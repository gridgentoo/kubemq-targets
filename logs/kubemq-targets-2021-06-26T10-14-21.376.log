2021-06-26T13:14:19.536+0300	INFO	request: {"metadata":{"filename":"Kubemq.javax","method":"save","path":"java/kubemq-java/kubemq-java-sdk/bin/main/io/kubemq/sdk/grpc"},"data":"Ly8gR2VuZXJhdGVkIGJ5IHRoZSBwcm90b2NvbCBidWZmZXIgY29tcGlsZXIuICBETyBOT1QgRURJVCENCi8vIHNvdXJjZToga3ViZW1xLnByb3RvDQoNCnBhY2thZ2UgaW8ua3ViZW1xLnNkay5ncnBjOw0KDQpwdWJsaWMgZmluYWwgY2xhc3MgS3ViZW1xIHsNCiAgcHJpdmF0ZSBLdWJlbXEoKSB7fQ0KICBwdWJsaWMgc3RhdGljIHZvaWQgcmVnaXN0ZXJBbGxFeHRlbnNpb25zKA0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgcmVnaXN0cnkpIHsNCiAgfQ0KDQogIHB1YmxpYyBzdGF0aWMgdm9pZCByZWdpc3RlckFsbEV4dGVuc2lvbnMoDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5IHJlZ2lzdHJ5KSB7DQogICAgcmVnaXN0ZXJBbGxFeHRlbnNpb25zKA0KICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUpIHJlZ2lzdHJ5KTsNCiAgfQ0KICAvKioNCiAgICogUHJvdG9idWYgZW51bSB7QGNvZGUga3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlfQ0KICAgKi8NCiAgcHVibGljIGVudW0gU3RyZWFtUmVxdWVzdFR5cGUNCiAgICAgIGltcGxlbWVudHMgY29tLmdvb2dsZS5wcm90b2J1Zi5Qcm90b2NvbE1lc3NhZ2VFbnVtIHsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5TdHJlYW1SZXF1ZXN0VHlwZVVua25vd24gPSAwOzwvY29kZT4NCiAgICAgKi8NCiAgICBTdHJlYW1SZXF1ZXN0VHlwZVVua25vd24oMCksDQogICAgLyoqDQogICAgICogPGNvZGU+UmVjZWl2ZU1lc3NhZ2UgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBSZWNlaXZlTWVzc2FnZSgxKSwNCiAgICAvKioNCiAgICAgKiA8Y29kZT5BY2tNZXNzYWdlID0gMjs8L2NvZGU+DQogICAgICovDQogICAgQWNrTWVzc2FnZSgyKSwNCiAgICAvKioNCiAgICAgKiA8Y29kZT5SZWplY3RNZXNzYWdlID0gMzs8L2NvZGU+DQogICAgICovDQogICAgUmVqZWN0TWVzc2FnZSgzKSwNCiAgICAvKioNCiAgICAgKiA8Y29kZT5Nb2RpZnlWaXNpYmlsaXR5ID0gNDs8L2NvZGU+DQogICAgICovDQogICAgTW9kaWZ5VmlzaWJpbGl0eSg0KSwNCiAgICAvKioNCiAgICAgKiA8Y29kZT5SZXNlbmRNZXNzYWdlID0gNTs8L2NvZGU+DQogICAgICovDQogICAgUmVzZW5kTWVzc2FnZSg1KSwNCiAgICAvKioNCiAgICAgKiA8Y29kZT5TZW5kTW9kaWZpZWRNZXNzYWdlID0gNjs8L2NvZGU+DQogICAgICovDQogICAgU2VuZE1vZGlmaWVkTWVzc2FnZSg2KSwNCiAgICBVTlJFQ09HTklaRUQoLTEpLA0KICAgIDsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPlN0cmVhbVJlcXVlc3RUeXBlVW5rbm93biA9IDA7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFN0cmVhbVJlcXVlc3RUeXBlVW5rbm93bl9WQUxVRSA9IDA7DQogICAgLyoqDQogICAgICogPGNvZGU+UmVjZWl2ZU1lc3NhZ2UgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBSZWNlaXZlTWVzc2FnZV9WQUxVRSA9IDE7DQogICAgLyoqDQogICAgICogPGNvZGU+QWNrTWVzc2FnZSA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEFja01lc3NhZ2VfVkFMVUUgPSAyOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPlJlamVjdE1lc3NhZ2UgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBSZWplY3RNZXNzYWdlX1ZBTFVFID0gMzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5Nb2RpZnlWaXNpYmlsaXR5ID0gNDs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTW9kaWZ5VmlzaWJpbGl0eV9WQUxVRSA9IDQ7DQogICAgLyoqDQogICAgICogPGNvZGU+UmVzZW5kTWVzc2FnZSA9IDU7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFJlc2VuZE1lc3NhZ2VfVkFMVUUgPSA1Ow0KICAgIC8qKg0KICAgICAqIDxjb2RlPlNlbmRNb2RpZmllZE1lc3NhZ2UgPSA2OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTZW5kTW9kaWZpZWRNZXNzYWdlX1ZBTFVFID0gNjsNCg0KDQogICAgcHVibGljIGZpbmFsIGludCBnZXROdW1iZXIoKSB7DQogICAgICBpZiAodGhpcyA9PSBVTlJFQ09HTklaRUQpIHsNCiAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5JbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24oDQogICAgICAgICAgICAiQ2FuJ3QgZ2V0IHRoZSBudW1iZXIgb2YgYW4gdW5rbm93biBlbnVtIHZhbHVlLiIpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIHZhbHVlOw0KICAgIH0NCg0KICAgIC8qKg0KICAgICAqIEBkZXByZWNhdGVkIFVzZSB7QGxpbmsgI2Zvck51bWJlcihpbnQpfSBpbnN0ZWFkLg0KICAgICAqLw0KICAgIEBqYXZhLmxhbmcuRGVwcmVjYXRlZA0KICAgIHB1YmxpYyBzdGF0aWMgU3RyZWFtUmVxdWVzdFR5cGUgdmFsdWVPZihpbnQgdmFsdWUpIHsNCiAgICAgIHJldHVybiBmb3JOdW1iZXIodmFsdWUpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgU3RyZWFtUmVxdWVzdFR5cGUgZm9yTnVtYmVyKGludCB2YWx1ZSkgew0KICAgICAgc3dpdGNoICh2YWx1ZSkgew0KICAgICAgICBjYXNlIDA6IHJldHVybiBTdHJlYW1SZXF1ZXN0VHlwZVVua25vd247DQogICAgICAgIGNhc2UgMTogcmV0dXJuIFJlY2VpdmVNZXNzYWdlOw0KICAgICAgICBjYXNlIDI6IHJldHVybiBBY2tNZXNzYWdlOw0KICAgICAgICBjYXNlIDM6IHJldHVybiBSZWplY3RNZXNzYWdlOw0KICAgICAgICBjYXNlIDQ6IHJldHVybiBNb2RpZnlWaXNpYmlsaXR5Ow0KICAgICAgICBjYXNlIDU6IHJldHVybiBSZXNlbmRNZXNzYWdlOw0KICAgICAgICBjYXNlIDY6IHJldHVybiBTZW5kTW9kaWZpZWRNZXNzYWdlOw0KICAgICAgICBkZWZhdWx0OiByZXR1cm4gbnVsbDsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGNvbS5nb29nbGUucHJvdG9idWYuSW50ZXJuYWwuRW51bUxpdGVNYXA8U3RyZWFtUmVxdWVzdFR5cGU+DQogICAgICAgIGludGVybmFsR2V0VmFsdWVNYXAoKSB7DQogICAgICByZXR1cm4gaW50ZXJuYWxWYWx1ZU1hcDsNCiAgICB9DQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5FbnVtTGl0ZU1hcDwNCiAgICAgICAgU3RyZWFtUmVxdWVzdFR5cGU+IGludGVybmFsVmFsdWVNYXAgPQ0KICAgICAgICAgIG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludGVybmFsLkVudW1MaXRlTWFwPFN0cmVhbVJlcXVlc3RUeXBlPigpIHsNCiAgICAgICAgICAgIHB1YmxpYyBTdHJlYW1SZXF1ZXN0VHlwZSBmaW5kVmFsdWVCeU51bWJlcihpbnQgbnVtYmVyKSB7DQogICAgICAgICAgICAgIHJldHVybiBTdHJlYW1SZXF1ZXN0VHlwZS5mb3JOdW1iZXIobnVtYmVyKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9Ow0KDQogICAgcHVibGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRW51bVZhbHVlRGVzY3JpcHRvcg0KICAgICAgICBnZXRWYWx1ZURlc2NyaXB0b3IoKSB7DQogICAgICByZXR1cm4gZ2V0RGVzY3JpcHRvcigpLmdldFZhbHVlcygpLmdldChvcmRpbmFsKCkpOw0KICAgIH0NCiAgICBwdWJsaWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5FbnVtRGVzY3JpcHRvcg0KICAgICAgICBnZXREZXNjcmlwdG9yRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBnZXREZXNjcmlwdG9yKCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5FbnVtRGVzY3JpcHRvcg0KICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuZ2V0RGVzY3JpcHRvcigpLmdldEVudW1UeXBlcygpLmdldCgwKTsNCiAgICB9DQoNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBTdHJlYW1SZXF1ZXN0VHlwZVtdIFZBTFVFUyA9IHZhbHVlcygpOw0KDQogICAgcHVibGljIHN0YXRpYyBTdHJlYW1SZXF1ZXN0VHlwZSB2YWx1ZU9mKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkVudW1WYWx1ZURlc2NyaXB0b3IgZGVzYykgew0KICAgICAgaWYgKGRlc2MuZ2V0VHlwZSgpICE9IGdldERlc2NyaXB0b3IoKSkgew0KICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLklsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbigNCiAgICAgICAgICAiRW51bVZhbHVlRGVzY3JpcHRvciBpcyBub3QgZm9yIHRoaXMgdHlwZS4iKTsNCiAgICAgIH0NCiAgICAgIGlmIChkZXNjLmdldEluZGV4KCkgPT0gLTEpIHsNCiAgICAgICAgcmV0dXJuIFVOUkVDT0dOSVpFRDsNCiAgICAgIH0NCiAgICAgIHJldHVybiBWQUxVRVNbZGVzYy5nZXRJbmRleCgpXTsNCiAgICB9DQoNCiAgICBwcml2YXRlIGZpbmFsIGludCB2YWx1ZTsNCg0KICAgIHByaXZhdGUgU3RyZWFtUmVxdWVzdFR5cGUoaW50IHZhbHVlKSB7DQogICAgICB0aGlzLnZhbHVlID0gdmFsdWU7DQogICAgfQ0KDQogICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGVudW1fc2NvcGU6a3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlKQ0KICB9DQoNCiAgcHVibGljIGludGVyZmFjZSBQaW5nUmVzdWx0T3JCdWlsZGVyIGV4dGVuZHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChpbnRlcmZhY2VfZXh0ZW5kczprdWJlbXEuUGluZ1Jlc3VsdCkNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZU9yQnVpbGRlciB7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgSG9zdCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0SG9zdCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBIb3N0ID0gMTs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldEhvc3RCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIFZlcnNpb24gPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldFZlcnNpb24oKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgVmVyc2lvbiA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRWZXJzaW9uQnl0ZXMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDY0IFNlcnZlclN0YXJ0VGltZSA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIGxvbmcgZ2V0U2VydmVyU3RhcnRUaW1lKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQ2NCBTZXJ2ZXJVcFRpbWVTZWNvbmRzID0gNDs8L2NvZGU+DQogICAgICovDQogICAgbG9uZyBnZXRTZXJ2ZXJVcFRpbWVTZWNvbmRzKCk7DQogIH0NCiAgLyoqDQogICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5QaW5nUmVzdWx0fQ0KICAgKi8NCiAgcHVibGljICBzdGF0aWMgZmluYWwgY2xhc3MgUGluZ1Jlc3VsdCBleHRlbmRzDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMyBpbXBsZW1lbnRzDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQobWVzc2FnZV9pbXBsZW1lbnRzOmt1YmVtcS5QaW5nUmVzdWx0KQ0KICAgICAgUGluZ1Jlc3VsdE9yQnVpbGRlciB7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGxvbmcgc2VyaWFsVmVyc2lvblVJRCA9IDBMOw0KICAgIC8vIFVzZSBQaW5nUmVzdWx0Lm5ld0J1aWxkZXIoKSB0byBjb25zdHJ1Y3QuDQogICAgcHJpdmF0ZSBQaW5nUmVzdWx0KGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8Pz4gYnVpbGRlcikgew0KICAgICAgc3VwZXIoYnVpbGRlcik7DQogICAgfQ0KICAgIHByaXZhdGUgUGluZ1Jlc3VsdCgpIHsNCiAgICAgIGhvc3RfID0gIiI7DQogICAgICB2ZXJzaW9uXyA9ICIiOw0KICAgICAgc2VydmVyU3RhcnRUaW1lXyA9IDBMOw0KICAgICAgc2VydmVyVXBUaW1lU2Vjb25kc18gPSAwTDsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0DQogICAgZ2V0VW5rbm93bkZpZWxkcygpIHsNCiAgICAgIHJldHVybiB0aGlzLnVua25vd25GaWVsZHM7DQogICAgfQ0KICAgIHByaXZhdGUgUGluZ1Jlc3VsdCgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHRoaXMoKTsNCiAgICAgIGlmIChleHRlbnNpb25SZWdpc3RyeSA9PSBudWxsKSB7DQogICAgICAgIHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgICAgIH0NCiAgICAgIGludCBtdXRhYmxlX2JpdEZpZWxkMF8gPSAwOw0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQuQnVpbGRlciB1bmtub3duRmllbGRzID0NCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldC5uZXdCdWlsZGVyKCk7DQogICAgICB0cnkgew0KICAgICAgICBib29sZWFuIGRvbmUgPSBmYWxzZTsNCiAgICAgICAgd2hpbGUgKCFkb25lKSB7DQogICAgICAgICAgaW50IHRhZyA9IGlucHV0LnJlYWRUYWcoKTsNCiAgICAgICAgICBzd2l0Y2ggKHRhZykgew0KICAgICAgICAgICAgY2FzZSAwOg0KICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICBkZWZhdWx0OiB7DQogICAgICAgICAgICAgIGlmICghcGFyc2VVbmtub3duRmllbGRQcm90bzMoDQogICAgICAgICAgICAgICAgICBpbnB1dCwgdW5rbm93bkZpZWxkcywgZXh0ZW5zaW9uUmVnaXN0cnksIHRhZykpIHsNCiAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMTA6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgaG9zdF8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMTg6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgdmVyc2lvbl8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMjQ6IHsNCg0KICAgICAgICAgICAgICBzZXJ2ZXJTdGFydFRpbWVfID0gaW5wdXQucmVhZEludDY0KCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAzMjogew0KDQogICAgICAgICAgICAgIHNlcnZlclVwVGltZVNlY29uZHNfID0gaW5wdXQucmVhZEludDY0KCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBlLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBjYXRjaCAoamF2YS5pby5JT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbigNCiAgICAgICAgICAgIGUpLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgdGhpcy51bmtub3duRmllbGRzID0gdW5rbm93bkZpZWxkcy5idWlsZCgpOw0KICAgICAgICBtYWtlRXh0ZW5zaW9uc0ltbXV0YWJsZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9QaW5nUmVzdWx0X2Rlc2NyaXB0b3I7DQogICAgfQ0KDQogICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUGluZ1Jlc3VsdF9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5QaW5nUmVzdWx0LmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQuQnVpbGRlci5jbGFzcyk7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgSE9TVF9GSUVMRF9OVU1CRVIgPSAxOw0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBob3N0XzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgSG9zdCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldEhvc3QoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGhvc3RfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIGhvc3RfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBIb3N0ID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRIb3N0Qnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGhvc3RfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIGhvc3RfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFZFUlNJT05fRklFTERfTlVNQkVSID0gMjsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgdmVyc2lvbl87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIFZlcnNpb24gPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRWZXJzaW9uKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSB2ZXJzaW9uXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICB2ZXJzaW9uXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgVmVyc2lvbiA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0VmVyc2lvbkJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSB2ZXJzaW9uXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICB2ZXJzaW9uXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTRVJWRVJTVEFSVFRJTUVfRklFTERfTlVNQkVSID0gMzsNCiAgICBwcml2YXRlIGxvbmcgc2VydmVyU3RhcnRUaW1lXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQ2NCBTZXJ2ZXJTdGFydFRpbWUgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgbG9uZyBnZXRTZXJ2ZXJTdGFydFRpbWUoKSB7DQogICAgICByZXR1cm4gc2VydmVyU3RhcnRUaW1lXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTRVJWRVJVUFRJTUVTRUNPTkRTX0ZJRUxEX05VTUJFUiA9IDQ7DQogICAgcHJpdmF0ZSBsb25nIHNlcnZlclVwVGltZVNlY29uZHNfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDY0IFNlcnZlclVwVGltZVNlY29uZHMgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgbG9uZyBnZXRTZXJ2ZXJVcFRpbWVTZWNvbmRzKCkgew0KICAgICAgcmV0dXJuIHNlcnZlclVwVGltZVNlY29uZHNfOw0KICAgIH0NCg0KICAgIHByaXZhdGUgYnl0ZSBtZW1vaXplZElzSW5pdGlhbGl6ZWQgPSAtMTsNCiAgICBwdWJsaWMgZmluYWwgYm9vbGVhbiBpc0luaXRpYWxpemVkKCkgew0KICAgICAgYnl0ZSBpc0luaXRpYWxpemVkID0gbWVtb2l6ZWRJc0luaXRpYWxpemVkOw0KICAgICAgaWYgKGlzSW5pdGlhbGl6ZWQgPT0gMSkgcmV0dXJuIHRydWU7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAwKSByZXR1cm4gZmFsc2U7DQoNCiAgICAgIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IDE7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQoNCiAgICBwdWJsaWMgdm9pZCB3cml0ZVRvKGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0gb3V0cHV0KQ0KICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgaWYgKCFnZXRIb3N0Qnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAxLCBob3N0Xyk7DQogICAgICB9DQogICAgICBpZiAoIWdldFZlcnNpb25CeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDIsIHZlcnNpb25fKTsNCiAgICAgIH0NCiAgICAgIGlmIChzZXJ2ZXJTdGFydFRpbWVfICE9IDBMKSB7DQogICAgICAgIG91dHB1dC53cml0ZUludDY0KDMsIHNlcnZlclN0YXJ0VGltZV8pOw0KICAgICAgfQ0KICAgICAgaWYgKHNlcnZlclVwVGltZVNlY29uZHNfICE9IDBMKSB7DQogICAgICAgIG91dHB1dC53cml0ZUludDY0KDQsIHNlcnZlclVwVGltZVNlY29uZHNfKTsNCiAgICAgIH0NCiAgICAgIHVua25vd25GaWVsZHMud3JpdGVUbyhvdXRwdXQpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBpbnQgZ2V0U2VyaWFsaXplZFNpemUoKSB7DQogICAgICBpbnQgc2l6ZSA9IG1lbW9pemVkU2l6ZTsNCiAgICAgIGlmIChzaXplICE9IC0xKSByZXR1cm4gc2l6ZTsNCg0KICAgICAgc2l6ZSA9IDA7DQogICAgICBpZiAoIWdldEhvc3RCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDEsIGhvc3RfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0VmVyc2lvbkJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoMiwgdmVyc2lvbl8pOw0KICAgICAgfQ0KICAgICAgaWYgKHNlcnZlclN0YXJ0VGltZV8gIT0gMEwpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVJbnQ2NFNpemUoMywgc2VydmVyU3RhcnRUaW1lXyk7DQogICAgICB9DQogICAgICBpZiAoc2VydmVyVXBUaW1lU2Vjb25kc18gIT0gMEwpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVJbnQ2NFNpemUoNCwgc2VydmVyVXBUaW1lU2Vjb25kc18pOw0KICAgICAgfQ0KICAgICAgc2l6ZSArPSB1bmtub3duRmllbGRzLmdldFNlcmlhbGl6ZWRTaXplKCk7DQogICAgICBtZW1vaXplZFNpemUgPSBzaXplOw0KICAgICAgcmV0dXJuIHNpemU7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBib29sZWFuIGVxdWFscyhmaW5hbCBqYXZhLmxhbmcuT2JqZWN0IG9iaikgew0KICAgICAgaWYgKG9iaiA9PSB0aGlzKSB7DQogICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgICBpZiAoIShvYmogaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQpKSB7DQogICAgICAgIHJldHVybiBzdXBlci5lcXVhbHMob2JqKTsNCiAgICAgIH0NCiAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUGluZ1Jlc3VsdCBvdGhlciA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQpIG9iajsNCg0KICAgICAgYm9vbGVhbiByZXN1bHQgPSB0cnVlOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldEhvc3QoKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0SG9zdCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRWZXJzaW9uKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldFZlcnNpb24oKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldFNlcnZlclN0YXJ0VGltZSgpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0U2VydmVyU3RhcnRUaW1lKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChnZXRTZXJ2ZXJVcFRpbWVTZWNvbmRzKCkNCiAgICAgICAgICA9PSBvdGhlci5nZXRTZXJ2ZXJVcFRpbWVTZWNvbmRzKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIHVua25vd25GaWVsZHMuZXF1YWxzKG90aGVyLnVua25vd25GaWVsZHMpOw0KICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGludCBoYXNoQ29kZSgpIHsNCiAgICAgIGlmIChtZW1vaXplZEhhc2hDb2RlICE9IDApIHsNCiAgICAgICAgcmV0dXJuIG1lbW9pemVkSGFzaENvZGU7DQogICAgICB9DQogICAgICBpbnQgaGFzaCA9IDQxOw0KICAgICAgaGFzaCA9ICgxOSAqIGhhc2gpICsgZ2V0RGVzY3JpcHRvcigpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBIT1NUX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldEhvc3QoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgVkVSU0lPTl9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRWZXJzaW9uKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFNFUlZFUlNUQVJUVElNRV9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBjb20uZ29vZ2xlLnByb3RvYnVmLkludGVybmFsLmhhc2hMb25nKA0KICAgICAgICAgIGdldFNlcnZlclN0YXJ0VGltZSgpKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFNFUlZFUlVQVElNRVNFQ09ORFNfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5oYXNoTG9uZygNCiAgICAgICAgICBnZXRTZXJ2ZXJVcFRpbWVTZWNvbmRzKCkpOw0KICAgICAgaGFzaCA9ICgyOSAqIGhhc2gpICsgdW5rbm93bkZpZWxkcy5oYXNoQ29kZSgpOw0KICAgICAgbWVtb2l6ZWRIYXNoQ29kZSA9IGhhc2g7DQogICAgICByZXR1cm4gaGFzaDsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUGluZ1Jlc3VsdCBwYXJzZUZyb20oDQogICAgICAgIGphdmEubmlvLkJ5dGVCdWZmZXIgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUGluZ1Jlc3VsdCBwYXJzZUZyb20oDQogICAgICAgIGphdmEubmlvLkJ5dGVCdWZmZXIgZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5QaW5nUmVzdWx0IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5QaW5nUmVzdWx0IHBhcnNlRnJvbShieXRlW10gZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUGluZ1Jlc3VsdCBwYXJzZUZyb20oDQogICAgICAgIGJ5dGVbXSBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQgcGFyc2VGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQgcGFyc2VEZWxpbWl0ZWRGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZURlbGltaXRlZFdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQgcGFyc2VEZWxpbWl0ZWRGcm9tKA0KICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBCdWlsZGVyIG5ld0J1aWxkZXJGb3JUeXBlKCkgeyByZXR1cm4gbmV3QnVpbGRlcigpOyB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRS50b0J1aWxkZXIoKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5QaW5nUmVzdWx0IHByb3RvdHlwZSkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCkubWVyZ2VGcm9tKHByb3RvdHlwZSk7DQogICAgfQ0KICAgIHB1YmxpYyBCdWlsZGVyIHRvQnVpbGRlcigpIHsNCiAgICAgIHJldHVybiB0aGlzID09IERFRkFVTFRfSU5TVEFOQ0UNCiAgICAgICAgICA/IG5ldyBCdWlsZGVyKCkgOiBuZXcgQnVpbGRlcigpLm1lcmdlRnJvbSh0aGlzKTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHJvdGVjdGVkIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXJQYXJlbnQgcGFyZW50KSB7DQogICAgICBCdWlsZGVyIGJ1aWxkZXIgPSBuZXcgQnVpbGRlcihwYXJlbnQpOw0KICAgICAgcmV0dXJuIGJ1aWxkZXI7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5QaW5nUmVzdWx0fQ0KICAgICAqLw0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY2xhc3MgQnVpbGRlciBleHRlbmRzDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8QnVpbGRlcj4gaW1wbGVtZW50cw0KICAgICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoYnVpbGRlcl9pbXBsZW1lbnRzOmt1YmVtcS5QaW5nUmVzdWx0KQ0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHRPckJ1aWxkZXIgew0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1BpbmdSZXN1bHRfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICAgIGludGVybmFsR2V0RmllbGRBY2Nlc3NvclRhYmxlKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1BpbmdSZXN1bHRfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUGluZ1Jlc3VsdC5CdWlsZGVyLmNsYXNzKTsNCiAgICAgIH0NCg0KICAgICAgLy8gQ29uc3RydWN0IHVzaW5nIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUGluZ1Jlc3VsdC5uZXdCdWlsZGVyKCkNCiAgICAgIHByaXZhdGUgQnVpbGRlcigpIHsNCiAgICAgICAgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIEJ1aWxkZXIoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlclBhcmVudCBwYXJlbnQpIHsNCiAgICAgICAgc3VwZXIocGFyZW50KTsNCiAgICAgICAgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpOw0KICAgICAgfQ0KICAgICAgcHJpdmF0ZSB2b2lkIG1heWJlRm9yY2VCdWlsZGVySW5pdGlhbGl6YXRpb24oKSB7DQogICAgICAgIGlmIChjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgICAgICAgIC5hbHdheXNVc2VGaWVsZEJ1aWxkZXJzKSB7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyKCkgew0KICAgICAgICBzdXBlci5jbGVhcigpOw0KICAgICAgICBob3N0XyA9ICIiOw0KDQogICAgICAgIHZlcnNpb25fID0gIiI7DQoNCiAgICAgICAgc2VydmVyU3RhcnRUaW1lXyA9IDBMOw0KDQogICAgICAgIHNlcnZlclVwVGltZVNlY29uZHNfID0gMEw7DQoNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9QaW5nUmVzdWx0X2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUGluZ1Jlc3VsdC5nZXREZWZhdWx0SW5zdGFuY2UoKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUGluZ1Jlc3VsdCBidWlsZCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5QaW5nUmVzdWx0IHJlc3VsdCA9IGJ1aWxkUGFydGlhbCgpOw0KICAgICAgICBpZiAoIXJlc3VsdC5pc0luaXRpYWxpemVkKCkpIHsNCiAgICAgICAgICB0aHJvdyBuZXdVbmluaXRpYWxpemVkTWVzc2FnZUV4Y2VwdGlvbihyZXN1bHQpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiByZXN1bHQ7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQgYnVpbGRQYXJ0aWFsKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQgcmVzdWx0ID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUGluZ1Jlc3VsdCh0aGlzKTsNCiAgICAgICAgcmVzdWx0Lmhvc3RfID0gaG9zdF87DQogICAgICAgIHJlc3VsdC52ZXJzaW9uXyA9IHZlcnNpb25fOw0KICAgICAgICByZXN1bHQuc2VydmVyU3RhcnRUaW1lXyA9IHNlcnZlclN0YXJ0VGltZV87DQogICAgICAgIHJlc3VsdC5zZXJ2ZXJVcFRpbWVTZWNvbmRzXyA9IHNlcnZlclVwVGltZVNlY29uZHNfOw0KICAgICAgICBvbkJ1aWx0KCk7DQogICAgICAgIHJldHVybiByZXN1bHQ7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsb25lKCkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsb25lKCk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuc2V0RmllbGQoZmllbGQsIHZhbHVlKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyRmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbGVhckZpZWxkKGZpZWxkKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyT25lb2YoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5PbmVvZkRlc2NyaXB0b3Igb25lb2YpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbGVhck9uZW9mKG9uZW9mKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlcGVhdGVkRmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgaW50IGluZGV4LCBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuc2V0UmVwZWF0ZWRGaWVsZChmaWVsZCwgaW5kZXgsIHZhbHVlKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGFkZFJlcGVhdGVkRmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmFkZFJlcGVhdGVkRmllbGQoZmllbGQsIHZhbHVlKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbShjb20uZ29vZ2xlLnByb3RvYnVmLk1lc3NhZ2Ugb3RoZXIpIHsNCiAgICAgICAgaWYgKG90aGVyIGluc3RhbmNlb2YgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5QaW5nUmVzdWx0KSB7DQogICAgICAgICAgcmV0dXJuIG1lcmdlRnJvbSgoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5QaW5nUmVzdWx0KW90aGVyKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBzdXBlci5tZXJnZUZyb20ob3RoZXIpOw0KICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbShpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQgb3RoZXIpIHsNCiAgICAgICAgaWYgKG90aGVyID09IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUGluZ1Jlc3VsdC5nZXREZWZhdWx0SW5zdGFuY2UoKSkgcmV0dXJuIHRoaXM7DQogICAgICAgIGlmICghb3RoZXIuZ2V0SG9zdCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIGhvc3RfID0gb3RoZXIuaG9zdF87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRWZXJzaW9uKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgdmVyc2lvbl8gPSBvdGhlci52ZXJzaW9uXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0U2VydmVyU3RhcnRUaW1lKCkgIT0gMEwpIHsNCiAgICAgICAgICBzZXRTZXJ2ZXJTdGFydFRpbWUob3RoZXIuZ2V0U2VydmVyU3RhcnRUaW1lKCkpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRTZXJ2ZXJVcFRpbWVTZWNvbmRzKCkgIT0gMEwpIHsNCiAgICAgICAgICBzZXRTZXJ2ZXJVcFRpbWVTZWNvbmRzKG90aGVyLmdldFNlcnZlclVwVGltZVNlY29uZHMoKSk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5tZXJnZVVua25vd25GaWVsZHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbSgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQgcGFyc2VkTWVzc2FnZSA9IG51bGw7DQogICAgICAgIHRyeSB7DQogICAgICAgICAgcGFyc2VkTWVzc2FnZSA9IFBBUlNFUi5wYXJzZVBhcnRpYWxGcm9tKGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICAgIH0gY2F0Y2ggKGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUGluZ1Jlc3VsdCkgZS5nZXRVbmZpbmlzaGVkTWVzc2FnZSgpOw0KICAgICAgICAgIHRocm93IGUudW53cmFwSU9FeGNlcHRpb24oKTsNCiAgICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgICBpZiAocGFyc2VkTWVzc2FnZSAhPSBudWxsKSB7DQogICAgICAgICAgICBtZXJnZUZyb20ocGFyc2VkTWVzc2FnZSk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgaG9zdF8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEhvc3QgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0SG9zdCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBob3N0XzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgaG9zdF8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBIb3N0ID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRIb3N0Qnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gaG9zdF87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgaG9zdF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEhvc3QgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0SG9zdCgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIGhvc3RfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEhvc3QgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJIb3N0KCkgew0KICAgICAgICANCiAgICAgICAgaG9zdF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRIb3N0KCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEhvc3QgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0SG9zdEJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBob3N0XyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCB2ZXJzaW9uXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgVmVyc2lvbiA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRWZXJzaW9uKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHZlcnNpb25fOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICB2ZXJzaW9uXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFZlcnNpb24gPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldFZlcnNpb25CeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSB2ZXJzaW9uXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICB2ZXJzaW9uXyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgVmVyc2lvbiA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRWZXJzaW9uKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgdmVyc2lvbl8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgVmVyc2lvbiA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhclZlcnNpb24oKSB7DQogICAgICAgIA0KICAgICAgICB2ZXJzaW9uXyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldFZlcnNpb24oKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgVmVyc2lvbiA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRWZXJzaW9uQnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIHZlcnNpb25fID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBsb25nIHNlcnZlclN0YXJ0VGltZV8gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQ2NCBTZXJ2ZXJTdGFydFRpbWUgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGxvbmcgZ2V0U2VydmVyU3RhcnRUaW1lKCkgew0KICAgICAgICByZXR1cm4gc2VydmVyU3RhcnRUaW1lXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgU2VydmVyU3RhcnRUaW1lID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFNlcnZlclN0YXJ0VGltZShsb25nIHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICBzZXJ2ZXJTdGFydFRpbWVfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgU2VydmVyU3RhcnRUaW1lID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyU2VydmVyU3RhcnRUaW1lKCkgew0KICAgICAgICANCiAgICAgICAgc2VydmVyU3RhcnRUaW1lXyA9IDBMOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgbG9uZyBzZXJ2ZXJVcFRpbWVTZWNvbmRzXyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDY0IFNlcnZlclVwVGltZVNlY29uZHMgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGxvbmcgZ2V0U2VydmVyVXBUaW1lU2Vjb25kcygpIHsNCiAgICAgICAgcmV0dXJuIHNlcnZlclVwVGltZVNlY29uZHNfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQ2NCBTZXJ2ZXJVcFRpbWVTZWNvbmRzID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFNlcnZlclVwVGltZVNlY29uZHMobG9uZyB2YWx1ZSkgew0KICAgICAgICANCiAgICAgICAgc2VydmVyVXBUaW1lU2Vjb25kc18gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQ2NCBTZXJ2ZXJVcFRpbWVTZWNvbmRzID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyU2VydmVyVXBUaW1lU2Vjb25kcygpIHsNCiAgICAgICAgDQogICAgICAgIHNlcnZlclVwVGltZVNlY29uZHNfID0gMEw7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIHNldFVua25vd25GaWVsZHMoDQogICAgICAgICAgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQgdW5rbm93bkZpZWxkcykgew0KICAgICAgICByZXR1cm4gc3VwZXIuc2V0VW5rbm93bkZpZWxkc1Byb3RvMyh1bmtub3duRmllbGRzKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIEJ1aWxkZXIgbWVyZ2VVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLm1lcmdlVW5rbm93bkZpZWxkcyh1bmtub3duRmllbGRzKTsNCiAgICAgIH0NCg0KDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoYnVpbGRlcl9zY29wZTprdWJlbXEuUGluZ1Jlc3VsdCkNCiAgICB9DQoNCiAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoY2xhc3Nfc2NvcGU6a3ViZW1xLlBpbmdSZXN1bHQpDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5QaW5nUmVzdWx0IERFRkFVTFRfSU5TVEFOQ0U7DQogICAgc3RhdGljIHsNCiAgICAgIERFRkFVTFRfSU5TVEFOQ0UgPSBuZXcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5QaW5nUmVzdWx0KCk7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlBpbmdSZXN1bHQgZ2V0RGVmYXVsdEluc3RhbmNlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UGluZ1Jlc3VsdD4NCiAgICAgICAgUEFSU0VSID0gbmV3IGNvbS5nb29nbGUucHJvdG9idWYuQWJzdHJhY3RQYXJzZXI8UGluZ1Jlc3VsdD4oKSB7DQogICAgICBwdWJsaWMgUGluZ1Jlc3VsdCBwYXJzZVBhcnRpYWxGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgICByZXR1cm4gbmV3IFBpbmdSZXN1bHQoaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgIH0NCiAgICB9Ow0KDQogICAgcHVibGljIHN0YXRpYyBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxQaW5nUmVzdWx0PiBwYXJzZXIoKSB7DQogICAgICByZXR1cm4gUEFSU0VSOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UGluZ1Jlc3VsdD4gZ2V0UGFyc2VyRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUGluZ1Jlc3VsdCBnZXREZWZhdWx0SW5zdGFuY2VGb3JUeXBlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogIH0NCg0KICBwdWJsaWMgaW50ZXJmYWNlIEVtcHR5T3JCdWlsZGVyIGV4dGVuZHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChpbnRlcmZhY2VfZXh0ZW5kczprdWJlbXEuRW1wdHkpDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLk1lc3NhZ2VPckJ1aWxkZXIgew0KICB9DQogIC8qKg0KICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuRW1wdHl9DQogICAqLw0KICBwdWJsaWMgIHN0YXRpYyBmaW5hbCBjbGFzcyBFbXB0eSBleHRlbmRzDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMyBpbXBsZW1lbnRzDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQobWVzc2FnZV9pbXBsZW1lbnRzOmt1YmVtcS5FbXB0eSkNCiAgICAgIEVtcHR5T3JCdWlsZGVyIHsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgbG9uZyBzZXJpYWxWZXJzaW9uVUlEID0gMEw7DQogICAgLy8gVXNlIEVtcHR5Lm5ld0J1aWxkZXIoKSB0byBjb25zdHJ1Y3QuDQogICAgcHJpdmF0ZSBFbXB0eShjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPD8+IGJ1aWxkZXIpIHsNCiAgICAgIHN1cGVyKGJ1aWxkZXIpOw0KICAgIH0NCiAgICBwcml2YXRlIEVtcHR5KCkgew0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQNCiAgICBnZXRVbmtub3duRmllbGRzKCkgew0KICAgICAgcmV0dXJuIHRoaXMudW5rbm93bkZpZWxkczsNCiAgICB9DQogICAgcHJpdmF0ZSBFbXB0eSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHRoaXMoKTsNCiAgICAgIGlmIChleHRlbnNpb25SZWdpc3RyeSA9PSBudWxsKSB7DQogICAgICAgIHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgICAgIH0NCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0LkJ1aWxkZXIgdW5rbm93bkZpZWxkcyA9DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQubmV3QnVpbGRlcigpOw0KICAgICAgdHJ5IHsNCiAgICAgICAgYm9vbGVhbiBkb25lID0gZmFsc2U7DQogICAgICAgIHdoaWxlICghZG9uZSkgew0KICAgICAgICAgIGludCB0YWcgPSBpbnB1dC5yZWFkVGFnKCk7DQogICAgICAgICAgc3dpdGNoICh0YWcpIHsNCiAgICAgICAgICAgIGNhc2UgMDoNCiAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgZGVmYXVsdDogew0KICAgICAgICAgICAgICBpZiAoIXBhcnNlVW5rbm93bkZpZWxkUHJvdG8zKA0KICAgICAgICAgICAgICAgICAgaW5wdXQsIHVua25vd25GaWVsZHMsIGV4dGVuc2lvblJlZ2lzdHJ5LCB0YWcpKSB7DQogICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9IGNhdGNoIChjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IGUuc2V0VW5maW5pc2hlZE1lc3NhZ2UodGhpcyk7DQogICAgICB9IGNhdGNoIChqYXZhLmlvLklPRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgdGhyb3cgbmV3IGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uKA0KICAgICAgICAgICAgZSkuc2V0VW5maW5pc2hlZE1lc3NhZ2UodGhpcyk7DQogICAgICB9IGZpbmFsbHkgew0KICAgICAgICB0aGlzLnVua25vd25GaWVsZHMgPSB1bmtub3duRmllbGRzLmJ1aWxkKCk7DQogICAgICAgIG1ha2VFeHRlbnNpb25zSW1tdXRhYmxlKCk7DQogICAgICB9DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0VtcHR5X2Rlc2NyaXB0b3I7DQogICAgfQ0KDQogICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfRW1wdHlfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgLmVuc3VyZUZpZWxkQWNjZXNzb3JzSW5pdGlhbGl6ZWQoDQogICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkuQnVpbGRlci5jbGFzcyk7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBieXRlIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IC0xOw0KICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICBieXRlIGlzSW5pdGlhbGl6ZWQgPSBtZW1vaXplZElzSW5pdGlhbGl6ZWQ7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAxKSByZXR1cm4gdHJ1ZTsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDApIHJldHVybiBmYWxzZTsNCg0KICAgICAgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gMTsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCg0KICAgIHB1YmxpYyB2b2lkIHdyaXRlVG8oY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbSBvdXRwdXQpDQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICB1bmtub3duRmllbGRzLndyaXRlVG8ob3V0cHV0KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW50IGdldFNlcmlhbGl6ZWRTaXplKCkgew0KICAgICAgaW50IHNpemUgPSBtZW1vaXplZFNpemU7DQogICAgICBpZiAoc2l6ZSAhPSAtMSkgcmV0dXJuIHNpemU7DQoNCiAgICAgIHNpemUgPSAwOw0KICAgICAgc2l6ZSArPSB1bmtub3duRmllbGRzLmdldFNlcmlhbGl6ZWRTaXplKCk7DQogICAgICBtZW1vaXplZFNpemUgPSBzaXplOw0KICAgICAgcmV0dXJuIHNpemU7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBib29sZWFuIGVxdWFscyhmaW5hbCBqYXZhLmxhbmcuT2JqZWN0IG9iaikgew0KICAgICAgaWYgKG9iaiA9PSB0aGlzKSB7DQogICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgICBpZiAoIShvYmogaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5KSkgew0KICAgICAgICByZXR1cm4gc3VwZXIuZXF1YWxzKG9iaik7DQogICAgICB9DQogICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5IG90aGVyID0gKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkpIG9iajsNCg0KICAgICAgYm9vbGVhbiByZXN1bHQgPSB0cnVlOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIHVua25vd25GaWVsZHMuZXF1YWxzKG90aGVyLnVua25vd25GaWVsZHMpOw0KICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGludCBoYXNoQ29kZSgpIHsNCiAgICAgIGlmIChtZW1vaXplZEhhc2hDb2RlICE9IDApIHsNCiAgICAgICAgcmV0dXJuIG1lbW9pemVkSGFzaENvZGU7DQogICAgICB9DQogICAgICBpbnQgaGFzaCA9IDQxOw0KICAgICAgaGFzaCA9ICgxOSAqIGhhc2gpICsgZ2V0RGVzY3JpcHRvcigpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDI5ICogaGFzaCkgKyB1bmtub3duRmllbGRzLmhhc2hDb2RlKCk7DQogICAgICBtZW1vaXplZEhhc2hDb2RlID0gaGFzaDsNCiAgICAgIHJldHVybiBoYXNoOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FbXB0eSBwYXJzZUZyb20oDQogICAgICAgIGphdmEubmlvLkJ5dGVCdWZmZXIgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FbXB0eSBwYXJzZUZyb20oYnl0ZVtdIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5IHBhcnNlRnJvbSgNCiAgICAgICAgYnl0ZVtdIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkgcGFyc2VGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5IHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FbXB0eSBwYXJzZURlbGltaXRlZEZyb20oamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkgcGFyc2VEZWxpbWl0ZWRGcm9tKA0KICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FbXB0eSBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KDQogICAgcHVibGljIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoKSB7IHJldHVybiBuZXdCdWlsZGVyKCk7IH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcigpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFLnRvQnVpbGRlcigpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcihpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5IHByb3RvdHlwZSkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCkubWVyZ2VGcm9tKHByb3RvdHlwZSk7DQogICAgfQ0KICAgIHB1YmxpYyBCdWlsZGVyIHRvQnVpbGRlcigpIHsNCiAgICAgIHJldHVybiB0aGlzID09IERFRkFVTFRfSU5TVEFOQ0UNCiAgICAgICAgICA/IG5ldyBCdWlsZGVyKCkgOiBuZXcgQnVpbGRlcigpLm1lcmdlRnJvbSh0aGlzKTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHJvdGVjdGVkIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXJQYXJlbnQgcGFyZW50KSB7DQogICAgICBCdWlsZGVyIGJ1aWxkZXIgPSBuZXcgQnVpbGRlcihwYXJlbnQpOw0KICAgICAgcmV0dXJuIGJ1aWxkZXI7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5FbXB0eX0NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNsYXNzIEJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPEJ1aWxkZXI+IGltcGxlbWVudHMNCiAgICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfaW1wbGVtZW50czprdWJlbXEuRW1wdHkpDQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHlPckJ1aWxkZXIgew0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0VtcHR5X2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FbXB0eV9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAgIC5lbnN1cmVGaWVsZEFjY2Vzc29yc0luaXRpYWxpemVkKA0KICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkuQnVpbGRlci5jbGFzcyk7DQogICAgICB9DQoNCiAgICAgIC8vIENvbnN0cnVjdCB1c2luZyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5Lm5ld0J1aWxkZXIoKQ0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKCkgew0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgQnVpbGRlcigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgICBzdXBlcihwYXJlbnQpOw0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQogICAgICBwcml2YXRlIHZvaWQgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpIHsNCiAgICAgICAgaWYgKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgICAgICAgLmFsd2F5c1VzZUZpZWxkQnVpbGRlcnMpIHsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXIoKSB7DQogICAgICAgIHN1cGVyLmNsZWFyKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvckZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfRW1wdHlfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkuZ2V0RGVmYXVsdEluc3RhbmNlKCk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5IGJ1aWxkKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5IHJlc3VsdCA9IGJ1aWxkUGFydGlhbCgpOw0KICAgICAgICBpZiAoIXJlc3VsdC5pc0luaXRpYWxpemVkKCkpIHsNCiAgICAgICAgICB0aHJvdyBuZXdVbmluaXRpYWxpemVkTWVzc2FnZUV4Y2VwdGlvbihyZXN1bHQpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiByZXN1bHQ7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5IGJ1aWxkUGFydGlhbCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FbXB0eSByZXN1bHQgPSBuZXcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FbXB0eSh0aGlzKTsNCiAgICAgICAgb25CdWlsdCgpOw0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBjbG9uZSgpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbG9uZSgpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJGaWVsZChmaWVsZCk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck9uZW9mKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuT25lb2ZEZXNjcmlwdG9yIG9uZW9mKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJPbmVvZihvbmVvZik7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGludCBpbmRleCwgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldFJlcGVhdGVkRmllbGQoZmllbGQsIGluZGV4LCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBhZGRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5hZGRSZXBlYXRlZEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oY29tLmdvb2dsZS5wcm90b2J1Zi5NZXNzYWdlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkpIHsNCiAgICAgICAgICByZXR1cm4gbWVyZ2VGcm9tKChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5KW90aGVyKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBzdXBlci5tZXJnZUZyb20ob3RoZXIpOw0KICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbShpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5IG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciA9PSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5LmdldERlZmF1bHRJbnN0YW5jZSgpKSByZXR1cm4gdGhpczsNCiAgICAgICAgdGhpcy5tZXJnZVVua25vd25GaWVsZHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbSgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5IHBhcnNlZE1lc3NhZ2UgPSBudWxsOw0KICAgICAgICB0cnkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSBQQVJTRVIucGFyc2VQYXJ0aWFsRnJvbShpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgICB9IGNhdGNoIChjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiBlKSB7DQogICAgICAgICAgcGFyc2VkTWVzc2FnZSA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkVtcHR5KSBlLmdldFVuZmluaXNoZWRNZXNzYWdlKCk7DQogICAgICAgICAgdGhyb3cgZS51bndyYXBJT0V4Y2VwdGlvbigpOw0KICAgICAgICB9IGZpbmFsbHkgew0KICAgICAgICAgIGlmIChwYXJzZWRNZXNzYWdlICE9IG51bGwpIHsNCiAgICAgICAgICAgIG1lcmdlRnJvbShwYXJzZWRNZXNzYWdlKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBzZXRVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLnNldFVua25vd25GaWVsZHNQcm90bzModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIG1lcmdlVW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5tZXJnZVVua25vd25GaWVsZHModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCg0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfc2NvcGU6a3ViZW1xLkVtcHR5KQ0KICAgIH0NCg0KICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChjbGFzc19zY29wZTprdWJlbXEuRW1wdHkpDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FbXB0eSBERUZBVUxUX0lOU1RBTkNFOw0KICAgIHN0YXRpYyB7DQogICAgICBERUZBVUxUX0lOU1RBTkNFID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkoKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkgZ2V0RGVmYXVsdEluc3RhbmNlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8RW1wdHk+DQogICAgICAgIFBBUlNFUiA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkFic3RyYWN0UGFyc2VyPEVtcHR5PigpIHsNCiAgICAgIHB1YmxpYyBFbXB0eSBwYXJzZVBhcnRpYWxGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgICByZXR1cm4gbmV3IEVtcHR5KGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICB9DQogICAgfTsNCg0KICAgIHB1YmxpYyBzdGF0aWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8RW1wdHk+IHBhcnNlcigpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxFbXB0eT4gZ2V0UGFyc2VyRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRW1wdHkgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFOw0KICAgIH0NCg0KICB9DQoNCiAgcHVibGljIGludGVyZmFjZSBSZXN1bHRPckJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGludGVyZmFjZV9leHRlbmRzOmt1YmVtcS5SZXN1bHQpDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLk1lc3NhZ2VPckJ1aWxkZXIgew0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEV2ZW50SUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldEV2ZW50SUQoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgRXZlbnRJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRFdmVudElEQnl0ZXMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmJvb2wgU2VudCA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGJvb2xlYW4gZ2V0U2VudCgpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gMzs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRFcnJvcigpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRFcnJvckJ5dGVzKCk7DQogIH0NCiAgLyoqDQogICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5SZXN1bHR9DQogICAqLw0KICBwdWJsaWMgIHN0YXRpYyBmaW5hbCBjbGFzcyBSZXN1bHQgZXh0ZW5kcw0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMgaW1wbGVtZW50cw0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KG1lc3NhZ2VfaW1wbGVtZW50czprdWJlbXEuUmVzdWx0KQ0KICAgICAgUmVzdWx0T3JCdWlsZGVyIHsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgbG9uZyBzZXJpYWxWZXJzaW9uVUlEID0gMEw7DQogICAgLy8gVXNlIFJlc3VsdC5uZXdCdWlsZGVyKCkgdG8gY29uc3RydWN0Lg0KICAgIHByaXZhdGUgUmVzdWx0KGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8Pz4gYnVpbGRlcikgew0KICAgICAgc3VwZXIoYnVpbGRlcik7DQogICAgfQ0KICAgIHByaXZhdGUgUmVzdWx0KCkgew0KICAgICAgZXZlbnRJRF8gPSAiIjsNCiAgICAgIHNlbnRfID0gZmFsc2U7DQogICAgICBlcnJvcl8gPSAiIjsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0DQogICAgZ2V0VW5rbm93bkZpZWxkcygpIHsNCiAgICAgIHJldHVybiB0aGlzLnVua25vd25GaWVsZHM7DQogICAgfQ0KICAgIHByaXZhdGUgUmVzdWx0KA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgdGhpcygpOw0KICAgICAgaWYgKGV4dGVuc2lvblJlZ2lzdHJ5ID09IG51bGwpIHsNCiAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgfQ0KICAgICAgaW50IG11dGFibGVfYml0RmllbGQwXyA9IDA7DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldC5CdWlsZGVyIHVua25vd25GaWVsZHMgPQ0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0Lm5ld0J1aWxkZXIoKTsNCiAgICAgIHRyeSB7DQogICAgICAgIGJvb2xlYW4gZG9uZSA9IGZhbHNlOw0KICAgICAgICB3aGlsZSAoIWRvbmUpIHsNCiAgICAgICAgICBpbnQgdGFnID0gaW5wdXQucmVhZFRhZygpOw0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7DQogICAgICAgICAgICBjYXNlIDA6DQogICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGRlZmF1bHQ6IHsNCiAgICAgICAgICAgICAgaWYgKCFwYXJzZVVua25vd25GaWVsZFByb3RvMygNCiAgICAgICAgICAgICAgICAgIGlucHV0LCB1bmtub3duRmllbGRzLCBleHRlbnNpb25SZWdpc3RyeSwgdGFnKSkgew0KICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAxMDogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICBldmVudElEXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAxNjogew0KDQogICAgICAgICAgICAgIHNlbnRfID0gaW5wdXQucmVhZEJvb2woKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDI2OiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIGVycm9yXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBlLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBjYXRjaCAoamF2YS5pby5JT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbigNCiAgICAgICAgICAgIGUpLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgdGhpcy51bmtub3duRmllbGRzID0gdW5rbm93bkZpZWxkcy5idWlsZCgpOw0KICAgICAgICBtYWtlRXh0ZW5zaW9uc0ltbXV0YWJsZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXN1bHRfZGVzY3JpcHRvcjsNCiAgICB9DQoNCiAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgIGludGVybmFsR2V0RmllbGRBY2Nlc3NvclRhYmxlKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXN1bHRfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgLmVuc3VyZUZpZWxkQWNjZXNzb3JzSW5pdGlhbGl6ZWQoDQogICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzdWx0LmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdC5CdWlsZGVyLmNsYXNzKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBFVkVOVElEX0ZJRUxEX05VTUJFUiA9IDE7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IGV2ZW50SURfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFdmVudElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0RXZlbnRJRCgpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gZXZlbnRJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgZXZlbnRJRF8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEV2ZW50SUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldEV2ZW50SURCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gZXZlbnRJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgZXZlbnRJRF8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0VOVF9GSUVMRF9OVU1CRVIgPSAyOw0KICAgIHByaXZhdGUgYm9vbGVhbiBzZW50XzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5ib29sIFNlbnQgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgYm9vbGVhbiBnZXRTZW50KCkgew0KICAgICAgcmV0dXJuIHNlbnRfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEVSUk9SX0ZJRUxEX05VTUJFUiA9IDM7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IGVycm9yXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgRXJyb3IgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRFcnJvcigpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gZXJyb3JfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIGVycm9yXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgRXJyb3IgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldEVycm9yQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGVycm9yXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICBlcnJvcl8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHJpdmF0ZSBieXRlIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IC0xOw0KICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICBieXRlIGlzSW5pdGlhbGl6ZWQgPSBtZW1vaXplZElzSW5pdGlhbGl6ZWQ7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAxKSByZXR1cm4gdHJ1ZTsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDApIHJldHVybiBmYWxzZTsNCg0KICAgICAgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gMTsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCg0KICAgIHB1YmxpYyB2b2lkIHdyaXRlVG8oY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbSBvdXRwdXQpDQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICBpZiAoIWdldEV2ZW50SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDEsIGV2ZW50SURfKTsNCiAgICAgIH0NCiAgICAgIGlmIChzZW50XyAhPSBmYWxzZSkgew0KICAgICAgICBvdXRwdXQud3JpdGVCb29sKDIsIHNlbnRfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0RXJyb3JCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDMsIGVycm9yXyk7DQogICAgICB9DQogICAgICB1bmtub3duRmllbGRzLndyaXRlVG8ob3V0cHV0KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW50IGdldFNlcmlhbGl6ZWRTaXplKCkgew0KICAgICAgaW50IHNpemUgPSBtZW1vaXplZFNpemU7DQogICAgICBpZiAoc2l6ZSAhPSAtMSkgcmV0dXJuIHNpemU7DQoNCiAgICAgIHNpemUgPSAwOw0KICAgICAgaWYgKCFnZXRFdmVudElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSgxLCBldmVudElEXyk7DQogICAgICB9DQogICAgICBpZiAoc2VudF8gIT0gZmFsc2UpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVCb29sU2l6ZSgyLCBzZW50Xyk7DQogICAgICB9DQogICAgICBpZiAoIWdldEVycm9yQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSgzLCBlcnJvcl8pOw0KICAgICAgfQ0KICAgICAgc2l6ZSArPSB1bmtub3duRmllbGRzLmdldFNlcmlhbGl6ZWRTaXplKCk7DQogICAgICBtZW1vaXplZFNpemUgPSBzaXplOw0KICAgICAgcmV0dXJuIHNpemU7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBib29sZWFuIGVxdWFscyhmaW5hbCBqYXZhLmxhbmcuT2JqZWN0IG9iaikgew0KICAgICAgaWYgKG9iaiA9PSB0aGlzKSB7DQogICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgICBpZiAoIShvYmogaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdCkpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLmVxdWFscyhvYmopOw0KICAgICAgfQ0KICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXN1bHQgb3RoZXIgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXN1bHQpIG9iajsNCg0KICAgICAgYm9vbGVhbiByZXN1bHQgPSB0cnVlOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldEV2ZW50SUQoKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0RXZlbnRJRCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiAoZ2V0U2VudCgpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0U2VudCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRFcnJvcigpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRFcnJvcigpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiB1bmtub3duRmllbGRzLmVxdWFscyhvdGhlci51bmtub3duRmllbGRzKTsNCiAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBpbnQgaGFzaENvZGUoKSB7DQogICAgICBpZiAobWVtb2l6ZWRIYXNoQ29kZSAhPSAwKSB7DQogICAgICAgIHJldHVybiBtZW1vaXplZEhhc2hDb2RlOw0KICAgICAgfQ0KICAgICAgaW50IGhhc2ggPSA0MTsNCiAgICAgIGhhc2ggPSAoMTkgKiBoYXNoKSArIGdldERlc2NyaXB0b3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgRVZFTlRJRF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRFdmVudElEKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFNFTlRfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5oYXNoQm9vbGVhbigNCiAgICAgICAgICBnZXRTZW50KCkpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgRVJST1JfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0RXJyb3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgyOSAqIGhhc2gpICsgdW5rbm93bkZpZWxkcy5oYXNoQ29kZSgpOw0KICAgICAgbWVtb2l6ZWRIYXNoQ29kZSA9IGhhc2g7DQogICAgICByZXR1cm4gaGFzaDsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzdWx0IHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5uaW8uQnl0ZUJ1ZmZlciBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXN1bHQgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzdWx0IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdCBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdCBwYXJzZUZyb20oYnl0ZVtdIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdCBwYXJzZUZyb20oDQogICAgICAgIGJ5dGVbXSBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdCBwYXJzZUZyb20oamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzdWx0IHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXN1bHQgcGFyc2VEZWxpbWl0ZWRGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZURlbGltaXRlZFdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdCBwYXJzZURlbGltaXRlZEZyb20oDQogICAgICAgIGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VEZWxpbWl0ZWRXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzdWx0IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXN1bHQgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBCdWlsZGVyIG5ld0J1aWxkZXJGb3JUeXBlKCkgeyByZXR1cm4gbmV3QnVpbGRlcigpOyB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRS50b0J1aWxkZXIoKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXN1bHQgcHJvdG90eXBlKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRS50b0J1aWxkZXIoKS5tZXJnZUZyb20ocHJvdG90eXBlKTsNCiAgICB9DQogICAgcHVibGljIEJ1aWxkZXIgdG9CdWlsZGVyKCkgew0KICAgICAgcmV0dXJuIHRoaXMgPT0gREVGQVVMVF9JTlNUQU5DRQ0KICAgICAgICAgID8gbmV3IEJ1aWxkZXIoKSA6IG5ldyBCdWlsZGVyKCkubWVyZ2VGcm9tKHRoaXMpOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwcm90ZWN0ZWQgQnVpbGRlciBuZXdCdWlsZGVyRm9yVHlwZSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlclBhcmVudCBwYXJlbnQpIHsNCiAgICAgIEJ1aWxkZXIgYnVpbGRlciA9IG5ldyBCdWlsZGVyKHBhcmVudCk7DQogICAgICByZXR1cm4gYnVpbGRlcjsNCiAgICB9DQogICAgLyoqDQogICAgICogUHJvdG9idWYgdHlwZSB7QGNvZGUga3ViZW1xLlJlc3VsdH0NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNsYXNzIEJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPEJ1aWxkZXI+IGltcGxlbWVudHMNCiAgICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfaW1wbGVtZW50czprdWJlbXEuUmVzdWx0KQ0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdE9yQnVpbGRlciB7DQogICAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUmVzdWx0X2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXN1bHRfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdC5jbGFzcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXN1bHQuQnVpbGRlci5jbGFzcyk7DQogICAgICB9DQoNCiAgICAgIC8vIENvbnN0cnVjdCB1c2luZyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdC5uZXdCdWlsZGVyKCkNCiAgICAgIHByaXZhdGUgQnVpbGRlcigpIHsNCiAgICAgICAgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIEJ1aWxkZXIoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlclBhcmVudCBwYXJlbnQpIHsNCiAgICAgICAgc3VwZXIocGFyZW50KTsNCiAgICAgICAgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpOw0KICAgICAgfQ0KICAgICAgcHJpdmF0ZSB2b2lkIG1heWJlRm9yY2VCdWlsZGVySW5pdGlhbGl6YXRpb24oKSB7DQogICAgICAgIGlmIChjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgICAgICAgIC5hbHdheXNVc2VGaWVsZEJ1aWxkZXJzKSB7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyKCkgew0KICAgICAgICBzdXBlci5jbGVhcigpOw0KICAgICAgICBldmVudElEXyA9ICIiOw0KDQogICAgICAgIHNlbnRfID0gZmFsc2U7DQoNCiAgICAgICAgZXJyb3JfID0gIiI7DQoNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXN1bHRfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzdWx0IGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdC5nZXREZWZhdWx0SW5zdGFuY2UoKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzdWx0IGJ1aWxkKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdCByZXN1bHQgPSBidWlsZFBhcnRpYWwoKTsNCiAgICAgICAgaWYgKCFyZXN1bHQuaXNJbml0aWFsaXplZCgpKSB7DQogICAgICAgICAgdGhyb3cgbmV3VW5pbml0aWFsaXplZE1lc3NhZ2VFeGNlcHRpb24ocmVzdWx0KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXN1bHQgYnVpbGRQYXJ0aWFsKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdCByZXN1bHQgPSBuZXcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXN1bHQodGhpcyk7DQogICAgICAgIHJlc3VsdC5ldmVudElEXyA9IGV2ZW50SURfOw0KICAgICAgICByZXN1bHQuc2VudF8gPSBzZW50XzsNCiAgICAgICAgcmVzdWx0LmVycm9yXyA9IGVycm9yXzsNCiAgICAgICAgb25CdWlsdCgpOw0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBjbG9uZSgpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbG9uZSgpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJGaWVsZChmaWVsZCk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck9uZW9mKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuT25lb2ZEZXNjcmlwdG9yIG9uZW9mKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJPbmVvZihvbmVvZik7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGludCBpbmRleCwgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldFJlcGVhdGVkRmllbGQoZmllbGQsIGluZGV4LCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBhZGRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5hZGRSZXBlYXRlZEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oY29tLmdvb2dsZS5wcm90b2J1Zi5NZXNzYWdlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzdWx0KSB7DQogICAgICAgICAgcmV0dXJuIG1lcmdlRnJvbSgoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXN1bHQpb3RoZXIpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHN1cGVyLm1lcmdlRnJvbShvdGhlcik7DQogICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzdWx0IG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciA9PSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdC5nZXREZWZhdWx0SW5zdGFuY2UoKSkgcmV0dXJuIHRoaXM7DQogICAgICAgIGlmICghb3RoZXIuZ2V0RXZlbnRJRCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIGV2ZW50SURfID0gb3RoZXIuZXZlbnRJRF87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmdldFNlbnQoKSAhPSBmYWxzZSkgew0KICAgICAgICAgIHNldFNlbnQob3RoZXIuZ2V0U2VudCgpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIW90aGVyLmdldEVycm9yKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgZXJyb3JfID0gb3RoZXIuZXJyb3JfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMubWVyZ2VVbmtub3duRmllbGRzKG90aGVyLnVua25vd25GaWVsZHMpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXN1bHQgcGFyc2VkTWVzc2FnZSA9IG51bGw7DQogICAgICAgIHRyeSB7DQogICAgICAgICAgcGFyc2VkTWVzc2FnZSA9IFBBUlNFUi5wYXJzZVBhcnRpYWxGcm9tKGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICAgIH0gY2F0Y2ggKGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzdWx0KSBlLmdldFVuZmluaXNoZWRNZXNzYWdlKCk7DQogICAgICAgICAgdGhyb3cgZS51bndyYXBJT0V4Y2VwdGlvbigpOw0KICAgICAgICB9IGZpbmFsbHkgew0KICAgICAgICAgIGlmIChwYXJzZWRNZXNzYWdlICE9IG51bGwpIHsNCiAgICAgICAgICAgIG1lcmdlRnJvbShwYXJzZWRNZXNzYWdlKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCBldmVudElEXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXZlbnRJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRFdmVudElEKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGV2ZW50SURfOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICBldmVudElEXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEV2ZW50SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldEV2ZW50SURCeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBldmVudElEXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBldmVudElEXyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXZlbnRJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRFdmVudElEKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgZXZlbnRJRF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXZlbnRJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckV2ZW50SUQoKSB7DQogICAgICAgIA0KICAgICAgICBldmVudElEXyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldEV2ZW50SUQoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXZlbnRJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRFdmVudElEQnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIGV2ZW50SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBib29sZWFuIHNlbnRfIDsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ym9vbCBTZW50ID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBib29sZWFuIGdldFNlbnQoKSB7DQogICAgICAgIHJldHVybiBzZW50XzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ym9vbCBTZW50ID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFNlbnQoYm9vbGVhbiB2YWx1ZSkgew0KICAgICAgICANCiAgICAgICAgc2VudF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIFNlbnQgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJTZW50KCkgew0KICAgICAgICANCiAgICAgICAgc2VudF8gPSBmYWxzZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgZXJyb3JfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRFcnJvcigpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBlcnJvcl87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIGVycm9yXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRFcnJvckJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGVycm9yXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBlcnJvcl8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEVycm9yKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgZXJyb3JfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyRXJyb3IoKSB7DQogICAgICAgIA0KICAgICAgICBlcnJvcl8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRFcnJvcigpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRFcnJvckJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBlcnJvcl8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgcHVibGljIGZpbmFsIEJ1aWxkZXIgc2V0VW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5zZXRVbmtub3duRmllbGRzUHJvdG8zKHVua25vd25GaWVsZHMpOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBtZXJnZVVua25vd25GaWVsZHMoDQogICAgICAgICAgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQgdW5rbm93bkZpZWxkcykgew0KICAgICAgICByZXR1cm4gc3VwZXIubWVyZ2VVbmtub3duRmllbGRzKHVua25vd25GaWVsZHMpOw0KICAgICAgfQ0KDQoNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChidWlsZGVyX3Njb3BlOmt1YmVtcS5SZXN1bHQpDQogICAgfQ0KDQogICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGNsYXNzX3Njb3BlOmt1YmVtcS5SZXN1bHQpDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXN1bHQgREVGQVVMVF9JTlNUQU5DRTsNCiAgICBzdGF0aWMgew0KICAgICAgREVGQVVMVF9JTlNUQU5DRSA9IG5ldyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3VsdCgpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXN1bHQgZ2V0RGVmYXVsdEluc3RhbmNlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UmVzdWx0Pg0KICAgICAgICBQQVJTRVIgPSBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5BYnN0cmFjdFBhcnNlcjxSZXN1bHQ+KCkgew0KICAgICAgcHVibGljIFJlc3VsdCBwYXJzZVBhcnRpYWxGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgICByZXR1cm4gbmV3IFJlc3VsdChpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgfQ0KICAgIH07DQoNCiAgICBwdWJsaWMgc3RhdGljIGNvbS5nb29nbGUucHJvdG9idWYuUGFyc2VyPFJlc3VsdD4gcGFyc2VyKCkgew0KICAgICAgcmV0dXJuIFBBUlNFUjsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuUGFyc2VyPFJlc3VsdD4gZ2V0UGFyc2VyRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzdWx0IGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRTsNCiAgICB9DQoNCiAgfQ0KDQogIHB1YmxpYyBpbnRlcmZhY2UgRXZlbnRPckJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGludGVyZmFjZV9leHRlbmRzOmt1YmVtcS5FdmVudCkNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZU9yQnVpbGRlciB7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgRXZlbnRJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0RXZlbnRJRCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFdmVudElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldEV2ZW50SURCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRDbGllbnRJRCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRDbGllbnRJREJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2hhbm5lbCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldENoYW5uZWxCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNDs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRNZXRhZGF0YSgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRNZXRhZGF0YUJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5ieXRlcyBCb2R5ID0gNTs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGdldEJvZHkoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmJvb2wgU3RvcmUgPSA2OzwvY29kZT4NCiAgICAgKi8NCiAgICBib29sZWFuIGdldFN0b3JlKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA3OzwvY29kZT4NCiAgICAgKi8NCiAgICBpbnQgZ2V0VGFnc0NvdW50KCk7DQogICAgLyoqDQogICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNzs8L2NvZGU+DQogICAgICovDQogICAgYm9vbGVhbiBjb250YWluc1RhZ3MoDQogICAgICAgIGphdmEubGFuZy5TdHJpbmcga2V5KTsNCiAgICAvKioNCiAgICAgKiBVc2Uge0BsaW5rICNnZXRUYWdzTWFwKCl9IGluc3RlYWQuDQogICAgICovDQogICAgQGphdmEubGFuZy5EZXByZWNhdGVkDQogICAgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgIGdldFRhZ3MoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA3OzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+DQogICAgZ2V0VGFnc01hcCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDc7PC9jb2RlPg0KICAgICAqLw0KDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRUYWdzT3JEZWZhdWx0KA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSwNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBkZWZhdWx0VmFsdWUpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDc7PC9jb2RlPg0KICAgICAqLw0KDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRUYWdzT3JUaHJvdygNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpOw0KICB9DQogIC8qKg0KICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuRXZlbnR9DQogICAqLw0KICBwdWJsaWMgIHN0YXRpYyBmaW5hbCBjbGFzcyBFdmVudCBleHRlbmRzDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMyBpbXBsZW1lbnRzDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQobWVzc2FnZV9pbXBsZW1lbnRzOmt1YmVtcS5FdmVudCkNCiAgICAgIEV2ZW50T3JCdWlsZGVyIHsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgbG9uZyBzZXJpYWxWZXJzaW9uVUlEID0gMEw7DQogICAgLy8gVXNlIEV2ZW50Lm5ld0J1aWxkZXIoKSB0byBjb25zdHJ1Y3QuDQogICAgcHJpdmF0ZSBFdmVudChjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPD8+IGJ1aWxkZXIpIHsNCiAgICAgIHN1cGVyKGJ1aWxkZXIpOw0KICAgIH0NCiAgICBwcml2YXRlIEV2ZW50KCkgew0KICAgICAgZXZlbnRJRF8gPSAiIjsNCiAgICAgIGNsaWVudElEXyA9ICIiOw0KICAgICAgY2hhbm5lbF8gPSAiIjsNCiAgICAgIG1ldGFkYXRhXyA9ICIiOw0KICAgICAgYm9keV8gPSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuRU1QVFk7DQogICAgICBzdG9yZV8gPSBmYWxzZTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0DQogICAgZ2V0VW5rbm93bkZpZWxkcygpIHsNCiAgICAgIHJldHVybiB0aGlzLnVua25vd25GaWVsZHM7DQogICAgfQ0KICAgIHByaXZhdGUgRXZlbnQoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICB0aGlzKCk7DQogICAgICBpZiAoZXh0ZW5zaW9uUmVnaXN0cnkgPT0gbnVsbCkgew0KICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogICAgICB9DQogICAgICBpbnQgbXV0YWJsZV9iaXRGaWVsZDBfID0gMDsNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0LkJ1aWxkZXIgdW5rbm93bkZpZWxkcyA9DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQubmV3QnVpbGRlcigpOw0KICAgICAgdHJ5IHsNCiAgICAgICAgYm9vbGVhbiBkb25lID0gZmFsc2U7DQogICAgICAgIHdoaWxlICghZG9uZSkgew0KICAgICAgICAgIGludCB0YWcgPSBpbnB1dC5yZWFkVGFnKCk7DQogICAgICAgICAgc3dpdGNoICh0YWcpIHsNCiAgICAgICAgICAgIGNhc2UgMDoNCiAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgZGVmYXVsdDogew0KICAgICAgICAgICAgICBpZiAoIXBhcnNlVW5rbm93bkZpZWxkUHJvdG8zKA0KICAgICAgICAgICAgICAgICAgaW5wdXQsIHVua25vd25GaWVsZHMsIGV4dGVuc2lvblJlZ2lzdHJ5LCB0YWcpKSB7DQogICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDEwOiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIGV2ZW50SURfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDE4OiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIGNsaWVudElEXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAyNjogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICBjaGFubmVsXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAzNDogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICBtZXRhZGF0YV8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNDI6IHsNCg0KICAgICAgICAgICAgICBib2R5XyA9IGlucHV0LnJlYWRCeXRlcygpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNDg6IHsNCg0KICAgICAgICAgICAgICBzdG9yZV8gPSBpbnB1dC5yZWFkQm9vbCgpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNTg6IHsNCiAgICAgICAgICAgICAgaWYgKCEoKG11dGFibGVfYml0RmllbGQwXyAmIDB4MDAwMDAwNDApID09IDB4MDAwMDAwNDApKSB7DQogICAgICAgICAgICAgICAgdGFnc18gPSBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkLm5ld01hcEZpZWxkKA0KICAgICAgICAgICAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeSk7DQogICAgICAgICAgICAgICAgbXV0YWJsZV9iaXRGaWVsZDBfIHw9IDB4MDAwMDAwNDA7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBFbnRyeTxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgICAgICAgICAgICB0YWdzX18gPSBpbnB1dC5yZWFkTWVzc2FnZSgNCiAgICAgICAgICAgICAgICAgIFRhZ3NEZWZhdWx0RW50cnlIb2xkZXIuZGVmYXVsdEVudHJ5LmdldFBhcnNlckZvclR5cGUoKSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgICAgICAgICB0YWdzXy5nZXRNdXRhYmxlTWFwKCkucHV0KA0KICAgICAgICAgICAgICAgICAgdGFnc19fLmdldEtleSgpLCB0YWdzX18uZ2V0VmFsdWUoKSk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBlLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBjYXRjaCAoamF2YS5pby5JT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbigNCiAgICAgICAgICAgIGUpLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgdGhpcy51bmtub3duRmllbGRzID0gdW5rbm93bkZpZWxkcy5idWlsZCgpOw0KICAgICAgICBtYWtlRXh0ZW5zaW9uc0ltbXV0YWJsZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FdmVudF9kZXNjcmlwdG9yOw0KICAgIH0NCg0KICAgIEBTdXBwcmVzc1dhcm5pbmdzKHsicmF3dHlwZXMifSkNCiAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZCBpbnRlcm5hbEdldE1hcEZpZWxkKA0KICAgICAgICBpbnQgbnVtYmVyKSB7DQogICAgICBzd2l0Y2ggKG51bWJlcikgew0KICAgICAgICBjYXNlIDc6DQogICAgICAgICAgcmV0dXJuIGludGVybmFsR2V0VGFncygpOw0KICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXhjZXB0aW9uKA0KICAgICAgICAgICAgICAiSW52YWxpZCBtYXAgZmllbGQgbnVtYmVyOiAiICsgbnVtYmVyKTsNCiAgICAgIH0NCiAgICB9DQogICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgLmVuc3VyZUZpZWxkQWNjZXNzb3JzSW5pdGlhbGl6ZWQoDQogICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQuQnVpbGRlci5jbGFzcyk7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBpbnQgYml0RmllbGQwXzsNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBFVkVOVElEX0ZJRUxEX05VTUJFUiA9IDE7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IGV2ZW50SURfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFdmVudElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0RXZlbnRJRCgpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gZXZlbnRJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgZXZlbnRJRF8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEV2ZW50SUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldEV2ZW50SURCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gZXZlbnRJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgZXZlbnRJRF8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQ0xJRU5USURfRklFTERfTlVNQkVSID0gMjsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgY2xpZW50SURfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldENsaWVudElEKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjbGllbnRJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgY2xpZW50SURfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0Q2xpZW50SURCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2xpZW50SURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIGNsaWVudElEXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDSEFOTkVMX0ZJRUxEX05VTUJFUiA9IDM7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IGNoYW5uZWxfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2hhbm5lbCgpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2hhbm5lbF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgY2hhbm5lbF8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldENoYW5uZWxCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2hhbm5lbF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgY2hhbm5lbF8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTUVUQURBVEFfRklFTERfTlVNQkVSID0gNDsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgbWV0YWRhdGFfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldE1ldGFkYXRhKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBtZXRhZGF0YV87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgbWV0YWRhdGFfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0TWV0YWRhdGFCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gbWV0YWRhdGFfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIG1ldGFkYXRhXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBCT0RZX0ZJRUxEX05VTUJFUiA9IDU7DQogICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYm9keV87DQogICAgLyoqDQogICAgICogPGNvZGU+Ynl0ZXMgQm9keSA9IDU7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZ2V0Qm9keSgpIHsNCiAgICAgIHJldHVybiBib2R5XzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTVE9SRV9GSUVMRF9OVU1CRVIgPSA2Ow0KICAgIHByaXZhdGUgYm9vbGVhbiBzdG9yZV87DQogICAgLyoqDQogICAgICogPGNvZGU+Ym9vbCBTdG9yZSA9IDY7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBib29sZWFuIGdldFN0b3JlKCkgew0KICAgICAgcmV0dXJuIHN0b3JlXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBUQUdTX0ZJRUxEX05VTUJFUiA9IDc7DQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY2xhc3MgVGFnc0RlZmF1bHRFbnRyeUhvbGRlciB7DQogICAgICBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBFbnRyeTwNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBkZWZhdWx0RW50cnkgPQ0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEVudHJ5DQogICAgICAgICAgICAgIC48amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz5uZXdEZWZhdWx0SW5zdGFuY2UoDQogICAgICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRfVGFnc0VudHJ5X2Rlc2NyaXB0b3IsIA0KICAgICAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5XaXJlRm9ybWF0LkZpZWxkVHlwZS5TVFJJTkcsDQogICAgICAgICAgICAgICAgICAiIiwNCiAgICAgICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuV2lyZUZvcm1hdC5GaWVsZFR5cGUuU1RSSU5HLA0KICAgICAgICAgICAgICAgICAgIiIpOw0KICAgIH0NCiAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQ8DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IHRhZ3NfOw0KICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgIGludGVybmFsR2V0VGFncygpIHsNCiAgICAgIGlmICh0YWdzXyA9PSBudWxsKSB7DQogICAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkLmVtcHR5TWFwRmllbGQoDQogICAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeSk7DQogICAgICB9DQogICAgICByZXR1cm4gdGFnc187DQogICAgfQ0KDQogICAgcHVibGljIGludCBnZXRUYWdzQ291bnQoKSB7DQogICAgICByZXR1cm4gaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCkuc2l6ZSgpOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA3OzwvY29kZT4NCiAgICAgKi8NCg0KICAgIHB1YmxpYyBib29sZWFuIGNvbnRhaW5zVGFncygNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpIHsNCiAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKS5jb250YWluc0tleShrZXkpOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiBVc2Uge0BsaW5rICNnZXRUYWdzTWFwKCl9IGluc3RlYWQuDQogICAgICovDQogICAgQGphdmEubGFuZy5EZXByZWNhdGVkDQogICAgcHVibGljIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gZ2V0VGFncygpIHsNCiAgICAgIHJldHVybiBnZXRUYWdzTWFwKCk7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDc7PC9jb2RlPg0KICAgICAqLw0KDQogICAgcHVibGljIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gZ2V0VGFnc01hcCgpIHsNCiAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNzs8L2NvZGU+DQogICAgICovDQoNCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRUYWdzT3JEZWZhdWx0KA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSwNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBkZWZhdWx0VmFsdWUpIHsNCiAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gbWFwID0NCiAgICAgICAgICBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICAgIHJldHVybiBtYXAuY29udGFpbnNLZXkoa2V5KSA/IG1hcC5nZXQoa2V5KSA6IGRlZmF1bHRWYWx1ZTsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNzs8L2NvZGU+DQogICAgICovDQoNCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRUYWdzT3JUaHJvdygNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpIHsNCiAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gbWFwID0NCiAgICAgICAgICBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICAgIGlmICghbWFwLmNvbnRhaW5zS2V5KGtleSkpIHsNCiAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5JbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24oKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBtYXAuZ2V0KGtleSk7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBieXRlIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IC0xOw0KICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICBieXRlIGlzSW5pdGlhbGl6ZWQgPSBtZW1vaXplZElzSW5pdGlhbGl6ZWQ7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAxKSByZXR1cm4gdHJ1ZTsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDApIHJldHVybiBmYWxzZTsNCg0KICAgICAgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gMTsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCg0KICAgIHB1YmxpYyB2b2lkIHdyaXRlVG8oY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbSBvdXRwdXQpDQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICBpZiAoIWdldEV2ZW50SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDEsIGV2ZW50SURfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0Q2xpZW50SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDIsIGNsaWVudElEXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldENoYW5uZWxCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDMsIGNoYW5uZWxfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0TWV0YWRhdGFCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDQsIG1ldGFkYXRhXyk7DQogICAgICB9DQogICAgICBpZiAoIWJvZHlfLmlzRW1wdHkoKSkgew0KICAgICAgICBvdXRwdXQud3JpdGVCeXRlcyg1LCBib2R5Xyk7DQogICAgICB9DQogICAgICBpZiAoc3RvcmVfICE9IGZhbHNlKSB7DQogICAgICAgIG91dHB1dC53cml0ZUJvb2woNiwgc3RvcmVfKTsNCiAgICAgIH0NCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgIC5zZXJpYWxpemVTdHJpbmdNYXBUbygNCiAgICAgICAgICBvdXRwdXQsDQogICAgICAgICAgaW50ZXJuYWxHZXRUYWdzKCksDQogICAgICAgICAgVGFnc0RlZmF1bHRFbnRyeUhvbGRlci5kZWZhdWx0RW50cnksDQogICAgICAgICAgNyk7DQogICAgICB1bmtub3duRmllbGRzLndyaXRlVG8ob3V0cHV0KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW50IGdldFNlcmlhbGl6ZWRTaXplKCkgew0KICAgICAgaW50IHNpemUgPSBtZW1vaXplZFNpemU7DQogICAgICBpZiAoc2l6ZSAhPSAtMSkgcmV0dXJuIHNpemU7DQoNCiAgICAgIHNpemUgPSAwOw0KICAgICAgaWYgKCFnZXRFdmVudElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSgxLCBldmVudElEXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldENsaWVudElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSgyLCBjbGllbnRJRF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRDaGFubmVsQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSgzLCBjaGFubmVsXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldE1ldGFkYXRhQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSg0LCBtZXRhZGF0YV8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFib2R5Xy5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVCeXRlc1NpemUoNSwgYm9keV8pOw0KICAgICAgfQ0KICAgICAgaWYgKHN0b3JlXyAhPSBmYWxzZSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUJvb2xTaXplKDYsIHN0b3JlXyk7DQogICAgICB9DQogICAgICBmb3IgKGphdmEudXRpbC5NYXAuRW50cnk8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gZW50cnkNCiAgICAgICAgICAgOiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKS5lbnRyeVNldCgpKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRW50cnk8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4NCiAgICAgICAgdGFnc19fID0gVGFnc0RlZmF1bHRFbnRyeUhvbGRlci5kZWZhdWx0RW50cnkubmV3QnVpbGRlckZvclR5cGUoKQ0KICAgICAgICAgICAgLnNldEtleShlbnRyeS5nZXRLZXkoKSkNCiAgICAgICAgICAgIC5zZXRWYWx1ZShlbnRyeS5nZXRWYWx1ZSgpKQ0KICAgICAgICAgICAgLmJ1aWxkKCk7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgICAgLmNvbXB1dGVNZXNzYWdlU2l6ZSg3LCB0YWdzX18pOw0KICAgICAgfQ0KICAgICAgc2l6ZSArPSB1bmtub3duRmllbGRzLmdldFNlcmlhbGl6ZWRTaXplKCk7DQogICAgICBtZW1vaXplZFNpemUgPSBzaXplOw0KICAgICAgcmV0dXJuIHNpemU7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBib29sZWFuIGVxdWFscyhmaW5hbCBqYXZhLmxhbmcuT2JqZWN0IG9iaikgew0KICAgICAgaWYgKG9iaiA9PSB0aGlzKSB7DQogICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgICBpZiAoIShvYmogaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50KSkgew0KICAgICAgICByZXR1cm4gc3VwZXIuZXF1YWxzKG9iaik7DQogICAgICB9DQogICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50IG90aGVyID0gKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQpIG9iajsNCg0KICAgICAgYm9vbGVhbiByZXN1bHQgPSB0cnVlOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldEV2ZW50SUQoKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0RXZlbnRJRCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRDbGllbnRJRCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRDbGllbnRJRCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRDaGFubmVsKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldENoYW5uZWwoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0TWV0YWRhdGEoKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0TWV0YWRhdGEoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0Qm9keSgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRCb2R5KCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChnZXRTdG9yZSgpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0U3RvcmUoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgaW50ZXJuYWxHZXRUYWdzKCkuZXF1YWxzKA0KICAgICAgICAgIG90aGVyLmludGVybmFsR2V0VGFncygpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiB1bmtub3duRmllbGRzLmVxdWFscyhvdGhlci51bmtub3duRmllbGRzKTsNCiAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBpbnQgaGFzaENvZGUoKSB7DQogICAgICBpZiAobWVtb2l6ZWRIYXNoQ29kZSAhPSAwKSB7DQogICAgICAgIHJldHVybiBtZW1vaXplZEhhc2hDb2RlOw0KICAgICAgfQ0KICAgICAgaW50IGhhc2ggPSA0MTsNCiAgICAgIGhhc2ggPSAoMTkgKiBoYXNoKSArIGdldERlc2NyaXB0b3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgRVZFTlRJRF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRFdmVudElEKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIENMSUVOVElEX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldENsaWVudElEKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIENIQU5ORUxfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0Q2hhbm5lbCgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBNRVRBREFUQV9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRNZXRhZGF0YSgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBCT0RZX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldEJvZHkoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgU1RPUkVfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5oYXNoQm9vbGVhbigNCiAgICAgICAgICBnZXRTdG9yZSgpKTsNCiAgICAgIGlmICghaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFRBR1NfRklFTERfTlVNQkVSOw0KICAgICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBpbnRlcm5hbEdldFRhZ3MoKS5oYXNoQ29kZSgpOw0KICAgICAgfQ0KICAgICAgaGFzaCA9ICgyOSAqIGhhc2gpICsgdW5rbm93bkZpZWxkcy5oYXNoQ29kZSgpOw0KICAgICAgbWVtb2l6ZWRIYXNoQ29kZSA9IGhhc2g7DQogICAgICByZXR1cm4gaGFzaDsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50IHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5uaW8uQnl0ZUJ1ZmZlciBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQgcGFyc2VGcm9tKGJ5dGVbXSBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudCBwYXJzZUZyb20oDQogICAgICAgIGJ5dGVbXSBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50IHBhcnNlRnJvbShqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudCBwYXJzZUZyb20oDQogICAgICAgIGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQgcGFyc2VEZWxpbWl0ZWRGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZURlbGltaXRlZFdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50IHBhcnNlRGVsaW1pdGVkRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZURlbGltaXRlZFdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudCBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBCdWlsZGVyIG5ld0J1aWxkZXJGb3JUeXBlKCkgeyByZXR1cm4gbmV3QnVpbGRlcigpOyB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRS50b0J1aWxkZXIoKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudCBwcm90b3R5cGUpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFLnRvQnVpbGRlcigpLm1lcmdlRnJvbShwcm90b3R5cGUpOw0KICAgIH0NCiAgICBwdWJsaWMgQnVpbGRlciB0b0J1aWxkZXIoKSB7DQogICAgICByZXR1cm4gdGhpcyA9PSBERUZBVUxUX0lOU1RBTkNFDQogICAgICAgICAgPyBuZXcgQnVpbGRlcigpIDogbmV3IEJ1aWxkZXIoKS5tZXJnZUZyb20odGhpcyk7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHByb3RlY3RlZCBCdWlsZGVyIG5ld0J1aWxkZXJGb3JUeXBlKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgQnVpbGRlciBidWlsZGVyID0gbmV3IEJ1aWxkZXIocGFyZW50KTsNCiAgICAgIHJldHVybiBidWlsZGVyOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuRXZlbnR9DQogICAgICovDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBjbGFzcyBCdWlsZGVyIGV4dGVuZHMNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlcjxCdWlsZGVyPiBpbXBsZW1lbnRzDQogICAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChidWlsZGVyX2ltcGxlbWVudHM6a3ViZW1xLkV2ZW50KQ0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50T3JCdWlsZGVyIHsNCiAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvcigpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FdmVudF9kZXNjcmlwdG9yOw0KICAgICAgfQ0KDQogICAgICBAU3VwcHJlc3NXYXJuaW5ncyh7InJhd3R5cGVzIn0pDQogICAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZCBpbnRlcm5hbEdldE1hcEZpZWxkKA0KICAgICAgICAgIGludCBudW1iZXIpIHsNCiAgICAgICAgc3dpdGNoIChudW1iZXIpIHsNCiAgICAgICAgICBjYXNlIDc6DQogICAgICAgICAgICByZXR1cm4gaW50ZXJuYWxHZXRUYWdzKCk7DQogICAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXhjZXB0aW9uKA0KICAgICAgICAgICAgICAgICJJbnZhbGlkIG1hcCBmaWVsZCBudW1iZXI6ICIgKyBudW1iZXIpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICBAU3VwcHJlc3NXYXJuaW5ncyh7InJhd3R5cGVzIn0pDQogICAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZCBpbnRlcm5hbEdldE11dGFibGVNYXBGaWVsZCgNCiAgICAgICAgICBpbnQgbnVtYmVyKSB7DQogICAgICAgIHN3aXRjaCAobnVtYmVyKSB7DQogICAgICAgICAgY2FzZSA3Og0KICAgICAgICAgICAgcmV0dXJuIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKTsNCiAgICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFeGNlcHRpb24oDQogICAgICAgICAgICAgICAgIkludmFsaWQgbWFwIGZpZWxkIG51bWJlcjogIiArIG51bWJlcik7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FdmVudF9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAgIC5lbnN1cmVGaWVsZEFjY2Vzc29yc0luaXRpYWxpemVkKA0KICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQuQnVpbGRlci5jbGFzcyk7DQogICAgICB9DQoNCiAgICAgIC8vIENvbnN0cnVjdCB1c2luZyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50Lm5ld0J1aWxkZXIoKQ0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKCkgew0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgQnVpbGRlcigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgICBzdXBlcihwYXJlbnQpOw0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQogICAgICBwcml2YXRlIHZvaWQgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpIHsNCiAgICAgICAgaWYgKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgICAgICAgLmFsd2F5c1VzZUZpZWxkQnVpbGRlcnMpIHsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXIoKSB7DQogICAgICAgIHN1cGVyLmNsZWFyKCk7DQogICAgICAgIGV2ZW50SURfID0gIiI7DQoNCiAgICAgICAgY2xpZW50SURfID0gIiI7DQoNCiAgICAgICAgY2hhbm5lbF8gPSAiIjsNCg0KICAgICAgICBtZXRhZGF0YV8gPSAiIjsNCg0KICAgICAgICBib2R5XyA9IGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5FTVBUWTsNCg0KICAgICAgICBzdG9yZV8gPSBmYWxzZTsNCg0KICAgICAgICBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkuY2xlYXIoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FdmVudF9kZXNjcmlwdG9yOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudCBnZXREZWZhdWx0SW5zdGFuY2VGb3JUeXBlKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudC5nZXREZWZhdWx0SW5zdGFuY2UoKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQgYnVpbGQoKSB7DQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQgcmVzdWx0ID0gYnVpbGRQYXJ0aWFsKCk7DQogICAgICAgIGlmICghcmVzdWx0LmlzSW5pdGlhbGl6ZWQoKSkgew0KICAgICAgICAgIHRocm93IG5ld1VuaW5pdGlhbGl6ZWRNZXNzYWdlRXhjZXB0aW9uKHJlc3VsdCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQgYnVpbGRQYXJ0aWFsKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50IHJlc3VsdCA9IG5ldyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50KHRoaXMpOw0KICAgICAgICBpbnQgZnJvbV9iaXRGaWVsZDBfID0gYml0RmllbGQwXzsNCiAgICAgICAgaW50IHRvX2JpdEZpZWxkMF8gPSAwOw0KICAgICAgICByZXN1bHQuZXZlbnRJRF8gPSBldmVudElEXzsNCiAgICAgICAgcmVzdWx0LmNsaWVudElEXyA9IGNsaWVudElEXzsNCiAgICAgICAgcmVzdWx0LmNoYW5uZWxfID0gY2hhbm5lbF87DQogICAgICAgIHJlc3VsdC5tZXRhZGF0YV8gPSBtZXRhZGF0YV87DQogICAgICAgIHJlc3VsdC5ib2R5XyA9IGJvZHlfOw0KICAgICAgICByZXN1bHQuc3RvcmVfID0gc3RvcmVfOw0KICAgICAgICByZXN1bHQudGFnc18gPSBpbnRlcm5hbEdldFRhZ3MoKTsNCiAgICAgICAgcmVzdWx0LnRhZ3NfLm1ha2VJbW11dGFibGUoKTsNCiAgICAgICAgcmVzdWx0LmJpdEZpZWxkMF8gPSB0b19iaXRGaWVsZDBfOw0KICAgICAgICBvbkJ1aWx0KCk7DQogICAgICAgIHJldHVybiByZXN1bHQ7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsb25lKCkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsb25lKCk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuc2V0RmllbGQoZmllbGQsIHZhbHVlKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyRmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbGVhckZpZWxkKGZpZWxkKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyT25lb2YoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5PbmVvZkRlc2NyaXB0b3Igb25lb2YpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbGVhck9uZW9mKG9uZW9mKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlcGVhdGVkRmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgaW50IGluZGV4LCBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuc2V0UmVwZWF0ZWRGaWVsZChmaWVsZCwgaW5kZXgsIHZhbHVlKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGFkZFJlcGVhdGVkRmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmFkZFJlcGVhdGVkRmllbGQoZmllbGQsIHZhbHVlKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbShjb20uZ29vZ2xlLnByb3RvYnVmLk1lc3NhZ2Ugb3RoZXIpIHsNCiAgICAgICAgaWYgKG90aGVyIGluc3RhbmNlb2YgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudCkgew0KICAgICAgICAgIHJldHVybiBtZXJnZUZyb20oKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQpb3RoZXIpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHN1cGVyLm1lcmdlRnJvbShvdGhlcik7DQogICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQgb3RoZXIpIHsNCiAgICAgICAgaWYgKG90aGVyID09IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQuZ2V0RGVmYXVsdEluc3RhbmNlKCkpIHJldHVybiB0aGlzOw0KICAgICAgICBpZiAoIW90aGVyLmdldEV2ZW50SUQoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICBldmVudElEXyA9IG90aGVyLmV2ZW50SURfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmICghb3RoZXIuZ2V0Q2xpZW50SUQoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICBjbGllbnRJRF8gPSBvdGhlci5jbGllbnRJRF87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRDaGFubmVsKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgY2hhbm5lbF8gPSBvdGhlci5jaGFubmVsXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIW90aGVyLmdldE1ldGFkYXRhKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgbWV0YWRhdGFfID0gb3RoZXIubWV0YWRhdGFfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRCb2R5KCkgIT0gY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLkVNUFRZKSB7DQogICAgICAgICAgc2V0Qm9keShvdGhlci5nZXRCb2R5KCkpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRTdG9yZSgpICE9IGZhbHNlKSB7DQogICAgICAgICAgc2V0U3RvcmUob3RoZXIuZ2V0U3RvcmUoKSk7DQogICAgICAgIH0NCiAgICAgICAgaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpLm1lcmdlRnJvbSgNCiAgICAgICAgICAgIG90aGVyLmludGVybmFsR2V0VGFncygpKTsNCiAgICAgICAgdGhpcy5tZXJnZVVua25vd25GaWVsZHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbSgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50IHBhcnNlZE1lc3NhZ2UgPSBudWxsOw0KICAgICAgICB0cnkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSBQQVJTRVIucGFyc2VQYXJ0aWFsRnJvbShpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgICB9IGNhdGNoIChjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiBlKSB7DQogICAgICAgICAgcGFyc2VkTWVzc2FnZSA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50KSBlLmdldFVuZmluaXNoZWRNZXNzYWdlKCk7DQogICAgICAgICAgdGhyb3cgZS51bndyYXBJT0V4Y2VwdGlvbigpOw0KICAgICAgICB9IGZpbmFsbHkgew0KICAgICAgICAgIGlmIChwYXJzZWRNZXNzYWdlICE9IG51bGwpIHsNCiAgICAgICAgICAgIG1lcmdlRnJvbShwYXJzZWRNZXNzYWdlKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICBwcml2YXRlIGludCBiaXRGaWVsZDBfOw0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgZXZlbnRJRF8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEV2ZW50SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0RXZlbnRJRCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBldmVudElEXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgZXZlbnRJRF8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBFdmVudElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRFdmVudElEQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gZXZlbnRJRF87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgZXZlbnRJRF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEV2ZW50SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RXZlbnRJRCgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIGV2ZW50SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEV2ZW50SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJFdmVudElEKCkgew0KICAgICAgICANCiAgICAgICAgZXZlbnRJRF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRFdmVudElEKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEV2ZW50SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RXZlbnRJREJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBldmVudElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCBjbGllbnRJRF8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldENsaWVudElEKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNsaWVudElEXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgY2xpZW50SURfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldENsaWVudElEQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2xpZW50SURfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIGNsaWVudElEXyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2xpZW50SUQoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBjbGllbnRJRF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJDbGllbnRJRCgpIHsNCiAgICAgICAgDQogICAgICAgIGNsaWVudElEXyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldENsaWVudElEKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldENsaWVudElEQnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIGNsaWVudElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCBjaGFubmVsXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDaGFubmVsKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNoYW5uZWxfOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICBjaGFubmVsXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldENoYW5uZWxCeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBjaGFubmVsXyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRDaGFubmVsKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgY2hhbm5lbF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckNoYW5uZWwoKSB7DQogICAgICAgIA0KICAgICAgICBjaGFubmVsXyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldENoYW5uZWwoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRDaGFubmVsQnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIGNoYW5uZWxfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IG1ldGFkYXRhXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTWV0YWRhdGEgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0TWV0YWRhdGEoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gbWV0YWRhdGFfOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICBtZXRhZGF0YV8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0TWV0YWRhdGFCeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBtZXRhZGF0YV87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgbWV0YWRhdGFfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRNZXRhZGF0YSgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIG1ldGFkYXRhXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck1ldGFkYXRhKCkgew0KICAgICAgICANCiAgICAgICAgbWV0YWRhdGFfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0TWV0YWRhdGEoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTWV0YWRhdGEgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0TWV0YWRhdGFCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgbWV0YWRhdGFfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYm9keV8gPSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuRU1QVFk7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJ5dGVzIEJvZHkgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBnZXRCb2R5KCkgew0KICAgICAgICByZXR1cm4gYm9keV87DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJ5dGVzIEJvZHkgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Qm9keShjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgYm9keV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ieXRlcyBCb2R5ID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyQm9keSgpIHsNCiAgICAgICAgDQogICAgICAgIGJvZHlfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0Qm9keSgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgYm9vbGVhbiBzdG9yZV8gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIFN0b3JlID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBib29sZWFuIGdldFN0b3JlKCkgew0KICAgICAgICByZXR1cm4gc3RvcmVfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIFN0b3JlID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFN0b3JlKGJvb2xlYW4gdmFsdWUpIHsNCiAgICAgICAgDQogICAgICAgIHN0b3JlXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJvb2wgU3RvcmUgPSA2OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJTdG9yZSgpIHsNCiAgICAgICAgDQogICAgICAgIHN0b3JlXyA9IGZhbHNlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZDwNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiB0YWdzXzsNCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgICAgaW50ZXJuYWxHZXRUYWdzKCkgew0KICAgICAgICBpZiAodGFnc18gPT0gbnVsbCkgew0KICAgICAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkLmVtcHR5TWFwRmllbGQoDQogICAgICAgICAgICAgIFRhZ3NEZWZhdWx0RW50cnlIb2xkZXIuZGVmYXVsdEVudHJ5KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGFnc187DQogICAgICB9DQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQ8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4NCiAgICAgIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKSB7DQogICAgICAgIG9uQ2hhbmdlZCgpOzsNCiAgICAgICAgaWYgKHRhZ3NfID09IG51bGwpIHsNCiAgICAgICAgICB0YWdzXyA9IGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQubmV3TWFwRmllbGQoDQogICAgICAgICAgICAgIFRhZ3NEZWZhdWx0RW50cnlIb2xkZXIuZGVmYXVsdEVudHJ5KTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIXRhZ3NfLmlzTXV0YWJsZSgpKSB7DQogICAgICAgICAgdGFnc18gPSB0YWdzXy5jb3B5KCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRhZ3NfOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW50IGdldFRhZ3NDb3VudCgpIHsNCiAgICAgICAgcmV0dXJuIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpLnNpemUoKTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNzs8L2NvZGU+DQogICAgICAgKi8NCg0KICAgICAgcHVibGljIGJvb2xlYW4gY29udGFpbnNUYWdzKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcga2V5KSB7DQogICAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgICAgcmV0dXJuIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpLmNvbnRhaW5zS2V5KGtleSk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIFVzZSB7QGxpbmsgI2dldFRhZ3NNYXAoKX0gaW5zdGVhZC4NCiAgICAgICAqLw0KICAgICAgQGphdmEubGFuZy5EZXByZWNhdGVkDQogICAgICBwdWJsaWMgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBnZXRUYWdzKCkgew0KICAgICAgICByZXR1cm4gZ2V0VGFnc01hcCgpOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA3OzwvY29kZT4NCiAgICAgICAqLw0KDQogICAgICBwdWJsaWMgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBnZXRUYWdzTWFwKCkgew0KICAgICAgICByZXR1cm4gaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDc7PC9jb2RlPg0KICAgICAgICovDQoNCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFRhZ3NPckRlZmF1bHQoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXksDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBkZWZhdWx0VmFsdWUpIHsNCiAgICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IG1hcCA9DQogICAgICAgICAgICBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICAgICAgcmV0dXJuIG1hcC5jb250YWluc0tleShrZXkpID8gbWFwLmdldChrZXkpIDogZGVmYXVsdFZhbHVlOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA3OzwvY29kZT4NCiAgICAgICAqLw0KDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRUYWdzT3JUaHJvdygNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSkgew0KICAgICAgICBpZiAoa2V5ID09IG51bGwpIHsgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOyB9DQogICAgICAgIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gbWFwID0NCiAgICAgICAgICAgIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpOw0KICAgICAgICBpZiAoIW1hcC5jb250YWluc0tleShrZXkpKSB7DQogICAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5JbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24oKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gbWFwLmdldChrZXkpOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhclRhZ3MoKSB7DQogICAgICAgIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKS5nZXRNdXRhYmxlTWFwKCkNCiAgICAgICAgICAgIC5jbGVhcigpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNzs8L2NvZGU+DQogICAgICAgKi8NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgcmVtb3ZlVGFncygNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSkgew0KICAgICAgICBpZiAoa2V5ID09IG51bGwpIHsgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOyB9DQogICAgICAgIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKS5nZXRNdXRhYmxlTWFwKCkNCiAgICAgICAgICAgIC5yZW1vdmUoa2V5KTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIFVzZSBhbHRlcm5hdGUgbXV0YXRpb24gYWNjZXNzb3JzIGluc3RlYWQuDQogICAgICAgKi8NCiAgICAgIEBqYXZhLmxhbmcuRGVwcmVjYXRlZA0KICAgICAgcHVibGljIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4NCiAgICAgIGdldE11dGFibGVUYWdzKCkgew0KICAgICAgICByZXR1cm4gaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpLmdldE11dGFibGVNYXAoKTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHB1dFRhZ3MoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXksDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAoa2V5ID09IG51bGwpIHsgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOyB9DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgICBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkuZ2V0TXV0YWJsZU1hcCgpDQogICAgICAgICAgICAucHV0KGtleSwgdmFsdWUpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNzs8L2NvZGU+DQogICAgICAgKi8NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgcHV0QWxsVGFncygNCiAgICAgICAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IHZhbHVlcykgew0KICAgICAgICBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkuZ2V0TXV0YWJsZU1hcCgpDQogICAgICAgICAgICAucHV0QWxsKHZhbHVlcyk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgcHVibGljIGZpbmFsIEJ1aWxkZXIgc2V0VW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5zZXRVbmtub3duRmllbGRzUHJvdG8zKHVua25vd25GaWVsZHMpOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBtZXJnZVVua25vd25GaWVsZHMoDQogICAgICAgICAgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQgdW5rbm93bkZpZWxkcykgew0KICAgICAgICByZXR1cm4gc3VwZXIubWVyZ2VVbmtub3duRmllbGRzKHVua25vd25GaWVsZHMpOw0KICAgICAgfQ0KDQoNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChidWlsZGVyX3Njb3BlOmt1YmVtcS5FdmVudCkNCiAgICB9DQoNCiAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoY2xhc3Nfc2NvcGU6a3ViZW1xLkV2ZW50KQ0KICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnQgREVGQVVMVF9JTlNUQU5DRTsNCiAgICBzdGF0aWMgew0KICAgICAgREVGQVVMVF9JTlNUQU5DRSA9IG5ldyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50KCk7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50IGdldERlZmF1bHRJbnN0YW5jZSgpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFOw0KICAgIH0NCg0KICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuUGFyc2VyPEV2ZW50Pg0KICAgICAgICBQQVJTRVIgPSBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5BYnN0cmFjdFBhcnNlcjxFdmVudD4oKSB7DQogICAgICBwdWJsaWMgRXZlbnQgcGFyc2VQYXJ0aWFsRnJvbSgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgICAgcmV0dXJuIG5ldyBFdmVudChpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgfQ0KICAgIH07DQoNCiAgICBwdWJsaWMgc3RhdGljIGNvbS5nb29nbGUucHJvdG9idWYuUGFyc2VyPEV2ZW50PiBwYXJzZXIoKSB7DQogICAgICByZXR1cm4gUEFSU0VSOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8RXZlbnQ+IGdldFBhcnNlckZvclR5cGUoKSB7DQogICAgICByZXR1cm4gUEFSU0VSOw0KICAgIH0NCg0KICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50IGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRTsNCiAgICB9DQoNCiAgfQ0KDQogIHB1YmxpYyBpbnRlcmZhY2UgRXZlbnRSZWNlaXZlT3JCdWlsZGVyIGV4dGVuZHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChpbnRlcmZhY2VfZXh0ZW5kczprdWJlbXEuRXZlbnRSZWNlaXZlKQ0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5NZXNzYWdlT3JCdWlsZGVyIHsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFdmVudElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRFdmVudElEKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEV2ZW50SUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0RXZlbnRJREJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2hhbm5lbCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMjs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldENoYW5uZWxCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gMzs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRNZXRhZGF0YSgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRNZXRhZGF0YUJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5ieXRlcyBCb2R5ID0gNDs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGdldEJvZHkoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDY0IFRpbWVzdGFtcCA9IDU7PC9jb2RlPg0KICAgICAqLw0KICAgIGxvbmcgZ2V0VGltZXN0YW1wKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT51aW50NjQgU2VxdWVuY2UgPSA2OzwvY29kZT4NCiAgICAgKi8NCiAgICBsb25nIGdldFNlcXVlbmNlKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA3OzwvY29kZT4NCiAgICAgKi8NCiAgICBpbnQgZ2V0VGFnc0NvdW50KCk7DQogICAgLyoqDQogICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNzs8L2NvZGU+DQogICAgICovDQogICAgYm9vbGVhbiBjb250YWluc1RhZ3MoDQogICAgICAgIGphdmEubGFuZy5TdHJpbmcga2V5KTsNCiAgICAvKioNCiAgICAgKiBVc2Uge0BsaW5rICNnZXRUYWdzTWFwKCl9IGluc3RlYWQuDQogICAgICovDQogICAgQGphdmEubGFuZy5EZXByZWNhdGVkDQogICAgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgIGdldFRhZ3MoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA3OzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+DQogICAgZ2V0VGFnc01hcCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDc7PC9jb2RlPg0KICAgICAqLw0KDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRUYWdzT3JEZWZhdWx0KA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSwNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBkZWZhdWx0VmFsdWUpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDc7PC9jb2RlPg0KICAgICAqLw0KDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRUYWdzT3JUaHJvdygNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpOw0KICB9DQogIC8qKg0KICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuRXZlbnRSZWNlaXZlfQ0KICAgKi8NCiAgcHVibGljICBzdGF0aWMgZmluYWwgY2xhc3MgRXZlbnRSZWNlaXZlIGV4dGVuZHMNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzIGltcGxlbWVudHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChtZXNzYWdlX2ltcGxlbWVudHM6a3ViZW1xLkV2ZW50UmVjZWl2ZSkNCiAgICAgIEV2ZW50UmVjZWl2ZU9yQnVpbGRlciB7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGxvbmcgc2VyaWFsVmVyc2lvblVJRCA9IDBMOw0KICAgIC8vIFVzZSBFdmVudFJlY2VpdmUubmV3QnVpbGRlcigpIHRvIGNvbnN0cnVjdC4NCiAgICBwcml2YXRlIEV2ZW50UmVjZWl2ZShjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPD8+IGJ1aWxkZXIpIHsNCiAgICAgIHN1cGVyKGJ1aWxkZXIpOw0KICAgIH0NCiAgICBwcml2YXRlIEV2ZW50UmVjZWl2ZSgpIHsNCiAgICAgIGV2ZW50SURfID0gIiI7DQogICAgICBjaGFubmVsXyA9ICIiOw0KICAgICAgbWV0YWRhdGFfID0gIiI7DQogICAgICBib2R5XyA9IGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5FTVBUWTsNCiAgICAgIHRpbWVzdGFtcF8gPSAwTDsNCiAgICAgIHNlcXVlbmNlXyA9IDBMOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQNCiAgICBnZXRVbmtub3duRmllbGRzKCkgew0KICAgICAgcmV0dXJuIHRoaXMudW5rbm93bkZpZWxkczsNCiAgICB9DQogICAgcHJpdmF0ZSBFdmVudFJlY2VpdmUoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICB0aGlzKCk7DQogICAgICBpZiAoZXh0ZW5zaW9uUmVnaXN0cnkgPT0gbnVsbCkgew0KICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogICAgICB9DQogICAgICBpbnQgbXV0YWJsZV9iaXRGaWVsZDBfID0gMDsNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0LkJ1aWxkZXIgdW5rbm93bkZpZWxkcyA9DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQubmV3QnVpbGRlcigpOw0KICAgICAgdHJ5IHsNCiAgICAgICAgYm9vbGVhbiBkb25lID0gZmFsc2U7DQogICAgICAgIHdoaWxlICghZG9uZSkgew0KICAgICAgICAgIGludCB0YWcgPSBpbnB1dC5yZWFkVGFnKCk7DQogICAgICAgICAgc3dpdGNoICh0YWcpIHsNCiAgICAgICAgICAgIGNhc2UgMDoNCiAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgZGVmYXVsdDogew0KICAgICAgICAgICAgICBpZiAoIXBhcnNlVW5rbm93bkZpZWxkUHJvdG8zKA0KICAgICAgICAgICAgICAgICAgaW5wdXQsIHVua25vd25GaWVsZHMsIGV4dGVuc2lvblJlZ2lzdHJ5LCB0YWcpKSB7DQogICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDEwOiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIGV2ZW50SURfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDE4OiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIGNoYW5uZWxfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDI2OiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIG1ldGFkYXRhXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAzNDogew0KDQogICAgICAgICAgICAgIGJvZHlfID0gaW5wdXQucmVhZEJ5dGVzKCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSA0MDogew0KDQogICAgICAgICAgICAgIHRpbWVzdGFtcF8gPSBpbnB1dC5yZWFkSW50NjQoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDQ4OiB7DQoNCiAgICAgICAgICAgICAgc2VxdWVuY2VfID0gaW5wdXQucmVhZFVJbnQ2NCgpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNTg6IHsNCiAgICAgICAgICAgICAgaWYgKCEoKG11dGFibGVfYml0RmllbGQwXyAmIDB4MDAwMDAwNDApID09IDB4MDAwMDAwNDApKSB7DQogICAgICAgICAgICAgICAgdGFnc18gPSBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkLm5ld01hcEZpZWxkKA0KICAgICAgICAgICAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeSk7DQogICAgICAgICAgICAgICAgbXV0YWJsZV9iaXRGaWVsZDBfIHw9IDB4MDAwMDAwNDA7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBFbnRyeTxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgICAgICAgICAgICB0YWdzX18gPSBpbnB1dC5yZWFkTWVzc2FnZSgNCiAgICAgICAgICAgICAgICAgIFRhZ3NEZWZhdWx0RW50cnlIb2xkZXIuZGVmYXVsdEVudHJ5LmdldFBhcnNlckZvclR5cGUoKSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgICAgICAgICB0YWdzXy5nZXRNdXRhYmxlTWFwKCkucHV0KA0KICAgICAgICAgICAgICAgICAgdGFnc19fLmdldEtleSgpLCB0YWdzX18uZ2V0VmFsdWUoKSk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBlLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBjYXRjaCAoamF2YS5pby5JT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbigNCiAgICAgICAgICAgIGUpLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgdGhpcy51bmtub3duRmllbGRzID0gdW5rbm93bkZpZWxkcy5idWlsZCgpOw0KICAgICAgICBtYWtlRXh0ZW5zaW9uc0ltbXV0YWJsZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FdmVudFJlY2VpdmVfZGVzY3JpcHRvcjsNCiAgICB9DQoNCiAgICBAU3VwcHJlc3NXYXJuaW5ncyh7InJhd3R5cGVzIn0pDQogICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQgaW50ZXJuYWxHZXRNYXBGaWVsZCgNCiAgICAgICAgaW50IG51bWJlcikgew0KICAgICAgc3dpdGNoIChudW1iZXIpIHsNCiAgICAgICAgY2FzZSA3Og0KICAgICAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKTsNCiAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICB0aHJvdyBuZXcgUnVudGltZUV4Y2VwdGlvbigNCiAgICAgICAgICAgICAgIkludmFsaWQgbWFwIGZpZWxkIG51bWJlcjogIiArIG51bWJlcik7DQogICAgICB9DQogICAgfQ0KICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgaW50ZXJuYWxHZXRGaWVsZEFjY2Vzc29yVGFibGUoKSB7DQogICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0V2ZW50UmVjZWl2ZV9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudFJlY2VpdmUuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnRSZWNlaXZlLkJ1aWxkZXIuY2xhc3MpOw0KICAgIH0NCg0KICAgIHByaXZhdGUgaW50IGJpdEZpZWxkMF87DQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRVZFTlRJRF9GSUVMRF9OVU1CRVIgPSAxOw0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBldmVudElEXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgRXZlbnRJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldEV2ZW50SUQoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGV2ZW50SURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIGV2ZW50SURfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFdmVudElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRFdmVudElEQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGV2ZW50SURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIGV2ZW50SURfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENIQU5ORUxfRklFTERfTlVNQkVSID0gMjsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgY2hhbm5lbF87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDaGFubmVsKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBjaGFubmVsXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0Q2hhbm5lbEJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICBjaGFubmVsXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNRVRBREFUQV9GSUVMRF9OVU1CRVIgPSAzOw0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBtZXRhZGF0YV87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gMzs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0TWV0YWRhdGEoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1ldGFkYXRhXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBtZXRhZGF0YV8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gMzs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRNZXRhZGF0YUJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBtZXRhZGF0YV87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgbWV0YWRhdGFfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEJPRFlfRklFTERfTlVNQkVSID0gNDsNCiAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBib2R5XzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5ieXRlcyBCb2R5ID0gNDs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBnZXRCb2R5KCkgew0KICAgICAgcmV0dXJuIGJvZHlfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFRJTUVTVEFNUF9GSUVMRF9OVU1CRVIgPSA1Ow0KICAgIHByaXZhdGUgbG9uZyB0aW1lc3RhbXBfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDY0IFRpbWVzdGFtcCA9IDU7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBsb25nIGdldFRpbWVzdGFtcCgpIHsNCiAgICAgIHJldHVybiB0aW1lc3RhbXBfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNFUVVFTkNFX0ZJRUxEX05VTUJFUiA9IDY7DQogICAgcHJpdmF0ZSBsb25nIHNlcXVlbmNlXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT51aW50NjQgU2VxdWVuY2UgPSA2OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgbG9uZyBnZXRTZXF1ZW5jZSgpIHsNCiAgICAgIHJldHVybiBzZXF1ZW5jZV87DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgVEFHU19GSUVMRF9OVU1CRVIgPSA3Ow0KICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIGNsYXNzIFRhZ3NEZWZhdWx0RW50cnlIb2xkZXIgew0KICAgICAgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRW50cnk8DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gZGVmYXVsdEVudHJ5ID0NCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBFbnRyeQ0KICAgICAgICAgICAgICAuPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+bmV3RGVmYXVsdEluc3RhbmNlKA0KICAgICAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0V2ZW50UmVjZWl2ZV9UYWdzRW50cnlfZGVzY3JpcHRvciwgDQogICAgICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLldpcmVGb3JtYXQuRmllbGRUeXBlLlNUUklORywNCiAgICAgICAgICAgICAgICAgICIiLA0KICAgICAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5XaXJlRm9ybWF0LkZpZWxkVHlwZS5TVFJJTkcsDQogICAgICAgICAgICAgICAgICAiIik7DQogICAgfQ0KICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZDwNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gdGFnc187DQogICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+DQogICAgaW50ZXJuYWxHZXRUYWdzKCkgew0KICAgICAgaWYgKHRhZ3NfID09IG51bGwpIHsNCiAgICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQuZW1wdHlNYXBGaWVsZCgNCiAgICAgICAgICAgIFRhZ3NEZWZhdWx0RW50cnlIb2xkZXIuZGVmYXVsdEVudHJ5KTsNCiAgICAgIH0NCiAgICAgIHJldHVybiB0YWdzXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW50IGdldFRhZ3NDb3VudCgpIHsNCiAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKS5zaXplKCk7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDc7PC9jb2RlPg0KICAgICAqLw0KDQogICAgcHVibGljIGJvb2xlYW4gY29udGFpbnNUYWdzKA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSkgew0KICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgcmV0dXJuIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpLmNvbnRhaW5zS2V5KGtleSk7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIFVzZSB7QGxpbmsgI2dldFRhZ3NNYXAoKX0gaW5zdGVhZC4NCiAgICAgKi8NCiAgICBAamF2YS5sYW5nLkRlcHJlY2F0ZWQNCiAgICBwdWJsaWMgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBnZXRUYWdzKCkgew0KICAgICAgcmV0dXJuIGdldFRhZ3NNYXAoKTsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNzs8L2NvZGU+DQogICAgICovDQoNCiAgICBwdWJsaWMgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBnZXRUYWdzTWFwKCkgew0KICAgICAgcmV0dXJuIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA3OzwvY29kZT4NCiAgICAgKi8NCg0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFRhZ3NPckRlZmF1bHQoDQogICAgICAgIGphdmEubGFuZy5TdHJpbmcga2V5LA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGRlZmF1bHRWYWx1ZSkgew0KICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBtYXAgPQ0KICAgICAgICAgIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpOw0KICAgICAgcmV0dXJuIG1hcC5jb250YWluc0tleShrZXkpID8gbWFwLmdldChrZXkpIDogZGVmYXVsdFZhbHVlOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA3OzwvY29kZT4NCiAgICAgKi8NCg0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFRhZ3NPclRocm93KA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSkgew0KICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBtYXAgPQ0KICAgICAgICAgIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpOw0KICAgICAgaWYgKCFtYXAuY29udGFpbnNLZXkoa2V5KSkgew0KICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLklsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbigpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIG1hcC5nZXQoa2V5KTsNCiAgICB9DQoNCiAgICBwcml2YXRlIGJ5dGUgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gLTE7DQogICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgIGJ5dGUgaXNJbml0aWFsaXplZCA9IG1lbW9pemVkSXNJbml0aWFsaXplZDsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDEpIHJldHVybiB0cnVlOw0KICAgICAgaWYgKGlzSW5pdGlhbGl6ZWQgPT0gMCkgcmV0dXJuIGZhbHNlOw0KDQogICAgICBtZW1vaXplZElzSW5pdGlhbGl6ZWQgPSAxOw0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KDQogICAgcHVibGljIHZvaWQgd3JpdGVUbyhjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtIG91dHB1dCkNCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIGlmICghZ2V0RXZlbnRJREJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLndyaXRlU3RyaW5nKG91dHB1dCwgMSwgZXZlbnRJRF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRDaGFubmVsQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAyLCBjaGFubmVsXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldE1ldGFkYXRhQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAzLCBtZXRhZGF0YV8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFib2R5Xy5pc0VtcHR5KCkpIHsNCiAgICAgICAgb3V0cHV0LndyaXRlQnl0ZXMoNCwgYm9keV8pOw0KICAgICAgfQ0KICAgICAgaWYgKHRpbWVzdGFtcF8gIT0gMEwpIHsNCiAgICAgICAgb3V0cHV0LndyaXRlSW50NjQoNSwgdGltZXN0YW1wXyk7DQogICAgICB9DQogICAgICBpZiAoc2VxdWVuY2VfICE9IDBMKSB7DQogICAgICAgIG91dHB1dC53cml0ZVVJbnQ2NCg2LCBzZXF1ZW5jZV8pOw0KICAgICAgfQ0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgLnNlcmlhbGl6ZVN0cmluZ01hcFRvKA0KICAgICAgICAgIG91dHB1dCwNCiAgICAgICAgICBpbnRlcm5hbEdldFRhZ3MoKSwNCiAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeSwNCiAgICAgICAgICA3KTsNCiAgICAgIHVua25vd25GaWVsZHMud3JpdGVUbyhvdXRwdXQpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBpbnQgZ2V0U2VyaWFsaXplZFNpemUoKSB7DQogICAgICBpbnQgc2l6ZSA9IG1lbW9pemVkU2l6ZTsNCiAgICAgIGlmIChzaXplICE9IC0xKSByZXR1cm4gc2l6ZTsNCg0KICAgICAgc2l6ZSA9IDA7DQogICAgICBpZiAoIWdldEV2ZW50SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDEsIGV2ZW50SURfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0Q2hhbm5lbEJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoMiwgY2hhbm5lbF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRNZXRhZGF0YUJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoMywgbWV0YWRhdGFfKTsNCiAgICAgIH0NCiAgICAgIGlmICghYm9keV8uaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlQnl0ZXNTaXplKDQsIGJvZHlfKTsNCiAgICAgIH0NCiAgICAgIGlmICh0aW1lc3RhbXBfICE9IDBMKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlSW50NjRTaXplKDUsIHRpbWVzdGFtcF8pOw0KICAgICAgfQ0KICAgICAgaWYgKHNlcXVlbmNlXyAhPSAwTCkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZVVJbnQ2NFNpemUoNiwgc2VxdWVuY2VfKTsNCiAgICAgIH0NCiAgICAgIGZvciAoamF2YS51dGlsLk1hcC5FbnRyeTxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBlbnRyeQ0KICAgICAgICAgICA6IGludGVybmFsR2V0VGFncygpLmdldE1hcCgpLmVudHJ5U2V0KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBFbnRyeTxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgICAgICB0YWdzX18gPSBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeS5uZXdCdWlsZGVyRm9yVHlwZSgpDQogICAgICAgICAgICAuc2V0S2V5KGVudHJ5LmdldEtleSgpKQ0KICAgICAgICAgICAgLnNldFZhbHVlKGVudHJ5LmdldFZhbHVlKCkpDQogICAgICAgICAgICAuYnVpbGQoKTsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgICAuY29tcHV0ZU1lc3NhZ2VTaXplKDcsIHRhZ3NfXyk7DQogICAgICB9DQogICAgICBzaXplICs9IHVua25vd25GaWVsZHMuZ2V0U2VyaWFsaXplZFNpemUoKTsNCiAgICAgIG1lbW9pemVkU2l6ZSA9IHNpemU7DQogICAgICByZXR1cm4gc2l6ZTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGJvb2xlYW4gZXF1YWxzKGZpbmFsIGphdmEubGFuZy5PYmplY3Qgb2JqKSB7DQogICAgICBpZiAob2JqID09IHRoaXMpIHsNCiAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIGlmICghKG9iaiBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnRSZWNlaXZlKSkgew0KICAgICAgICByZXR1cm4gc3VwZXIuZXF1YWxzKG9iaik7DQogICAgICB9DQogICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZSBvdGhlciA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZSkgb2JqOw0KDQogICAgICBib29sZWFuIHJlc3VsdCA9IHRydWU7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0RXZlbnRJRCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRFdmVudElEKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldENoYW5uZWwoKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0Q2hhbm5lbCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRNZXRhZGF0YSgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRNZXRhZGF0YSgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRCb2R5KCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldEJvZHkoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldFRpbWVzdGFtcCgpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0VGltZXN0YW1wKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChnZXRTZXF1ZW5jZSgpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0U2VxdWVuY2UoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgaW50ZXJuYWxHZXRUYWdzKCkuZXF1YWxzKA0KICAgICAgICAgIG90aGVyLmludGVybmFsR2V0VGFncygpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiB1bmtub3duRmllbGRzLmVxdWFscyhvdGhlci51bmtub3duRmllbGRzKTsNCiAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBpbnQgaGFzaENvZGUoKSB7DQogICAgICBpZiAobWVtb2l6ZWRIYXNoQ29kZSAhPSAwKSB7DQogICAgICAgIHJldHVybiBtZW1vaXplZEhhc2hDb2RlOw0KICAgICAgfQ0KICAgICAgaW50IGhhc2ggPSA0MTsNCiAgICAgIGhhc2ggPSAoMTkgKiBoYXNoKSArIGdldERlc2NyaXB0b3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgRVZFTlRJRF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRFdmVudElEKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIENIQU5ORUxfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0Q2hhbm5lbCgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBNRVRBREFUQV9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRNZXRhZGF0YSgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBCT0RZX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldEJvZHkoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgVElNRVNUQU1QX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGNvbS5nb29nbGUucHJvdG9idWYuSW50ZXJuYWwuaGFzaExvbmcoDQogICAgICAgICAgZ2V0VGltZXN0YW1wKCkpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgU0VRVUVOQ0VfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5oYXNoTG9uZygNCiAgICAgICAgICBnZXRTZXF1ZW5jZSgpKTsNCiAgICAgIGlmICghaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFRBR1NfRklFTERfTlVNQkVSOw0KICAgICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBpbnRlcm5hbEdldFRhZ3MoKS5oYXNoQ29kZSgpOw0KICAgICAgfQ0KICAgICAgaGFzaCA9ICgyOSAqIGhhc2gpICsgdW5rbm93bkZpZWxkcy5oYXNoQ29kZSgpOw0KICAgICAgbWVtb2l6ZWRIYXNoQ29kZSA9IGhhc2g7DQogICAgICByZXR1cm4gaGFzaDsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnRSZWNlaXZlIHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5uaW8uQnl0ZUJ1ZmZlciBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudFJlY2VpdmUgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnRSZWNlaXZlIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZSBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZSBwYXJzZUZyb20oYnl0ZVtdIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZSBwYXJzZUZyb20oDQogICAgICAgIGJ5dGVbXSBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZSBwYXJzZUZyb20oamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnRSZWNlaXZlIHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudFJlY2VpdmUgcGFyc2VEZWxpbWl0ZWRGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZURlbGltaXRlZFdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZSBwYXJzZURlbGltaXRlZEZyb20oDQogICAgICAgIGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VEZWxpbWl0ZWRXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnRSZWNlaXZlIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudFJlY2VpdmUgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBCdWlsZGVyIG5ld0J1aWxkZXJGb3JUeXBlKCkgeyByZXR1cm4gbmV3QnVpbGRlcigpOyB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRS50b0J1aWxkZXIoKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudFJlY2VpdmUgcHJvdG90eXBlKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRS50b0J1aWxkZXIoKS5tZXJnZUZyb20ocHJvdG90eXBlKTsNCiAgICB9DQogICAgcHVibGljIEJ1aWxkZXIgdG9CdWlsZGVyKCkgew0KICAgICAgcmV0dXJuIHRoaXMgPT0gREVGQVVMVF9JTlNUQU5DRQ0KICAgICAgICAgID8gbmV3IEJ1aWxkZXIoKSA6IG5ldyBCdWlsZGVyKCkubWVyZ2VGcm9tKHRoaXMpOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwcm90ZWN0ZWQgQnVpbGRlciBuZXdCdWlsZGVyRm9yVHlwZSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlclBhcmVudCBwYXJlbnQpIHsNCiAgICAgIEJ1aWxkZXIgYnVpbGRlciA9IG5ldyBCdWlsZGVyKHBhcmVudCk7DQogICAgICByZXR1cm4gYnVpbGRlcjsNCiAgICB9DQogICAgLyoqDQogICAgICogUHJvdG9idWYgdHlwZSB7QGNvZGUga3ViZW1xLkV2ZW50UmVjZWl2ZX0NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNsYXNzIEJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPEJ1aWxkZXI+IGltcGxlbWVudHMNCiAgICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfaW1wbGVtZW50czprdWJlbXEuRXZlbnRSZWNlaXZlKQ0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZU9yQnVpbGRlciB7DQogICAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRSZWNlaXZlX2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIEBTdXBwcmVzc1dhcm5pbmdzKHsicmF3dHlwZXMifSkNCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkIGludGVybmFsR2V0TWFwRmllbGQoDQogICAgICAgICAgaW50IG51bWJlcikgew0KICAgICAgICBzd2l0Y2ggKG51bWJlcikgew0KICAgICAgICAgIGNhc2UgNzoNCiAgICAgICAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKTsNCiAgICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFeGNlcHRpb24oDQogICAgICAgICAgICAgICAgIkludmFsaWQgbWFwIGZpZWxkIG51bWJlcjogIiArIG51bWJlcik7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIEBTdXBwcmVzc1dhcm5pbmdzKHsicmF3dHlwZXMifSkNCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkIGludGVybmFsR2V0TXV0YWJsZU1hcEZpZWxkKA0KICAgICAgICAgIGludCBudW1iZXIpIHsNCiAgICAgICAgc3dpdGNoIChudW1iZXIpIHsNCiAgICAgICAgICBjYXNlIDc6DQogICAgICAgICAgICByZXR1cm4gaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpOw0KICAgICAgICAgIGRlZmF1bHQ6DQogICAgICAgICAgICB0aHJvdyBuZXcgUnVudGltZUV4Y2VwdGlvbigNCiAgICAgICAgICAgICAgICAiSW52YWxpZCBtYXAgZmllbGQgbnVtYmVyOiAiICsgbnVtYmVyKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICAgIGludGVybmFsR2V0RmllbGRBY2Nlc3NvclRhYmxlKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0V2ZW50UmVjZWl2ZV9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAgIC5lbnN1cmVGaWVsZEFjY2Vzc29yc0luaXRpYWxpemVkKA0KICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnRSZWNlaXZlLmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZS5CdWlsZGVyLmNsYXNzKTsNCiAgICAgIH0NCg0KICAgICAgLy8gQ29uc3RydWN0IHVzaW5nIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnRSZWNlaXZlLm5ld0J1aWxkZXIoKQ0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKCkgew0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgQnVpbGRlcigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgICBzdXBlcihwYXJlbnQpOw0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQogICAgICBwcml2YXRlIHZvaWQgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpIHsNCiAgICAgICAgaWYgKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgICAgICAgLmFsd2F5c1VzZUZpZWxkQnVpbGRlcnMpIHsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXIoKSB7DQogICAgICAgIHN1cGVyLmNsZWFyKCk7DQogICAgICAgIGV2ZW50SURfID0gIiI7DQoNCiAgICAgICAgY2hhbm5lbF8gPSAiIjsNCg0KICAgICAgICBtZXRhZGF0YV8gPSAiIjsNCg0KICAgICAgICBib2R5XyA9IGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5FTVBUWTsNCg0KICAgICAgICB0aW1lc3RhbXBfID0gMEw7DQoNCiAgICAgICAgc2VxdWVuY2VfID0gMEw7DQoNCiAgICAgICAgaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpLmNsZWFyKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvckZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRSZWNlaXZlX2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZSBnZXREZWZhdWx0SW5zdGFuY2VGb3JUeXBlKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudFJlY2VpdmUuZ2V0RGVmYXVsdEluc3RhbmNlKCk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZSBidWlsZCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudFJlY2VpdmUgcmVzdWx0ID0gYnVpbGRQYXJ0aWFsKCk7DQogICAgICAgIGlmICghcmVzdWx0LmlzSW5pdGlhbGl6ZWQoKSkgew0KICAgICAgICAgIHRocm93IG5ld1VuaW5pdGlhbGl6ZWRNZXNzYWdlRXhjZXB0aW9uKHJlc3VsdCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnRSZWNlaXZlIGJ1aWxkUGFydGlhbCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudFJlY2VpdmUgcmVzdWx0ID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnRSZWNlaXZlKHRoaXMpOw0KICAgICAgICBpbnQgZnJvbV9iaXRGaWVsZDBfID0gYml0RmllbGQwXzsNCiAgICAgICAgaW50IHRvX2JpdEZpZWxkMF8gPSAwOw0KICAgICAgICByZXN1bHQuZXZlbnRJRF8gPSBldmVudElEXzsNCiAgICAgICAgcmVzdWx0LmNoYW5uZWxfID0gY2hhbm5lbF87DQogICAgICAgIHJlc3VsdC5tZXRhZGF0YV8gPSBtZXRhZGF0YV87DQogICAgICAgIHJlc3VsdC5ib2R5XyA9IGJvZHlfOw0KICAgICAgICByZXN1bHQudGltZXN0YW1wXyA9IHRpbWVzdGFtcF87DQogICAgICAgIHJlc3VsdC5zZXF1ZW5jZV8gPSBzZXF1ZW5jZV87DQogICAgICAgIHJlc3VsdC50YWdzXyA9IGludGVybmFsR2V0VGFncygpOw0KICAgICAgICByZXN1bHQudGFnc18ubWFrZUltbXV0YWJsZSgpOw0KICAgICAgICByZXN1bHQuYml0RmllbGQwXyA9IHRvX2JpdEZpZWxkMF87DQogICAgICAgIG9uQnVpbHQoKTsNCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xvbmUoKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xvbmUoKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyRmllbGQoZmllbGQpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJPbmVvZigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLk9uZW9mRGVzY3JpcHRvciBvbmVvZikgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyT25lb2Yob25lb2YpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBpbnQgaW5kZXgsIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRSZXBlYXRlZEZpZWxkKGZpZWxkLCBpbmRleCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgYWRkUmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuYWRkUmVwZWF0ZWRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZSBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZSkgew0KICAgICAgICAgIHJldHVybiBtZXJnZUZyb20oKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnRSZWNlaXZlKW90aGVyKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBzdXBlci5tZXJnZUZyb20ob3RoZXIpOw0KICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbShpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZSBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgPT0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudFJlY2VpdmUuZ2V0RGVmYXVsdEluc3RhbmNlKCkpIHJldHVybiB0aGlzOw0KICAgICAgICBpZiAoIW90aGVyLmdldEV2ZW50SUQoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICBldmVudElEXyA9IG90aGVyLmV2ZW50SURfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmICghb3RoZXIuZ2V0Q2hhbm5lbCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIGNoYW5uZWxfID0gb3RoZXIuY2hhbm5lbF87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRNZXRhZGF0YSgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIG1ldGFkYXRhXyA9IG90aGVyLm1ldGFkYXRhXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0Qm9keSgpICE9IGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5FTVBUWSkgew0KICAgICAgICAgIHNldEJvZHkob3RoZXIuZ2V0Qm9keSgpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0VGltZXN0YW1wKCkgIT0gMEwpIHsNCiAgICAgICAgICBzZXRUaW1lc3RhbXAob3RoZXIuZ2V0VGltZXN0YW1wKCkpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRTZXF1ZW5jZSgpICE9IDBMKSB7DQogICAgICAgICAgc2V0U2VxdWVuY2Uob3RoZXIuZ2V0U2VxdWVuY2UoKSk7DQogICAgICAgIH0NCiAgICAgICAgaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpLm1lcmdlRnJvbSgNCiAgICAgICAgICAgIG90aGVyLmludGVybmFsR2V0VGFncygpKTsNCiAgICAgICAgdGhpcy5tZXJnZVVua25vd25GaWVsZHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbSgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZSBwYXJzZWRNZXNzYWdlID0gbnVsbDsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gUEFSU0VSLnBhcnNlUGFydGlhbEZyb20oaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudFJlY2VpdmUpIGUuZ2V0VW5maW5pc2hlZE1lc3NhZ2UoKTsNCiAgICAgICAgICB0aHJvdyBlLnVud3JhcElPRXhjZXB0aW9uKCk7DQogICAgICAgIH0gZmluYWxseSB7DQogICAgICAgICAgaWYgKHBhcnNlZE1lc3NhZ2UgIT0gbnVsbCkgew0KICAgICAgICAgICAgbWVyZ2VGcm9tKHBhcnNlZE1lc3NhZ2UpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIHByaXZhdGUgaW50IGJpdEZpZWxkMF87DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCBldmVudElEXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXZlbnRJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRFdmVudElEKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGV2ZW50SURfOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICBldmVudElEXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEV2ZW50SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldEV2ZW50SURCeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBldmVudElEXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBldmVudElEXyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXZlbnRJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRFdmVudElEKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgZXZlbnRJRF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXZlbnRJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckV2ZW50SUQoKSB7DQogICAgICAgIA0KICAgICAgICBldmVudElEXyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldEV2ZW50SUQoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXZlbnRJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRFdmVudElEQnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIGV2ZW50SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IGNoYW5uZWxfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldENoYW5uZWwoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2hhbm5lbF87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIGNoYW5uZWxfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0Q2hhbm5lbEJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNoYW5uZWxfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIGNoYW5uZWxfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldENoYW5uZWwoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBjaGFubmVsXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyQ2hhbm5lbCgpIHsNCiAgICAgICAgDQogICAgICAgIGNoYW5uZWxfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0Q2hhbm5lbCgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldENoYW5uZWxCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgY2hhbm5lbF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgbWV0YWRhdGFfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRNZXRhZGF0YSgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBtZXRhZGF0YV87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIG1ldGFkYXRhXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRNZXRhZGF0YUJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1ldGFkYXRhXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBtZXRhZGF0YV8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldE1ldGFkYXRhKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgbWV0YWRhdGFfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyTWV0YWRhdGEoKSB7DQogICAgICAgIA0KICAgICAgICBtZXRhZGF0YV8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRNZXRhZGF0YSgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRNZXRhZGF0YUJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBtZXRhZGF0YV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBib2R5XyA9IGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5FTVBUWTsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ynl0ZXMgQm9keSA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGdldEJvZHkoKSB7DQogICAgICAgIHJldHVybiBib2R5XzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ynl0ZXMgQm9keSA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRCb2R5KGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBib2R5XyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJ5dGVzIEJvZHkgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJCb2R5KCkgew0KICAgICAgICANCiAgICAgICAgYm9keV8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRCb2R5KCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBsb25nIHRpbWVzdGFtcF8gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQ2NCBUaW1lc3RhbXAgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGxvbmcgZ2V0VGltZXN0YW1wKCkgew0KICAgICAgICByZXR1cm4gdGltZXN0YW1wXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgVGltZXN0YW1wID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFRpbWVzdGFtcChsb25nIHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICB0aW1lc3RhbXBfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgVGltZXN0YW1wID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyVGltZXN0YW1wKCkgew0KICAgICAgICANCiAgICAgICAgdGltZXN0YW1wXyA9IDBMOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgbG9uZyBzZXF1ZW5jZV8gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT51aW50NjQgU2VxdWVuY2UgPSA2OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGxvbmcgZ2V0U2VxdWVuY2UoKSB7DQogICAgICAgIHJldHVybiBzZXF1ZW5jZV87DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnVpbnQ2NCBTZXF1ZW5jZSA9IDY7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRTZXF1ZW5jZShsb25nIHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICBzZXF1ZW5jZV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT51aW50NjQgU2VxdWVuY2UgPSA2OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJTZXF1ZW5jZSgpIHsNCiAgICAgICAgDQogICAgICAgIHNlcXVlbmNlXyA9IDBMOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZDwNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiB0YWdzXzsNCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgICAgaW50ZXJuYWxHZXRUYWdzKCkgew0KICAgICAgICBpZiAodGFnc18gPT0gbnVsbCkgew0KICAgICAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkLmVtcHR5TWFwRmllbGQoDQogICAgICAgICAgICAgIFRhZ3NEZWZhdWx0RW50cnlIb2xkZXIuZGVmYXVsdEVudHJ5KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGFnc187DQogICAgICB9DQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQ8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4NCiAgICAgIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKSB7DQogICAgICAgIG9uQ2hhbmdlZCgpOzsNCiAgICAgICAgaWYgKHRhZ3NfID09IG51bGwpIHsNCiAgICAgICAgICB0YWdzXyA9IGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQubmV3TWFwRmllbGQoDQogICAgICAgICAgICAgIFRhZ3NEZWZhdWx0RW50cnlIb2xkZXIuZGVmYXVsdEVudHJ5KTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIXRhZ3NfLmlzTXV0YWJsZSgpKSB7DQogICAgICAgICAgdGFnc18gPSB0YWdzXy5jb3B5KCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRhZ3NfOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW50IGdldFRhZ3NDb3VudCgpIHsNCiAgICAgICAgcmV0dXJuIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpLnNpemUoKTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNzs8L2NvZGU+DQogICAgICAgKi8NCg0KICAgICAgcHVibGljIGJvb2xlYW4gY29udGFpbnNUYWdzKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcga2V5KSB7DQogICAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgICAgcmV0dXJuIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpLmNvbnRhaW5zS2V5KGtleSk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIFVzZSB7QGxpbmsgI2dldFRhZ3NNYXAoKX0gaW5zdGVhZC4NCiAgICAgICAqLw0KICAgICAgQGphdmEubGFuZy5EZXByZWNhdGVkDQogICAgICBwdWJsaWMgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBnZXRUYWdzKCkgew0KICAgICAgICByZXR1cm4gZ2V0VGFnc01hcCgpOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA3OzwvY29kZT4NCiAgICAgICAqLw0KDQogICAgICBwdWJsaWMgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBnZXRUYWdzTWFwKCkgew0KICAgICAgICByZXR1cm4gaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDc7PC9jb2RlPg0KICAgICAgICovDQoNCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFRhZ3NPckRlZmF1bHQoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXksDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBkZWZhdWx0VmFsdWUpIHsNCiAgICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IG1hcCA9DQogICAgICAgICAgICBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICAgICAgcmV0dXJuIG1hcC5jb250YWluc0tleShrZXkpID8gbWFwLmdldChrZXkpIDogZGVmYXVsdFZhbHVlOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA3OzwvY29kZT4NCiAgICAgICAqLw0KDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRUYWdzT3JUaHJvdygNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSkgew0KICAgICAgICBpZiAoa2V5ID09IG51bGwpIHsgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOyB9DQogICAgICAgIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gbWFwID0NCiAgICAgICAgICAgIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpOw0KICAgICAgICBpZiAoIW1hcC5jb250YWluc0tleShrZXkpKSB7DQogICAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5JbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24oKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gbWFwLmdldChrZXkpOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhclRhZ3MoKSB7DQogICAgICAgIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKS5nZXRNdXRhYmxlTWFwKCkNCiAgICAgICAgICAgIC5jbGVhcigpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNzs8L2NvZGU+DQogICAgICAgKi8NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgcmVtb3ZlVGFncygNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSkgew0KICAgICAgICBpZiAoa2V5ID09IG51bGwpIHsgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOyB9DQogICAgICAgIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKS5nZXRNdXRhYmxlTWFwKCkNCiAgICAgICAgICAgIC5yZW1vdmUoa2V5KTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIFVzZSBhbHRlcm5hdGUgbXV0YXRpb24gYWNjZXNzb3JzIGluc3RlYWQuDQogICAgICAgKi8NCiAgICAgIEBqYXZhLmxhbmcuRGVwcmVjYXRlZA0KICAgICAgcHVibGljIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4NCiAgICAgIGdldE11dGFibGVUYWdzKCkgew0KICAgICAgICByZXR1cm4gaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpLmdldE11dGFibGVNYXAoKTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHB1dFRhZ3MoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXksDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAoa2V5ID09IG51bGwpIHsgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOyB9DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgICBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkuZ2V0TXV0YWJsZU1hcCgpDQogICAgICAgICAgICAucHV0KGtleSwgdmFsdWUpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNzs8L2NvZGU+DQogICAgICAgKi8NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgcHV0QWxsVGFncygNCiAgICAgICAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IHZhbHVlcykgew0KICAgICAgICBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkuZ2V0TXV0YWJsZU1hcCgpDQogICAgICAgICAgICAucHV0QWxsKHZhbHVlcyk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgcHVibGljIGZpbmFsIEJ1aWxkZXIgc2V0VW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5zZXRVbmtub3duRmllbGRzUHJvdG8zKHVua25vd25GaWVsZHMpOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBtZXJnZVVua25vd25GaWVsZHMoDQogICAgICAgICAgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQgdW5rbm93bkZpZWxkcykgew0KICAgICAgICByZXR1cm4gc3VwZXIubWVyZ2VVbmtub3duRmllbGRzKHVua25vd25GaWVsZHMpOw0KICAgICAgfQ0KDQoNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChidWlsZGVyX3Njb3BlOmt1YmVtcS5FdmVudFJlY2VpdmUpDQogICAgfQ0KDQogICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGNsYXNzX3Njb3BlOmt1YmVtcS5FdmVudFJlY2VpdmUpDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudFJlY2VpdmUgREVGQVVMVF9JTlNUQU5DRTsNCiAgICBzdGF0aWMgew0KICAgICAgREVGQVVMVF9JTlNUQU5DRSA9IG5ldyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkV2ZW50UmVjZWl2ZSgpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5FdmVudFJlY2VpdmUgZ2V0RGVmYXVsdEluc3RhbmNlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8RXZlbnRSZWNlaXZlPg0KICAgICAgICBQQVJTRVIgPSBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5BYnN0cmFjdFBhcnNlcjxFdmVudFJlY2VpdmU+KCkgew0KICAgICAgcHVibGljIEV2ZW50UmVjZWl2ZSBwYXJzZVBhcnRpYWxGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgICByZXR1cm4gbmV3IEV2ZW50UmVjZWl2ZShpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgfQ0KICAgIH07DQoNCiAgICBwdWJsaWMgc3RhdGljIGNvbS5nb29nbGUucHJvdG9idWYuUGFyc2VyPEV2ZW50UmVjZWl2ZT4gcGFyc2VyKCkgew0KICAgICAgcmV0dXJuIFBBUlNFUjsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuUGFyc2VyPEV2ZW50UmVjZWl2ZT4gZ2V0UGFyc2VyRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuRXZlbnRSZWNlaXZlIGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRTsNCiAgICB9DQoNCiAgfQ0KDQogIHB1YmxpYyBpbnRlcmZhY2UgU3Vic2NyaWJlT3JCdWlsZGVyIGV4dGVuZHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChpbnRlcmZhY2VfZXh0ZW5kczprdWJlbXEuU3Vic2NyaWJlKQ0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5NZXNzYWdlT3JCdWlsZGVyIHsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuU3Vic2NyaWJlLlN1YnNjcmliZVR5cGUgU3Vic2NyaWJlVHlwZURhdGEgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBpbnQgZ2V0U3Vic2NyaWJlVHlwZURhdGFWYWx1ZSgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuU3Vic2NyaWJlLlN1YnNjcmliZVR5cGUgU3Vic2NyaWJlVHlwZURhdGEgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5TdWJzY3JpYmVUeXBlIGdldFN1YnNjcmliZVR5cGVEYXRhKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldENsaWVudElEKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldENsaWVudElEQnl0ZXMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRDaGFubmVsKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0Q2hhbm5lbEJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgR3JvdXAgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldEdyb3VwKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEdyb3VwID0gNDs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldEdyb3VwQnl0ZXMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuU3Vic2NyaWJlLkV2ZW50c1N0b3JlVHlwZSBFdmVudHNTdG9yZVR5cGVEYXRhID0gNTs8L2NvZGU+DQogICAgICovDQogICAgaW50IGdldEV2ZW50c1N0b3JlVHlwZURhdGFWYWx1ZSgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuU3Vic2NyaWJlLkV2ZW50c1N0b3JlVHlwZSBFdmVudHNTdG9yZVR5cGVEYXRhID0gNTs8L2NvZGU+DQogICAgICovDQogICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUuRXZlbnRzU3RvcmVUeXBlIGdldEV2ZW50c1N0b3JlVHlwZURhdGEoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDY0IEV2ZW50c1N0b3JlVHlwZVZhbHVlID0gNjs8L2NvZGU+DQogICAgICovDQogICAgbG9uZyBnZXRFdmVudHNTdG9yZVR5cGVWYWx1ZSgpOw0KICB9DQogIC8qKg0KICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuU3Vic2NyaWJlfQ0KICAgKi8NCiAgcHVibGljICBzdGF0aWMgZmluYWwgY2xhc3MgU3Vic2NyaWJlIGV4dGVuZHMNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzIGltcGxlbWVudHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChtZXNzYWdlX2ltcGxlbWVudHM6a3ViZW1xLlN1YnNjcmliZSkNCiAgICAgIFN1YnNjcmliZU9yQnVpbGRlciB7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGxvbmcgc2VyaWFsVmVyc2lvblVJRCA9IDBMOw0KICAgIC8vIFVzZSBTdWJzY3JpYmUubmV3QnVpbGRlcigpIHRvIGNvbnN0cnVjdC4NCiAgICBwcml2YXRlIFN1YnNjcmliZShjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPD8+IGJ1aWxkZXIpIHsNCiAgICAgIHN1cGVyKGJ1aWxkZXIpOw0KICAgIH0NCiAgICBwcml2YXRlIFN1YnNjcmliZSgpIHsNCiAgICAgIHN1YnNjcmliZVR5cGVEYXRhXyA9IDA7DQogICAgICBjbGllbnRJRF8gPSAiIjsNCiAgICAgIGNoYW5uZWxfID0gIiI7DQogICAgICBncm91cF8gPSAiIjsNCiAgICAgIGV2ZW50c1N0b3JlVHlwZURhdGFfID0gMDsNCiAgICAgIGV2ZW50c1N0b3JlVHlwZVZhbHVlXyA9IDBMOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQNCiAgICBnZXRVbmtub3duRmllbGRzKCkgew0KICAgICAgcmV0dXJuIHRoaXMudW5rbm93bkZpZWxkczsNCiAgICB9DQogICAgcHJpdmF0ZSBTdWJzY3JpYmUoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICB0aGlzKCk7DQogICAgICBpZiAoZXh0ZW5zaW9uUmVnaXN0cnkgPT0gbnVsbCkgew0KICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogICAgICB9DQogICAgICBpbnQgbXV0YWJsZV9iaXRGaWVsZDBfID0gMDsNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0LkJ1aWxkZXIgdW5rbm93bkZpZWxkcyA9DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQubmV3QnVpbGRlcigpOw0KICAgICAgdHJ5IHsNCiAgICAgICAgYm9vbGVhbiBkb25lID0gZmFsc2U7DQogICAgICAgIHdoaWxlICghZG9uZSkgew0KICAgICAgICAgIGludCB0YWcgPSBpbnB1dC5yZWFkVGFnKCk7DQogICAgICAgICAgc3dpdGNoICh0YWcpIHsNCiAgICAgICAgICAgIGNhc2UgMDoNCiAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgZGVmYXVsdDogew0KICAgICAgICAgICAgICBpZiAoIXBhcnNlVW5rbm93bkZpZWxkUHJvdG8zKA0KICAgICAgICAgICAgICAgICAgaW5wdXQsIHVua25vd25GaWVsZHMsIGV4dGVuc2lvblJlZ2lzdHJ5LCB0YWcpKSB7DQogICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDg6IHsNCiAgICAgICAgICAgICAgaW50IHJhd1ZhbHVlID0gaW5wdXQucmVhZEVudW0oKTsNCg0KICAgICAgICAgICAgICBzdWJzY3JpYmVUeXBlRGF0YV8gPSByYXdWYWx1ZTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDE4OiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIGNsaWVudElEXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAyNjogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICBjaGFubmVsXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAzNDogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICBncm91cF8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNDA6IHsNCiAgICAgICAgICAgICAgaW50IHJhd1ZhbHVlID0gaW5wdXQucmVhZEVudW0oKTsNCg0KICAgICAgICAgICAgICBldmVudHNTdG9yZVR5cGVEYXRhXyA9IHJhd1ZhbHVlOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNDg6IHsNCg0KICAgICAgICAgICAgICBldmVudHNTdG9yZVR5cGVWYWx1ZV8gPSBpbnB1dC5yZWFkSW50NjQoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9IGNhdGNoIChjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IGUuc2V0VW5maW5pc2hlZE1lc3NhZ2UodGhpcyk7DQogICAgICB9IGNhdGNoIChqYXZhLmlvLklPRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgdGhyb3cgbmV3IGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uKA0KICAgICAgICAgICAgZSkuc2V0VW5maW5pc2hlZE1lc3NhZ2UodGhpcyk7DQogICAgICB9IGZpbmFsbHkgew0KICAgICAgICB0aGlzLnVua25vd25GaWVsZHMgPSB1bmtub3duRmllbGRzLmJ1aWxkKCk7DQogICAgICAgIG1ha2VFeHRlbnNpb25zSW1tdXRhYmxlKCk7DQogICAgICB9DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1N1YnNjcmliZV9kZXNjcmlwdG9yOw0KICAgIH0NCg0KICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgaW50ZXJuYWxHZXRGaWVsZEFjY2Vzc29yVGFibGUoKSB7DQogICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1N1YnNjcmliZV9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlLkJ1aWxkZXIuY2xhc3MpOw0KICAgIH0NCg0KICAgIC8qKg0KICAgICAqIFByb3RvYnVmIGVudW0ge0Bjb2RlIGt1YmVtcS5TdWJzY3JpYmUuU3Vic2NyaWJlVHlwZX0NCiAgICAgKi8NCiAgICBwdWJsaWMgZW51bSBTdWJzY3JpYmVUeXBlDQogICAgICAgIGltcGxlbWVudHMgY29tLmdvb2dsZS5wcm90b2J1Zi5Qcm90b2NvbE1lc3NhZ2VFbnVtIHsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+U3Vic2NyaWJlVHlwZVVuZGVmaW5lZCA9IDA7PC9jb2RlPg0KICAgICAgICovDQogICAgICBTdWJzY3JpYmVUeXBlVW5kZWZpbmVkKDApLA0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5FdmVudHMgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgRXZlbnRzKDEpLA0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5FdmVudHNTdG9yZSA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBFdmVudHNTdG9yZSgyKSwNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Q29tbWFuZHMgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgQ29tbWFuZHMoMyksDQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPlF1ZXJpZXMgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgUXVlcmllcyg0KSwNCiAgICAgIFVOUkVDT0dOSVpFRCgtMSksDQogICAgICA7DQoNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+U3Vic2NyaWJlVHlwZVVuZGVmaW5lZCA9IDA7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTdWJzY3JpYmVUeXBlVW5kZWZpbmVkX1ZBTFVFID0gMDsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+RXZlbnRzID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEV2ZW50c19WQUxVRSA9IDE7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPkV2ZW50c1N0b3JlID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEV2ZW50c1N0b3JlX1ZBTFVFID0gMjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Q29tbWFuZHMgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQ29tbWFuZHNfVkFMVUUgPSAzOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5RdWVyaWVzID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFF1ZXJpZXNfVkFMVUUgPSA0Ow0KDQoNCiAgICAgIHB1YmxpYyBmaW5hbCBpbnQgZ2V0TnVtYmVyKCkgew0KICAgICAgICBpZiAodGhpcyA9PSBVTlJFQ09HTklaRUQpIHsNCiAgICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLklsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbigNCiAgICAgICAgICAgICAgIkNhbid0IGdldCB0aGUgbnVtYmVyIG9mIGFuIHVua25vd24gZW51bSB2YWx1ZS4iKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdmFsdWU7DQogICAgICB9DQoNCiAgICAgIC8qKg0KICAgICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayAjZm9yTnVtYmVyKGludCl9IGluc3RlYWQuDQogICAgICAgKi8NCiAgICAgIEBqYXZhLmxhbmcuRGVwcmVjYXRlZA0KICAgICAgcHVibGljIHN0YXRpYyBTdWJzY3JpYmVUeXBlIHZhbHVlT2YoaW50IHZhbHVlKSB7DQogICAgICAgIHJldHVybiBmb3JOdW1iZXIodmFsdWUpOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgc3RhdGljIFN1YnNjcmliZVR5cGUgZm9yTnVtYmVyKGludCB2YWx1ZSkgew0KICAgICAgICBzd2l0Y2ggKHZhbHVlKSB7DQogICAgICAgICAgY2FzZSAwOiByZXR1cm4gU3Vic2NyaWJlVHlwZVVuZGVmaW5lZDsNCiAgICAgICAgICBjYXNlIDE6IHJldHVybiBFdmVudHM7DQogICAgICAgICAgY2FzZSAyOiByZXR1cm4gRXZlbnRzU3RvcmU7DQogICAgICAgICAgY2FzZSAzOiByZXR1cm4gQ29tbWFuZHM7DQogICAgICAgICAgY2FzZSA0OiByZXR1cm4gUXVlcmllczsNCiAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgc3RhdGljIGNvbS5nb29nbGUucHJvdG9idWYuSW50ZXJuYWwuRW51bUxpdGVNYXA8U3Vic2NyaWJlVHlwZT4NCiAgICAgICAgICBpbnRlcm5hbEdldFZhbHVlTWFwKCkgew0KICAgICAgICByZXR1cm4gaW50ZXJuYWxWYWx1ZU1hcDsNCiAgICAgIH0NCiAgICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuSW50ZXJuYWwuRW51bUxpdGVNYXA8DQogICAgICAgICAgU3Vic2NyaWJlVHlwZT4gaW50ZXJuYWxWYWx1ZU1hcCA9DQogICAgICAgICAgICBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5FbnVtTGl0ZU1hcDxTdWJzY3JpYmVUeXBlPigpIHsNCiAgICAgICAgICAgICAgcHVibGljIFN1YnNjcmliZVR5cGUgZmluZFZhbHVlQnlOdW1iZXIoaW50IG51bWJlcikgew0KICAgICAgICAgICAgICAgIHJldHVybiBTdWJzY3JpYmVUeXBlLmZvck51bWJlcihudW1iZXIpOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KDQogICAgICBwdWJsaWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5FbnVtVmFsdWVEZXNjcmlwdG9yDQogICAgICAgICAgZ2V0VmFsdWVEZXNjcmlwdG9yKCkgew0KICAgICAgICByZXR1cm4gZ2V0RGVzY3JpcHRvcigpLmdldFZhbHVlcygpLmdldChvcmRpbmFsKCkpOw0KICAgICAgfQ0KICAgICAgcHVibGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRW51bURlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGdldERlc2NyaXB0b3IoKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5FbnVtRGVzY3JpcHRvcg0KICAgICAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5nZXREZXNjcmlwdG9yKCkuZ2V0RW51bVR5cGVzKCkuZ2V0KDApOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBTdWJzY3JpYmVUeXBlW10gVkFMVUVTID0gdmFsdWVzKCk7DQoNCiAgICAgIHB1YmxpYyBzdGF0aWMgU3Vic2NyaWJlVHlwZSB2YWx1ZU9mKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRW51bVZhbHVlRGVzY3JpcHRvciBkZXNjKSB7DQogICAgICAgIGlmIChkZXNjLmdldFR5cGUoKSAhPSBnZXREZXNjcmlwdG9yKCkpIHsNCiAgICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLklsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbigNCiAgICAgICAgICAgICJFbnVtVmFsdWVEZXNjcmlwdG9yIGlzIG5vdCBmb3IgdGhpcyB0eXBlLiIpOw0KICAgICAgICB9DQogICAgICAgIGlmIChkZXNjLmdldEluZGV4KCkgPT0gLTEpIHsNCiAgICAgICAgICByZXR1cm4gVU5SRUNPR05JWkVEOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBWQUxVRVNbZGVzYy5nZXRJbmRleCgpXTsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBmaW5hbCBpbnQgdmFsdWU7DQoNCiAgICAgIHByaXZhdGUgU3Vic2NyaWJlVHlwZShpbnQgdmFsdWUpIHsNCiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOw0KICAgICAgfQ0KDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoZW51bV9zY29wZTprdWJlbXEuU3Vic2NyaWJlLlN1YnNjcmliZVR5cGUpDQogICAgfQ0KDQogICAgLyoqDQogICAgICogUHJvdG9idWYgZW51bSB7QGNvZGUga3ViZW1xLlN1YnNjcmliZS5FdmVudHNTdG9yZVR5cGV9DQogICAgICovDQogICAgcHVibGljIGVudW0gRXZlbnRzU3RvcmVUeXBlDQogICAgICAgIGltcGxlbWVudHMgY29tLmdvb2dsZS5wcm90b2J1Zi5Qcm90b2NvbE1lc3NhZ2VFbnVtIHsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+RXZlbnRzU3RvcmVUeXBlVW5kZWZpbmVkID0gMDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIEV2ZW50c1N0b3JlVHlwZVVuZGVmaW5lZCgwKSwNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+U3RhcnROZXdPbmx5ID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIFN0YXJ0TmV3T25seSgxKSwNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+U3RhcnRGcm9tRmlyc3QgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgU3RhcnRGcm9tRmlyc3QoMiksDQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPlN0YXJ0RnJvbUxhc3QgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgU3RhcnRGcm9tTGFzdCgzKSwNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+U3RhcnRBdFNlcXVlbmNlID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIFN0YXJ0QXRTZXF1ZW5jZSg0KSwNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+U3RhcnRBdFRpbWUgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgU3RhcnRBdFRpbWUoNSksDQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPlN0YXJ0QXRUaW1lRGVsdGEgPSA2OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgU3RhcnRBdFRpbWVEZWx0YSg2KSwNCiAgICAgIFVOUkVDT0dOSVpFRCgtMSksDQogICAgICA7DQoNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+RXZlbnRzU3RvcmVUeXBlVW5kZWZpbmVkID0gMDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEV2ZW50c1N0b3JlVHlwZVVuZGVmaW5lZF9WQUxVRSA9IDA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPlN0YXJ0TmV3T25seSA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTdGFydE5ld09ubHlfVkFMVUUgPSAxOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5TdGFydEZyb21GaXJzdCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTdGFydEZyb21GaXJzdF9WQUxVRSA9IDI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPlN0YXJ0RnJvbUxhc3QgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU3RhcnRGcm9tTGFzdF9WQUxVRSA9IDM7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPlN0YXJ0QXRTZXF1ZW5jZSA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTdGFydEF0U2VxdWVuY2VfVkFMVUUgPSA0Ow0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5TdGFydEF0VGltZSA9IDU7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTdGFydEF0VGltZV9WQUxVRSA9IDU7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPlN0YXJ0QXRUaW1lRGVsdGEgPSA2OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU3RhcnRBdFRpbWVEZWx0YV9WQUxVRSA9IDY7DQoNCg0KICAgICAgcHVibGljIGZpbmFsIGludCBnZXROdW1iZXIoKSB7DQogICAgICAgIGlmICh0aGlzID09IFVOUkVDT0dOSVpFRCkgew0KICAgICAgICAgIHRocm93IG5ldyBqYXZhLmxhbmcuSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKA0KICAgICAgICAgICAgICAiQ2FuJ3QgZ2V0IHRoZSBudW1iZXIgb2YgYW4gdW5rbm93biBlbnVtIHZhbHVlLiIpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB2YWx1ZTsNCiAgICAgIH0NCg0KICAgICAgLyoqDQogICAgICAgKiBAZGVwcmVjYXRlZCBVc2Uge0BsaW5rICNmb3JOdW1iZXIoaW50KX0gaW5zdGVhZC4NCiAgICAgICAqLw0KICAgICAgQGphdmEubGFuZy5EZXByZWNhdGVkDQogICAgICBwdWJsaWMgc3RhdGljIEV2ZW50c1N0b3JlVHlwZSB2YWx1ZU9mKGludCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gZm9yTnVtYmVyKHZhbHVlKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIHN0YXRpYyBFdmVudHNTdG9yZVR5cGUgZm9yTnVtYmVyKGludCB2YWx1ZSkgew0KICAgICAgICBzd2l0Y2ggKHZhbHVlKSB7DQogICAgICAgICAgY2FzZSAwOiByZXR1cm4gRXZlbnRzU3RvcmVUeXBlVW5kZWZpbmVkOw0KICAgICAgICAgIGNhc2UgMTogcmV0dXJuIFN0YXJ0TmV3T25seTsNCiAgICAgICAgICBjYXNlIDI6IHJldHVybiBTdGFydEZyb21GaXJzdDsNCiAgICAgICAgICBjYXNlIDM6IHJldHVybiBTdGFydEZyb21MYXN0Ow0KICAgICAgICAgIGNhc2UgNDogcmV0dXJuIFN0YXJ0QXRTZXF1ZW5jZTsNCiAgICAgICAgICBjYXNlIDU6IHJldHVybiBTdGFydEF0VGltZTsNCiAgICAgICAgICBjYXNlIDY6IHJldHVybiBTdGFydEF0VGltZURlbHRhOw0KICAgICAgICAgIGRlZmF1bHQ6IHJldHVybiBudWxsOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBzdGF0aWMgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5FbnVtTGl0ZU1hcDxFdmVudHNTdG9yZVR5cGU+DQogICAgICAgICAgaW50ZXJuYWxHZXRWYWx1ZU1hcCgpIHsNCiAgICAgICAgcmV0dXJuIGludGVybmFsVmFsdWVNYXA7DQogICAgICB9DQogICAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkludGVybmFsLkVudW1MaXRlTWFwPA0KICAgICAgICAgIEV2ZW50c1N0b3JlVHlwZT4gaW50ZXJuYWxWYWx1ZU1hcCA9DQogICAgICAgICAgICBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5FbnVtTGl0ZU1hcDxFdmVudHNTdG9yZVR5cGU+KCkgew0KICAgICAgICAgICAgICBwdWJsaWMgRXZlbnRzU3RvcmVUeXBlIGZpbmRWYWx1ZUJ5TnVtYmVyKGludCBudW1iZXIpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gRXZlbnRzU3RvcmVUeXBlLmZvck51bWJlcihudW1iZXIpOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICB9Ow0KDQogICAgICBwdWJsaWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5FbnVtVmFsdWVEZXNjcmlwdG9yDQogICAgICAgICAgZ2V0VmFsdWVEZXNjcmlwdG9yKCkgew0KICAgICAgICByZXR1cm4gZ2V0RGVzY3JpcHRvcigpLmdldFZhbHVlcygpLmdldChvcmRpbmFsKCkpOw0KICAgICAgfQ0KICAgICAgcHVibGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRW51bURlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGdldERlc2NyaXB0b3IoKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5FbnVtRGVzY3JpcHRvcg0KICAgICAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5nZXREZXNjcmlwdG9yKCkuZ2V0RW51bVR5cGVzKCkuZ2V0KDEpOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBFdmVudHNTdG9yZVR5cGVbXSBWQUxVRVMgPSB2YWx1ZXMoKTsNCg0KICAgICAgcHVibGljIHN0YXRpYyBFdmVudHNTdG9yZVR5cGUgdmFsdWVPZigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkVudW1WYWx1ZURlc2NyaXB0b3IgZGVzYykgew0KICAgICAgICBpZiAoZGVzYy5nZXRUeXBlKCkgIT0gZ2V0RGVzY3JpcHRvcigpKSB7DQogICAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5JbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24oDQogICAgICAgICAgICAiRW51bVZhbHVlRGVzY3JpcHRvciBpcyBub3QgZm9yIHRoaXMgdHlwZS4iKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoZGVzYy5nZXRJbmRleCgpID09IC0xKSB7DQogICAgICAgICAgcmV0dXJuIFVOUkVDT0dOSVpFRDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gVkFMVUVTW2Rlc2MuZ2V0SW5kZXgoKV07DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgZmluYWwgaW50IHZhbHVlOw0KDQogICAgICBwcml2YXRlIEV2ZW50c1N0b3JlVHlwZShpbnQgdmFsdWUpIHsNCiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOw0KICAgICAgfQ0KDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoZW51bV9zY29wZTprdWJlbXEuU3Vic2NyaWJlLkV2ZW50c1N0b3JlVHlwZSkNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTVUJTQ1JJQkVUWVBFREFUQV9GSUVMRF9OVU1CRVIgPSAxOw0KICAgIHByaXZhdGUgaW50IHN1YnNjcmliZVR5cGVEYXRhXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlN1YnNjcmliZS5TdWJzY3JpYmVUeXBlIFN1YnNjcmliZVR5cGVEYXRhID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGludCBnZXRTdWJzY3JpYmVUeXBlRGF0YVZhbHVlKCkgew0KICAgICAgcmV0dXJuIHN1YnNjcmliZVR5cGVEYXRhXzsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+Lmt1YmVtcS5TdWJzY3JpYmUuU3Vic2NyaWJlVHlwZSBTdWJzY3JpYmVUeXBlRGF0YSA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5TdWJzY3JpYmVUeXBlIGdldFN1YnNjcmliZVR5cGVEYXRhKCkgew0KICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUuU3Vic2NyaWJlVHlwZSByZXN1bHQgPSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5TdWJzY3JpYmVUeXBlLnZhbHVlT2Yoc3Vic2NyaWJlVHlwZURhdGFfKTsNCiAgICAgIHJldHVybiByZXN1bHQgPT0gbnVsbCA/IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlLlN1YnNjcmliZVR5cGUuVU5SRUNPR05JWkVEIDogcmVzdWx0Ow0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENMSUVOVElEX0ZJRUxEX05VTUJFUiA9IDI7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IGNsaWVudElEXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDbGllbnRJRCgpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2xpZW50SURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIGNsaWVudElEXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldENsaWVudElEQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNsaWVudElEXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICBjbGllbnRJRF8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQ0hBTk5FTF9GSUVMRF9OVU1CRVIgPSAzOw0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBjaGFubmVsXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldENoYW5uZWwoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNoYW5uZWxfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIGNoYW5uZWxfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRDaGFubmVsQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNoYW5uZWxfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIGNoYW5uZWxfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEdST1VQX0ZJRUxEX05VTUJFUiA9IDQ7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IGdyb3VwXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgR3JvdXAgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRHcm91cCgpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gZ3JvdXBfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIGdyb3VwXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgR3JvdXAgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldEdyb3VwQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGdyb3VwXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICBncm91cF8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRVZFTlRTU1RPUkVUWVBFREFUQV9GSUVMRF9OVU1CRVIgPSA1Ow0KICAgIHByaXZhdGUgaW50IGV2ZW50c1N0b3JlVHlwZURhdGFfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuU3Vic2NyaWJlLkV2ZW50c1N0b3JlVHlwZSBFdmVudHNTdG9yZVR5cGVEYXRhID0gNTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGludCBnZXRFdmVudHNTdG9yZVR5cGVEYXRhVmFsdWUoKSB7DQogICAgICByZXR1cm4gZXZlbnRzU3RvcmVUeXBlRGF0YV87DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuU3Vic2NyaWJlLkV2ZW50c1N0b3JlVHlwZSBFdmVudHNTdG9yZVR5cGVEYXRhID0gNTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlLkV2ZW50c1N0b3JlVHlwZSBnZXRFdmVudHNTdG9yZVR5cGVEYXRhKCkgew0KICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUuRXZlbnRzU3RvcmVUeXBlIHJlc3VsdCA9IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlLkV2ZW50c1N0b3JlVHlwZS52YWx1ZU9mKGV2ZW50c1N0b3JlVHlwZURhdGFfKTsNCiAgICAgIHJldHVybiByZXN1bHQgPT0gbnVsbCA/IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlLkV2ZW50c1N0b3JlVHlwZS5VTlJFQ09HTklaRUQgOiByZXN1bHQ7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRVZFTlRTU1RPUkVUWVBFVkFMVUVfRklFTERfTlVNQkVSID0gNjsNCiAgICBwcml2YXRlIGxvbmcgZXZlbnRzU3RvcmVUeXBlVmFsdWVfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDY0IEV2ZW50c1N0b3JlVHlwZVZhbHVlID0gNjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGxvbmcgZ2V0RXZlbnRzU3RvcmVUeXBlVmFsdWUoKSB7DQogICAgICByZXR1cm4gZXZlbnRzU3RvcmVUeXBlVmFsdWVfOw0KICAgIH0NCg0KICAgIHByaXZhdGUgYnl0ZSBtZW1vaXplZElzSW5pdGlhbGl6ZWQgPSAtMTsNCiAgICBwdWJsaWMgZmluYWwgYm9vbGVhbiBpc0luaXRpYWxpemVkKCkgew0KICAgICAgYnl0ZSBpc0luaXRpYWxpemVkID0gbWVtb2l6ZWRJc0luaXRpYWxpemVkOw0KICAgICAgaWYgKGlzSW5pdGlhbGl6ZWQgPT0gMSkgcmV0dXJuIHRydWU7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAwKSByZXR1cm4gZmFsc2U7DQoNCiAgICAgIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IDE7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQoNCiAgICBwdWJsaWMgdm9pZCB3cml0ZVRvKGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0gb3V0cHV0KQ0KICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgaWYgKHN1YnNjcmliZVR5cGVEYXRhXyAhPSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5TdWJzY3JpYmVUeXBlLlN1YnNjcmliZVR5cGVVbmRlZmluZWQuZ2V0TnVtYmVyKCkpIHsNCiAgICAgICAgb3V0cHV0LndyaXRlRW51bSgxLCBzdWJzY3JpYmVUeXBlRGF0YV8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRDbGllbnRJREJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLndyaXRlU3RyaW5nKG91dHB1dCwgMiwgY2xpZW50SURfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0Q2hhbm5lbEJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLndyaXRlU3RyaW5nKG91dHB1dCwgMywgY2hhbm5lbF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRHcm91cEJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLndyaXRlU3RyaW5nKG91dHB1dCwgNCwgZ3JvdXBfKTsNCiAgICAgIH0NCiAgICAgIGlmIChldmVudHNTdG9yZVR5cGVEYXRhXyAhPSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5FdmVudHNTdG9yZVR5cGUuRXZlbnRzU3RvcmVUeXBlVW5kZWZpbmVkLmdldE51bWJlcigpKSB7DQogICAgICAgIG91dHB1dC53cml0ZUVudW0oNSwgZXZlbnRzU3RvcmVUeXBlRGF0YV8pOw0KICAgICAgfQ0KICAgICAgaWYgKGV2ZW50c1N0b3JlVHlwZVZhbHVlXyAhPSAwTCkgew0KICAgICAgICBvdXRwdXQud3JpdGVJbnQ2NCg2LCBldmVudHNTdG9yZVR5cGVWYWx1ZV8pOw0KICAgICAgfQ0KICAgICAgdW5rbm93bkZpZWxkcy53cml0ZVRvKG91dHB1dCk7DQogICAgfQ0KDQogICAgcHVibGljIGludCBnZXRTZXJpYWxpemVkU2l6ZSgpIHsNCiAgICAgIGludCBzaXplID0gbWVtb2l6ZWRTaXplOw0KICAgICAgaWYgKHNpemUgIT0gLTEpIHJldHVybiBzaXplOw0KDQogICAgICBzaXplID0gMDsNCiAgICAgIGlmIChzdWJzY3JpYmVUeXBlRGF0YV8gIT0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUuU3Vic2NyaWJlVHlwZS5TdWJzY3JpYmVUeXBlVW5kZWZpbmVkLmdldE51bWJlcigpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlRW51bVNpemUoMSwgc3Vic2NyaWJlVHlwZURhdGFfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0Q2xpZW50SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDIsIGNsaWVudElEXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldENoYW5uZWxCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDMsIGNoYW5uZWxfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0R3JvdXBCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDQsIGdyb3VwXyk7DQogICAgICB9DQogICAgICBpZiAoZXZlbnRzU3RvcmVUeXBlRGF0YV8gIT0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUuRXZlbnRzU3RvcmVUeXBlLkV2ZW50c1N0b3JlVHlwZVVuZGVmaW5lZC5nZXROdW1iZXIoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUVudW1TaXplKDUsIGV2ZW50c1N0b3JlVHlwZURhdGFfKTsNCiAgICAgIH0NCiAgICAgIGlmIChldmVudHNTdG9yZVR5cGVWYWx1ZV8gIT0gMEwpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVJbnQ2NFNpemUoNiwgZXZlbnRzU3RvcmVUeXBlVmFsdWVfKTsNCiAgICAgIH0NCiAgICAgIHNpemUgKz0gdW5rbm93bkZpZWxkcy5nZXRTZXJpYWxpemVkU2l6ZSgpOw0KICAgICAgbWVtb2l6ZWRTaXplID0gc2l6ZTsNCiAgICAgIHJldHVybiBzaXplOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgYm9vbGVhbiBlcXVhbHMoZmluYWwgamF2YS5sYW5nLk9iamVjdCBvYmopIHsNCiAgICAgIGlmIChvYmogPT0gdGhpcykgew0KICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KICAgICAgaWYgKCEob2JqIGluc3RhbmNlb2YgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUpKSB7DQogICAgICAgIHJldHVybiBzdXBlci5lcXVhbHMob2JqKTsNCiAgICAgIH0NCiAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlIG90aGVyID0gKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlKSBvYmo7DQoNCiAgICAgIGJvb2xlYW4gcmVzdWx0ID0gdHJ1ZTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBzdWJzY3JpYmVUeXBlRGF0YV8gPT0gb3RoZXIuc3Vic2NyaWJlVHlwZURhdGFfOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldENsaWVudElEKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldENsaWVudElEKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldENoYW5uZWwoKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0Q2hhbm5lbCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRHcm91cCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRHcm91cCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBldmVudHNTdG9yZVR5cGVEYXRhXyA9PSBvdGhlci5ldmVudHNTdG9yZVR5cGVEYXRhXzsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiAoZ2V0RXZlbnRzU3RvcmVUeXBlVmFsdWUoKQ0KICAgICAgICAgID09IG90aGVyLmdldEV2ZW50c1N0b3JlVHlwZVZhbHVlKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIHVua25vd25GaWVsZHMuZXF1YWxzKG90aGVyLnVua25vd25GaWVsZHMpOw0KICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGludCBoYXNoQ29kZSgpIHsNCiAgICAgIGlmIChtZW1vaXplZEhhc2hDb2RlICE9IDApIHsNCiAgICAgICAgcmV0dXJuIG1lbW9pemVkSGFzaENvZGU7DQogICAgICB9DQogICAgICBpbnQgaGFzaCA9IDQxOw0KICAgICAgaGFzaCA9ICgxOSAqIGhhc2gpICsgZ2V0RGVzY3JpcHRvcigpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBTVUJTQ1JJQkVUWVBFREFUQV9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBzdWJzY3JpYmVUeXBlRGF0YV87DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBDTElFTlRJRF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRDbGllbnRJRCgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBDSEFOTkVMX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldENoYW5uZWwoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgR1JPVVBfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0R3JvdXAoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgRVZFTlRTU1RPUkVUWVBFREFUQV9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBldmVudHNTdG9yZVR5cGVEYXRhXzsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIEVWRU5UU1NUT1JFVFlQRVZBTFVFX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGNvbS5nb29nbGUucHJvdG9idWYuSW50ZXJuYWwuaGFzaExvbmcoDQogICAgICAgICAgZ2V0RXZlbnRzU3RvcmVUeXBlVmFsdWUoKSk7DQogICAgICBoYXNoID0gKDI5ICogaGFzaCkgKyB1bmtub3duRmllbGRzLmhhc2hDb2RlKCk7DQogICAgICBtZW1vaXplZEhhc2hDb2RlID0gaGFzaDsNCiAgICAgIHJldHVybiBoYXNoOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZSBwYXJzZUZyb20oDQogICAgICAgIGphdmEubmlvLkJ5dGVCdWZmZXIgZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlIHBhcnNlRnJvbShieXRlW10gZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlIHBhcnNlRnJvbSgNCiAgICAgICAgYnl0ZVtdIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlIHBhcnNlRnJvbShqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZSBwYXJzZURlbGltaXRlZEZyb20oamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlIHBhcnNlRGVsaW1pdGVkRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZURlbGltaXRlZFdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZSBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KDQogICAgcHVibGljIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoKSB7IHJldHVybiBuZXdCdWlsZGVyKCk7IH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcigpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFLnRvQnVpbGRlcigpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcihpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZSBwcm90b3R5cGUpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFLnRvQnVpbGRlcigpLm1lcmdlRnJvbShwcm90b3R5cGUpOw0KICAgIH0NCiAgICBwdWJsaWMgQnVpbGRlciB0b0J1aWxkZXIoKSB7DQogICAgICByZXR1cm4gdGhpcyA9PSBERUZBVUxUX0lOU1RBTkNFDQogICAgICAgICAgPyBuZXcgQnVpbGRlcigpIDogbmV3IEJ1aWxkZXIoKS5tZXJnZUZyb20odGhpcyk7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHByb3RlY3RlZCBCdWlsZGVyIG5ld0J1aWxkZXJGb3JUeXBlKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgQnVpbGRlciBidWlsZGVyID0gbmV3IEJ1aWxkZXIocGFyZW50KTsNCiAgICAgIHJldHVybiBidWlsZGVyOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuU3Vic2NyaWJlfQ0KICAgICAqLw0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY2xhc3MgQnVpbGRlciBleHRlbmRzDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8QnVpbGRlcj4gaW1wbGVtZW50cw0KICAgICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoYnVpbGRlcl9pbXBsZW1lbnRzOmt1YmVtcS5TdWJzY3JpYmUpDQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlT3JCdWlsZGVyIHsNCiAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvcigpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdWJzY3JpYmVfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICAgIGludGVybmFsR2V0RmllbGRBY2Nlc3NvclRhYmxlKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1N1YnNjcmliZV9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAgIC5lbnN1cmVGaWVsZEFjY2Vzc29yc0luaXRpYWxpemVkKA0KICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlLmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5CdWlsZGVyLmNsYXNzKTsNCiAgICAgIH0NCg0KICAgICAgLy8gQ29uc3RydWN0IHVzaW5nIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlLm5ld0J1aWxkZXIoKQ0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKCkgew0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgQnVpbGRlcigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgICBzdXBlcihwYXJlbnQpOw0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQogICAgICBwcml2YXRlIHZvaWQgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpIHsNCiAgICAgICAgaWYgKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgICAgICAgLmFsd2F5c1VzZUZpZWxkQnVpbGRlcnMpIHsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXIoKSB7DQogICAgICAgIHN1cGVyLmNsZWFyKCk7DQogICAgICAgIHN1YnNjcmliZVR5cGVEYXRhXyA9IDA7DQoNCiAgICAgICAgY2xpZW50SURfID0gIiI7DQoNCiAgICAgICAgY2hhbm5lbF8gPSAiIjsNCg0KICAgICAgICBncm91cF8gPSAiIjsNCg0KICAgICAgICBldmVudHNTdG9yZVR5cGVEYXRhXyA9IDA7DQoNCiAgICAgICAgZXZlbnRzU3RvcmVUeXBlVmFsdWVfID0gMEw7DQoNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdWJzY3JpYmVfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlIGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5nZXREZWZhdWx0SW5zdGFuY2UoKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlIGJ1aWxkKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZSByZXN1bHQgPSBidWlsZFBhcnRpYWwoKTsNCiAgICAgICAgaWYgKCFyZXN1bHQuaXNJbml0aWFsaXplZCgpKSB7DQogICAgICAgICAgdGhyb3cgbmV3VW5pbml0aWFsaXplZE1lc3NhZ2VFeGNlcHRpb24ocmVzdWx0KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUgYnVpbGRQYXJ0aWFsKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZSByZXN1bHQgPSBuZXcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUodGhpcyk7DQogICAgICAgIHJlc3VsdC5zdWJzY3JpYmVUeXBlRGF0YV8gPSBzdWJzY3JpYmVUeXBlRGF0YV87DQogICAgICAgIHJlc3VsdC5jbGllbnRJRF8gPSBjbGllbnRJRF87DQogICAgICAgIHJlc3VsdC5jaGFubmVsXyA9IGNoYW5uZWxfOw0KICAgICAgICByZXN1bHQuZ3JvdXBfID0gZ3JvdXBfOw0KICAgICAgICByZXN1bHQuZXZlbnRzU3RvcmVUeXBlRGF0YV8gPSBldmVudHNTdG9yZVR5cGVEYXRhXzsNCiAgICAgICAgcmVzdWx0LmV2ZW50c1N0b3JlVHlwZVZhbHVlXyA9IGV2ZW50c1N0b3JlVHlwZVZhbHVlXzsNCiAgICAgICAgb25CdWlsdCgpOw0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBjbG9uZSgpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbG9uZSgpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJGaWVsZChmaWVsZCk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck9uZW9mKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuT25lb2ZEZXNjcmlwdG9yIG9uZW9mKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJPbmVvZihvbmVvZik7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGludCBpbmRleCwgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldFJlcGVhdGVkRmllbGQoZmllbGQsIGluZGV4LCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBhZGRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5hZGRSZXBlYXRlZEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oY29tLmdvb2dsZS5wcm90b2J1Zi5NZXNzYWdlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlKSB7DQogICAgICAgICAgcmV0dXJuIG1lcmdlRnJvbSgoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUpb3RoZXIpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHN1cGVyLm1lcmdlRnJvbShvdGhlcik7DQogICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciA9PSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5nZXREZWZhdWx0SW5zdGFuY2UoKSkgcmV0dXJuIHRoaXM7DQogICAgICAgIGlmIChvdGhlci5zdWJzY3JpYmVUeXBlRGF0YV8gIT0gMCkgew0KICAgICAgICAgIHNldFN1YnNjcmliZVR5cGVEYXRhVmFsdWUob3RoZXIuZ2V0U3Vic2NyaWJlVHlwZURhdGFWYWx1ZSgpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIW90aGVyLmdldENsaWVudElEKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgY2xpZW50SURfID0gb3RoZXIuY2xpZW50SURfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmICghb3RoZXIuZ2V0Q2hhbm5lbCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIGNoYW5uZWxfID0gb3RoZXIuY2hhbm5lbF87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRHcm91cCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIGdyb3VwXyA9IG90aGVyLmdyb3VwXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZXZlbnRzU3RvcmVUeXBlRGF0YV8gIT0gMCkgew0KICAgICAgICAgIHNldEV2ZW50c1N0b3JlVHlwZURhdGFWYWx1ZShvdGhlci5nZXRFdmVudHNTdG9yZVR5cGVEYXRhVmFsdWUoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmdldEV2ZW50c1N0b3JlVHlwZVZhbHVlKCkgIT0gMEwpIHsNCiAgICAgICAgICBzZXRFdmVudHNTdG9yZVR5cGVWYWx1ZShvdGhlci5nZXRFdmVudHNTdG9yZVR5cGVWYWx1ZSgpKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLm1lcmdlVW5rbm93bkZpZWxkcyhvdGhlci51bmtub3duRmllbGRzKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgZmluYWwgYm9vbGVhbiBpc0luaXRpYWxpemVkKCkgew0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlIHBhcnNlZE1lc3NhZ2UgPSBudWxsOw0KICAgICAgICB0cnkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSBQQVJTRVIucGFyc2VQYXJ0aWFsRnJvbShpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgICB9IGNhdGNoIChjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiBlKSB7DQogICAgICAgICAgcGFyc2VkTWVzc2FnZSA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZSkgZS5nZXRVbmZpbmlzaGVkTWVzc2FnZSgpOw0KICAgICAgICAgIHRocm93IGUudW53cmFwSU9FeGNlcHRpb24oKTsNCiAgICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgICBpZiAocGFyc2VkTWVzc2FnZSAhPSBudWxsKSB7DQogICAgICAgICAgICBtZXJnZUZyb20ocGFyc2VkTWVzc2FnZSk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGludCBzdWJzY3JpYmVUeXBlRGF0YV8gPSAwOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlN1YnNjcmliZS5TdWJzY3JpYmVUeXBlIFN1YnNjcmliZVR5cGVEYXRhID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpbnQgZ2V0U3Vic2NyaWJlVHlwZURhdGFWYWx1ZSgpIHsNCiAgICAgICAgcmV0dXJuIHN1YnNjcmliZVR5cGVEYXRhXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5TdWJzY3JpYmUuU3Vic2NyaWJlVHlwZSBTdWJzY3JpYmVUeXBlRGF0YSA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRTdWJzY3JpYmVUeXBlRGF0YVZhbHVlKGludCB2YWx1ZSkgew0KICAgICAgICBzdWJzY3JpYmVUeXBlRGF0YV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlN1YnNjcmliZS5TdWJzY3JpYmVUeXBlIFN1YnNjcmliZVR5cGVEYXRhID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5TdWJzY3JpYmVUeXBlIGdldFN1YnNjcmliZVR5cGVEYXRhKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5TdWJzY3JpYmVUeXBlIHJlc3VsdCA9IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlLlN1YnNjcmliZVR5cGUudmFsdWVPZihzdWJzY3JpYmVUeXBlRGF0YV8pOw0KICAgICAgICByZXR1cm4gcmVzdWx0ID09IG51bGwgPyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5TdWJzY3JpYmVUeXBlLlVOUkVDT0dOSVpFRCA6IHJlc3VsdDsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5TdWJzY3JpYmUuU3Vic2NyaWJlVHlwZSBTdWJzY3JpYmVUeXBlRGF0YSA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRTdWJzY3JpYmVUeXBlRGF0YShpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5TdWJzY3JpYmVUeXBlIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgICAgICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIHN1YnNjcmliZVR5cGVEYXRhXyA9IHZhbHVlLmdldE51bWJlcigpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPi5rdWJlbXEuU3Vic2NyaWJlLlN1YnNjcmliZVR5cGUgU3Vic2NyaWJlVHlwZURhdGEgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJTdWJzY3JpYmVUeXBlRGF0YSgpIHsNCiAgICAgICAgDQogICAgICAgIHN1YnNjcmliZVR5cGVEYXRhXyA9IDA7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IGNsaWVudElEXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2xpZW50SUQoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2xpZW50SURfOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICBjbGllbnRJRF8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0Q2xpZW50SURCeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjbGllbnRJRF87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgY2xpZW50SURfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRDbGllbnRJRCgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIGNsaWVudElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckNsaWVudElEKCkgew0KICAgICAgICANCiAgICAgICAgY2xpZW50SURfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0Q2xpZW50SUQoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2xpZW50SURCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgY2xpZW50SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IGNoYW5uZWxfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldENoYW5uZWwoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2hhbm5lbF87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIGNoYW5uZWxfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0Q2hhbm5lbEJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNoYW5uZWxfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIGNoYW5uZWxfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldENoYW5uZWwoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBjaGFubmVsXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyQ2hhbm5lbCgpIHsNCiAgICAgICAgDQogICAgICAgIGNoYW5uZWxfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0Q2hhbm5lbCgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldENoYW5uZWxCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgY2hhbm5lbF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgZ3JvdXBfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBHcm91cCA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRHcm91cCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBncm91cF87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIGdyb3VwXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEdyb3VwID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRHcm91cEJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGdyb3VwXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBncm91cF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEdyb3VwID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEdyb3VwKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgZ3JvdXBfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEdyb3VwID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyR3JvdXAoKSB7DQogICAgICAgIA0KICAgICAgICBncm91cF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRHcm91cCgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBHcm91cCA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRHcm91cEJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBncm91cF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGludCBldmVudHNTdG9yZVR5cGVEYXRhXyA9IDA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPi5rdWJlbXEuU3Vic2NyaWJlLkV2ZW50c1N0b3JlVHlwZSBFdmVudHNTdG9yZVR5cGVEYXRhID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpbnQgZ2V0RXZlbnRzU3RvcmVUeXBlRGF0YVZhbHVlKCkgew0KICAgICAgICByZXR1cm4gZXZlbnRzU3RvcmVUeXBlRGF0YV87DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPi5rdWJlbXEuU3Vic2NyaWJlLkV2ZW50c1N0b3JlVHlwZSBFdmVudHNTdG9yZVR5cGVEYXRhID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEV2ZW50c1N0b3JlVHlwZURhdGFWYWx1ZShpbnQgdmFsdWUpIHsNCiAgICAgICAgZXZlbnRzU3RvcmVUeXBlRGF0YV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlN1YnNjcmliZS5FdmVudHNTdG9yZVR5cGUgRXZlbnRzU3RvcmVUeXBlRGF0YSA9IDU7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUuRXZlbnRzU3RvcmVUeXBlIGdldEV2ZW50c1N0b3JlVHlwZURhdGEoKSB7DQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlLkV2ZW50c1N0b3JlVHlwZSByZXN1bHQgPSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZS5FdmVudHNTdG9yZVR5cGUudmFsdWVPZihldmVudHNTdG9yZVR5cGVEYXRhXyk7DQogICAgICAgIHJldHVybiByZXN1bHQgPT0gbnVsbCA/IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlLkV2ZW50c1N0b3JlVHlwZS5VTlJFQ09HTklaRUQgOiByZXN1bHQ7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPi5rdWJlbXEuU3Vic2NyaWJlLkV2ZW50c1N0b3JlVHlwZSBFdmVudHNTdG9yZVR5cGVEYXRhID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEV2ZW50c1N0b3JlVHlwZURhdGEoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUuRXZlbnRzU3RvcmVUeXBlIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgICAgICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogICAgICAgIH0NCiAgICAgICAgDQogICAgICAgIGV2ZW50c1N0b3JlVHlwZURhdGFfID0gdmFsdWUuZ2V0TnVtYmVyKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5TdWJzY3JpYmUuRXZlbnRzU3RvcmVUeXBlIEV2ZW50c1N0b3JlVHlwZURhdGEgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJFdmVudHNTdG9yZVR5cGVEYXRhKCkgew0KICAgICAgICANCiAgICAgICAgZXZlbnRzU3RvcmVUeXBlRGF0YV8gPSAwOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgbG9uZyBldmVudHNTdG9yZVR5cGVWYWx1ZV8gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQ2NCBFdmVudHNTdG9yZVR5cGVWYWx1ZSA9IDY7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgbG9uZyBnZXRFdmVudHNTdG9yZVR5cGVWYWx1ZSgpIHsNCiAgICAgICAgcmV0dXJuIGV2ZW50c1N0b3JlVHlwZVZhbHVlXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgRXZlbnRzU3RvcmVUeXBlVmFsdWUgPSA2OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RXZlbnRzU3RvcmVUeXBlVmFsdWUobG9uZyB2YWx1ZSkgew0KICAgICAgICANCiAgICAgICAgZXZlbnRzU3RvcmVUeXBlVmFsdWVfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgRXZlbnRzU3RvcmVUeXBlVmFsdWUgPSA2OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJFdmVudHNTdG9yZVR5cGVWYWx1ZSgpIHsNCiAgICAgICAgDQogICAgICAgIGV2ZW50c1N0b3JlVHlwZVZhbHVlXyA9IDBMOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBzZXRVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLnNldFVua25vd25GaWVsZHNQcm90bzModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIG1lcmdlVW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5tZXJnZVVua25vd25GaWVsZHModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCg0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfc2NvcGU6a3ViZW1xLlN1YnNjcmliZSkNCiAgICB9DQoNCiAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoY2xhc3Nfc2NvcGU6a3ViZW1xLlN1YnNjcmliZSkNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZSBERUZBVUxUX0lOU1RBTkNFOw0KICAgIHN0YXRpYyB7DQogICAgICBERUZBVUxUX0lOU1RBTkNFID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3Vic2NyaWJlKCk7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN1YnNjcmliZSBnZXREZWZhdWx0SW5zdGFuY2UoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRTsNCiAgICB9DQoNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxTdWJzY3JpYmU+DQogICAgICAgIFBBUlNFUiA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkFic3RyYWN0UGFyc2VyPFN1YnNjcmliZT4oKSB7DQogICAgICBwdWJsaWMgU3Vic2NyaWJlIHBhcnNlUGFydGlhbEZyb20oDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICAgIHJldHVybiBuZXcgU3Vic2NyaWJlKGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICB9DQogICAgfTsNCg0KICAgIHB1YmxpYyBzdGF0aWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8U3Vic2NyaWJlPiBwYXJzZXIoKSB7DQogICAgICByZXR1cm4gUEFSU0VSOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8U3Vic2NyaWJlPiBnZXRQYXJzZXJGb3JUeXBlKCkgew0KICAgICAgcmV0dXJuIFBBUlNFUjsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdWJzY3JpYmUgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFOw0KICAgIH0NCg0KICB9DQoNCiAgcHVibGljIGludGVyZmFjZSBSZXF1ZXN0T3JCdWlsZGVyIGV4dGVuZHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChpbnRlcmZhY2VfZXh0ZW5kczprdWJlbXEuUmVxdWVzdCkNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZU9yQnVpbGRlciB7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRSZXF1ZXN0SUQoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldFJlcXVlc3RJREJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlJlcXVlc3QuUmVxdWVzdFR5cGUgUmVxdWVzdFR5cGVEYXRhID0gMjs8L2NvZGU+DQogICAgICovDQogICAgaW50IGdldFJlcXVlc3RUeXBlRGF0YVZhbHVlKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+Lmt1YmVtcS5SZXF1ZXN0LlJlcXVlc3RUeXBlIFJlcXVlc3RUeXBlRGF0YSA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdC5SZXF1ZXN0VHlwZSBnZXRSZXF1ZXN0VHlwZURhdGEoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2xpZW50SUQoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0Q2xpZW50SURCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldENoYW5uZWwoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRDaGFubmVsQnl0ZXMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDU7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0TWV0YWRhdGEoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgTWV0YWRhdGEgPSA1OzwvY29kZT4NCiAgICAgKi8NCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0TWV0YWRhdGFCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+Ynl0ZXMgQm9keSA9IDY7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBnZXRCb2R5KCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVwbHlDaGFubmVsID0gNzs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRSZXBseUNoYW5uZWwoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVwbHlDaGFubmVsID0gNzs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldFJlcGx5Q2hhbm5lbEJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQzMiBUaW1lb3V0ID0gODs8L2NvZGU+DQogICAgICovDQogICAgaW50IGdldFRpbWVvdXQoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDYWNoZUtleSA9IDk7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2FjaGVLZXkoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2FjaGVLZXkgPSA5OzwvY29kZT4NCiAgICAgKi8NCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0Q2FjaGVLZXlCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+aW50MzIgQ2FjaGVUVEwgPSAxMDs8L2NvZGU+DQogICAgICovDQogICAgaW50IGdldENhY2hlVFRMKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5ieXRlcyBTcGFuID0gMTE7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBnZXRTcGFuKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSAxMjs8L2NvZGU+DQogICAgICovDQogICAgaW50IGdldFRhZ3NDb3VudCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDEyOzwvY29kZT4NCiAgICAgKi8NCiAgICBib29sZWFuIGNvbnRhaW5zVGFncygNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpOw0KICAgIC8qKg0KICAgICAqIFVzZSB7QGxpbmsgI2dldFRhZ3NNYXAoKX0gaW5zdGVhZC4NCiAgICAgKi8NCiAgICBAamF2YS5sYW5nLkRlcHJlY2F0ZWQNCiAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+DQogICAgZ2V0VGFncygpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDEyOzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+DQogICAgZ2V0VGFnc01hcCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDEyOzwvY29kZT4NCiAgICAgKi8NCg0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0VGFnc09yRGVmYXVsdCgNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXksDQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgZGVmYXVsdFZhbHVlKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSAxMjs8L2NvZGU+DQogICAgICovDQoNCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldFRhZ3NPclRocm93KA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSk7DQogIH0NCiAgLyoqDQogICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5SZXF1ZXN0fQ0KICAgKi8NCiAgcHVibGljICBzdGF0aWMgZmluYWwgY2xhc3MgUmVxdWVzdCBleHRlbmRzDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMyBpbXBsZW1lbnRzDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQobWVzc2FnZV9pbXBsZW1lbnRzOmt1YmVtcS5SZXF1ZXN0KQ0KICAgICAgUmVxdWVzdE9yQnVpbGRlciB7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGxvbmcgc2VyaWFsVmVyc2lvblVJRCA9IDBMOw0KICAgIC8vIFVzZSBSZXF1ZXN0Lm5ld0J1aWxkZXIoKSB0byBjb25zdHJ1Y3QuDQogICAgcHJpdmF0ZSBSZXF1ZXN0KGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8Pz4gYnVpbGRlcikgew0KICAgICAgc3VwZXIoYnVpbGRlcik7DQogICAgfQ0KICAgIHByaXZhdGUgUmVxdWVzdCgpIHsNCiAgICAgIHJlcXVlc3RJRF8gPSAiIjsNCiAgICAgIHJlcXVlc3RUeXBlRGF0YV8gPSAwOw0KICAgICAgY2xpZW50SURfID0gIiI7DQogICAgICBjaGFubmVsXyA9ICIiOw0KICAgICAgbWV0YWRhdGFfID0gIiI7DQogICAgICBib2R5XyA9IGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5FTVBUWTsNCiAgICAgIHJlcGx5Q2hhbm5lbF8gPSAiIjsNCiAgICAgIHRpbWVvdXRfID0gMDsNCiAgICAgIGNhY2hlS2V5XyA9ICIiOw0KICAgICAgY2FjaGVUVExfID0gMDsNCiAgICAgIHNwYW5fID0gY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLkVNUFRZOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQNCiAgICBnZXRVbmtub3duRmllbGRzKCkgew0KICAgICAgcmV0dXJuIHRoaXMudW5rbm93bkZpZWxkczsNCiAgICB9DQogICAgcHJpdmF0ZSBSZXF1ZXN0KA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgdGhpcygpOw0KICAgICAgaWYgKGV4dGVuc2lvblJlZ2lzdHJ5ID09IG51bGwpIHsNCiAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgfQ0KICAgICAgaW50IG11dGFibGVfYml0RmllbGQwXyA9IDA7DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldC5CdWlsZGVyIHVua25vd25GaWVsZHMgPQ0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0Lm5ld0J1aWxkZXIoKTsNCiAgICAgIHRyeSB7DQogICAgICAgIGJvb2xlYW4gZG9uZSA9IGZhbHNlOw0KICAgICAgICB3aGlsZSAoIWRvbmUpIHsNCiAgICAgICAgICBpbnQgdGFnID0gaW5wdXQucmVhZFRhZygpOw0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7DQogICAgICAgICAgICBjYXNlIDA6DQogICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGRlZmF1bHQ6IHsNCiAgICAgICAgICAgICAgaWYgKCFwYXJzZVVua25vd25GaWVsZFByb3RvMygNCiAgICAgICAgICAgICAgICAgIGlucHV0LCB1bmtub3duRmllbGRzLCBleHRlbnNpb25SZWdpc3RyeSwgdGFnKSkgew0KICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAxMDogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICByZXF1ZXN0SURfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDE2OiB7DQogICAgICAgICAgICAgIGludCByYXdWYWx1ZSA9IGlucHV0LnJlYWRFbnVtKCk7DQoNCiAgICAgICAgICAgICAgcmVxdWVzdFR5cGVEYXRhXyA9IHJhd1ZhbHVlOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMjY6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgY2xpZW50SURfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDM0OiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIGNoYW5uZWxfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDQyOiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIG1ldGFkYXRhXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSA1MDogew0KDQogICAgICAgICAgICAgIGJvZHlfID0gaW5wdXQucmVhZEJ5dGVzKCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSA1ODogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICByZXBseUNoYW5uZWxfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDY0OiB7DQoNCiAgICAgICAgICAgICAgdGltZW91dF8gPSBpbnB1dC5yZWFkSW50MzIoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDc0OiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIGNhY2hlS2V5XyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSA4MDogew0KDQogICAgICAgICAgICAgIGNhY2hlVFRMXyA9IGlucHV0LnJlYWRJbnQzMigpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgOTA6IHsNCg0KICAgICAgICAgICAgICBzcGFuXyA9IGlucHV0LnJlYWRCeXRlcygpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgOTg6IHsNCiAgICAgICAgICAgICAgaWYgKCEoKG11dGFibGVfYml0RmllbGQwXyAmIDB4MDAwMDA4MDApID09IDB4MDAwMDA4MDApKSB7DQogICAgICAgICAgICAgICAgdGFnc18gPSBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkLm5ld01hcEZpZWxkKA0KICAgICAgICAgICAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeSk7DQogICAgICAgICAgICAgICAgbXV0YWJsZV9iaXRGaWVsZDBfIHw9IDB4MDAwMDA4MDA7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBFbnRyeTxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgICAgICAgICAgICB0YWdzX18gPSBpbnB1dC5yZWFkTWVzc2FnZSgNCiAgICAgICAgICAgICAgICAgIFRhZ3NEZWZhdWx0RW50cnlIb2xkZXIuZGVmYXVsdEVudHJ5LmdldFBhcnNlckZvclR5cGUoKSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgICAgICAgICB0YWdzXy5nZXRNdXRhYmxlTWFwKCkucHV0KA0KICAgICAgICAgICAgICAgICAgdGFnc19fLmdldEtleSgpLCB0YWdzX18uZ2V0VmFsdWUoKSk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBlLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBjYXRjaCAoamF2YS5pby5JT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbigNCiAgICAgICAgICAgIGUpLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgdGhpcy51bmtub3duRmllbGRzID0gdW5rbm93bkZpZWxkcy5idWlsZCgpOw0KICAgICAgICBtYWtlRXh0ZW5zaW9uc0ltbXV0YWJsZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXF1ZXN0X2Rlc2NyaXB0b3I7DQogICAgfQ0KDQogICAgQFN1cHByZXNzV2FybmluZ3MoeyJyYXd0eXBlcyJ9KQ0KICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkIGludGVybmFsR2V0TWFwRmllbGQoDQogICAgICAgIGludCBudW1iZXIpIHsNCiAgICAgIHN3aXRjaCAobnVtYmVyKSB7DQogICAgICAgIGNhc2UgMTI6DQogICAgICAgICAgcmV0dXJuIGludGVybmFsR2V0VGFncygpOw0KICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXhjZXB0aW9uKA0KICAgICAgICAgICAgICAiSW52YWxpZCBtYXAgZmllbGQgbnVtYmVyOiAiICsgbnVtYmVyKTsNCiAgICAgIH0NCiAgICB9DQogICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUmVxdWVzdF9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0LmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QuQnVpbGRlci5jbGFzcyk7DQogICAgfQ0KDQogICAgLyoqDQogICAgICogUHJvdG9idWYgZW51bSB7QGNvZGUga3ViZW1xLlJlcXVlc3QuUmVxdWVzdFR5cGV9DQogICAgICovDQogICAgcHVibGljIGVudW0gUmVxdWVzdFR5cGUNCiAgICAgICAgaW1wbGVtZW50cyBjb20uZ29vZ2xlLnByb3RvYnVmLlByb3RvY29sTWVzc2FnZUVudW0gew0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5SZXF1ZXN0VHlwZVVua25vd24gPSAwOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgUmVxdWVzdFR5cGVVbmtub3duKDApLA0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5Db21tYW5kID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIENvbW1hbmQoMSksDQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPlF1ZXJ5ID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIFF1ZXJ5KDIpLA0KICAgICAgVU5SRUNPR05JWkVEKC0xKSwNCiAgICAgIDsNCg0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5SZXF1ZXN0VHlwZVVua25vd24gPSAwOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUmVxdWVzdFR5cGVVbmtub3duX1ZBTFVFID0gMDsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Q29tbWFuZCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDb21tYW5kX1ZBTFVFID0gMTsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+UXVlcnkgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUXVlcnlfVkFMVUUgPSAyOw0KDQoNCiAgICAgIHB1YmxpYyBmaW5hbCBpbnQgZ2V0TnVtYmVyKCkgew0KICAgICAgICBpZiAodGhpcyA9PSBVTlJFQ09HTklaRUQpIHsNCiAgICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLklsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbigNCiAgICAgICAgICAgICAgIkNhbid0IGdldCB0aGUgbnVtYmVyIG9mIGFuIHVua25vd24gZW51bSB2YWx1ZS4iKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdmFsdWU7DQogICAgICB9DQoNCiAgICAgIC8qKg0KICAgICAgICogQGRlcHJlY2F0ZWQgVXNlIHtAbGluayAjZm9yTnVtYmVyKGludCl9IGluc3RlYWQuDQogICAgICAgKi8NCiAgICAgIEBqYXZhLmxhbmcuRGVwcmVjYXRlZA0KICAgICAgcHVibGljIHN0YXRpYyBSZXF1ZXN0VHlwZSB2YWx1ZU9mKGludCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gZm9yTnVtYmVyKHZhbHVlKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIHN0YXRpYyBSZXF1ZXN0VHlwZSBmb3JOdW1iZXIoaW50IHZhbHVlKSB7DQogICAgICAgIHN3aXRjaCAodmFsdWUpIHsNCiAgICAgICAgICBjYXNlIDA6IHJldHVybiBSZXF1ZXN0VHlwZVVua25vd247DQogICAgICAgICAgY2FzZSAxOiByZXR1cm4gQ29tbWFuZDsNCiAgICAgICAgICBjYXNlIDI6IHJldHVybiBRdWVyeTsNCiAgICAgICAgICBkZWZhdWx0OiByZXR1cm4gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgc3RhdGljIGNvbS5nb29nbGUucHJvdG9idWYuSW50ZXJuYWwuRW51bUxpdGVNYXA8UmVxdWVzdFR5cGU+DQogICAgICAgICAgaW50ZXJuYWxHZXRWYWx1ZU1hcCgpIHsNCiAgICAgICAgcmV0dXJuIGludGVybmFsVmFsdWVNYXA7DQogICAgICB9DQogICAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkludGVybmFsLkVudW1MaXRlTWFwPA0KICAgICAgICAgIFJlcXVlc3RUeXBlPiBpbnRlcm5hbFZhbHVlTWFwID0NCiAgICAgICAgICAgIG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludGVybmFsLkVudW1MaXRlTWFwPFJlcXVlc3RUeXBlPigpIHsNCiAgICAgICAgICAgICAgcHVibGljIFJlcXVlc3RUeXBlIGZpbmRWYWx1ZUJ5TnVtYmVyKGludCBudW1iZXIpIHsNCiAgICAgICAgICAgICAgICByZXR1cm4gUmVxdWVzdFR5cGUuZm9yTnVtYmVyKG51bWJlcik7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgIH07DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkVudW1WYWx1ZURlc2NyaXB0b3INCiAgICAgICAgICBnZXRWYWx1ZURlc2NyaXB0b3IoKSB7DQogICAgICAgIHJldHVybiBnZXREZXNjcmlwdG9yKCkuZ2V0VmFsdWVzKCkuZ2V0KG9yZGluYWwoKSk7DQogICAgICB9DQogICAgICBwdWJsaWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5FbnVtRGVzY3JpcHRvcg0KICAgICAgICAgIGdldERlc2NyaXB0b3JGb3JUeXBlKCkgew0KICAgICAgICByZXR1cm4gZ2V0RGVzY3JpcHRvcigpOw0KICAgICAgfQ0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkVudW1EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvcigpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdC5nZXREZXNjcmlwdG9yKCkuZ2V0RW51bVR5cGVzKCkuZ2V0KDApOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBSZXF1ZXN0VHlwZVtdIFZBTFVFUyA9IHZhbHVlcygpOw0KDQogICAgICBwdWJsaWMgc3RhdGljIFJlcXVlc3RUeXBlIHZhbHVlT2YoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5FbnVtVmFsdWVEZXNjcmlwdG9yIGRlc2MpIHsNCiAgICAgICAgaWYgKGRlc2MuZ2V0VHlwZSgpICE9IGdldERlc2NyaXB0b3IoKSkgew0KICAgICAgICAgIHRocm93IG5ldyBqYXZhLmxhbmcuSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKA0KICAgICAgICAgICAgIkVudW1WYWx1ZURlc2NyaXB0b3IgaXMgbm90IGZvciB0aGlzIHR5cGUuIik7DQogICAgICAgIH0NCiAgICAgICAgaWYgKGRlc2MuZ2V0SW5kZXgoKSA9PSAtMSkgew0KICAgICAgICAgIHJldHVybiBVTlJFQ09HTklaRUQ7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIFZBTFVFU1tkZXNjLmdldEluZGV4KCldOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGZpbmFsIGludCB2YWx1ZTsNCg0KICAgICAgcHJpdmF0ZSBSZXF1ZXN0VHlwZShpbnQgdmFsdWUpIHsNCiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOw0KICAgICAgfQ0KDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoZW51bV9zY29wZTprdWJlbXEuUmVxdWVzdC5SZXF1ZXN0VHlwZSkNCiAgICB9DQoNCiAgICBwcml2YXRlIGludCBiaXRGaWVsZDBfOw0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFJFUVVFU1RJRF9GSUVMRF9OVU1CRVIgPSAxOw0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCByZXF1ZXN0SURfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRSZXF1ZXN0SUQoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHJlcXVlc3RJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgcmVxdWVzdElEXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRSZXF1ZXN0SURCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVxdWVzdElEXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICByZXF1ZXN0SURfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFJFUVVFU1RUWVBFREFUQV9GSUVMRF9OVU1CRVIgPSAyOw0KICAgIHByaXZhdGUgaW50IHJlcXVlc3RUeXBlRGF0YV87DQogICAgLyoqDQogICAgICogPGNvZGU+Lmt1YmVtcS5SZXF1ZXN0LlJlcXVlc3RUeXBlIFJlcXVlc3RUeXBlRGF0YSA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpbnQgZ2V0UmVxdWVzdFR5cGVEYXRhVmFsdWUoKSB7DQogICAgICByZXR1cm4gcmVxdWVzdFR5cGVEYXRhXzsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+Lmt1YmVtcS5SZXF1ZXN0LlJlcXVlc3RUeXBlIFJlcXVlc3RUeXBlRGF0YSA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QuUmVxdWVzdFR5cGUgZ2V0UmVxdWVzdFR5cGVEYXRhKCkgew0KICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0LlJlcXVlc3RUeXBlIHJlc3VsdCA9IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdC5SZXF1ZXN0VHlwZS52YWx1ZU9mKHJlcXVlc3RUeXBlRGF0YV8pOw0KICAgICAgcmV0dXJuIHJlc3VsdCA9PSBudWxsID8gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0LlJlcXVlc3RUeXBlLlVOUkVDT0dOSVpFRCA6IHJlc3VsdDsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDTElFTlRJRF9GSUVMRF9OVU1CRVIgPSAzOw0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBjbGllbnRJRF87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMzs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2xpZW50SUQoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNsaWVudElEXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBjbGllbnRJRF8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMzs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRDbGllbnRJREJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjbGllbnRJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgY2xpZW50SURfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENIQU5ORUxfRklFTERfTlVNQkVSID0gNDsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgY2hhbm5lbF87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDaGFubmVsKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBjaGFubmVsXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0Q2hhbm5lbEJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICBjaGFubmVsXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNRVRBREFUQV9GSUVMRF9OVU1CRVIgPSA1Ow0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBtZXRhZGF0YV87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0TWV0YWRhdGEoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1ldGFkYXRhXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBtZXRhZGF0YV8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRNZXRhZGF0YUJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBtZXRhZGF0YV87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgbWV0YWRhdGFfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEJPRFlfRklFTERfTlVNQkVSID0gNjsNCiAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBib2R5XzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5ieXRlcyBCb2R5ID0gNjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBnZXRCb2R5KCkgew0KICAgICAgcmV0dXJuIGJvZHlfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFJFUExZQ0hBTk5FTF9GSUVMRF9OVU1CRVIgPSA3Ow0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCByZXBseUNoYW5uZWxfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBSZXBseUNoYW5uZWwgPSA3OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRSZXBseUNoYW5uZWwoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHJlcGx5Q2hhbm5lbF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgcmVwbHlDaGFubmVsXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVwbHlDaGFubmVsID0gNzs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRSZXBseUNoYW5uZWxCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVwbHlDaGFubmVsXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICByZXBseUNoYW5uZWxfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFRJTUVPVVRfRklFTERfTlVNQkVSID0gODsNCiAgICBwcml2YXRlIGludCB0aW1lb3V0XzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQzMiBUaW1lb3V0ID0gODs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGludCBnZXRUaW1lb3V0KCkgew0KICAgICAgcmV0dXJuIHRpbWVvdXRfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENBQ0hFS0VZX0ZJRUxEX05VTUJFUiA9IDk7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IGNhY2hlS2V5XzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2FjaGVLZXkgPSA5OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDYWNoZUtleSgpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2FjaGVLZXlfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIGNhY2hlS2V5XyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2FjaGVLZXkgPSA5OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldENhY2hlS2V5Qnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNhY2hlS2V5XzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICBjYWNoZUtleV8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQ0FDSEVUVExfRklFTERfTlVNQkVSID0gMTA7DQogICAgcHJpdmF0ZSBpbnQgY2FjaGVUVExfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDMyIENhY2hlVFRMID0gMTA7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpbnQgZ2V0Q2FjaGVUVEwoKSB7DQogICAgICByZXR1cm4gY2FjaGVUVExfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNQQU5fRklFTERfTlVNQkVSID0gMTE7DQogICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgc3Bhbl87DQogICAgLyoqDQogICAgICogPGNvZGU+Ynl0ZXMgU3BhbiA9IDExOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGdldFNwYW4oKSB7DQogICAgICByZXR1cm4gc3Bhbl87DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgVEFHU19GSUVMRF9OVU1CRVIgPSAxMjsNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjbGFzcyBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyIHsNCiAgICAgIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEVudHJ5PA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IGRlZmF1bHRFbnRyeSA9DQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRW50cnkNCiAgICAgICAgICAgICAgLjxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPm5ld0RlZmF1bHRJbnN0YW5jZSgNCiAgICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXF1ZXN0X1RhZ3NFbnRyeV9kZXNjcmlwdG9yLCANCiAgICAgICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuV2lyZUZvcm1hdC5GaWVsZFR5cGUuU1RSSU5HLA0KICAgICAgICAgICAgICAgICAgIiIsDQogICAgICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLldpcmVGb3JtYXQuRmllbGRUeXBlLlNUUklORywNCiAgICAgICAgICAgICAgICAgICIiKTsNCiAgICB9DQogICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkPA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiB0YWdzXzsNCiAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQ8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4NCiAgICBpbnRlcm5hbEdldFRhZ3MoKSB7DQogICAgICBpZiAodGFnc18gPT0gbnVsbCkgew0KICAgICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZC5lbXB0eU1hcEZpZWxkKA0KICAgICAgICAgICAgVGFnc0RlZmF1bHRFbnRyeUhvbGRlci5kZWZhdWx0RW50cnkpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIHRhZ3NfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBpbnQgZ2V0VGFnc0NvdW50KCkgew0KICAgICAgcmV0dXJuIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpLnNpemUoKTsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gMTI7PC9jb2RlPg0KICAgICAqLw0KDQogICAgcHVibGljIGJvb2xlYW4gY29udGFpbnNUYWdzKA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSkgew0KICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgcmV0dXJuIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpLmNvbnRhaW5zS2V5KGtleSk7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIFVzZSB7QGxpbmsgI2dldFRhZ3NNYXAoKX0gaW5zdGVhZC4NCiAgICAgKi8NCiAgICBAamF2YS5sYW5nLkRlcHJlY2F0ZWQNCiAgICBwdWJsaWMgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBnZXRUYWdzKCkgew0KICAgICAgcmV0dXJuIGdldFRhZ3NNYXAoKTsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gMTI7PC9jb2RlPg0KICAgICAqLw0KDQogICAgcHVibGljIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gZ2V0VGFnc01hcCgpIHsNCiAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gMTI7PC9jb2RlPg0KICAgICAqLw0KDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0VGFnc09yRGVmYXVsdCgNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXksDQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgZGVmYXVsdFZhbHVlKSB7DQogICAgICBpZiAoa2V5ID09IG51bGwpIHsgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOyB9DQogICAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IG1hcCA9DQogICAgICAgICAgaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCk7DQogICAgICByZXR1cm4gbWFwLmNvbnRhaW5zS2V5KGtleSkgPyBtYXAuZ2V0KGtleSkgOiBkZWZhdWx0VmFsdWU7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDEyOzwvY29kZT4NCiAgICAgKi8NCg0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFRhZ3NPclRocm93KA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSkgew0KICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBtYXAgPQ0KICAgICAgICAgIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpOw0KICAgICAgaWYgKCFtYXAuY29udGFpbnNLZXkoa2V5KSkgew0KICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLklsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbigpOw0KICAgICAgfQ0KICAgICAgcmV0dXJuIG1hcC5nZXQoa2V5KTsNCiAgICB9DQoNCiAgICBwcml2YXRlIGJ5dGUgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gLTE7DQogICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgIGJ5dGUgaXNJbml0aWFsaXplZCA9IG1lbW9pemVkSXNJbml0aWFsaXplZDsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDEpIHJldHVybiB0cnVlOw0KICAgICAgaWYgKGlzSW5pdGlhbGl6ZWQgPT0gMCkgcmV0dXJuIGZhbHNlOw0KDQogICAgICBtZW1vaXplZElzSW5pdGlhbGl6ZWQgPSAxOw0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KDQogICAgcHVibGljIHZvaWQgd3JpdGVUbyhjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtIG91dHB1dCkNCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIGlmICghZ2V0UmVxdWVzdElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAxLCByZXF1ZXN0SURfKTsNCiAgICAgIH0NCiAgICAgIGlmIChyZXF1ZXN0VHlwZURhdGFfICE9IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdC5SZXF1ZXN0VHlwZS5SZXF1ZXN0VHlwZVVua25vd24uZ2V0TnVtYmVyKCkpIHsNCiAgICAgICAgb3V0cHV0LndyaXRlRW51bSgyLCByZXF1ZXN0VHlwZURhdGFfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0Q2xpZW50SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDMsIGNsaWVudElEXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldENoYW5uZWxCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDQsIGNoYW5uZWxfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0TWV0YWRhdGFCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDUsIG1ldGFkYXRhXyk7DQogICAgICB9DQogICAgICBpZiAoIWJvZHlfLmlzRW1wdHkoKSkgew0KICAgICAgICBvdXRwdXQud3JpdGVCeXRlcyg2LCBib2R5Xyk7DQogICAgICB9DQogICAgICBpZiAoIWdldFJlcGx5Q2hhbm5lbEJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLndyaXRlU3RyaW5nKG91dHB1dCwgNywgcmVwbHlDaGFubmVsXyk7DQogICAgICB9DQogICAgICBpZiAodGltZW91dF8gIT0gMCkgew0KICAgICAgICBvdXRwdXQud3JpdGVJbnQzMig4LCB0aW1lb3V0Xyk7DQogICAgICB9DQogICAgICBpZiAoIWdldENhY2hlS2V5Qnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCA5LCBjYWNoZUtleV8pOw0KICAgICAgfQ0KICAgICAgaWYgKGNhY2hlVFRMXyAhPSAwKSB7DQogICAgICAgIG91dHB1dC53cml0ZUludDMyKDEwLCBjYWNoZVRUTF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFzcGFuXy5pc0VtcHR5KCkpIHsNCiAgICAgICAgb3V0cHV0LndyaXRlQnl0ZXMoMTEsIHNwYW5fKTsNCiAgICAgIH0NCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgIC5zZXJpYWxpemVTdHJpbmdNYXBUbygNCiAgICAgICAgICBvdXRwdXQsDQogICAgICAgICAgaW50ZXJuYWxHZXRUYWdzKCksDQogICAgICAgICAgVGFnc0RlZmF1bHRFbnRyeUhvbGRlci5kZWZhdWx0RW50cnksDQogICAgICAgICAgMTIpOw0KICAgICAgdW5rbm93bkZpZWxkcy53cml0ZVRvKG91dHB1dCk7DQogICAgfQ0KDQogICAgcHVibGljIGludCBnZXRTZXJpYWxpemVkU2l6ZSgpIHsNCiAgICAgIGludCBzaXplID0gbWVtb2l6ZWRTaXplOw0KICAgICAgaWYgKHNpemUgIT0gLTEpIHJldHVybiBzaXplOw0KDQogICAgICBzaXplID0gMDsNCiAgICAgIGlmICghZ2V0UmVxdWVzdElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSgxLCByZXF1ZXN0SURfKTsNCiAgICAgIH0NCiAgICAgIGlmIChyZXF1ZXN0VHlwZURhdGFfICE9IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdC5SZXF1ZXN0VHlwZS5SZXF1ZXN0VHlwZVVua25vd24uZ2V0TnVtYmVyKCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVFbnVtU2l6ZSgyLCByZXF1ZXN0VHlwZURhdGFfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0Q2xpZW50SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDMsIGNsaWVudElEXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldENoYW5uZWxCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDQsIGNoYW5uZWxfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0TWV0YWRhdGFCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDUsIG1ldGFkYXRhXyk7DQogICAgICB9DQogICAgICBpZiAoIWJvZHlfLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUJ5dGVzU2l6ZSg2LCBib2R5Xyk7DQogICAgICB9DQogICAgICBpZiAoIWdldFJlcGx5Q2hhbm5lbEJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoNywgcmVwbHlDaGFubmVsXyk7DQogICAgICB9DQogICAgICBpZiAodGltZW91dF8gIT0gMCkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUludDMyU2l6ZSg4LCB0aW1lb3V0Xyk7DQogICAgICB9DQogICAgICBpZiAoIWdldENhY2hlS2V5Qnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSg5LCBjYWNoZUtleV8pOw0KICAgICAgfQ0KICAgICAgaWYgKGNhY2hlVFRMXyAhPSAwKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlSW50MzJTaXplKDEwLCBjYWNoZVRUTF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFzcGFuXy5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVCeXRlc1NpemUoMTEsIHNwYW5fKTsNCiAgICAgIH0NCiAgICAgIGZvciAoamF2YS51dGlsLk1hcC5FbnRyeTxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBlbnRyeQ0KICAgICAgICAgICA6IGludGVybmFsR2V0VGFncygpLmdldE1hcCgpLmVudHJ5U2V0KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBFbnRyeTxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgICAgICB0YWdzX18gPSBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeS5uZXdCdWlsZGVyRm9yVHlwZSgpDQogICAgICAgICAgICAuc2V0S2V5KGVudHJ5LmdldEtleSgpKQ0KICAgICAgICAgICAgLnNldFZhbHVlKGVudHJ5LmdldFZhbHVlKCkpDQogICAgICAgICAgICAuYnVpbGQoKTsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgICAuY29tcHV0ZU1lc3NhZ2VTaXplKDEyLCB0YWdzX18pOw0KICAgICAgfQ0KICAgICAgc2l6ZSArPSB1bmtub3duRmllbGRzLmdldFNlcmlhbGl6ZWRTaXplKCk7DQogICAgICBtZW1vaXplZFNpemUgPSBzaXplOw0KICAgICAgcmV0dXJuIHNpemU7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBib29sZWFuIGVxdWFscyhmaW5hbCBqYXZhLmxhbmcuT2JqZWN0IG9iaikgew0KICAgICAgaWYgKG9iaiA9PSB0aGlzKSB7DQogICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgICBpZiAoIShvYmogaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QpKSB7DQogICAgICAgIHJldHVybiBzdXBlci5lcXVhbHMob2JqKTsNCiAgICAgIH0NCiAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdCBvdGhlciA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QpIG9iajsNCg0KICAgICAgYm9vbGVhbiByZXN1bHQgPSB0cnVlOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldFJlcXVlc3RJRCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRSZXF1ZXN0SUQoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgcmVxdWVzdFR5cGVEYXRhXyA9PSBvdGhlci5yZXF1ZXN0VHlwZURhdGFfOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldENsaWVudElEKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldENsaWVudElEKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldENoYW5uZWwoKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0Q2hhbm5lbCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRNZXRhZGF0YSgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRNZXRhZGF0YSgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRCb2R5KCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldEJvZHkoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0UmVwbHlDaGFubmVsKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldFJlcGx5Q2hhbm5lbCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiAoZ2V0VGltZW91dCgpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0VGltZW91dCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRDYWNoZUtleSgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRDYWNoZUtleSgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiAoZ2V0Q2FjaGVUVEwoKQ0KICAgICAgICAgID09IG90aGVyLmdldENhY2hlVFRMKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldFNwYW4oKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0U3BhbigpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBpbnRlcm5hbEdldFRhZ3MoKS5lcXVhbHMoDQogICAgICAgICAgb3RoZXIuaW50ZXJuYWxHZXRUYWdzKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIHVua25vd25GaWVsZHMuZXF1YWxzKG90aGVyLnVua25vd25GaWVsZHMpOw0KICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGludCBoYXNoQ29kZSgpIHsNCiAgICAgIGlmIChtZW1vaXplZEhhc2hDb2RlICE9IDApIHsNCiAgICAgICAgcmV0dXJuIG1lbW9pemVkSGFzaENvZGU7DQogICAgICB9DQogICAgICBpbnQgaGFzaCA9IDQxOw0KICAgICAgaGFzaCA9ICgxOSAqIGhhc2gpICsgZ2V0RGVzY3JpcHRvcigpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBSRVFVRVNUSURfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0UmVxdWVzdElEKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFJFUVVFU1RUWVBFREFUQV9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyByZXF1ZXN0VHlwZURhdGFfOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgQ0xJRU5USURfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0Q2xpZW50SUQoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgQ0hBTk5FTF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRDaGFubmVsKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIE1FVEFEQVRBX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldE1ldGFkYXRhKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIEJPRFlfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0Qm9keSgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBSRVBMWUNIQU5ORUxfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0UmVwbHlDaGFubmVsKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFRJTUVPVVRfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0VGltZW91dCgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgQ0FDSEVLRVlfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0Q2FjaGVLZXkoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgQ0FDSEVUVExfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0Q2FjaGVUVEwoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFNQQU5fRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0U3BhbigpLmhhc2hDb2RlKCk7DQogICAgICBpZiAoIWludGVybmFsR2V0VGFncygpLmdldE1hcCgpLmlzRW1wdHkoKSkgew0KICAgICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBUQUdTX0ZJRUxEX05VTUJFUjsNCiAgICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgaW50ZXJuYWxHZXRUYWdzKCkuaGFzaENvZGUoKTsNCiAgICAgIH0NCiAgICAgIGhhc2ggPSAoMjkgKiBoYXNoKSArIHVua25vd25GaWVsZHMuaGFzaENvZGUoKTsNCiAgICAgIG1lbW9pemVkSGFzaENvZGUgPSBoYXNoOw0KICAgICAgcmV0dXJuIGhhc2g7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdCBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdCBwYXJzZUZyb20oYnl0ZVtdIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBieXRlW10gZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0IHBhcnNlRnJvbShqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0IHBhcnNlRGVsaW1pdGVkRnJvbShqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VEZWxpbWl0ZWRXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0IHBhcnNlRGVsaW1pdGVkRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZURlbGltaXRlZFdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgQnVpbGRlciBuZXdCdWlsZGVyRm9yVHlwZSgpIHsgcmV0dXJuIG5ld0J1aWxkZXIoKTsgfQ0KICAgIHB1YmxpYyBzdGF0aWMgQnVpbGRlciBuZXdCdWlsZGVyKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgQnVpbGRlciBuZXdCdWlsZGVyKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdCBwcm90b3R5cGUpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFLnRvQnVpbGRlcigpLm1lcmdlRnJvbShwcm90b3R5cGUpOw0KICAgIH0NCiAgICBwdWJsaWMgQnVpbGRlciB0b0J1aWxkZXIoKSB7DQogICAgICByZXR1cm4gdGhpcyA9PSBERUZBVUxUX0lOU1RBTkNFDQogICAgICAgICAgPyBuZXcgQnVpbGRlcigpIDogbmV3IEJ1aWxkZXIoKS5tZXJnZUZyb20odGhpcyk7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHByb3RlY3RlZCBCdWlsZGVyIG5ld0J1aWxkZXJGb3JUeXBlKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgQnVpbGRlciBidWlsZGVyID0gbmV3IEJ1aWxkZXIocGFyZW50KTsNCiAgICAgIHJldHVybiBidWlsZGVyOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuUmVxdWVzdH0NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNsYXNzIEJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPEJ1aWxkZXI+IGltcGxlbWVudHMNCiAgICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfaW1wbGVtZW50czprdWJlbXEuUmVxdWVzdCkNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0T3JCdWlsZGVyIHsNCiAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvcigpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXF1ZXN0X2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIEBTdXBwcmVzc1dhcm5pbmdzKHsicmF3dHlwZXMifSkNCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkIGludGVybmFsR2V0TWFwRmllbGQoDQogICAgICAgICAgaW50IG51bWJlcikgew0KICAgICAgICBzd2l0Y2ggKG51bWJlcikgew0KICAgICAgICAgIGNhc2UgMTI6DQogICAgICAgICAgICByZXR1cm4gaW50ZXJuYWxHZXRUYWdzKCk7DQogICAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXhjZXB0aW9uKA0KICAgICAgICAgICAgICAgICJJbnZhbGlkIG1hcCBmaWVsZCBudW1iZXI6ICIgKyBudW1iZXIpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICBAU3VwcHJlc3NXYXJuaW5ncyh7InJhd3R5cGVzIn0pDQogICAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZCBpbnRlcm5hbEdldE11dGFibGVNYXBGaWVsZCgNCiAgICAgICAgICBpbnQgbnVtYmVyKSB7DQogICAgICAgIHN3aXRjaCAobnVtYmVyKSB7DQogICAgICAgICAgY2FzZSAxMjoNCiAgICAgICAgICAgIHJldHVybiBpbnRlcm5hbEdldE11dGFibGVUYWdzKCk7DQogICAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXhjZXB0aW9uKA0KICAgICAgICAgICAgICAgICJJbnZhbGlkIG1hcCBmaWVsZCBudW1iZXI6ICIgKyBudW1iZXIpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgaW50ZXJuYWxHZXRGaWVsZEFjY2Vzc29yVGFibGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUmVxdWVzdF9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAgIC5lbnN1cmVGaWVsZEFjY2Vzc29yc0luaXRpYWxpemVkKA0KICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdC5jbGFzcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0LkJ1aWxkZXIuY2xhc3MpOw0KICAgICAgfQ0KDQogICAgICAvLyBDb25zdHJ1Y3QgdXNpbmcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0Lm5ld0J1aWxkZXIoKQ0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKCkgew0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgQnVpbGRlcigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgICBzdXBlcihwYXJlbnQpOw0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQogICAgICBwcml2YXRlIHZvaWQgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpIHsNCiAgICAgICAgaWYgKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgICAgICAgLmFsd2F5c1VzZUZpZWxkQnVpbGRlcnMpIHsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXIoKSB7DQogICAgICAgIHN1cGVyLmNsZWFyKCk7DQogICAgICAgIHJlcXVlc3RJRF8gPSAiIjsNCg0KICAgICAgICByZXF1ZXN0VHlwZURhdGFfID0gMDsNCg0KICAgICAgICBjbGllbnRJRF8gPSAiIjsNCg0KICAgICAgICBjaGFubmVsXyA9ICIiOw0KDQogICAgICAgIG1ldGFkYXRhXyA9ICIiOw0KDQogICAgICAgIGJvZHlfID0gY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLkVNUFRZOw0KDQogICAgICAgIHJlcGx5Q2hhbm5lbF8gPSAiIjsNCg0KICAgICAgICB0aW1lb3V0XyA9IDA7DQoNCiAgICAgICAgY2FjaGVLZXlfID0gIiI7DQoNCiAgICAgICAgY2FjaGVUVExfID0gMDsNCg0KICAgICAgICBzcGFuXyA9IGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5FTVBUWTsNCg0KICAgICAgICBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkuY2xlYXIoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXF1ZXN0X2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdC5nZXREZWZhdWx0SW5zdGFuY2UoKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdCBidWlsZCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0IHJlc3VsdCA9IGJ1aWxkUGFydGlhbCgpOw0KICAgICAgICBpZiAoIXJlc3VsdC5pc0luaXRpYWxpemVkKCkpIHsNCiAgICAgICAgICB0aHJvdyBuZXdVbmluaXRpYWxpemVkTWVzc2FnZUV4Y2VwdGlvbihyZXN1bHQpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiByZXN1bHQ7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QgYnVpbGRQYXJ0aWFsKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QgcmVzdWx0ID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdCh0aGlzKTsNCiAgICAgICAgaW50IGZyb21fYml0RmllbGQwXyA9IGJpdEZpZWxkMF87DQogICAgICAgIGludCB0b19iaXRGaWVsZDBfID0gMDsNCiAgICAgICAgcmVzdWx0LnJlcXVlc3RJRF8gPSByZXF1ZXN0SURfOw0KICAgICAgICByZXN1bHQucmVxdWVzdFR5cGVEYXRhXyA9IHJlcXVlc3RUeXBlRGF0YV87DQogICAgICAgIHJlc3VsdC5jbGllbnRJRF8gPSBjbGllbnRJRF87DQogICAgICAgIHJlc3VsdC5jaGFubmVsXyA9IGNoYW5uZWxfOw0KICAgICAgICByZXN1bHQubWV0YWRhdGFfID0gbWV0YWRhdGFfOw0KICAgICAgICByZXN1bHQuYm9keV8gPSBib2R5XzsNCiAgICAgICAgcmVzdWx0LnJlcGx5Q2hhbm5lbF8gPSByZXBseUNoYW5uZWxfOw0KICAgICAgICByZXN1bHQudGltZW91dF8gPSB0aW1lb3V0XzsNCiAgICAgICAgcmVzdWx0LmNhY2hlS2V5XyA9IGNhY2hlS2V5XzsNCiAgICAgICAgcmVzdWx0LmNhY2hlVFRMXyA9IGNhY2hlVFRMXzsNCiAgICAgICAgcmVzdWx0LnNwYW5fID0gc3Bhbl87DQogICAgICAgIHJlc3VsdC50YWdzXyA9IGludGVybmFsR2V0VGFncygpOw0KICAgICAgICByZXN1bHQudGFnc18ubWFrZUltbXV0YWJsZSgpOw0KICAgICAgICByZXN1bHQuYml0RmllbGQwXyA9IHRvX2JpdEZpZWxkMF87DQogICAgICAgIG9uQnVpbHQoKTsNCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xvbmUoKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xvbmUoKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyRmllbGQoZmllbGQpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJPbmVvZigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLk9uZW9mRGVzY3JpcHRvciBvbmVvZikgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyT25lb2Yob25lb2YpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBpbnQgaW5kZXgsIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRSZXBlYXRlZEZpZWxkKGZpZWxkLCBpbmRleCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgYWRkUmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuYWRkUmVwZWF0ZWRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZSBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QpIHsNCiAgICAgICAgICByZXR1cm4gbWVyZ2VGcm9tKChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3Qpb3RoZXIpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHN1cGVyLm1lcmdlRnJvbShvdGhlcik7DQogICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdCBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgPT0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0LmdldERlZmF1bHRJbnN0YW5jZSgpKSByZXR1cm4gdGhpczsNCiAgICAgICAgaWYgKCFvdGhlci5nZXRSZXF1ZXN0SUQoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICByZXF1ZXN0SURfID0gb3RoZXIucmVxdWVzdElEXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIucmVxdWVzdFR5cGVEYXRhXyAhPSAwKSB7DQogICAgICAgICAgc2V0UmVxdWVzdFR5cGVEYXRhVmFsdWUob3RoZXIuZ2V0UmVxdWVzdFR5cGVEYXRhVmFsdWUoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRDbGllbnRJRCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIGNsaWVudElEXyA9IG90aGVyLmNsaWVudElEXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIW90aGVyLmdldENoYW5uZWwoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICBjaGFubmVsXyA9IG90aGVyLmNoYW5uZWxfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmICghb3RoZXIuZ2V0TWV0YWRhdGEoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICBtZXRhZGF0YV8gPSBvdGhlci5tZXRhZGF0YV87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmdldEJvZHkoKSAhPSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuRU1QVFkpIHsNCiAgICAgICAgICBzZXRCb2R5KG90aGVyLmdldEJvZHkoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRSZXBseUNoYW5uZWwoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICByZXBseUNoYW5uZWxfID0gb3RoZXIucmVwbHlDaGFubmVsXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0VGltZW91dCgpICE9IDApIHsNCiAgICAgICAgICBzZXRUaW1lb3V0KG90aGVyLmdldFRpbWVvdXQoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRDYWNoZUtleSgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIGNhY2hlS2V5XyA9IG90aGVyLmNhY2hlS2V5XzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0Q2FjaGVUVEwoKSAhPSAwKSB7DQogICAgICAgICAgc2V0Q2FjaGVUVEwob3RoZXIuZ2V0Q2FjaGVUVEwoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmdldFNwYW4oKSAhPSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuRU1QVFkpIHsNCiAgICAgICAgICBzZXRTcGFuKG90aGVyLmdldFNwYW4oKSk7DQogICAgICAgIH0NCiAgICAgICAgaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpLm1lcmdlRnJvbSgNCiAgICAgICAgICAgIG90aGVyLmludGVybmFsR2V0VGFncygpKTsNCiAgICAgICAgdGhpcy5tZXJnZVVua25vd25GaWVsZHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbSgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QgcGFyc2VkTWVzc2FnZSA9IG51bGw7DQogICAgICAgIHRyeSB7DQogICAgICAgICAgcGFyc2VkTWVzc2FnZSA9IFBBUlNFUi5wYXJzZVBhcnRpYWxGcm9tKGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICAgIH0gY2F0Y2ggKGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdCkgZS5nZXRVbmZpbmlzaGVkTWVzc2FnZSgpOw0KICAgICAgICAgIHRocm93IGUudW53cmFwSU9FeGNlcHRpb24oKTsNCiAgICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgICBpZiAocGFyc2VkTWVzc2FnZSAhPSBudWxsKSB7DQogICAgICAgICAgICBtZXJnZUZyb20ocGFyc2VkTWVzc2FnZSk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgcHJpdmF0ZSBpbnQgYml0RmllbGQwXzsNCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IHJlcXVlc3RJRF8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRSZXF1ZXN0SUQoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVxdWVzdElEXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgcmVxdWVzdElEXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0UmVxdWVzdElEQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVxdWVzdElEXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICByZXF1ZXN0SURfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UmVxdWVzdElEKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgcmVxdWVzdElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJSZXF1ZXN0SUQoKSB7DQogICAgICAgIA0KICAgICAgICByZXF1ZXN0SURfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0UmVxdWVzdElEKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXF1ZXN0SURCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgcmVxdWVzdElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgaW50IHJlcXVlc3RUeXBlRGF0YV8gPSAwOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlJlcXVlc3QuUmVxdWVzdFR5cGUgUmVxdWVzdFR5cGVEYXRhID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpbnQgZ2V0UmVxdWVzdFR5cGVEYXRhVmFsdWUoKSB7DQogICAgICAgIHJldHVybiByZXF1ZXN0VHlwZURhdGFfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlJlcXVlc3QuUmVxdWVzdFR5cGUgUmVxdWVzdFR5cGVEYXRhID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlcXVlc3RUeXBlRGF0YVZhbHVlKGludCB2YWx1ZSkgew0KICAgICAgICByZXF1ZXN0VHlwZURhdGFfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5SZXF1ZXN0LlJlcXVlc3RUeXBlIFJlcXVlc3RUeXBlRGF0YSA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0LlJlcXVlc3RUeXBlIGdldFJlcXVlc3RUeXBlRGF0YSgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0LlJlcXVlc3RUeXBlIHJlc3VsdCA9IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdC5SZXF1ZXN0VHlwZS52YWx1ZU9mKHJlcXVlc3RUeXBlRGF0YV8pOw0KICAgICAgICByZXR1cm4gcmVzdWx0ID09IG51bGwgPyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QuUmVxdWVzdFR5cGUuVU5SRUNPR05JWkVEIDogcmVzdWx0Ow0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlJlcXVlc3QuUmVxdWVzdFR5cGUgUmVxdWVzdFR5cGVEYXRhID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlcXVlc3RUeXBlRGF0YShpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QuUmVxdWVzdFR5cGUgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICAgICAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgcmVxdWVzdFR5cGVEYXRhXyA9IHZhbHVlLmdldE51bWJlcigpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPi5rdWJlbXEuUmVxdWVzdC5SZXF1ZXN0VHlwZSBSZXF1ZXN0VHlwZURhdGEgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJSZXF1ZXN0VHlwZURhdGEoKSB7DQogICAgICAgIA0KICAgICAgICByZXF1ZXN0VHlwZURhdGFfID0gMDsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgY2xpZW50SURfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDbGllbnRJRCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjbGllbnRJRF87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIGNsaWVudElEXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRDbGllbnRJREJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNsaWVudElEXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBjbGllbnRJRF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldENsaWVudElEKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgY2xpZW50SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyQ2xpZW50SUQoKSB7DQogICAgICAgIA0KICAgICAgICBjbGllbnRJRF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRDbGllbnRJRCgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRDbGllbnRJREJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBjbGllbnRJRF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgY2hhbm5lbF8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2hhbm5lbCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgY2hhbm5lbF8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRDaGFubmVsQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2hhbm5lbF87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgY2hhbm5lbF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2hhbm5lbCgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIGNoYW5uZWxfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJDaGFubmVsKCkgew0KICAgICAgICANCiAgICAgICAgY2hhbm5lbF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRDaGFubmVsKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2hhbm5lbEJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBjaGFubmVsXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCBtZXRhZGF0YV8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldE1ldGFkYXRhKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1ldGFkYXRhXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgbWV0YWRhdGFfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTWV0YWRhdGEgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldE1ldGFkYXRhQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gbWV0YWRhdGFfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIG1ldGFkYXRhXyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTWV0YWRhdGEgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0TWV0YWRhdGEoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBtZXRhZGF0YV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTWV0YWRhdGEgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJNZXRhZGF0YSgpIHsNCiAgICAgICAgDQogICAgICAgIG1ldGFkYXRhXyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldE1ldGFkYXRhKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldE1ldGFkYXRhQnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIG1ldGFkYXRhXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJvZHlfID0gY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLkVNUFRZOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ieXRlcyBCb2R5ID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZ2V0Qm9keSgpIHsNCiAgICAgICAgcmV0dXJuIGJvZHlfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ieXRlcyBCb2R5ID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEJvZHkoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIGJvZHlfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ynl0ZXMgQm9keSA9IDY7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckJvZHkoKSB7DQogICAgICAgIA0KICAgICAgICBib2R5XyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldEJvZHkoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgcmVwbHlDaGFubmVsXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVwbHlDaGFubmVsID0gNzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFJlcGx5Q2hhbm5lbCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXBseUNoYW5uZWxfOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICByZXBseUNoYW5uZWxfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVwbHlDaGFubmVsID0gNzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRSZXBseUNoYW5uZWxCeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXBseUNoYW5uZWxfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIHJlcGx5Q2hhbm5lbF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcGx5Q2hhbm5lbCA9IDc7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXBseUNoYW5uZWwoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICByZXBseUNoYW5uZWxfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcGx5Q2hhbm5lbCA9IDc7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhclJlcGx5Q2hhbm5lbCgpIHsNCiAgICAgICAgDQogICAgICAgIHJlcGx5Q2hhbm5lbF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRSZXBseUNoYW5uZWwoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVwbHlDaGFubmVsID0gNzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlcGx5Q2hhbm5lbEJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICByZXBseUNoYW5uZWxfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBpbnQgdGltZW91dF8gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQzMiBUaW1lb3V0ID0gODs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpbnQgZ2V0VGltZW91dCgpIHsNCiAgICAgICAgcmV0dXJuIHRpbWVvdXRfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQzMiBUaW1lb3V0ID0gODs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFRpbWVvdXQoaW50IHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICB0aW1lb3V0XyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIFRpbWVvdXQgPSA4OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJUaW1lb3V0KCkgew0KICAgICAgICANCiAgICAgICAgdGltZW91dF8gPSAwOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCBjYWNoZUtleV8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENhY2hlS2V5ID0gOTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldENhY2hlS2V5KCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNhY2hlS2V5XzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgY2FjaGVLZXlfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2FjaGVLZXkgPSA5OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldENhY2hlS2V5Qnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2FjaGVLZXlfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIGNhY2hlS2V5XyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2FjaGVLZXkgPSA5OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2FjaGVLZXkoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBjYWNoZUtleV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2FjaGVLZXkgPSA5OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJDYWNoZUtleSgpIHsNCiAgICAgICAgDQogICAgICAgIGNhY2hlS2V5XyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldENhY2hlS2V5KCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENhY2hlS2V5ID0gOTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldENhY2hlS2V5Qnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIGNhY2hlS2V5XyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgaW50IGNhY2hlVFRMXyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIENhY2hlVFRMID0gMTA7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW50IGdldENhY2hlVFRMKCkgew0KICAgICAgICByZXR1cm4gY2FjaGVUVExfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQzMiBDYWNoZVRUTCA9IDEwOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2FjaGVUVEwoaW50IHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICBjYWNoZVRUTF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQzMiBDYWNoZVRUTCA9IDEwOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJDYWNoZVRUTCgpIHsNCiAgICAgICAgDQogICAgICAgIGNhY2hlVFRMXyA9IDA7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgc3Bhbl8gPSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuRU1QVFk7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJ5dGVzIFNwYW4gPSAxMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZ2V0U3BhbigpIHsNCiAgICAgICAgcmV0dXJuIHNwYW5fOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ieXRlcyBTcGFuID0gMTE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRTcGFuKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBzcGFuXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJ5dGVzIFNwYW4gPSAxMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyU3BhbigpIHsNCiAgICAgICAgDQogICAgICAgIHNwYW5fID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0U3BhbigpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZDwNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiB0YWdzXzsNCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgICAgaW50ZXJuYWxHZXRUYWdzKCkgew0KICAgICAgICBpZiAodGFnc18gPT0gbnVsbCkgew0KICAgICAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkLmVtcHR5TWFwRmllbGQoDQogICAgICAgICAgICAgIFRhZ3NEZWZhdWx0RW50cnlIb2xkZXIuZGVmYXVsdEVudHJ5KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGFnc187DQogICAgICB9DQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQ8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4NCiAgICAgIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKSB7DQogICAgICAgIG9uQ2hhbmdlZCgpOzsNCiAgICAgICAgaWYgKHRhZ3NfID09IG51bGwpIHsNCiAgICAgICAgICB0YWdzXyA9IGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQubmV3TWFwRmllbGQoDQogICAgICAgICAgICAgIFRhZ3NEZWZhdWx0RW50cnlIb2xkZXIuZGVmYXVsdEVudHJ5KTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIXRhZ3NfLmlzTXV0YWJsZSgpKSB7DQogICAgICAgICAgdGFnc18gPSB0YWdzXy5jb3B5KCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRhZ3NfOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW50IGdldFRhZ3NDb3VudCgpIHsNCiAgICAgICAgcmV0dXJuIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpLnNpemUoKTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gMTI7PC9jb2RlPg0KICAgICAgICovDQoNCiAgICAgIHB1YmxpYyBib29sZWFuIGNvbnRhaW5zVGFncygNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSkgew0KICAgICAgICBpZiAoa2V5ID09IG51bGwpIHsgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOyB9DQogICAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKS5jb250YWluc0tleShrZXkpOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiBVc2Uge0BsaW5rICNnZXRUYWdzTWFwKCl9IGluc3RlYWQuDQogICAgICAgKi8NCiAgICAgIEBqYXZhLmxhbmcuRGVwcmVjYXRlZA0KICAgICAgcHVibGljIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gZ2V0VGFncygpIHsNCiAgICAgICAgcmV0dXJuIGdldFRhZ3NNYXAoKTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gMTI7PC9jb2RlPg0KICAgICAgICovDQoNCiAgICAgIHB1YmxpYyBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IGdldFRhZ3NNYXAoKSB7DQogICAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gMTI7PC9jb2RlPg0KICAgICAgICovDQoNCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFRhZ3NPckRlZmF1bHQoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXksDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBkZWZhdWx0VmFsdWUpIHsNCiAgICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IG1hcCA9DQogICAgICAgICAgICBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICAgICAgcmV0dXJuIG1hcC5jb250YWluc0tleShrZXkpID8gbWFwLmdldChrZXkpIDogZGVmYXVsdFZhbHVlOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSAxMjs8L2NvZGU+DQogICAgICAgKi8NCg0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0VGFnc09yVGhyb3coDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpIHsNCiAgICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IG1hcCA9DQogICAgICAgICAgICBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICAgICAgaWYgKCFtYXAuY29udGFpbnNLZXkoa2V5KSkgew0KICAgICAgICAgIHRocm93IG5ldyBqYXZhLmxhbmcuSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG1hcC5nZXQoa2V5KTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJUYWdzKCkgew0KICAgICAgICBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkuZ2V0TXV0YWJsZU1hcCgpDQogICAgICAgICAgICAuY2xlYXIoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDEyOzwvY29kZT4NCiAgICAgICAqLw0KDQogICAgICBwdWJsaWMgQnVpbGRlciByZW1vdmVUYWdzKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcga2V5KSB7DQogICAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgICAgaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpLmdldE11dGFibGVNYXAoKQ0KICAgICAgICAgICAgLnJlbW92ZShrZXkpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogVXNlIGFsdGVybmF0ZSBtdXRhdGlvbiBhY2Nlc3NvcnMgaW5zdGVhZC4NCiAgICAgICAqLw0KICAgICAgQGphdmEubGFuZy5EZXByZWNhdGVkDQogICAgICBwdWJsaWMgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgICAgZ2V0TXV0YWJsZVRhZ3MoKSB7DQogICAgICAgIHJldHVybiBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkuZ2V0TXV0YWJsZU1hcCgpOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSAxMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHB1dFRhZ3MoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXksDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAoa2V5ID09IG51bGwpIHsgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOyB9DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgICBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkuZ2V0TXV0YWJsZU1hcCgpDQogICAgICAgICAgICAucHV0KGtleSwgdmFsdWUpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gMTI7PC9jb2RlPg0KICAgICAgICovDQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIHB1dEFsbFRhZ3MoDQogICAgICAgICAgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiB2YWx1ZXMpIHsNCiAgICAgICAgaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpLmdldE11dGFibGVNYXAoKQ0KICAgICAgICAgICAgLnB1dEFsbCh2YWx1ZXMpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIHNldFVua25vd25GaWVsZHMoDQogICAgICAgICAgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQgdW5rbm93bkZpZWxkcykgew0KICAgICAgICByZXR1cm4gc3VwZXIuc2V0VW5rbm93bkZpZWxkc1Byb3RvMyh1bmtub3duRmllbGRzKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIEJ1aWxkZXIgbWVyZ2VVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLm1lcmdlVW5rbm93bkZpZWxkcyh1bmtub3duRmllbGRzKTsNCiAgICAgIH0NCg0KDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoYnVpbGRlcl9zY29wZTprdWJlbXEuUmVxdWVzdCkNCiAgICB9DQoNCiAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoY2xhc3Nfc2NvcGU6a3ViZW1xLlJlcXVlc3QpDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0IERFRkFVTFRfSU5TVEFOQ0U7DQogICAgc3RhdGljIHsNCiAgICAgIERFRkFVTFRfSU5TVEFOQ0UgPSBuZXcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXF1ZXN0KCk7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlcXVlc3QgZ2V0RGVmYXVsdEluc3RhbmNlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UmVxdWVzdD4NCiAgICAgICAgUEFSU0VSID0gbmV3IGNvbS5nb29nbGUucHJvdG9idWYuQWJzdHJhY3RQYXJzZXI8UmVxdWVzdD4oKSB7DQogICAgICBwdWJsaWMgUmVxdWVzdCBwYXJzZVBhcnRpYWxGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgICByZXR1cm4gbmV3IFJlcXVlc3QoaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgIH0NCiAgICB9Ow0KDQogICAgcHVibGljIHN0YXRpYyBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxSZXF1ZXN0PiBwYXJzZXIoKSB7DQogICAgICByZXR1cm4gUEFSU0VSOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UmVxdWVzdD4gZ2V0UGFyc2VyRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVxdWVzdCBnZXREZWZhdWx0SW5zdGFuY2VGb3JUeXBlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogIH0NCg0KICBwdWJsaWMgaW50ZXJmYWNlIFJlc3BvbnNlT3JCdWlsZGVyIGV4dGVuZHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChpbnRlcmZhY2VfZXh0ZW5kczprdWJlbXEuUmVzcG9uc2UpDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLk1lc3NhZ2VPckJ1aWxkZXIgew0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRDbGllbnRJRCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRDbGllbnRJREJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMjs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRSZXF1ZXN0SUQoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMjs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldFJlcXVlc3RJREJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVwbHlDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRSZXBseUNoYW5uZWwoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVwbHlDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldFJlcGx5Q2hhbm5lbEJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgTWV0YWRhdGEgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldE1ldGFkYXRhKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNDs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldE1ldGFkYXRhQnl0ZXMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmJ5dGVzIEJvZHkgPSA1OzwvY29kZT4NCiAgICAgKi8NCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZ2V0Qm9keSgpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+Ym9vbCBDYWNoZUhpdCA9IDY7PC9jb2RlPg0KICAgICAqLw0KICAgIGJvb2xlYW4gZ2V0Q2FjaGVIaXQoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDY0IFRpbWVzdGFtcCA9IDc7PC9jb2RlPg0KICAgICAqLw0KICAgIGxvbmcgZ2V0VGltZXN0YW1wKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5ib29sIEV4ZWN1dGVkID0gODs8L2NvZGU+DQogICAgICovDQogICAgYm9vbGVhbiBnZXRFeGVjdXRlZCgpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gOTs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRFcnJvcigpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDk7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRFcnJvckJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5ieXRlcyBTcGFuID0gMTA7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBnZXRTcGFuKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSAxMTs8L2NvZGU+DQogICAgICovDQogICAgaW50IGdldFRhZ3NDb3VudCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDExOzwvY29kZT4NCiAgICAgKi8NCiAgICBib29sZWFuIGNvbnRhaW5zVGFncygNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpOw0KICAgIC8qKg0KICAgICAqIFVzZSB7QGxpbmsgI2dldFRhZ3NNYXAoKX0gaW5zdGVhZC4NCiAgICAgKi8NCiAgICBAamF2YS5sYW5nLkRlcHJlY2F0ZWQNCiAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+DQogICAgZ2V0VGFncygpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDExOzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+DQogICAgZ2V0VGFnc01hcCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDExOzwvY29kZT4NCiAgICAgKi8NCg0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0VGFnc09yRGVmYXVsdCgNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXksDQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgZGVmYXVsdFZhbHVlKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSAxMTs8L2NvZGU+DQogICAgICovDQoNCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldFRhZ3NPclRocm93KA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSk7DQogIH0NCiAgLyoqDQogICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5SZXNwb25zZX0NCiAgICovDQogIHB1YmxpYyAgc3RhdGljIGZpbmFsIGNsYXNzIFJlc3BvbnNlIGV4dGVuZHMNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzIGltcGxlbWVudHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChtZXNzYWdlX2ltcGxlbWVudHM6a3ViZW1xLlJlc3BvbnNlKQ0KICAgICAgUmVzcG9uc2VPckJ1aWxkZXIgew0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBsb25nIHNlcmlhbFZlcnNpb25VSUQgPSAwTDsNCiAgICAvLyBVc2UgUmVzcG9uc2UubmV3QnVpbGRlcigpIHRvIGNvbnN0cnVjdC4NCiAgICBwcml2YXRlIFJlc3BvbnNlKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8Pz4gYnVpbGRlcikgew0KICAgICAgc3VwZXIoYnVpbGRlcik7DQogICAgfQ0KICAgIHByaXZhdGUgUmVzcG9uc2UoKSB7DQogICAgICBjbGllbnRJRF8gPSAiIjsNCiAgICAgIHJlcXVlc3RJRF8gPSAiIjsNCiAgICAgIHJlcGx5Q2hhbm5lbF8gPSAiIjsNCiAgICAgIG1ldGFkYXRhXyA9ICIiOw0KICAgICAgYm9keV8gPSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuRU1QVFk7DQogICAgICBjYWNoZUhpdF8gPSBmYWxzZTsNCiAgICAgIHRpbWVzdGFtcF8gPSAwTDsNCiAgICAgIGV4ZWN1dGVkXyA9IGZhbHNlOw0KICAgICAgZXJyb3JfID0gIiI7DQogICAgICBzcGFuXyA9IGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5FTVBUWTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0DQogICAgZ2V0VW5rbm93bkZpZWxkcygpIHsNCiAgICAgIHJldHVybiB0aGlzLnVua25vd25GaWVsZHM7DQogICAgfQ0KICAgIHByaXZhdGUgUmVzcG9uc2UoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICB0aGlzKCk7DQogICAgICBpZiAoZXh0ZW5zaW9uUmVnaXN0cnkgPT0gbnVsbCkgew0KICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogICAgICB9DQogICAgICBpbnQgbXV0YWJsZV9iaXRGaWVsZDBfID0gMDsNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0LkJ1aWxkZXIgdW5rbm93bkZpZWxkcyA9DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQubmV3QnVpbGRlcigpOw0KICAgICAgdHJ5IHsNCiAgICAgICAgYm9vbGVhbiBkb25lID0gZmFsc2U7DQogICAgICAgIHdoaWxlICghZG9uZSkgew0KICAgICAgICAgIGludCB0YWcgPSBpbnB1dC5yZWFkVGFnKCk7DQogICAgICAgICAgc3dpdGNoICh0YWcpIHsNCiAgICAgICAgICAgIGNhc2UgMDoNCiAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgZGVmYXVsdDogew0KICAgICAgICAgICAgICBpZiAoIXBhcnNlVW5rbm93bkZpZWxkUHJvdG8zKA0KICAgICAgICAgICAgICAgICAgaW5wdXQsIHVua25vd25GaWVsZHMsIGV4dGVuc2lvblJlZ2lzdHJ5LCB0YWcpKSB7DQogICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDEwOiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIGNsaWVudElEXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAxODogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICByZXF1ZXN0SURfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDI2OiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIHJlcGx5Q2hhbm5lbF8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMzQ6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgbWV0YWRhdGFfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDQyOiB7DQoNCiAgICAgICAgICAgICAgYm9keV8gPSBpbnB1dC5yZWFkQnl0ZXMoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDQ4OiB7DQoNCiAgICAgICAgICAgICAgY2FjaGVIaXRfID0gaW5wdXQucmVhZEJvb2woKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDU2OiB7DQoNCiAgICAgICAgICAgICAgdGltZXN0YW1wXyA9IGlucHV0LnJlYWRJbnQ2NCgpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNjQ6IHsNCg0KICAgICAgICAgICAgICBleGVjdXRlZF8gPSBpbnB1dC5yZWFkQm9vbCgpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNzQ6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgZXJyb3JfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDgyOiB7DQoNCiAgICAgICAgICAgICAgc3Bhbl8gPSBpbnB1dC5yZWFkQnl0ZXMoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDkwOiB7DQogICAgICAgICAgICAgIGlmICghKChtdXRhYmxlX2JpdEZpZWxkMF8gJiAweDAwMDAwNDAwKSA9PSAweDAwMDAwNDAwKSkgew0KICAgICAgICAgICAgICAgIHRhZ3NfID0gY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZC5uZXdNYXBGaWVsZCgNCiAgICAgICAgICAgICAgICAgICAgVGFnc0RlZmF1bHRFbnRyeUhvbGRlci5kZWZhdWx0RW50cnkpOw0KICAgICAgICAgICAgICAgIG11dGFibGVfYml0RmllbGQwXyB8PSAweDAwMDAwNDAwOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRW50cnk8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4NCiAgICAgICAgICAgICAgdGFnc19fID0gaW5wdXQucmVhZE1lc3NhZ2UoDQogICAgICAgICAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeS5nZXRQYXJzZXJGb3JUeXBlKCksIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgICAgICAgICAgdGFnc18uZ2V0TXV0YWJsZU1hcCgpLnB1dCgNCiAgICAgICAgICAgICAgICAgIHRhZ3NfXy5nZXRLZXkoKSwgdGFnc19fLmdldFZhbHVlKCkpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0gY2F0Y2ggKGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgdGhyb3cgZS5zZXRVbmZpbmlzaGVkTWVzc2FnZSh0aGlzKTsNCiAgICAgIH0gY2F0Y2ggKGphdmEuaW8uSU9FeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24oDQogICAgICAgICAgICBlKS5zZXRVbmZpbmlzaGVkTWVzc2FnZSh0aGlzKTsNCiAgICAgIH0gZmluYWxseSB7DQogICAgICAgIHRoaXMudW5rbm93bkZpZWxkcyA9IHVua25vd25GaWVsZHMuYnVpbGQoKTsNCiAgICAgICAgbWFrZUV4dGVuc2lvbnNJbW11dGFibGUoKTsNCiAgICAgIH0NCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgZ2V0RGVzY3JpcHRvcigpIHsNCiAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUmVzcG9uc2VfZGVzY3JpcHRvcjsNCiAgICB9DQoNCiAgICBAU3VwcHJlc3NXYXJuaW5ncyh7InJhd3R5cGVzIn0pDQogICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQgaW50ZXJuYWxHZXRNYXBGaWVsZCgNCiAgICAgICAgaW50IG51bWJlcikgew0KICAgICAgc3dpdGNoIChudW1iZXIpIHsNCiAgICAgICAgY2FzZSAxMToNCiAgICAgICAgICByZXR1cm4gaW50ZXJuYWxHZXRUYWdzKCk7DQogICAgICAgIGRlZmF1bHQ6DQogICAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFeGNlcHRpb24oDQogICAgICAgICAgICAgICJJbnZhbGlkIG1hcCBmaWVsZCBudW1iZXI6ICIgKyBudW1iZXIpOw0KICAgICAgfQ0KICAgIH0NCiAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgIGludGVybmFsR2V0RmllbGRBY2Nlc3NvclRhYmxlKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXNwb25zZV9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZS5jbGFzcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZS5CdWlsZGVyLmNsYXNzKTsNCiAgICB9DQoNCiAgICBwcml2YXRlIGludCBiaXRGaWVsZDBfOw0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENMSUVOVElEX0ZJRUxEX05VTUJFUiA9IDE7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IGNsaWVudElEXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDbGllbnRJRCgpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2xpZW50SURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIGNsaWVudElEXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldENsaWVudElEQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNsaWVudElEXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICBjbGllbnRJRF8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUkVRVUVTVElEX0ZJRUxEX05VTUJFUiA9IDI7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IHJlcXVlc3RJRF87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFJlcXVlc3RJRCgpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVxdWVzdElEXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICByZXF1ZXN0SURfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldFJlcXVlc3RJREJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXF1ZXN0SURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIHJlcXVlc3RJRF8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUkVQTFlDSEFOTkVMX0ZJRUxEX05VTUJFUiA9IDM7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IHJlcGx5Q2hhbm5lbF87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIFJlcGx5Q2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFJlcGx5Q2hhbm5lbCgpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVwbHlDaGFubmVsXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICByZXBseUNoYW5uZWxfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBSZXBseUNoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldFJlcGx5Q2hhbm5lbEJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXBseUNoYW5uZWxfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIHJlcGx5Q2hhbm5lbF8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTUVUQURBVEFfRklFTERfTlVNQkVSID0gNDsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgbWV0YWRhdGFfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldE1ldGFkYXRhKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBtZXRhZGF0YV87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgbWV0YWRhdGFfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0TWV0YWRhdGFCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gbWV0YWRhdGFfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIG1ldGFkYXRhXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBCT0RZX0ZJRUxEX05VTUJFUiA9IDU7DQogICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYm9keV87DQogICAgLyoqDQogICAgICogPGNvZGU+Ynl0ZXMgQm9keSA9IDU7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZ2V0Qm9keSgpIHsNCiAgICAgIHJldHVybiBib2R5XzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDQUNIRUhJVF9GSUVMRF9OVU1CRVIgPSA2Ow0KICAgIHByaXZhdGUgYm9vbGVhbiBjYWNoZUhpdF87DQogICAgLyoqDQogICAgICogPGNvZGU+Ym9vbCBDYWNoZUhpdCA9IDY7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBib29sZWFuIGdldENhY2hlSGl0KCkgew0KICAgICAgcmV0dXJuIGNhY2hlSGl0XzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBUSU1FU1RBTVBfRklFTERfTlVNQkVSID0gNzsNCiAgICBwcml2YXRlIGxvbmcgdGltZXN0YW1wXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQ2NCBUaW1lc3RhbXAgPSA3OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgbG9uZyBnZXRUaW1lc3RhbXAoKSB7DQogICAgICByZXR1cm4gdGltZXN0YW1wXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBFWEVDVVRFRF9GSUVMRF9OVU1CRVIgPSA4Ow0KICAgIHByaXZhdGUgYm9vbGVhbiBleGVjdXRlZF87DQogICAgLyoqDQogICAgICogPGNvZGU+Ym9vbCBFeGVjdXRlZCA9IDg7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBib29sZWFuIGdldEV4ZWN1dGVkKCkgew0KICAgICAgcmV0dXJuIGV4ZWN1dGVkXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBFUlJPUl9GSUVMRF9OVU1CRVIgPSA5Ow0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBlcnJvcl87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gOTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0RXJyb3IoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGVycm9yXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBlcnJvcl8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gOTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRFcnJvckJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBlcnJvcl87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgZXJyb3JfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNQQU5fRklFTERfTlVNQkVSID0gMTA7DQogICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgc3Bhbl87DQogICAgLyoqDQogICAgICogPGNvZGU+Ynl0ZXMgU3BhbiA9IDEwOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGdldFNwYW4oKSB7DQogICAgICByZXR1cm4gc3Bhbl87DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgVEFHU19GSUVMRF9OVU1CRVIgPSAxMTsNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjbGFzcyBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyIHsNCiAgICAgIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEVudHJ5PA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IGRlZmF1bHRFbnRyeSA9DQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRW50cnkNCiAgICAgICAgICAgICAgLjxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPm5ld0RlZmF1bHRJbnN0YW5jZSgNCiAgICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXNwb25zZV9UYWdzRW50cnlfZGVzY3JpcHRvciwgDQogICAgICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLldpcmVGb3JtYXQuRmllbGRUeXBlLlNUUklORywNCiAgICAgICAgICAgICAgICAgICIiLA0KICAgICAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5XaXJlRm9ybWF0LkZpZWxkVHlwZS5TVFJJTkcsDQogICAgICAgICAgICAgICAgICAiIik7DQogICAgfQ0KICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZDwNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gdGFnc187DQogICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+DQogICAgaW50ZXJuYWxHZXRUYWdzKCkgew0KICAgICAgaWYgKHRhZ3NfID09IG51bGwpIHsNCiAgICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQuZW1wdHlNYXBGaWVsZCgNCiAgICAgICAgICAgIFRhZ3NEZWZhdWx0RW50cnlIb2xkZXIuZGVmYXVsdEVudHJ5KTsNCiAgICAgIH0NCiAgICAgIHJldHVybiB0YWdzXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW50IGdldFRhZ3NDb3VudCgpIHsNCiAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKS5zaXplKCk7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDExOzwvY29kZT4NCiAgICAgKi8NCg0KICAgIHB1YmxpYyBib29sZWFuIGNvbnRhaW5zVGFncygNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpIHsNCiAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKS5jb250YWluc0tleShrZXkpOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiBVc2Uge0BsaW5rICNnZXRUYWdzTWFwKCl9IGluc3RlYWQuDQogICAgICovDQogICAgQGphdmEubGFuZy5EZXByZWNhdGVkDQogICAgcHVibGljIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gZ2V0VGFncygpIHsNCiAgICAgIHJldHVybiBnZXRUYWdzTWFwKCk7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDExOzwvY29kZT4NCiAgICAgKi8NCg0KICAgIHB1YmxpYyBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IGdldFRhZ3NNYXAoKSB7DQogICAgICByZXR1cm4gaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCk7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDExOzwvY29kZT4NCiAgICAgKi8NCg0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFRhZ3NPckRlZmF1bHQoDQogICAgICAgIGphdmEubGFuZy5TdHJpbmcga2V5LA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGRlZmF1bHRWYWx1ZSkgew0KICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBtYXAgPQ0KICAgICAgICAgIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpOw0KICAgICAgcmV0dXJuIG1hcC5jb250YWluc0tleShrZXkpID8gbWFwLmdldChrZXkpIDogZGVmYXVsdFZhbHVlOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSAxMTs8L2NvZGU+DQogICAgICovDQoNCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRUYWdzT3JUaHJvdygNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpIHsNCiAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gbWFwID0NCiAgICAgICAgICBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICAgIGlmICghbWFwLmNvbnRhaW5zS2V5KGtleSkpIHsNCiAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5JbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24oKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBtYXAuZ2V0KGtleSk7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBieXRlIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IC0xOw0KICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICBieXRlIGlzSW5pdGlhbGl6ZWQgPSBtZW1vaXplZElzSW5pdGlhbGl6ZWQ7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAxKSByZXR1cm4gdHJ1ZTsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDApIHJldHVybiBmYWxzZTsNCg0KICAgICAgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gMTsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCg0KICAgIHB1YmxpYyB2b2lkIHdyaXRlVG8oY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbSBvdXRwdXQpDQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICBpZiAoIWdldENsaWVudElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAxLCBjbGllbnRJRF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRSZXF1ZXN0SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDIsIHJlcXVlc3RJRF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRSZXBseUNoYW5uZWxCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDMsIHJlcGx5Q2hhbm5lbF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRNZXRhZGF0YUJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLndyaXRlU3RyaW5nKG91dHB1dCwgNCwgbWV0YWRhdGFfKTsNCiAgICAgIH0NCiAgICAgIGlmICghYm9keV8uaXNFbXB0eSgpKSB7DQogICAgICAgIG91dHB1dC53cml0ZUJ5dGVzKDUsIGJvZHlfKTsNCiAgICAgIH0NCiAgICAgIGlmIChjYWNoZUhpdF8gIT0gZmFsc2UpIHsNCiAgICAgICAgb3V0cHV0LndyaXRlQm9vbCg2LCBjYWNoZUhpdF8pOw0KICAgICAgfQ0KICAgICAgaWYgKHRpbWVzdGFtcF8gIT0gMEwpIHsNCiAgICAgICAgb3V0cHV0LndyaXRlSW50NjQoNywgdGltZXN0YW1wXyk7DQogICAgICB9DQogICAgICBpZiAoZXhlY3V0ZWRfICE9IGZhbHNlKSB7DQogICAgICAgIG91dHB1dC53cml0ZUJvb2woOCwgZXhlY3V0ZWRfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0RXJyb3JCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDksIGVycm9yXyk7DQogICAgICB9DQogICAgICBpZiAoIXNwYW5fLmlzRW1wdHkoKSkgew0KICAgICAgICBvdXRwdXQud3JpdGVCeXRlcygxMCwgc3Bhbl8pOw0KICAgICAgfQ0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgLnNlcmlhbGl6ZVN0cmluZ01hcFRvKA0KICAgICAgICAgIG91dHB1dCwNCiAgICAgICAgICBpbnRlcm5hbEdldFRhZ3MoKSwNCiAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeSwNCiAgICAgICAgICAxMSk7DQogICAgICB1bmtub3duRmllbGRzLndyaXRlVG8ob3V0cHV0KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW50IGdldFNlcmlhbGl6ZWRTaXplKCkgew0KICAgICAgaW50IHNpemUgPSBtZW1vaXplZFNpemU7DQogICAgICBpZiAoc2l6ZSAhPSAtMSkgcmV0dXJuIHNpemU7DQoNCiAgICAgIHNpemUgPSAwOw0KICAgICAgaWYgKCFnZXRDbGllbnRJREJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoMSwgY2xpZW50SURfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0UmVxdWVzdElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSgyLCByZXF1ZXN0SURfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0UmVwbHlDaGFubmVsQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSgzLCByZXBseUNoYW5uZWxfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0TWV0YWRhdGFCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDQsIG1ldGFkYXRhXyk7DQogICAgICB9DQogICAgICBpZiAoIWJvZHlfLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUJ5dGVzU2l6ZSg1LCBib2R5Xyk7DQogICAgICB9DQogICAgICBpZiAoY2FjaGVIaXRfICE9IGZhbHNlKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlQm9vbFNpemUoNiwgY2FjaGVIaXRfKTsNCiAgICAgIH0NCiAgICAgIGlmICh0aW1lc3RhbXBfICE9IDBMKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlSW50NjRTaXplKDcsIHRpbWVzdGFtcF8pOw0KICAgICAgfQ0KICAgICAgaWYgKGV4ZWN1dGVkXyAhPSBmYWxzZSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUJvb2xTaXplKDgsIGV4ZWN1dGVkXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldEVycm9yQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSg5LCBlcnJvcl8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFzcGFuXy5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVCeXRlc1NpemUoMTAsIHNwYW5fKTsNCiAgICAgIH0NCiAgICAgIGZvciAoamF2YS51dGlsLk1hcC5FbnRyeTxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBlbnRyeQ0KICAgICAgICAgICA6IGludGVybmFsR2V0VGFncygpLmdldE1hcCgpLmVudHJ5U2V0KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBFbnRyeTxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgICAgICB0YWdzX18gPSBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeS5uZXdCdWlsZGVyRm9yVHlwZSgpDQogICAgICAgICAgICAuc2V0S2V5KGVudHJ5LmdldEtleSgpKQ0KICAgICAgICAgICAgLnNldFZhbHVlKGVudHJ5LmdldFZhbHVlKCkpDQogICAgICAgICAgICAuYnVpbGQoKTsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgICAuY29tcHV0ZU1lc3NhZ2VTaXplKDExLCB0YWdzX18pOw0KICAgICAgfQ0KICAgICAgc2l6ZSArPSB1bmtub3duRmllbGRzLmdldFNlcmlhbGl6ZWRTaXplKCk7DQogICAgICBtZW1vaXplZFNpemUgPSBzaXplOw0KICAgICAgcmV0dXJuIHNpemU7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBib29sZWFuIGVxdWFscyhmaW5hbCBqYXZhLmxhbmcuT2JqZWN0IG9iaikgew0KICAgICAgaWYgKG9iaiA9PSB0aGlzKSB7DQogICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgICBpZiAoIShvYmogaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3BvbnNlKSkgew0KICAgICAgICByZXR1cm4gc3VwZXIuZXF1YWxzKG9iaik7DQogICAgICB9DQogICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3BvbnNlIG90aGVyID0gKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzcG9uc2UpIG9iajsNCg0KICAgICAgYm9vbGVhbiByZXN1bHQgPSB0cnVlOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldENsaWVudElEKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldENsaWVudElEKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldFJlcXVlc3RJRCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRSZXF1ZXN0SUQoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0UmVwbHlDaGFubmVsKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldFJlcGx5Q2hhbm5lbCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRNZXRhZGF0YSgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRNZXRhZGF0YSgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRCb2R5KCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldEJvZHkoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldENhY2hlSGl0KCkNCiAgICAgICAgICA9PSBvdGhlci5nZXRDYWNoZUhpdCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiAoZ2V0VGltZXN0YW1wKCkNCiAgICAgICAgICA9PSBvdGhlci5nZXRUaW1lc3RhbXAoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldEV4ZWN1dGVkKCkNCiAgICAgICAgICA9PSBvdGhlci5nZXRFeGVjdXRlZCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRFcnJvcigpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRFcnJvcigpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRTcGFuKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldFNwYW4oKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgaW50ZXJuYWxHZXRUYWdzKCkuZXF1YWxzKA0KICAgICAgICAgIG90aGVyLmludGVybmFsR2V0VGFncygpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiB1bmtub3duRmllbGRzLmVxdWFscyhvdGhlci51bmtub3duRmllbGRzKTsNCiAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBpbnQgaGFzaENvZGUoKSB7DQogICAgICBpZiAobWVtb2l6ZWRIYXNoQ29kZSAhPSAwKSB7DQogICAgICAgIHJldHVybiBtZW1vaXplZEhhc2hDb2RlOw0KICAgICAgfQ0KICAgICAgaW50IGhhc2ggPSA0MTsNCiAgICAgIGhhc2ggPSAoMTkgKiBoYXNoKSArIGdldERlc2NyaXB0b3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgQ0xJRU5USURfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0Q2xpZW50SUQoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgUkVRVUVTVElEX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldFJlcXVlc3RJRCgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBSRVBMWUNIQU5ORUxfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0UmVwbHlDaGFubmVsKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIE1FVEFEQVRBX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldE1ldGFkYXRhKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIEJPRFlfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0Qm9keSgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBDQUNIRUhJVF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBjb20uZ29vZ2xlLnByb3RvYnVmLkludGVybmFsLmhhc2hCb29sZWFuKA0KICAgICAgICAgIGdldENhY2hlSGl0KCkpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgVElNRVNUQU1QX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGNvbS5nb29nbGUucHJvdG9idWYuSW50ZXJuYWwuaGFzaExvbmcoDQogICAgICAgICAgZ2V0VGltZXN0YW1wKCkpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgRVhFQ1VURURfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5oYXNoQm9vbGVhbigNCiAgICAgICAgICBnZXRFeGVjdXRlZCgpKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIEVSUk9SX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldEVycm9yKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFNQQU5fRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0U3BhbigpLmhhc2hDb2RlKCk7DQogICAgICBpZiAoIWludGVybmFsR2V0VGFncygpLmdldE1hcCgpLmlzRW1wdHkoKSkgew0KICAgICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBUQUdTX0ZJRUxEX05VTUJFUjsNCiAgICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgaW50ZXJuYWxHZXRUYWdzKCkuaGFzaENvZGUoKTsNCiAgICAgIH0NCiAgICAgIGhhc2ggPSAoMjkgKiBoYXNoKSArIHVua25vd25GaWVsZHMuaGFzaENvZGUoKTsNCiAgICAgIG1lbW9pemVkSGFzaENvZGUgPSBoYXNoOw0KICAgICAgcmV0dXJuIGhhc2g7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5uaW8uQnl0ZUJ1ZmZlciBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZSBwYXJzZUZyb20oDQogICAgICAgIGphdmEubmlvLkJ5dGVCdWZmZXIgZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZSBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZSBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3BvbnNlIHBhcnNlRnJvbShieXRlW10gZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBieXRlW10gZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZSBwYXJzZUZyb20oamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3BvbnNlIHBhcnNlRGVsaW1pdGVkRnJvbShqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VEZWxpbWl0ZWRXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZSBwYXJzZURlbGltaXRlZEZyb20oDQogICAgICAgIGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VEZWxpbWl0ZWRXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgQnVpbGRlciBuZXdCdWlsZGVyRm9yVHlwZSgpIHsgcmV0dXJuIG5ld0J1aWxkZXIoKTsgfQ0KICAgIHB1YmxpYyBzdGF0aWMgQnVpbGRlciBuZXdCdWlsZGVyKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgQnVpbGRlciBuZXdCdWlsZGVyKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzcG9uc2UgcHJvdG90eXBlKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRS50b0J1aWxkZXIoKS5tZXJnZUZyb20ocHJvdG90eXBlKTsNCiAgICB9DQogICAgcHVibGljIEJ1aWxkZXIgdG9CdWlsZGVyKCkgew0KICAgICAgcmV0dXJuIHRoaXMgPT0gREVGQVVMVF9JTlNUQU5DRQ0KICAgICAgICAgID8gbmV3IEJ1aWxkZXIoKSA6IG5ldyBCdWlsZGVyKCkubWVyZ2VGcm9tKHRoaXMpOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwcm90ZWN0ZWQgQnVpbGRlciBuZXdCdWlsZGVyRm9yVHlwZSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlclBhcmVudCBwYXJlbnQpIHsNCiAgICAgIEJ1aWxkZXIgYnVpbGRlciA9IG5ldyBCdWlsZGVyKHBhcmVudCk7DQogICAgICByZXR1cm4gYnVpbGRlcjsNCiAgICB9DQogICAgLyoqDQogICAgICogUHJvdG9idWYgdHlwZSB7QGNvZGUga3ViZW1xLlJlc3BvbnNlfQ0KICAgICAqLw0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY2xhc3MgQnVpbGRlciBleHRlbmRzDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8QnVpbGRlcj4gaW1wbGVtZW50cw0KICAgICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoYnVpbGRlcl9pbXBsZW1lbnRzOmt1YmVtcS5SZXNwb25zZSkNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZU9yQnVpbGRlciB7DQogICAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUmVzcG9uc2VfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgQFN1cHByZXNzV2FybmluZ3MoeyJyYXd0eXBlcyJ9KQ0KICAgICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQgaW50ZXJuYWxHZXRNYXBGaWVsZCgNCiAgICAgICAgICBpbnQgbnVtYmVyKSB7DQogICAgICAgIHN3aXRjaCAobnVtYmVyKSB7DQogICAgICAgICAgY2FzZSAxMToNCiAgICAgICAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKTsNCiAgICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFeGNlcHRpb24oDQogICAgICAgICAgICAgICAgIkludmFsaWQgbWFwIGZpZWxkIG51bWJlcjogIiArIG51bWJlcik7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIEBTdXBwcmVzc1dhcm5pbmdzKHsicmF3dHlwZXMifSkNCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkIGludGVybmFsR2V0TXV0YWJsZU1hcEZpZWxkKA0KICAgICAgICAgIGludCBudW1iZXIpIHsNCiAgICAgICAgc3dpdGNoIChudW1iZXIpIHsNCiAgICAgICAgICBjYXNlIDExOg0KICAgICAgICAgICAgcmV0dXJuIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKTsNCiAgICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFeGNlcHRpb24oDQogICAgICAgICAgICAgICAgIkludmFsaWQgbWFwIGZpZWxkIG51bWJlcjogIiArIG51bWJlcik7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXNwb25zZV9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAgIC5lbnN1cmVGaWVsZEFjY2Vzc29yc0luaXRpYWxpemVkKA0KICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzcG9uc2UuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzcG9uc2UuQnVpbGRlci5jbGFzcyk7DQogICAgICB9DQoNCiAgICAgIC8vIENvbnN0cnVjdCB1c2luZyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3BvbnNlLm5ld0J1aWxkZXIoKQ0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKCkgew0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgQnVpbGRlcigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgICBzdXBlcihwYXJlbnQpOw0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQogICAgICBwcml2YXRlIHZvaWQgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpIHsNCiAgICAgICAgaWYgKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgICAgICAgLmFsd2F5c1VzZUZpZWxkQnVpbGRlcnMpIHsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXIoKSB7DQogICAgICAgIHN1cGVyLmNsZWFyKCk7DQogICAgICAgIGNsaWVudElEXyA9ICIiOw0KDQogICAgICAgIHJlcXVlc3RJRF8gPSAiIjsNCg0KICAgICAgICByZXBseUNoYW5uZWxfID0gIiI7DQoNCiAgICAgICAgbWV0YWRhdGFfID0gIiI7DQoNCiAgICAgICAgYm9keV8gPSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuRU1QVFk7DQoNCiAgICAgICAgY2FjaGVIaXRfID0gZmFsc2U7DQoNCiAgICAgICAgdGltZXN0YW1wXyA9IDBMOw0KDQogICAgICAgIGV4ZWN1dGVkXyA9IGZhbHNlOw0KDQogICAgICAgIGVycm9yXyA9ICIiOw0KDQogICAgICAgIHNwYW5fID0gY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLkVNUFRZOw0KDQogICAgICAgIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKS5jbGVhcigpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICAgIGdldERlc2NyaXB0b3JGb3JUeXBlKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1Jlc3BvbnNlX2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3BvbnNlIGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3BvbnNlLmdldERlZmF1bHRJbnN0YW5jZSgpOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZSBidWlsZCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZSByZXN1bHQgPSBidWlsZFBhcnRpYWwoKTsNCiAgICAgICAgaWYgKCFyZXN1bHQuaXNJbml0aWFsaXplZCgpKSB7DQogICAgICAgICAgdGhyb3cgbmV3VW5pbml0aWFsaXplZE1lc3NhZ2VFeGNlcHRpb24ocmVzdWx0KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZSBidWlsZFBhcnRpYWwoKSB7DQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzcG9uc2UgcmVzdWx0ID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzcG9uc2UodGhpcyk7DQogICAgICAgIGludCBmcm9tX2JpdEZpZWxkMF8gPSBiaXRGaWVsZDBfOw0KICAgICAgICBpbnQgdG9fYml0RmllbGQwXyA9IDA7DQogICAgICAgIHJlc3VsdC5jbGllbnRJRF8gPSBjbGllbnRJRF87DQogICAgICAgIHJlc3VsdC5yZXF1ZXN0SURfID0gcmVxdWVzdElEXzsNCiAgICAgICAgcmVzdWx0LnJlcGx5Q2hhbm5lbF8gPSByZXBseUNoYW5uZWxfOw0KICAgICAgICByZXN1bHQubWV0YWRhdGFfID0gbWV0YWRhdGFfOw0KICAgICAgICByZXN1bHQuYm9keV8gPSBib2R5XzsNCiAgICAgICAgcmVzdWx0LmNhY2hlSGl0XyA9IGNhY2hlSGl0XzsNCiAgICAgICAgcmVzdWx0LnRpbWVzdGFtcF8gPSB0aW1lc3RhbXBfOw0KICAgICAgICByZXN1bHQuZXhlY3V0ZWRfID0gZXhlY3V0ZWRfOw0KICAgICAgICByZXN1bHQuZXJyb3JfID0gZXJyb3JfOw0KICAgICAgICByZXN1bHQuc3Bhbl8gPSBzcGFuXzsNCiAgICAgICAgcmVzdWx0LnRhZ3NfID0gaW50ZXJuYWxHZXRUYWdzKCk7DQogICAgICAgIHJlc3VsdC50YWdzXy5tYWtlSW1tdXRhYmxlKCk7DQogICAgICAgIHJlc3VsdC5iaXRGaWVsZDBfID0gdG9fYml0RmllbGQwXzsNCiAgICAgICAgb25CdWlsdCgpOw0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBjbG9uZSgpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbG9uZSgpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJGaWVsZChmaWVsZCk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck9uZW9mKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuT25lb2ZEZXNjcmlwdG9yIG9uZW9mKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJPbmVvZihvbmVvZik7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGludCBpbmRleCwgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldFJlcGVhdGVkRmllbGQoZmllbGQsIGluZGV4LCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBhZGRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5hZGRSZXBlYXRlZEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oY29tLmdvb2dsZS5wcm90b2J1Zi5NZXNzYWdlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzcG9uc2UpIHsNCiAgICAgICAgICByZXR1cm4gbWVyZ2VGcm9tKChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3BvbnNlKW90aGVyKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBzdXBlci5tZXJnZUZyb20ob3RoZXIpOw0KICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbShpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3BvbnNlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciA9PSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlc3BvbnNlLmdldERlZmF1bHRJbnN0YW5jZSgpKSByZXR1cm4gdGhpczsNCiAgICAgICAgaWYgKCFvdGhlci5nZXRDbGllbnRJRCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIGNsaWVudElEXyA9IG90aGVyLmNsaWVudElEXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIW90aGVyLmdldFJlcXVlc3RJRCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIHJlcXVlc3RJRF8gPSBvdGhlci5yZXF1ZXN0SURfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmICghb3RoZXIuZ2V0UmVwbHlDaGFubmVsKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgcmVwbHlDaGFubmVsXyA9IG90aGVyLnJlcGx5Q2hhbm5lbF87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRNZXRhZGF0YSgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIG1ldGFkYXRhXyA9IG90aGVyLm1ldGFkYXRhXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0Qm9keSgpICE9IGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5FTVBUWSkgew0KICAgICAgICAgIHNldEJvZHkob3RoZXIuZ2V0Qm9keSgpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0Q2FjaGVIaXQoKSAhPSBmYWxzZSkgew0KICAgICAgICAgIHNldENhY2hlSGl0KG90aGVyLmdldENhY2hlSGl0KCkpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRUaW1lc3RhbXAoKSAhPSAwTCkgew0KICAgICAgICAgIHNldFRpbWVzdGFtcChvdGhlci5nZXRUaW1lc3RhbXAoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmdldEV4ZWN1dGVkKCkgIT0gZmFsc2UpIHsNCiAgICAgICAgICBzZXRFeGVjdXRlZChvdGhlci5nZXRFeGVjdXRlZCgpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIW90aGVyLmdldEVycm9yKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgZXJyb3JfID0gb3RoZXIuZXJyb3JfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRTcGFuKCkgIT0gY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLkVNUFRZKSB7DQogICAgICAgICAgc2V0U3BhbihvdGhlci5nZXRTcGFuKCkpOw0KICAgICAgICB9DQogICAgICAgIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKS5tZXJnZUZyb20oDQogICAgICAgICAgICBvdGhlci5pbnRlcm5hbEdldFRhZ3MoKSk7DQogICAgICAgIHRoaXMubWVyZ2VVbmtub3duRmllbGRzKG90aGVyLnVua25vd25GaWVsZHMpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZSBwYXJzZWRNZXNzYWdlID0gbnVsbDsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gUEFSU0VSLnBhcnNlUGFydGlhbEZyb20oaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZSkgZS5nZXRVbmZpbmlzaGVkTWVzc2FnZSgpOw0KICAgICAgICAgIHRocm93IGUudW53cmFwSU9FeGNlcHRpb24oKTsNCiAgICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgICBpZiAocGFyc2VkTWVzc2FnZSAhPSBudWxsKSB7DQogICAgICAgICAgICBtZXJnZUZyb20ocGFyc2VkTWVzc2FnZSk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgcHJpdmF0ZSBpbnQgYml0RmllbGQwXzsNCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IGNsaWVudElEXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2xpZW50SUQoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2xpZW50SURfOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICBjbGllbnRJRF8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0Q2xpZW50SURCeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjbGllbnRJRF87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgY2xpZW50SURfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRDbGllbnRJRCgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIGNsaWVudElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckNsaWVudElEKCkgew0KICAgICAgICANCiAgICAgICAgY2xpZW50SURfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0Q2xpZW50SUQoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2xpZW50SURCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgY2xpZW50SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IHJlcXVlc3RJRF8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRSZXF1ZXN0SUQoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVxdWVzdElEXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgcmVxdWVzdElEXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0UmVxdWVzdElEQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVxdWVzdElEXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICByZXF1ZXN0SURfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UmVxdWVzdElEKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgcmVxdWVzdElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJSZXF1ZXN0SUQoKSB7DQogICAgICAgIA0KICAgICAgICByZXF1ZXN0SURfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0UmVxdWVzdElEKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXF1ZXN0SURCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgcmVxdWVzdElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCByZXBseUNoYW5uZWxfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXBseUNoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0UmVwbHlDaGFubmVsKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHJlcGx5Q2hhbm5lbF87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIHJlcGx5Q2hhbm5lbF8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXBseUNoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldFJlcGx5Q2hhbm5lbEJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHJlcGx5Q2hhbm5lbF87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgcmVwbHlDaGFubmVsXyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVwbHlDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlcGx5Q2hhbm5lbCgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIHJlcGx5Q2hhbm5lbF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVwbHlDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyUmVwbHlDaGFubmVsKCkgew0KICAgICAgICANCiAgICAgICAgcmVwbHlDaGFubmVsXyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldFJlcGx5Q2hhbm5lbCgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXBseUNoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UmVwbHlDaGFubmVsQnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIHJlcGx5Q2hhbm5lbF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgbWV0YWRhdGFfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRNZXRhZGF0YSgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBtZXRhZGF0YV87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIG1ldGFkYXRhXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRNZXRhZGF0YUJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1ldGFkYXRhXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBtZXRhZGF0YV8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldE1ldGFkYXRhKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgbWV0YWRhdGFfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyTWV0YWRhdGEoKSB7DQogICAgICAgIA0KICAgICAgICBtZXRhZGF0YV8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRNZXRhZGF0YSgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRNZXRhZGF0YUJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBtZXRhZGF0YV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBib2R5XyA9IGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5FTVBUWTsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ynl0ZXMgQm9keSA9IDU7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGdldEJvZHkoKSB7DQogICAgICAgIHJldHVybiBib2R5XzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ynl0ZXMgQm9keSA9IDU7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRCb2R5KGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBib2R5XyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJ5dGVzIEJvZHkgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJCb2R5KCkgew0KICAgICAgICANCiAgICAgICAgYm9keV8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRCb2R5KCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBib29sZWFuIGNhY2hlSGl0XyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJvb2wgQ2FjaGVIaXQgPSA2OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGJvb2xlYW4gZ2V0Q2FjaGVIaXQoKSB7DQogICAgICAgIHJldHVybiBjYWNoZUhpdF87DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJvb2wgQ2FjaGVIaXQgPSA2OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2FjaGVIaXQoYm9vbGVhbiB2YWx1ZSkgew0KICAgICAgICANCiAgICAgICAgY2FjaGVIaXRfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ym9vbCBDYWNoZUhpdCA9IDY7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckNhY2hlSGl0KCkgew0KICAgICAgICANCiAgICAgICAgY2FjaGVIaXRfID0gZmFsc2U7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBsb25nIHRpbWVzdGFtcF8gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQ2NCBUaW1lc3RhbXAgPSA3OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGxvbmcgZ2V0VGltZXN0YW1wKCkgew0KICAgICAgICByZXR1cm4gdGltZXN0YW1wXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgVGltZXN0YW1wID0gNzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFRpbWVzdGFtcChsb25nIHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICB0aW1lc3RhbXBfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgVGltZXN0YW1wID0gNzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyVGltZXN0YW1wKCkgew0KICAgICAgICANCiAgICAgICAgdGltZXN0YW1wXyA9IDBMOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgYm9vbGVhbiBleGVjdXRlZF8gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIEV4ZWN1dGVkID0gODs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBib29sZWFuIGdldEV4ZWN1dGVkKCkgew0KICAgICAgICByZXR1cm4gZXhlY3V0ZWRfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIEV4ZWN1dGVkID0gODs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEV4ZWN1dGVkKGJvb2xlYW4gdmFsdWUpIHsNCiAgICAgICAgDQogICAgICAgIGV4ZWN1dGVkXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJvb2wgRXhlY3V0ZWQgPSA4OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJFeGVjdXRlZCgpIHsNCiAgICAgICAgDQogICAgICAgIGV4ZWN1dGVkXyA9IGZhbHNlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCBlcnJvcl8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gOTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldEVycm9yKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGVycm9yXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgZXJyb3JfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXJyb3IgPSA5OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldEVycm9yQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gZXJyb3JfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIGVycm9yXyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXJyb3IgPSA5OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RXJyb3IoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBlcnJvcl8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXJyb3IgPSA5OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJFcnJvcigpIHsNCiAgICAgICAgDQogICAgICAgIGVycm9yXyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldEVycm9yKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gOTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEVycm9yQnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIGVycm9yXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHNwYW5fID0gY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLkVNUFRZOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ieXRlcyBTcGFuID0gMTA7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGdldFNwYW4oKSB7DQogICAgICAgIHJldHVybiBzcGFuXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ynl0ZXMgU3BhbiA9IDEwOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0U3Bhbihjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgc3Bhbl8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ieXRlcyBTcGFuID0gMTA7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhclNwYW4oKSB7DQogICAgICAgIA0KICAgICAgICBzcGFuXyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldFNwYW4oKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQ8DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gdGFnc187DQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQ8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4NCiAgICAgIGludGVybmFsR2V0VGFncygpIHsNCiAgICAgICAgaWYgKHRhZ3NfID09IG51bGwpIHsNCiAgICAgICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZC5lbXB0eU1hcEZpZWxkKA0KICAgICAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRhZ3NfOw0KICAgICAgfQ0KICAgICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+DQogICAgICBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkgew0KICAgICAgICBvbkNoYW5nZWQoKTs7DQogICAgICAgIGlmICh0YWdzXyA9PSBudWxsKSB7DQogICAgICAgICAgdGFnc18gPSBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkLm5ld01hcEZpZWxkKA0KICAgICAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCF0YWdzXy5pc011dGFibGUoKSkgew0KICAgICAgICAgIHRhZ3NfID0gdGFnc18uY29weSgpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0YWdzXzsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGludCBnZXRUYWdzQ291bnQoKSB7DQogICAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKS5zaXplKCk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDExOzwvY29kZT4NCiAgICAgICAqLw0KDQogICAgICBwdWJsaWMgYm9vbGVhbiBjb250YWluc1RhZ3MoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpIHsNCiAgICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgICByZXR1cm4gaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCkuY29udGFpbnNLZXkoa2V5KTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogVXNlIHtAbGluayAjZ2V0VGFnc01hcCgpfSBpbnN0ZWFkLg0KICAgICAgICovDQogICAgICBAamF2YS5sYW5nLkRlcHJlY2F0ZWQNCiAgICAgIHB1YmxpYyBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IGdldFRhZ3MoKSB7DQogICAgICAgIHJldHVybiBnZXRUYWdzTWFwKCk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDExOzwvY29kZT4NCiAgICAgICAqLw0KDQogICAgICBwdWJsaWMgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBnZXRUYWdzTWFwKCkgew0KICAgICAgICByZXR1cm4gaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDExOzwvY29kZT4NCiAgICAgICAqLw0KDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRUYWdzT3JEZWZhdWx0KA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcga2V5LA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgZGVmYXVsdFZhbHVlKSB7DQogICAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgICAgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBtYXAgPQ0KICAgICAgICAgICAgaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCk7DQogICAgICAgIHJldHVybiBtYXAuY29udGFpbnNLZXkoa2V5KSA/IG1hcC5nZXQoa2V5KSA6IGRlZmF1bHRWYWx1ZTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gMTE7PC9jb2RlPg0KICAgICAgICovDQoNCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFRhZ3NPclRocm93KA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcga2V5KSB7DQogICAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgICAgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBtYXAgPQ0KICAgICAgICAgICAgaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCk7DQogICAgICAgIGlmICghbWFwLmNvbnRhaW5zS2V5KGtleSkpIHsNCiAgICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLklsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbigpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBtYXAuZ2V0KGtleSk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyVGFncygpIHsNCiAgICAgICAgaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpLmdldE11dGFibGVNYXAoKQ0KICAgICAgICAgICAgLmNsZWFyKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSAxMTs8L2NvZGU+DQogICAgICAgKi8NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgcmVtb3ZlVGFncygNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSkgew0KICAgICAgICBpZiAoa2V5ID09IG51bGwpIHsgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOyB9DQogICAgICAgIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKS5nZXRNdXRhYmxlTWFwKCkNCiAgICAgICAgICAgIC5yZW1vdmUoa2V5KTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIFVzZSBhbHRlcm5hdGUgbXV0YXRpb24gYWNjZXNzb3JzIGluc3RlYWQuDQogICAgICAgKi8NCiAgICAgIEBqYXZhLmxhbmcuRGVwcmVjYXRlZA0KICAgICAgcHVibGljIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4NCiAgICAgIGdldE11dGFibGVUYWdzKCkgew0KICAgICAgICByZXR1cm4gaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpLmdldE11dGFibGVNYXAoKTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gMTE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBwdXRUYWdzKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcga2V5LA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgICAgaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpLmdldE11dGFibGVNYXAoKQ0KICAgICAgICAgICAgLnB1dChrZXksIHZhbHVlKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDExOzwvY29kZT4NCiAgICAgICAqLw0KDQogICAgICBwdWJsaWMgQnVpbGRlciBwdXRBbGxUYWdzKA0KICAgICAgICAgIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gdmFsdWVzKSB7DQogICAgICAgIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKS5nZXRNdXRhYmxlTWFwKCkNCiAgICAgICAgICAgIC5wdXRBbGwodmFsdWVzKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBzZXRVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLnNldFVua25vd25GaWVsZHNQcm90bzModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIG1lcmdlVW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5tZXJnZVVua25vd25GaWVsZHModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCg0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfc2NvcGU6a3ViZW1xLlJlc3BvbnNlKQ0KICAgIH0NCg0KICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChjbGFzc19zY29wZTprdWJlbXEuUmVzcG9uc2UpDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZXNwb25zZSBERUZBVUxUX0lOU1RBTkNFOw0KICAgIHN0YXRpYyB7DQogICAgICBERUZBVUxUX0lOU1RBTkNFID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzcG9uc2UoKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzcG9uc2UgZ2V0RGVmYXVsdEluc3RhbmNlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UmVzcG9uc2U+DQogICAgICAgIFBBUlNFUiA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkFic3RyYWN0UGFyc2VyPFJlc3BvbnNlPigpIHsNCiAgICAgIHB1YmxpYyBSZXNwb25zZSBwYXJzZVBhcnRpYWxGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgICByZXR1cm4gbmV3IFJlc3BvbnNlKGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICB9DQogICAgfTsNCg0KICAgIHB1YmxpYyBzdGF0aWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UmVzcG9uc2U+IHBhcnNlcigpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxSZXNwb25zZT4gZ2V0UGFyc2VyRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVzcG9uc2UgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFOw0KICAgIH0NCg0KICB9DQoNCiAgcHVibGljIGludGVyZmFjZSBRdWV1ZU1lc3NhZ2VPckJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGludGVyZmFjZV9leHRlbmRzOmt1YmVtcS5RdWV1ZU1lc3NhZ2UpDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLk1lc3NhZ2VPckJ1aWxkZXIgew0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1lc3NhZ2VJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0TWVzc2FnZUlEKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1lc3NhZ2VJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRNZXNzYWdlSURCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRDbGllbnRJRCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRDbGllbnRJREJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2hhbm5lbCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldENoYW5uZWxCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNDs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRNZXRhZGF0YSgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBNZXRhZGF0YSA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRNZXRhZGF0YUJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5ieXRlcyBCb2R5ID0gNTs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGdldEJvZHkoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDY7PC9jb2RlPg0KICAgICAqLw0KICAgIGludCBnZXRUYWdzQ291bnQoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA2OzwvY29kZT4NCiAgICAgKi8NCiAgICBib29sZWFuIGNvbnRhaW5zVGFncygNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpOw0KICAgIC8qKg0KICAgICAqIFVzZSB7QGxpbmsgI2dldFRhZ3NNYXAoKX0gaW5zdGVhZC4NCiAgICAgKi8NCiAgICBAamF2YS5sYW5nLkRlcHJlY2F0ZWQNCiAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+DQogICAgZ2V0VGFncygpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDY7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4NCiAgICBnZXRUYWdzTWFwKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNjs8L2NvZGU+DQogICAgICovDQoNCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldFRhZ3NPckRlZmF1bHQoDQogICAgICAgIGphdmEubGFuZy5TdHJpbmcga2V5LA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGRlZmF1bHRWYWx1ZSk7DQogICAgLyoqDQogICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNjs8L2NvZGU+DQogICAgICovDQoNCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldFRhZ3NPclRocm93KA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgQXR0cmlidXRlcyA9IDc7PC9jb2RlPg0KICAgICAqLw0KICAgIGJvb2xlYW4gaGFzQXR0cmlidXRlcygpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcyBBdHRyaWJ1dGVzID0gNzs8L2NvZGU+DQogICAgICovDQogICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIGdldEF0dHJpYnV0ZXMoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgQXR0cmlidXRlcyA9IDc7PC9jb2RlPg0KICAgICAqLw0KICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlc09yQnVpbGRlciBnZXRBdHRyaWJ1dGVzT3JCdWlsZGVyKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBQb2xpY3kgPSA4OzwvY29kZT4NCiAgICAgKi8NCiAgICBib29sZWFuIGhhc1BvbGljeSgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IFBvbGljeSA9IDg7PC9jb2RlPg0KICAgICAqLw0KICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IGdldFBvbGljeSgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IFBvbGljeSA9IDg7PC9jb2RlPg0KICAgICAqLw0KICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5T3JCdWlsZGVyIGdldFBvbGljeU9yQnVpbGRlcigpOw0KICB9DQogIC8qKg0KICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuUXVldWVNZXNzYWdlfQ0KICAgKi8NCiAgcHVibGljICBzdGF0aWMgZmluYWwgY2xhc3MgUXVldWVNZXNzYWdlIGV4dGVuZHMNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzIGltcGxlbWVudHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChtZXNzYWdlX2ltcGxlbWVudHM6a3ViZW1xLlF1ZXVlTWVzc2FnZSkNCiAgICAgIFF1ZXVlTWVzc2FnZU9yQnVpbGRlciB7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGxvbmcgc2VyaWFsVmVyc2lvblVJRCA9IDBMOw0KICAgIC8vIFVzZSBRdWV1ZU1lc3NhZ2UubmV3QnVpbGRlcigpIHRvIGNvbnN0cnVjdC4NCiAgICBwcml2YXRlIFF1ZXVlTWVzc2FnZShjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPD8+IGJ1aWxkZXIpIHsNCiAgICAgIHN1cGVyKGJ1aWxkZXIpOw0KICAgIH0NCiAgICBwcml2YXRlIFF1ZXVlTWVzc2FnZSgpIHsNCiAgICAgIG1lc3NhZ2VJRF8gPSAiIjsNCiAgICAgIGNsaWVudElEXyA9ICIiOw0KICAgICAgY2hhbm5lbF8gPSAiIjsNCiAgICAgIG1ldGFkYXRhXyA9ICIiOw0KICAgICAgYm9keV8gPSBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuRU1QVFk7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldA0KICAgIGdldFVua25vd25GaWVsZHMoKSB7DQogICAgICByZXR1cm4gdGhpcy51bmtub3duRmllbGRzOw0KICAgIH0NCiAgICBwcml2YXRlIFF1ZXVlTWVzc2FnZSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHRoaXMoKTsNCiAgICAgIGlmIChleHRlbnNpb25SZWdpc3RyeSA9PSBudWxsKSB7DQogICAgICAgIHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgICAgIH0NCiAgICAgIGludCBtdXRhYmxlX2JpdEZpZWxkMF8gPSAwOw0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQuQnVpbGRlciB1bmtub3duRmllbGRzID0NCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldC5uZXdCdWlsZGVyKCk7DQogICAgICB0cnkgew0KICAgICAgICBib29sZWFuIGRvbmUgPSBmYWxzZTsNCiAgICAgICAgd2hpbGUgKCFkb25lKSB7DQogICAgICAgICAgaW50IHRhZyA9IGlucHV0LnJlYWRUYWcoKTsNCiAgICAgICAgICBzd2l0Y2ggKHRhZykgew0KICAgICAgICAgICAgY2FzZSAwOg0KICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICBkZWZhdWx0OiB7DQogICAgICAgICAgICAgIGlmICghcGFyc2VVbmtub3duRmllbGRQcm90bzMoDQogICAgICAgICAgICAgICAgICBpbnB1dCwgdW5rbm93bkZpZWxkcywgZXh0ZW5zaW9uUmVnaXN0cnksIHRhZykpIHsNCiAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMTA6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgbWVzc2FnZUlEXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAxODogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICBjbGllbnRJRF8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMjY6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgY2hhbm5lbF8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMzQ6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgbWV0YWRhdGFfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDQyOiB7DQoNCiAgICAgICAgICAgICAgYm9keV8gPSBpbnB1dC5yZWFkQnl0ZXMoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDUwOiB7DQogICAgICAgICAgICAgIGlmICghKChtdXRhYmxlX2JpdEZpZWxkMF8gJiAweDAwMDAwMDIwKSA9PSAweDAwMDAwMDIwKSkgew0KICAgICAgICAgICAgICAgIHRhZ3NfID0gY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZC5uZXdNYXBGaWVsZCgNCiAgICAgICAgICAgICAgICAgICAgVGFnc0RlZmF1bHRFbnRyeUhvbGRlci5kZWZhdWx0RW50cnkpOw0KICAgICAgICAgICAgICAgIG11dGFibGVfYml0RmllbGQwXyB8PSAweDAwMDAwMDIwOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRW50cnk8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4NCiAgICAgICAgICAgICAgdGFnc19fID0gaW5wdXQucmVhZE1lc3NhZ2UoDQogICAgICAgICAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeS5nZXRQYXJzZXJGb3JUeXBlKCksIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgICAgICAgICAgdGFnc18uZ2V0TXV0YWJsZU1hcCgpLnB1dCgNCiAgICAgICAgICAgICAgICAgIHRhZ3NfXy5nZXRLZXkoKSwgdGFnc19fLmdldFZhbHVlKCkpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNTg6IHsNCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzLkJ1aWxkZXIgc3ViQnVpbGRlciA9IG51bGw7DQogICAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVzXyAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgc3ViQnVpbGRlciA9IGF0dHJpYnV0ZXNfLnRvQnVpbGRlcigpOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGF0dHJpYnV0ZXNfID0gaW5wdXQucmVhZE1lc3NhZ2UoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzLnBhcnNlcigpLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICAgICAgICAgIGlmIChzdWJCdWlsZGVyICE9IG51bGwpIHsNCiAgICAgICAgICAgICAgICBzdWJCdWlsZGVyLm1lcmdlRnJvbShhdHRyaWJ1dGVzXyk7DQogICAgICAgICAgICAgICAgYXR0cmlidXRlc18gPSBzdWJCdWlsZGVyLmJ1aWxkUGFydGlhbCgpOw0KICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDY2OiB7DQogICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5LkJ1aWxkZXIgc3ViQnVpbGRlciA9IG51bGw7DQogICAgICAgICAgICAgIGlmIChwb2xpY3lfICE9IG51bGwpIHsNCiAgICAgICAgICAgICAgICBzdWJCdWlsZGVyID0gcG9saWN5Xy50b0J1aWxkZXIoKTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICBwb2xpY3lfID0gaW5wdXQucmVhZE1lc3NhZ2UoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kucGFyc2VyKCksIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgICAgICAgICAgaWYgKHN1YkJ1aWxkZXIgIT0gbnVsbCkgew0KICAgICAgICAgICAgICAgIHN1YkJ1aWxkZXIubWVyZ2VGcm9tKHBvbGljeV8pOw0KICAgICAgICAgICAgICAgIHBvbGljeV8gPSBzdWJCdWlsZGVyLmJ1aWxkUGFydGlhbCgpOw0KICAgICAgICAgICAgICB9DQoNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9IGNhdGNoIChjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IGUuc2V0VW5maW5pc2hlZE1lc3NhZ2UodGhpcyk7DQogICAgICB9IGNhdGNoIChqYXZhLmlvLklPRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgdGhyb3cgbmV3IGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uKA0KICAgICAgICAgICAgZSkuc2V0VW5maW5pc2hlZE1lc3NhZ2UodGhpcyk7DQogICAgICB9IGZpbmFsbHkgew0KICAgICAgICB0aGlzLnVua25vd25GaWVsZHMgPSB1bmtub3duRmllbGRzLmJ1aWxkKCk7DQogICAgICAgIG1ha2VFeHRlbnNpb25zSW1tdXRhYmxlKCk7DQogICAgICB9DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZV9kZXNjcmlwdG9yOw0KICAgIH0NCg0KICAgIEBTdXBwcmVzc1dhcm5pbmdzKHsicmF3dHlwZXMifSkNCiAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZCBpbnRlcm5hbEdldE1hcEZpZWxkKA0KICAgICAgICBpbnQgbnVtYmVyKSB7DQogICAgICBzd2l0Y2ggKG51bWJlcikgew0KICAgICAgICBjYXNlIDY6DQogICAgICAgICAgcmV0dXJuIGludGVybmFsR2V0VGFncygpOw0KICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXhjZXB0aW9uKA0KICAgICAgICAgICAgICAiSW52YWxpZCBtYXAgZmllbGQgbnVtYmVyOiAiICsgbnVtYmVyKTsNCiAgICAgIH0NCiAgICB9DQogICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlX2ZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICAgIC5lbnN1cmVGaWVsZEFjY2Vzc29yc0luaXRpYWxpemVkKA0KICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5jbGFzcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlci5jbGFzcyk7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBpbnQgYml0RmllbGQwXzsNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNRVNTQUdFSURfRklFTERfTlVNQkVSID0gMTsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgbWVzc2FnZUlEXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgTWVzc2FnZUlEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0TWVzc2FnZUlEKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBtZXNzYWdlSURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIG1lc3NhZ2VJRF8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1lc3NhZ2VJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0TWVzc2FnZUlEQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1lc3NhZ2VJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgbWVzc2FnZUlEXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDTElFTlRJRF9GSUVMRF9OVU1CRVIgPSAyOw0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBjbGllbnRJRF87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2xpZW50SUQoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNsaWVudElEXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBjbGllbnRJRF8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRDbGllbnRJREJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjbGllbnRJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgY2xpZW50SURfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENIQU5ORUxfRklFTERfTlVNQkVSID0gMzsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgY2hhbm5lbF87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDaGFubmVsKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBjaGFubmVsXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0Q2hhbm5lbEJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICBjaGFubmVsXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNRVRBREFUQV9GSUVMRF9OVU1CRVIgPSA0Ow0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBtZXRhZGF0YV87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNDs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0TWV0YWRhdGEoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1ldGFkYXRhXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBtZXRhZGF0YV8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNDs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRNZXRhZGF0YUJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBtZXRhZGF0YV87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgbWV0YWRhdGFfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEJPRFlfRklFTERfTlVNQkVSID0gNTsNCiAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBib2R5XzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5ieXRlcyBCb2R5ID0gNTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBnZXRCb2R5KCkgew0KICAgICAgcmV0dXJuIGJvZHlfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFRBR1NfRklFTERfTlVNQkVSID0gNjsNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjbGFzcyBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyIHsNCiAgICAgIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEVudHJ5PA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IGRlZmF1bHRFbnRyeSA9DQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRW50cnkNCiAgICAgICAgICAgICAgLjxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPm5ld0RlZmF1bHRJbnN0YW5jZSgNCiAgICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VfVGFnc0VudHJ5X2Rlc2NyaXB0b3IsIA0KICAgICAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5XaXJlRm9ybWF0LkZpZWxkVHlwZS5TVFJJTkcsDQogICAgICAgICAgICAgICAgICAiIiwNCiAgICAgICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuV2lyZUZvcm1hdC5GaWVsZFR5cGUuU1RSSU5HLA0KICAgICAgICAgICAgICAgICAgIiIpOw0KICAgIH0NCiAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQ8DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IHRhZ3NfOw0KICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgIGludGVybmFsR2V0VGFncygpIHsNCiAgICAgIGlmICh0YWdzXyA9PSBudWxsKSB7DQogICAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkLmVtcHR5TWFwRmllbGQoDQogICAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeSk7DQogICAgICB9DQogICAgICByZXR1cm4gdGFnc187DQogICAgfQ0KDQogICAgcHVibGljIGludCBnZXRUYWdzQ291bnQoKSB7DQogICAgICByZXR1cm4gaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCkuc2l6ZSgpOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA2OzwvY29kZT4NCiAgICAgKi8NCg0KICAgIHB1YmxpYyBib29sZWFuIGNvbnRhaW5zVGFncygNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpIHsNCiAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKS5jb250YWluc0tleShrZXkpOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiBVc2Uge0BsaW5rICNnZXRUYWdzTWFwKCl9IGluc3RlYWQuDQogICAgICovDQogICAgQGphdmEubGFuZy5EZXByZWNhdGVkDQogICAgcHVibGljIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gZ2V0VGFncygpIHsNCiAgICAgIHJldHVybiBnZXRUYWdzTWFwKCk7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDY7PC9jb2RlPg0KICAgICAqLw0KDQogICAgcHVibGljIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gZ2V0VGFnc01hcCgpIHsNCiAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNjs8L2NvZGU+DQogICAgICovDQoNCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRUYWdzT3JEZWZhdWx0KA0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSwNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBkZWZhdWx0VmFsdWUpIHsNCiAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gbWFwID0NCiAgICAgICAgICBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICAgIHJldHVybiBtYXAuY29udGFpbnNLZXkoa2V5KSA/IG1hcC5nZXQoa2V5KSA6IGRlZmF1bHRWYWx1ZTsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNjs8L2NvZGU+DQogICAgICovDQoNCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRUYWdzT3JUaHJvdygNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpIHsNCiAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gbWFwID0NCiAgICAgICAgICBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICAgIGlmICghbWFwLmNvbnRhaW5zS2V5KGtleSkpIHsNCiAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5JbGxlZ2FsQXJndW1lbnRFeGNlcHRpb24oKTsNCiAgICAgIH0NCiAgICAgIHJldHVybiBtYXAuZ2V0KGtleSk7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQVRUUklCVVRFU19GSUVMRF9OVU1CRVIgPSA3Ow0KICAgIHByaXZhdGUgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIGF0dHJpYnV0ZXNfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcyBBdHRyaWJ1dGVzID0gNzs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGJvb2xlYW4gaGFzQXR0cmlidXRlcygpIHsNCiAgICAgIHJldHVybiBhdHRyaWJ1dGVzXyAhPSBudWxsOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgQXR0cmlidXRlcyA9IDc7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgZ2V0QXR0cmlidXRlcygpIHsNCiAgICAgIHJldHVybiBhdHRyaWJ1dGVzXyA9PSBudWxsID8gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzLmdldERlZmF1bHRJbnN0YW5jZSgpIDogYXR0cmlidXRlc187DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcyBBdHRyaWJ1dGVzID0gNzs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlc09yQnVpbGRlciBnZXRBdHRyaWJ1dGVzT3JCdWlsZGVyKCkgew0KICAgICAgcmV0dXJuIGdldEF0dHJpYnV0ZXMoKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBQT0xJQ1lfRklFTERfTlVNQkVSID0gODsNCiAgICBwcml2YXRlIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IHBvbGljeV87DQogICAgLyoqDQogICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgUG9saWN5ID0gODs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGJvb2xlYW4gaGFzUG9saWN5KCkgew0KICAgICAgcmV0dXJuIHBvbGljeV8gIT0gbnVsbDsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgUG9saWN5ID0gODs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IGdldFBvbGljeSgpIHsNCiAgICAgIHJldHVybiBwb2xpY3lfID09IG51bGwgPyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeS5nZXREZWZhdWx0SW5zdGFuY2UoKSA6IHBvbGljeV87DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IFBvbGljeSA9IDg7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeU9yQnVpbGRlciBnZXRQb2xpY3lPckJ1aWxkZXIoKSB7DQogICAgICByZXR1cm4gZ2V0UG9saWN5KCk7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBieXRlIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IC0xOw0KICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICBieXRlIGlzSW5pdGlhbGl6ZWQgPSBtZW1vaXplZElzSW5pdGlhbGl6ZWQ7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAxKSByZXR1cm4gdHJ1ZTsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDApIHJldHVybiBmYWxzZTsNCg0KICAgICAgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gMTsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCg0KICAgIHB1YmxpYyB2b2lkIHdyaXRlVG8oY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbSBvdXRwdXQpDQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICBpZiAoIWdldE1lc3NhZ2VJREJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLndyaXRlU3RyaW5nKG91dHB1dCwgMSwgbWVzc2FnZUlEXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldENsaWVudElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAyLCBjbGllbnRJRF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRDaGFubmVsQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAzLCBjaGFubmVsXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldE1ldGFkYXRhQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCA0LCBtZXRhZGF0YV8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFib2R5Xy5pc0VtcHR5KCkpIHsNCiAgICAgICAgb3V0cHV0LndyaXRlQnl0ZXMoNSwgYm9keV8pOw0KICAgICAgfQ0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgLnNlcmlhbGl6ZVN0cmluZ01hcFRvKA0KICAgICAgICAgIG91dHB1dCwNCiAgICAgICAgICBpbnRlcm5hbEdldFRhZ3MoKSwNCiAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeSwNCiAgICAgICAgICA2KTsNCiAgICAgIGlmIChhdHRyaWJ1dGVzXyAhPSBudWxsKSB7DQogICAgICAgIG91dHB1dC53cml0ZU1lc3NhZ2UoNywgZ2V0QXR0cmlidXRlcygpKTsNCiAgICAgIH0NCiAgICAgIGlmIChwb2xpY3lfICE9IG51bGwpIHsNCiAgICAgICAgb3V0cHV0LndyaXRlTWVzc2FnZSg4LCBnZXRQb2xpY3koKSk7DQogICAgICB9DQogICAgICB1bmtub3duRmllbGRzLndyaXRlVG8ob3V0cHV0KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW50IGdldFNlcmlhbGl6ZWRTaXplKCkgew0KICAgICAgaW50IHNpemUgPSBtZW1vaXplZFNpemU7DQogICAgICBpZiAoc2l6ZSAhPSAtMSkgcmV0dXJuIHNpemU7DQoNCiAgICAgIHNpemUgPSAwOw0KICAgICAgaWYgKCFnZXRNZXNzYWdlSURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDEsIG1lc3NhZ2VJRF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRDbGllbnRJREJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoMiwgY2xpZW50SURfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0Q2hhbm5lbEJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoMywgY2hhbm5lbF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRNZXRhZGF0YUJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoNCwgbWV0YWRhdGFfKTsNCiAgICAgIH0NCiAgICAgIGlmICghYm9keV8uaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlQnl0ZXNTaXplKDUsIGJvZHlfKTsNCiAgICAgIH0NCiAgICAgIGZvciAoamF2YS51dGlsLk1hcC5FbnRyeTxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBlbnRyeQ0KICAgICAgICAgICA6IGludGVybmFsR2V0VGFncygpLmdldE1hcCgpLmVudHJ5U2V0KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBFbnRyeTxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPg0KICAgICAgICB0YWdzX18gPSBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeS5uZXdCdWlsZGVyRm9yVHlwZSgpDQogICAgICAgICAgICAuc2V0S2V5KGVudHJ5LmdldEtleSgpKQ0KICAgICAgICAgICAgLnNldFZhbHVlKGVudHJ5LmdldFZhbHVlKCkpDQogICAgICAgICAgICAuYnVpbGQoKTsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgICAuY29tcHV0ZU1lc3NhZ2VTaXplKDYsIHRhZ3NfXyk7DQogICAgICB9DQogICAgICBpZiAoYXR0cmlidXRlc18gIT0gbnVsbCkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZU1lc3NhZ2VTaXplKDcsIGdldEF0dHJpYnV0ZXMoKSk7DQogICAgICB9DQogICAgICBpZiAocG9saWN5XyAhPSBudWxsKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlTWVzc2FnZVNpemUoOCwgZ2V0UG9saWN5KCkpOw0KICAgICAgfQ0KICAgICAgc2l6ZSArPSB1bmtub3duRmllbGRzLmdldFNlcmlhbGl6ZWRTaXplKCk7DQogICAgICBtZW1vaXplZFNpemUgPSBzaXplOw0KICAgICAgcmV0dXJuIHNpemU7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBib29sZWFuIGVxdWFscyhmaW5hbCBqYXZhLmxhbmcuT2JqZWN0IG9iaikgew0KICAgICAgaWYgKG9iaiA9PSB0aGlzKSB7DQogICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgICBpZiAoIShvYmogaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSkpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLmVxdWFscyhvYmopOw0KICAgICAgfQ0KICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2Ugb3RoZXIgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UpIG9iajsNCg0KICAgICAgYm9vbGVhbiByZXN1bHQgPSB0cnVlOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldE1lc3NhZ2VJRCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRNZXNzYWdlSUQoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0Q2xpZW50SUQoKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0Q2xpZW50SUQoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0Q2hhbm5lbCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRDaGFubmVsKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldE1ldGFkYXRhKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldE1ldGFkYXRhKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldEJvZHkoKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0Qm9keSgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBpbnRlcm5hbEdldFRhZ3MoKS5lcXVhbHMoDQogICAgICAgICAgb3RoZXIuaW50ZXJuYWxHZXRUYWdzKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChoYXNBdHRyaWJ1dGVzKCkgPT0gb3RoZXIuaGFzQXR0cmlidXRlcygpKTsNCiAgICAgIGlmIChoYXNBdHRyaWJ1dGVzKCkpIHsNCiAgICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldEF0dHJpYnV0ZXMoKQ0KICAgICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRBdHRyaWJ1dGVzKCkpOw0KICAgICAgfQ0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChoYXNQb2xpY3koKSA9PSBvdGhlci5oYXNQb2xpY3koKSk7DQogICAgICBpZiAoaGFzUG9saWN5KCkpIHsNCiAgICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldFBvbGljeSgpDQogICAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldFBvbGljeSgpKTsNCiAgICAgIH0NCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiB1bmtub3duRmllbGRzLmVxdWFscyhvdGhlci51bmtub3duRmllbGRzKTsNCiAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBpbnQgaGFzaENvZGUoKSB7DQogICAgICBpZiAobWVtb2l6ZWRIYXNoQ29kZSAhPSAwKSB7DQogICAgICAgIHJldHVybiBtZW1vaXplZEhhc2hDb2RlOw0KICAgICAgfQ0KICAgICAgaW50IGhhc2ggPSA0MTsNCiAgICAgIGhhc2ggPSAoMTkgKiBoYXNoKSArIGdldERlc2NyaXB0b3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgTUVTU0FHRUlEX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldE1lc3NhZ2VJRCgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBDTElFTlRJRF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRDbGllbnRJRCgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBDSEFOTkVMX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldENoYW5uZWwoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgTUVUQURBVEFfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0TWV0YWRhdGEoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgQk9EWV9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRCb2R5KCkuaGFzaENvZGUoKTsNCiAgICAgIGlmICghaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFRBR1NfRklFTERfTlVNQkVSOw0KICAgICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBpbnRlcm5hbEdldFRhZ3MoKS5oYXNoQ29kZSgpOw0KICAgICAgfQ0KICAgICAgaWYgKGhhc0F0dHJpYnV0ZXMoKSkgew0KICAgICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBBVFRSSUJVVEVTX0ZJRUxEX05VTUJFUjsNCiAgICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0QXR0cmlidXRlcygpLmhhc2hDb2RlKCk7DQogICAgICB9DQogICAgICBpZiAoaGFzUG9saWN5KCkpIHsNCiAgICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgUE9MSUNZX0ZJRUxEX05VTUJFUjsNCiAgICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0UG9saWN5KCkuaGFzaENvZGUoKTsNCiAgICAgIH0NCiAgICAgIGhhc2ggPSAoMjkgKiBoYXNoKSArIHVua25vd25GaWVsZHMuaGFzaENvZGUoKTsNCiAgICAgIG1lbW9pemVkSGFzaENvZGUgPSBoYXNoOw0KICAgICAgcmV0dXJuIGhhc2g7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBwYXJzZUZyb20oDQogICAgICAgIGphdmEubmlvLkJ5dGVCdWZmZXIgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlIHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5uaW8uQnl0ZUJ1ZmZlciBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgcGFyc2VGcm9tKGJ5dGVbXSBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgcGFyc2VGcm9tKA0KICAgICAgICBieXRlW10gZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgcGFyc2VGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBwYXJzZUZyb20oDQogICAgICAgIGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlIHBhcnNlRGVsaW1pdGVkRnJvbShqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VEZWxpbWl0ZWRXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgcGFyc2VEZWxpbWl0ZWRGcm9tKA0KICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgQnVpbGRlciBuZXdCdWlsZGVyRm9yVHlwZSgpIHsgcmV0dXJuIG5ld0J1aWxkZXIoKTsgfQ0KICAgIHB1YmxpYyBzdGF0aWMgQnVpbGRlciBuZXdCdWlsZGVyKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgQnVpbGRlciBuZXdCdWlsZGVyKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlIHByb3RvdHlwZSkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCkubWVyZ2VGcm9tKHByb3RvdHlwZSk7DQogICAgfQ0KICAgIHB1YmxpYyBCdWlsZGVyIHRvQnVpbGRlcigpIHsNCiAgICAgIHJldHVybiB0aGlzID09IERFRkFVTFRfSU5TVEFOQ0UNCiAgICAgICAgICA/IG5ldyBCdWlsZGVyKCkgOiBuZXcgQnVpbGRlcigpLm1lcmdlRnJvbSh0aGlzKTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHJvdGVjdGVkIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXJQYXJlbnQgcGFyZW50KSB7DQogICAgICBCdWlsZGVyIGJ1aWxkZXIgPSBuZXcgQnVpbGRlcihwYXJlbnQpOw0KICAgICAgcmV0dXJuIGJ1aWxkZXI7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5RdWV1ZU1lc3NhZ2V9DQogICAgICovDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBjbGFzcyBCdWlsZGVyIGV4dGVuZHMNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlcjxCdWlsZGVyPiBpbXBsZW1lbnRzDQogICAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChidWlsZGVyX2ltcGxlbWVudHM6a3ViZW1xLlF1ZXVlTWVzc2FnZSkNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VPckJ1aWxkZXIgew0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZV9kZXNjcmlwdG9yOw0KICAgICAgfQ0KDQogICAgICBAU3VwcHJlc3NXYXJuaW5ncyh7InJhd3R5cGVzIn0pDQogICAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZCBpbnRlcm5hbEdldE1hcEZpZWxkKA0KICAgICAgICAgIGludCBudW1iZXIpIHsNCiAgICAgICAgc3dpdGNoIChudW1iZXIpIHsNCiAgICAgICAgICBjYXNlIDY6DQogICAgICAgICAgICByZXR1cm4gaW50ZXJuYWxHZXRUYWdzKCk7DQogICAgICAgICAgZGVmYXVsdDoNCiAgICAgICAgICAgIHRocm93IG5ldyBSdW50aW1lRXhjZXB0aW9uKA0KICAgICAgICAgICAgICAgICJJbnZhbGlkIG1hcCBmaWVsZCBudW1iZXI6ICIgKyBudW1iZXIpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICBAU3VwcHJlc3NXYXJuaW5ncyh7InJhd3R5cGVzIn0pDQogICAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZCBpbnRlcm5hbEdldE11dGFibGVNYXBGaWVsZCgNCiAgICAgICAgICBpbnQgbnVtYmVyKSB7DQogICAgICAgIHN3aXRjaCAobnVtYmVyKSB7DQogICAgICAgICAgY2FzZSA2Og0KICAgICAgICAgICAgcmV0dXJuIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKTsNCiAgICAgICAgICBkZWZhdWx0Og0KICAgICAgICAgICAgdGhyb3cgbmV3IFJ1bnRpbWVFeGNlcHRpb24oDQogICAgICAgICAgICAgICAgIkludmFsaWQgbWFwIGZpZWxkIG51bWJlcjogIiArIG51bWJlcik7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5jbGFzcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlci5jbGFzcyk7DQogICAgICB9DQoNCiAgICAgIC8vIENvbnN0cnVjdCB1c2luZyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5uZXdCdWlsZGVyKCkNCiAgICAgIHByaXZhdGUgQnVpbGRlcigpIHsNCiAgICAgICAgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIEJ1aWxkZXIoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlclBhcmVudCBwYXJlbnQpIHsNCiAgICAgICAgc3VwZXIocGFyZW50KTsNCiAgICAgICAgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpOw0KICAgICAgfQ0KICAgICAgcHJpdmF0ZSB2b2lkIG1heWJlRm9yY2VCdWlsZGVySW5pdGlhbGl6YXRpb24oKSB7DQogICAgICAgIGlmIChjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgICAgICAgIC5hbHdheXNVc2VGaWVsZEJ1aWxkZXJzKSB7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyKCkgew0KICAgICAgICBzdXBlci5jbGVhcigpOw0KICAgICAgICBtZXNzYWdlSURfID0gIiI7DQoNCiAgICAgICAgY2xpZW50SURfID0gIiI7DQoNCiAgICAgICAgY2hhbm5lbF8gPSAiIjsNCg0KICAgICAgICBtZXRhZGF0YV8gPSAiIjsNCg0KICAgICAgICBib2R5XyA9IGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5FTVBUWTsNCg0KICAgICAgICBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkuY2xlYXIoKTsNCiAgICAgICAgaWYgKGF0dHJpYnV0ZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgYXR0cmlidXRlc18gPSBudWxsOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGF0dHJpYnV0ZXNfID0gbnVsbDsNCiAgICAgICAgICBhdHRyaWJ1dGVzQnVpbGRlcl8gPSBudWxsOw0KICAgICAgICB9DQogICAgICAgIGlmIChwb2xpY3lCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgcG9saWN5XyA9IG51bGw7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcG9saWN5XyA9IG51bGw7DQogICAgICAgICAgcG9saWN5QnVpbGRlcl8gPSBudWxsOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvckZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlX2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBnZXREZWZhdWx0SW5zdGFuY2VGb3JUeXBlKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuZ2V0RGVmYXVsdEluc3RhbmNlKCk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBidWlsZCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgcmVzdWx0ID0gYnVpbGRQYXJ0aWFsKCk7DQogICAgICAgIGlmICghcmVzdWx0LmlzSW5pdGlhbGl6ZWQoKSkgew0KICAgICAgICAgIHRocm93IG5ld1VuaW5pdGlhbGl6ZWRNZXNzYWdlRXhjZXB0aW9uKHJlc3VsdCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlIGJ1aWxkUGFydGlhbCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgcmVzdWx0ID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlKHRoaXMpOw0KICAgICAgICBpbnQgZnJvbV9iaXRGaWVsZDBfID0gYml0RmllbGQwXzsNCiAgICAgICAgaW50IHRvX2JpdEZpZWxkMF8gPSAwOw0KICAgICAgICByZXN1bHQubWVzc2FnZUlEXyA9IG1lc3NhZ2VJRF87DQogICAgICAgIHJlc3VsdC5jbGllbnRJRF8gPSBjbGllbnRJRF87DQogICAgICAgIHJlc3VsdC5jaGFubmVsXyA9IGNoYW5uZWxfOw0KICAgICAgICByZXN1bHQubWV0YWRhdGFfID0gbWV0YWRhdGFfOw0KICAgICAgICByZXN1bHQuYm9keV8gPSBib2R5XzsNCiAgICAgICAgcmVzdWx0LnRhZ3NfID0gaW50ZXJuYWxHZXRUYWdzKCk7DQogICAgICAgIHJlc3VsdC50YWdzXy5tYWtlSW1tdXRhYmxlKCk7DQogICAgICAgIGlmIChhdHRyaWJ1dGVzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIHJlc3VsdC5hdHRyaWJ1dGVzXyA9IGF0dHJpYnV0ZXNfOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJlc3VsdC5hdHRyaWJ1dGVzXyA9IGF0dHJpYnV0ZXNCdWlsZGVyXy5idWlsZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmIChwb2xpY3lCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgcmVzdWx0LnBvbGljeV8gPSBwb2xpY3lfOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJlc3VsdC5wb2xpY3lfID0gcG9saWN5QnVpbGRlcl8uYnVpbGQoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXN1bHQuYml0RmllbGQwXyA9IHRvX2JpdEZpZWxkMF87DQogICAgICAgIG9uQnVpbHQoKTsNCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xvbmUoKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xvbmUoKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyRmllbGQoZmllbGQpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJPbmVvZigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLk9uZW9mRGVzY3JpcHRvciBvbmVvZikgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyT25lb2Yob25lb2YpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBpbnQgaW5kZXgsIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRSZXBlYXRlZEZpZWxkKGZpZWxkLCBpbmRleCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgYWRkUmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuYWRkUmVwZWF0ZWRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZSBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSkgew0KICAgICAgICAgIHJldHVybiBtZXJnZUZyb20oKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlKW90aGVyKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBzdXBlci5tZXJnZUZyb20ob3RoZXIpOw0KICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbShpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgPT0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuZ2V0RGVmYXVsdEluc3RhbmNlKCkpIHJldHVybiB0aGlzOw0KICAgICAgICBpZiAoIW90aGVyLmdldE1lc3NhZ2VJRCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIG1lc3NhZ2VJRF8gPSBvdGhlci5tZXNzYWdlSURfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmICghb3RoZXIuZ2V0Q2xpZW50SUQoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICBjbGllbnRJRF8gPSBvdGhlci5jbGllbnRJRF87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRDaGFubmVsKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgY2hhbm5lbF8gPSBvdGhlci5jaGFubmVsXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIW90aGVyLmdldE1ldGFkYXRhKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgbWV0YWRhdGFfID0gb3RoZXIubWV0YWRhdGFfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRCb2R5KCkgIT0gY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLkVNUFRZKSB7DQogICAgICAgICAgc2V0Qm9keShvdGhlci5nZXRCb2R5KCkpOw0KICAgICAgICB9DQogICAgICAgIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKS5tZXJnZUZyb20oDQogICAgICAgICAgICBvdGhlci5pbnRlcm5hbEdldFRhZ3MoKSk7DQogICAgICAgIGlmIChvdGhlci5oYXNBdHRyaWJ1dGVzKCkpIHsNCiAgICAgICAgICBtZXJnZUF0dHJpYnV0ZXMob3RoZXIuZ2V0QXR0cmlidXRlcygpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuaGFzUG9saWN5KCkpIHsNCiAgICAgICAgICBtZXJnZVBvbGljeShvdGhlci5nZXRQb2xpY3koKSk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5tZXJnZVVua25vd25GaWVsZHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbSgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBwYXJzZWRNZXNzYWdlID0gbnVsbDsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gUEFSU0VSLnBhcnNlUGFydGlhbEZyb20oaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UpIGUuZ2V0VW5maW5pc2hlZE1lc3NhZ2UoKTsNCiAgICAgICAgICB0aHJvdyBlLnVud3JhcElPRXhjZXB0aW9uKCk7DQogICAgICAgIH0gZmluYWxseSB7DQogICAgICAgICAgaWYgKHBhcnNlZE1lc3NhZ2UgIT0gbnVsbCkgew0KICAgICAgICAgICAgbWVyZ2VGcm9tKHBhcnNlZE1lc3NhZ2UpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIHByaXZhdGUgaW50IGJpdEZpZWxkMF87DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCBtZXNzYWdlSURfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNZXNzYWdlSUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0TWVzc2FnZUlEKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1lc3NhZ2VJRF87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIG1lc3NhZ2VJRF8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNZXNzYWdlSUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldE1lc3NhZ2VJREJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1lc3NhZ2VJRF87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgbWVzc2FnZUlEXyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTWVzc2FnZUlEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldE1lc3NhZ2VJRCgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIG1lc3NhZ2VJRF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTWVzc2FnZUlEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyTWVzc2FnZUlEKCkgew0KICAgICAgICANCiAgICAgICAgbWVzc2FnZUlEXyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldE1lc3NhZ2VJRCgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNZXNzYWdlSUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0TWVzc2FnZUlEQnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIG1lc3NhZ2VJRF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgY2xpZW50SURfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDbGllbnRJRCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjbGllbnRJRF87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIGNsaWVudElEXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRDbGllbnRJREJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNsaWVudElEXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBjbGllbnRJRF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldENsaWVudElEKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgY2xpZW50SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyQ2xpZW50SUQoKSB7DQogICAgICAgIA0KICAgICAgICBjbGllbnRJRF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRDbGllbnRJRCgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRDbGllbnRJREJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBjbGllbnRJRF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgY2hhbm5lbF8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2hhbm5lbCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgY2hhbm5lbF8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRDaGFubmVsQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2hhbm5lbF87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgY2hhbm5lbF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2hhbm5lbCgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIGNoYW5uZWxfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJDaGFubmVsKCkgew0KICAgICAgICANCiAgICAgICAgY2hhbm5lbF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRDaGFubmVsKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2hhbm5lbEJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBjaGFubmVsXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCBtZXRhZGF0YV8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldE1ldGFkYXRhKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1ldGFkYXRhXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgbWV0YWRhdGFfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTWV0YWRhdGEgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldE1ldGFkYXRhQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gbWV0YWRhdGFfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIG1ldGFkYXRhXyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTWV0YWRhdGEgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0TWV0YWRhdGEoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBtZXRhZGF0YV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTWV0YWRhdGEgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJNZXRhZGF0YSgpIHsNCiAgICAgICAgDQogICAgICAgIG1ldGFkYXRhXyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldE1ldGFkYXRhKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1ldGFkYXRhID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldE1ldGFkYXRhQnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIG1ldGFkYXRhXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJvZHlfID0gY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLkVNUFRZOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ieXRlcyBCb2R5ID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZ2V0Qm9keSgpIHsNCiAgICAgICAgcmV0dXJuIGJvZHlfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ieXRlcyBCb2R5ID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEJvZHkoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIGJvZHlfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ynl0ZXMgQm9keSA9IDU7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckJvZHkoKSB7DQogICAgICAgIA0KICAgICAgICBib2R5XyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldEJvZHkoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQ8DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gdGFnc187DQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuTWFwRmllbGQ8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4NCiAgICAgIGludGVybmFsR2V0VGFncygpIHsNCiAgICAgICAgaWYgKHRhZ3NfID09IG51bGwpIHsNCiAgICAgICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5NYXBGaWVsZC5lbXB0eU1hcEZpZWxkKA0KICAgICAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRhZ3NfOw0KICAgICAgfQ0KICAgICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+DQogICAgICBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkgew0KICAgICAgICBvbkNoYW5nZWQoKTs7DQogICAgICAgIGlmICh0YWdzXyA9PSBudWxsKSB7DQogICAgICAgICAgdGFnc18gPSBjb20uZ29vZ2xlLnByb3RvYnVmLk1hcEZpZWxkLm5ld01hcEZpZWxkKA0KICAgICAgICAgICAgICBUYWdzRGVmYXVsdEVudHJ5SG9sZGVyLmRlZmF1bHRFbnRyeSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCF0YWdzXy5pc011dGFibGUoKSkgew0KICAgICAgICAgIHRhZ3NfID0gdGFnc18uY29weSgpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0YWdzXzsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGludCBnZXRUYWdzQ291bnQoKSB7DQogICAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKS5zaXplKCk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDY7PC9jb2RlPg0KICAgICAgICovDQoNCiAgICAgIHB1YmxpYyBib29sZWFuIGNvbnRhaW5zVGFncygNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIGtleSkgew0KICAgICAgICBpZiAoa2V5ID09IG51bGwpIHsgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOyB9DQogICAgICAgIHJldHVybiBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKS5jb250YWluc0tleShrZXkpOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiBVc2Uge0BsaW5rICNnZXRUYWdzTWFwKCl9IGluc3RlYWQuDQogICAgICAgKi8NCiAgICAgIEBqYXZhLmxhbmcuRGVwcmVjYXRlZA0KICAgICAgcHVibGljIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gZ2V0VGFncygpIHsNCiAgICAgICAgcmV0dXJuIGdldFRhZ3NNYXAoKTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNjs8L2NvZGU+DQogICAgICAgKi8NCg0KICAgICAgcHVibGljIGphdmEudXRpbC5NYXA8amF2YS5sYW5nLlN0cmluZywgamF2YS5sYW5nLlN0cmluZz4gZ2V0VGFnc01hcCgpIHsNCiAgICAgICAgcmV0dXJuIGludGVybmFsR2V0VGFncygpLmdldE1hcCgpOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5tYXAmbHQ7c3RyaW5nLCBzdHJpbmcmZ3Q7IFRhZ3MgPSA2OzwvY29kZT4NCiAgICAgICAqLw0KDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRUYWdzT3JEZWZhdWx0KA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcga2V5LA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgZGVmYXVsdFZhbHVlKSB7DQogICAgICAgIGlmIChrZXkgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgICAgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiBtYXAgPQ0KICAgICAgICAgICAgaW50ZXJuYWxHZXRUYWdzKCkuZ2V0TWFwKCk7DQogICAgICAgIHJldHVybiBtYXAuY29udGFpbnNLZXkoa2V5KSA/IG1hcC5nZXQoa2V5KSA6IGRlZmF1bHRWYWx1ZTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+bWFwJmx0O3N0cmluZywgc3RyaW5nJmd0OyBUYWdzID0gNjs8L2NvZGU+DQogICAgICAgKi8NCg0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0VGFnc09yVGhyb3coDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpIHsNCiAgICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgICBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+IG1hcCA9DQogICAgICAgICAgICBpbnRlcm5hbEdldFRhZ3MoKS5nZXRNYXAoKTsNCiAgICAgICAgaWYgKCFtYXAuY29udGFpbnNLZXkoa2V5KSkgew0KICAgICAgICAgIHRocm93IG5ldyBqYXZhLmxhbmcuSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG1hcC5nZXQoa2V5KTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJUYWdzKCkgew0KICAgICAgICBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkuZ2V0TXV0YWJsZU1hcCgpDQogICAgICAgICAgICAuY2xlYXIoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDY7PC9jb2RlPg0KICAgICAgICovDQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIHJlbW92ZVRhZ3MoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBrZXkpIHsNCiAgICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgICBpbnRlcm5hbEdldE11dGFibGVUYWdzKCkuZ2V0TXV0YWJsZU1hcCgpDQogICAgICAgICAgICAucmVtb3ZlKGtleSk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiBVc2UgYWx0ZXJuYXRlIG11dGF0aW9uIGFjY2Vzc29ycyBpbnN0ZWFkLg0KICAgICAgICovDQogICAgICBAamF2YS5sYW5nLkRlcHJlY2F0ZWQNCiAgICAgIHB1YmxpYyBqYXZhLnV0aWwuTWFwPGphdmEubGFuZy5TdHJpbmcsIGphdmEubGFuZy5TdHJpbmc+DQogICAgICBnZXRNdXRhYmxlVGFncygpIHsNCiAgICAgICAgcmV0dXJuIGludGVybmFsR2V0TXV0YWJsZVRhZ3MoKS5nZXRNdXRhYmxlTWFwKCk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDY7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBwdXRUYWdzKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcga2V5LA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKGtleSA9PSBudWxsKSB7IHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsgfQ0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgeyB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7IH0NCiAgICAgICAgaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpLmdldE11dGFibGVNYXAoKQ0KICAgICAgICAgICAgLnB1dChrZXksIHZhbHVlKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPm1hcCZsdDtzdHJpbmcsIHN0cmluZyZndDsgVGFncyA9IDY7PC9jb2RlPg0KICAgICAgICovDQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIHB1dEFsbFRhZ3MoDQogICAgICAgICAgamF2YS51dGlsLk1hcDxqYXZhLmxhbmcuU3RyaW5nLCBqYXZhLmxhbmcuU3RyaW5nPiB2YWx1ZXMpIHsNCiAgICAgICAgaW50ZXJuYWxHZXRNdXRhYmxlVGFncygpLmdldE11dGFibGVNYXAoKQ0KICAgICAgICAgICAgLnB1dEFsbCh2YWx1ZXMpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgYXR0cmlidXRlc18gPSBudWxsOw0KICAgICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLlNpbmdsZUZpZWxkQnVpbGRlclYzPA0KICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzLkJ1aWxkZXIsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlc09yQnVpbGRlcj4gYXR0cmlidXRlc0J1aWxkZXJfOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgQXR0cmlidXRlcyA9IDc7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgYm9vbGVhbiBoYXNBdHRyaWJ1dGVzKCkgew0KICAgICAgICByZXR1cm4gYXR0cmlidXRlc0J1aWxkZXJfICE9IG51bGwgfHwgYXR0cmlidXRlc18gIT0gbnVsbDsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIEF0dHJpYnV0ZXMgPSA3OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcyBnZXRBdHRyaWJ1dGVzKCkgew0KICAgICAgICBpZiAoYXR0cmlidXRlc0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICByZXR1cm4gYXR0cmlidXRlc18gPT0gbnVsbCA/IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcy5nZXREZWZhdWx0SW5zdGFuY2UoKSA6IGF0dHJpYnV0ZXNfOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiBhdHRyaWJ1dGVzQnVpbGRlcl8uZ2V0TWVzc2FnZSgpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPi5rdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcyBBdHRyaWJ1dGVzID0gNzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEF0dHJpYnV0ZXMoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIHZhbHVlKSB7DQogICAgICAgIGlmIChhdHRyaWJ1dGVzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgICAgICAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgICAgICAgICB9DQogICAgICAgICAgYXR0cmlidXRlc18gPSB2YWx1ZTsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBhdHRyaWJ1dGVzQnVpbGRlcl8uc2V0TWVzc2FnZSh2YWx1ZSk7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIEF0dHJpYnV0ZXMgPSA3OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0QXR0cmlidXRlcygNCiAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMuQnVpbGRlciBidWlsZGVyRm9yVmFsdWUpIHsNCiAgICAgICAgaWYgKGF0dHJpYnV0ZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgYXR0cmlidXRlc18gPSBidWlsZGVyRm9yVmFsdWUuYnVpbGQoKTsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBhdHRyaWJ1dGVzQnVpbGRlcl8uc2V0TWVzc2FnZShidWlsZGVyRm9yVmFsdWUuYnVpbGQoKSk7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIEF0dHJpYnV0ZXMgPSA3OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VBdHRyaWJ1dGVzKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcyB2YWx1ZSkgew0KICAgICAgICBpZiAoYXR0cmlidXRlc0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBpZiAoYXR0cmlidXRlc18gIT0gbnVsbCkgew0KICAgICAgICAgICAgYXR0cmlidXRlc18gPQ0KICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMubmV3QnVpbGRlcihhdHRyaWJ1dGVzXykubWVyZ2VGcm9tKHZhbHVlKS5idWlsZFBhcnRpYWwoKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgYXR0cmlidXRlc18gPSB2YWx1ZTsNCiAgICAgICAgICB9DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgYXR0cmlidXRlc0J1aWxkZXJfLm1lcmdlRnJvbSh2YWx1ZSk7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIEF0dHJpYnV0ZXMgPSA3OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJBdHRyaWJ1dGVzKCkgew0KICAgICAgICBpZiAoYXR0cmlidXRlc0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBhdHRyaWJ1dGVzXyA9IG51bGw7DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgYXR0cmlidXRlc18gPSBudWxsOw0KICAgICAgICAgIGF0dHJpYnV0ZXNCdWlsZGVyXyA9IG51bGw7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIEF0dHJpYnV0ZXMgPSA3OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcy5CdWlsZGVyIGdldEF0dHJpYnV0ZXNCdWlsZGVyKCkgew0KICAgICAgICANCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiBnZXRBdHRyaWJ1dGVzRmllbGRCdWlsZGVyKCkuZ2V0QnVpbGRlcigpOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgQXR0cmlidXRlcyA9IDc7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzT3JCdWlsZGVyIGdldEF0dHJpYnV0ZXNPckJ1aWxkZXIoKSB7DQogICAgICAgIGlmIChhdHRyaWJ1dGVzQnVpbGRlcl8gIT0gbnVsbCkgew0KICAgICAgICAgIHJldHVybiBhdHRyaWJ1dGVzQnVpbGRlcl8uZ2V0TWVzc2FnZU9yQnVpbGRlcigpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiBhdHRyaWJ1dGVzXyA9PSBudWxsID8NCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzLmdldERlZmF1bHRJbnN0YW5jZSgpIDogYXR0cmlidXRlc187DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIEF0dHJpYnV0ZXMgPSA3OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLlNpbmdsZUZpZWxkQnVpbGRlclYzPA0KICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzLkJ1aWxkZXIsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlc09yQnVpbGRlcj4gDQogICAgICAgICAgZ2V0QXR0cmlidXRlc0ZpZWxkQnVpbGRlcigpIHsNCiAgICAgICAgaWYgKGF0dHJpYnV0ZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgYXR0cmlidXRlc0J1aWxkZXJfID0gbmV3IGNvbS5nb29nbGUucHJvdG9idWYuU2luZ2xlRmllbGRCdWlsZGVyVjM8DQogICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzLkJ1aWxkZXIsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlc09yQnVpbGRlcj4oDQogICAgICAgICAgICAgICAgICBnZXRBdHRyaWJ1dGVzKCksDQogICAgICAgICAgICAgICAgICBnZXRQYXJlbnRGb3JDaGlsZHJlbigpLA0KICAgICAgICAgICAgICAgICAgaXNDbGVhbigpKTsNCiAgICAgICAgICBhdHRyaWJ1dGVzXyA9IG51bGw7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZXNCdWlsZGVyXzsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBwb2xpY3lfID0gbnVsbDsNCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5TaW5nbGVGaWVsZEJ1aWxkZXJWMzwNCiAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kuQnVpbGRlciwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3lPckJ1aWxkZXI+IHBvbGljeUJ1aWxkZXJfOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBQb2xpY3kgPSA4OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGJvb2xlYW4gaGFzUG9saWN5KCkgew0KICAgICAgICByZXR1cm4gcG9saWN5QnVpbGRlcl8gIT0gbnVsbCB8fCBwb2xpY3lfICE9IG51bGw7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPi5rdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IFBvbGljeSA9IDg7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgZ2V0UG9saWN5KCkgew0KICAgICAgICBpZiAocG9saWN5QnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIHJldHVybiBwb2xpY3lfID09IG51bGwgPyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeS5nZXREZWZhdWx0SW5zdGFuY2UoKSA6IHBvbGljeV87DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIHBvbGljeUJ1aWxkZXJfLmdldE1lc3NhZ2UoKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBQb2xpY3kgPSA4OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UG9saWN5KGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IHZhbHVlKSB7DQogICAgICAgIGlmIChwb2xpY3lCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICAgICAgICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBwb2xpY3lfID0gdmFsdWU7DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcG9saWN5QnVpbGRlcl8uc2V0TWVzc2FnZSh2YWx1ZSk7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgUG9saWN5ID0gODs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFBvbGljeSgNCiAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeS5CdWlsZGVyIGJ1aWxkZXJGb3JWYWx1ZSkgew0KICAgICAgICBpZiAocG9saWN5QnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIHBvbGljeV8gPSBidWlsZGVyRm9yVmFsdWUuYnVpbGQoKTsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBwb2xpY3lCdWlsZGVyXy5zZXRNZXNzYWdlKGJ1aWxkZXJGb3JWYWx1ZS5idWlsZCgpKTsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBQb2xpY3kgPSA4OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VQb2xpY3koaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgdmFsdWUpIHsNCiAgICAgICAgaWYgKHBvbGljeUJ1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBpZiAocG9saWN5XyAhPSBudWxsKSB7DQogICAgICAgICAgICBwb2xpY3lfID0NCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kubmV3QnVpbGRlcihwb2xpY3lfKS5tZXJnZUZyb20odmFsdWUpLmJ1aWxkUGFydGlhbCgpOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBwb2xpY3lfID0gdmFsdWU7DQogICAgICAgICAgfQ0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHBvbGljeUJ1aWxkZXJfLm1lcmdlRnJvbSh2YWx1ZSk7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgUG9saWN5ID0gODs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyUG9saWN5KCkgew0KICAgICAgICBpZiAocG9saWN5QnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIHBvbGljeV8gPSBudWxsOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHBvbGljeV8gPSBudWxsOw0KICAgICAgICAgIHBvbGljeUJ1aWxkZXJfID0gbnVsbDsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBQb2xpY3kgPSA4OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5LkJ1aWxkZXIgZ2V0UG9saWN5QnVpbGRlcigpIHsNCiAgICAgICAgDQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gZ2V0UG9saWN5RmllbGRCdWlsZGVyKCkuZ2V0QnVpbGRlcigpOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBQb2xpY3kgPSA4OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5T3JCdWlsZGVyIGdldFBvbGljeU9yQnVpbGRlcigpIHsNCiAgICAgICAgaWYgKHBvbGljeUJ1aWxkZXJfICE9IG51bGwpIHsNCiAgICAgICAgICByZXR1cm4gcG9saWN5QnVpbGRlcl8uZ2V0TWVzc2FnZU9yQnVpbGRlcigpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiBwb2xpY3lfID09IG51bGwgPw0KICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeS5nZXREZWZhdWx0SW5zdGFuY2UoKSA6IHBvbGljeV87DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgUG9saWN5ID0gODs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5TaW5nbGVGaWVsZEJ1aWxkZXJWMzwNCiAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kuQnVpbGRlciwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3lPckJ1aWxkZXI+IA0KICAgICAgICAgIGdldFBvbGljeUZpZWxkQnVpbGRlcigpIHsNCiAgICAgICAgaWYgKHBvbGljeUJ1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBwb2xpY3lCdWlsZGVyXyA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLlNpbmdsZUZpZWxkQnVpbGRlclYzPA0KICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kuQnVpbGRlciwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3lPckJ1aWxkZXI+KA0KICAgICAgICAgICAgICAgICAgZ2V0UG9saWN5KCksDQogICAgICAgICAgICAgICAgICBnZXRQYXJlbnRGb3JDaGlsZHJlbigpLA0KICAgICAgICAgICAgICAgICAgaXNDbGVhbigpKTsNCiAgICAgICAgICBwb2xpY3lfID0gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcG9saWN5QnVpbGRlcl87DQogICAgICB9DQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBzZXRVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLnNldFVua25vd25GaWVsZHNQcm90bzModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIG1lcmdlVW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5tZXJnZVVua25vd25GaWVsZHModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCg0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfc2NvcGU6a3ViZW1xLlF1ZXVlTWVzc2FnZSkNCiAgICB9DQoNCiAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoY2xhc3Nfc2NvcGU6a3ViZW1xLlF1ZXVlTWVzc2FnZSkNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBERUZBVUxUX0lOU1RBTkNFOw0KICAgIHN0YXRpYyB7DQogICAgICBERUZBVUxUX0lOU1RBTkNFID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlKCk7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBnZXREZWZhdWx0SW5zdGFuY2UoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRTsNCiAgICB9DQoNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxRdWV1ZU1lc3NhZ2U+DQogICAgICAgIFBBUlNFUiA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkFic3RyYWN0UGFyc2VyPFF1ZXVlTWVzc2FnZT4oKSB7DQogICAgICBwdWJsaWMgUXVldWVNZXNzYWdlIHBhcnNlUGFydGlhbEZyb20oDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICAgIHJldHVybiBuZXcgUXVldWVNZXNzYWdlKGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICB9DQogICAgfTsNCg0KICAgIHB1YmxpYyBzdGF0aWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UXVldWVNZXNzYWdlPiBwYXJzZXIoKSB7DQogICAgICByZXR1cm4gUEFSU0VSOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UXVldWVNZXNzYWdlPiBnZXRQYXJzZXJGb3JUeXBlKCkgew0KICAgICAgcmV0dXJuIFBBUlNFUjsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFOw0KICAgIH0NCg0KICB9DQoNCiAgcHVibGljIGludGVyZmFjZSBRdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0T3JCdWlsZGVyIGV4dGVuZHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChpbnRlcmZhY2VfZXh0ZW5kczprdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCkNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZU9yQnVpbGRlciB7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQmF0Y2hJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0QmF0Y2hJRCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBCYXRjaElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldEJhdGNoSURCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLnV0aWwuTGlzdDxpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZT4gDQogICAgICAgIGdldE1lc3NhZ2VzTGlzdCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICovDQogICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgZ2V0TWVzc2FnZXMoaW50IGluZGV4KTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGludCBnZXRNZXNzYWdlc0NvdW50KCk7DQogICAgLyoqDQogICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLnV0aWwuTGlzdDw/IGV4dGVuZHMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VPckJ1aWxkZXI+IA0KICAgICAgICBnZXRNZXNzYWdlc09yQnVpbGRlckxpc3QoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlT3JCdWlsZGVyIGdldE1lc3NhZ2VzT3JCdWlsZGVyKA0KICAgICAgICBpbnQgaW5kZXgpOw0KICB9DQogIC8qKg0KICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdH0NCiAgICovDQogIHB1YmxpYyAgc3RhdGljIGZpbmFsIGNsYXNzIFF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3QgZXh0ZW5kcw0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMgaW1wbGVtZW50cw0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KG1lc3NhZ2VfaW1wbGVtZW50czprdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCkNCiAgICAgIFF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3RPckJ1aWxkZXIgew0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBsb25nIHNlcmlhbFZlcnNpb25VSUQgPSAwTDsNCiAgICAvLyBVc2UgUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdC5uZXdCdWlsZGVyKCkgdG8gY29uc3RydWN0Lg0KICAgIHByaXZhdGUgUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdChjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPD8+IGJ1aWxkZXIpIHsNCiAgICAgIHN1cGVyKGJ1aWxkZXIpOw0KICAgIH0NCiAgICBwcml2YXRlIFF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3QoKSB7DQogICAgICBiYXRjaElEXyA9ICIiOw0KICAgICAgbWVzc2FnZXNfID0gamF2YS51dGlsLkNvbGxlY3Rpb25zLmVtcHR5TGlzdCgpOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQNCiAgICBnZXRVbmtub3duRmllbGRzKCkgew0KICAgICAgcmV0dXJuIHRoaXMudW5rbm93bkZpZWxkczsNCiAgICB9DQogICAgcHJpdmF0ZSBRdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0KA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgdGhpcygpOw0KICAgICAgaWYgKGV4dGVuc2lvblJlZ2lzdHJ5ID09IG51bGwpIHsNCiAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgfQ0KICAgICAgaW50IG11dGFibGVfYml0RmllbGQwXyA9IDA7DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldC5CdWlsZGVyIHVua25vd25GaWVsZHMgPQ0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0Lm5ld0J1aWxkZXIoKTsNCiAgICAgIHRyeSB7DQogICAgICAgIGJvb2xlYW4gZG9uZSA9IGZhbHNlOw0KICAgICAgICB3aGlsZSAoIWRvbmUpIHsNCiAgICAgICAgICBpbnQgdGFnID0gaW5wdXQucmVhZFRhZygpOw0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7DQogICAgICAgICAgICBjYXNlIDA6DQogICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGRlZmF1bHQ6IHsNCiAgICAgICAgICAgICAgaWYgKCFwYXJzZVVua25vd25GaWVsZFByb3RvMygNCiAgICAgICAgICAgICAgICAgIGlucHV0LCB1bmtub3duRmllbGRzLCBleHRlbnNpb25SZWdpc3RyeSwgdGFnKSkgew0KICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAxMDogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICBiYXRjaElEXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAxODogew0KICAgICAgICAgICAgICBpZiAoISgobXV0YWJsZV9iaXRGaWVsZDBfICYgMHgwMDAwMDAwMikgPT0gMHgwMDAwMDAwMikpIHsNCiAgICAgICAgICAgICAgICBtZXNzYWdlc18gPSBuZXcgamF2YS51dGlsLkFycmF5TGlzdDxpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZT4oKTsNCiAgICAgICAgICAgICAgICBtdXRhYmxlX2JpdEZpZWxkMF8gfD0gMHgwMDAwMDAwMjsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICBtZXNzYWdlc18uYWRkKA0KICAgICAgICAgICAgICAgICAgaW5wdXQucmVhZE1lc3NhZ2UoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UucGFyc2VyKCksIGV4dGVuc2lvblJlZ2lzdHJ5KSk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBlLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBjYXRjaCAoamF2YS5pby5JT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbigNCiAgICAgICAgICAgIGUpLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgaWYgKCgobXV0YWJsZV9iaXRGaWVsZDBfICYgMHgwMDAwMDAwMikgPT0gMHgwMDAwMDAwMikpIHsNCiAgICAgICAgICBtZXNzYWdlc18gPSBqYXZhLnV0aWwuQ29sbGVjdGlvbnMudW5tb2RpZmlhYmxlTGlzdChtZXNzYWdlc18pOw0KICAgICAgICB9DQogICAgICAgIHRoaXMudW5rbm93bkZpZWxkcyA9IHVua25vd25GaWVsZHMuYnVpbGQoKTsNCiAgICAgICAgbWFrZUV4dGVuc2lvbnNJbW11dGFibGUoKTsNCiAgICAgIH0NCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgZ2V0RGVzY3JpcHRvcigpIHsNCiAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdF9kZXNjcmlwdG9yOw0KICAgIH0NCg0KICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgaW50ZXJuYWxHZXRGaWVsZEFjY2Vzc29yVGFibGUoKSB7DQogICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3RfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgLmVuc3VyZUZpZWxkQWNjZXNzb3JzSW5pdGlhbGl6ZWQoDQogICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdC5jbGFzcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0LkJ1aWxkZXIuY2xhc3MpOw0KICAgIH0NCg0KICAgIHByaXZhdGUgaW50IGJpdEZpZWxkMF87DQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQkFUQ0hJRF9GSUVMRF9OVU1CRVIgPSAxOw0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBiYXRjaElEXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQmF0Y2hJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldEJhdGNoSUQoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGJhdGNoSURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIGJhdGNoSURfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBCYXRjaElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRCYXRjaElEQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGJhdGNoSURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIGJhdGNoSURfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE1FU1NBR0VTX0ZJRUxEX05VTUJFUiA9IDI7DQogICAgcHJpdmF0ZSBqYXZhLnV0aWwuTGlzdDxpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZT4gbWVzc2FnZXNfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEudXRpbC5MaXN0PGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlPiBnZXRNZXNzYWdlc0xpc3QoKSB7DQogICAgICByZXR1cm4gbWVzc2FnZXNfOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLnV0aWwuTGlzdDw/IGV4dGVuZHMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VPckJ1aWxkZXI+IA0KICAgICAgICBnZXRNZXNzYWdlc09yQnVpbGRlckxpc3QoKSB7DQogICAgICByZXR1cm4gbWVzc2FnZXNfOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpbnQgZ2V0TWVzc2FnZXNDb3VudCgpIHsNCiAgICAgIHJldHVybiBtZXNzYWdlc18uc2l6ZSgpOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBnZXRNZXNzYWdlcyhpbnQgaW5kZXgpIHsNCiAgICAgIHJldHVybiBtZXNzYWdlc18uZ2V0KGluZGV4KTsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VPckJ1aWxkZXIgZ2V0TWVzc2FnZXNPckJ1aWxkZXIoDQogICAgICAgIGludCBpbmRleCkgew0KICAgICAgcmV0dXJuIG1lc3NhZ2VzXy5nZXQoaW5kZXgpOw0KICAgIH0NCg0KICAgIHByaXZhdGUgYnl0ZSBtZW1vaXplZElzSW5pdGlhbGl6ZWQgPSAtMTsNCiAgICBwdWJsaWMgZmluYWwgYm9vbGVhbiBpc0luaXRpYWxpemVkKCkgew0KICAgICAgYnl0ZSBpc0luaXRpYWxpemVkID0gbWVtb2l6ZWRJc0luaXRpYWxpemVkOw0KICAgICAgaWYgKGlzSW5pdGlhbGl6ZWQgPT0gMSkgcmV0dXJuIHRydWU7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAwKSByZXR1cm4gZmFsc2U7DQoNCiAgICAgIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IDE7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQoNCiAgICBwdWJsaWMgdm9pZCB3cml0ZVRvKGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0gb3V0cHV0KQ0KICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgaWYgKCFnZXRCYXRjaElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAxLCBiYXRjaElEXyk7DQogICAgICB9DQogICAgICBmb3IgKGludCBpID0gMDsgaSA8IG1lc3NhZ2VzXy5zaXplKCk7IGkrKykgew0KICAgICAgICBvdXRwdXQud3JpdGVNZXNzYWdlKDIsIG1lc3NhZ2VzXy5nZXQoaSkpOw0KICAgICAgfQ0KICAgICAgdW5rbm93bkZpZWxkcy53cml0ZVRvKG91dHB1dCk7DQogICAgfQ0KDQogICAgcHVibGljIGludCBnZXRTZXJpYWxpemVkU2l6ZSgpIHsNCiAgICAgIGludCBzaXplID0gbWVtb2l6ZWRTaXplOw0KICAgICAgaWYgKHNpemUgIT0gLTEpIHJldHVybiBzaXplOw0KDQogICAgICBzaXplID0gMDsNCiAgICAgIGlmICghZ2V0QmF0Y2hJREJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoMSwgYmF0Y2hJRF8pOw0KICAgICAgfQ0KICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCBtZXNzYWdlc18uc2l6ZSgpOyBpKyspIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVNZXNzYWdlU2l6ZSgyLCBtZXNzYWdlc18uZ2V0KGkpKTsNCiAgICAgIH0NCiAgICAgIHNpemUgKz0gdW5rbm93bkZpZWxkcy5nZXRTZXJpYWxpemVkU2l6ZSgpOw0KICAgICAgbWVtb2l6ZWRTaXplID0gc2l6ZTsNCiAgICAgIHJldHVybiBzaXplOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgYm9vbGVhbiBlcXVhbHMoZmluYWwgamF2YS5sYW5nLk9iamVjdCBvYmopIHsNCiAgICAgIGlmIChvYmogPT0gdGhpcykgew0KICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KICAgICAgaWYgKCEob2JqIGluc3RhbmNlb2YgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0KSkgew0KICAgICAgICByZXR1cm4gc3VwZXIuZXF1YWxzKG9iaik7DQogICAgICB9DQogICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3Qgb3RoZXIgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0KSBvYmo7DQoNCiAgICAgIGJvb2xlYW4gcmVzdWx0ID0gdHJ1ZTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRCYXRjaElEKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldEJhdGNoSUQoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0TWVzc2FnZXNMaXN0KCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldE1lc3NhZ2VzTGlzdCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiB1bmtub3duRmllbGRzLmVxdWFscyhvdGhlci51bmtub3duRmllbGRzKTsNCiAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBpbnQgaGFzaENvZGUoKSB7DQogICAgICBpZiAobWVtb2l6ZWRIYXNoQ29kZSAhPSAwKSB7DQogICAgICAgIHJldHVybiBtZW1vaXplZEhhc2hDb2RlOw0KICAgICAgfQ0KICAgICAgaW50IGhhc2ggPSA0MTsNCiAgICAgIGhhc2ggPSAoMTkgKiBoYXNoKSArIGdldERlc2NyaXB0b3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgQkFUQ0hJRF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRCYXRjaElEKCkuaGFzaENvZGUoKTsNCiAgICAgIGlmIChnZXRNZXNzYWdlc0NvdW50KCkgPiAwKSB7DQogICAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIE1FU1NBR0VTX0ZJRUxEX05VTUJFUjsNCiAgICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0TWVzc2FnZXNMaXN0KCkuaGFzaENvZGUoKTsNCiAgICAgIH0NCiAgICAgIGhhc2ggPSAoMjkgKiBoYXNoKSArIHVua25vd25GaWVsZHMuaGFzaENvZGUoKTsNCiAgICAgIG1lbW9pemVkSGFzaENvZGUgPSBoYXNoOw0KICAgICAgcmV0dXJuIGhhc2g7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCBwYXJzZUZyb20oYnl0ZVtdIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBieXRlW10gZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0IHBhcnNlRnJvbShqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0IHBhcnNlRGVsaW1pdGVkRnJvbShqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VEZWxpbWl0ZWRXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0IHBhcnNlRGVsaW1pdGVkRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZURlbGltaXRlZFdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgQnVpbGRlciBuZXdCdWlsZGVyRm9yVHlwZSgpIHsgcmV0dXJuIG5ld0J1aWxkZXIoKTsgfQ0KICAgIHB1YmxpYyBzdGF0aWMgQnVpbGRlciBuZXdCdWlsZGVyKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgQnVpbGRlciBuZXdCdWlsZGVyKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCBwcm90b3R5cGUpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFLnRvQnVpbGRlcigpLm1lcmdlRnJvbShwcm90b3R5cGUpOw0KICAgIH0NCiAgICBwdWJsaWMgQnVpbGRlciB0b0J1aWxkZXIoKSB7DQogICAgICByZXR1cm4gdGhpcyA9PSBERUZBVUxUX0lOU1RBTkNFDQogICAgICAgICAgPyBuZXcgQnVpbGRlcigpIDogbmV3IEJ1aWxkZXIoKS5tZXJnZUZyb20odGhpcyk7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHByb3RlY3RlZCBCdWlsZGVyIG5ld0J1aWxkZXJGb3JUeXBlKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgQnVpbGRlciBidWlsZGVyID0gbmV3IEJ1aWxkZXIocGFyZW50KTsNCiAgICAgIHJldHVybiBidWlsZGVyOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdH0NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNsYXNzIEJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPEJ1aWxkZXI+IGltcGxlbWVudHMNCiAgICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfaW1wbGVtZW50czprdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCkNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0T3JCdWlsZGVyIHsNCiAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvcigpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0X2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0X2ZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICAgICAgLmVuc3VyZUZpZWxkQWNjZXNzb3JzSW5pdGlhbGl6ZWQoDQogICAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0LmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3QuQnVpbGRlci5jbGFzcyk7DQogICAgICB9DQoNCiAgICAgIC8vIENvbnN0cnVjdCB1c2luZyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3QubmV3QnVpbGRlcigpDQogICAgICBwcml2YXRlIEJ1aWxkZXIoKSB7DQogICAgICAgIG1heWJlRm9yY2VCdWlsZGVySW5pdGlhbGl6YXRpb24oKTsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXJQYXJlbnQgcGFyZW50KSB7DQogICAgICAgIHN1cGVyKHBhcmVudCk7DQogICAgICAgIG1heWJlRm9yY2VCdWlsZGVySW5pdGlhbGl6YXRpb24oKTsNCiAgICAgIH0NCiAgICAgIHByaXZhdGUgdm9pZCBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCkgew0KICAgICAgICBpZiAoY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAgICAgICAuYWx3YXlzVXNlRmllbGRCdWlsZGVycykgew0KICAgICAgICAgIGdldE1lc3NhZ2VzRmllbGRCdWlsZGVyKCk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyKCkgew0KICAgICAgICBzdXBlci5jbGVhcigpOw0KICAgICAgICBiYXRjaElEXyA9ICIiOw0KDQogICAgICAgIGlmIChtZXNzYWdlc0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBtZXNzYWdlc18gPSBqYXZhLnV0aWwuQ29sbGVjdGlvbnMuZW1wdHlMaXN0KCk7DQogICAgICAgICAgYml0RmllbGQwXyA9IChiaXRGaWVsZDBfICYgfjB4MDAwMDAwMDIpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG1lc3NhZ2VzQnVpbGRlcl8uY2xlYXIoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICAgIGdldERlc2NyaXB0b3JGb3JUeXBlKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3RfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCBnZXREZWZhdWx0SW5zdGFuY2VGb3JUeXBlKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0LmdldERlZmF1bHRJbnN0YW5jZSgpOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0IGJ1aWxkKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3QgcmVzdWx0ID0gYnVpbGRQYXJ0aWFsKCk7DQogICAgICAgIGlmICghcmVzdWx0LmlzSW5pdGlhbGl6ZWQoKSkgew0KICAgICAgICAgIHRocm93IG5ld1VuaW5pdGlhbGl6ZWRNZXNzYWdlRXhjZXB0aW9uKHJlc3VsdCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCBidWlsZFBhcnRpYWwoKSB7DQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCByZXN1bHQgPSBuZXcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0KHRoaXMpOw0KICAgICAgICBpbnQgZnJvbV9iaXRGaWVsZDBfID0gYml0RmllbGQwXzsNCiAgICAgICAgaW50IHRvX2JpdEZpZWxkMF8gPSAwOw0KICAgICAgICByZXN1bHQuYmF0Y2hJRF8gPSBiYXRjaElEXzsNCiAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGlmICgoKGJpdEZpZWxkMF8gJiAweDAwMDAwMDAyKSA9PSAweDAwMDAwMDAyKSkgew0KICAgICAgICAgICAgbWVzc2FnZXNfID0gamF2YS51dGlsLkNvbGxlY3Rpb25zLnVubW9kaWZpYWJsZUxpc3QobWVzc2FnZXNfKTsNCiAgICAgICAgICAgIGJpdEZpZWxkMF8gPSAoYml0RmllbGQwXyAmIH4weDAwMDAwMDAyKTsNCiAgICAgICAgICB9DQogICAgICAgICAgcmVzdWx0Lm1lc3NhZ2VzXyA9IG1lc3NhZ2VzXzsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXN1bHQubWVzc2FnZXNfID0gbWVzc2FnZXNCdWlsZGVyXy5idWlsZCgpOw0KICAgICAgICB9DQogICAgICAgIHJlc3VsdC5iaXRGaWVsZDBfID0gdG9fYml0RmllbGQwXzsNCiAgICAgICAgb25CdWlsdCgpOw0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBjbG9uZSgpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbG9uZSgpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJGaWVsZChmaWVsZCk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck9uZW9mKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuT25lb2ZEZXNjcmlwdG9yIG9uZW9mKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJPbmVvZihvbmVvZik7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGludCBpbmRleCwgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldFJlcGVhdGVkRmllbGQoZmllbGQsIGluZGV4LCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBhZGRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5hZGRSZXBlYXRlZEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oY29tLmdvb2dsZS5wcm90b2J1Zi5NZXNzYWdlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCkgew0KICAgICAgICAgIHJldHVybiBtZXJnZUZyb20oKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdClvdGhlcik7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgc3VwZXIubWVyZ2VGcm9tKG90aGVyKTsNCiAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfQ0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0IG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciA9PSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3QuZ2V0RGVmYXVsdEluc3RhbmNlKCkpIHJldHVybiB0aGlzOw0KICAgICAgICBpZiAoIW90aGVyLmdldEJhdGNoSUQoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICBiYXRjaElEXyA9IG90aGVyLmJhdGNoSURfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmIChtZXNzYWdlc0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBpZiAoIW90aGVyLm1lc3NhZ2VzXy5pc0VtcHR5KCkpIHsNCiAgICAgICAgICAgIGlmIChtZXNzYWdlc18uaXNFbXB0eSgpKSB7DQogICAgICAgICAgICAgIG1lc3NhZ2VzXyA9IG90aGVyLm1lc3NhZ2VzXzsNCiAgICAgICAgICAgICAgYml0RmllbGQwXyA9IChiaXRGaWVsZDBfICYgfjB4MDAwMDAwMDIpOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgZW5zdXJlTWVzc2FnZXNJc011dGFibGUoKTsNCiAgICAgICAgICAgICAgbWVzc2FnZXNfLmFkZEFsbChvdGhlci5tZXNzYWdlc18pOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGlmICghb3RoZXIubWVzc2FnZXNfLmlzRW1wdHkoKSkgew0KICAgICAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8uaXNFbXB0eSgpKSB7DQogICAgICAgICAgICAgIG1lc3NhZ2VzQnVpbGRlcl8uZGlzcG9zZSgpOw0KICAgICAgICAgICAgICBtZXNzYWdlc0J1aWxkZXJfID0gbnVsbDsNCiAgICAgICAgICAgICAgbWVzc2FnZXNfID0gb3RoZXIubWVzc2FnZXNfOw0KICAgICAgICAgICAgICBiaXRGaWVsZDBfID0gKGJpdEZpZWxkMF8gJiB+MHgwMDAwMDAwMik7DQogICAgICAgICAgICAgIG1lc3NhZ2VzQnVpbGRlcl8gPSANCiAgICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5hbHdheXNVc2VGaWVsZEJ1aWxkZXJzID8NCiAgICAgICAgICAgICAgICAgICBnZXRNZXNzYWdlc0ZpZWxkQnVpbGRlcigpIDogbnVsbDsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIG1lc3NhZ2VzQnVpbGRlcl8uYWRkQWxsTWVzc2FnZXMob3RoZXIubWVzc2FnZXNfKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5tZXJnZVVua25vd25GaWVsZHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbSgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3QgcGFyc2VkTWVzc2FnZSA9IG51bGw7DQogICAgICAgIHRyeSB7DQogICAgICAgICAgcGFyc2VkTWVzc2FnZSA9IFBBUlNFUi5wYXJzZVBhcnRpYWxGcm9tKGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICAgIH0gY2F0Y2ggKGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCkgZS5nZXRVbmZpbmlzaGVkTWVzc2FnZSgpOw0KICAgICAgICAgIHRocm93IGUudW53cmFwSU9FeGNlcHRpb24oKTsNCiAgICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgICBpZiAocGFyc2VkTWVzc2FnZSAhPSBudWxsKSB7DQogICAgICAgICAgICBtZXJnZUZyb20ocGFyc2VkTWVzc2FnZSk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgcHJpdmF0ZSBpbnQgYml0RmllbGQwXzsNCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IGJhdGNoSURfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBCYXRjaElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldEJhdGNoSUQoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gYmF0Y2hJRF87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIGJhdGNoSURfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQmF0Y2hJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0QmF0Y2hJREJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGJhdGNoSURfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIGJhdGNoSURfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBCYXRjaElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEJhdGNoSUQoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBiYXRjaElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBCYXRjaElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyQmF0Y2hJRCgpIHsNCiAgICAgICAgDQogICAgICAgIGJhdGNoSURfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0QmF0Y2hJRCgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBCYXRjaElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEJhdGNoSURCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgYmF0Y2hJRF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEudXRpbC5MaXN0PGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlPiBtZXNzYWdlc18gPQ0KICAgICAgICBqYXZhLnV0aWwuQ29sbGVjdGlvbnMuZW1wdHlMaXN0KCk7DQogICAgICBwcml2YXRlIHZvaWQgZW5zdXJlTWVzc2FnZXNJc011dGFibGUoKSB7DQogICAgICAgIGlmICghKChiaXRGaWVsZDBfICYgMHgwMDAwMDAwMikgPT0gMHgwMDAwMDAwMikpIHsNCiAgICAgICAgICBtZXNzYWdlc18gPSBuZXcgamF2YS51dGlsLkFycmF5TGlzdDxpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZT4obWVzc2FnZXNfKTsNCiAgICAgICAgICBiaXRGaWVsZDBfIHw9IDB4MDAwMDAwMDI7DQogICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5SZXBlYXRlZEZpZWxkQnVpbGRlclYzPA0KICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5CdWlsZGVyLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZU9yQnVpbGRlcj4gbWVzc2FnZXNCdWlsZGVyXzsNCg0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS51dGlsLkxpc3Q8aW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2U+IGdldE1lc3NhZ2VzTGlzdCgpIHsNCiAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIHJldHVybiBqYXZhLnV0aWwuQ29sbGVjdGlvbnMudW5tb2RpZmlhYmxlTGlzdChtZXNzYWdlc18pOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiBtZXNzYWdlc0J1aWxkZXJfLmdldE1lc3NhZ2VMaXN0KCk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGludCBnZXRNZXNzYWdlc0NvdW50KCkgew0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgcmV0dXJuIG1lc3NhZ2VzXy5zaXplKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIG1lc3NhZ2VzQnVpbGRlcl8uZ2V0Q291bnQoKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgZ2V0TWVzc2FnZXMoaW50IGluZGV4KSB7DQogICAgICAgIGlmIChtZXNzYWdlc0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICByZXR1cm4gbWVzc2FnZXNfLmdldChpbmRleCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIG1lc3NhZ2VzQnVpbGRlcl8uZ2V0TWVzc2FnZShpbmRleCk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0TWVzc2FnZXMoDQogICAgICAgICAgaW50IGluZGV4LCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSB2YWx1ZSkgew0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICAgICAgICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBlbnN1cmVNZXNzYWdlc0lzTXV0YWJsZSgpOw0KICAgICAgICAgIG1lc3NhZ2VzXy5zZXQoaW5kZXgsIHZhbHVlKTsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBtZXNzYWdlc0J1aWxkZXJfLnNldE1lc3NhZ2UoaW5kZXgsIHZhbHVlKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0TWVzc2FnZXMoDQogICAgICAgICAgaW50IGluZGV4LCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5CdWlsZGVyIGJ1aWxkZXJGb3JWYWx1ZSkgew0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgZW5zdXJlTWVzc2FnZXNJc011dGFibGUoKTsNCiAgICAgICAgICBtZXNzYWdlc18uc2V0KGluZGV4LCBidWlsZGVyRm9yVmFsdWUuYnVpbGQoKSk7DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgbWVzc2FnZXNCdWlsZGVyXy5zZXRNZXNzYWdlKGluZGV4LCBidWlsZGVyRm9yVmFsdWUuYnVpbGQoKSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGFkZE1lc3NhZ2VzKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlIHZhbHVlKSB7DQogICAgICAgIGlmIChtZXNzYWdlc0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgICAgICAgICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogICAgICAgICAgfQ0KICAgICAgICAgIGVuc3VyZU1lc3NhZ2VzSXNNdXRhYmxlKCk7DQogICAgICAgICAgbWVzc2FnZXNfLmFkZCh2YWx1ZSk7DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgbWVzc2FnZXNCdWlsZGVyXy5hZGRNZXNzYWdlKHZhbHVlKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgYWRkTWVzc2FnZXMoDQogICAgICAgICAgaW50IGluZGV4LCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSB2YWx1ZSkgew0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICAgICAgICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBlbnN1cmVNZXNzYWdlc0lzTXV0YWJsZSgpOw0KICAgICAgICAgIG1lc3NhZ2VzXy5hZGQoaW5kZXgsIHZhbHVlKTsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBtZXNzYWdlc0J1aWxkZXJfLmFkZE1lc3NhZ2UoaW5kZXgsIHZhbHVlKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgYWRkTWVzc2FnZXMoDQogICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlciBidWlsZGVyRm9yVmFsdWUpIHsNCiAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGVuc3VyZU1lc3NhZ2VzSXNNdXRhYmxlKCk7DQogICAgICAgICAgbWVzc2FnZXNfLmFkZChidWlsZGVyRm9yVmFsdWUuYnVpbGQoKSk7DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgbWVzc2FnZXNCdWlsZGVyXy5hZGRNZXNzYWdlKGJ1aWxkZXJGb3JWYWx1ZS5idWlsZCgpKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgYWRkTWVzc2FnZXMoDQogICAgICAgICAgaW50IGluZGV4LCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5CdWlsZGVyIGJ1aWxkZXJGb3JWYWx1ZSkgew0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgZW5zdXJlTWVzc2FnZXNJc011dGFibGUoKTsNCiAgICAgICAgICBtZXNzYWdlc18uYWRkKGluZGV4LCBidWlsZGVyRm9yVmFsdWUuYnVpbGQoKSk7DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgbWVzc2FnZXNCdWlsZGVyXy5hZGRNZXNzYWdlKGluZGV4LCBidWlsZGVyRm9yVmFsdWUuYnVpbGQoKSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGFkZEFsbE1lc3NhZ2VzKA0KICAgICAgICAgIGphdmEubGFuZy5JdGVyYWJsZTw/IGV4dGVuZHMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2U+IHZhbHVlcykgew0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgZW5zdXJlTWVzc2FnZXNJc011dGFibGUoKTsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkFic3RyYWN0TWVzc2FnZUxpdGUuQnVpbGRlci5hZGRBbGwoDQogICAgICAgICAgICAgIHZhbHVlcywgbWVzc2FnZXNfKTsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBtZXNzYWdlc0J1aWxkZXJfLmFkZEFsbE1lc3NhZ2VzKHZhbHVlcyk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyTWVzc2FnZXMoKSB7DQogICAgICAgIGlmIChtZXNzYWdlc0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBtZXNzYWdlc18gPSBqYXZhLnV0aWwuQ29sbGVjdGlvbnMuZW1wdHlMaXN0KCk7DQogICAgICAgICAgYml0RmllbGQwXyA9IChiaXRGaWVsZDBfICYgfjB4MDAwMDAwMDIpOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG1lc3NhZ2VzQnVpbGRlcl8uY2xlYXIoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgcmVtb3ZlTWVzc2FnZXMoaW50IGluZGV4KSB7DQogICAgICAgIGlmIChtZXNzYWdlc0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBlbnN1cmVNZXNzYWdlc0lzTXV0YWJsZSgpOw0KICAgICAgICAgIG1lc3NhZ2VzXy5yZW1vdmUoaW5kZXgpOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG1lc3NhZ2VzQnVpbGRlcl8ucmVtb3ZlKGluZGV4KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLkJ1aWxkZXIgZ2V0TWVzc2FnZXNCdWlsZGVyKA0KICAgICAgICAgIGludCBpbmRleCkgew0KICAgICAgICByZXR1cm4gZ2V0TWVzc2FnZXNGaWVsZEJ1aWxkZXIoKS5nZXRCdWlsZGVyKGluZGV4KTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlT3JCdWlsZGVyIGdldE1lc3NhZ2VzT3JCdWlsZGVyKA0KICAgICAgICAgIGludCBpbmRleCkgew0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgcmV0dXJuIG1lc3NhZ2VzXy5nZXQoaW5kZXgpOyAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gbWVzc2FnZXNCdWlsZGVyXy5nZXRNZXNzYWdlT3JCdWlsZGVyKGluZGV4KTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS51dGlsLkxpc3Q8PyBleHRlbmRzIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlT3JCdWlsZGVyPiANCiAgICAgICAgICAgZ2V0TWVzc2FnZXNPckJ1aWxkZXJMaXN0KCkgew0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyAhPSBudWxsKSB7DQogICAgICAgICAgcmV0dXJuIG1lc3NhZ2VzQnVpbGRlcl8uZ2V0TWVzc2FnZU9yQnVpbGRlckxpc3QoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gamF2YS51dGlsLkNvbGxlY3Rpb25zLnVubW9kaWZpYWJsZUxpc3QobWVzc2FnZXNfKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlciBhZGRNZXNzYWdlc0J1aWxkZXIoKSB7DQogICAgICAgIHJldHVybiBnZXRNZXNzYWdlc0ZpZWxkQnVpbGRlcigpLmFkZEJ1aWxkZXIoDQogICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5nZXREZWZhdWx0SW5zdGFuY2UoKSk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5CdWlsZGVyIGFkZE1lc3NhZ2VzQnVpbGRlcigNCiAgICAgICAgICBpbnQgaW5kZXgpIHsNCiAgICAgICAgcmV0dXJuIGdldE1lc3NhZ2VzRmllbGRCdWlsZGVyKCkuYWRkQnVpbGRlcigNCiAgICAgICAgICAgIGluZGV4LCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5nZXREZWZhdWx0SW5zdGFuY2UoKSk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLnV0aWwuTGlzdDxpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5CdWlsZGVyPiANCiAgICAgICAgICAgZ2V0TWVzc2FnZXNCdWlsZGVyTGlzdCgpIHsNCiAgICAgICAgcmV0dXJuIGdldE1lc3NhZ2VzRmllbGRCdWlsZGVyKCkuZ2V0QnVpbGRlckxpc3QoKTsNCiAgICAgIH0NCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5SZXBlYXRlZEZpZWxkQnVpbGRlclYzPA0KICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5CdWlsZGVyLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZU9yQnVpbGRlcj4gDQogICAgICAgICAgZ2V0TWVzc2FnZXNGaWVsZEJ1aWxkZXIoKSB7DQogICAgICAgIGlmIChtZXNzYWdlc0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBtZXNzYWdlc0J1aWxkZXJfID0gbmV3IGNvbS5nb29nbGUucHJvdG9idWYuUmVwZWF0ZWRGaWVsZEJ1aWxkZXJWMzwNCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLkJ1aWxkZXIsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlT3JCdWlsZGVyPigNCiAgICAgICAgICAgICAgICAgIG1lc3NhZ2VzXywNCiAgICAgICAgICAgICAgICAgICgoYml0RmllbGQwXyAmIDB4MDAwMDAwMDIpID09IDB4MDAwMDAwMDIpLA0KICAgICAgICAgICAgICAgICAgZ2V0UGFyZW50Rm9yQ2hpbGRyZW4oKSwNCiAgICAgICAgICAgICAgICAgIGlzQ2xlYW4oKSk7DQogICAgICAgICAgbWVzc2FnZXNfID0gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gbWVzc2FnZXNCdWlsZGVyXzsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIHNldFVua25vd25GaWVsZHMoDQogICAgICAgICAgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQgdW5rbm93bkZpZWxkcykgew0KICAgICAgICByZXR1cm4gc3VwZXIuc2V0VW5rbm93bkZpZWxkc1Byb3RvMyh1bmtub3duRmllbGRzKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIEJ1aWxkZXIgbWVyZ2VVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLm1lcmdlVW5rbm93bkZpZWxkcyh1bmtub3duRmllbGRzKTsNCiAgICAgIH0NCg0KDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoYnVpbGRlcl9zY29wZTprdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCkNCiAgICB9DQoNCiAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoY2xhc3Nfc2NvcGU6a3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3QpDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0IERFRkFVTFRfSU5TVEFOQ0U7DQogICAgc3RhdGljIHsNCiAgICAgIERFRkFVTFRfSU5TVEFOQ0UgPSBuZXcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0KCk7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3QgZ2V0RGVmYXVsdEluc3RhbmNlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdD4NCiAgICAgICAgUEFSU0VSID0gbmV3IGNvbS5nb29nbGUucHJvdG9idWYuQWJzdHJhY3RQYXJzZXI8UXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdD4oKSB7DQogICAgICBwdWJsaWMgUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCBwYXJzZVBhcnRpYWxGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgICByZXR1cm4gbmV3IFF1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3QoaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgIH0NCiAgICB9Ow0KDQogICAgcHVibGljIHN0YXRpYyBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxRdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0PiBwYXJzZXIoKSB7DQogICAgICByZXR1cm4gUEFSU0VSOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdD4gZ2V0UGFyc2VyRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdCBnZXREZWZhdWx0SW5zdGFuY2VGb3JUeXBlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogIH0NCg0KICBwdWJsaWMgaW50ZXJmYWNlIFF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlT3JCdWlsZGVyIGV4dGVuZHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChpbnRlcmZhY2VfZXh0ZW5kczprdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UpDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLk1lc3NhZ2VPckJ1aWxkZXIgew0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEJhdGNoSUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldEJhdGNoSUQoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQmF0Y2hJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRCYXRjaElEQnl0ZXMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBSZXN1bHRzID0gMjs8L2NvZGU+DQogICAgICovDQogICAgamF2YS51dGlsLkxpc3Q8aW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0PiANCiAgICAgICAgZ2V0UmVzdWx0c0xpc3QoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgUmVzdWx0cyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBnZXRSZXN1bHRzKGludCBpbmRleCk7DQogICAgLyoqDQogICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IFJlc3VsdHMgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBpbnQgZ2V0UmVzdWx0c0NvdW50KCk7DQogICAgLyoqDQogICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IFJlc3VsdHMgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLnV0aWwuTGlzdDw/IGV4dGVuZHMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0T3JCdWlsZGVyPiANCiAgICAgICAgZ2V0UmVzdWx0c09yQnVpbGRlckxpc3QoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgUmVzdWx0cyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdE9yQnVpbGRlciBnZXRSZXN1bHRzT3JCdWlsZGVyKA0KICAgICAgICBpbnQgaW5kZXgpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+Ym9vbCBIYXZlRXJyb3JzID0gMzs8L2NvZGU+DQogICAgICovDQogICAgYm9vbGVhbiBnZXRIYXZlRXJyb3JzKCk7DQogIH0NCiAgLyoqDQogICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZX0NCiAgICovDQogIHB1YmxpYyAgc3RhdGljIGZpbmFsIGNsYXNzIFF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlIGV4dGVuZHMNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzIGltcGxlbWVudHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChtZXNzYWdlX2ltcGxlbWVudHM6a3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlKQ0KICAgICAgUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2VPckJ1aWxkZXIgew0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBsb25nIHNlcmlhbFZlcnNpb25VSUQgPSAwTDsNCiAgICAvLyBVc2UgUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UubmV3QnVpbGRlcigpIHRvIGNvbnN0cnVjdC4NCiAgICBwcml2YXRlIFF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8Pz4gYnVpbGRlcikgew0KICAgICAgc3VwZXIoYnVpbGRlcik7DQogICAgfQ0KICAgIHByaXZhdGUgUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UoKSB7DQogICAgICBiYXRjaElEXyA9ICIiOw0KICAgICAgcmVzdWx0c18gPSBqYXZhLnV0aWwuQ29sbGVjdGlvbnMuZW1wdHlMaXN0KCk7DQogICAgICBoYXZlRXJyb3JzXyA9IGZhbHNlOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQNCiAgICBnZXRVbmtub3duRmllbGRzKCkgew0KICAgICAgcmV0dXJuIHRoaXMudW5rbm93bkZpZWxkczsNCiAgICB9DQogICAgcHJpdmF0ZSBRdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHRoaXMoKTsNCiAgICAgIGlmIChleHRlbnNpb25SZWdpc3RyeSA9PSBudWxsKSB7DQogICAgICAgIHRocm93IG5ldyBqYXZhLmxhbmcuTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgICAgIH0NCiAgICAgIGludCBtdXRhYmxlX2JpdEZpZWxkMF8gPSAwOw0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQuQnVpbGRlciB1bmtub3duRmllbGRzID0NCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldC5uZXdCdWlsZGVyKCk7DQogICAgICB0cnkgew0KICAgICAgICBib29sZWFuIGRvbmUgPSBmYWxzZTsNCiAgICAgICAgd2hpbGUgKCFkb25lKSB7DQogICAgICAgICAgaW50IHRhZyA9IGlucHV0LnJlYWRUYWcoKTsNCiAgICAgICAgICBzd2l0Y2ggKHRhZykgew0KICAgICAgICAgICAgY2FzZSAwOg0KICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICBkZWZhdWx0OiB7DQogICAgICAgICAgICAgIGlmICghcGFyc2VVbmtub3duRmllbGRQcm90bzMoDQogICAgICAgICAgICAgICAgICBpbnB1dCwgdW5rbm93bkZpZWxkcywgZXh0ZW5zaW9uUmVnaXN0cnksIHRhZykpIHsNCiAgICAgICAgICAgICAgICBkb25lID0gdHJ1ZTsNCiAgICAgICAgICAgICAgfQ0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMTA6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgYmF0Y2hJRF8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMTg6IHsNCiAgICAgICAgICAgICAgaWYgKCEoKG11dGFibGVfYml0RmllbGQwXyAmIDB4MDAwMDAwMDIpID09IDB4MDAwMDAwMDIpKSB7DQogICAgICAgICAgICAgICAgcmVzdWx0c18gPSBuZXcgamF2YS51dGlsLkFycmF5TGlzdDxpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQ+KCk7DQogICAgICAgICAgICAgICAgbXV0YWJsZV9iaXRGaWVsZDBfIHw9IDB4MDAwMDAwMDI7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgcmVzdWx0c18uYWRkKA0KICAgICAgICAgICAgICAgICAgaW5wdXQucmVhZE1lc3NhZ2UoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0LnBhcnNlcigpLCBleHRlbnNpb25SZWdpc3RyeSkpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMjQ6IHsNCg0KICAgICAgICAgICAgICBoYXZlRXJyb3JzXyA9IGlucHV0LnJlYWRCb29sKCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBlLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBjYXRjaCAoamF2YS5pby5JT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbigNCiAgICAgICAgICAgIGUpLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgaWYgKCgobXV0YWJsZV9iaXRGaWVsZDBfICYgMHgwMDAwMDAwMikgPT0gMHgwMDAwMDAwMikpIHsNCiAgICAgICAgICByZXN1bHRzXyA9IGphdmEudXRpbC5Db2xsZWN0aW9ucy51bm1vZGlmaWFibGVMaXN0KHJlc3VsdHNfKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLnVua25vd25GaWVsZHMgPSB1bmtub3duRmllbGRzLmJ1aWxkKCk7DQogICAgICAgIG1ha2VFeHRlbnNpb25zSW1tdXRhYmxlKCk7DQogICAgICB9DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlX2Rlc2NyaXB0b3I7DQogICAgfQ0KDQogICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2VfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgLmVuc3VyZUZpZWxkQWNjZXNzb3JzSW5pdGlhbGl6ZWQoDQogICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UuQnVpbGRlci5jbGFzcyk7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBpbnQgYml0RmllbGQwXzsNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBCQVRDSElEX0ZJRUxEX05VTUJFUiA9IDE7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IGJhdGNoSURfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBCYXRjaElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0QmF0Y2hJRCgpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gYmF0Y2hJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgYmF0Y2hJRF8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEJhdGNoSUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldEJhdGNoSURCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gYmF0Y2hJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgYmF0Y2hJRF8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUkVTVUxUU19GSUVMRF9OVU1CRVIgPSAyOw0KICAgIHByaXZhdGUgamF2YS51dGlsLkxpc3Q8aW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0PiByZXN1bHRzXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgUmVzdWx0cyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLnV0aWwuTGlzdDxpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQ+IGdldFJlc3VsdHNMaXN0KCkgew0KICAgICAgcmV0dXJuIHJlc3VsdHNfOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgUmVzdWx0cyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLnV0aWwuTGlzdDw/IGV4dGVuZHMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0T3JCdWlsZGVyPiANCiAgICAgICAgZ2V0UmVzdWx0c09yQnVpbGRlckxpc3QoKSB7DQogICAgICByZXR1cm4gcmVzdWx0c187DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBSZXN1bHRzID0gMjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGludCBnZXRSZXN1bHRzQ291bnQoKSB7DQogICAgICByZXR1cm4gcmVzdWx0c18uc2l6ZSgpOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgUmVzdWx0cyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgZ2V0UmVzdWx0cyhpbnQgaW5kZXgpIHsNCiAgICAgIHJldHVybiByZXN1bHRzXy5nZXQoaW5kZXgpOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgUmVzdWx0cyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHRPckJ1aWxkZXIgZ2V0UmVzdWx0c09yQnVpbGRlcigNCiAgICAgICAgaW50IGluZGV4KSB7DQogICAgICByZXR1cm4gcmVzdWx0c18uZ2V0KGluZGV4KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBIQVZFRVJST1JTX0ZJRUxEX05VTUJFUiA9IDM7DQogICAgcHJpdmF0ZSBib29sZWFuIGhhdmVFcnJvcnNfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmJvb2wgSGF2ZUVycm9ycyA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBib29sZWFuIGdldEhhdmVFcnJvcnMoKSB7DQogICAgICByZXR1cm4gaGF2ZUVycm9yc187DQogICAgfQ0KDQogICAgcHJpdmF0ZSBieXRlIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IC0xOw0KICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICBieXRlIGlzSW5pdGlhbGl6ZWQgPSBtZW1vaXplZElzSW5pdGlhbGl6ZWQ7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAxKSByZXR1cm4gdHJ1ZTsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDApIHJldHVybiBmYWxzZTsNCg0KICAgICAgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gMTsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCg0KICAgIHB1YmxpYyB2b2lkIHdyaXRlVG8oY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbSBvdXRwdXQpDQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICBpZiAoIWdldEJhdGNoSURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDEsIGJhdGNoSURfKTsNCiAgICAgIH0NCiAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgcmVzdWx0c18uc2l6ZSgpOyBpKyspIHsNCiAgICAgICAgb3V0cHV0LndyaXRlTWVzc2FnZSgyLCByZXN1bHRzXy5nZXQoaSkpOw0KICAgICAgfQ0KICAgICAgaWYgKGhhdmVFcnJvcnNfICE9IGZhbHNlKSB7DQogICAgICAgIG91dHB1dC53cml0ZUJvb2woMywgaGF2ZUVycm9yc18pOw0KICAgICAgfQ0KICAgICAgdW5rbm93bkZpZWxkcy53cml0ZVRvKG91dHB1dCk7DQogICAgfQ0KDQogICAgcHVibGljIGludCBnZXRTZXJpYWxpemVkU2l6ZSgpIHsNCiAgICAgIGludCBzaXplID0gbWVtb2l6ZWRTaXplOw0KICAgICAgaWYgKHNpemUgIT0gLTEpIHJldHVybiBzaXplOw0KDQogICAgICBzaXplID0gMDsNCiAgICAgIGlmICghZ2V0QmF0Y2hJREJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoMSwgYmF0Y2hJRF8pOw0KICAgICAgfQ0KICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCByZXN1bHRzXy5zaXplKCk7IGkrKykgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZU1lc3NhZ2VTaXplKDIsIHJlc3VsdHNfLmdldChpKSk7DQogICAgICB9DQogICAgICBpZiAoaGF2ZUVycm9yc18gIT0gZmFsc2UpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVCb29sU2l6ZSgzLCBoYXZlRXJyb3JzXyk7DQogICAgICB9DQogICAgICBzaXplICs9IHVua25vd25GaWVsZHMuZ2V0U2VyaWFsaXplZFNpemUoKTsNCiAgICAgIG1lbW9pemVkU2l6ZSA9IHNpemU7DQogICAgICByZXR1cm4gc2l6ZTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGJvb2xlYW4gZXF1YWxzKGZpbmFsIGphdmEubGFuZy5PYmplY3Qgb2JqKSB7DQogICAgICBpZiAob2JqID09IHRoaXMpIHsNCiAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIGlmICghKG9iaiBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UpKSB7DQogICAgICAgIHJldHVybiBzdXBlci5lcXVhbHMob2JqKTsNCiAgICAgIH0NCiAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2Ugb3RoZXIgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSkgb2JqOw0KDQogICAgICBib29sZWFuIHJlc3VsdCA9IHRydWU7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0QmF0Y2hJRCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRCYXRjaElEKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldFJlc3VsdHNMaXN0KCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldFJlc3VsdHNMaXN0KCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChnZXRIYXZlRXJyb3JzKCkNCiAgICAgICAgICA9PSBvdGhlci5nZXRIYXZlRXJyb3JzKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIHVua25vd25GaWVsZHMuZXF1YWxzKG90aGVyLnVua25vd25GaWVsZHMpOw0KICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGludCBoYXNoQ29kZSgpIHsNCiAgICAgIGlmIChtZW1vaXplZEhhc2hDb2RlICE9IDApIHsNCiAgICAgICAgcmV0dXJuIG1lbW9pemVkSGFzaENvZGU7DQogICAgICB9DQogICAgICBpbnQgaGFzaCA9IDQxOw0KICAgICAgaGFzaCA9ICgxOSAqIGhhc2gpICsgZ2V0RGVzY3JpcHRvcigpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBCQVRDSElEX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldEJhdGNoSUQoKS5oYXNoQ29kZSgpOw0KICAgICAgaWYgKGdldFJlc3VsdHNDb3VudCgpID4gMCkgew0KICAgICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBSRVNVTFRTX0ZJRUxEX05VTUJFUjsNCiAgICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0UmVzdWx0c0xpc3QoKS5oYXNoQ29kZSgpOw0KICAgICAgfQ0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgSEFWRUVSUk9SU19GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBjb20uZ29vZ2xlLnByb3RvYnVmLkludGVybmFsLmhhc2hCb29sZWFuKA0KICAgICAgICAgIGdldEhhdmVFcnJvcnMoKSk7DQogICAgICBoYXNoID0gKDI5ICogaGFzaCkgKyB1bmtub3duRmllbGRzLmhhc2hDb2RlKCk7DQogICAgICBtZW1vaXplZEhhc2hDb2RlID0gaGFzaDsNCiAgICAgIHJldHVybiBoYXNoOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSBwYXJzZUZyb20oDQogICAgICAgIGphdmEubmlvLkJ5dGVCdWZmZXIgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSBwYXJzZUZyb20oYnl0ZVtdIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgYnl0ZVtdIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UgcGFyc2VGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSBwYXJzZURlbGltaXRlZEZyb20oamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UgcGFyc2VEZWxpbWl0ZWRGcm9tKA0KICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KDQogICAgcHVibGljIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoKSB7IHJldHVybiBuZXdCdWlsZGVyKCk7IH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcigpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFLnRvQnVpbGRlcigpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcihpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlIHByb3RvdHlwZSkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCkubWVyZ2VGcm9tKHByb3RvdHlwZSk7DQogICAgfQ0KICAgIHB1YmxpYyBCdWlsZGVyIHRvQnVpbGRlcigpIHsNCiAgICAgIHJldHVybiB0aGlzID09IERFRkFVTFRfSU5TVEFOQ0UNCiAgICAgICAgICA/IG5ldyBCdWlsZGVyKCkgOiBuZXcgQnVpbGRlcigpLm1lcmdlRnJvbSh0aGlzKTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHJvdGVjdGVkIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXJQYXJlbnQgcGFyZW50KSB7DQogICAgICBCdWlsZGVyIGJ1aWxkZXIgPSBuZXcgQnVpbGRlcihwYXJlbnQpOw0KICAgICAgcmV0dXJuIGJ1aWxkZXI7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZX0NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNsYXNzIEJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPEJ1aWxkZXI+IGltcGxlbWVudHMNCiAgICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfaW1wbGVtZW50czprdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UpDQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2VPckJ1aWxkZXIgew0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlX2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZV9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAgIC5lbnN1cmVGaWVsZEFjY2Vzc29yc0luaXRpYWxpemVkKA0KICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UuQnVpbGRlci5jbGFzcyk7DQogICAgICB9DQoNCiAgICAgIC8vIENvbnN0cnVjdCB1c2luZyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlLm5ld0J1aWxkZXIoKQ0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKCkgew0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgQnVpbGRlcigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgICBzdXBlcihwYXJlbnQpOw0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQogICAgICBwcml2YXRlIHZvaWQgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpIHsNCiAgICAgICAgaWYgKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgICAgICAgLmFsd2F5c1VzZUZpZWxkQnVpbGRlcnMpIHsNCiAgICAgICAgICBnZXRSZXN1bHRzRmllbGRCdWlsZGVyKCk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyKCkgew0KICAgICAgICBzdXBlci5jbGVhcigpOw0KICAgICAgICBiYXRjaElEXyA9ICIiOw0KDQogICAgICAgIGlmIChyZXN1bHRzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIHJlc3VsdHNfID0gamF2YS51dGlsLkNvbGxlY3Rpb25zLmVtcHR5TGlzdCgpOw0KICAgICAgICAgIGJpdEZpZWxkMF8gPSAoYml0RmllbGQwXyAmIH4weDAwMDAwMDAyKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXN1bHRzQnVpbGRlcl8uY2xlYXIoKTsNCiAgICAgICAgfQ0KICAgICAgICBoYXZlRXJyb3JzXyA9IGZhbHNlOw0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvckZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2VfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UuZ2V0RGVmYXVsdEluc3RhbmNlKCk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlIGJ1aWxkKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlIHJlc3VsdCA9IGJ1aWxkUGFydGlhbCgpOw0KICAgICAgICBpZiAoIXJlc3VsdC5pc0luaXRpYWxpemVkKCkpIHsNCiAgICAgICAgICB0aHJvdyBuZXdVbmluaXRpYWxpemVkTWVzc2FnZUV4Y2VwdGlvbihyZXN1bHQpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiByZXN1bHQ7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlIGJ1aWxkUGFydGlhbCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSByZXN1bHQgPSBuZXcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSh0aGlzKTsNCiAgICAgICAgaW50IGZyb21fYml0RmllbGQwXyA9IGJpdEZpZWxkMF87DQogICAgICAgIGludCB0b19iaXRGaWVsZDBfID0gMDsNCiAgICAgICAgcmVzdWx0LmJhdGNoSURfID0gYmF0Y2hJRF87DQogICAgICAgIGlmIChyZXN1bHRzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGlmICgoKGJpdEZpZWxkMF8gJiAweDAwMDAwMDAyKSA9PSAweDAwMDAwMDAyKSkgew0KICAgICAgICAgICAgcmVzdWx0c18gPSBqYXZhLnV0aWwuQ29sbGVjdGlvbnMudW5tb2RpZmlhYmxlTGlzdChyZXN1bHRzXyk7DQogICAgICAgICAgICBiaXRGaWVsZDBfID0gKGJpdEZpZWxkMF8gJiB+MHgwMDAwMDAwMik7DQogICAgICAgICAgfQ0KICAgICAgICAgIHJlc3VsdC5yZXN1bHRzXyA9IHJlc3VsdHNfOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJlc3VsdC5yZXN1bHRzXyA9IHJlc3VsdHNCdWlsZGVyXy5idWlsZCgpOw0KICAgICAgICB9DQogICAgICAgIHJlc3VsdC5oYXZlRXJyb3JzXyA9IGhhdmVFcnJvcnNfOw0KICAgICAgICByZXN1bHQuYml0RmllbGQwXyA9IHRvX2JpdEZpZWxkMF87DQogICAgICAgIG9uQnVpbHQoKTsNCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xvbmUoKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xvbmUoKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyRmllbGQoZmllbGQpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJPbmVvZigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLk9uZW9mRGVzY3JpcHRvciBvbmVvZikgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyT25lb2Yob25lb2YpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBpbnQgaW5kZXgsIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRSZXBlYXRlZEZpZWxkKGZpZWxkLCBpbmRleCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgYWRkUmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuYWRkUmVwZWF0ZWRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZSBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlKSB7DQogICAgICAgICAgcmV0dXJuIG1lcmdlRnJvbSgoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSlvdGhlcik7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgc3VwZXIubWVyZ2VGcm9tKG90aGVyKTsNCiAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfQ0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgPT0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZS5nZXREZWZhdWx0SW5zdGFuY2UoKSkgcmV0dXJuIHRoaXM7DQogICAgICAgIGlmICghb3RoZXIuZ2V0QmF0Y2hJRCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIGJhdGNoSURfID0gb3RoZXIuYmF0Y2hJRF87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHJlc3VsdHNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgaWYgKCFvdGhlci5yZXN1bHRzXy5pc0VtcHR5KCkpIHsNCiAgICAgICAgICAgIGlmIChyZXN1bHRzXy5pc0VtcHR5KCkpIHsNCiAgICAgICAgICAgICAgcmVzdWx0c18gPSBvdGhlci5yZXN1bHRzXzsNCiAgICAgICAgICAgICAgYml0RmllbGQwXyA9IChiaXRGaWVsZDBfICYgfjB4MDAwMDAwMDIpOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgZW5zdXJlUmVzdWx0c0lzTXV0YWJsZSgpOw0KICAgICAgICAgICAgICByZXN1bHRzXy5hZGRBbGwob3RoZXIucmVzdWx0c18pOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGlmICghb3RoZXIucmVzdWx0c18uaXNFbXB0eSgpKSB7DQogICAgICAgICAgICBpZiAocmVzdWx0c0J1aWxkZXJfLmlzRW1wdHkoKSkgew0KICAgICAgICAgICAgICByZXN1bHRzQnVpbGRlcl8uZGlzcG9zZSgpOw0KICAgICAgICAgICAgICByZXN1bHRzQnVpbGRlcl8gPSBudWxsOw0KICAgICAgICAgICAgICByZXN1bHRzXyA9IG90aGVyLnJlc3VsdHNfOw0KICAgICAgICAgICAgICBiaXRGaWVsZDBfID0gKGJpdEZpZWxkMF8gJiB+MHgwMDAwMDAwMik7DQogICAgICAgICAgICAgIHJlc3VsdHNCdWlsZGVyXyA9IA0KICAgICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmFsd2F5c1VzZUZpZWxkQnVpbGRlcnMgPw0KICAgICAgICAgICAgICAgICAgIGdldFJlc3VsdHNGaWVsZEJ1aWxkZXIoKSA6IG51bGw7DQogICAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgICByZXN1bHRzQnVpbGRlcl8uYWRkQWxsTWVzc2FnZXMob3RoZXIucmVzdWx0c18pOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0SGF2ZUVycm9ycygpICE9IGZhbHNlKSB7DQogICAgICAgICAgc2V0SGF2ZUVycm9ycyhvdGhlci5nZXRIYXZlRXJyb3JzKCkpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMubWVyZ2VVbmtub3duRmllbGRzKG90aGVyLnVua25vd25GaWVsZHMpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSBwYXJzZWRNZXNzYWdlID0gbnVsbDsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gUEFSU0VSLnBhcnNlUGFydGlhbEZyb20oaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSkgZS5nZXRVbmZpbmlzaGVkTWVzc2FnZSgpOw0KICAgICAgICAgIHRocm93IGUudW53cmFwSU9FeGNlcHRpb24oKTsNCiAgICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgICBpZiAocGFyc2VkTWVzc2FnZSAhPSBudWxsKSB7DQogICAgICAgICAgICBtZXJnZUZyb20ocGFyc2VkTWVzc2FnZSk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgcHJpdmF0ZSBpbnQgYml0RmllbGQwXzsNCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IGJhdGNoSURfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBCYXRjaElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldEJhdGNoSUQoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gYmF0Y2hJRF87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIGJhdGNoSURfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQmF0Y2hJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0QmF0Y2hJREJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGJhdGNoSURfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIGJhdGNoSURfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBCYXRjaElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEJhdGNoSUQoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBiYXRjaElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBCYXRjaElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyQmF0Y2hJRCgpIHsNCiAgICAgICAgDQogICAgICAgIGJhdGNoSURfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0QmF0Y2hJRCgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBCYXRjaElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEJhdGNoSURCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgYmF0Y2hJRF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEudXRpbC5MaXN0PGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdD4gcmVzdWx0c18gPQ0KICAgICAgICBqYXZhLnV0aWwuQ29sbGVjdGlvbnMuZW1wdHlMaXN0KCk7DQogICAgICBwcml2YXRlIHZvaWQgZW5zdXJlUmVzdWx0c0lzTXV0YWJsZSgpIHsNCiAgICAgICAgaWYgKCEoKGJpdEZpZWxkMF8gJiAweDAwMDAwMDAyKSA9PSAweDAwMDAwMDAyKSkgew0KICAgICAgICAgIHJlc3VsdHNfID0gbmV3IGphdmEudXRpbC5BcnJheUxpc3Q8aW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0PihyZXN1bHRzXyk7DQogICAgICAgICAgYml0RmllbGQwXyB8PSAweDAwMDAwMDAyOw0KICAgICAgICAgfQ0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuUmVwZWF0ZWRGaWVsZEJ1aWxkZXJWMzwNCiAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdC5CdWlsZGVyLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHRPckJ1aWxkZXI+IHJlc3VsdHNCdWlsZGVyXzsNCg0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgUmVzdWx0cyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS51dGlsLkxpc3Q8aW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0PiBnZXRSZXN1bHRzTGlzdCgpIHsNCiAgICAgICAgaWYgKHJlc3VsdHNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgcmV0dXJuIGphdmEudXRpbC5Db2xsZWN0aW9ucy51bm1vZGlmaWFibGVMaXN0KHJlc3VsdHNfKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gcmVzdWx0c0J1aWxkZXJfLmdldE1lc3NhZ2VMaXN0KCk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IFJlc3VsdHMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGludCBnZXRSZXN1bHRzQ291bnQoKSB7DQogICAgICAgIGlmIChyZXN1bHRzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIHJldHVybiByZXN1bHRzXy5zaXplKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIHJlc3VsdHNCdWlsZGVyXy5nZXRDb3VudCgpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBSZXN1bHRzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgZ2V0UmVzdWx0cyhpbnQgaW5kZXgpIHsNCiAgICAgICAgaWYgKHJlc3VsdHNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgcmV0dXJuIHJlc3VsdHNfLmdldChpbmRleCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIHJlc3VsdHNCdWlsZGVyXy5nZXRNZXNzYWdlKGluZGV4KTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgUmVzdWx0cyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXN1bHRzKA0KICAgICAgICAgIGludCBpbmRleCwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IHZhbHVlKSB7DQogICAgICAgIGlmIChyZXN1bHRzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgICAgICAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgICAgICAgICB9DQogICAgICAgICAgZW5zdXJlUmVzdWx0c0lzTXV0YWJsZSgpOw0KICAgICAgICAgIHJlc3VsdHNfLnNldChpbmRleCwgdmFsdWUpOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJlc3VsdHNCdWlsZGVyXy5zZXRNZXNzYWdlKGluZGV4LCB2YWx1ZSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBSZXN1bHRzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlc3VsdHMoDQogICAgICAgICAgaW50IGluZGV4LCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQuQnVpbGRlciBidWlsZGVyRm9yVmFsdWUpIHsNCiAgICAgICAgaWYgKHJlc3VsdHNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgZW5zdXJlUmVzdWx0c0lzTXV0YWJsZSgpOw0KICAgICAgICAgIHJlc3VsdHNfLnNldChpbmRleCwgYnVpbGRlckZvclZhbHVlLmJ1aWxkKCkpOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJlc3VsdHNCdWlsZGVyXy5zZXRNZXNzYWdlKGluZGV4LCBidWlsZGVyRm9yVmFsdWUuYnVpbGQoKSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBSZXN1bHRzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGFkZFJlc3VsdHMoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IHZhbHVlKSB7DQogICAgICAgIGlmIChyZXN1bHRzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgICAgICAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgICAgICAgICB9DQogICAgICAgICAgZW5zdXJlUmVzdWx0c0lzTXV0YWJsZSgpOw0KICAgICAgICAgIHJlc3VsdHNfLmFkZCh2YWx1ZSk7DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmVzdWx0c0J1aWxkZXJfLmFkZE1lc3NhZ2UodmFsdWUpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgUmVzdWx0cyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBhZGRSZXN1bHRzKA0KICAgICAgICAgIGludCBpbmRleCwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IHZhbHVlKSB7DQogICAgICAgIGlmIChyZXN1bHRzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgICAgICAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgICAgICAgICB9DQogICAgICAgICAgZW5zdXJlUmVzdWx0c0lzTXV0YWJsZSgpOw0KICAgICAgICAgIHJlc3VsdHNfLmFkZChpbmRleCwgdmFsdWUpOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJlc3VsdHNCdWlsZGVyXy5hZGRNZXNzYWdlKGluZGV4LCB2YWx1ZSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBSZXN1bHRzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGFkZFJlc3VsdHMoDQogICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0LkJ1aWxkZXIgYnVpbGRlckZvclZhbHVlKSB7DQogICAgICAgIGlmIChyZXN1bHRzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGVuc3VyZVJlc3VsdHNJc011dGFibGUoKTsNCiAgICAgICAgICByZXN1bHRzXy5hZGQoYnVpbGRlckZvclZhbHVlLmJ1aWxkKCkpOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJlc3VsdHNCdWlsZGVyXy5hZGRNZXNzYWdlKGJ1aWxkZXJGb3JWYWx1ZS5idWlsZCgpKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IFJlc3VsdHMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgYWRkUmVzdWx0cygNCiAgICAgICAgICBpbnQgaW5kZXgsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdC5CdWlsZGVyIGJ1aWxkZXJGb3JWYWx1ZSkgew0KICAgICAgICBpZiAocmVzdWx0c0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBlbnN1cmVSZXN1bHRzSXNNdXRhYmxlKCk7DQogICAgICAgICAgcmVzdWx0c18uYWRkKGluZGV4LCBidWlsZGVyRm9yVmFsdWUuYnVpbGQoKSk7DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmVzdWx0c0J1aWxkZXJfLmFkZE1lc3NhZ2UoaW5kZXgsIGJ1aWxkZXJGb3JWYWx1ZS5idWlsZCgpKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IFJlc3VsdHMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgYWRkQWxsUmVzdWx0cygNCiAgICAgICAgICBqYXZhLmxhbmcuSXRlcmFibGU8PyBleHRlbmRzIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdD4gdmFsdWVzKSB7DQogICAgICAgIGlmIChyZXN1bHRzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGVuc3VyZVJlc3VsdHNJc011dGFibGUoKTsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkFic3RyYWN0TWVzc2FnZUxpdGUuQnVpbGRlci5hZGRBbGwoDQogICAgICAgICAgICAgIHZhbHVlcywgcmVzdWx0c18pOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJlc3VsdHNCdWlsZGVyXy5hZGRBbGxNZXNzYWdlcyh2YWx1ZXMpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgUmVzdWx0cyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhclJlc3VsdHMoKSB7DQogICAgICAgIGlmIChyZXN1bHRzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIHJlc3VsdHNfID0gamF2YS51dGlsLkNvbGxlY3Rpb25zLmVtcHR5TGlzdCgpOw0KICAgICAgICAgIGJpdEZpZWxkMF8gPSAoYml0RmllbGQwXyAmIH4weDAwMDAwMDAyKTsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXN1bHRzQnVpbGRlcl8uY2xlYXIoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IFJlc3VsdHMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgcmVtb3ZlUmVzdWx0cyhpbnQgaW5kZXgpIHsNCiAgICAgICAgaWYgKHJlc3VsdHNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgZW5zdXJlUmVzdWx0c0lzTXV0YWJsZSgpOw0KICAgICAgICAgIHJlc3VsdHNfLnJlbW92ZShpbmRleCk7DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmVzdWx0c0J1aWxkZXJfLnJlbW92ZShpbmRleCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBSZXN1bHRzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQuQnVpbGRlciBnZXRSZXN1bHRzQnVpbGRlcigNCiAgICAgICAgICBpbnQgaW5kZXgpIHsNCiAgICAgICAgcmV0dXJuIGdldFJlc3VsdHNGaWVsZEJ1aWxkZXIoKS5nZXRCdWlsZGVyKGluZGV4KTsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IFJlc3VsdHMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdE9yQnVpbGRlciBnZXRSZXN1bHRzT3JCdWlsZGVyKA0KICAgICAgICAgIGludCBpbmRleCkgew0KICAgICAgICBpZiAocmVzdWx0c0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICByZXR1cm4gcmVzdWx0c18uZ2V0KGluZGV4KTsgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIHJlc3VsdHNCdWlsZGVyXy5nZXRNZXNzYWdlT3JCdWlsZGVyKGluZGV4KTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgUmVzdWx0cyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS51dGlsLkxpc3Q8PyBleHRlbmRzIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdE9yQnVpbGRlcj4gDQogICAgICAgICAgIGdldFJlc3VsdHNPckJ1aWxkZXJMaXN0KCkgew0KICAgICAgICBpZiAocmVzdWx0c0J1aWxkZXJfICE9IG51bGwpIHsNCiAgICAgICAgICByZXR1cm4gcmVzdWx0c0J1aWxkZXJfLmdldE1lc3NhZ2VPckJ1aWxkZXJMaXN0KCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIGphdmEudXRpbC5Db2xsZWN0aW9ucy51bm1vZGlmaWFibGVMaXN0KHJlc3VsdHNfKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgUmVzdWx0cyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0LkJ1aWxkZXIgYWRkUmVzdWx0c0J1aWxkZXIoKSB7DQogICAgICAgIHJldHVybiBnZXRSZXN1bHRzRmllbGRCdWlsZGVyKCkuYWRkQnVpbGRlcigNCiAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdC5nZXREZWZhdWx0SW5zdGFuY2UoKSk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBSZXN1bHRzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQuQnVpbGRlciBhZGRSZXN1bHRzQnVpbGRlcigNCiAgICAgICAgICBpbnQgaW5kZXgpIHsNCiAgICAgICAgcmV0dXJuIGdldFJlc3VsdHNGaWVsZEJ1aWxkZXIoKS5hZGRCdWlsZGVyKA0KICAgICAgICAgICAgaW5kZXgsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdC5nZXREZWZhdWx0SW5zdGFuY2UoKSk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBSZXN1bHRzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLnV0aWwuTGlzdDxpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQuQnVpbGRlcj4gDQogICAgICAgICAgIGdldFJlc3VsdHNCdWlsZGVyTGlzdCgpIHsNCiAgICAgICAgcmV0dXJuIGdldFJlc3VsdHNGaWVsZEJ1aWxkZXIoKS5nZXRCdWlsZGVyTGlzdCgpOw0KICAgICAgfQ0KICAgICAgcHJpdmF0ZSBjb20uZ29vZ2xlLnByb3RvYnVmLlJlcGVhdGVkRmllbGRCdWlsZGVyVjM8DQogICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0LCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQuQnVpbGRlciwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0T3JCdWlsZGVyPiANCiAgICAgICAgICBnZXRSZXN1bHRzRmllbGRCdWlsZGVyKCkgew0KICAgICAgICBpZiAocmVzdWx0c0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICByZXN1bHRzQnVpbGRlcl8gPSBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5SZXBlYXRlZEZpZWxkQnVpbGRlclYzPA0KICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdC5CdWlsZGVyLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHRPckJ1aWxkZXI+KA0KICAgICAgICAgICAgICAgICAgcmVzdWx0c18sDQogICAgICAgICAgICAgICAgICAoKGJpdEZpZWxkMF8gJiAweDAwMDAwMDAyKSA9PSAweDAwMDAwMDAyKSwNCiAgICAgICAgICAgICAgICAgIGdldFBhcmVudEZvckNoaWxkcmVuKCksDQogICAgICAgICAgICAgICAgICBpc0NsZWFuKCkpOw0KICAgICAgICAgIHJlc3VsdHNfID0gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVzdWx0c0J1aWxkZXJfOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGJvb2xlYW4gaGF2ZUVycm9yc18gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIEhhdmVFcnJvcnMgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGJvb2xlYW4gZ2V0SGF2ZUVycm9ycygpIHsNCiAgICAgICAgcmV0dXJuIGhhdmVFcnJvcnNfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIEhhdmVFcnJvcnMgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0SGF2ZUVycm9ycyhib29sZWFuIHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICBoYXZlRXJyb3JzXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJvb2wgSGF2ZUVycm9ycyA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckhhdmVFcnJvcnMoKSB7DQogICAgICAgIA0KICAgICAgICBoYXZlRXJyb3JzXyA9IGZhbHNlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBzZXRVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLnNldFVua25vd25GaWVsZHNQcm90bzModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIG1lcmdlVW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5tZXJnZVVua25vd25GaWVsZHModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCg0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfc2NvcGU6a3ViZW1xLlF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlKQ0KICAgIH0NCg0KICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChjbGFzc19zY29wZTprdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UpDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSBERUZBVUxUX0lOU1RBTkNFOw0KICAgIHN0YXRpYyB7DQogICAgICBERUZBVUxUX0lOU1RBTkNFID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UoKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UgZ2V0RGVmYXVsdEluc3RhbmNlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2U+DQogICAgICAgIFBBUlNFUiA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkFic3RyYWN0UGFyc2VyPFF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlPigpIHsNCiAgICAgIHB1YmxpYyBRdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZSBwYXJzZVBhcnRpYWxGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgICByZXR1cm4gbmV3IFF1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlKGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICB9DQogICAgfTsNCg0KICAgIHB1YmxpYyBzdGF0aWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2U+IHBhcnNlcigpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxRdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZT4gZ2V0UGFyc2VyRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2UgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFOw0KICAgIH0NCg0KICB9DQoNCiAgcHVibGljIGludGVyZmFjZSBRdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzT3JCdWlsZGVyIGV4dGVuZHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChpbnRlcmZhY2VfZXh0ZW5kczprdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcykNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZU9yQnVpbGRlciB7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQ2NCBUaW1lc3RhbXAgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBsb25nIGdldFRpbWVzdGFtcCgpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+dWludDY0IFNlcXVlbmNlID0gMjs8L2NvZGU+DQogICAgICovDQogICAgbG9uZyBnZXRTZXF1ZW5jZSgpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1ENU9mQm9keSA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0TUQ1T2ZCb2R5KCk7DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1ENU9mQm9keSA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRNRDVPZkJvZHlCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+aW50MzIgUmVjZWl2ZUNvdW50ID0gNDs8L2NvZGU+DQogICAgICovDQogICAgaW50IGdldFJlY2VpdmVDb3VudCgpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+Ym9vbCBSZVJvdXRlZCA9IDU7PC9jb2RlPg0KICAgICAqLw0KICAgIGJvb2xlYW4gZ2V0UmVSb3V0ZWQoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBSZVJvdXRlZEZyb21RdWV1ZSA9IDY7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0UmVSb3V0ZWRGcm9tUXVldWUoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVSb3V0ZWRGcm9tUXVldWUgPSA2OzwvY29kZT4NCiAgICAgKi8NCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0UmVSb3V0ZWRGcm9tUXVldWVCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+aW50NjQgRXhwaXJhdGlvbkF0ID0gNzs8L2NvZGU+DQogICAgICovDQogICAgbG9uZyBnZXRFeHBpcmF0aW9uQXQoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDY0IERlbGF5ZWRUbyA9IDg7PC9jb2RlPg0KICAgICAqLw0KICAgIGxvbmcgZ2V0RGVsYXllZFRvKCk7DQogIH0NCiAgLyoqDQogICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzfQ0KICAgKi8NCiAgcHVibGljICBzdGF0aWMgZmluYWwgY2xhc3MgUXVldWVNZXNzYWdlQXR0cmlidXRlcyBleHRlbmRzDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMyBpbXBsZW1lbnRzDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQobWVzc2FnZV9pbXBsZW1lbnRzOmt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzKQ0KICAgICAgUXVldWVNZXNzYWdlQXR0cmlidXRlc09yQnVpbGRlciB7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGxvbmcgc2VyaWFsVmVyc2lvblVJRCA9IDBMOw0KICAgIC8vIFVzZSBRdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzLm5ld0J1aWxkZXIoKSB0byBjb25zdHJ1Y3QuDQogICAgcHJpdmF0ZSBRdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8Pz4gYnVpbGRlcikgew0KICAgICAgc3VwZXIoYnVpbGRlcik7DQogICAgfQ0KICAgIHByaXZhdGUgUXVldWVNZXNzYWdlQXR0cmlidXRlcygpIHsNCiAgICAgIHRpbWVzdGFtcF8gPSAwTDsNCiAgICAgIHNlcXVlbmNlXyA9IDBMOw0KICAgICAgbUQ1T2ZCb2R5XyA9ICIiOw0KICAgICAgcmVjZWl2ZUNvdW50XyA9IDA7DQogICAgICByZVJvdXRlZF8gPSBmYWxzZTsNCiAgICAgIHJlUm91dGVkRnJvbVF1ZXVlXyA9ICIiOw0KICAgICAgZXhwaXJhdGlvbkF0XyA9IDBMOw0KICAgICAgZGVsYXllZFRvXyA9IDBMOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQNCiAgICBnZXRVbmtub3duRmllbGRzKCkgew0KICAgICAgcmV0dXJuIHRoaXMudW5rbm93bkZpZWxkczsNCiAgICB9DQogICAgcHJpdmF0ZSBRdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgdGhpcygpOw0KICAgICAgaWYgKGV4dGVuc2lvblJlZ2lzdHJ5ID09IG51bGwpIHsNCiAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgfQ0KICAgICAgaW50IG11dGFibGVfYml0RmllbGQwXyA9IDA7DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldC5CdWlsZGVyIHVua25vd25GaWVsZHMgPQ0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0Lm5ld0J1aWxkZXIoKTsNCiAgICAgIHRyeSB7DQogICAgICAgIGJvb2xlYW4gZG9uZSA9IGZhbHNlOw0KICAgICAgICB3aGlsZSAoIWRvbmUpIHsNCiAgICAgICAgICBpbnQgdGFnID0gaW5wdXQucmVhZFRhZygpOw0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7DQogICAgICAgICAgICBjYXNlIDA6DQogICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGRlZmF1bHQ6IHsNCiAgICAgICAgICAgICAgaWYgKCFwYXJzZVVua25vd25GaWVsZFByb3RvMygNCiAgICAgICAgICAgICAgICAgIGlucHV0LCB1bmtub3duRmllbGRzLCBleHRlbnNpb25SZWdpc3RyeSwgdGFnKSkgew0KICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSA4OiB7DQoNCiAgICAgICAgICAgICAgdGltZXN0YW1wXyA9IGlucHV0LnJlYWRJbnQ2NCgpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMTY6IHsNCg0KICAgICAgICAgICAgICBzZXF1ZW5jZV8gPSBpbnB1dC5yZWFkVUludDY0KCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAyNjogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICBtRDVPZkJvZHlfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDMyOiB7DQoNCiAgICAgICAgICAgICAgcmVjZWl2ZUNvdW50XyA9IGlucHV0LnJlYWRJbnQzMigpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNDA6IHsNCg0KICAgICAgICAgICAgICByZVJvdXRlZF8gPSBpbnB1dC5yZWFkQm9vbCgpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNTA6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgcmVSb3V0ZWRGcm9tUXVldWVfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDU2OiB7DQoNCiAgICAgICAgICAgICAgZXhwaXJhdGlvbkF0XyA9IGlucHV0LnJlYWRJbnQ2NCgpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNjQ6IHsNCg0KICAgICAgICAgICAgICBkZWxheWVkVG9fID0gaW5wdXQucmVhZEludDY0KCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBlLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBjYXRjaCAoamF2YS5pby5JT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbigNCiAgICAgICAgICAgIGUpLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgdGhpcy51bmtub3duRmllbGRzID0gdW5rbm93bkZpZWxkcy5idWlsZCgpOw0KICAgICAgICBtYWtlRXh0ZW5zaW9uc0ltbXV0YWJsZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzX2Rlc2NyaXB0b3I7DQogICAgfQ0KDQogICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlQXR0cmlidXRlc19maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzLmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMuQnVpbGRlci5jbGFzcyk7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgVElNRVNUQU1QX0ZJRUxEX05VTUJFUiA9IDE7DQogICAgcHJpdmF0ZSBsb25nIHRpbWVzdGFtcF87DQogICAgLyoqDQogICAgICogPGNvZGU+aW50NjQgVGltZXN0YW1wID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGxvbmcgZ2V0VGltZXN0YW1wKCkgew0KICAgICAgcmV0dXJuIHRpbWVzdGFtcF87DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU0VRVUVOQ0VfRklFTERfTlVNQkVSID0gMjsNCiAgICBwcml2YXRlIGxvbmcgc2VxdWVuY2VfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnVpbnQ2NCBTZXF1ZW5jZSA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBsb25nIGdldFNlcXVlbmNlKCkgew0KICAgICAgcmV0dXJuIHNlcXVlbmNlXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNRDVPRkJPRFlfRklFTERfTlVNQkVSID0gMzsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgbUQ1T2ZCb2R5XzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgTUQ1T2ZCb2R5ID0gMzs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0TUQ1T2ZCb2R5KCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBtRDVPZkJvZHlfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIG1ENU9mQm9keV8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1ENU9mQm9keSA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0TUQ1T2ZCb2R5Qnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1ENU9mQm9keV87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgbUQ1T2ZCb2R5XyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBSRUNFSVZFQ09VTlRfRklFTERfTlVNQkVSID0gNDsNCiAgICBwcml2YXRlIGludCByZWNlaXZlQ291bnRfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDMyIFJlY2VpdmVDb3VudCA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpbnQgZ2V0UmVjZWl2ZUNvdW50KCkgew0KICAgICAgcmV0dXJuIHJlY2VpdmVDb3VudF87DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUkVST1VURURfRklFTERfTlVNQkVSID0gNTsNCiAgICBwcml2YXRlIGJvb2xlYW4gcmVSb3V0ZWRfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmJvb2wgUmVSb3V0ZWQgPSA1OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgYm9vbGVhbiBnZXRSZVJvdXRlZCgpIHsNCiAgICAgIHJldHVybiByZVJvdXRlZF87DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgUkVST1VURURGUk9NUVVFVUVfRklFTERfTlVNQkVSID0gNjsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgcmVSb3V0ZWRGcm9tUXVldWVfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBSZVJvdXRlZEZyb21RdWV1ZSA9IDY7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFJlUm91dGVkRnJvbVF1ZXVlKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZVJvdXRlZEZyb21RdWV1ZV87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgcmVSb3V0ZWRGcm9tUXVldWVfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBSZVJvdXRlZEZyb21RdWV1ZSA9IDY7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0UmVSb3V0ZWRGcm9tUXVldWVCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVSb3V0ZWRGcm9tUXVldWVfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIHJlUm91dGVkRnJvbVF1ZXVlXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBFWFBJUkFUSU9OQVRfRklFTERfTlVNQkVSID0gNzsNCiAgICBwcml2YXRlIGxvbmcgZXhwaXJhdGlvbkF0XzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQ2NCBFeHBpcmF0aW9uQXQgPSA3OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgbG9uZyBnZXRFeHBpcmF0aW9uQXQoKSB7DQogICAgICByZXR1cm4gZXhwaXJhdGlvbkF0XzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBERUxBWUVEVE9fRklFTERfTlVNQkVSID0gODsNCiAgICBwcml2YXRlIGxvbmcgZGVsYXllZFRvXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQ2NCBEZWxheWVkVG8gPSA4OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgbG9uZyBnZXREZWxheWVkVG8oKSB7DQogICAgICByZXR1cm4gZGVsYXllZFRvXzsNCiAgICB9DQoNCiAgICBwcml2YXRlIGJ5dGUgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gLTE7DQogICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgIGJ5dGUgaXNJbml0aWFsaXplZCA9IG1lbW9pemVkSXNJbml0aWFsaXplZDsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDEpIHJldHVybiB0cnVlOw0KICAgICAgaWYgKGlzSW5pdGlhbGl6ZWQgPT0gMCkgcmV0dXJuIGZhbHNlOw0KDQogICAgICBtZW1vaXplZElzSW5pdGlhbGl6ZWQgPSAxOw0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KDQogICAgcHVibGljIHZvaWQgd3JpdGVUbyhjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtIG91dHB1dCkNCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIGlmICh0aW1lc3RhbXBfICE9IDBMKSB7DQogICAgICAgIG91dHB1dC53cml0ZUludDY0KDEsIHRpbWVzdGFtcF8pOw0KICAgICAgfQ0KICAgICAgaWYgKHNlcXVlbmNlXyAhPSAwTCkgew0KICAgICAgICBvdXRwdXQud3JpdGVVSW50NjQoMiwgc2VxdWVuY2VfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0TUQ1T2ZCb2R5Qnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAzLCBtRDVPZkJvZHlfKTsNCiAgICAgIH0NCiAgICAgIGlmIChyZWNlaXZlQ291bnRfICE9IDApIHsNCiAgICAgICAgb3V0cHV0LndyaXRlSW50MzIoNCwgcmVjZWl2ZUNvdW50Xyk7DQogICAgICB9DQogICAgICBpZiAocmVSb3V0ZWRfICE9IGZhbHNlKSB7DQogICAgICAgIG91dHB1dC53cml0ZUJvb2woNSwgcmVSb3V0ZWRfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0UmVSb3V0ZWRGcm9tUXVldWVCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDYsIHJlUm91dGVkRnJvbVF1ZXVlXyk7DQogICAgICB9DQogICAgICBpZiAoZXhwaXJhdGlvbkF0XyAhPSAwTCkgew0KICAgICAgICBvdXRwdXQud3JpdGVJbnQ2NCg3LCBleHBpcmF0aW9uQXRfKTsNCiAgICAgIH0NCiAgICAgIGlmIChkZWxheWVkVG9fICE9IDBMKSB7DQogICAgICAgIG91dHB1dC53cml0ZUludDY0KDgsIGRlbGF5ZWRUb18pOw0KICAgICAgfQ0KICAgICAgdW5rbm93bkZpZWxkcy53cml0ZVRvKG91dHB1dCk7DQogICAgfQ0KDQogICAgcHVibGljIGludCBnZXRTZXJpYWxpemVkU2l6ZSgpIHsNCiAgICAgIGludCBzaXplID0gbWVtb2l6ZWRTaXplOw0KICAgICAgaWYgKHNpemUgIT0gLTEpIHJldHVybiBzaXplOw0KDQogICAgICBzaXplID0gMDsNCiAgICAgIGlmICh0aW1lc3RhbXBfICE9IDBMKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlSW50NjRTaXplKDEsIHRpbWVzdGFtcF8pOw0KICAgICAgfQ0KICAgICAgaWYgKHNlcXVlbmNlXyAhPSAwTCkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZVVJbnQ2NFNpemUoMiwgc2VxdWVuY2VfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0TUQ1T2ZCb2R5Qnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSgzLCBtRDVPZkJvZHlfKTsNCiAgICAgIH0NCiAgICAgIGlmIChyZWNlaXZlQ291bnRfICE9IDApIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVJbnQzMlNpemUoNCwgcmVjZWl2ZUNvdW50Xyk7DQogICAgICB9DQogICAgICBpZiAocmVSb3V0ZWRfICE9IGZhbHNlKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlQm9vbFNpemUoNSwgcmVSb3V0ZWRfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0UmVSb3V0ZWRGcm9tUXVldWVCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDYsIHJlUm91dGVkRnJvbVF1ZXVlXyk7DQogICAgICB9DQogICAgICBpZiAoZXhwaXJhdGlvbkF0XyAhPSAwTCkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUludDY0U2l6ZSg3LCBleHBpcmF0aW9uQXRfKTsNCiAgICAgIH0NCiAgICAgIGlmIChkZWxheWVkVG9fICE9IDBMKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlSW50NjRTaXplKDgsIGRlbGF5ZWRUb18pOw0KICAgICAgfQ0KICAgICAgc2l6ZSArPSB1bmtub3duRmllbGRzLmdldFNlcmlhbGl6ZWRTaXplKCk7DQogICAgICBtZW1vaXplZFNpemUgPSBzaXplOw0KICAgICAgcmV0dXJuIHNpemU7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBib29sZWFuIGVxdWFscyhmaW5hbCBqYXZhLmxhbmcuT2JqZWN0IG9iaikgew0KICAgICAgaWYgKG9iaiA9PSB0aGlzKSB7DQogICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgICBpZiAoIShvYmogaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMpKSB7DQogICAgICAgIHJldHVybiBzdXBlci5lcXVhbHMob2JqKTsNCiAgICAgIH0NCiAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcyBvdGhlciA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMpIG9iajsNCg0KICAgICAgYm9vbGVhbiByZXN1bHQgPSB0cnVlOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChnZXRUaW1lc3RhbXAoKQ0KICAgICAgICAgID09IG90aGVyLmdldFRpbWVzdGFtcCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiAoZ2V0U2VxdWVuY2UoKQ0KICAgICAgICAgID09IG90aGVyLmdldFNlcXVlbmNlKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldE1ENU9mQm9keSgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRNRDVPZkJvZHkoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldFJlY2VpdmVDb3VudCgpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0UmVjZWl2ZUNvdW50KCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChnZXRSZVJvdXRlZCgpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0UmVSb3V0ZWQoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0UmVSb3V0ZWRGcm9tUXVldWUoKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0UmVSb3V0ZWRGcm9tUXVldWUoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldEV4cGlyYXRpb25BdCgpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0RXhwaXJhdGlvbkF0KCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChnZXREZWxheWVkVG8oKQ0KICAgICAgICAgID09IG90aGVyLmdldERlbGF5ZWRUbygpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiB1bmtub3duRmllbGRzLmVxdWFscyhvdGhlci51bmtub3duRmllbGRzKTsNCiAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBpbnQgaGFzaENvZGUoKSB7DQogICAgICBpZiAobWVtb2l6ZWRIYXNoQ29kZSAhPSAwKSB7DQogICAgICAgIHJldHVybiBtZW1vaXplZEhhc2hDb2RlOw0KICAgICAgfQ0KICAgICAgaW50IGhhc2ggPSA0MTsNCiAgICAgIGhhc2ggPSAoMTkgKiBoYXNoKSArIGdldERlc2NyaXB0b3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgVElNRVNUQU1QX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGNvbS5nb29nbGUucHJvdG9idWYuSW50ZXJuYWwuaGFzaExvbmcoDQogICAgICAgICAgZ2V0VGltZXN0YW1wKCkpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgU0VRVUVOQ0VfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5oYXNoTG9uZygNCiAgICAgICAgICBnZXRTZXF1ZW5jZSgpKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIE1ENU9GQk9EWV9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRNRDVPZkJvZHkoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgUkVDRUlWRUNPVU5UX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldFJlY2VpdmVDb3VudCgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgUkVST1VURURfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5oYXNoQm9vbGVhbigNCiAgICAgICAgICBnZXRSZVJvdXRlZCgpKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFJFUk9VVEVERlJPTVFVRVVFX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldFJlUm91dGVkRnJvbVF1ZXVlKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIEVYUElSQVRJT05BVF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBjb20uZ29vZ2xlLnByb3RvYnVmLkludGVybmFsLmhhc2hMb25nKA0KICAgICAgICAgIGdldEV4cGlyYXRpb25BdCgpKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIERFTEFZRURUT19GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBjb20uZ29vZ2xlLnByb3RvYnVmLkludGVybmFsLmhhc2hMb25nKA0KICAgICAgICAgIGdldERlbGF5ZWRUbygpKTsNCiAgICAgIGhhc2ggPSAoMjkgKiBoYXNoKSArIHVua25vd25GaWVsZHMuaGFzaENvZGUoKTsNCiAgICAgIG1lbW9pemVkSGFzaENvZGUgPSBoYXNoOw0KICAgICAgcmV0dXJuIGhhc2g7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcyBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcyBwYXJzZUZyb20oYnl0ZVtdIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgcGFyc2VGcm9tKA0KICAgICAgICBieXRlW10gZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIHBhcnNlRnJvbShqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIHBhcnNlRGVsaW1pdGVkRnJvbShqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VEZWxpbWl0ZWRXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIHBhcnNlRGVsaW1pdGVkRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZURlbGltaXRlZFdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgQnVpbGRlciBuZXdCdWlsZGVyRm9yVHlwZSgpIHsgcmV0dXJuIG5ld0J1aWxkZXIoKTsgfQ0KICAgIHB1YmxpYyBzdGF0aWMgQnVpbGRlciBuZXdCdWlsZGVyKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgQnVpbGRlciBuZXdCdWlsZGVyKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcyBwcm90b3R5cGUpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFLnRvQnVpbGRlcigpLm1lcmdlRnJvbShwcm90b3R5cGUpOw0KICAgIH0NCiAgICBwdWJsaWMgQnVpbGRlciB0b0J1aWxkZXIoKSB7DQogICAgICByZXR1cm4gdGhpcyA9PSBERUZBVUxUX0lOU1RBTkNFDQogICAgICAgICAgPyBuZXcgQnVpbGRlcigpIDogbmV3IEJ1aWxkZXIoKS5tZXJnZUZyb20odGhpcyk7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHByb3RlY3RlZCBCdWlsZGVyIG5ld0J1aWxkZXJGb3JUeXBlKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgQnVpbGRlciBidWlsZGVyID0gbmV3IEJ1aWxkZXIocGFyZW50KTsNCiAgICAgIHJldHVybiBidWlsZGVyOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlc30NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNsYXNzIEJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPEJ1aWxkZXI+IGltcGxlbWVudHMNCiAgICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfaW1wbGVtZW50czprdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcykNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzT3JCdWlsZGVyIHsNCiAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvcigpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzX2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzX2ZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICAgICAgLmVuc3VyZUZpZWxkQWNjZXNzb3JzSW5pdGlhbGl6ZWQoDQogICAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzLmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMuQnVpbGRlci5jbGFzcyk7DQogICAgICB9DQoNCiAgICAgIC8vIENvbnN0cnVjdCB1c2luZyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMubmV3QnVpbGRlcigpDQogICAgICBwcml2YXRlIEJ1aWxkZXIoKSB7DQogICAgICAgIG1heWJlRm9yY2VCdWlsZGVySW5pdGlhbGl6YXRpb24oKTsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXJQYXJlbnQgcGFyZW50KSB7DQogICAgICAgIHN1cGVyKHBhcmVudCk7DQogICAgICAgIG1heWJlRm9yY2VCdWlsZGVySW5pdGlhbGl6YXRpb24oKTsNCiAgICAgIH0NCiAgICAgIHByaXZhdGUgdm9pZCBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCkgew0KICAgICAgICBpZiAoY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAgICAgICAuYWx3YXlzVXNlRmllbGRCdWlsZGVycykgew0KICAgICAgICB9DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhcigpIHsNCiAgICAgICAgc3VwZXIuY2xlYXIoKTsNCiAgICAgICAgdGltZXN0YW1wXyA9IDBMOw0KDQogICAgICAgIHNlcXVlbmNlXyA9IDBMOw0KDQogICAgICAgIG1ENU9mQm9keV8gPSAiIjsNCg0KICAgICAgICByZWNlaXZlQ291bnRfID0gMDsNCg0KICAgICAgICByZVJvdXRlZF8gPSBmYWxzZTsNCg0KICAgICAgICByZVJvdXRlZEZyb21RdWV1ZV8gPSAiIjsNCg0KICAgICAgICBleHBpcmF0aW9uQXRfID0gMEw7DQoNCiAgICAgICAgZGVsYXllZFRvXyA9IDBMOw0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvckZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlQXR0cmlidXRlc19kZXNjcmlwdG9yOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMuZ2V0RGVmYXVsdEluc3RhbmNlKCk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgYnVpbGQoKSB7DQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcyByZXN1bHQgPSBidWlsZFBhcnRpYWwoKTsNCiAgICAgICAgaWYgKCFyZXN1bHQuaXNJbml0aWFsaXplZCgpKSB7DQogICAgICAgICAgdGhyb3cgbmV3VW5pbml0aWFsaXplZE1lc3NhZ2VFeGNlcHRpb24ocmVzdWx0KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIGJ1aWxkUGFydGlhbCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIHJlc3VsdCA9IG5ldyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXModGhpcyk7DQogICAgICAgIHJlc3VsdC50aW1lc3RhbXBfID0gdGltZXN0YW1wXzsNCiAgICAgICAgcmVzdWx0LnNlcXVlbmNlXyA9IHNlcXVlbmNlXzsNCiAgICAgICAgcmVzdWx0Lm1ENU9mQm9keV8gPSBtRDVPZkJvZHlfOw0KICAgICAgICByZXN1bHQucmVjZWl2ZUNvdW50XyA9IHJlY2VpdmVDb3VudF87DQogICAgICAgIHJlc3VsdC5yZVJvdXRlZF8gPSByZVJvdXRlZF87DQogICAgICAgIHJlc3VsdC5yZVJvdXRlZEZyb21RdWV1ZV8gPSByZVJvdXRlZEZyb21RdWV1ZV87DQogICAgICAgIHJlc3VsdC5leHBpcmF0aW9uQXRfID0gZXhwaXJhdGlvbkF0XzsNCiAgICAgICAgcmVzdWx0LmRlbGF5ZWRUb18gPSBkZWxheWVkVG9fOw0KICAgICAgICBvbkJ1aWx0KCk7DQogICAgICAgIHJldHVybiByZXN1bHQ7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsb25lKCkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsb25lKCk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuc2V0RmllbGQoZmllbGQsIHZhbHVlKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyRmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbGVhckZpZWxkKGZpZWxkKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyT25lb2YoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5PbmVvZkRlc2NyaXB0b3Igb25lb2YpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbGVhck9uZW9mKG9uZW9mKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlcGVhdGVkRmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgaW50IGluZGV4LCBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuc2V0UmVwZWF0ZWRGaWVsZChmaWVsZCwgaW5kZXgsIHZhbHVlKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGFkZFJlcGVhdGVkRmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmFkZFJlcGVhdGVkRmllbGQoZmllbGQsIHZhbHVlKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbShjb20uZ29vZ2xlLnByb3RvYnVmLk1lc3NhZ2Ugb3RoZXIpIHsNCiAgICAgICAgaWYgKG90aGVyIGluc3RhbmNlb2YgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzKSB7DQogICAgICAgICAgcmV0dXJuIG1lcmdlRnJvbSgoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzKW90aGVyKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBzdXBlci5tZXJnZUZyb20ob3RoZXIpOw0KICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbShpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgb3RoZXIpIHsNCiAgICAgICAgaWYgKG90aGVyID09IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcy5nZXREZWZhdWx0SW5zdGFuY2UoKSkgcmV0dXJuIHRoaXM7DQogICAgICAgIGlmIChvdGhlci5nZXRUaW1lc3RhbXAoKSAhPSAwTCkgew0KICAgICAgICAgIHNldFRpbWVzdGFtcChvdGhlci5nZXRUaW1lc3RhbXAoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmdldFNlcXVlbmNlKCkgIT0gMEwpIHsNCiAgICAgICAgICBzZXRTZXF1ZW5jZShvdGhlci5nZXRTZXF1ZW5jZSgpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIW90aGVyLmdldE1ENU9mQm9keSgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIG1ENU9mQm9keV8gPSBvdGhlci5tRDVPZkJvZHlfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRSZWNlaXZlQ291bnQoKSAhPSAwKSB7DQogICAgICAgICAgc2V0UmVjZWl2ZUNvdW50KG90aGVyLmdldFJlY2VpdmVDb3VudCgpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0UmVSb3V0ZWQoKSAhPSBmYWxzZSkgew0KICAgICAgICAgIHNldFJlUm91dGVkKG90aGVyLmdldFJlUm91dGVkKCkpOw0KICAgICAgICB9DQogICAgICAgIGlmICghb3RoZXIuZ2V0UmVSb3V0ZWRGcm9tUXVldWUoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICByZVJvdXRlZEZyb21RdWV1ZV8gPSBvdGhlci5yZVJvdXRlZEZyb21RdWV1ZV87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmdldEV4cGlyYXRpb25BdCgpICE9IDBMKSB7DQogICAgICAgICAgc2V0RXhwaXJhdGlvbkF0KG90aGVyLmdldEV4cGlyYXRpb25BdCgpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0RGVsYXllZFRvKCkgIT0gMEwpIHsNCiAgICAgICAgICBzZXREZWxheWVkVG8ob3RoZXIuZ2V0RGVsYXllZFRvKCkpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMubWVyZ2VVbmtub3duRmllbGRzKG90aGVyLnVua25vd25GaWVsZHMpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIHBhcnNlZE1lc3NhZ2UgPSBudWxsOw0KICAgICAgICB0cnkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSBQQVJTRVIucGFyc2VQYXJ0aWFsRnJvbShpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgICB9IGNhdGNoIChjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiBlKSB7DQogICAgICAgICAgcGFyc2VkTWVzc2FnZSA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMpIGUuZ2V0VW5maW5pc2hlZE1lc3NhZ2UoKTsNCiAgICAgICAgICB0aHJvdyBlLnVud3JhcElPRXhjZXB0aW9uKCk7DQogICAgICAgIH0gZmluYWxseSB7DQogICAgICAgICAgaWYgKHBhcnNlZE1lc3NhZ2UgIT0gbnVsbCkgew0KICAgICAgICAgICAgbWVyZ2VGcm9tKHBhcnNlZE1lc3NhZ2UpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBsb25nIHRpbWVzdGFtcF8gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQ2NCBUaW1lc3RhbXAgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGxvbmcgZ2V0VGltZXN0YW1wKCkgew0KICAgICAgICByZXR1cm4gdGltZXN0YW1wXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgVGltZXN0YW1wID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFRpbWVzdGFtcChsb25nIHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICB0aW1lc3RhbXBfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgVGltZXN0YW1wID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyVGltZXN0YW1wKCkgew0KICAgICAgICANCiAgICAgICAgdGltZXN0YW1wXyA9IDBMOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgbG9uZyBzZXF1ZW5jZV8gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT51aW50NjQgU2VxdWVuY2UgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGxvbmcgZ2V0U2VxdWVuY2UoKSB7DQogICAgICAgIHJldHVybiBzZXF1ZW5jZV87DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnVpbnQ2NCBTZXF1ZW5jZSA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRTZXF1ZW5jZShsb25nIHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICBzZXF1ZW5jZV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT51aW50NjQgU2VxdWVuY2UgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJTZXF1ZW5jZSgpIHsNCiAgICAgICAgDQogICAgICAgIHNlcXVlbmNlXyA9IDBMOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCBtRDVPZkJvZHlfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNRDVPZkJvZHkgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0TUQ1T2ZCb2R5KCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1ENU9mQm9keV87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIG1ENU9mQm9keV8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNRDVPZkJvZHkgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldE1ENU9mQm9keUJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1ENU9mQm9keV87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgbUQ1T2ZCb2R5XyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTUQ1T2ZCb2R5ID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldE1ENU9mQm9keSgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIG1ENU9mQm9keV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTUQ1T2ZCb2R5ID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyTUQ1T2ZCb2R5KCkgew0KICAgICAgICANCiAgICAgICAgbUQ1T2ZCb2R5XyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldE1ENU9mQm9keSgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNRDVPZkJvZHkgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0TUQ1T2ZCb2R5Qnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIG1ENU9mQm9keV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGludCByZWNlaXZlQ291bnRfIDsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50MzIgUmVjZWl2ZUNvdW50ID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpbnQgZ2V0UmVjZWl2ZUNvdW50KCkgew0KICAgICAgICByZXR1cm4gcmVjZWl2ZUNvdW50XzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50MzIgUmVjZWl2ZUNvdW50ID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlY2VpdmVDb3VudChpbnQgdmFsdWUpIHsNCiAgICAgICAgDQogICAgICAgIHJlY2VpdmVDb3VudF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQzMiBSZWNlaXZlQ291bnQgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJSZWNlaXZlQ291bnQoKSB7DQogICAgICAgIA0KICAgICAgICByZWNlaXZlQ291bnRfID0gMDsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGJvb2xlYW4gcmVSb3V0ZWRfIDsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ym9vbCBSZVJvdXRlZCA9IDU7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgYm9vbGVhbiBnZXRSZVJvdXRlZCgpIHsNCiAgICAgICAgcmV0dXJuIHJlUm91dGVkXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ym9vbCBSZVJvdXRlZCA9IDU7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZVJvdXRlZChib29sZWFuIHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICByZVJvdXRlZF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIFJlUm91dGVkID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyUmVSb3V0ZWQoKSB7DQogICAgICAgIA0KICAgICAgICByZVJvdXRlZF8gPSBmYWxzZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgcmVSb3V0ZWRGcm9tUXVldWVfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZVJvdXRlZEZyb21RdWV1ZSA9IDY7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRSZVJvdXRlZEZyb21RdWV1ZSgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZVJvdXRlZEZyb21RdWV1ZV87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIHJlUm91dGVkRnJvbVF1ZXVlXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlUm91dGVkRnJvbVF1ZXVlID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRSZVJvdXRlZEZyb21RdWV1ZUJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHJlUm91dGVkRnJvbVF1ZXVlXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICByZVJvdXRlZEZyb21RdWV1ZV8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlUm91dGVkRnJvbVF1ZXVlID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlUm91dGVkRnJvbVF1ZXVlKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgcmVSb3V0ZWRGcm9tUXVldWVfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlUm91dGVkRnJvbVF1ZXVlID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyUmVSb3V0ZWRGcm9tUXVldWUoKSB7DQogICAgICAgIA0KICAgICAgICByZVJvdXRlZEZyb21RdWV1ZV8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRSZVJvdXRlZEZyb21RdWV1ZSgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZVJvdXRlZEZyb21RdWV1ZSA9IDY7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZVJvdXRlZEZyb21RdWV1ZUJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICByZVJvdXRlZEZyb21RdWV1ZV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGxvbmcgZXhwaXJhdGlvbkF0XyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDY0IEV4cGlyYXRpb25BdCA9IDc7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgbG9uZyBnZXRFeHBpcmF0aW9uQXQoKSB7DQogICAgICAgIHJldHVybiBleHBpcmF0aW9uQXRfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQ2NCBFeHBpcmF0aW9uQXQgPSA3OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RXhwaXJhdGlvbkF0KGxvbmcgdmFsdWUpIHsNCiAgICAgICAgDQogICAgICAgIGV4cGlyYXRpb25BdF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQ2NCBFeHBpcmF0aW9uQXQgPSA3OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJFeHBpcmF0aW9uQXQoKSB7DQogICAgICAgIA0KICAgICAgICBleHBpcmF0aW9uQXRfID0gMEw7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBsb25nIGRlbGF5ZWRUb18gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQ2NCBEZWxheWVkVG8gPSA4OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGxvbmcgZ2V0RGVsYXllZFRvKCkgew0KICAgICAgICByZXR1cm4gZGVsYXllZFRvXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgRGVsYXllZFRvID0gODs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldERlbGF5ZWRUbyhsb25nIHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICBkZWxheWVkVG9fID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgRGVsYXllZFRvID0gODs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyRGVsYXllZFRvKCkgew0KICAgICAgICANCiAgICAgICAgZGVsYXllZFRvXyA9IDBMOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBzZXRVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLnNldFVua25vd25GaWVsZHNQcm90bzModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIG1lcmdlVW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5tZXJnZVVua25vd25GaWVsZHModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCg0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfc2NvcGU6a3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMpDQogICAgfQ0KDQogICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGNsYXNzX3Njb3BlOmt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzKQ0KICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcyBERUZBVUxUX0lOU1RBTkNFOw0KICAgIHN0YXRpYyB7DQogICAgICBERUZBVUxUX0lOU1RBTkNFID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlQXR0cmlidXRlcygpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzIGdldERlZmF1bHRJbnN0YW5jZSgpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFOw0KICAgIH0NCg0KICAgIHByaXZhdGUgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuUGFyc2VyPFF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXM+DQogICAgICAgIFBBUlNFUiA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkFic3RyYWN0UGFyc2VyPFF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXM+KCkgew0KICAgICAgcHVibGljIFF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgcGFyc2VQYXJ0aWFsRnJvbSgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgICAgcmV0dXJuIG5ldyBRdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzKGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICB9DQogICAgfTsNCg0KICAgIHB1YmxpYyBzdGF0aWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UXVldWVNZXNzYWdlQXR0cmlidXRlcz4gcGFyc2VyKCkgew0KICAgICAgcmV0dXJuIFBBUlNFUjsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuUGFyc2VyPFF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXM+IGdldFBhcnNlckZvclR5cGUoKSB7DQogICAgICByZXR1cm4gUEFSU0VSOw0KICAgIH0NCg0KICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFOw0KICAgIH0NCg0KICB9DQoNCiAgcHVibGljIGludGVyZmFjZSBRdWV1ZU1lc3NhZ2VQb2xpY3lPckJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGludGVyZmFjZV9leHRlbmRzOmt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kpDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLk1lc3NhZ2VPckJ1aWxkZXIgew0KDQogICAgLyoqDQogICAgICogPGNvZGU+aW50MzIgRXhwaXJhdGlvblNlY29uZHMgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBpbnQgZ2V0RXhwaXJhdGlvblNlY29uZHMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDMyIERlbGF5U2Vjb25kcyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGludCBnZXREZWxheVNlY29uZHMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDMyIE1heFJlY2VpdmVDb3VudCA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIGludCBnZXRNYXhSZWNlaXZlQ291bnQoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBNYXhSZWNlaXZlUXVldWUgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldE1heFJlY2VpdmVRdWV1ZSgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBNYXhSZWNlaXZlUXVldWUgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0TWF4UmVjZWl2ZVF1ZXVlQnl0ZXMoKTsNCiAgfQ0KICAvKioNCiAgICogUHJvdG9idWYgdHlwZSB7QGNvZGUga3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeX0NCiAgICovDQogIHB1YmxpYyAgc3RhdGljIGZpbmFsIGNsYXNzIFF1ZXVlTWVzc2FnZVBvbGljeSBleHRlbmRzDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMyBpbXBsZW1lbnRzDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQobWVzc2FnZV9pbXBsZW1lbnRzOmt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kpDQogICAgICBRdWV1ZU1lc3NhZ2VQb2xpY3lPckJ1aWxkZXIgew0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBsb25nIHNlcmlhbFZlcnNpb25VSUQgPSAwTDsNCiAgICAvLyBVc2UgUXVldWVNZXNzYWdlUG9saWN5Lm5ld0J1aWxkZXIoKSB0byBjb25zdHJ1Y3QuDQogICAgcHJpdmF0ZSBRdWV1ZU1lc3NhZ2VQb2xpY3koY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlcjw/PiBidWlsZGVyKSB7DQogICAgICBzdXBlcihidWlsZGVyKTsNCiAgICB9DQogICAgcHJpdmF0ZSBRdWV1ZU1lc3NhZ2VQb2xpY3koKSB7DQogICAgICBleHBpcmF0aW9uU2Vjb25kc18gPSAwOw0KICAgICAgZGVsYXlTZWNvbmRzXyA9IDA7DQogICAgICBtYXhSZWNlaXZlQ291bnRfID0gMDsNCiAgICAgIG1heFJlY2VpdmVRdWV1ZV8gPSAiIjsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0DQogICAgZ2V0VW5rbm93bkZpZWxkcygpIHsNCiAgICAgIHJldHVybiB0aGlzLnVua25vd25GaWVsZHM7DQogICAgfQ0KICAgIHByaXZhdGUgUXVldWVNZXNzYWdlUG9saWN5KA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgdGhpcygpOw0KICAgICAgaWYgKGV4dGVuc2lvblJlZ2lzdHJ5ID09IG51bGwpIHsNCiAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgfQ0KICAgICAgaW50IG11dGFibGVfYml0RmllbGQwXyA9IDA7DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldC5CdWlsZGVyIHVua25vd25GaWVsZHMgPQ0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0Lm5ld0J1aWxkZXIoKTsNCiAgICAgIHRyeSB7DQogICAgICAgIGJvb2xlYW4gZG9uZSA9IGZhbHNlOw0KICAgICAgICB3aGlsZSAoIWRvbmUpIHsNCiAgICAgICAgICBpbnQgdGFnID0gaW5wdXQucmVhZFRhZygpOw0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7DQogICAgICAgICAgICBjYXNlIDA6DQogICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGRlZmF1bHQ6IHsNCiAgICAgICAgICAgICAgaWYgKCFwYXJzZVVua25vd25GaWVsZFByb3RvMygNCiAgICAgICAgICAgICAgICAgIGlucHV0LCB1bmtub3duRmllbGRzLCBleHRlbnNpb25SZWdpc3RyeSwgdGFnKSkgew0KICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSA4OiB7DQoNCiAgICAgICAgICAgICAgZXhwaXJhdGlvblNlY29uZHNfID0gaW5wdXQucmVhZEludDMyKCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAxNjogew0KDQogICAgICAgICAgICAgIGRlbGF5U2Vjb25kc18gPSBpbnB1dC5yZWFkSW50MzIoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDI0OiB7DQoNCiAgICAgICAgICAgICAgbWF4UmVjZWl2ZUNvdW50XyA9IGlucHV0LnJlYWRJbnQzMigpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMzQ6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgbWF4UmVjZWl2ZVF1ZXVlXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBlLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBjYXRjaCAoamF2YS5pby5JT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbigNCiAgICAgICAgICAgIGUpLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgdGhpcy51bmtub3duRmllbGRzID0gdW5rbm93bkZpZWxkcy5idWlsZCgpOw0KICAgICAgICBtYWtlRXh0ZW5zaW9uc0ltbXV0YWJsZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VQb2xpY3lfZGVzY3JpcHRvcjsNCiAgICB9DQoNCiAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgIGludGVybmFsR2V0RmllbGRBY2Nlc3NvclRhYmxlKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VQb2xpY3lfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgLmVuc3VyZUZpZWxkQWNjZXNzb3JzSW5pdGlhbGl6ZWQoDQogICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5LmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeS5CdWlsZGVyLmNsYXNzKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBFWFBJUkFUSU9OU0VDT05EU19GSUVMRF9OVU1CRVIgPSAxOw0KICAgIHByaXZhdGUgaW50IGV4cGlyYXRpb25TZWNvbmRzXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQzMiBFeHBpcmF0aW9uU2Vjb25kcyA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpbnQgZ2V0RXhwaXJhdGlvblNlY29uZHMoKSB7DQogICAgICByZXR1cm4gZXhwaXJhdGlvblNlY29uZHNfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERFTEFZU0VDT05EU19GSUVMRF9OVU1CRVIgPSAyOw0KICAgIHByaXZhdGUgaW50IGRlbGF5U2Vjb25kc187DQogICAgLyoqDQogICAgICogPGNvZGU+aW50MzIgRGVsYXlTZWNvbmRzID0gMjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGludCBnZXREZWxheVNlY29uZHMoKSB7DQogICAgICByZXR1cm4gZGVsYXlTZWNvbmRzXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNQVhSRUNFSVZFQ09VTlRfRklFTERfTlVNQkVSID0gMzsNCiAgICBwcml2YXRlIGludCBtYXhSZWNlaXZlQ291bnRfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDMyIE1heFJlY2VpdmVDb3VudCA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpbnQgZ2V0TWF4UmVjZWl2ZUNvdW50KCkgew0KICAgICAgcmV0dXJuIG1heFJlY2VpdmVDb3VudF87DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTUFYUkVDRUlWRVFVRVVFX0ZJRUxEX05VTUJFUiA9IDQ7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IG1heFJlY2VpdmVRdWV1ZV87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIE1heFJlY2VpdmVRdWV1ZSA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldE1heFJlY2VpdmVRdWV1ZSgpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gbWF4UmVjZWl2ZVF1ZXVlXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBtYXhSZWNlaXZlUXVldWVfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBNYXhSZWNlaXZlUXVldWUgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldE1heFJlY2VpdmVRdWV1ZUJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBtYXhSZWNlaXZlUXVldWVfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIG1heFJlY2VpdmVRdWV1ZV8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHJpdmF0ZSBieXRlIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IC0xOw0KICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICBieXRlIGlzSW5pdGlhbGl6ZWQgPSBtZW1vaXplZElzSW5pdGlhbGl6ZWQ7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAxKSByZXR1cm4gdHJ1ZTsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDApIHJldHVybiBmYWxzZTsNCg0KICAgICAgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gMTsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCg0KICAgIHB1YmxpYyB2b2lkIHdyaXRlVG8oY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbSBvdXRwdXQpDQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICBpZiAoZXhwaXJhdGlvblNlY29uZHNfICE9IDApIHsNCiAgICAgICAgb3V0cHV0LndyaXRlSW50MzIoMSwgZXhwaXJhdGlvblNlY29uZHNfKTsNCiAgICAgIH0NCiAgICAgIGlmIChkZWxheVNlY29uZHNfICE9IDApIHsNCiAgICAgICAgb3V0cHV0LndyaXRlSW50MzIoMiwgZGVsYXlTZWNvbmRzXyk7DQogICAgICB9DQogICAgICBpZiAobWF4UmVjZWl2ZUNvdW50XyAhPSAwKSB7DQogICAgICAgIG91dHB1dC53cml0ZUludDMyKDMsIG1heFJlY2VpdmVDb3VudF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRNYXhSZWNlaXZlUXVldWVCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDQsIG1heFJlY2VpdmVRdWV1ZV8pOw0KICAgICAgfQ0KICAgICAgdW5rbm93bkZpZWxkcy53cml0ZVRvKG91dHB1dCk7DQogICAgfQ0KDQogICAgcHVibGljIGludCBnZXRTZXJpYWxpemVkU2l6ZSgpIHsNCiAgICAgIGludCBzaXplID0gbWVtb2l6ZWRTaXplOw0KICAgICAgaWYgKHNpemUgIT0gLTEpIHJldHVybiBzaXplOw0KDQogICAgICBzaXplID0gMDsNCiAgICAgIGlmIChleHBpcmF0aW9uU2Vjb25kc18gIT0gMCkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUludDMyU2l6ZSgxLCBleHBpcmF0aW9uU2Vjb25kc18pOw0KICAgICAgfQ0KICAgICAgaWYgKGRlbGF5U2Vjb25kc18gIT0gMCkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUludDMyU2l6ZSgyLCBkZWxheVNlY29uZHNfKTsNCiAgICAgIH0NCiAgICAgIGlmIChtYXhSZWNlaXZlQ291bnRfICE9IDApIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVJbnQzMlNpemUoMywgbWF4UmVjZWl2ZUNvdW50Xyk7DQogICAgICB9DQogICAgICBpZiAoIWdldE1heFJlY2VpdmVRdWV1ZUJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoNCwgbWF4UmVjZWl2ZVF1ZXVlXyk7DQogICAgICB9DQogICAgICBzaXplICs9IHVua25vd25GaWVsZHMuZ2V0U2VyaWFsaXplZFNpemUoKTsNCiAgICAgIG1lbW9pemVkU2l6ZSA9IHNpemU7DQogICAgICByZXR1cm4gc2l6ZTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGJvb2xlYW4gZXF1YWxzKGZpbmFsIGphdmEubGFuZy5PYmplY3Qgb2JqKSB7DQogICAgICBpZiAob2JqID09IHRoaXMpIHsNCiAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIGlmICghKG9iaiBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5KSkgew0KICAgICAgICByZXR1cm4gc3VwZXIuZXF1YWxzKG9iaik7DQogICAgICB9DQogICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBvdGhlciA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSkgb2JqOw0KDQogICAgICBib29sZWFuIHJlc3VsdCA9IHRydWU7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldEV4cGlyYXRpb25TZWNvbmRzKCkNCiAgICAgICAgICA9PSBvdGhlci5nZXRFeHBpcmF0aW9uU2Vjb25kcygpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiAoZ2V0RGVsYXlTZWNvbmRzKCkNCiAgICAgICAgICA9PSBvdGhlci5nZXREZWxheVNlY29uZHMoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldE1heFJlY2VpdmVDb3VudCgpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0TWF4UmVjZWl2ZUNvdW50KCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldE1heFJlY2VpdmVRdWV1ZSgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRNYXhSZWNlaXZlUXVldWUoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgdW5rbm93bkZpZWxkcy5lcXVhbHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICByZXR1cm4gcmVzdWx0Ow0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgaW50IGhhc2hDb2RlKCkgew0KICAgICAgaWYgKG1lbW9pemVkSGFzaENvZGUgIT0gMCkgew0KICAgICAgICByZXR1cm4gbWVtb2l6ZWRIYXNoQ29kZTsNCiAgICAgIH0NCiAgICAgIGludCBoYXNoID0gNDE7DQogICAgICBoYXNoID0gKDE5ICogaGFzaCkgKyBnZXREZXNjcmlwdG9yKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIEVYUElSQVRJT05TRUNPTkRTX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldEV4cGlyYXRpb25TZWNvbmRzKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBERUxBWVNFQ09ORFNfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0RGVsYXlTZWNvbmRzKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBNQVhSRUNFSVZFQ09VTlRfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0TWF4UmVjZWl2ZUNvdW50KCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBNQVhSRUNFSVZFUVVFVUVfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0TWF4UmVjZWl2ZVF1ZXVlKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMjkgKiBoYXNoKSArIHVua25vd25GaWVsZHMuaGFzaENvZGUoKTsNCiAgICAgIG1lbW9pemVkSGFzaENvZGUgPSBoYXNoOw0KICAgICAgcmV0dXJuIGhhc2g7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBwYXJzZUZyb20oDQogICAgICAgIGphdmEubmlvLkJ5dGVCdWZmZXIgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5uaW8uQnl0ZUJ1ZmZlciBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgcGFyc2VGcm9tKGJ5dGVbXSBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgcGFyc2VGcm9tKA0KICAgICAgICBieXRlW10gZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgcGFyc2VGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBwYXJzZUZyb20oDQogICAgICAgIGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IHBhcnNlRGVsaW1pdGVkRnJvbShqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VEZWxpbWl0ZWRXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgcGFyc2VEZWxpbWl0ZWRGcm9tKA0KICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgQnVpbGRlciBuZXdCdWlsZGVyRm9yVHlwZSgpIHsgcmV0dXJuIG5ld0J1aWxkZXIoKTsgfQ0KICAgIHB1YmxpYyBzdGF0aWMgQnVpbGRlciBuZXdCdWlsZGVyKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgQnVpbGRlciBuZXdCdWlsZGVyKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IHByb3RvdHlwZSkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCkubWVyZ2VGcm9tKHByb3RvdHlwZSk7DQogICAgfQ0KICAgIHB1YmxpYyBCdWlsZGVyIHRvQnVpbGRlcigpIHsNCiAgICAgIHJldHVybiB0aGlzID09IERFRkFVTFRfSU5TVEFOQ0UNCiAgICAgICAgICA/IG5ldyBCdWlsZGVyKCkgOiBuZXcgQnVpbGRlcigpLm1lcmdlRnJvbSh0aGlzKTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHJvdGVjdGVkIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXJQYXJlbnQgcGFyZW50KSB7DQogICAgICBCdWlsZGVyIGJ1aWxkZXIgPSBuZXcgQnVpbGRlcihwYXJlbnQpOw0KICAgICAgcmV0dXJuIGJ1aWxkZXI7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3l9DQogICAgICovDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBjbGFzcyBCdWlsZGVyIGV4dGVuZHMNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlcjxCdWlsZGVyPiBpbXBsZW1lbnRzDQogICAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChidWlsZGVyX2ltcGxlbWVudHM6a3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSkNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3lPckJ1aWxkZXIgew0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZVBvbGljeV9kZXNjcmlwdG9yOw0KICAgICAgfQ0KDQogICAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgaW50ZXJuYWxHZXRGaWVsZEFjY2Vzc29yVGFibGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlUG9saWN5X2ZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICAgICAgLmVuc3VyZUZpZWxkQWNjZXNzb3JzSW5pdGlhbGl6ZWQoDQogICAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5LkJ1aWxkZXIuY2xhc3MpOw0KICAgICAgfQ0KDQogICAgICAvLyBDb25zdHJ1Y3QgdXNpbmcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kubmV3QnVpbGRlcigpDQogICAgICBwcml2YXRlIEJ1aWxkZXIoKSB7DQogICAgICAgIG1heWJlRm9yY2VCdWlsZGVySW5pdGlhbGl6YXRpb24oKTsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXJQYXJlbnQgcGFyZW50KSB7DQogICAgICAgIHN1cGVyKHBhcmVudCk7DQogICAgICAgIG1heWJlRm9yY2VCdWlsZGVySW5pdGlhbGl6YXRpb24oKTsNCiAgICAgIH0NCiAgICAgIHByaXZhdGUgdm9pZCBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCkgew0KICAgICAgICBpZiAoY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAgICAgICAuYWx3YXlzVXNlRmllbGRCdWlsZGVycykgew0KICAgICAgICB9DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhcigpIHsNCiAgICAgICAgc3VwZXIuY2xlYXIoKTsNCiAgICAgICAgZXhwaXJhdGlvblNlY29uZHNfID0gMDsNCg0KICAgICAgICBkZWxheVNlY29uZHNfID0gMDsNCg0KICAgICAgICBtYXhSZWNlaXZlQ291bnRfID0gMDsNCg0KICAgICAgICBtYXhSZWNlaXZlUXVldWVfID0gIiI7DQoNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VQb2xpY3lfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeS5nZXREZWZhdWx0SW5zdGFuY2UoKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5IGJ1aWxkKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSByZXN1bHQgPSBidWlsZFBhcnRpYWwoKTsNCiAgICAgICAgaWYgKCFyZXN1bHQuaXNJbml0aWFsaXplZCgpKSB7DQogICAgICAgICAgdGhyb3cgbmV3VW5pbml0aWFsaXplZE1lc3NhZ2VFeGNlcHRpb24ocmVzdWx0KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgYnVpbGRQYXJ0aWFsKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSByZXN1bHQgPSBuZXcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kodGhpcyk7DQogICAgICAgIHJlc3VsdC5leHBpcmF0aW9uU2Vjb25kc18gPSBleHBpcmF0aW9uU2Vjb25kc187DQogICAgICAgIHJlc3VsdC5kZWxheVNlY29uZHNfID0gZGVsYXlTZWNvbmRzXzsNCiAgICAgICAgcmVzdWx0Lm1heFJlY2VpdmVDb3VudF8gPSBtYXhSZWNlaXZlQ291bnRfOw0KICAgICAgICByZXN1bHQubWF4UmVjZWl2ZVF1ZXVlXyA9IG1heFJlY2VpdmVRdWV1ZV87DQogICAgICAgIG9uQnVpbHQoKTsNCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xvbmUoKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xvbmUoKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyRmllbGQoZmllbGQpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJPbmVvZigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLk9uZW9mRGVzY3JpcHRvciBvbmVvZikgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyT25lb2Yob25lb2YpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBpbnQgaW5kZXgsIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRSZXBlYXRlZEZpZWxkKGZpZWxkLCBpbmRleCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgYWRkUmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuYWRkUmVwZWF0ZWRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZSBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSkgew0KICAgICAgICAgIHJldHVybiBtZXJnZUZyb20oKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5KW90aGVyKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBzdXBlci5tZXJnZUZyb20ob3RoZXIpOw0KICAgICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbShpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgPT0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kuZ2V0RGVmYXVsdEluc3RhbmNlKCkpIHJldHVybiB0aGlzOw0KICAgICAgICBpZiAob3RoZXIuZ2V0RXhwaXJhdGlvblNlY29uZHMoKSAhPSAwKSB7DQogICAgICAgICAgc2V0RXhwaXJhdGlvblNlY29uZHMob3RoZXIuZ2V0RXhwaXJhdGlvblNlY29uZHMoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmdldERlbGF5U2Vjb25kcygpICE9IDApIHsNCiAgICAgICAgICBzZXREZWxheVNlY29uZHMob3RoZXIuZ2V0RGVsYXlTZWNvbmRzKCkpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRNYXhSZWNlaXZlQ291bnQoKSAhPSAwKSB7DQogICAgICAgICAgc2V0TWF4UmVjZWl2ZUNvdW50KG90aGVyLmdldE1heFJlY2VpdmVDb3VudCgpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIW90aGVyLmdldE1heFJlY2VpdmVRdWV1ZSgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIG1heFJlY2VpdmVRdWV1ZV8gPSBvdGhlci5tYXhSZWNlaXZlUXVldWVfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMubWVyZ2VVbmtub3duRmllbGRzKG90aGVyLnVua25vd25GaWVsZHMpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgcGFyc2VkTWVzc2FnZSA9IG51bGw7DQogICAgICAgIHRyeSB7DQogICAgICAgICAgcGFyc2VkTWVzc2FnZSA9IFBBUlNFUi5wYXJzZVBhcnRpYWxGcm9tKGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICAgIH0gY2F0Y2ggKGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5KSBlLmdldFVuZmluaXNoZWRNZXNzYWdlKCk7DQogICAgICAgICAgdGhyb3cgZS51bndyYXBJT0V4Y2VwdGlvbigpOw0KICAgICAgICB9IGZpbmFsbHkgew0KICAgICAgICAgIGlmIChwYXJzZWRNZXNzYWdlICE9IG51bGwpIHsNCiAgICAgICAgICAgIG1lcmdlRnJvbShwYXJzZWRNZXNzYWdlKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgaW50IGV4cGlyYXRpb25TZWNvbmRzXyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIEV4cGlyYXRpb25TZWNvbmRzID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpbnQgZ2V0RXhwaXJhdGlvblNlY29uZHMoKSB7DQogICAgICAgIHJldHVybiBleHBpcmF0aW9uU2Vjb25kc187DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIEV4cGlyYXRpb25TZWNvbmRzID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEV4cGlyYXRpb25TZWNvbmRzKGludCB2YWx1ZSkgew0KICAgICAgICANCiAgICAgICAgZXhwaXJhdGlvblNlY29uZHNfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50MzIgRXhwaXJhdGlvblNlY29uZHMgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJFeHBpcmF0aW9uU2Vjb25kcygpIHsNCiAgICAgICAgDQogICAgICAgIGV4cGlyYXRpb25TZWNvbmRzXyA9IDA7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBpbnQgZGVsYXlTZWNvbmRzXyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIERlbGF5U2Vjb25kcyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW50IGdldERlbGF5U2Vjb25kcygpIHsNCiAgICAgICAgcmV0dXJuIGRlbGF5U2Vjb25kc187DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIERlbGF5U2Vjb25kcyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXREZWxheVNlY29uZHMoaW50IHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICBkZWxheVNlY29uZHNfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50MzIgRGVsYXlTZWNvbmRzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyRGVsYXlTZWNvbmRzKCkgew0KICAgICAgICANCiAgICAgICAgZGVsYXlTZWNvbmRzXyA9IDA7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBpbnQgbWF4UmVjZWl2ZUNvdW50XyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIE1heFJlY2VpdmVDb3VudCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW50IGdldE1heFJlY2VpdmVDb3VudCgpIHsNCiAgICAgICAgcmV0dXJuIG1heFJlY2VpdmVDb3VudF87DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIE1heFJlY2VpdmVDb3VudCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRNYXhSZWNlaXZlQ291bnQoaW50IHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICBtYXhSZWNlaXZlQ291bnRfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50MzIgTWF4UmVjZWl2ZUNvdW50ID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyTWF4UmVjZWl2ZUNvdW50KCkgew0KICAgICAgICANCiAgICAgICAgbWF4UmVjZWl2ZUNvdW50XyA9IDA7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IG1heFJlY2VpdmVRdWV1ZV8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1heFJlY2VpdmVRdWV1ZSA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRNYXhSZWNlaXZlUXVldWUoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gbWF4UmVjZWl2ZVF1ZXVlXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgbWF4UmVjZWl2ZVF1ZXVlXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1heFJlY2VpdmVRdWV1ZSA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0TWF4UmVjZWl2ZVF1ZXVlQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gbWF4UmVjZWl2ZVF1ZXVlXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBtYXhSZWNlaXZlUXVldWVfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNYXhSZWNlaXZlUXVldWUgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0TWF4UmVjZWl2ZVF1ZXVlKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgbWF4UmVjZWl2ZVF1ZXVlXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBNYXhSZWNlaXZlUXVldWUgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJNYXhSZWNlaXZlUXVldWUoKSB7DQogICAgICAgIA0KICAgICAgICBtYXhSZWNlaXZlUXVldWVfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0TWF4UmVjZWl2ZVF1ZXVlKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1heFJlY2VpdmVRdWV1ZSA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRNYXhSZWNlaXZlUXVldWVCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgbWF4UmVjZWl2ZVF1ZXVlXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBzZXRVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLnNldFVua25vd25GaWVsZHNQcm90bzModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIG1lcmdlVW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5tZXJnZVVua25vd25GaWVsZHModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCg0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfc2NvcGU6a3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSkNCiAgICB9DQoNCiAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoY2xhc3Nfc2NvcGU6a3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSkNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBERUZBVUxUX0lOU1RBTkNFOw0KICAgIHN0YXRpYyB7DQogICAgICBERUZBVUxUX0lOU1RBTkNFID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5KCk7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZVBvbGljeSBnZXREZWZhdWx0SW5zdGFuY2UoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRTsNCiAgICB9DQoNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxRdWV1ZU1lc3NhZ2VQb2xpY3k+DQogICAgICAgIFBBUlNFUiA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkFic3RyYWN0UGFyc2VyPFF1ZXVlTWVzc2FnZVBvbGljeT4oKSB7DQogICAgICBwdWJsaWMgUXVldWVNZXNzYWdlUG9saWN5IHBhcnNlUGFydGlhbEZyb20oDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICAgIHJldHVybiBuZXcgUXVldWVNZXNzYWdlUG9saWN5KGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICB9DQogICAgfTsNCg0KICAgIHB1YmxpYyBzdGF0aWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UXVldWVNZXNzYWdlUG9saWN5PiBwYXJzZXIoKSB7DQogICAgICByZXR1cm4gUEFSU0VSOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UXVldWVNZXNzYWdlUG9saWN5PiBnZXRQYXJzZXJGb3JUeXBlKCkgew0KICAgICAgcmV0dXJuIFBBUlNFUjsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VQb2xpY3kgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFOw0KICAgIH0NCg0KICB9DQoNCiAgcHVibGljIGludGVyZmFjZSBTZW5kUXVldWVNZXNzYWdlUmVzdWx0T3JCdWlsZGVyIGV4dGVuZHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChpbnRlcmZhY2VfZXh0ZW5kczprdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCkNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZU9yQnVpbGRlciB7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgTWVzc2FnZUlEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRNZXNzYWdlSUQoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgTWVzc2FnZUlEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldE1lc3NhZ2VJREJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQ2NCBTZW50QXQgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBsb25nIGdldFNlbnRBdCgpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+aW50NjQgRXhwaXJhdGlvbkF0ID0gMzs8L2NvZGU+DQogICAgICovDQogICAgbG9uZyBnZXRFeHBpcmF0aW9uQXQoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDY0IERlbGF5ZWRUbyA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIGxvbmcgZ2V0RGVsYXllZFRvKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5ib29sIElzRXJyb3IgPSA1OzwvY29kZT4NCiAgICAgKi8NCiAgICBib29sZWFuIGdldElzRXJyb3IoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDY7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0RXJyb3IoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgRXJyb3IgPSA2OzwvY29kZT4NCiAgICAgKi8NCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0RXJyb3JCeXRlcygpOw0KICB9DQogIC8qKg0KICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdH0NCiAgICovDQogIHB1YmxpYyAgc3RhdGljIGZpbmFsIGNsYXNzIFNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgZXh0ZW5kcw0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMgaW1wbGVtZW50cw0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KG1lc3NhZ2VfaW1wbGVtZW50czprdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCkNCiAgICAgIFNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHRPckJ1aWxkZXIgew0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBsb25nIHNlcmlhbFZlcnNpb25VSUQgPSAwTDsNCiAgICAvLyBVc2UgU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdC5uZXdCdWlsZGVyKCkgdG8gY29uc3RydWN0Lg0KICAgIHByaXZhdGUgU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdChjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPD8+IGJ1aWxkZXIpIHsNCiAgICAgIHN1cGVyKGJ1aWxkZXIpOw0KICAgIH0NCiAgICBwcml2YXRlIFNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQoKSB7DQogICAgICBtZXNzYWdlSURfID0gIiI7DQogICAgICBzZW50QXRfID0gMEw7DQogICAgICBleHBpcmF0aW9uQXRfID0gMEw7DQogICAgICBkZWxheWVkVG9fID0gMEw7DQogICAgICBpc0Vycm9yXyA9IGZhbHNlOw0KICAgICAgZXJyb3JfID0gIiI7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldA0KICAgIGdldFVua25vd25GaWVsZHMoKSB7DQogICAgICByZXR1cm4gdGhpcy51bmtub3duRmllbGRzOw0KICAgIH0NCiAgICBwcml2YXRlIFNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICB0aGlzKCk7DQogICAgICBpZiAoZXh0ZW5zaW9uUmVnaXN0cnkgPT0gbnVsbCkgew0KICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogICAgICB9DQogICAgICBpbnQgbXV0YWJsZV9iaXRGaWVsZDBfID0gMDsNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0LkJ1aWxkZXIgdW5rbm93bkZpZWxkcyA9DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQubmV3QnVpbGRlcigpOw0KICAgICAgdHJ5IHsNCiAgICAgICAgYm9vbGVhbiBkb25lID0gZmFsc2U7DQogICAgICAgIHdoaWxlICghZG9uZSkgew0KICAgICAgICAgIGludCB0YWcgPSBpbnB1dC5yZWFkVGFnKCk7DQogICAgICAgICAgc3dpdGNoICh0YWcpIHsNCiAgICAgICAgICAgIGNhc2UgMDoNCiAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgZGVmYXVsdDogew0KICAgICAgICAgICAgICBpZiAoIXBhcnNlVW5rbm93bkZpZWxkUHJvdG8zKA0KICAgICAgICAgICAgICAgICAgaW5wdXQsIHVua25vd25GaWVsZHMsIGV4dGVuc2lvblJlZ2lzdHJ5LCB0YWcpKSB7DQogICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDEwOiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIG1lc3NhZ2VJRF8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMTY6IHsNCg0KICAgICAgICAgICAgICBzZW50QXRfID0gaW5wdXQucmVhZEludDY0KCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAyNDogew0KDQogICAgICAgICAgICAgIGV4cGlyYXRpb25BdF8gPSBpbnB1dC5yZWFkSW50NjQoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDMyOiB7DQoNCiAgICAgICAgICAgICAgZGVsYXllZFRvXyA9IGlucHV0LnJlYWRJbnQ2NCgpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNDA6IHsNCg0KICAgICAgICAgICAgICBpc0Vycm9yXyA9IGlucHV0LnJlYWRCb29sKCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSA1MDogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICBlcnJvcl8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0gY2F0Y2ggKGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgdGhyb3cgZS5zZXRVbmZpbmlzaGVkTWVzc2FnZSh0aGlzKTsNCiAgICAgIH0gY2F0Y2ggKGphdmEuaW8uSU9FeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24oDQogICAgICAgICAgICBlKS5zZXRVbmZpbmlzaGVkTWVzc2FnZSh0aGlzKTsNCiAgICAgIH0gZmluYWxseSB7DQogICAgICAgIHRoaXMudW5rbm93bkZpZWxkcyA9IHVua25vd25GaWVsZHMuYnVpbGQoKTsNCiAgICAgICAgbWFrZUV4dGVuc2lvbnNJbW11dGFibGUoKTsNCiAgICAgIH0NCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgZ2V0RGVzY3JpcHRvcigpIHsNCiAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdF9kZXNjcmlwdG9yOw0KICAgIH0NCg0KICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgaW50ZXJuYWxHZXRGaWVsZEFjY2Vzc29yVGFibGUoKSB7DQogICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1NlbmRRdWV1ZU1lc3NhZ2VSZXN1bHRfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgLmVuc3VyZUZpZWxkQWNjZXNzb3JzSW5pdGlhbGl6ZWQoDQogICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdC5jbGFzcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0LkJ1aWxkZXIuY2xhc3MpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE1FU1NBR0VJRF9GSUVMRF9OVU1CRVIgPSAxOw0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBtZXNzYWdlSURfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBNZXNzYWdlSUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRNZXNzYWdlSUQoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IG1lc3NhZ2VJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgbWVzc2FnZUlEXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgTWVzc2FnZUlEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRNZXNzYWdlSURCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gbWVzc2FnZUlEXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICBtZXNzYWdlSURfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFNFTlRBVF9GSUVMRF9OVU1CRVIgPSAyOw0KICAgIHByaXZhdGUgbG9uZyBzZW50QXRfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDY0IFNlbnRBdCA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBsb25nIGdldFNlbnRBdCgpIHsNCiAgICAgIHJldHVybiBzZW50QXRfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IEVYUElSQVRJT05BVF9GSUVMRF9OVU1CRVIgPSAzOw0KICAgIHByaXZhdGUgbG9uZyBleHBpcmF0aW9uQXRfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDY0IEV4cGlyYXRpb25BdCA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBsb25nIGdldEV4cGlyYXRpb25BdCgpIHsNCiAgICAgIHJldHVybiBleHBpcmF0aW9uQXRfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IERFTEFZRURUT19GSUVMRF9OVU1CRVIgPSA0Ow0KICAgIHByaXZhdGUgbG9uZyBkZWxheWVkVG9fOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDY0IERlbGF5ZWRUbyA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBsb25nIGdldERlbGF5ZWRUbygpIHsNCiAgICAgIHJldHVybiBkZWxheWVkVG9fOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IElTRVJST1JfRklFTERfTlVNQkVSID0gNTsNCiAgICBwcml2YXRlIGJvb2xlYW4gaXNFcnJvcl87DQogICAgLyoqDQogICAgICogPGNvZGU+Ym9vbCBJc0Vycm9yID0gNTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGJvb2xlYW4gZ2V0SXNFcnJvcigpIHsNCiAgICAgIHJldHVybiBpc0Vycm9yXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBFUlJPUl9GSUVMRF9OVU1CRVIgPSA2Ow0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBlcnJvcl87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0RXJyb3IoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGVycm9yXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBlcnJvcl8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRFcnJvckJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBlcnJvcl87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgZXJyb3JfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHByaXZhdGUgYnl0ZSBtZW1vaXplZElzSW5pdGlhbGl6ZWQgPSAtMTsNCiAgICBwdWJsaWMgZmluYWwgYm9vbGVhbiBpc0luaXRpYWxpemVkKCkgew0KICAgICAgYnl0ZSBpc0luaXRpYWxpemVkID0gbWVtb2l6ZWRJc0luaXRpYWxpemVkOw0KICAgICAgaWYgKGlzSW5pdGlhbGl6ZWQgPT0gMSkgcmV0dXJuIHRydWU7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAwKSByZXR1cm4gZmFsc2U7DQoNCiAgICAgIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IDE7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQoNCiAgICBwdWJsaWMgdm9pZCB3cml0ZVRvKGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0gb3V0cHV0KQ0KICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgaWYgKCFnZXRNZXNzYWdlSURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDEsIG1lc3NhZ2VJRF8pOw0KICAgICAgfQ0KICAgICAgaWYgKHNlbnRBdF8gIT0gMEwpIHsNCiAgICAgICAgb3V0cHV0LndyaXRlSW50NjQoMiwgc2VudEF0Xyk7DQogICAgICB9DQogICAgICBpZiAoZXhwaXJhdGlvbkF0XyAhPSAwTCkgew0KICAgICAgICBvdXRwdXQud3JpdGVJbnQ2NCgzLCBleHBpcmF0aW9uQXRfKTsNCiAgICAgIH0NCiAgICAgIGlmIChkZWxheWVkVG9fICE9IDBMKSB7DQogICAgICAgIG91dHB1dC53cml0ZUludDY0KDQsIGRlbGF5ZWRUb18pOw0KICAgICAgfQ0KICAgICAgaWYgKGlzRXJyb3JfICE9IGZhbHNlKSB7DQogICAgICAgIG91dHB1dC53cml0ZUJvb2woNSwgaXNFcnJvcl8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRFcnJvckJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLndyaXRlU3RyaW5nKG91dHB1dCwgNiwgZXJyb3JfKTsNCiAgICAgIH0NCiAgICAgIHVua25vd25GaWVsZHMud3JpdGVUbyhvdXRwdXQpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBpbnQgZ2V0U2VyaWFsaXplZFNpemUoKSB7DQogICAgICBpbnQgc2l6ZSA9IG1lbW9pemVkU2l6ZTsNCiAgICAgIGlmIChzaXplICE9IC0xKSByZXR1cm4gc2l6ZTsNCg0KICAgICAgc2l6ZSA9IDA7DQogICAgICBpZiAoIWdldE1lc3NhZ2VJREJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoMSwgbWVzc2FnZUlEXyk7DQogICAgICB9DQogICAgICBpZiAoc2VudEF0XyAhPSAwTCkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUludDY0U2l6ZSgyLCBzZW50QXRfKTsNCiAgICAgIH0NCiAgICAgIGlmIChleHBpcmF0aW9uQXRfICE9IDBMKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlSW50NjRTaXplKDMsIGV4cGlyYXRpb25BdF8pOw0KICAgICAgfQ0KICAgICAgaWYgKGRlbGF5ZWRUb18gIT0gMEwpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVJbnQ2NFNpemUoNCwgZGVsYXllZFRvXyk7DQogICAgICB9DQogICAgICBpZiAoaXNFcnJvcl8gIT0gZmFsc2UpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVCb29sU2l6ZSg1LCBpc0Vycm9yXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldEVycm9yQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSg2LCBlcnJvcl8pOw0KICAgICAgfQ0KICAgICAgc2l6ZSArPSB1bmtub3duRmllbGRzLmdldFNlcmlhbGl6ZWRTaXplKCk7DQogICAgICBtZW1vaXplZFNpemUgPSBzaXplOw0KICAgICAgcmV0dXJuIHNpemU7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBib29sZWFuIGVxdWFscyhmaW5hbCBqYXZhLmxhbmcuT2JqZWN0IG9iaikgew0KICAgICAgaWYgKG9iaiA9PSB0aGlzKSB7DQogICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQogICAgICBpZiAoIShvYmogaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQpKSB7DQogICAgICAgIHJldHVybiBzdXBlci5lcXVhbHMob2JqKTsNCiAgICAgIH0NCiAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBvdGhlciA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQpIG9iajsNCg0KICAgICAgYm9vbGVhbiByZXN1bHQgPSB0cnVlOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldE1lc3NhZ2VJRCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRNZXNzYWdlSUQoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldFNlbnRBdCgpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0U2VudEF0KCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChnZXRFeHBpcmF0aW9uQXQoKQ0KICAgICAgICAgID09IG90aGVyLmdldEV4cGlyYXRpb25BdCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiAoZ2V0RGVsYXllZFRvKCkNCiAgICAgICAgICA9PSBvdGhlci5nZXREZWxheWVkVG8oKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldElzRXJyb3IoKQ0KICAgICAgICAgID09IG90aGVyLmdldElzRXJyb3IoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0RXJyb3IoKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0RXJyb3IoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgdW5rbm93bkZpZWxkcy5lcXVhbHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICByZXR1cm4gcmVzdWx0Ow0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgaW50IGhhc2hDb2RlKCkgew0KICAgICAgaWYgKG1lbW9pemVkSGFzaENvZGUgIT0gMCkgew0KICAgICAgICByZXR1cm4gbWVtb2l6ZWRIYXNoQ29kZTsNCiAgICAgIH0NCiAgICAgIGludCBoYXNoID0gNDE7DQogICAgICBoYXNoID0gKDE5ICogaGFzaCkgKyBnZXREZXNjcmlwdG9yKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIE1FU1NBR0VJRF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRNZXNzYWdlSUQoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgU0VOVEFUX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGNvbS5nb29nbGUucHJvdG9idWYuSW50ZXJuYWwuaGFzaExvbmcoDQogICAgICAgICAgZ2V0U2VudEF0KCkpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgRVhQSVJBVElPTkFUX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGNvbS5nb29nbGUucHJvdG9idWYuSW50ZXJuYWwuaGFzaExvbmcoDQogICAgICAgICAgZ2V0RXhwaXJhdGlvbkF0KCkpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgREVMQVlFRFRPX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGNvbS5nb29nbGUucHJvdG9idWYuSW50ZXJuYWwuaGFzaExvbmcoDQogICAgICAgICAgZ2V0RGVsYXllZFRvKCkpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgSVNFUlJPUl9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBjb20uZ29vZ2xlLnByb3RvYnVmLkludGVybmFsLmhhc2hCb29sZWFuKA0KICAgICAgICAgIGdldElzRXJyb3IoKSk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBFUlJPUl9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRFcnJvcigpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDI5ICogaGFzaCkgKyB1bmtub3duRmllbGRzLmhhc2hDb2RlKCk7DQogICAgICBtZW1vaXplZEhhc2hDb2RlID0gaGFzaDsNCiAgICAgIHJldHVybiBoYXNoOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5uaW8uQnl0ZUJ1ZmZlciBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5uaW8uQnl0ZUJ1ZmZlciBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgcGFyc2VGcm9tKGJ5dGVbXSBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IHBhcnNlRnJvbSgNCiAgICAgICAgYnl0ZVtdIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBwYXJzZUZyb20oamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBwYXJzZUZyb20oDQogICAgICAgIGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBwYXJzZURlbGltaXRlZEZyb20oamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBwYXJzZURlbGltaXRlZEZyb20oDQogICAgICAgIGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VEZWxpbWl0ZWRXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KDQogICAgcHVibGljIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoKSB7IHJldHVybiBuZXdCdWlsZGVyKCk7IH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcigpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFLnRvQnVpbGRlcigpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcihpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgcHJvdG90eXBlKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRS50b0J1aWxkZXIoKS5tZXJnZUZyb20ocHJvdG90eXBlKTsNCiAgICB9DQogICAgcHVibGljIEJ1aWxkZXIgdG9CdWlsZGVyKCkgew0KICAgICAgcmV0dXJuIHRoaXMgPT0gREVGQVVMVF9JTlNUQU5DRQ0KICAgICAgICAgID8gbmV3IEJ1aWxkZXIoKSA6IG5ldyBCdWlsZGVyKCkubWVyZ2VGcm9tKHRoaXMpOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwcm90ZWN0ZWQgQnVpbGRlciBuZXdCdWlsZGVyRm9yVHlwZSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlclBhcmVudCBwYXJlbnQpIHsNCiAgICAgIEJ1aWxkZXIgYnVpbGRlciA9IG5ldyBCdWlsZGVyKHBhcmVudCk7DQogICAgICByZXR1cm4gYnVpbGRlcjsNCiAgICB9DQogICAgLyoqDQogICAgICogUHJvdG9idWYgdHlwZSB7QGNvZGUga3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHR9DQogICAgICovDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBjbGFzcyBCdWlsZGVyIGV4dGVuZHMNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlcjxCdWlsZGVyPiBpbXBsZW1lbnRzDQogICAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChidWlsZGVyX2ltcGxlbWVudHM6a3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQpDQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdE9yQnVpbGRlciB7DQogICAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdF9kZXNjcmlwdG9yOw0KICAgICAgfQ0KDQogICAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgaW50ZXJuYWxHZXRGaWVsZEFjY2Vzc29yVGFibGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdF9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAgIC5lbnN1cmVGaWVsZEFjY2Vzc29yc0luaXRpYWxpemVkKA0KICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdC5jbGFzcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0LkJ1aWxkZXIuY2xhc3MpOw0KICAgICAgfQ0KDQogICAgICAvLyBDb25zdHJ1Y3QgdXNpbmcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0Lm5ld0J1aWxkZXIoKQ0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKCkgew0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgQnVpbGRlcigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgICBzdXBlcihwYXJlbnQpOw0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQogICAgICBwcml2YXRlIHZvaWQgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpIHsNCiAgICAgICAgaWYgKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgICAgICAgLmFsd2F5c1VzZUZpZWxkQnVpbGRlcnMpIHsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXIoKSB7DQogICAgICAgIHN1cGVyLmNsZWFyKCk7DQogICAgICAgIG1lc3NhZ2VJRF8gPSAiIjsNCg0KICAgICAgICBzZW50QXRfID0gMEw7DQoNCiAgICAgICAgZXhwaXJhdGlvbkF0XyA9IDBMOw0KDQogICAgICAgIGRlbGF5ZWRUb18gPSAwTDsNCg0KICAgICAgICBpc0Vycm9yXyA9IGZhbHNlOw0KDQogICAgICAgIGVycm9yXyA9ICIiOw0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvckZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdF9kZXNjcmlwdG9yOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQuZ2V0RGVmYXVsdEluc3RhbmNlKCk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgYnVpbGQoKSB7DQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCByZXN1bHQgPSBidWlsZFBhcnRpYWwoKTsNCiAgICAgICAgaWYgKCFyZXN1bHQuaXNJbml0aWFsaXplZCgpKSB7DQogICAgICAgICAgdGhyb3cgbmV3VW5pbml0aWFsaXplZE1lc3NhZ2VFeGNlcHRpb24ocmVzdWx0KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IGJ1aWxkUGFydGlhbCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IHJlc3VsdCA9IG5ldyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQodGhpcyk7DQogICAgICAgIHJlc3VsdC5tZXNzYWdlSURfID0gbWVzc2FnZUlEXzsNCiAgICAgICAgcmVzdWx0LnNlbnRBdF8gPSBzZW50QXRfOw0KICAgICAgICByZXN1bHQuZXhwaXJhdGlvbkF0XyA9IGV4cGlyYXRpb25BdF87DQogICAgICAgIHJlc3VsdC5kZWxheWVkVG9fID0gZGVsYXllZFRvXzsNCiAgICAgICAgcmVzdWx0LmlzRXJyb3JfID0gaXNFcnJvcl87DQogICAgICAgIHJlc3VsdC5lcnJvcl8gPSBlcnJvcl87DQogICAgICAgIG9uQnVpbHQoKTsNCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xvbmUoKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xvbmUoKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyRmllbGQoZmllbGQpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJPbmVvZigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLk9uZW9mRGVzY3JpcHRvciBvbmVvZikgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyT25lb2Yob25lb2YpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBpbnQgaW5kZXgsIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRSZXBlYXRlZEZpZWxkKGZpZWxkLCBpbmRleCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgYWRkUmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuYWRkUmVwZWF0ZWRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZSBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQpIHsNCiAgICAgICAgICByZXR1cm4gbWVyZ2VGcm9tKChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQpb3RoZXIpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHN1cGVyLm1lcmdlRnJvbShvdGhlcik7DQogICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgPT0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0LmdldERlZmF1bHRJbnN0YW5jZSgpKSByZXR1cm4gdGhpczsNCiAgICAgICAgaWYgKCFvdGhlci5nZXRNZXNzYWdlSUQoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICBtZXNzYWdlSURfID0gb3RoZXIubWVzc2FnZUlEXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0U2VudEF0KCkgIT0gMEwpIHsNCiAgICAgICAgICBzZXRTZW50QXQob3RoZXIuZ2V0U2VudEF0KCkpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRFeHBpcmF0aW9uQXQoKSAhPSAwTCkgew0KICAgICAgICAgIHNldEV4cGlyYXRpb25BdChvdGhlci5nZXRFeHBpcmF0aW9uQXQoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmdldERlbGF5ZWRUbygpICE9IDBMKSB7DQogICAgICAgICAgc2V0RGVsYXllZFRvKG90aGVyLmdldERlbGF5ZWRUbygpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0SXNFcnJvcigpICE9IGZhbHNlKSB7DQogICAgICAgICAgc2V0SXNFcnJvcihvdGhlci5nZXRJc0Vycm9yKCkpOw0KICAgICAgICB9DQogICAgICAgIGlmICghb3RoZXIuZ2V0RXJyb3IoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICBlcnJvcl8gPSBvdGhlci5lcnJvcl87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5tZXJnZVVua25vd25GaWVsZHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbSgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgcGFyc2VkTWVzc2FnZSA9IG51bGw7DQogICAgICAgIHRyeSB7DQogICAgICAgICAgcGFyc2VkTWVzc2FnZSA9IFBBUlNFUi5wYXJzZVBhcnRpYWxGcm9tKGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICAgIH0gY2F0Y2ggKGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCkgZS5nZXRVbmZpbmlzaGVkTWVzc2FnZSgpOw0KICAgICAgICAgIHRocm93IGUudW53cmFwSU9FeGNlcHRpb24oKTsNCiAgICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgICBpZiAocGFyc2VkTWVzc2FnZSAhPSBudWxsKSB7DQogICAgICAgICAgICBtZXJnZUZyb20ocGFyc2VkTWVzc2FnZSk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgbWVzc2FnZUlEXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTWVzc2FnZUlEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldE1lc3NhZ2VJRCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBtZXNzYWdlSURfOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICBtZXNzYWdlSURfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTWVzc2FnZUlEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRNZXNzYWdlSURCeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBtZXNzYWdlSURfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIG1lc3NhZ2VJRF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1lc3NhZ2VJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRNZXNzYWdlSUQoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBtZXNzYWdlSURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIE1lc3NhZ2VJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck1lc3NhZ2VJRCgpIHsNCiAgICAgICAgDQogICAgICAgIG1lc3NhZ2VJRF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRNZXNzYWdlSUQoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgTWVzc2FnZUlEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldE1lc3NhZ2VJREJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBtZXNzYWdlSURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBsb25nIHNlbnRBdF8gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQ2NCBTZW50QXQgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGxvbmcgZ2V0U2VudEF0KCkgew0KICAgICAgICByZXR1cm4gc2VudEF0XzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgU2VudEF0ID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFNlbnRBdChsb25nIHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICBzZW50QXRfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgU2VudEF0ID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyU2VudEF0KCkgew0KICAgICAgICANCiAgICAgICAgc2VudEF0XyA9IDBMOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgbG9uZyBleHBpcmF0aW9uQXRfIDsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50NjQgRXhwaXJhdGlvbkF0ID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBsb25nIGdldEV4cGlyYXRpb25BdCgpIHsNCiAgICAgICAgcmV0dXJuIGV4cGlyYXRpb25BdF87DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDY0IEV4cGlyYXRpb25BdCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRFeHBpcmF0aW9uQXQobG9uZyB2YWx1ZSkgew0KICAgICAgICANCiAgICAgICAgZXhwaXJhdGlvbkF0XyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDY0IEV4cGlyYXRpb25BdCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckV4cGlyYXRpb25BdCgpIHsNCiAgICAgICAgDQogICAgICAgIGV4cGlyYXRpb25BdF8gPSAwTDsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGxvbmcgZGVsYXllZFRvXyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDY0IERlbGF5ZWRUbyA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgbG9uZyBnZXREZWxheWVkVG8oKSB7DQogICAgICAgIHJldHVybiBkZWxheWVkVG9fOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQ2NCBEZWxheWVkVG8gPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RGVsYXllZFRvKGxvbmcgdmFsdWUpIHsNCiAgICAgICAgDQogICAgICAgIGRlbGF5ZWRUb18gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQ2NCBEZWxheWVkVG8gPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJEZWxheWVkVG8oKSB7DQogICAgICAgIA0KICAgICAgICBkZWxheWVkVG9fID0gMEw7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBib29sZWFuIGlzRXJyb3JfIDsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ym9vbCBJc0Vycm9yID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBib29sZWFuIGdldElzRXJyb3IoKSB7DQogICAgICAgIHJldHVybiBpc0Vycm9yXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ym9vbCBJc0Vycm9yID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldElzRXJyb3IoYm9vbGVhbiB2YWx1ZSkgew0KICAgICAgICANCiAgICAgICAgaXNFcnJvcl8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIElzRXJyb3IgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJJc0Vycm9yKCkgew0KICAgICAgICANCiAgICAgICAgaXNFcnJvcl8gPSBmYWxzZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgZXJyb3JfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDY7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRFcnJvcigpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBlcnJvcl87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIGVycm9yXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRFcnJvckJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGVycm9yXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBlcnJvcl8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEVycm9yKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgZXJyb3JfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyRXJyb3IoKSB7DQogICAgICAgIA0KICAgICAgICBlcnJvcl8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRFcnJvcigpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDY7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRFcnJvckJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBlcnJvcl8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgcHVibGljIGZpbmFsIEJ1aWxkZXIgc2V0VW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5zZXRVbmtub3duRmllbGRzUHJvdG8zKHVua25vd25GaWVsZHMpOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBtZXJnZVVua25vd25GaWVsZHMoDQogICAgICAgICAgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQgdW5rbm93bkZpZWxkcykgew0KICAgICAgICByZXR1cm4gc3VwZXIubWVyZ2VVbmtub3duRmllbGRzKHVua25vd25GaWVsZHMpOw0KICAgICAgfQ0KDQoNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChidWlsZGVyX3Njb3BlOmt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0KQ0KICAgIH0NCg0KICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChjbGFzc19zY29wZTprdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCkNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQgREVGQVVMVF9JTlNUQU5DRTsNCiAgICBzdGF0aWMgew0KICAgICAgREVGQVVMVF9JTlNUQU5DRSA9IG5ldyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQoKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdCBnZXREZWZhdWx0SW5zdGFuY2UoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRTsNCiAgICB9DQoNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxTZW5kUXVldWVNZXNzYWdlUmVzdWx0Pg0KICAgICAgICBQQVJTRVIgPSBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5BYnN0cmFjdFBhcnNlcjxTZW5kUXVldWVNZXNzYWdlUmVzdWx0PigpIHsNCiAgICAgIHB1YmxpYyBTZW5kUXVldWVNZXNzYWdlUmVzdWx0IHBhcnNlUGFydGlhbEZyb20oDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICAgIHJldHVybiBuZXcgU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdChpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgfQ0KICAgIH07DQoNCiAgICBwdWJsaWMgc3RhdGljIGNvbS5nb29nbGUucHJvdG9idWYuUGFyc2VyPFNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQ+IHBhcnNlcigpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxTZW5kUXVldWVNZXNzYWdlUmVzdWx0PiBnZXRQYXJzZXJGb3JUeXBlKCkgew0KICAgICAgcmV0dXJuIFBBUlNFUjsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TZW5kUXVldWVNZXNzYWdlUmVzdWx0IGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRTsNCiAgICB9DQoNCiAgfQ0KDQogIHB1YmxpYyBpbnRlcmZhY2UgUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0T3JCdWlsZGVyIGV4dGVuZHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChpbnRlcmZhY2VfZXh0ZW5kczprdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0KQ0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5NZXNzYWdlT3JCdWlsZGVyIHsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldFJlcXVlc3RJRCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0UmVxdWVzdElEQnl0ZXMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2xpZW50SUQoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0Q2xpZW50SURCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldENoYW5uZWwoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRDaGFubmVsQnl0ZXMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDMyIE1heE51bWJlck9mTWVzc2FnZXMgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBpbnQgZ2V0TWF4TnVtYmVyT2ZNZXNzYWdlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+aW50MzIgV2FpdFRpbWVTZWNvbmRzID0gNTs8L2NvZGU+DQogICAgICovDQogICAgaW50IGdldFdhaXRUaW1lU2Vjb25kcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+Ym9vbCBJc1BlYWsgPSA2OzwvY29kZT4NCiAgICAgKi8NCiAgICBib29sZWFuIGdldElzUGVhaygpOw0KICB9DQogIC8qKg0KICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0fQ0KICAgKi8NCiAgcHVibGljICBzdGF0aWMgZmluYWwgY2xhc3MgUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IGV4dGVuZHMNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzIGltcGxlbWVudHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChtZXNzYWdlX2ltcGxlbWVudHM6a3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCkNCiAgICAgIFJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdE9yQnVpbGRlciB7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGxvbmcgc2VyaWFsVmVyc2lvblVJRCA9IDBMOw0KICAgIC8vIFVzZSBSZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3QubmV3QnVpbGRlcigpIHRvIGNvbnN0cnVjdC4NCiAgICBwcml2YXRlIFJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdChjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPD8+IGJ1aWxkZXIpIHsNCiAgICAgIHN1cGVyKGJ1aWxkZXIpOw0KICAgIH0NCiAgICBwcml2YXRlIFJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCgpIHsNCiAgICAgIHJlcXVlc3RJRF8gPSAiIjsNCiAgICAgIGNsaWVudElEXyA9ICIiOw0KICAgICAgY2hhbm5lbF8gPSAiIjsNCiAgICAgIG1heE51bWJlck9mTWVzc2FnZXNfID0gMDsNCiAgICAgIHdhaXRUaW1lU2Vjb25kc18gPSAwOw0KICAgICAgaXNQZWFrXyA9IGZhbHNlOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQNCiAgICBnZXRVbmtub3duRmllbGRzKCkgew0KICAgICAgcmV0dXJuIHRoaXMudW5rbm93bkZpZWxkczsNCiAgICB9DQogICAgcHJpdmF0ZSBSZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3QoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICB0aGlzKCk7DQogICAgICBpZiAoZXh0ZW5zaW9uUmVnaXN0cnkgPT0gbnVsbCkgew0KICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogICAgICB9DQogICAgICBpbnQgbXV0YWJsZV9iaXRGaWVsZDBfID0gMDsNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0LkJ1aWxkZXIgdW5rbm93bkZpZWxkcyA9DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQubmV3QnVpbGRlcigpOw0KICAgICAgdHJ5IHsNCiAgICAgICAgYm9vbGVhbiBkb25lID0gZmFsc2U7DQogICAgICAgIHdoaWxlICghZG9uZSkgew0KICAgICAgICAgIGludCB0YWcgPSBpbnB1dC5yZWFkVGFnKCk7DQogICAgICAgICAgc3dpdGNoICh0YWcpIHsNCiAgICAgICAgICAgIGNhc2UgMDoNCiAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgZGVmYXVsdDogew0KICAgICAgICAgICAgICBpZiAoIXBhcnNlVW5rbm93bkZpZWxkUHJvdG8zKA0KICAgICAgICAgICAgICAgICAgaW5wdXQsIHVua25vd25GaWVsZHMsIGV4dGVuc2lvblJlZ2lzdHJ5LCB0YWcpKSB7DQogICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDEwOiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIHJlcXVlc3RJRF8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMTg6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgY2xpZW50SURfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDI2OiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIGNoYW5uZWxfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDMyOiB7DQoNCiAgICAgICAgICAgICAgbWF4TnVtYmVyT2ZNZXNzYWdlc18gPSBpbnB1dC5yZWFkSW50MzIoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDQwOiB7DQoNCiAgICAgICAgICAgICAgd2FpdFRpbWVTZWNvbmRzXyA9IGlucHV0LnJlYWRJbnQzMigpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNDg6IHsNCg0KICAgICAgICAgICAgICBpc1BlYWtfID0gaW5wdXQucmVhZEJvb2woKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9IGNhdGNoIChjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IGUuc2V0VW5maW5pc2hlZE1lc3NhZ2UodGhpcyk7DQogICAgICB9IGNhdGNoIChqYXZhLmlvLklPRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgdGhyb3cgbmV3IGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uKA0KICAgICAgICAgICAgZSkuc2V0VW5maW5pc2hlZE1lc3NhZ2UodGhpcyk7DQogICAgICB9IGZpbmFsbHkgew0KICAgICAgICB0aGlzLnVua25vd25GaWVsZHMgPSB1bmtub3duRmllbGRzLmJ1aWxkKCk7DQogICAgICAgIG1ha2VFeHRlbnNpb25zSW1tdXRhYmxlKCk7DQogICAgICB9DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1JlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdF9kZXNjcmlwdG9yOw0KICAgIH0NCg0KICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgaW50ZXJuYWxHZXRGaWVsZEFjY2Vzc29yVGFibGUoKSB7DQogICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1JlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdF9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3QuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0LkJ1aWxkZXIuY2xhc3MpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFJFUVVFU1RJRF9GSUVMRF9OVU1CRVIgPSAxOw0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCByZXF1ZXN0SURfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRSZXF1ZXN0SUQoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHJlcXVlc3RJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgcmVxdWVzdElEXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRSZXF1ZXN0SURCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVxdWVzdElEXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICByZXF1ZXN0SURfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENMSUVOVElEX0ZJRUxEX05VTUJFUiA9IDI7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IGNsaWVudElEXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDbGllbnRJRCgpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2xpZW50SURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIGNsaWVudElEXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldENsaWVudElEQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNsaWVudElEXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICBjbGllbnRJRF8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgQ0hBTk5FTF9GSUVMRF9OVU1CRVIgPSAzOw0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBjaGFubmVsXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldENoYW5uZWwoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNoYW5uZWxfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIGNoYW5uZWxfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRDaGFubmVsQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNoYW5uZWxfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIGNoYW5uZWxfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE1BWE5VTUJFUk9GTUVTU0FHRVNfRklFTERfTlVNQkVSID0gNDsNCiAgICBwcml2YXRlIGludCBtYXhOdW1iZXJPZk1lc3NhZ2VzXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQzMiBNYXhOdW1iZXJPZk1lc3NhZ2VzID0gNDs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGludCBnZXRNYXhOdW1iZXJPZk1lc3NhZ2VzKCkgew0KICAgICAgcmV0dXJuIG1heE51bWJlck9mTWVzc2FnZXNfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFdBSVRUSU1FU0VDT05EU19GSUVMRF9OVU1CRVIgPSA1Ow0KICAgIHByaXZhdGUgaW50IHdhaXRUaW1lU2Vjb25kc187DQogICAgLyoqDQogICAgICogPGNvZGU+aW50MzIgV2FpdFRpbWVTZWNvbmRzID0gNTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGludCBnZXRXYWl0VGltZVNlY29uZHMoKSB7DQogICAgICByZXR1cm4gd2FpdFRpbWVTZWNvbmRzXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBJU1BFQUtfRklFTERfTlVNQkVSID0gNjsNCiAgICBwcml2YXRlIGJvb2xlYW4gaXNQZWFrXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5ib29sIElzUGVhayA9IDY7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBib29sZWFuIGdldElzUGVhaygpIHsNCiAgICAgIHJldHVybiBpc1BlYWtfOw0KICAgIH0NCg0KICAgIHByaXZhdGUgYnl0ZSBtZW1vaXplZElzSW5pdGlhbGl6ZWQgPSAtMTsNCiAgICBwdWJsaWMgZmluYWwgYm9vbGVhbiBpc0luaXRpYWxpemVkKCkgew0KICAgICAgYnl0ZSBpc0luaXRpYWxpemVkID0gbWVtb2l6ZWRJc0luaXRpYWxpemVkOw0KICAgICAgaWYgKGlzSW5pdGlhbGl6ZWQgPT0gMSkgcmV0dXJuIHRydWU7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAwKSByZXR1cm4gZmFsc2U7DQoNCiAgICAgIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IDE7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQoNCiAgICBwdWJsaWMgdm9pZCB3cml0ZVRvKGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0gb3V0cHV0KQ0KICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgaWYgKCFnZXRSZXF1ZXN0SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDEsIHJlcXVlc3RJRF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRDbGllbnRJREJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLndyaXRlU3RyaW5nKG91dHB1dCwgMiwgY2xpZW50SURfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0Q2hhbm5lbEJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLndyaXRlU3RyaW5nKG91dHB1dCwgMywgY2hhbm5lbF8pOw0KICAgICAgfQ0KICAgICAgaWYgKG1heE51bWJlck9mTWVzc2FnZXNfICE9IDApIHsNCiAgICAgICAgb3V0cHV0LndyaXRlSW50MzIoNCwgbWF4TnVtYmVyT2ZNZXNzYWdlc18pOw0KICAgICAgfQ0KICAgICAgaWYgKHdhaXRUaW1lU2Vjb25kc18gIT0gMCkgew0KICAgICAgICBvdXRwdXQud3JpdGVJbnQzMig1LCB3YWl0VGltZVNlY29uZHNfKTsNCiAgICAgIH0NCiAgICAgIGlmIChpc1BlYWtfICE9IGZhbHNlKSB7DQogICAgICAgIG91dHB1dC53cml0ZUJvb2woNiwgaXNQZWFrXyk7DQogICAgICB9DQogICAgICB1bmtub3duRmllbGRzLndyaXRlVG8ob3V0cHV0KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW50IGdldFNlcmlhbGl6ZWRTaXplKCkgew0KICAgICAgaW50IHNpemUgPSBtZW1vaXplZFNpemU7DQogICAgICBpZiAoc2l6ZSAhPSAtMSkgcmV0dXJuIHNpemU7DQoNCiAgICAgIHNpemUgPSAwOw0KICAgICAgaWYgKCFnZXRSZXF1ZXN0SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDEsIHJlcXVlc3RJRF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRDbGllbnRJREJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoMiwgY2xpZW50SURfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0Q2hhbm5lbEJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoMywgY2hhbm5lbF8pOw0KICAgICAgfQ0KICAgICAgaWYgKG1heE51bWJlck9mTWVzc2FnZXNfICE9IDApIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVJbnQzMlNpemUoNCwgbWF4TnVtYmVyT2ZNZXNzYWdlc18pOw0KICAgICAgfQ0KICAgICAgaWYgKHdhaXRUaW1lU2Vjb25kc18gIT0gMCkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUludDMyU2l6ZSg1LCB3YWl0VGltZVNlY29uZHNfKTsNCiAgICAgIH0NCiAgICAgIGlmIChpc1BlYWtfICE9IGZhbHNlKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlQm9vbFNpemUoNiwgaXNQZWFrXyk7DQogICAgICB9DQogICAgICBzaXplICs9IHVua25vd25GaWVsZHMuZ2V0U2VyaWFsaXplZFNpemUoKTsNCiAgICAgIG1lbW9pemVkU2l6ZSA9IHNpemU7DQogICAgICByZXR1cm4gc2l6ZTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGJvb2xlYW4gZXF1YWxzKGZpbmFsIGphdmEubGFuZy5PYmplY3Qgb2JqKSB7DQogICAgICBpZiAob2JqID09IHRoaXMpIHsNCiAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIGlmICghKG9iaiBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0KSkgew0KICAgICAgICByZXR1cm4gc3VwZXIuZXF1YWxzKG9iaik7DQogICAgICB9DQogICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCBvdGhlciA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCkgb2JqOw0KDQogICAgICBib29sZWFuIHJlc3VsdCA9IHRydWU7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0UmVxdWVzdElEKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldFJlcXVlc3RJRCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRDbGllbnRJRCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRDbGllbnRJRCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRDaGFubmVsKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldENoYW5uZWwoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldE1heE51bWJlck9mTWVzc2FnZXMoKQ0KICAgICAgICAgID09IG90aGVyLmdldE1heE51bWJlck9mTWVzc2FnZXMoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldFdhaXRUaW1lU2Vjb25kcygpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0V2FpdFRpbWVTZWNvbmRzKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChnZXRJc1BlYWsoKQ0KICAgICAgICAgID09IG90aGVyLmdldElzUGVhaygpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiB1bmtub3duRmllbGRzLmVxdWFscyhvdGhlci51bmtub3duRmllbGRzKTsNCiAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBpbnQgaGFzaENvZGUoKSB7DQogICAgICBpZiAobWVtb2l6ZWRIYXNoQ29kZSAhPSAwKSB7DQogICAgICAgIHJldHVybiBtZW1vaXplZEhhc2hDb2RlOw0KICAgICAgfQ0KICAgICAgaW50IGhhc2ggPSA0MTsNCiAgICAgIGhhc2ggPSAoMTkgKiBoYXNoKSArIGdldERlc2NyaXB0b3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgUkVRVUVTVElEX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldFJlcXVlc3RJRCgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBDTElFTlRJRF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRDbGllbnRJRCgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBDSEFOTkVMX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldENoYW5uZWwoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgTUFYTlVNQkVST0ZNRVNTQUdFU19GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRNYXhOdW1iZXJPZk1lc3NhZ2VzKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBXQUlUVElNRVNFQ09ORFNfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0V2FpdFRpbWVTZWNvbmRzKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBJU1BFQUtfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5oYXNoQm9vbGVhbigNCiAgICAgICAgICBnZXRJc1BlYWsoKSk7DQogICAgICBoYXNoID0gKDI5ICogaGFzaCkgKyB1bmtub3duRmllbGRzLmhhc2hDb2RlKCk7DQogICAgICBtZW1vaXplZEhhc2hDb2RlID0gaGFzaDsNCiAgICAgIHJldHVybiBoYXNoOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZUZyb20oDQogICAgICAgIGphdmEubmlvLkJ5dGVCdWZmZXIgZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlRnJvbShieXRlW10gZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgYnl0ZVtdIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlRnJvbShqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZURlbGltaXRlZEZyb20oamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlRGVsaW1pdGVkRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZURlbGltaXRlZFdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KDQogICAgcHVibGljIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoKSB7IHJldHVybiBuZXdCdWlsZGVyKCk7IH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcigpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFLnRvQnVpbGRlcigpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcihpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwcm90b3R5cGUpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFLnRvQnVpbGRlcigpLm1lcmdlRnJvbShwcm90b3R5cGUpOw0KICAgIH0NCiAgICBwdWJsaWMgQnVpbGRlciB0b0J1aWxkZXIoKSB7DQogICAgICByZXR1cm4gdGhpcyA9PSBERUZBVUxUX0lOU1RBTkNFDQogICAgICAgICAgPyBuZXcgQnVpbGRlcigpIDogbmV3IEJ1aWxkZXIoKS5tZXJnZUZyb20odGhpcyk7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHByb3RlY3RlZCBCdWlsZGVyIG5ld0J1aWxkZXJGb3JUeXBlKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgQnVpbGRlciBidWlsZGVyID0gbmV3IEJ1aWxkZXIocGFyZW50KTsNCiAgICAgIHJldHVybiBidWlsZGVyOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0fQ0KICAgICAqLw0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY2xhc3MgQnVpbGRlciBleHRlbmRzDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8QnVpbGRlcj4gaW1wbGVtZW50cw0KICAgICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoYnVpbGRlcl9pbXBsZW1lbnRzOmt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3QpDQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0T3JCdWlsZGVyIHsNCiAgICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvcigpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3RfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICAgIGludGVybmFsR2V0RmllbGRBY2Nlc3NvclRhYmxlKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1JlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdF9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAgIC5lbnN1cmVGaWVsZEFjY2Vzc29yc0luaXRpYWxpemVkKA0KICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0LmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdC5CdWlsZGVyLmNsYXNzKTsNCiAgICAgIH0NCg0KICAgICAgLy8gQ29uc3RydWN0IHVzaW5nIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0Lm5ld0J1aWxkZXIoKQ0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKCkgew0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgQnVpbGRlcigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgICBzdXBlcihwYXJlbnQpOw0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQogICAgICBwcml2YXRlIHZvaWQgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpIHsNCiAgICAgICAgaWYgKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgICAgICAgLmFsd2F5c1VzZUZpZWxkQnVpbGRlcnMpIHsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXIoKSB7DQogICAgICAgIHN1cGVyLmNsZWFyKCk7DQogICAgICAgIHJlcXVlc3RJRF8gPSAiIjsNCg0KICAgICAgICBjbGllbnRJRF8gPSAiIjsNCg0KICAgICAgICBjaGFubmVsXyA9ICIiOw0KDQogICAgICAgIG1heE51bWJlck9mTWVzc2FnZXNfID0gMDsNCg0KICAgICAgICB3YWl0VGltZVNlY29uZHNfID0gMDsNCg0KICAgICAgICBpc1BlYWtfID0gZmFsc2U7DQoNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3RfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdC5nZXREZWZhdWx0SW5zdGFuY2UoKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IGJ1aWxkKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCByZXN1bHQgPSBidWlsZFBhcnRpYWwoKTsNCiAgICAgICAgaWYgKCFyZXN1bHQuaXNJbml0aWFsaXplZCgpKSB7DQogICAgICAgICAgdGhyb3cgbmV3VW5pbml0aWFsaXplZE1lc3NhZ2VFeGNlcHRpb24ocmVzdWx0KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3QgYnVpbGRQYXJ0aWFsKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCByZXN1bHQgPSBuZXcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3QodGhpcyk7DQogICAgICAgIHJlc3VsdC5yZXF1ZXN0SURfID0gcmVxdWVzdElEXzsNCiAgICAgICAgcmVzdWx0LmNsaWVudElEXyA9IGNsaWVudElEXzsNCiAgICAgICAgcmVzdWx0LmNoYW5uZWxfID0gY2hhbm5lbF87DQogICAgICAgIHJlc3VsdC5tYXhOdW1iZXJPZk1lc3NhZ2VzXyA9IG1heE51bWJlck9mTWVzc2FnZXNfOw0KICAgICAgICByZXN1bHQud2FpdFRpbWVTZWNvbmRzXyA9IHdhaXRUaW1lU2Vjb25kc187DQogICAgICAgIHJlc3VsdC5pc1BlYWtfID0gaXNQZWFrXzsNCiAgICAgICAgb25CdWlsdCgpOw0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBjbG9uZSgpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbG9uZSgpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJGaWVsZChmaWVsZCk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck9uZW9mKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuT25lb2ZEZXNjcmlwdG9yIG9uZW9mKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJPbmVvZihvbmVvZik7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGludCBpbmRleCwgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldFJlcGVhdGVkRmllbGQoZmllbGQsIGluZGV4LCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBhZGRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5hZGRSZXBlYXRlZEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oY29tLmdvb2dsZS5wcm90b2J1Zi5NZXNzYWdlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0KSB7DQogICAgICAgICAgcmV0dXJuIG1lcmdlRnJvbSgoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3Qpb3RoZXIpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHN1cGVyLm1lcmdlRnJvbShvdGhlcik7DQogICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciA9PSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdC5nZXREZWZhdWx0SW5zdGFuY2UoKSkgcmV0dXJuIHRoaXM7DQogICAgICAgIGlmICghb3RoZXIuZ2V0UmVxdWVzdElEKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgcmVxdWVzdElEXyA9IG90aGVyLnJlcXVlc3RJRF87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRDbGllbnRJRCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIGNsaWVudElEXyA9IG90aGVyLmNsaWVudElEXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAoIW90aGVyLmdldENoYW5uZWwoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICBjaGFubmVsXyA9IG90aGVyLmNoYW5uZWxfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRNYXhOdW1iZXJPZk1lc3NhZ2VzKCkgIT0gMCkgew0KICAgICAgICAgIHNldE1heE51bWJlck9mTWVzc2FnZXMob3RoZXIuZ2V0TWF4TnVtYmVyT2ZNZXNzYWdlcygpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0V2FpdFRpbWVTZWNvbmRzKCkgIT0gMCkgew0KICAgICAgICAgIHNldFdhaXRUaW1lU2Vjb25kcyhvdGhlci5nZXRXYWl0VGltZVNlY29uZHMoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmdldElzUGVhaygpICE9IGZhbHNlKSB7DQogICAgICAgICAgc2V0SXNQZWFrKG90aGVyLmdldElzUGVhaygpKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLm1lcmdlVW5rbm93bkZpZWxkcyhvdGhlci51bmtub3duRmllbGRzKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgZmluYWwgYm9vbGVhbiBpc0luaXRpYWxpemVkKCkgew0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlZE1lc3NhZ2UgPSBudWxsOw0KICAgICAgICB0cnkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSBQQVJTRVIucGFyc2VQYXJ0aWFsRnJvbShpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgICB9IGNhdGNoIChjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiBlKSB7DQogICAgICAgICAgcGFyc2VkTWVzc2FnZSA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCkgZS5nZXRVbmZpbmlzaGVkTWVzc2FnZSgpOw0KICAgICAgICAgIHRocm93IGUudW53cmFwSU9FeGNlcHRpb24oKTsNCiAgICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgICBpZiAocGFyc2VkTWVzc2FnZSAhPSBudWxsKSB7DQogICAgICAgICAgICBtZXJnZUZyb20ocGFyc2VkTWVzc2FnZSk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgcmVxdWVzdElEXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFJlcXVlc3RJRCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXF1ZXN0SURfOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICByZXF1ZXN0SURfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRSZXF1ZXN0SURCeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXF1ZXN0SURfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIHJlcXVlc3RJRF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXF1ZXN0SUQoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICByZXF1ZXN0SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhclJlcXVlc3RJRCgpIHsNCiAgICAgICAgDQogICAgICAgIHJlcXVlc3RJRF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRSZXF1ZXN0SUQoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlcXVlc3RJREJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICByZXF1ZXN0SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IGNsaWVudElEXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2xpZW50SUQoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2xpZW50SURfOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICBjbGllbnRJRF8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0Q2xpZW50SURCeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjbGllbnRJRF87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgY2xpZW50SURfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRDbGllbnRJRCgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIGNsaWVudElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckNsaWVudElEKCkgew0KICAgICAgICANCiAgICAgICAgY2xpZW50SURfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0Q2xpZW50SUQoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2xpZW50SURCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgY2xpZW50SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IGNoYW5uZWxfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldENoYW5uZWwoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2hhbm5lbF87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIGNoYW5uZWxfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0Q2hhbm5lbEJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNoYW5uZWxfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIGNoYW5uZWxfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldENoYW5uZWwoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBjaGFubmVsXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyQ2hhbm5lbCgpIHsNCiAgICAgICAgDQogICAgICAgIGNoYW5uZWxfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0Q2hhbm5lbCgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldENoYW5uZWxCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgY2hhbm5lbF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGludCBtYXhOdW1iZXJPZk1lc3NhZ2VzXyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIE1heE51bWJlck9mTWVzc2FnZXMgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGludCBnZXRNYXhOdW1iZXJPZk1lc3NhZ2VzKCkgew0KICAgICAgICByZXR1cm4gbWF4TnVtYmVyT2ZNZXNzYWdlc187DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIE1heE51bWJlck9mTWVzc2FnZXMgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0TWF4TnVtYmVyT2ZNZXNzYWdlcyhpbnQgdmFsdWUpIHsNCiAgICAgICAgDQogICAgICAgIG1heE51bWJlck9mTWVzc2FnZXNfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50MzIgTWF4TnVtYmVyT2ZNZXNzYWdlcyA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck1heE51bWJlck9mTWVzc2FnZXMoKSB7DQogICAgICAgIA0KICAgICAgICBtYXhOdW1iZXJPZk1lc3NhZ2VzXyA9IDA7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBpbnQgd2FpdFRpbWVTZWNvbmRzXyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIFdhaXRUaW1lU2Vjb25kcyA9IDU7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW50IGdldFdhaXRUaW1lU2Vjb25kcygpIHsNCiAgICAgICAgcmV0dXJuIHdhaXRUaW1lU2Vjb25kc187DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIFdhaXRUaW1lU2Vjb25kcyA9IDU7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRXYWl0VGltZVNlY29uZHMoaW50IHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICB3YWl0VGltZVNlY29uZHNfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50MzIgV2FpdFRpbWVTZWNvbmRzID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyV2FpdFRpbWVTZWNvbmRzKCkgew0KICAgICAgICANCiAgICAgICAgd2FpdFRpbWVTZWNvbmRzXyA9IDA7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBib29sZWFuIGlzUGVha18gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIElzUGVhayA9IDY7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgYm9vbGVhbiBnZXRJc1BlYWsoKSB7DQogICAgICAgIHJldHVybiBpc1BlYWtfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIElzUGVhayA9IDY7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRJc1BlYWsoYm9vbGVhbiB2YWx1ZSkgew0KICAgICAgICANCiAgICAgICAgaXNQZWFrXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJvb2wgSXNQZWFrID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFySXNQZWFrKCkgew0KICAgICAgICANCiAgICAgICAgaXNQZWFrXyA9IGZhbHNlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBzZXRVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLnNldFVua25vd25GaWVsZHNQcm90bzModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIG1lcmdlVW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5tZXJnZVVua25vd25GaWVsZHModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCg0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfc2NvcGU6a3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCkNCiAgICB9DQoNCiAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoY2xhc3Nfc2NvcGU6a3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCkNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCBERUZBVUxUX0lOU1RBTkNFOw0KICAgIHN0YXRpYyB7DQogICAgICBERUZBVUxUX0lOU1RBTkNFID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0KCk7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdCBnZXREZWZhdWx0SW5zdGFuY2UoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRTsNCiAgICB9DQoNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxSZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3Q+DQogICAgICAgIFBBUlNFUiA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkFic3RyYWN0UGFyc2VyPFJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdD4oKSB7DQogICAgICBwdWJsaWMgUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlUGFydGlhbEZyb20oDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICAgIHJldHVybiBuZXcgUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0KGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICB9DQogICAgfTsNCg0KICAgIHB1YmxpYyBzdGF0aWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0PiBwYXJzZXIoKSB7DQogICAgICByZXR1cm4gUEFSU0VSOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8UmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0PiBnZXRQYXJzZXJGb3JUeXBlKCkgew0KICAgICAgcmV0dXJuIFBBUlNFUjsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3QgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFOw0KICAgIH0NCg0KICB9DQoNCiAgcHVibGljIGludGVyZmFjZSBSZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlT3JCdWlsZGVyIGV4dGVuZHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChpbnRlcmZhY2VfZXh0ZW5kczprdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZSkNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZU9yQnVpbGRlciB7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRSZXF1ZXN0SUQoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldFJlcXVlc3RJREJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEudXRpbC5MaXN0PGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlPiANCiAgICAgICAgZ2V0TWVzc2FnZXNMaXN0KCk7DQogICAgLyoqDQogICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBnZXRNZXNzYWdlcyhpbnQgaW5kZXgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICovDQogICAgaW50IGdldE1lc3NhZ2VzQ291bnQoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEudXRpbC5MaXN0PD8gZXh0ZW5kcyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZU9yQnVpbGRlcj4gDQogICAgICAgIGdldE1lc3NhZ2VzT3JCdWlsZGVyTGlzdCgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICovDQogICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VPckJ1aWxkZXIgZ2V0TWVzc2FnZXNPckJ1aWxkZXIoDQogICAgICAgIGludCBpbmRleCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQzMiBNZXNzYWdlc1JlY2VpdmVkID0gMzs8L2NvZGU+DQogICAgICovDQogICAgaW50IGdldE1lc3NhZ2VzUmVjZWl2ZWQoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDMyIE1lc3NhZ2VzRXhwaXJlZCA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIGludCBnZXRNZXNzYWdlc0V4cGlyZWQoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmJvb2wgSXNQZWFrID0gNTs8L2NvZGU+DQogICAgICovDQogICAgYm9vbGVhbiBnZXRJc1BlYWsoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmJvb2wgSXNFcnJvciA9IDY7PC9jb2RlPg0KICAgICAqLw0KICAgIGJvb2xlYW4gZ2V0SXNFcnJvcigpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNzs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRFcnJvcigpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDc7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRFcnJvckJ5dGVzKCk7DQogIH0NCiAgLyoqDQogICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlfQ0KICAgKi8NCiAgcHVibGljICBzdGF0aWMgZmluYWwgY2xhc3MgUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBleHRlbmRzDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMyBpbXBsZW1lbnRzDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQobWVzc2FnZV9pbXBsZW1lbnRzOmt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlKQ0KICAgICAgUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZU9yQnVpbGRlciB7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGxvbmcgc2VyaWFsVmVyc2lvblVJRCA9IDBMOw0KICAgIC8vIFVzZSBSZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlLm5ld0J1aWxkZXIoKSB0byBjb25zdHJ1Y3QuDQogICAgcHJpdmF0ZSBSZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8Pz4gYnVpbGRlcikgew0KICAgICAgc3VwZXIoYnVpbGRlcik7DQogICAgfQ0KICAgIHByaXZhdGUgUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZSgpIHsNCiAgICAgIHJlcXVlc3RJRF8gPSAiIjsNCiAgICAgIG1lc3NhZ2VzXyA9IGphdmEudXRpbC5Db2xsZWN0aW9ucy5lbXB0eUxpc3QoKTsNCiAgICAgIG1lc3NhZ2VzUmVjZWl2ZWRfID0gMDsNCiAgICAgIG1lc3NhZ2VzRXhwaXJlZF8gPSAwOw0KICAgICAgaXNQZWFrXyA9IGZhbHNlOw0KICAgICAgaXNFcnJvcl8gPSBmYWxzZTsNCiAgICAgIGVycm9yXyA9ICIiOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQNCiAgICBnZXRVbmtub3duRmllbGRzKCkgew0KICAgICAgcmV0dXJuIHRoaXMudW5rbm93bkZpZWxkczsNCiAgICB9DQogICAgcHJpdmF0ZSBSZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgdGhpcygpOw0KICAgICAgaWYgKGV4dGVuc2lvblJlZ2lzdHJ5ID09IG51bGwpIHsNCiAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgfQ0KICAgICAgaW50IG11dGFibGVfYml0RmllbGQwXyA9IDA7DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldC5CdWlsZGVyIHVua25vd25GaWVsZHMgPQ0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0Lm5ld0J1aWxkZXIoKTsNCiAgICAgIHRyeSB7DQogICAgICAgIGJvb2xlYW4gZG9uZSA9IGZhbHNlOw0KICAgICAgICB3aGlsZSAoIWRvbmUpIHsNCiAgICAgICAgICBpbnQgdGFnID0gaW5wdXQucmVhZFRhZygpOw0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7DQogICAgICAgICAgICBjYXNlIDA6DQogICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGRlZmF1bHQ6IHsNCiAgICAgICAgICAgICAgaWYgKCFwYXJzZVVua25vd25GaWVsZFByb3RvMygNCiAgICAgICAgICAgICAgICAgIGlucHV0LCB1bmtub3duRmllbGRzLCBleHRlbnNpb25SZWdpc3RyeSwgdGFnKSkgew0KICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAxMDogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICByZXF1ZXN0SURfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDE4OiB7DQogICAgICAgICAgICAgIGlmICghKChtdXRhYmxlX2JpdEZpZWxkMF8gJiAweDAwMDAwMDAyKSA9PSAweDAwMDAwMDAyKSkgew0KICAgICAgICAgICAgICAgIG1lc3NhZ2VzXyA9IG5ldyBqYXZhLnV0aWwuQXJyYXlMaXN0PGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlPigpOw0KICAgICAgICAgICAgICAgIG11dGFibGVfYml0RmllbGQwXyB8PSAweDAwMDAwMDAyOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIG1lc3NhZ2VzXy5hZGQoDQogICAgICAgICAgICAgICAgICBpbnB1dC5yZWFkTWVzc2FnZShpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5wYXJzZXIoKSwgZXh0ZW5zaW9uUmVnaXN0cnkpKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDI0OiB7DQoNCiAgICAgICAgICAgICAgbWVzc2FnZXNSZWNlaXZlZF8gPSBpbnB1dC5yZWFkSW50MzIoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDMyOiB7DQoNCiAgICAgICAgICAgICAgbWVzc2FnZXNFeHBpcmVkXyA9IGlucHV0LnJlYWRJbnQzMigpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNDA6IHsNCg0KICAgICAgICAgICAgICBpc1BlYWtfID0gaW5wdXQucmVhZEJvb2woKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDQ4OiB7DQoNCiAgICAgICAgICAgICAgaXNFcnJvcl8gPSBpbnB1dC5yZWFkQm9vbCgpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNTg6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgZXJyb3JfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICB9IGNhdGNoIChjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IGUuc2V0VW5maW5pc2hlZE1lc3NhZ2UodGhpcyk7DQogICAgICB9IGNhdGNoIChqYXZhLmlvLklPRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgdGhyb3cgbmV3IGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uKA0KICAgICAgICAgICAgZSkuc2V0VW5maW5pc2hlZE1lc3NhZ2UodGhpcyk7DQogICAgICB9IGZpbmFsbHkgew0KICAgICAgICBpZiAoKChtdXRhYmxlX2JpdEZpZWxkMF8gJiAweDAwMDAwMDAyKSA9PSAweDAwMDAwMDAyKSkgew0KICAgICAgICAgIG1lc3NhZ2VzXyA9IGphdmEudXRpbC5Db2xsZWN0aW9ucy51bm1vZGlmaWFibGVMaXN0KG1lc3NhZ2VzXyk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy51bmtub3duRmllbGRzID0gdW5rbm93bkZpZWxkcy5idWlsZCgpOw0KICAgICAgICBtYWtlRXh0ZW5zaW9uc0ltbXV0YWJsZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlX2Rlc2NyaXB0b3I7DQogICAgfQ0KDQogICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZV9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlLmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UuQnVpbGRlci5jbGFzcyk7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBpbnQgYml0RmllbGQwXzsNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBSRVFVRVNUSURfRklFTERfTlVNQkVSID0gMTsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgcmVxdWVzdElEXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0UmVxdWVzdElEKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXF1ZXN0SURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIHJlcXVlc3RJRF8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0UmVxdWVzdElEQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHJlcXVlc3RJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgcmVxdWVzdElEXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNRVNTQUdFU19GSUVMRF9OVU1CRVIgPSAyOw0KICAgIHByaXZhdGUgamF2YS51dGlsLkxpc3Q8aW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2U+IG1lc3NhZ2VzXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLnV0aWwuTGlzdDxpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZT4gZ2V0TWVzc2FnZXNMaXN0KCkgew0KICAgICAgcmV0dXJuIG1lc3NhZ2VzXzsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS51dGlsLkxpc3Q8PyBleHRlbmRzIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlT3JCdWlsZGVyPiANCiAgICAgICAgZ2V0TWVzc2FnZXNPckJ1aWxkZXJMaXN0KCkgew0KICAgICAgcmV0dXJuIG1lc3NhZ2VzXzsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgaW50IGdldE1lc3NhZ2VzQ291bnQoKSB7DQogICAgICByZXR1cm4gbWVzc2FnZXNfLnNpemUoKTsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgZ2V0TWVzc2FnZXMoaW50IGluZGV4KSB7DQogICAgICByZXR1cm4gbWVzc2FnZXNfLmdldChpbmRleCk7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlT3JCdWlsZGVyIGdldE1lc3NhZ2VzT3JCdWlsZGVyKA0KICAgICAgICBpbnQgaW5kZXgpIHsNCiAgICAgIHJldHVybiBtZXNzYWdlc18uZ2V0KGluZGV4KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNRVNTQUdFU1JFQ0VJVkVEX0ZJRUxEX05VTUJFUiA9IDM7DQogICAgcHJpdmF0ZSBpbnQgbWVzc2FnZXNSZWNlaXZlZF87DQogICAgLyoqDQogICAgICogPGNvZGU+aW50MzIgTWVzc2FnZXNSZWNlaXZlZCA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpbnQgZ2V0TWVzc2FnZXNSZWNlaXZlZCgpIHsNCiAgICAgIHJldHVybiBtZXNzYWdlc1JlY2VpdmVkXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBNRVNTQUdFU0VYUElSRURfRklFTERfTlVNQkVSID0gNDsNCiAgICBwcml2YXRlIGludCBtZXNzYWdlc0V4cGlyZWRfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDMyIE1lc3NhZ2VzRXhwaXJlZCA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpbnQgZ2V0TWVzc2FnZXNFeHBpcmVkKCkgew0KICAgICAgcmV0dXJuIG1lc3NhZ2VzRXhwaXJlZF87DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgSVNQRUFLX0ZJRUxEX05VTUJFUiA9IDU7DQogICAgcHJpdmF0ZSBib29sZWFuIGlzUGVha187DQogICAgLyoqDQogICAgICogPGNvZGU+Ym9vbCBJc1BlYWsgPSA1OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgYm9vbGVhbiBnZXRJc1BlYWsoKSB7DQogICAgICByZXR1cm4gaXNQZWFrXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBJU0VSUk9SX0ZJRUxEX05VTUJFUiA9IDY7DQogICAgcHJpdmF0ZSBib29sZWFuIGlzRXJyb3JfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmJvb2wgSXNFcnJvciA9IDY7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBib29sZWFuIGdldElzRXJyb3IoKSB7DQogICAgICByZXR1cm4gaXNFcnJvcl87DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRVJST1JfRklFTERfTlVNQkVSID0gNzsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgZXJyb3JfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDc7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldEVycm9yKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBlcnJvcl87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgZXJyb3JfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDc7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0RXJyb3JCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gZXJyb3JfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIGVycm9yXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwcml2YXRlIGJ5dGUgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gLTE7DQogICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgIGJ5dGUgaXNJbml0aWFsaXplZCA9IG1lbW9pemVkSXNJbml0aWFsaXplZDsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDEpIHJldHVybiB0cnVlOw0KICAgICAgaWYgKGlzSW5pdGlhbGl6ZWQgPT0gMCkgcmV0dXJuIGZhbHNlOw0KDQogICAgICBtZW1vaXplZElzSW5pdGlhbGl6ZWQgPSAxOw0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KDQogICAgcHVibGljIHZvaWQgd3JpdGVUbyhjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtIG91dHB1dCkNCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIGlmICghZ2V0UmVxdWVzdElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAxLCByZXF1ZXN0SURfKTsNCiAgICAgIH0NCiAgICAgIGZvciAoaW50IGkgPSAwOyBpIDwgbWVzc2FnZXNfLnNpemUoKTsgaSsrKSB7DQogICAgICAgIG91dHB1dC53cml0ZU1lc3NhZ2UoMiwgbWVzc2FnZXNfLmdldChpKSk7DQogICAgICB9DQogICAgICBpZiAobWVzc2FnZXNSZWNlaXZlZF8gIT0gMCkgew0KICAgICAgICBvdXRwdXQud3JpdGVJbnQzMigzLCBtZXNzYWdlc1JlY2VpdmVkXyk7DQogICAgICB9DQogICAgICBpZiAobWVzc2FnZXNFeHBpcmVkXyAhPSAwKSB7DQogICAgICAgIG91dHB1dC53cml0ZUludDMyKDQsIG1lc3NhZ2VzRXhwaXJlZF8pOw0KICAgICAgfQ0KICAgICAgaWYgKGlzUGVha18gIT0gZmFsc2UpIHsNCiAgICAgICAgb3V0cHV0LndyaXRlQm9vbCg1LCBpc1BlYWtfKTsNCiAgICAgIH0NCiAgICAgIGlmIChpc0Vycm9yXyAhPSBmYWxzZSkgew0KICAgICAgICBvdXRwdXQud3JpdGVCb29sKDYsIGlzRXJyb3JfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0RXJyb3JCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDcsIGVycm9yXyk7DQogICAgICB9DQogICAgICB1bmtub3duRmllbGRzLndyaXRlVG8ob3V0cHV0KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW50IGdldFNlcmlhbGl6ZWRTaXplKCkgew0KICAgICAgaW50IHNpemUgPSBtZW1vaXplZFNpemU7DQogICAgICBpZiAoc2l6ZSAhPSAtMSkgcmV0dXJuIHNpemU7DQoNCiAgICAgIHNpemUgPSAwOw0KICAgICAgaWYgKCFnZXRSZXF1ZXN0SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDEsIHJlcXVlc3RJRF8pOw0KICAgICAgfQ0KICAgICAgZm9yIChpbnQgaSA9IDA7IGkgPCBtZXNzYWdlc18uc2l6ZSgpOyBpKyspIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVNZXNzYWdlU2l6ZSgyLCBtZXNzYWdlc18uZ2V0KGkpKTsNCiAgICAgIH0NCiAgICAgIGlmIChtZXNzYWdlc1JlY2VpdmVkXyAhPSAwKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlSW50MzJTaXplKDMsIG1lc3NhZ2VzUmVjZWl2ZWRfKTsNCiAgICAgIH0NCiAgICAgIGlmIChtZXNzYWdlc0V4cGlyZWRfICE9IDApIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVJbnQzMlNpemUoNCwgbWVzc2FnZXNFeHBpcmVkXyk7DQogICAgICB9DQogICAgICBpZiAoaXNQZWFrXyAhPSBmYWxzZSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUJvb2xTaXplKDUsIGlzUGVha18pOw0KICAgICAgfQ0KICAgICAgaWYgKGlzRXJyb3JfICE9IGZhbHNlKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlQm9vbFNpemUoNiwgaXNFcnJvcl8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRFcnJvckJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoNywgZXJyb3JfKTsNCiAgICAgIH0NCiAgICAgIHNpemUgKz0gdW5rbm93bkZpZWxkcy5nZXRTZXJpYWxpemVkU2l6ZSgpOw0KICAgICAgbWVtb2l6ZWRTaXplID0gc2l6ZTsNCiAgICAgIHJldHVybiBzaXplOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgYm9vbGVhbiBlcXVhbHMoZmluYWwgamF2YS5sYW5nLk9iamVjdCBvYmopIHsNCiAgICAgIGlmIChvYmogPT0gdGhpcykgew0KICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KICAgICAgaWYgKCEob2JqIGluc3RhbmNlb2YgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlKSkgew0KICAgICAgICByZXR1cm4gc3VwZXIuZXF1YWxzKG9iaik7DQogICAgICB9DQogICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2Ugb3RoZXIgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlKSBvYmo7DQoNCiAgICAgIGJvb2xlYW4gcmVzdWx0ID0gdHJ1ZTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRSZXF1ZXN0SUQoKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0UmVxdWVzdElEKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIGdldE1lc3NhZ2VzTGlzdCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRNZXNzYWdlc0xpc3QoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldE1lc3NhZ2VzUmVjZWl2ZWQoKQ0KICAgICAgICAgID09IG90aGVyLmdldE1lc3NhZ2VzUmVjZWl2ZWQoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldE1lc3NhZ2VzRXhwaXJlZCgpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0TWVzc2FnZXNFeHBpcmVkKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChnZXRJc1BlYWsoKQ0KICAgICAgICAgID09IG90aGVyLmdldElzUGVhaygpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiAoZ2V0SXNFcnJvcigpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0SXNFcnJvcigpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRFcnJvcigpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRFcnJvcigpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiB1bmtub3duRmllbGRzLmVxdWFscyhvdGhlci51bmtub3duRmllbGRzKTsNCiAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBpbnQgaGFzaENvZGUoKSB7DQogICAgICBpZiAobWVtb2l6ZWRIYXNoQ29kZSAhPSAwKSB7DQogICAgICAgIHJldHVybiBtZW1vaXplZEhhc2hDb2RlOw0KICAgICAgfQ0KICAgICAgaW50IGhhc2ggPSA0MTsNCiAgICAgIGhhc2ggPSAoMTkgKiBoYXNoKSArIGdldERlc2NyaXB0b3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgUkVRVUVTVElEX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldFJlcXVlc3RJRCgpLmhhc2hDb2RlKCk7DQogICAgICBpZiAoZ2V0TWVzc2FnZXNDb3VudCgpID4gMCkgew0KICAgICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBNRVNTQUdFU19GSUVMRF9OVU1CRVI7DQogICAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldE1lc3NhZ2VzTGlzdCgpLmhhc2hDb2RlKCk7DQogICAgICB9DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBNRVNTQUdFU1JFQ0VJVkVEX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldE1lc3NhZ2VzUmVjZWl2ZWQoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIE1FU1NBR0VTRVhQSVJFRF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRNZXNzYWdlc0V4cGlyZWQoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIElTUEVBS19GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBjb20uZ29vZ2xlLnByb3RvYnVmLkludGVybmFsLmhhc2hCb29sZWFuKA0KICAgICAgICAgIGdldElzUGVhaygpKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIElTRVJST1JfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5oYXNoQm9vbGVhbigNCiAgICAgICAgICBnZXRJc0Vycm9yKCkpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgRVJST1JfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0RXJyb3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgyOSAqIGhhc2gpICsgdW5rbm93bkZpZWxkcy5oYXNoQ29kZSgpOw0KICAgICAgbWVtb2l6ZWRIYXNoQ29kZSA9IGhhc2g7DQogICAgICByZXR1cm4gaGFzaDsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZUZyb20oDQogICAgICAgIGphdmEubmlvLkJ5dGVCdWZmZXIgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZUZyb20oDQogICAgICAgIGphdmEubmlvLkJ5dGVCdWZmZXIgZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHBhcnNlRnJvbShieXRlW10gZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZUZyb20oDQogICAgICAgIGJ5dGVbXSBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcGFyc2VGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcGFyc2VEZWxpbWl0ZWRGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZURlbGltaXRlZFdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcGFyc2VEZWxpbWl0ZWRGcm9tKA0KICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBCdWlsZGVyIG5ld0J1aWxkZXJGb3JUeXBlKCkgeyByZXR1cm4gbmV3QnVpbGRlcigpOyB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRS50b0J1aWxkZXIoKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHByb3RvdHlwZSkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCkubWVyZ2VGcm9tKHByb3RvdHlwZSk7DQogICAgfQ0KICAgIHB1YmxpYyBCdWlsZGVyIHRvQnVpbGRlcigpIHsNCiAgICAgIHJldHVybiB0aGlzID09IERFRkFVTFRfSU5TVEFOQ0UNCiAgICAgICAgICA/IG5ldyBCdWlsZGVyKCkgOiBuZXcgQnVpbGRlcigpLm1lcmdlRnJvbSh0aGlzKTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHJvdGVjdGVkIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXJQYXJlbnQgcGFyZW50KSB7DQogICAgICBCdWlsZGVyIGJ1aWxkZXIgPSBuZXcgQnVpbGRlcihwYXJlbnQpOw0KICAgICAgcmV0dXJuIGJ1aWxkZXI7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlfQ0KICAgICAqLw0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgY2xhc3MgQnVpbGRlciBleHRlbmRzDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8QnVpbGRlcj4gaW1wbGVtZW50cw0KICAgICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoYnVpbGRlcl9pbXBsZW1lbnRzOmt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlKQ0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2VPckJ1aWxkZXIgew0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1JlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgcHJvdGVjdGVkIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICAgIGludGVybmFsR2V0RmllbGRBY2Nlc3NvclRhYmxlKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1JlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZS5CdWlsZGVyLmNsYXNzKTsNCiAgICAgIH0NCg0KICAgICAgLy8gQ29uc3RydWN0IHVzaW5nIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZS5uZXdCdWlsZGVyKCkNCiAgICAgIHByaXZhdGUgQnVpbGRlcigpIHsNCiAgICAgICAgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIEJ1aWxkZXIoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlclBhcmVudCBwYXJlbnQpIHsNCiAgICAgICAgc3VwZXIocGFyZW50KTsNCiAgICAgICAgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpOw0KICAgICAgfQ0KICAgICAgcHJpdmF0ZSB2b2lkIG1heWJlRm9yY2VCdWlsZGVySW5pdGlhbGl6YXRpb24oKSB7DQogICAgICAgIGlmIChjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgICAgICAgIC5hbHdheXNVc2VGaWVsZEJ1aWxkZXJzKSB7DQogICAgICAgICAgZ2V0TWVzc2FnZXNGaWVsZEJ1aWxkZXIoKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXIoKSB7DQogICAgICAgIHN1cGVyLmNsZWFyKCk7DQogICAgICAgIHJlcXVlc3RJRF8gPSAiIjsNCg0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgbWVzc2FnZXNfID0gamF2YS51dGlsLkNvbGxlY3Rpb25zLmVtcHR5TGlzdCgpOw0KICAgICAgICAgIGJpdEZpZWxkMF8gPSAoYml0RmllbGQwXyAmIH4weDAwMDAwMDAyKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBtZXNzYWdlc0J1aWxkZXJfLmNsZWFyKCk7DQogICAgICAgIH0NCiAgICAgICAgbWVzc2FnZXNSZWNlaXZlZF8gPSAwOw0KDQogICAgICAgIG1lc3NhZ2VzRXhwaXJlZF8gPSAwOw0KDQogICAgICAgIGlzUGVha18gPSBmYWxzZTsNCg0KICAgICAgICBpc0Vycm9yXyA9IGZhbHNlOw0KDQogICAgICAgIGVycm9yXyA9ICIiOw0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvckZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZV9kZXNjcmlwdG9yOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlIGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UuZ2V0RGVmYXVsdEluc3RhbmNlKCk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgYnVpbGQoKSB7DQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZSByZXN1bHQgPSBidWlsZFBhcnRpYWwoKTsNCiAgICAgICAgaWYgKCFyZXN1bHQuaXNJbml0aWFsaXplZCgpKSB7DQogICAgICAgICAgdGhyb3cgbmV3VW5pbml0aWFsaXplZE1lc3NhZ2VFeGNlcHRpb24ocmVzdWx0KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlIGJ1aWxkUGFydGlhbCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHJlc3VsdCA9IG5ldyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UodGhpcyk7DQogICAgICAgIGludCBmcm9tX2JpdEZpZWxkMF8gPSBiaXRGaWVsZDBfOw0KICAgICAgICBpbnQgdG9fYml0RmllbGQwXyA9IDA7DQogICAgICAgIHJlc3VsdC5yZXF1ZXN0SURfID0gcmVxdWVzdElEXzsNCiAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGlmICgoKGJpdEZpZWxkMF8gJiAweDAwMDAwMDAyKSA9PSAweDAwMDAwMDAyKSkgew0KICAgICAgICAgICAgbWVzc2FnZXNfID0gamF2YS51dGlsLkNvbGxlY3Rpb25zLnVubW9kaWZpYWJsZUxpc3QobWVzc2FnZXNfKTsNCiAgICAgICAgICAgIGJpdEZpZWxkMF8gPSAoYml0RmllbGQwXyAmIH4weDAwMDAwMDAyKTsNCiAgICAgICAgICB9DQogICAgICAgICAgcmVzdWx0Lm1lc3NhZ2VzXyA9IG1lc3NhZ2VzXzsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXN1bHQubWVzc2FnZXNfID0gbWVzc2FnZXNCdWlsZGVyXy5idWlsZCgpOw0KICAgICAgICB9DQogICAgICAgIHJlc3VsdC5tZXNzYWdlc1JlY2VpdmVkXyA9IG1lc3NhZ2VzUmVjZWl2ZWRfOw0KICAgICAgICByZXN1bHQubWVzc2FnZXNFeHBpcmVkXyA9IG1lc3NhZ2VzRXhwaXJlZF87DQogICAgICAgIHJlc3VsdC5pc1BlYWtfID0gaXNQZWFrXzsNCiAgICAgICAgcmVzdWx0LmlzRXJyb3JfID0gaXNFcnJvcl87DQogICAgICAgIHJlc3VsdC5lcnJvcl8gPSBlcnJvcl87DQogICAgICAgIHJlc3VsdC5iaXRGaWVsZDBfID0gdG9fYml0RmllbGQwXzsNCiAgICAgICAgb25CdWlsdCgpOw0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBjbG9uZSgpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbG9uZSgpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJGaWVsZChmaWVsZCk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck9uZW9mKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuT25lb2ZEZXNjcmlwdG9yIG9uZW9mKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJPbmVvZihvbmVvZik7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGludCBpbmRleCwgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldFJlcGVhdGVkRmllbGQoZmllbGQsIGluZGV4LCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBhZGRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5hZGRSZXBlYXRlZEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oY29tLmdvb2dsZS5wcm90b2J1Zi5NZXNzYWdlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZSkgew0KICAgICAgICAgIHJldHVybiBtZXJnZUZyb20oKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZSlvdGhlcik7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgc3VwZXIubWVyZ2VGcm9tKG90aGVyKTsNCiAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfQ0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciA9PSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UuZ2V0RGVmYXVsdEluc3RhbmNlKCkpIHJldHVybiB0aGlzOw0KICAgICAgICBpZiAoIW90aGVyLmdldFJlcXVlc3RJRCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIHJlcXVlc3RJRF8gPSBvdGhlci5yZXF1ZXN0SURfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmIChtZXNzYWdlc0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBpZiAoIW90aGVyLm1lc3NhZ2VzXy5pc0VtcHR5KCkpIHsNCiAgICAgICAgICAgIGlmIChtZXNzYWdlc18uaXNFbXB0eSgpKSB7DQogICAgICAgICAgICAgIG1lc3NhZ2VzXyA9IG90aGVyLm1lc3NhZ2VzXzsNCiAgICAgICAgICAgICAgYml0RmllbGQwXyA9IChiaXRGaWVsZDBfICYgfjB4MDAwMDAwMDIpOw0KICAgICAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICAgICAgZW5zdXJlTWVzc2FnZXNJc011dGFibGUoKTsNCiAgICAgICAgICAgICAgbWVzc2FnZXNfLmFkZEFsbChvdGhlci5tZXNzYWdlc18pOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgICAgfQ0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIGlmICghb3RoZXIubWVzc2FnZXNfLmlzRW1wdHkoKSkgew0KICAgICAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8uaXNFbXB0eSgpKSB7DQogICAgICAgICAgICAgIG1lc3NhZ2VzQnVpbGRlcl8uZGlzcG9zZSgpOw0KICAgICAgICAgICAgICBtZXNzYWdlc0J1aWxkZXJfID0gbnVsbDsNCiAgICAgICAgICAgICAgbWVzc2FnZXNfID0gb3RoZXIubWVzc2FnZXNfOw0KICAgICAgICAgICAgICBiaXRGaWVsZDBfID0gKGJpdEZpZWxkMF8gJiB+MHgwMDAwMDAwMik7DQogICAgICAgICAgICAgIG1lc3NhZ2VzQnVpbGRlcl8gPSANCiAgICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5hbHdheXNVc2VGaWVsZEJ1aWxkZXJzID8NCiAgICAgICAgICAgICAgICAgICBnZXRNZXNzYWdlc0ZpZWxkQnVpbGRlcigpIDogbnVsbDsNCiAgICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICAgIG1lc3NhZ2VzQnVpbGRlcl8uYWRkQWxsTWVzc2FnZXMob3RoZXIubWVzc2FnZXNfKTsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmdldE1lc3NhZ2VzUmVjZWl2ZWQoKSAhPSAwKSB7DQogICAgICAgICAgc2V0TWVzc2FnZXNSZWNlaXZlZChvdGhlci5nZXRNZXNzYWdlc1JlY2VpdmVkKCkpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRNZXNzYWdlc0V4cGlyZWQoKSAhPSAwKSB7DQogICAgICAgICAgc2V0TWVzc2FnZXNFeHBpcmVkKG90aGVyLmdldE1lc3NhZ2VzRXhwaXJlZCgpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0SXNQZWFrKCkgIT0gZmFsc2UpIHsNCiAgICAgICAgICBzZXRJc1BlYWsob3RoZXIuZ2V0SXNQZWFrKCkpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRJc0Vycm9yKCkgIT0gZmFsc2UpIHsNCiAgICAgICAgICBzZXRJc0Vycm9yKG90aGVyLmdldElzRXJyb3IoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRFcnJvcigpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIGVycm9yXyA9IG90aGVyLmVycm9yXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLm1lcmdlVW5rbm93bkZpZWxkcyhvdGhlci51bmtub3duRmllbGRzKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgZmluYWwgYm9vbGVhbiBpc0luaXRpYWxpemVkKCkgew0KICAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZWRNZXNzYWdlID0gbnVsbDsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gUEFSU0VSLnBhcnNlUGFydGlhbEZyb20oaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlKSBlLmdldFVuZmluaXNoZWRNZXNzYWdlKCk7DQogICAgICAgICAgdGhyb3cgZS51bndyYXBJT0V4Y2VwdGlvbigpOw0KICAgICAgICB9IGZpbmFsbHkgew0KICAgICAgICAgIGlmIChwYXJzZWRNZXNzYWdlICE9IG51bGwpIHsNCiAgICAgICAgICAgIG1lcmdlRnJvbShwYXJzZWRNZXNzYWdlKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICBwcml2YXRlIGludCBiaXRGaWVsZDBfOw0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgcmVxdWVzdElEXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFJlcXVlc3RJRCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXF1ZXN0SURfOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICByZXF1ZXN0SURfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRSZXF1ZXN0SURCeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXF1ZXN0SURfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIHJlcXVlc3RJRF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXF1ZXN0SUQoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICByZXF1ZXN0SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhclJlcXVlc3RJRCgpIHsNCiAgICAgICAgDQogICAgICAgIHJlcXVlc3RJRF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRSZXF1ZXN0SUQoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlcXVlc3RJREJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICByZXF1ZXN0SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBqYXZhLnV0aWwuTGlzdDxpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZT4gbWVzc2FnZXNfID0NCiAgICAgICAgamF2YS51dGlsLkNvbGxlY3Rpb25zLmVtcHR5TGlzdCgpOw0KICAgICAgcHJpdmF0ZSB2b2lkIGVuc3VyZU1lc3NhZ2VzSXNNdXRhYmxlKCkgew0KICAgICAgICBpZiAoISgoYml0RmllbGQwXyAmIDB4MDAwMDAwMDIpID09IDB4MDAwMDAwMDIpKSB7DQogICAgICAgICAgbWVzc2FnZXNfID0gbmV3IGphdmEudXRpbC5BcnJheUxpc3Q8aW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2U+KG1lc3NhZ2VzXyk7DQogICAgICAgICAgYml0RmllbGQwXyB8PSAweDAwMDAwMDAyOw0KICAgICAgICAgfQ0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuUmVwZWF0ZWRGaWVsZEJ1aWxkZXJWMzwNCiAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlciwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VPckJ1aWxkZXI+IG1lc3NhZ2VzQnVpbGRlcl87DQoNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEudXRpbC5MaXN0PGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlPiBnZXRNZXNzYWdlc0xpc3QoKSB7DQogICAgICAgIGlmIChtZXNzYWdlc0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICByZXR1cm4gamF2YS51dGlsLkNvbGxlY3Rpb25zLnVubW9kaWZpYWJsZUxpc3QobWVzc2FnZXNfKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gbWVzc2FnZXNCdWlsZGVyXy5nZXRNZXNzYWdlTGlzdCgpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpbnQgZ2V0TWVzc2FnZXNDb3VudCgpIHsNCiAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIHJldHVybiBtZXNzYWdlc18uc2l6ZSgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiBtZXNzYWdlc0J1aWxkZXJfLmdldENvdW50KCk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlIGdldE1lc3NhZ2VzKGludCBpbmRleCkgew0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgcmV0dXJuIG1lc3NhZ2VzXy5nZXQoaW5kZXgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiBtZXNzYWdlc0J1aWxkZXJfLmdldE1lc3NhZ2UoaW5kZXgpOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldE1lc3NhZ2VzKA0KICAgICAgICAgIGludCBpbmRleCwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgdmFsdWUpIHsNCiAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgICAgICAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgICAgICAgICB9DQogICAgICAgICAgZW5zdXJlTWVzc2FnZXNJc011dGFibGUoKTsNCiAgICAgICAgICBtZXNzYWdlc18uc2V0KGluZGV4LCB2YWx1ZSk7DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgbWVzc2FnZXNCdWlsZGVyXy5zZXRNZXNzYWdlKGluZGV4LCB2YWx1ZSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldE1lc3NhZ2VzKA0KICAgICAgICAgIGludCBpbmRleCwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlciBidWlsZGVyRm9yVmFsdWUpIHsNCiAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGVuc3VyZU1lc3NhZ2VzSXNNdXRhYmxlKCk7DQogICAgICAgICAgbWVzc2FnZXNfLnNldChpbmRleCwgYnVpbGRlckZvclZhbHVlLmJ1aWxkKCkpOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG1lc3NhZ2VzQnVpbGRlcl8uc2V0TWVzc2FnZShpbmRleCwgYnVpbGRlckZvclZhbHVlLmJ1aWxkKCkpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBhZGRNZXNzYWdlcyhpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSB2YWx1ZSkgew0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICAgICAgICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBlbnN1cmVNZXNzYWdlc0lzTXV0YWJsZSgpOw0KICAgICAgICAgIG1lc3NhZ2VzXy5hZGQodmFsdWUpOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG1lc3NhZ2VzQnVpbGRlcl8uYWRkTWVzc2FnZSh2YWx1ZSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGFkZE1lc3NhZ2VzKA0KICAgICAgICAgIGludCBpbmRleCwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgdmFsdWUpIHsNCiAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgICAgICAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgICAgICAgICB9DQogICAgICAgICAgZW5zdXJlTWVzc2FnZXNJc011dGFibGUoKTsNCiAgICAgICAgICBtZXNzYWdlc18uYWRkKGluZGV4LCB2YWx1ZSk7DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgbWVzc2FnZXNCdWlsZGVyXy5hZGRNZXNzYWdlKGluZGV4LCB2YWx1ZSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGFkZE1lc3NhZ2VzKA0KICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLkJ1aWxkZXIgYnVpbGRlckZvclZhbHVlKSB7DQogICAgICAgIGlmIChtZXNzYWdlc0J1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBlbnN1cmVNZXNzYWdlc0lzTXV0YWJsZSgpOw0KICAgICAgICAgIG1lc3NhZ2VzXy5hZGQoYnVpbGRlckZvclZhbHVlLmJ1aWxkKCkpOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG1lc3NhZ2VzQnVpbGRlcl8uYWRkTWVzc2FnZShidWlsZGVyRm9yVmFsdWUuYnVpbGQoKSk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGFkZE1lc3NhZ2VzKA0KICAgICAgICAgIGludCBpbmRleCwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlciBidWlsZGVyRm9yVmFsdWUpIHsNCiAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGVuc3VyZU1lc3NhZ2VzSXNNdXRhYmxlKCk7DQogICAgICAgICAgbWVzc2FnZXNfLmFkZChpbmRleCwgYnVpbGRlckZvclZhbHVlLmJ1aWxkKCkpOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG1lc3NhZ2VzQnVpbGRlcl8uYWRkTWVzc2FnZShpbmRleCwgYnVpbGRlckZvclZhbHVlLmJ1aWxkKCkpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBhZGRBbGxNZXNzYWdlcygNCiAgICAgICAgICBqYXZhLmxhbmcuSXRlcmFibGU8PyBleHRlbmRzIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlPiB2YWx1ZXMpIHsNCiAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIGVuc3VyZU1lc3NhZ2VzSXNNdXRhYmxlKCk7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5BYnN0cmFjdE1lc3NhZ2VMaXRlLkJ1aWxkZXIuYWRkQWxsKA0KICAgICAgICAgICAgICB2YWx1ZXMsIG1lc3NhZ2VzXyk7DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgbWVzc2FnZXNCdWlsZGVyXy5hZGRBbGxNZXNzYWdlcyh2YWx1ZXMpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck1lc3NhZ2VzKCkgew0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgbWVzc2FnZXNfID0gamF2YS51dGlsLkNvbGxlY3Rpb25zLmVtcHR5TGlzdCgpOw0KICAgICAgICAgIGJpdEZpZWxkMF8gPSAoYml0RmllbGQwXyAmIH4weDAwMDAwMDAyKTsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBtZXNzYWdlc0J1aWxkZXJfLmNsZWFyKCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHJlbW92ZU1lc3NhZ2VzKGludCBpbmRleCkgew0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgZW5zdXJlTWVzc2FnZXNJc011dGFibGUoKTsNCiAgICAgICAgICBtZXNzYWdlc18ucmVtb3ZlKGluZGV4KTsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBtZXNzYWdlc0J1aWxkZXJfLnJlbW92ZShpbmRleCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5CdWlsZGVyIGdldE1lc3NhZ2VzQnVpbGRlcigNCiAgICAgICAgICBpbnQgaW5kZXgpIHsNCiAgICAgICAgcmV0dXJuIGdldE1lc3NhZ2VzRmllbGRCdWlsZGVyKCkuZ2V0QnVpbGRlcihpbmRleCk7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnJlcGVhdGVkIC5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZU9yQnVpbGRlciBnZXRNZXNzYWdlc09yQnVpbGRlcigNCiAgICAgICAgICBpbnQgaW5kZXgpIHsNCiAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIHJldHVybiBtZXNzYWdlc18uZ2V0KGluZGV4KTsgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIG1lc3NhZ2VzQnVpbGRlcl8uZ2V0TWVzc2FnZU9yQnVpbGRlcihpbmRleCk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEudXRpbC5MaXN0PD8gZXh0ZW5kcyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZU9yQnVpbGRlcj4gDQogICAgICAgICAgIGdldE1lc3NhZ2VzT3JCdWlsZGVyTGlzdCgpIHsNCiAgICAgICAgaWYgKG1lc3NhZ2VzQnVpbGRlcl8gIT0gbnVsbCkgew0KICAgICAgICAgIHJldHVybiBtZXNzYWdlc0J1aWxkZXJfLmdldE1lc3NhZ2VPckJ1aWxkZXJMaXN0KCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIGphdmEudXRpbC5Db2xsZWN0aW9ucy51bm1vZGlmaWFibGVMaXN0KG1lc3NhZ2VzXyk7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+cmVwZWF0ZWQgLmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLkJ1aWxkZXIgYWRkTWVzc2FnZXNCdWlsZGVyKCkgew0KICAgICAgICByZXR1cm4gZ2V0TWVzc2FnZXNGaWVsZEJ1aWxkZXIoKS5hZGRCdWlsZGVyKA0KICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuZ2V0RGVmYXVsdEluc3RhbmNlKCkpOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlciBhZGRNZXNzYWdlc0J1aWxkZXIoDQogICAgICAgICAgaW50IGluZGV4KSB7DQogICAgICAgIHJldHVybiBnZXRNZXNzYWdlc0ZpZWxkQnVpbGRlcigpLmFkZEJ1aWxkZXIoDQogICAgICAgICAgICBpbmRleCwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuZ2V0RGVmYXVsdEluc3RhbmNlKCkpOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5yZXBlYXRlZCAua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlcyA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS51dGlsLkxpc3Q8aW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlcj4gDQogICAgICAgICAgIGdldE1lc3NhZ2VzQnVpbGRlckxpc3QoKSB7DQogICAgICAgIHJldHVybiBnZXRNZXNzYWdlc0ZpZWxkQnVpbGRlcigpLmdldEJ1aWxkZXJMaXN0KCk7DQogICAgICB9DQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuUmVwZWF0ZWRGaWVsZEJ1aWxkZXJWMzwNCiAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlciwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VPckJ1aWxkZXI+IA0KICAgICAgICAgIGdldE1lc3NhZ2VzRmllbGRCdWlsZGVyKCkgew0KICAgICAgICBpZiAobWVzc2FnZXNCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgbWVzc2FnZXNCdWlsZGVyXyA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLlJlcGVhdGVkRmllbGRCdWlsZGVyVjM8DQogICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5CdWlsZGVyLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZU9yQnVpbGRlcj4oDQogICAgICAgICAgICAgICAgICBtZXNzYWdlc18sDQogICAgICAgICAgICAgICAgICAoKGJpdEZpZWxkMF8gJiAweDAwMDAwMDAyKSA9PSAweDAwMDAwMDAyKSwNCiAgICAgICAgICAgICAgICAgIGdldFBhcmVudEZvckNoaWxkcmVuKCksDQogICAgICAgICAgICAgICAgICBpc0NsZWFuKCkpOw0KICAgICAgICAgIG1lc3NhZ2VzXyA9IG51bGw7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIG1lc3NhZ2VzQnVpbGRlcl87DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgaW50IG1lc3NhZ2VzUmVjZWl2ZWRfIDsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50MzIgTWVzc2FnZXNSZWNlaXZlZCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW50IGdldE1lc3NhZ2VzUmVjZWl2ZWQoKSB7DQogICAgICAgIHJldHVybiBtZXNzYWdlc1JlY2VpdmVkXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50MzIgTWVzc2FnZXNSZWNlaXZlZCA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRNZXNzYWdlc1JlY2VpdmVkKGludCB2YWx1ZSkgew0KICAgICAgICANCiAgICAgICAgbWVzc2FnZXNSZWNlaXZlZF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQzMiBNZXNzYWdlc1JlY2VpdmVkID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyTWVzc2FnZXNSZWNlaXZlZCgpIHsNCiAgICAgICAgDQogICAgICAgIG1lc3NhZ2VzUmVjZWl2ZWRfID0gMDsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGludCBtZXNzYWdlc0V4cGlyZWRfIDsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50MzIgTWVzc2FnZXNFeHBpcmVkID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpbnQgZ2V0TWVzc2FnZXNFeHBpcmVkKCkgew0KICAgICAgICByZXR1cm4gbWVzc2FnZXNFeHBpcmVkXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50MzIgTWVzc2FnZXNFeHBpcmVkID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldE1lc3NhZ2VzRXhwaXJlZChpbnQgdmFsdWUpIHsNCiAgICAgICAgDQogICAgICAgIG1lc3NhZ2VzRXhwaXJlZF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQzMiBNZXNzYWdlc0V4cGlyZWQgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJNZXNzYWdlc0V4cGlyZWQoKSB7DQogICAgICAgIA0KICAgICAgICBtZXNzYWdlc0V4cGlyZWRfID0gMDsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGJvb2xlYW4gaXNQZWFrXyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJvb2wgSXNQZWFrID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBib29sZWFuIGdldElzUGVhaygpIHsNCiAgICAgICAgcmV0dXJuIGlzUGVha187DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJvb2wgSXNQZWFrID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldElzUGVhayhib29sZWFuIHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICBpc1BlYWtfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ym9vbCBJc1BlYWsgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJJc1BlYWsoKSB7DQogICAgICAgIA0KICAgICAgICBpc1BlYWtfID0gZmFsc2U7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBib29sZWFuIGlzRXJyb3JfIDsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ym9vbCBJc0Vycm9yID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBib29sZWFuIGdldElzRXJyb3IoKSB7DQogICAgICAgIHJldHVybiBpc0Vycm9yXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ym9vbCBJc0Vycm9yID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldElzRXJyb3IoYm9vbGVhbiB2YWx1ZSkgew0KICAgICAgICANCiAgICAgICAgaXNFcnJvcl8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIElzRXJyb3IgPSA2OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJJc0Vycm9yKCkgew0KICAgICAgICANCiAgICAgICAgaXNFcnJvcl8gPSBmYWxzZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgZXJyb3JfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDc7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRFcnJvcigpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBlcnJvcl87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIGVycm9yXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRFcnJvckJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGVycm9yXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBlcnJvcl8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEVycm9yKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgZXJyb3JfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyRXJyb3IoKSB7DQogICAgICAgIA0KICAgICAgICBlcnJvcl8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRFcnJvcigpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDc7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRFcnJvckJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBlcnJvcl8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgcHVibGljIGZpbmFsIEJ1aWxkZXIgc2V0VW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5zZXRVbmtub3duRmllbGRzUHJvdG8zKHVua25vd25GaWVsZHMpOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBtZXJnZVVua25vd25GaWVsZHMoDQogICAgICAgICAgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQgdW5rbm93bkZpZWxkcykgew0KICAgICAgICByZXR1cm4gc3VwZXIubWVyZ2VVbmtub3duRmllbGRzKHVua25vd25GaWVsZHMpOw0KICAgICAgfQ0KDQoNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChidWlsZGVyX3Njb3BlOmt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlKQ0KICAgIH0NCg0KICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChjbGFzc19zY29wZTprdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZSkNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgREVGQVVMVF9JTlNUQU5DRTsNCiAgICBzdGF0aWMgew0KICAgICAgREVGQVVMVF9JTlNUQU5DRSA9IG5ldyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UoKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBnZXREZWZhdWx0SW5zdGFuY2UoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRTsNCiAgICB9DQoNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxSZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlPg0KICAgICAgICBQQVJTRVIgPSBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5BYnN0cmFjdFBhcnNlcjxSZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlPigpIHsNCiAgICAgIHB1YmxpYyBSZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHBhcnNlUGFydGlhbEZyb20oDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICAgIHJldHVybiBuZXcgUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZShpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgfQ0KICAgIH07DQoNCiAgICBwdWJsaWMgc3RhdGljIGNvbS5nb29nbGUucHJvdG9idWYuUGFyc2VyPFJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2U+IHBhcnNlcigpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxSZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlPiBnZXRQYXJzZXJGb3JUeXBlKCkgew0KICAgICAgcmV0dXJuIFBBUlNFUjsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlIGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRTsNCiAgICB9DQoNCiAgfQ0KDQogIHB1YmxpYyBpbnRlcmZhY2UgQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3RPckJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGludGVyZmFjZV9leHRlbmRzOmt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdCkNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZU9yQnVpbGRlciB7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRSZXF1ZXN0SUQoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldFJlcXVlc3RJREJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldENsaWVudElEKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldENsaWVudElEQnl0ZXMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRDaGFubmVsKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0Q2hhbm5lbEJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQzMiBXYWl0VGltZVNlY29uZHMgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBpbnQgZ2V0V2FpdFRpbWVTZWNvbmRzKCk7DQogIH0NCiAgLyoqDQogICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdH0NCiAgICovDQogIHB1YmxpYyAgc3RhdGljIGZpbmFsIGNsYXNzIEFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0IGV4dGVuZHMNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzIGltcGxlbWVudHMNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChtZXNzYWdlX2ltcGxlbWVudHM6a3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0KQ0KICAgICAgQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3RPckJ1aWxkZXIgew0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBsb25nIHNlcmlhbFZlcnNpb25VSUQgPSAwTDsNCiAgICAvLyBVc2UgQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QubmV3QnVpbGRlcigpIHRvIGNvbnN0cnVjdC4NCiAgICBwcml2YXRlIEFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0KGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8Pz4gYnVpbGRlcikgew0KICAgICAgc3VwZXIoYnVpbGRlcik7DQogICAgfQ0KICAgIHByaXZhdGUgQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QoKSB7DQogICAgICByZXF1ZXN0SURfID0gIiI7DQogICAgICBjbGllbnRJRF8gPSAiIjsNCiAgICAgIGNoYW5uZWxfID0gIiI7DQogICAgICB3YWl0VGltZVNlY29uZHNfID0gMDsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0DQogICAgZ2V0VW5rbm93bkZpZWxkcygpIHsNCiAgICAgIHJldHVybiB0aGlzLnVua25vd25GaWVsZHM7DQogICAgfQ0KICAgIHByaXZhdGUgQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICB0aGlzKCk7DQogICAgICBpZiAoZXh0ZW5zaW9uUmVnaXN0cnkgPT0gbnVsbCkgew0KICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogICAgICB9DQogICAgICBpbnQgbXV0YWJsZV9iaXRGaWVsZDBfID0gMDsNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0LkJ1aWxkZXIgdW5rbm93bkZpZWxkcyA9DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQubmV3QnVpbGRlcigpOw0KICAgICAgdHJ5IHsNCiAgICAgICAgYm9vbGVhbiBkb25lID0gZmFsc2U7DQogICAgICAgIHdoaWxlICghZG9uZSkgew0KICAgICAgICAgIGludCB0YWcgPSBpbnB1dC5yZWFkVGFnKCk7DQogICAgICAgICAgc3dpdGNoICh0YWcpIHsNCiAgICAgICAgICAgIGNhc2UgMDoNCiAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgZGVmYXVsdDogew0KICAgICAgICAgICAgICBpZiAoIXBhcnNlVW5rbm93bkZpZWxkUHJvdG8zKA0KICAgICAgICAgICAgICAgICAgaW5wdXQsIHVua25vd25GaWVsZHMsIGV4dGVuc2lvblJlZ2lzdHJ5LCB0YWcpKSB7DQogICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDEwOiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIHJlcXVlc3RJRF8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMTg6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgY2xpZW50SURfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDI2OiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIGNoYW5uZWxfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDMyOiB7DQoNCiAgICAgICAgICAgICAgd2FpdFRpbWVTZWNvbmRzXyA9IGlucHV0LnJlYWRJbnQzMigpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgIH0gY2F0Y2ggKGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgdGhyb3cgZS5zZXRVbmZpbmlzaGVkTWVzc2FnZSh0aGlzKTsNCiAgICAgIH0gY2F0Y2ggKGphdmEuaW8uSU9FeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24oDQogICAgICAgICAgICBlKS5zZXRVbmZpbmlzaGVkTWVzc2FnZSh0aGlzKTsNCiAgICAgIH0gZmluYWxseSB7DQogICAgICAgIHRoaXMudW5rbm93bkZpZWxkcyA9IHVua25vd25GaWVsZHMuYnVpbGQoKTsNCiAgICAgICAgbWFrZUV4dGVuc2lvbnNJbW11dGFibGUoKTsNCiAgICAgIH0NCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgZ2V0RGVzY3JpcHRvcigpIHsNCiAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3RfZGVzY3JpcHRvcjsNCiAgICB9DQoNCiAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgIGludGVybmFsR2V0RmllbGRBY2Nlc3NvclRhYmxlKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdF9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdC5jbGFzcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdC5CdWlsZGVyLmNsYXNzKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBSRVFVRVNUSURfRklFTERfTlVNQkVSID0gMTsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgcmVxdWVzdElEXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0UmVxdWVzdElEKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXF1ZXN0SURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIHJlcXVlc3RJRF8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0UmVxdWVzdElEQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHJlcXVlc3RJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgcmVxdWVzdElEXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBDTElFTlRJRF9GSUVMRF9OVU1CRVIgPSAyOw0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBjbGllbnRJRF87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2xpZW50SUQoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNsaWVudElEXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBjbGllbnRJRF8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRDbGllbnRJREJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjbGllbnRJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgY2xpZW50SURfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENIQU5ORUxfRklFTERfTlVNQkVSID0gMzsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgY2hhbm5lbF87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDaGFubmVsKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBjaGFubmVsXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0Q2hhbm5lbEJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICBjaGFubmVsXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBXQUlUVElNRVNFQ09ORFNfRklFTERfTlVNQkVSID0gNDsNCiAgICBwcml2YXRlIGludCB3YWl0VGltZVNlY29uZHNfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDMyIFdhaXRUaW1lU2Vjb25kcyA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpbnQgZ2V0V2FpdFRpbWVTZWNvbmRzKCkgew0KICAgICAgcmV0dXJuIHdhaXRUaW1lU2Vjb25kc187DQogICAgfQ0KDQogICAgcHJpdmF0ZSBieXRlIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IC0xOw0KICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICBieXRlIGlzSW5pdGlhbGl6ZWQgPSBtZW1vaXplZElzSW5pdGlhbGl6ZWQ7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAxKSByZXR1cm4gdHJ1ZTsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDApIHJldHVybiBmYWxzZTsNCg0KICAgICAgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gMTsNCiAgICAgIHJldHVybiB0cnVlOw0KICAgIH0NCg0KICAgIHB1YmxpYyB2b2lkIHdyaXRlVG8oY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbSBvdXRwdXQpDQogICAgICAgICAgICAgICAgICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICBpZiAoIWdldFJlcXVlc3RJREJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLndyaXRlU3RyaW5nKG91dHB1dCwgMSwgcmVxdWVzdElEXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldENsaWVudElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAyLCBjbGllbnRJRF8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRDaGFubmVsQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAzLCBjaGFubmVsXyk7DQogICAgICB9DQogICAgICBpZiAod2FpdFRpbWVTZWNvbmRzXyAhPSAwKSB7DQogICAgICAgIG91dHB1dC53cml0ZUludDMyKDQsIHdhaXRUaW1lU2Vjb25kc18pOw0KICAgICAgfQ0KICAgICAgdW5rbm93bkZpZWxkcy53cml0ZVRvKG91dHB1dCk7DQogICAgfQ0KDQogICAgcHVibGljIGludCBnZXRTZXJpYWxpemVkU2l6ZSgpIHsNCiAgICAgIGludCBzaXplID0gbWVtb2l6ZWRTaXplOw0KICAgICAgaWYgKHNpemUgIT0gLTEpIHJldHVybiBzaXplOw0KDQogICAgICBzaXplID0gMDsNCiAgICAgIGlmICghZ2V0UmVxdWVzdElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSgxLCByZXF1ZXN0SURfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0Q2xpZW50SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDIsIGNsaWVudElEXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldENoYW5uZWxCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDMsIGNoYW5uZWxfKTsNCiAgICAgIH0NCiAgICAgIGlmICh3YWl0VGltZVNlY29uZHNfICE9IDApIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVJbnQzMlNpemUoNCwgd2FpdFRpbWVTZWNvbmRzXyk7DQogICAgICB9DQogICAgICBzaXplICs9IHVua25vd25GaWVsZHMuZ2V0U2VyaWFsaXplZFNpemUoKTsNCiAgICAgIG1lbW9pemVkU2l6ZSA9IHNpemU7DQogICAgICByZXR1cm4gc2l6ZTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGJvb2xlYW4gZXF1YWxzKGZpbmFsIGphdmEubGFuZy5PYmplY3Qgb2JqKSB7DQogICAgICBpZiAob2JqID09IHRoaXMpIHsNCiAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIGlmICghKG9iaiBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QpKSB7DQogICAgICAgIHJldHVybiBzdXBlci5lcXVhbHMob2JqKTsNCiAgICAgIH0NCiAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3Qgb3RoZXIgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdCkgb2JqOw0KDQogICAgICBib29sZWFuIHJlc3VsdCA9IHRydWU7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0UmVxdWVzdElEKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldFJlcXVlc3RJRCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRDbGllbnRJRCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRDbGllbnRJRCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRDaGFubmVsKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldENoYW5uZWwoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldFdhaXRUaW1lU2Vjb25kcygpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0V2FpdFRpbWVTZWNvbmRzKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIHVua25vd25GaWVsZHMuZXF1YWxzKG90aGVyLnVua25vd25GaWVsZHMpOw0KICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGludCBoYXNoQ29kZSgpIHsNCiAgICAgIGlmIChtZW1vaXplZEhhc2hDb2RlICE9IDApIHsNCiAgICAgICAgcmV0dXJuIG1lbW9pemVkSGFzaENvZGU7DQogICAgICB9DQogICAgICBpbnQgaGFzaCA9IDQxOw0KICAgICAgaGFzaCA9ICgxOSAqIGhhc2gpICsgZ2V0RGVzY3JpcHRvcigpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBSRVFVRVNUSURfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0UmVxdWVzdElEKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIENMSUVOVElEX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldENsaWVudElEKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIENIQU5ORUxfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0Q2hhbm5lbCgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBXQUlUVElNRVNFQ09ORFNfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0V2FpdFRpbWVTZWNvbmRzKCk7DQogICAgICBoYXNoID0gKDI5ICogaGFzaCkgKyB1bmtub3duRmllbGRzLmhhc2hDb2RlKCk7DQogICAgICBtZW1vaXplZEhhc2hDb2RlID0gaGFzaDsNCiAgICAgIHJldHVybiBoYXNoOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZUZyb20oDQogICAgICAgIGphdmEubmlvLkJ5dGVCdWZmZXIgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZUZyb20oYnl0ZVtdIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgYnl0ZVtdIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZURlbGltaXRlZEZyb20oamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VEZWxpbWl0ZWRGcm9tKA0KICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KDQogICAgcHVibGljIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoKSB7IHJldHVybiBuZXdCdWlsZGVyKCk7IH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcigpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFLnRvQnVpbGRlcigpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcihpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHByb3RvdHlwZSkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCkubWVyZ2VGcm9tKHByb3RvdHlwZSk7DQogICAgfQ0KICAgIHB1YmxpYyBCdWlsZGVyIHRvQnVpbGRlcigpIHsNCiAgICAgIHJldHVybiB0aGlzID09IERFRkFVTFRfSU5TVEFOQ0UNCiAgICAgICAgICA/IG5ldyBCdWlsZGVyKCkgOiBuZXcgQnVpbGRlcigpLm1lcmdlRnJvbSh0aGlzKTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHJvdGVjdGVkIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXJQYXJlbnQgcGFyZW50KSB7DQogICAgICBCdWlsZGVyIGJ1aWxkZXIgPSBuZXcgQnVpbGRlcihwYXJlbnQpOw0KICAgICAgcmV0dXJuIGJ1aWxkZXI7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdH0NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNsYXNzIEJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPEJ1aWxkZXI+IGltcGxlbWVudHMNCiAgICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfaW1wbGVtZW50czprdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QpDQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3RPckJ1aWxkZXIgew0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0Fja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0X2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdF9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAgIC5lbnN1cmVGaWVsZEFjY2Vzc29yc0luaXRpYWxpemVkKA0KICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QuQnVpbGRlci5jbGFzcyk7DQogICAgICB9DQoNCiAgICAgIC8vIENvbnN0cnVjdCB1c2luZyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0Lm5ld0J1aWxkZXIoKQ0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKCkgew0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgQnVpbGRlcigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgICBzdXBlcihwYXJlbnQpOw0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQogICAgICBwcml2YXRlIHZvaWQgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpIHsNCiAgICAgICAgaWYgKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgICAgICAgLmFsd2F5c1VzZUZpZWxkQnVpbGRlcnMpIHsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXIoKSB7DQogICAgICAgIHN1cGVyLmNsZWFyKCk7DQogICAgICAgIHJlcXVlc3RJRF8gPSAiIjsNCg0KICAgICAgICBjbGllbnRJRF8gPSAiIjsNCg0KICAgICAgICBjaGFubmVsXyA9ICIiOw0KDQogICAgICAgIHdhaXRUaW1lU2Vjb25kc18gPSAwOw0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvckZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3RfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QuZ2V0RGVmYXVsdEluc3RhbmNlKCk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0IGJ1aWxkKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHJlc3VsdCA9IGJ1aWxkUGFydGlhbCgpOw0KICAgICAgICBpZiAoIXJlc3VsdC5pc0luaXRpYWxpemVkKCkpIHsNCiAgICAgICAgICB0aHJvdyBuZXdVbmluaXRpYWxpemVkTWVzc2FnZUV4Y2VwdGlvbihyZXN1bHQpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiByZXN1bHQ7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0IGJ1aWxkUGFydGlhbCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdCByZXN1bHQgPSBuZXcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdCh0aGlzKTsNCiAgICAgICAgcmVzdWx0LnJlcXVlc3RJRF8gPSByZXF1ZXN0SURfOw0KICAgICAgICByZXN1bHQuY2xpZW50SURfID0gY2xpZW50SURfOw0KICAgICAgICByZXN1bHQuY2hhbm5lbF8gPSBjaGFubmVsXzsNCiAgICAgICAgcmVzdWx0LndhaXRUaW1lU2Vjb25kc18gPSB3YWl0VGltZVNlY29uZHNfOw0KICAgICAgICBvbkJ1aWx0KCk7DQogICAgICAgIHJldHVybiByZXN1bHQ7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsb25lKCkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsb25lKCk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuc2V0RmllbGQoZmllbGQsIHZhbHVlKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyRmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbGVhckZpZWxkKGZpZWxkKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyT25lb2YoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5PbmVvZkRlc2NyaXB0b3Igb25lb2YpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbGVhck9uZW9mKG9uZW9mKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlcGVhdGVkRmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgaW50IGluZGV4LCBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuc2V0UmVwZWF0ZWRGaWVsZChmaWVsZCwgaW5kZXgsIHZhbHVlKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGFkZFJlcGVhdGVkRmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmFkZFJlcGVhdGVkRmllbGQoZmllbGQsIHZhbHVlKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbShjb20uZ29vZ2xlLnByb3RvYnVmLk1lc3NhZ2Ugb3RoZXIpIHsNCiAgICAgICAgaWYgKG90aGVyIGluc3RhbmNlb2YgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdCkgew0KICAgICAgICAgIHJldHVybiBtZXJnZUZyb20oKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3Qpb3RoZXIpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHN1cGVyLm1lcmdlRnJvbShvdGhlcik7DQogICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3Qgb3RoZXIpIHsNCiAgICAgICAgaWYgKG90aGVyID09IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QuZ2V0RGVmYXVsdEluc3RhbmNlKCkpIHJldHVybiB0aGlzOw0KICAgICAgICBpZiAoIW90aGVyLmdldFJlcXVlc3RJRCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIHJlcXVlc3RJRF8gPSBvdGhlci5yZXF1ZXN0SURfOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9DQogICAgICAgIGlmICghb3RoZXIuZ2V0Q2xpZW50SUQoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICBjbGllbnRJRF8gPSBvdGhlci5jbGllbnRJRF87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRDaGFubmVsKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgY2hhbm5lbF8gPSBvdGhlci5jaGFubmVsXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0V2FpdFRpbWVTZWNvbmRzKCkgIT0gMCkgew0KICAgICAgICAgIHNldFdhaXRUaW1lU2Vjb25kcyhvdGhlci5nZXRXYWl0VGltZVNlY29uZHMoKSk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5tZXJnZVVua25vd25GaWVsZHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbSgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlZE1lc3NhZ2UgPSBudWxsOw0KICAgICAgICB0cnkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSBQQVJTRVIucGFyc2VQYXJ0aWFsRnJvbShpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgICB9IGNhdGNoIChjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiBlKSB7DQogICAgICAgICAgcGFyc2VkTWVzc2FnZSA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0KSBlLmdldFVuZmluaXNoZWRNZXNzYWdlKCk7DQogICAgICAgICAgdGhyb3cgZS51bndyYXBJT0V4Y2VwdGlvbigpOw0KICAgICAgICB9IGZpbmFsbHkgew0KICAgICAgICAgIGlmIChwYXJzZWRNZXNzYWdlICE9IG51bGwpIHsNCiAgICAgICAgICAgIG1lcmdlRnJvbShwYXJzZWRNZXNzYWdlKTsNCiAgICAgICAgICB9DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCByZXF1ZXN0SURfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0UmVxdWVzdElEKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHJlcXVlc3RJRF87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIHJlcXVlc3RJRF8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldFJlcXVlc3RJREJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHJlcXVlc3RJRF87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgcmVxdWVzdElEXyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlcXVlc3RJRCgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIHJlcXVlc3RJRF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyUmVxdWVzdElEKCkgew0KICAgICAgICANCiAgICAgICAgcmVxdWVzdElEXyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldFJlcXVlc3RJRCgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UmVxdWVzdElEQnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIHJlcXVlc3RJRF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgY2xpZW50SURfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDbGllbnRJRCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjbGllbnRJRF87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIGNsaWVudElEXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRDbGllbnRJREJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNsaWVudElEXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBjbGllbnRJRF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldENsaWVudElEKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgY2xpZW50SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyQ2xpZW50SUQoKSB7DQogICAgICAgIA0KICAgICAgICBjbGllbnRJRF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRDbGllbnRJRCgpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRDbGllbnRJREJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBjbGllbnRJRF8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgY2hhbm5lbF8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2hhbm5lbCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgY2hhbm5lbF8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRDaGFubmVsQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2hhbm5lbF87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgY2hhbm5lbF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2hhbm5lbCgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIGNoYW5uZWxfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJDaGFubmVsKCkgew0KICAgICAgICANCiAgICAgICAgY2hhbm5lbF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRDaGFubmVsKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2hhbm5lbEJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBjaGFubmVsXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgaW50IHdhaXRUaW1lU2Vjb25kc18gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQzMiBXYWl0VGltZVNlY29uZHMgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGludCBnZXRXYWl0VGltZVNlY29uZHMoKSB7DQogICAgICAgIHJldHVybiB3YWl0VGltZVNlY29uZHNfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5pbnQzMiBXYWl0VGltZVNlY29uZHMgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0V2FpdFRpbWVTZWNvbmRzKGludCB2YWx1ZSkgew0KICAgICAgICANCiAgICAgICAgd2FpdFRpbWVTZWNvbmRzXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIFdhaXRUaW1lU2Vjb25kcyA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhcldhaXRUaW1lU2Vjb25kcygpIHsNCiAgICAgICAgDQogICAgICAgIHdhaXRUaW1lU2Vjb25kc18gPSAwOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBzZXRVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLnNldFVua25vd25GaWVsZHNQcm90bzModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIG1lcmdlVW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5tZXJnZVVua25vd25GaWVsZHModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCg0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfc2NvcGU6a3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0KQ0KICAgIH0NCg0KICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChjbGFzc19zY29wZTprdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QpDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdCBERUZBVUxUX0lOU1RBTkNFOw0KICAgIHN0YXRpYyB7DQogICAgICBERUZBVUxUX0lOU1RBTkNFID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QoKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QgZ2V0RGVmYXVsdEluc3RhbmNlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8QWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3Q+DQogICAgICAgIFBBUlNFUiA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkFic3RyYWN0UGFyc2VyPEFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0PigpIHsNCiAgICAgIHB1YmxpYyBBY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZVBhcnRpYWxGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgICByZXR1cm4gbmV3IEFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0KGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICB9DQogICAgfTsNCg0KICAgIHB1YmxpYyBzdGF0aWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8QWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3Q+IHBhcnNlcigpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxBY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdD4gZ2V0UGFyc2VyRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3QgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFOw0KICAgIH0NCg0KICB9DQoNCiAgcHVibGljIGludGVyZmFjZSBBY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2VPckJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGludGVyZmFjZV9leHRlbmRzOmt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UpDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLk1lc3NhZ2VPckJ1aWxkZXIgew0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0UmVxdWVzdElEKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRSZXF1ZXN0SURCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+dWludDY0IEFmZmVjdGVkTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBsb25nIGdldEFmZmVjdGVkTWVzc2FnZXMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmJvb2wgSXNFcnJvciA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIGJvb2xlYW4gZ2V0SXNFcnJvcigpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNDs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRFcnJvcigpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRFcnJvckJ5dGVzKCk7DQogIH0NCiAgLyoqDQogICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2V9DQogICAqLw0KICBwdWJsaWMgIHN0YXRpYyBmaW5hbCBjbGFzcyBBY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgZXh0ZW5kcw0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMgaW1wbGVtZW50cw0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KG1lc3NhZ2VfaW1wbGVtZW50czprdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlKQ0KICAgICAgQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlT3JCdWlsZGVyIHsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgbG9uZyBzZXJpYWxWZXJzaW9uVUlEID0gMEw7DQogICAgLy8gVXNlIEFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZS5uZXdCdWlsZGVyKCkgdG8gY29uc3RydWN0Lg0KICAgIHByaXZhdGUgQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXI8Pz4gYnVpbGRlcikgew0KICAgICAgc3VwZXIoYnVpbGRlcik7DQogICAgfQ0KICAgIHByaXZhdGUgQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlKCkgew0KICAgICAgcmVxdWVzdElEXyA9ICIiOw0KICAgICAgYWZmZWN0ZWRNZXNzYWdlc18gPSAwTDsNCiAgICAgIGlzRXJyb3JfID0gZmFsc2U7DQogICAgICBlcnJvcl8gPSAiIjsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0DQogICAgZ2V0VW5rbm93bkZpZWxkcygpIHsNCiAgICAgIHJldHVybiB0aGlzLnVua25vd25GaWVsZHM7DQogICAgfQ0KICAgIHByaXZhdGUgQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgdGhpcygpOw0KICAgICAgaWYgKGV4dGVuc2lvblJlZ2lzdHJ5ID09IG51bGwpIHsNCiAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgfQ0KICAgICAgaW50IG11dGFibGVfYml0RmllbGQwXyA9IDA7DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldC5CdWlsZGVyIHVua25vd25GaWVsZHMgPQ0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0Lm5ld0J1aWxkZXIoKTsNCiAgICAgIHRyeSB7DQogICAgICAgIGJvb2xlYW4gZG9uZSA9IGZhbHNlOw0KICAgICAgICB3aGlsZSAoIWRvbmUpIHsNCiAgICAgICAgICBpbnQgdGFnID0gaW5wdXQucmVhZFRhZygpOw0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7DQogICAgICAgICAgICBjYXNlIDA6DQogICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGRlZmF1bHQ6IHsNCiAgICAgICAgICAgICAgaWYgKCFwYXJzZVVua25vd25GaWVsZFByb3RvMygNCiAgICAgICAgICAgICAgICAgIGlucHV0LCB1bmtub3duRmllbGRzLCBleHRlbnNpb25SZWdpc3RyeSwgdGFnKSkgew0KICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAxMDogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICByZXF1ZXN0SURfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDE2OiB7DQoNCiAgICAgICAgICAgICAgYWZmZWN0ZWRNZXNzYWdlc18gPSBpbnB1dC5yZWFkVUludDY0KCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAyNDogew0KDQogICAgICAgICAgICAgIGlzRXJyb3JfID0gaW5wdXQucmVhZEJvb2woKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDM0OiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIGVycm9yXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBlLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBjYXRjaCAoamF2YS5pby5JT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbigNCiAgICAgICAgICAgIGUpLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgdGhpcy51bmtub3duRmllbGRzID0gdW5rbm93bkZpZWxkcy5idWlsZCgpOw0KICAgICAgICBtYWtlRXh0ZW5zaW9uc0ltbXV0YWJsZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZGVzY3JpcHRvcjsNCiAgICB9DQoNCiAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgIGludGVybmFsR2V0RmllbGRBY2Nlc3NvclRhYmxlKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgLmVuc3VyZUZpZWxkQWNjZXNzb3JzSW5pdGlhbGl6ZWQoDQogICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlLmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZS5CdWlsZGVyLmNsYXNzKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBSRVFVRVNUSURfRklFTERfTlVNQkVSID0gMTsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgcmVxdWVzdElEXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0UmVxdWVzdElEKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXF1ZXN0SURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIHJlcXVlc3RJRF8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0UmVxdWVzdElEQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHJlcXVlc3RJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgcmVxdWVzdElEXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBBRkZFQ1RFRE1FU1NBR0VTX0ZJRUxEX05VTUJFUiA9IDI7DQogICAgcHJpdmF0ZSBsb25nIGFmZmVjdGVkTWVzc2FnZXNfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnVpbnQ2NCBBZmZlY3RlZE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGxvbmcgZ2V0QWZmZWN0ZWRNZXNzYWdlcygpIHsNCiAgICAgIHJldHVybiBhZmZlY3RlZE1lc3NhZ2VzXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBJU0VSUk9SX0ZJRUxEX05VTUJFUiA9IDM7DQogICAgcHJpdmF0ZSBib29sZWFuIGlzRXJyb3JfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPmJvb2wgSXNFcnJvciA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBib29sZWFuIGdldElzRXJyb3IoKSB7DQogICAgICByZXR1cm4gaXNFcnJvcl87DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgRVJST1JfRklFTERfTlVNQkVSID0gNDsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgZXJyb3JfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldEVycm9yKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBlcnJvcl87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgZXJyb3JfID0gczsNCiAgICAgICAgcmV0dXJuIHM7DQogICAgICB9DQogICAgfQ0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0RXJyb3JCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gZXJyb3JfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgIGVycm9yXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwcml2YXRlIGJ5dGUgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gLTE7DQogICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgIGJ5dGUgaXNJbml0aWFsaXplZCA9IG1lbW9pemVkSXNJbml0aWFsaXplZDsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDEpIHJldHVybiB0cnVlOw0KICAgICAgaWYgKGlzSW5pdGlhbGl6ZWQgPT0gMCkgcmV0dXJuIGZhbHNlOw0KDQogICAgICBtZW1vaXplZElzSW5pdGlhbGl6ZWQgPSAxOw0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KDQogICAgcHVibGljIHZvaWQgd3JpdGVUbyhjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtIG91dHB1dCkNCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIGlmICghZ2V0UmVxdWVzdElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAxLCByZXF1ZXN0SURfKTsNCiAgICAgIH0NCiAgICAgIGlmIChhZmZlY3RlZE1lc3NhZ2VzXyAhPSAwTCkgew0KICAgICAgICBvdXRwdXQud3JpdGVVSW50NjQoMiwgYWZmZWN0ZWRNZXNzYWdlc18pOw0KICAgICAgfQ0KICAgICAgaWYgKGlzRXJyb3JfICE9IGZhbHNlKSB7DQogICAgICAgIG91dHB1dC53cml0ZUJvb2woMywgaXNFcnJvcl8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRFcnJvckJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLndyaXRlU3RyaW5nKG91dHB1dCwgNCwgZXJyb3JfKTsNCiAgICAgIH0NCiAgICAgIHVua25vd25GaWVsZHMud3JpdGVUbyhvdXRwdXQpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBpbnQgZ2V0U2VyaWFsaXplZFNpemUoKSB7DQogICAgICBpbnQgc2l6ZSA9IG1lbW9pemVkU2l6ZTsNCiAgICAgIGlmIChzaXplICE9IC0xKSByZXR1cm4gc2l6ZTsNCg0KICAgICAgc2l6ZSA9IDA7DQogICAgICBpZiAoIWdldFJlcXVlc3RJREJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoMSwgcmVxdWVzdElEXyk7DQogICAgICB9DQogICAgICBpZiAoYWZmZWN0ZWRNZXNzYWdlc18gIT0gMEwpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVVSW50NjRTaXplKDIsIGFmZmVjdGVkTWVzc2FnZXNfKTsNCiAgICAgIH0NCiAgICAgIGlmIChpc0Vycm9yXyAhPSBmYWxzZSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUJvb2xTaXplKDMsIGlzRXJyb3JfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0RXJyb3JCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDQsIGVycm9yXyk7DQogICAgICB9DQogICAgICBzaXplICs9IHVua25vd25GaWVsZHMuZ2V0U2VyaWFsaXplZFNpemUoKTsNCiAgICAgIG1lbW9pemVkU2l6ZSA9IHNpemU7DQogICAgICByZXR1cm4gc2l6ZTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGJvb2xlYW4gZXF1YWxzKGZpbmFsIGphdmEubGFuZy5PYmplY3Qgb2JqKSB7DQogICAgICBpZiAob2JqID09IHRoaXMpIHsNCiAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIGlmICghKG9iaiBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlKSkgew0KICAgICAgICByZXR1cm4gc3VwZXIuZXF1YWxzKG9iaik7DQogICAgICB9DQogICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZSBvdGhlciA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZSkgb2JqOw0KDQogICAgICBib29sZWFuIHJlc3VsdCA9IHRydWU7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0UmVxdWVzdElEKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldFJlcXVlc3RJRCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiAoZ2V0QWZmZWN0ZWRNZXNzYWdlcygpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0QWZmZWN0ZWRNZXNzYWdlcygpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiAoZ2V0SXNFcnJvcigpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0SXNFcnJvcigpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRFcnJvcigpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRFcnJvcigpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiB1bmtub3duRmllbGRzLmVxdWFscyhvdGhlci51bmtub3duRmllbGRzKTsNCiAgICAgIHJldHVybiByZXN1bHQ7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBpbnQgaGFzaENvZGUoKSB7DQogICAgICBpZiAobWVtb2l6ZWRIYXNoQ29kZSAhPSAwKSB7DQogICAgICAgIHJldHVybiBtZW1vaXplZEhhc2hDb2RlOw0KICAgICAgfQ0KICAgICAgaW50IGhhc2ggPSA0MTsNCiAgICAgIGhhc2ggPSAoMTkgKiBoYXNoKSArIGdldERlc2NyaXB0b3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgUkVRVUVTVElEX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldFJlcXVlc3RJRCgpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBBRkZFQ1RFRE1FU1NBR0VTX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGNvbS5nb29nbGUucHJvdG9idWYuSW50ZXJuYWwuaGFzaExvbmcoDQogICAgICAgICAgZ2V0QWZmZWN0ZWRNZXNzYWdlcygpKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIElTRVJST1JfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5oYXNoQm9vbGVhbigNCiAgICAgICAgICBnZXRJc0Vycm9yKCkpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgRVJST1JfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0RXJyb3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgyOSAqIGhhc2gpICsgdW5rbm93bkZpZWxkcy5oYXNoQ29kZSgpOw0KICAgICAgbWVtb2l6ZWRIYXNoQ29kZSA9IGhhc2g7DQogICAgICByZXR1cm4gaGFzaDsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5uaW8uQnl0ZUJ1ZmZlciBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZUZyb20oYnl0ZVtdIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZUZyb20oDQogICAgICAgIGJ5dGVbXSBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZUZyb20oamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcGFyc2VEZWxpbWl0ZWRGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZURlbGltaXRlZFdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZURlbGltaXRlZEZyb20oDQogICAgICAgIGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VEZWxpbWl0ZWRXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBCdWlsZGVyIG5ld0J1aWxkZXJGb3JUeXBlKCkgeyByZXR1cm4gbmV3QnVpbGRlcigpOyB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRS50b0J1aWxkZXIoKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcHJvdG90eXBlKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRS50b0J1aWxkZXIoKS5tZXJnZUZyb20ocHJvdG90eXBlKTsNCiAgICB9DQogICAgcHVibGljIEJ1aWxkZXIgdG9CdWlsZGVyKCkgew0KICAgICAgcmV0dXJuIHRoaXMgPT0gREVGQVVMVF9JTlNUQU5DRQ0KICAgICAgICAgID8gbmV3IEJ1aWxkZXIoKSA6IG5ldyBCdWlsZGVyKCkubWVyZ2VGcm9tKHRoaXMpOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwcm90ZWN0ZWQgQnVpbGRlciBuZXdCdWlsZGVyRm9yVHlwZSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlclBhcmVudCBwYXJlbnQpIHsNCiAgICAgIEJ1aWxkZXIgYnVpbGRlciA9IG5ldyBCdWlsZGVyKHBhcmVudCk7DQogICAgICByZXR1cm4gYnVpbGRlcjsNCiAgICB9DQogICAgLyoqDQogICAgICogUHJvdG9idWYgdHlwZSB7QGNvZGUga3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZX0NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNsYXNzIEJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPEJ1aWxkZXI+IGltcGxlbWVudHMNCiAgICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfaW1wbGVtZW50czprdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlKQ0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZU9yQnVpbGRlciB7DQogICAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlX2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZS5jbGFzcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UuQnVpbGRlci5jbGFzcyk7DQogICAgICB9DQoNCiAgICAgIC8vIENvbnN0cnVjdCB1c2luZyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZS5uZXdCdWlsZGVyKCkNCiAgICAgIHByaXZhdGUgQnVpbGRlcigpIHsNCiAgICAgICAgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIEJ1aWxkZXIoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlclBhcmVudCBwYXJlbnQpIHsNCiAgICAgICAgc3VwZXIocGFyZW50KTsNCiAgICAgICAgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpOw0KICAgICAgfQ0KICAgICAgcHJpdmF0ZSB2b2lkIG1heWJlRm9yY2VCdWlsZGVySW5pdGlhbGl6YXRpb24oKSB7DQogICAgICAgIGlmIChjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgICAgICAgIC5hbHdheXNVc2VGaWVsZEJ1aWxkZXJzKSB7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyKCkgew0KICAgICAgICBzdXBlci5jbGVhcigpOw0KICAgICAgICByZXF1ZXN0SURfID0gIiI7DQoNCiAgICAgICAgYWZmZWN0ZWRNZXNzYWdlc18gPSAwTDsNCg0KICAgICAgICBpc0Vycm9yXyA9IGZhbHNlOw0KDQogICAgICAgIGVycm9yXyA9ICIiOw0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgICAgICAgZ2V0RGVzY3JpcHRvckZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlX2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZSBnZXREZWZhdWx0SW5zdGFuY2VGb3JUeXBlKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UuZ2V0RGVmYXVsdEluc3RhbmNlKCk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZSBidWlsZCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcmVzdWx0ID0gYnVpbGRQYXJ0aWFsKCk7DQogICAgICAgIGlmICghcmVzdWx0LmlzSW5pdGlhbGl6ZWQoKSkgew0KICAgICAgICAgIHRocm93IG5ld1VuaW5pdGlhbGl6ZWRNZXNzYWdlRXhjZXB0aW9uKHJlc3VsdCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlIGJ1aWxkUGFydGlhbCgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcmVzdWx0ID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlKHRoaXMpOw0KICAgICAgICByZXN1bHQucmVxdWVzdElEXyA9IHJlcXVlc3RJRF87DQogICAgICAgIHJlc3VsdC5hZmZlY3RlZE1lc3NhZ2VzXyA9IGFmZmVjdGVkTWVzc2FnZXNfOw0KICAgICAgICByZXN1bHQuaXNFcnJvcl8gPSBpc0Vycm9yXzsNCiAgICAgICAgcmVzdWx0LmVycm9yXyA9IGVycm9yXzsNCiAgICAgICAgb25CdWlsdCgpOw0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBjbG9uZSgpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbG9uZSgpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJGaWVsZChmaWVsZCk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck9uZW9mKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuT25lb2ZEZXNjcmlwdG9yIG9uZW9mKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJPbmVvZihvbmVvZik7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGludCBpbmRleCwgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldFJlcGVhdGVkRmllbGQoZmllbGQsIGluZGV4LCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBhZGRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5hZGRSZXBlYXRlZEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oY29tLmdvb2dsZS5wcm90b2J1Zi5NZXNzYWdlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlKSB7DQogICAgICAgICAgcmV0dXJuIG1lcmdlRnJvbSgoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2Upb3RoZXIpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHN1cGVyLm1lcmdlRnJvbShvdGhlcik7DQogICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciA9PSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZS5nZXREZWZhdWx0SW5zdGFuY2UoKSkgcmV0dXJuIHRoaXM7DQogICAgICAgIGlmICghb3RoZXIuZ2V0UmVxdWVzdElEKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgcmVxdWVzdElEXyA9IG90aGVyLnJlcXVlc3RJRF87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmdldEFmZmVjdGVkTWVzc2FnZXMoKSAhPSAwTCkgew0KICAgICAgICAgIHNldEFmZmVjdGVkTWVzc2FnZXMob3RoZXIuZ2V0QWZmZWN0ZWRNZXNzYWdlcygpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0SXNFcnJvcigpICE9IGZhbHNlKSB7DQogICAgICAgICAgc2V0SXNFcnJvcihvdGhlci5nZXRJc0Vycm9yKCkpOw0KICAgICAgICB9DQogICAgICAgIGlmICghb3RoZXIuZ2V0RXJyb3IoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICBlcnJvcl8gPSBvdGhlci5lcnJvcl87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5tZXJnZVVua25vd25GaWVsZHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbSgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZWRNZXNzYWdlID0gbnVsbDsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gUEFSU0VSLnBhcnNlUGFydGlhbEZyb20oaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UpIGUuZ2V0VW5maW5pc2hlZE1lc3NhZ2UoKTsNCiAgICAgICAgICB0aHJvdyBlLnVud3JhcElPRXhjZXB0aW9uKCk7DQogICAgICAgIH0gZmluYWxseSB7DQogICAgICAgICAgaWYgKHBhcnNlZE1lc3NhZ2UgIT0gbnVsbCkgew0KICAgICAgICAgICAgbWVyZ2VGcm9tKHBhcnNlZE1lc3NhZ2UpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IHJlcXVlc3RJRF8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRSZXF1ZXN0SUQoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVxdWVzdElEXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgcmVxdWVzdElEXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0UmVxdWVzdElEQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVxdWVzdElEXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICByZXF1ZXN0SURfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UmVxdWVzdElEKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgcmVxdWVzdElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJSZXF1ZXN0SUQoKSB7DQogICAgICAgIA0KICAgICAgICByZXF1ZXN0SURfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0UmVxdWVzdElEKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXF1ZXN0SURCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgcmVxdWVzdElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgbG9uZyBhZmZlY3RlZE1lc3NhZ2VzXyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnVpbnQ2NCBBZmZlY3RlZE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBsb25nIGdldEFmZmVjdGVkTWVzc2FnZXMoKSB7DQogICAgICAgIHJldHVybiBhZmZlY3RlZE1lc3NhZ2VzXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+dWludDY0IEFmZmVjdGVkTWVzc2FnZXMgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0QWZmZWN0ZWRNZXNzYWdlcyhsb25nIHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICBhZmZlY3RlZE1lc3NhZ2VzXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnVpbnQ2NCBBZmZlY3RlZE1lc3NhZ2VzID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyQWZmZWN0ZWRNZXNzYWdlcygpIHsNCiAgICAgICAgDQogICAgICAgIGFmZmVjdGVkTWVzc2FnZXNfID0gMEw7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBib29sZWFuIGlzRXJyb3JfIDsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ym9vbCBJc0Vycm9yID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBib29sZWFuIGdldElzRXJyb3IoKSB7DQogICAgICAgIHJldHVybiBpc0Vycm9yXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Ym9vbCBJc0Vycm9yID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldElzRXJyb3IoYm9vbGVhbiB2YWx1ZSkgew0KICAgICAgICANCiAgICAgICAgaXNFcnJvcl8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIElzRXJyb3IgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJJc0Vycm9yKCkgew0KICAgICAgICANCiAgICAgICAgaXNFcnJvcl8gPSBmYWxzZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgZXJyb3JfID0gIiI7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRFcnJvcigpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBlcnJvcl87DQogICAgICAgIGlmICghKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0NCiAgICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICAgIGVycm9yXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRFcnJvckJ5dGVzKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGVycm9yXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICBlcnJvcl8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEVycm9yKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgZXJyb3JfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyRXJyb3IoKSB7DQogICAgICAgIA0KICAgICAgICBlcnJvcl8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRFcnJvcigpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBFcnJvciA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRFcnJvckJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBlcnJvcl8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgcHVibGljIGZpbmFsIEJ1aWxkZXIgc2V0VW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5zZXRVbmtub3duRmllbGRzUHJvdG8zKHVua25vd25GaWVsZHMpOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBtZXJnZVVua25vd25GaWVsZHMoDQogICAgICAgICAgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQgdW5rbm93bkZpZWxkcykgew0KICAgICAgICByZXR1cm4gc3VwZXIubWVyZ2VVbmtub3duRmllbGRzKHVua25vd25GaWVsZHMpOw0KICAgICAgfQ0KDQoNCiAgICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChidWlsZGVyX3Njb3BlOmt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UpDQogICAgfQ0KDQogICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGNsYXNzX3Njb3BlOmt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UpDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgREVGQVVMVF9JTlNUQU5DRTsNCiAgICBzdGF0aWMgew0KICAgICAgREVGQVVMVF9JTlNUQU5DRSA9IG5ldyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZSgpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgZ2V0RGVmYXVsdEluc3RhbmNlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8QWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlPg0KICAgICAgICBQQVJTRVIgPSBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5BYnN0cmFjdFBhcnNlcjxBY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2U+KCkgew0KICAgICAgcHVibGljIEFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZVBhcnRpYWxGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgICByZXR1cm4gbmV3IEFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZShpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgfQ0KICAgIH07DQoNCiAgICBwdWJsaWMgc3RhdGljIGNvbS5nb29nbGUucHJvdG9idWYuUGFyc2VyPEFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZT4gcGFyc2VyKCkgew0KICAgICAgcmV0dXJuIFBBUlNFUjsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuUGFyc2VyPEFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZT4gZ2V0UGFyc2VyRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlIGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRTsNCiAgICB9DQoNCiAgfQ0KDQogIHB1YmxpYyBpbnRlcmZhY2UgU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3RPckJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGludGVyZmFjZV9leHRlbmRzOmt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCkNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZU9yQnVpbGRlciB7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgamF2YS5sYW5nLlN0cmluZyBnZXRSZXF1ZXN0SUQoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldFJlcXVlc3RJREJ5dGVzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldENsaWVudElEKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENsaWVudElEID0gMjs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldENsaWVudElEQnl0ZXMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuU3RyZWFtUmVxdWVzdFR5cGUgU3RyZWFtUmVxdWVzdFR5cGVEYXRhID0gMzs8L2NvZGU+DQogICAgICovDQogICAgaW50IGdldFN0cmVhbVJlcXVlc3RUeXBlRGF0YVZhbHVlKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+Lmt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZSBTdHJlYW1SZXF1ZXN0VHlwZURhdGEgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlIGdldFN0cmVhbVJlcXVlc3RUeXBlRGF0YSgpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldENoYW5uZWwoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRDaGFubmVsQnl0ZXMoKTsNCg0KICAgIC8qKg0KICAgICAqIDxjb2RlPmludDMyIFZpc2liaWxpdHlTZWNvbmRzID0gNTs8L2NvZGU+DQogICAgICovDQogICAgaW50IGdldFZpc2liaWxpdHlTZWNvbmRzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQzMiBXYWl0VGltZVNlY29uZHMgPSA2OzwvY29kZT4NCiAgICAgKi8NCiAgICBpbnQgZ2V0V2FpdFRpbWVTZWNvbmRzKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT51aW50NjQgUmVmU2VxdWVuY2UgPSA3OzwvY29kZT4NCiAgICAgKi8NCiAgICBsb25nIGdldFJlZlNlcXVlbmNlKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNb2RpZmllZE1lc3NhZ2UgPSA4OzwvY29kZT4NCiAgICAgKi8NCiAgICBib29sZWFuIGhhc01vZGlmaWVkTWVzc2FnZSgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuUXVldWVNZXNzYWdlIE1vZGlmaWVkTWVzc2FnZSA9IDg7PC9jb2RlPg0KICAgICAqLw0KICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlIGdldE1vZGlmaWVkTWVzc2FnZSgpOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuUXVldWVNZXNzYWdlIE1vZGlmaWVkTWVzc2FnZSA9IDg7PC9jb2RlPg0KICAgICAqLw0KICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlT3JCdWlsZGVyIGdldE1vZGlmaWVkTWVzc2FnZU9yQnVpbGRlcigpOw0KICB9DQogIC8qKg0KICAgKiBQcm90b2J1ZiB0eXBlIHtAY29kZSBrdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3R9DQogICAqLw0KICBwdWJsaWMgIHN0YXRpYyBmaW5hbCBjbGFzcyBTdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCBleHRlbmRzDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMyBpbXBsZW1lbnRzDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQobWVzc2FnZV9pbXBsZW1lbnRzOmt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCkNCiAgICAgIFN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0T3JCdWlsZGVyIHsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgbG9uZyBzZXJpYWxWZXJzaW9uVUlEID0gMEw7DQogICAgLy8gVXNlIFN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0Lm5ld0J1aWxkZXIoKSB0byBjb25zdHJ1Y3QuDQogICAgcHJpdmF0ZSBTdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdChjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPD8+IGJ1aWxkZXIpIHsNCiAgICAgIHN1cGVyKGJ1aWxkZXIpOw0KICAgIH0NCiAgICBwcml2YXRlIFN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0KCkgew0KICAgICAgcmVxdWVzdElEXyA9ICIiOw0KICAgICAgY2xpZW50SURfID0gIiI7DQogICAgICBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfID0gMDsNCiAgICAgIGNoYW5uZWxfID0gIiI7DQogICAgICB2aXNpYmlsaXR5U2Vjb25kc18gPSAwOw0KICAgICAgd2FpdFRpbWVTZWNvbmRzXyA9IDA7DQogICAgICByZWZTZXF1ZW5jZV8gPSAwTDsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0DQogICAgZ2V0VW5rbm93bkZpZWxkcygpIHsNCiAgICAgIHJldHVybiB0aGlzLnVua25vd25GaWVsZHM7DQogICAgfQ0KICAgIHByaXZhdGUgU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICB0aGlzKCk7DQogICAgICBpZiAoZXh0ZW5zaW9uUmVnaXN0cnkgPT0gbnVsbCkgew0KICAgICAgICB0aHJvdyBuZXcgamF2YS5sYW5nLk51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogICAgICB9DQogICAgICBpbnQgbXV0YWJsZV9iaXRGaWVsZDBfID0gMDsNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0LkJ1aWxkZXIgdW5rbm93bkZpZWxkcyA9DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Vbmtub3duRmllbGRTZXQubmV3QnVpbGRlcigpOw0KICAgICAgdHJ5IHsNCiAgICAgICAgYm9vbGVhbiBkb25lID0gZmFsc2U7DQogICAgICAgIHdoaWxlICghZG9uZSkgew0KICAgICAgICAgIGludCB0YWcgPSBpbnB1dC5yZWFkVGFnKCk7DQogICAgICAgICAgc3dpdGNoICh0YWcpIHsNCiAgICAgICAgICAgIGNhc2UgMDoNCiAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgZGVmYXVsdDogew0KICAgICAgICAgICAgICBpZiAoIXBhcnNlVW5rbm93bkZpZWxkUHJvdG8zKA0KICAgICAgICAgICAgICAgICAgaW5wdXQsIHVua25vd25GaWVsZHMsIGV4dGVuc2lvblJlZ2lzdHJ5LCB0YWcpKSB7DQogICAgICAgICAgICAgICAgZG9uZSA9IHRydWU7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDEwOiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIHJlcXVlc3RJRF8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMTg6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgY2xpZW50SURfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDI0OiB7DQogICAgICAgICAgICAgIGludCByYXdWYWx1ZSA9IGlucHV0LnJlYWRFbnVtKCk7DQoNCiAgICAgICAgICAgICAgc3RyZWFtUmVxdWVzdFR5cGVEYXRhXyA9IHJhd1ZhbHVlOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMzQ6IHsNCiAgICAgICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gaW5wdXQucmVhZFN0cmluZ1JlcXVpcmVVdGY4KCk7DQoNCiAgICAgICAgICAgICAgY2hhbm5lbF8gPSBzOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNDA6IHsNCg0KICAgICAgICAgICAgICB2aXNpYmlsaXR5U2Vjb25kc18gPSBpbnB1dC5yZWFkSW50MzIoKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDQ4OiB7DQoNCiAgICAgICAgICAgICAgd2FpdFRpbWVTZWNvbmRzXyA9IGlucHV0LnJlYWRJbnQzMigpOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgNTY6IHsNCg0KICAgICAgICAgICAgICByZWZTZXF1ZW5jZV8gPSBpbnB1dC5yZWFkVUludDY0KCk7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSA2Njogew0KICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5CdWlsZGVyIHN1YkJ1aWxkZXIgPSBudWxsOw0KICAgICAgICAgICAgICBpZiAobW9kaWZpZWRNZXNzYWdlXyAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgc3ViQnVpbGRlciA9IG1vZGlmaWVkTWVzc2FnZV8udG9CdWlsZGVyKCk7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgbW9kaWZpZWRNZXNzYWdlXyA9IGlucHV0LnJlYWRNZXNzYWdlKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLnBhcnNlcigpLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICAgICAgICAgIGlmIChzdWJCdWlsZGVyICE9IG51bGwpIHsNCiAgICAgICAgICAgICAgICBzdWJCdWlsZGVyLm1lcmdlRnJvbShtb2RpZmllZE1lc3NhZ2VfKTsNCiAgICAgICAgICAgICAgICBtb2RpZmllZE1lc3NhZ2VfID0gc3ViQnVpbGRlci5idWlsZFBhcnRpYWwoKTsNCiAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBlLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBjYXRjaCAoamF2YS5pby5JT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbigNCiAgICAgICAgICAgIGUpLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgdGhpcy51bmtub3duRmllbGRzID0gdW5rbm93bkZpZWxkcy5idWlsZCgpOw0KICAgICAgICBtYWtlRXh0ZW5zaW9uc0ltbXV0YWJsZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdF9kZXNjcmlwdG9yOw0KICAgIH0NCg0KICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgaW50ZXJuYWxHZXRGaWVsZEFjY2Vzc29yVGFibGUoKSB7DQogICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1N0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0X2ZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgICAgIC5lbnN1cmVGaWVsZEFjY2Vzc29yc0luaXRpYWxpemVkKA0KICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0LmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0LkJ1aWxkZXIuY2xhc3MpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFJFUVVFU1RJRF9GSUVMRF9OVU1CRVIgPSAxOw0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCByZXF1ZXN0SURfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRSZXF1ZXN0SUQoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHJlcXVlc3RJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9IA0KICAgICAgICAgICAgKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgcmVxdWVzdElEXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRSZXF1ZXN0SURCeXRlcygpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVxdWVzdElEXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICByZXF1ZXN0SURfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENMSUVOVElEX0ZJRUxEX05VTUJFUiA9IDI7DQogICAgcHJpdmF0ZSB2b2xhdGlsZSBqYXZhLmxhbmcuT2JqZWN0IGNsaWVudElEXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDbGllbnRJRCgpIHsNCiAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2xpZW50SURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIGNsaWVudElEXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldENsaWVudElEQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGNsaWVudElEXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICBjbGllbnRJRF8gPSBiOw0KICAgICAgICByZXR1cm4gYjsNCiAgICAgIH0gZWxzZSB7DQogICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICB9DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgU1RSRUFNUkVRVUVTVFRZUEVEQVRBX0ZJRUxEX05VTUJFUiA9IDM7DQogICAgcHJpdmF0ZSBpbnQgc3RyZWFtUmVxdWVzdFR5cGVEYXRhXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlIFN0cmVhbVJlcXVlc3RUeXBlRGF0YSA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpbnQgZ2V0U3RyZWFtUmVxdWVzdFR5cGVEYXRhVmFsdWUoKSB7DQogICAgICByZXR1cm4gc3RyZWFtUmVxdWVzdFR5cGVEYXRhXzsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+Lmt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZSBTdHJlYW1SZXF1ZXN0VHlwZURhdGEgPSAzOzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZSBnZXRTdHJlYW1SZXF1ZXN0VHlwZURhdGEoKSB7DQogICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlIHJlc3VsdCA9IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUmVxdWVzdFR5cGUudmFsdWVPZihzdHJlYW1SZXF1ZXN0VHlwZURhdGFfKTsNCiAgICAgIHJldHVybiByZXN1bHQgPT0gbnVsbCA/IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUmVxdWVzdFR5cGUuVU5SRUNPR05JWkVEIDogcmVzdWx0Ow0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IENIQU5ORUxfRklFTERfTlVNQkVSID0gNDsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgY2hhbm5lbF87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSA0OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRDaGFubmVsKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBjaGFubmVsXyA9IHM7DQogICAgICAgIHJldHVybiBzOw0KICAgICAgfQ0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgQ2hhbm5lbCA9IDQ7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0Q2hhbm5lbEJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICBjaGFubmVsXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBWSVNJQklMSVRZU0VDT05EU19GSUVMRF9OVU1CRVIgPSA1Ow0KICAgIHByaXZhdGUgaW50IHZpc2liaWxpdHlTZWNvbmRzXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5pbnQzMiBWaXNpYmlsaXR5U2Vjb25kcyA9IDU7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpbnQgZ2V0VmlzaWJpbGl0eVNlY29uZHMoKSB7DQogICAgICByZXR1cm4gdmlzaWJpbGl0eVNlY29uZHNfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IFdBSVRUSU1FU0VDT05EU19GSUVMRF9OVU1CRVIgPSA2Ow0KICAgIHByaXZhdGUgaW50IHdhaXRUaW1lU2Vjb25kc187DQogICAgLyoqDQogICAgICogPGNvZGU+aW50MzIgV2FpdFRpbWVTZWNvbmRzID0gNjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGludCBnZXRXYWl0VGltZVNlY29uZHMoKSB7DQogICAgICByZXR1cm4gd2FpdFRpbWVTZWNvbmRzXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBSRUZTRVFVRU5DRV9GSUVMRF9OVU1CRVIgPSA3Ow0KICAgIHByaXZhdGUgbG9uZyByZWZTZXF1ZW5jZV87DQogICAgLyoqDQogICAgICogPGNvZGU+dWludDY0IFJlZlNlcXVlbmNlID0gNzs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGxvbmcgZ2V0UmVmU2VxdWVuY2UoKSB7DQogICAgICByZXR1cm4gcmVmU2VxdWVuY2VfOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IE1PRElGSUVETUVTU0FHRV9GSUVMRF9OVU1CRVIgPSA4Ow0KICAgIHByaXZhdGUgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgbW9kaWZpZWRNZXNzYWdlXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNb2RpZmllZE1lc3NhZ2UgPSA4OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgYm9vbGVhbiBoYXNNb2RpZmllZE1lc3NhZ2UoKSB7DQogICAgICByZXR1cm4gbW9kaWZpZWRNZXNzYWdlXyAhPSBudWxsOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNb2RpZmllZE1lc3NhZ2UgPSA4OzwvY29kZT4NCiAgICAgKi8NCiAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgZ2V0TW9kaWZpZWRNZXNzYWdlKCkgew0KICAgICAgcmV0dXJuIG1vZGlmaWVkTWVzc2FnZV8gPT0gbnVsbCA/IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLmdldERlZmF1bHRJbnN0YW5jZSgpIDogbW9kaWZpZWRNZXNzYWdlXzsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTW9kaWZpZWRNZXNzYWdlID0gODs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlT3JCdWlsZGVyIGdldE1vZGlmaWVkTWVzc2FnZU9yQnVpbGRlcigpIHsNCiAgICAgIHJldHVybiBnZXRNb2RpZmllZE1lc3NhZ2UoKTsNCiAgICB9DQoNCiAgICBwcml2YXRlIGJ5dGUgbWVtb2l6ZWRJc0luaXRpYWxpemVkID0gLTE7DQogICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgIGJ5dGUgaXNJbml0aWFsaXplZCA9IG1lbW9pemVkSXNJbml0aWFsaXplZDsNCiAgICAgIGlmIChpc0luaXRpYWxpemVkID09IDEpIHJldHVybiB0cnVlOw0KICAgICAgaWYgKGlzSW5pdGlhbGl6ZWQgPT0gMCkgcmV0dXJuIGZhbHNlOw0KDQogICAgICBtZW1vaXplZElzSW5pdGlhbGl6ZWQgPSAxOw0KICAgICAgcmV0dXJuIHRydWU7DQogICAgfQ0KDQogICAgcHVibGljIHZvaWQgd3JpdGVUbyhjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtIG91dHB1dCkNCiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIGlmICghZ2V0UmVxdWVzdElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCAxLCByZXF1ZXN0SURfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0Q2xpZW50SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDIsIGNsaWVudElEXyk7DQogICAgICB9DQogICAgICBpZiAoc3RyZWFtUmVxdWVzdFR5cGVEYXRhXyAhPSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlLlN0cmVhbVJlcXVlc3RUeXBlVW5rbm93bi5nZXROdW1iZXIoKSkgew0KICAgICAgICBvdXRwdXQud3JpdGVFbnVtKDMsIHN0cmVhbVJlcXVlc3RUeXBlRGF0YV8pOw0KICAgICAgfQ0KICAgICAgaWYgKCFnZXRDaGFubmVsQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMud3JpdGVTdHJpbmcob3V0cHV0LCA0LCBjaGFubmVsXyk7DQogICAgICB9DQogICAgICBpZiAodmlzaWJpbGl0eVNlY29uZHNfICE9IDApIHsNCiAgICAgICAgb3V0cHV0LndyaXRlSW50MzIoNSwgdmlzaWJpbGl0eVNlY29uZHNfKTsNCiAgICAgIH0NCiAgICAgIGlmICh3YWl0VGltZVNlY29uZHNfICE9IDApIHsNCiAgICAgICAgb3V0cHV0LndyaXRlSW50MzIoNiwgd2FpdFRpbWVTZWNvbmRzXyk7DQogICAgICB9DQogICAgICBpZiAocmVmU2VxdWVuY2VfICE9IDBMKSB7DQogICAgICAgIG91dHB1dC53cml0ZVVJbnQ2NCg3LCByZWZTZXF1ZW5jZV8pOw0KICAgICAgfQ0KICAgICAgaWYgKG1vZGlmaWVkTWVzc2FnZV8gIT0gbnVsbCkgew0KICAgICAgICBvdXRwdXQud3JpdGVNZXNzYWdlKDgsIGdldE1vZGlmaWVkTWVzc2FnZSgpKTsNCiAgICAgIH0NCiAgICAgIHVua25vd25GaWVsZHMud3JpdGVUbyhvdXRwdXQpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBpbnQgZ2V0U2VyaWFsaXplZFNpemUoKSB7DQogICAgICBpbnQgc2l6ZSA9IG1lbW9pemVkU2l6ZTsNCiAgICAgIGlmIChzaXplICE9IC0xKSByZXR1cm4gc2l6ZTsNCg0KICAgICAgc2l6ZSA9IDA7DQogICAgICBpZiAoIWdldFJlcXVlc3RJREJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoMSwgcmVxdWVzdElEXyk7DQogICAgICB9DQogICAgICBpZiAoIWdldENsaWVudElEQnl0ZXMoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5jb21wdXRlU3RyaW5nU2l6ZSgyLCBjbGllbnRJRF8pOw0KICAgICAgfQ0KICAgICAgaWYgKHN0cmVhbVJlcXVlc3RUeXBlRGF0YV8gIT0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZS5TdHJlYW1SZXF1ZXN0VHlwZVVua25vd24uZ2V0TnVtYmVyKCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVFbnVtU2l6ZSgzLCBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0Q2hhbm5lbEJ5dGVzKCkuaXNFbXB0eSgpKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuY29tcHV0ZVN0cmluZ1NpemUoNCwgY2hhbm5lbF8pOw0KICAgICAgfQ0KICAgICAgaWYgKHZpc2liaWxpdHlTZWNvbmRzXyAhPSAwKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlSW50MzJTaXplKDUsIHZpc2liaWxpdHlTZWNvbmRzXyk7DQogICAgICB9DQogICAgICBpZiAod2FpdFRpbWVTZWNvbmRzXyAhPSAwKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlSW50MzJTaXplKDYsIHdhaXRUaW1lU2Vjb25kc18pOw0KICAgICAgfQ0KICAgICAgaWYgKHJlZlNlcXVlbmNlXyAhPSAwTCkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZVVJbnQ2NFNpemUoNywgcmVmU2VxdWVuY2VfKTsNCiAgICAgIH0NCiAgICAgIGlmIChtb2RpZmllZE1lc3NhZ2VfICE9IG51bGwpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVNZXNzYWdlU2l6ZSg4LCBnZXRNb2RpZmllZE1lc3NhZ2UoKSk7DQogICAgICB9DQogICAgICBzaXplICs9IHVua25vd25GaWVsZHMuZ2V0U2VyaWFsaXplZFNpemUoKTsNCiAgICAgIG1lbW9pemVkU2l6ZSA9IHNpemU7DQogICAgICByZXR1cm4gc2l6ZTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGJvb2xlYW4gZXF1YWxzKGZpbmFsIGphdmEubGFuZy5PYmplY3Qgb2JqKSB7DQogICAgICBpZiAob2JqID09IHRoaXMpIHsNCiAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIGlmICghKG9iaiBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QpKSB7DQogICAgICAgIHJldHVybiBzdXBlci5lcXVhbHMob2JqKTsNCiAgICAgIH0NCiAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3Qgb3RoZXIgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCkgb2JqOw0KDQogICAgICBib29sZWFuIHJlc3VsdCA9IHRydWU7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0UmVxdWVzdElEKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldFJlcXVlc3RJRCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBnZXRDbGllbnRJRCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRDbGllbnRJRCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfID09IG90aGVyLnN0cmVhbVJlcXVlc3RUeXBlRGF0YV87DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0Q2hhbm5lbCgpDQogICAgICAgICAgLmVxdWFscyhvdGhlci5nZXRDaGFubmVsKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChnZXRWaXNpYmlsaXR5U2Vjb25kcygpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0VmlzaWJpbGl0eVNlY29uZHMoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldFdhaXRUaW1lU2Vjb25kcygpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0V2FpdFRpbWVTZWNvbmRzKCkpOw0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIChnZXRSZWZTZXF1ZW5jZSgpDQogICAgICAgICAgPT0gb3RoZXIuZ2V0UmVmU2VxdWVuY2UoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGhhc01vZGlmaWVkTWVzc2FnZSgpID09IG90aGVyLmhhc01vZGlmaWVkTWVzc2FnZSgpKTsNCiAgICAgIGlmIChoYXNNb2RpZmllZE1lc3NhZ2UoKSkgew0KICAgICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0TW9kaWZpZWRNZXNzYWdlKCkNCiAgICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0TW9kaWZpZWRNZXNzYWdlKCkpOw0KICAgICAgfQ0KICAgICAgcmVzdWx0ID0gcmVzdWx0ICYmIHVua25vd25GaWVsZHMuZXF1YWxzKG90aGVyLnVua25vd25GaWVsZHMpOw0KICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGludCBoYXNoQ29kZSgpIHsNCiAgICAgIGlmIChtZW1vaXplZEhhc2hDb2RlICE9IDApIHsNCiAgICAgICAgcmV0dXJuIG1lbW9pemVkSGFzaENvZGU7DQogICAgICB9DQogICAgICBpbnQgaGFzaCA9IDQxOw0KICAgICAgaGFzaCA9ICgxOSAqIGhhc2gpICsgZ2V0RGVzY3JpcHRvcigpLmhhc2hDb2RlKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBSRVFVRVNUSURfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0UmVxdWVzdElEKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIENMSUVOVElEX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldENsaWVudElEKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFNUUkVBTVJFUVVFU1RUWVBFREFUQV9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgQ0hBTk5FTF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRDaGFubmVsKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFZJU0lCSUxJVFlTRUNPTkRTX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldFZpc2liaWxpdHlTZWNvbmRzKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBXQUlUVElNRVNFQ09ORFNfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0V2FpdFRpbWVTZWNvbmRzKCk7DQogICAgICBoYXNoID0gKDM3ICogaGFzaCkgKyBSRUZTRVFVRU5DRV9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBjb20uZ29vZ2xlLnByb3RvYnVmLkludGVybmFsLmhhc2hMb25nKA0KICAgICAgICAgIGdldFJlZlNlcXVlbmNlKCkpOw0KICAgICAgaWYgKGhhc01vZGlmaWVkTWVzc2FnZSgpKSB7DQogICAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIE1PRElGSUVETUVTU0FHRV9GSUVMRF9OVU1CRVI7DQogICAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIGdldE1vZGlmaWVkTWVzc2FnZSgpLmhhc2hDb2RlKCk7DQogICAgICB9DQogICAgICBoYXNoID0gKDI5ICogaGFzaCkgKyB1bmtub3duRmllbGRzLmhhc2hDb2RlKCk7DQogICAgICBtZW1vaXplZEhhc2hDb2RlID0gaGFzaDsNCiAgICAgIHJldHVybiBoYXNoOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZUZyb20oDQogICAgICAgIGphdmEubmlvLkJ5dGVCdWZmZXIgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgZGF0YSwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhLCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZUZyb20oYnl0ZVtdIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgYnl0ZVtdIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZURlbGltaXRlZEZyb20oamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QgcGFyc2VEZWxpbWl0ZWRGcm9tKA0KICAgICAgICBqYXZhLmlvLklucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlRGVsaW1pdGVkV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KDQogICAgcHVibGljIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoKSB7IHJldHVybiBuZXdCdWlsZGVyKCk7IH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcigpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFLnRvQnVpbGRlcigpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIEJ1aWxkZXIgbmV3QnVpbGRlcihpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHByb3RvdHlwZSkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0UudG9CdWlsZGVyKCkubWVyZ2VGcm9tKHByb3RvdHlwZSk7DQogICAgfQ0KICAgIHB1YmxpYyBCdWlsZGVyIHRvQnVpbGRlcigpIHsNCiAgICAgIHJldHVybiB0aGlzID09IERFRkFVTFRfSU5TVEFOQ0UNCiAgICAgICAgICA/IG5ldyBCdWlsZGVyKCkgOiBuZXcgQnVpbGRlcigpLm1lcmdlRnJvbSh0aGlzKTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHJvdGVjdGVkIEJ1aWxkZXIgbmV3QnVpbGRlckZvclR5cGUoDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkJ1aWxkZXJQYXJlbnQgcGFyZW50KSB7DQogICAgICBCdWlsZGVyIGJ1aWxkZXIgPSBuZXcgQnVpbGRlcihwYXJlbnQpOw0KICAgICAgcmV0dXJuIGJ1aWxkZXI7DQogICAgfQ0KICAgIC8qKg0KICAgICAqIFByb3RvYnVmIHR5cGUge0Bjb2RlIGt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdH0NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNsYXNzIEJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPEJ1aWxkZXI+IGltcGxlbWVudHMNCiAgICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfaW1wbGVtZW50czprdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QpDQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3RPckJ1aWxkZXIgew0KICAgICAgcHVibGljIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5pbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1N0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0X2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdF9maWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICAgIC5lbnN1cmVGaWVsZEFjY2Vzc29yc0luaXRpYWxpemVkKA0KICAgICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QuY2xhc3MsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QuQnVpbGRlci5jbGFzcyk7DQogICAgICB9DQoNCiAgICAgIC8vIENvbnN0cnVjdCB1c2luZyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0Lm5ld0J1aWxkZXIoKQ0KICAgICAgcHJpdmF0ZSBCdWlsZGVyKCkgew0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgQnVpbGRlcigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyUGFyZW50IHBhcmVudCkgew0KICAgICAgICBzdXBlcihwYXJlbnQpOw0KICAgICAgICBtYXliZUZvcmNlQnVpbGRlckluaXRpYWxpemF0aW9uKCk7DQogICAgICB9DQogICAgICBwcml2YXRlIHZvaWQgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpIHsNCiAgICAgICAgaWYgKGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgICAgICAgLmFsd2F5c1VzZUZpZWxkQnVpbGRlcnMpIHsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXIoKSB7DQogICAgICAgIHN1cGVyLmNsZWFyKCk7DQogICAgICAgIHJlcXVlc3RJRF8gPSAiIjsNCg0KICAgICAgICBjbGllbnRJRF8gPSAiIjsNCg0KICAgICAgICBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfID0gMDsNCg0KICAgICAgICBjaGFubmVsXyA9ICIiOw0KDQogICAgICAgIHZpc2liaWxpdHlTZWNvbmRzXyA9IDA7DQoNCiAgICAgICAgd2FpdFRpbWVTZWNvbmRzXyA9IDA7DQoNCiAgICAgICAgcmVmU2VxdWVuY2VfID0gMEw7DQoNCiAgICAgICAgaWYgKG1vZGlmaWVkTWVzc2FnZUJ1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBtb2RpZmllZE1lc3NhZ2VfID0gbnVsbDsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBtb2RpZmllZE1lc3NhZ2VfID0gbnVsbDsNCiAgICAgICAgICBtb2RpZmllZE1lc3NhZ2VCdWlsZGVyXyA9IG51bGw7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdF9kZXNjcmlwdG9yOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCBnZXREZWZhdWx0SW5zdGFuY2VGb3JUeXBlKCkgew0KICAgICAgICByZXR1cm4gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdC5nZXREZWZhdWx0SW5zdGFuY2UoKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QgYnVpbGQoKSB7DQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QgcmVzdWx0ID0gYnVpbGRQYXJ0aWFsKCk7DQogICAgICAgIGlmICghcmVzdWx0LmlzSW5pdGlhbGl6ZWQoKSkgew0KICAgICAgICAgIHRocm93IG5ld1VuaW5pdGlhbGl6ZWRNZXNzYWdlRXhjZXB0aW9uKHJlc3VsdCk7DQogICAgICAgIH0NCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QgYnVpbGRQYXJ0aWFsKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0IHJlc3VsdCA9IG5ldyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0KHRoaXMpOw0KICAgICAgICByZXN1bHQucmVxdWVzdElEXyA9IHJlcXVlc3RJRF87DQogICAgICAgIHJlc3VsdC5jbGllbnRJRF8gPSBjbGllbnRJRF87DQogICAgICAgIHJlc3VsdC5zdHJlYW1SZXF1ZXN0VHlwZURhdGFfID0gc3RyZWFtUmVxdWVzdFR5cGVEYXRhXzsNCiAgICAgICAgcmVzdWx0LmNoYW5uZWxfID0gY2hhbm5lbF87DQogICAgICAgIHJlc3VsdC52aXNpYmlsaXR5U2Vjb25kc18gPSB2aXNpYmlsaXR5U2Vjb25kc187DQogICAgICAgIHJlc3VsdC53YWl0VGltZVNlY29uZHNfID0gd2FpdFRpbWVTZWNvbmRzXzsNCiAgICAgICAgcmVzdWx0LnJlZlNlcXVlbmNlXyA9IHJlZlNlcXVlbmNlXzsNCiAgICAgICAgaWYgKG1vZGlmaWVkTWVzc2FnZUJ1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICByZXN1bHQubW9kaWZpZWRNZXNzYWdlXyA9IG1vZGlmaWVkTWVzc2FnZV87DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmVzdWx0Lm1vZGlmaWVkTWVzc2FnZV8gPSBtb2RpZmllZE1lc3NhZ2VCdWlsZGVyXy5idWlsZCgpOw0KICAgICAgICB9DQogICAgICAgIG9uQnVpbHQoKTsNCiAgICAgICAgcmV0dXJuIHJlc3VsdDsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xvbmUoKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xvbmUoKTsNCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyRmllbGQoZmllbGQpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJPbmVvZigNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLk9uZW9mRGVzY3JpcHRvciBvbmVvZikgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLmNsZWFyT25lb2Yob25lb2YpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBpbnQgaW5kZXgsIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5zZXRSZXBlYXRlZEZpZWxkKGZpZWxkLCBpbmRleCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgYWRkUmVwZWF0ZWRGaWVsZCgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkZpZWxkRGVzY3JpcHRvciBmaWVsZCwNCiAgICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHZhbHVlKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuYWRkUmVwZWF0ZWRGaWVsZChmaWVsZCwgdmFsdWUpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGNvbS5nb29nbGUucHJvdG9idWYuTWVzc2FnZSBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgaW5zdGFuY2VvZiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0KSB7DQogICAgICAgICAgcmV0dXJuIG1lcmdlRnJvbSgoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdClvdGhlcik7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgc3VwZXIubWVyZ2VGcm9tKG90aGVyKTsNCiAgICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgICAgfQ0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCBvdGhlcikgew0KICAgICAgICBpZiAob3RoZXIgPT0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdC5nZXREZWZhdWx0SW5zdGFuY2UoKSkgcmV0dXJuIHRoaXM7DQogICAgICAgIGlmICghb3RoZXIuZ2V0UmVxdWVzdElEKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgcmVxdWVzdElEXyA9IG90aGVyLnJlcXVlc3RJRF87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRDbGllbnRJRCgpLmlzRW1wdHkoKSkgew0KICAgICAgICAgIGNsaWVudElEXyA9IG90aGVyLmNsaWVudElEXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuc3RyZWFtUmVxdWVzdFR5cGVEYXRhXyAhPSAwKSB7DQogICAgICAgICAgc2V0U3RyZWFtUmVxdWVzdFR5cGVEYXRhVmFsdWUob3RoZXIuZ2V0U3RyZWFtUmVxdWVzdFR5cGVEYXRhVmFsdWUoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKCFvdGhlci5nZXRDaGFubmVsKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgY2hhbm5lbF8gPSBvdGhlci5jaGFubmVsXzsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0VmlzaWJpbGl0eVNlY29uZHMoKSAhPSAwKSB7DQogICAgICAgICAgc2V0VmlzaWJpbGl0eVNlY29uZHMob3RoZXIuZ2V0VmlzaWJpbGl0eVNlY29uZHMoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmdldFdhaXRUaW1lU2Vjb25kcygpICE9IDApIHsNCiAgICAgICAgICBzZXRXYWl0VGltZVNlY29uZHMob3RoZXIuZ2V0V2FpdFRpbWVTZWNvbmRzKCkpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5nZXRSZWZTZXF1ZW5jZSgpICE9IDBMKSB7DQogICAgICAgICAgc2V0UmVmU2VxdWVuY2Uob3RoZXIuZ2V0UmVmU2VxdWVuY2UoKSk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLmhhc01vZGlmaWVkTWVzc2FnZSgpKSB7DQogICAgICAgICAgbWVyZ2VNb2RpZmllZE1lc3NhZ2Uob3RoZXIuZ2V0TW9kaWZpZWRNZXNzYWdlKCkpOw0KICAgICAgICB9DQogICAgICAgIHRoaXMubWVyZ2VVbmtub3duRmllbGRzKG90aGVyLnVua25vd25GaWVsZHMpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBib29sZWFuIGlzSW5pdGlhbGl6ZWQoKSB7DQogICAgICAgIHJldHVybiB0cnVlOw0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZWRNZXNzYWdlID0gbnVsbDsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gUEFSU0VSLnBhcnNlUGFydGlhbEZyb20oaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCkgZS5nZXRVbmZpbmlzaGVkTWVzc2FnZSgpOw0KICAgICAgICAgIHRocm93IGUudW53cmFwSU9FeGNlcHRpb24oKTsNCiAgICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgICBpZiAocGFyc2VkTWVzc2FnZSAhPSBudWxsKSB7DQogICAgICAgICAgICBtZXJnZUZyb20ocGFyc2VkTWVzc2FnZSk7DQogICAgICAgICAgfQ0KICAgICAgICB9DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgcmVxdWVzdElEXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldFJlcXVlc3RJRCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXF1ZXN0SURfOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICByZXF1ZXN0SURfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRSZXF1ZXN0SURCeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXF1ZXN0SURfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIHJlcXVlc3RJRF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXF1ZXN0SUQoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICByZXF1ZXN0SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhclJlcXVlc3RJRCgpIHsNCiAgICAgICAgDQogICAgICAgIHJlcXVlc3RJRF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRSZXF1ZXN0SUQoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlcXVlc3RJREJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICByZXF1ZXN0SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IGNsaWVudElEXyA9ICIiOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2xpZW50SUQoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2xpZW50SURfOw0KICAgICAgICBpZiAoIShyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSkgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBicyA9DQogICAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBicy50b1N0cmluZ1V0ZjgoKTsNCiAgICAgICAgICBjbGllbnRJRF8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0Q2xpZW50SURCeXRlcygpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjbGllbnRJRF87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgY2xpZW50SURfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRDbGllbnRJRCgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIGNsaWVudElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDbGllbnRJRCA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckNsaWVudElEKCkgew0KICAgICAgICANCiAgICAgICAgY2xpZW50SURfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0Q2xpZW50SUQoKTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgQ2xpZW50SUQgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2xpZW50SURCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgY2xpZW50SURfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBpbnQgc3RyZWFtUmVxdWVzdFR5cGVEYXRhXyA9IDA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPi5rdWJlbXEuU3RyZWFtUmVxdWVzdFR5cGUgU3RyZWFtUmVxdWVzdFR5cGVEYXRhID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpbnQgZ2V0U3RyZWFtUmVxdWVzdFR5cGVEYXRhVmFsdWUoKSB7DQogICAgICAgIHJldHVybiBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlIFN0cmVhbVJlcXVlc3RUeXBlRGF0YSA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRTdHJlYW1SZXF1ZXN0VHlwZURhdGFWYWx1ZShpbnQgdmFsdWUpIHsNCiAgICAgICAgc3RyZWFtUmVxdWVzdFR5cGVEYXRhXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPi5rdWJlbXEuU3RyZWFtUmVxdWVzdFR5cGUgU3RyZWFtUmVxdWVzdFR5cGVEYXRhID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlIGdldFN0cmVhbVJlcXVlc3RUeXBlRGF0YSgpIHsNCiAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZSByZXN1bHQgPSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlLnZhbHVlT2Yoc3RyZWFtUmVxdWVzdFR5cGVEYXRhXyk7DQogICAgICAgIHJldHVybiByZXN1bHQgPT0gbnVsbCA/IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUmVxdWVzdFR5cGUuVU5SRUNPR05JWkVEIDogcmVzdWx0Ow0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlIFN0cmVhbVJlcXVlc3RUeXBlRGF0YSA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRTdHJlYW1SZXF1ZXN0VHlwZURhdGEoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZSB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgICAgICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgICB9DQogICAgICAgIA0KICAgICAgICBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfID0gdmFsdWUuZ2V0TnVtYmVyKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZSBTdHJlYW1SZXF1ZXN0VHlwZURhdGEgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJTdHJlYW1SZXF1ZXN0VHlwZURhdGEoKSB7DQogICAgICAgIA0KICAgICAgICBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfID0gMDsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGphdmEubGFuZy5PYmplY3QgY2hhbm5lbF8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0Q2hhbm5lbCgpIHsNCiAgICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBjaGFubmVsXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgY2hhbm5lbF8gPSBzOw0KICAgICAgICAgIHJldHVybiBzOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBDaGFubmVsID0gNDs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgICBnZXRDaGFubmVsQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gY2hhbm5lbF87DQogICAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBTdHJpbmcpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcuY29weUZyb21VdGY4KA0KICAgICAgICAgICAgICAgICAgKGphdmEubGFuZy5TdHJpbmcpIHJlZik7DQogICAgICAgICAgY2hhbm5lbF8gPSBiOw0KICAgICAgICAgIHJldHVybiBiOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2hhbm5lbCgNCiAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgDQogICAgICAgIGNoYW5uZWxfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJDaGFubmVsKCkgew0KICAgICAgICANCiAgICAgICAgY2hhbm5lbF8gPSBnZXREZWZhdWx0SW5zdGFuY2UoKS5nZXRDaGFubmVsKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIENoYW5uZWwgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0Q2hhbm5lbEJ5dGVzKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIGNoZWNrQnl0ZVN0cmluZ0lzVXRmOCh2YWx1ZSk7DQogICAgICAgIA0KICAgICAgICBjaGFubmVsXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgaW50IHZpc2liaWxpdHlTZWNvbmRzXyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIFZpc2liaWxpdHlTZWNvbmRzID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpbnQgZ2V0VmlzaWJpbGl0eVNlY29uZHMoKSB7DQogICAgICAgIHJldHVybiB2aXNpYmlsaXR5U2Vjb25kc187DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIFZpc2liaWxpdHlTZWNvbmRzID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFZpc2liaWxpdHlTZWNvbmRzKGludCB2YWx1ZSkgew0KICAgICAgICANCiAgICAgICAgdmlzaWJpbGl0eVNlY29uZHNfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50MzIgVmlzaWJpbGl0eVNlY29uZHMgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJWaXNpYmlsaXR5U2Vjb25kcygpIHsNCiAgICAgICAgDQogICAgICAgIHZpc2liaWxpdHlTZWNvbmRzXyA9IDA7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBpbnQgd2FpdFRpbWVTZWNvbmRzXyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIFdhaXRUaW1lU2Vjb25kcyA9IDY7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW50IGdldFdhaXRUaW1lU2Vjb25kcygpIHsNCiAgICAgICAgcmV0dXJuIHdhaXRUaW1lU2Vjb25kc187DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmludDMyIFdhaXRUaW1lU2Vjb25kcyA9IDY7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRXYWl0VGltZVNlY29uZHMoaW50IHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICB3YWl0VGltZVNlY29uZHNfID0gdmFsdWU7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+aW50MzIgV2FpdFRpbWVTZWNvbmRzID0gNjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyV2FpdFRpbWVTZWNvbmRzKCkgew0KICAgICAgICANCiAgICAgICAgd2FpdFRpbWVTZWNvbmRzXyA9IDA7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBsb25nIHJlZlNlcXVlbmNlXyA7DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnVpbnQ2NCBSZWZTZXF1ZW5jZSA9IDc7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgbG9uZyBnZXRSZWZTZXF1ZW5jZSgpIHsNCiAgICAgICAgcmV0dXJuIHJlZlNlcXVlbmNlXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+dWludDY0IFJlZlNlcXVlbmNlID0gNzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldFJlZlNlcXVlbmNlKGxvbmcgdmFsdWUpIHsNCiAgICAgICAgDQogICAgICAgIHJlZlNlcXVlbmNlXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnVpbnQ2NCBSZWZTZXF1ZW5jZSA9IDc7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhclJlZlNlcXVlbmNlKCkgew0KICAgICAgICANCiAgICAgICAgcmVmU2VxdWVuY2VfID0gMEw7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBtb2RpZmllZE1lc3NhZ2VfID0gbnVsbDsNCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5TaW5nbGVGaWVsZEJ1aWxkZXJWMzwNCiAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlciwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VPckJ1aWxkZXI+IG1vZGlmaWVkTWVzc2FnZUJ1aWxkZXJfOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNb2RpZmllZE1lc3NhZ2UgPSA4OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGJvb2xlYW4gaGFzTW9kaWZpZWRNZXNzYWdlKCkgew0KICAgICAgICByZXR1cm4gbW9kaWZpZWRNZXNzYWdlQnVpbGRlcl8gIT0gbnVsbCB8fCBtb2RpZmllZE1lc3NhZ2VfICE9IG51bGw7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPi5rdWJlbXEuUXVldWVNZXNzYWdlIE1vZGlmaWVkTWVzc2FnZSA9IDg7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgZ2V0TW9kaWZpZWRNZXNzYWdlKCkgew0KICAgICAgICBpZiAobW9kaWZpZWRNZXNzYWdlQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIHJldHVybiBtb2RpZmllZE1lc3NhZ2VfID09IG51bGwgPyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5nZXREZWZhdWx0SW5zdGFuY2UoKSA6IG1vZGlmaWVkTWVzc2FnZV87DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIG1vZGlmaWVkTWVzc2FnZUJ1aWxkZXJfLmdldE1lc3NhZ2UoKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNb2RpZmllZE1lc3NhZ2UgPSA4OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0TW9kaWZpZWRNZXNzYWdlKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlIHZhbHVlKSB7DQogICAgICAgIGlmIChtb2RpZmllZE1lc3NhZ2VCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICAgICAgICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBtb2RpZmllZE1lc3NhZ2VfID0gdmFsdWU7DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgbW9kaWZpZWRNZXNzYWdlQnVpbGRlcl8uc2V0TWVzc2FnZSh2YWx1ZSk7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTW9kaWZpZWRNZXNzYWdlID0gODs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldE1vZGlmaWVkTWVzc2FnZSgNCiAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5CdWlsZGVyIGJ1aWxkZXJGb3JWYWx1ZSkgew0KICAgICAgICBpZiAobW9kaWZpZWRNZXNzYWdlQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIG1vZGlmaWVkTWVzc2FnZV8gPSBidWlsZGVyRm9yVmFsdWUuYnVpbGQoKTsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBtb2RpZmllZE1lc3NhZ2VCdWlsZGVyXy5zZXRNZXNzYWdlKGJ1aWxkZXJGb3JWYWx1ZS5idWlsZCgpKTsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNb2RpZmllZE1lc3NhZ2UgPSA4OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VNb2RpZmllZE1lc3NhZ2UoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgdmFsdWUpIHsNCiAgICAgICAgaWYgKG1vZGlmaWVkTWVzc2FnZUJ1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBpZiAobW9kaWZpZWRNZXNzYWdlXyAhPSBudWxsKSB7DQogICAgICAgICAgICBtb2RpZmllZE1lc3NhZ2VfID0NCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UubmV3QnVpbGRlcihtb2RpZmllZE1lc3NhZ2VfKS5tZXJnZUZyb20odmFsdWUpLmJ1aWxkUGFydGlhbCgpOw0KICAgICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgICBtb2RpZmllZE1lc3NhZ2VfID0gdmFsdWU7DQogICAgICAgICAgfQ0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG1vZGlmaWVkTWVzc2FnZUJ1aWxkZXJfLm1lcmdlRnJvbSh2YWx1ZSk7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTW9kaWZpZWRNZXNzYWdlID0gODs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyTW9kaWZpZWRNZXNzYWdlKCkgew0KICAgICAgICBpZiAobW9kaWZpZWRNZXNzYWdlQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIG1vZGlmaWVkTWVzc2FnZV8gPSBudWxsOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG1vZGlmaWVkTWVzc2FnZV8gPSBudWxsOw0KICAgICAgICAgIG1vZGlmaWVkTWVzc2FnZUJ1aWxkZXJfID0gbnVsbDsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNb2RpZmllZE1lc3NhZ2UgPSA4OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLkJ1aWxkZXIgZ2V0TW9kaWZpZWRNZXNzYWdlQnVpbGRlcigpIHsNCiAgICAgICAgDQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gZ2V0TW9kaWZpZWRNZXNzYWdlRmllbGRCdWlsZGVyKCkuZ2V0QnVpbGRlcigpOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNb2RpZmllZE1lc3NhZ2UgPSA4OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlT3JCdWlsZGVyIGdldE1vZGlmaWVkTWVzc2FnZU9yQnVpbGRlcigpIHsNCiAgICAgICAgaWYgKG1vZGlmaWVkTWVzc2FnZUJ1aWxkZXJfICE9IG51bGwpIHsNCiAgICAgICAgICByZXR1cm4gbW9kaWZpZWRNZXNzYWdlQnVpbGRlcl8uZ2V0TWVzc2FnZU9yQnVpbGRlcigpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHJldHVybiBtb2RpZmllZE1lc3NhZ2VfID09IG51bGwgPw0KICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5nZXREZWZhdWx0SW5zdGFuY2UoKSA6IG1vZGlmaWVkTWVzc2FnZV87DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTW9kaWZpZWRNZXNzYWdlID0gODs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHByaXZhdGUgY29tLmdvb2dsZS5wcm90b2J1Zi5TaW5nbGVGaWVsZEJ1aWxkZXJWMzwNCiAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlciwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VPckJ1aWxkZXI+IA0KICAgICAgICAgIGdldE1vZGlmaWVkTWVzc2FnZUZpZWxkQnVpbGRlcigpIHsNCiAgICAgICAgaWYgKG1vZGlmaWVkTWVzc2FnZUJ1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBtb2RpZmllZE1lc3NhZ2VCdWlsZGVyXyA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLlNpbmdsZUZpZWxkQnVpbGRlclYzPA0KICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlciwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VPckJ1aWxkZXI+KA0KICAgICAgICAgICAgICAgICAgZ2V0TW9kaWZpZWRNZXNzYWdlKCksDQogICAgICAgICAgICAgICAgICBnZXRQYXJlbnRGb3JDaGlsZHJlbigpLA0KICAgICAgICAgICAgICAgICAgaXNDbGVhbigpKTsNCiAgICAgICAgICBtb2RpZmllZE1lc3NhZ2VfID0gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gbW9kaWZpZWRNZXNzYWdlQnVpbGRlcl87DQogICAgICB9DQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBzZXRVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLnNldFVua25vd25GaWVsZHNQcm90bzModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIG1lcmdlVW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5tZXJnZVVua25vd25GaWVsZHModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCg0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfc2NvcGU6a3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0KQ0KICAgIH0NCg0KICAgIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChjbGFzc19zY29wZTprdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QpDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCBERUZBVUxUX0lOU1RBTkNFOw0KICAgIHN0YXRpYyB7DQogICAgICBERUZBVUxUX0lOU1RBTkNFID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QoKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QgZ2V0RGVmYXVsdEluc3RhbmNlKCkgew0KICAgICAgcmV0dXJuIERFRkFVTFRfSU5TVEFOQ0U7DQogICAgfQ0KDQogICAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8U3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3Q+DQogICAgICAgIFBBUlNFUiA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkFic3RyYWN0UGFyc2VyPFN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0PigpIHsNCiAgICAgIHB1YmxpYyBTdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdCBwYXJzZVBhcnRpYWxGcm9tKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRJbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgICByZXR1cm4gbmV3IFN0cmVhbVF1ZXVlTWVzc2FnZXNSZXF1ZXN0KGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICB9DQogICAgfTsNCg0KICAgIHB1YmxpYyBzdGF0aWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8U3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3Q+IHBhcnNlcigpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgQGphdmEubGFuZy5PdmVycmlkZQ0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxTdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdD4gZ2V0UGFyc2VyRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBQQVJTRVI7DQogICAgfQ0KDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3QgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFOw0KICAgIH0NCg0KICB9DQoNCiAgcHVibGljIGludGVyZmFjZSBTdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2VPckJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGludGVyZmFjZV9leHRlbmRzOmt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2UpDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLk1lc3NhZ2VPckJ1aWxkZXIgew0KDQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIGphdmEubGFuZy5TdHJpbmcgZ2V0UmVxdWVzdElEKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRSZXF1ZXN0SURCeXRlcygpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+Lmt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZSBTdHJlYW1SZXF1ZXN0VHlwZURhdGEgPSAyOzwvY29kZT4NCiAgICAgKi8NCiAgICBpbnQgZ2V0U3RyZWFtUmVxdWVzdFR5cGVEYXRhVmFsdWUoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlIFN0cmVhbVJlcXVlc3RUeXBlRGF0YSA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUmVxdWVzdFR5cGUgZ2V0U3RyZWFtUmVxdWVzdFR5cGVEYXRhKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlID0gMzs8L2NvZGU+DQogICAgICovDQogICAgYm9vbGVhbiBoYXNNZXNzYWdlKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZSA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlIGdldE1lc3NhZ2UoKTsNCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlID0gMzs8L2NvZGU+DQogICAgICovDQogICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2VPckJ1aWxkZXIgZ2V0TWVzc2FnZU9yQnVpbGRlcigpOw0KDQogICAgLyoqDQogICAgICogPGNvZGU+Ym9vbCBJc0Vycm9yID0gNDs8L2NvZGU+DQogICAgICovDQogICAgYm9vbGVhbiBnZXRJc0Vycm9yKCk7DQoNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgRXJyb3IgPSA1OzwvY29kZT4NCiAgICAgKi8NCiAgICBqYXZhLmxhbmcuU3RyaW5nIGdldEVycm9yKCk7DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNTs8L2NvZGU+DQogICAgICovDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgIGdldEVycm9yQnl0ZXMoKTsNCiAgfQ0KICAvKioNCiAgICogUHJvdG9idWYgdHlwZSB7QGNvZGUga3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZX0NCiAgICovDQogIHB1YmxpYyAgc3RhdGljIGZpbmFsIGNsYXNzIFN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBleHRlbmRzDQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMyBpbXBsZW1lbnRzDQogICAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQobWVzc2FnZV9pbXBsZW1lbnRzOmt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2UpDQogICAgICBTdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2VPckJ1aWxkZXIgew0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBsb25nIHNlcmlhbFZlcnNpb25VSUQgPSAwTDsNCiAgICAvLyBVc2UgU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlLm5ld0J1aWxkZXIoKSB0byBjb25zdHJ1Y3QuDQogICAgcHJpdmF0ZSBTdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2UoY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlcjw/PiBidWlsZGVyKSB7DQogICAgICBzdXBlcihidWlsZGVyKTsNCiAgICB9DQogICAgcHJpdmF0ZSBTdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2UoKSB7DQogICAgICByZXF1ZXN0SURfID0gIiI7DQogICAgICBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfID0gMDsNCiAgICAgIGlzRXJyb3JfID0gZmFsc2U7DQogICAgICBlcnJvcl8gPSAiIjsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0DQogICAgZ2V0VW5rbm93bkZpZWxkcygpIHsNCiAgICAgIHJldHVybiB0aGlzLnVua25vd25GaWVsZHM7DQogICAgfQ0KICAgIHByaXZhdGUgU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgdGhpcygpOw0KICAgICAgaWYgKGV4dGVuc2lvblJlZ2lzdHJ5ID09IG51bGwpIHsNCiAgICAgICAgdGhyb3cgbmV3IGphdmEubGFuZy5OdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgfQ0KICAgICAgaW50IG11dGFibGVfYml0RmllbGQwXyA9IDA7DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldC5CdWlsZGVyIHVua25vd25GaWVsZHMgPQ0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0Lm5ld0J1aWxkZXIoKTsNCiAgICAgIHRyeSB7DQogICAgICAgIGJvb2xlYW4gZG9uZSA9IGZhbHNlOw0KICAgICAgICB3aGlsZSAoIWRvbmUpIHsNCiAgICAgICAgICBpbnQgdGFnID0gaW5wdXQucmVhZFRhZygpOw0KICAgICAgICAgIHN3aXRjaCAodGFnKSB7DQogICAgICAgICAgICBjYXNlIDA6DQogICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIGRlZmF1bHQ6IHsNCiAgICAgICAgICAgICAgaWYgKCFwYXJzZVVua25vd25GaWVsZFByb3RvMygNCiAgICAgICAgICAgICAgICAgIGlucHV0LCB1bmtub3duRmllbGRzLCBleHRlbnNpb25SZWdpc3RyeSwgdGFnKSkgew0KICAgICAgICAgICAgICAgIGRvbmUgPSB0cnVlOw0KICAgICAgICAgICAgICB9DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAxMDogew0KICAgICAgICAgICAgICBqYXZhLmxhbmcuU3RyaW5nIHMgPSBpbnB1dC5yZWFkU3RyaW5nUmVxdWlyZVV0ZjgoKTsNCg0KICAgICAgICAgICAgICByZXF1ZXN0SURfID0gczsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDE2OiB7DQogICAgICAgICAgICAgIGludCByYXdWYWx1ZSA9IGlucHV0LnJlYWRFbnVtKCk7DQoNCiAgICAgICAgICAgICAgc3RyZWFtUmVxdWVzdFR5cGVEYXRhXyA9IHJhd1ZhbHVlOw0KICAgICAgICAgICAgICBicmVhazsNCiAgICAgICAgICAgIH0NCiAgICAgICAgICAgIGNhc2UgMjY6IHsNCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlciBzdWJCdWlsZGVyID0gbnVsbDsNCiAgICAgICAgICAgICAgaWYgKG1lc3NhZ2VfICE9IG51bGwpIHsNCiAgICAgICAgICAgICAgICBzdWJCdWlsZGVyID0gbWVzc2FnZV8udG9CdWlsZGVyKCk7DQogICAgICAgICAgICAgIH0NCiAgICAgICAgICAgICAgbWVzc2FnZV8gPSBpbnB1dC5yZWFkTWVzc2FnZShpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5wYXJzZXIoKSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgICAgICAgICAgICBpZiAoc3ViQnVpbGRlciAhPSBudWxsKSB7DQogICAgICAgICAgICAgICAgc3ViQnVpbGRlci5tZXJnZUZyb20obWVzc2FnZV8pOw0KICAgICAgICAgICAgICAgIG1lc3NhZ2VfID0gc3ViQnVpbGRlci5idWlsZFBhcnRpYWwoKTsNCiAgICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgICAgY2FzZSAzMjogew0KDQogICAgICAgICAgICAgIGlzRXJyb3JfID0gaW5wdXQucmVhZEJvb2woKTsNCiAgICAgICAgICAgICAgYnJlYWs7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBjYXNlIDQyOiB7DQogICAgICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGlucHV0LnJlYWRTdHJpbmdSZXF1aXJlVXRmOCgpOw0KDQogICAgICAgICAgICAgIGVycm9yXyA9IHM7DQogICAgICAgICAgICAgIGJyZWFrOw0KICAgICAgICAgICAgfQ0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICB0aHJvdyBlLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBjYXRjaCAoamF2YS5pby5JT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgIHRocm93IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbigNCiAgICAgICAgICAgIGUpLnNldFVuZmluaXNoZWRNZXNzYWdlKHRoaXMpOw0KICAgICAgfSBmaW5hbGx5IHsNCiAgICAgICAgdGhpcy51bmtub3duRmllbGRzID0gdW5rbm93bkZpZWxkcy5idWlsZCgpOw0KICAgICAgICBtYWtlRXh0ZW5zaW9uc0ltbXV0YWJsZSgpOw0KICAgICAgfQ0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICBnZXREZXNjcmlwdG9yKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZGVzY3JpcHRvcjsNCiAgICB9DQoNCiAgICBwcm90ZWN0ZWQgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgIGludGVybmFsR2V0RmllbGRBY2Nlc3NvclRhYmxlKCkgew0KICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgLmVuc3VyZUZpZWxkQWNjZXNzb3JzSW5pdGlhbGl6ZWQoDQogICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlLmNsYXNzLCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZS5CdWlsZGVyLmNsYXNzKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBSRVFVRVNUSURfRklFTERfTlVNQkVSID0gMTsNCiAgICBwcml2YXRlIHZvbGF0aWxlIGphdmEubGFuZy5PYmplY3QgcmVxdWVzdElEXzsNCiAgICAvKioNCiAgICAgKiA8Y29kZT5zdHJpbmcgUmVxdWVzdElEID0gMTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0UmVxdWVzdElEKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSByZXF1ZXN0SURfOw0KICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIGphdmEubGFuZy5TdHJpbmcpIHsNCiAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICB9IGVsc2Ugew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPSANCiAgICAgICAgICAgIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgIHJlcXVlc3RJRF8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcNCiAgICAgICAgZ2V0UmVxdWVzdElEQnl0ZXMoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IHJlcXVlc3RJRF87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgcmVxdWVzdElEXyA9IGI7DQogICAgICAgIHJldHVybiBiOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgIH0NCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBTVFJFQU1SRVFVRVNUVFlQRURBVEFfRklFTERfTlVNQkVSID0gMjsNCiAgICBwcml2YXRlIGludCBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfOw0KICAgIC8qKg0KICAgICAqIDxjb2RlPi5rdWJlbXEuU3RyZWFtUmVxdWVzdFR5cGUgU3RyZWFtUmVxdWVzdFR5cGVEYXRhID0gMjs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGludCBnZXRTdHJlYW1SZXF1ZXN0VHlwZURhdGFWYWx1ZSgpIHsNCiAgICAgIHJldHVybiBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlIFN0cmVhbVJlcXVlc3RUeXBlRGF0YSA9IDI7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlIGdldFN0cmVhbVJlcXVlc3RUeXBlRGF0YSgpIHsNCiAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUmVxdWVzdFR5cGUgcmVzdWx0ID0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZS52YWx1ZU9mKHN0cmVhbVJlcXVlc3RUeXBlRGF0YV8pOw0KICAgICAgcmV0dXJuIHJlc3VsdCA9PSBudWxsID8gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZS5VTlJFQ09HTklaRUQgOiByZXN1bHQ7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBmaW5hbCBpbnQgTUVTU0FHRV9GSUVMRF9OVU1CRVIgPSAzOw0KICAgIHByaXZhdGUgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgbWVzc2FnZV87DQogICAgLyoqDQogICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZSA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBib29sZWFuIGhhc01lc3NhZ2UoKSB7DQogICAgICByZXR1cm4gbWVzc2FnZV8gIT0gbnVsbDsNCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZSA9IDM7PC9jb2RlPg0KICAgICAqLw0KICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBnZXRNZXNzYWdlKCkgew0KICAgICAgcmV0dXJuIG1lc3NhZ2VfID09IG51bGwgPyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5nZXREZWZhdWx0SW5zdGFuY2UoKSA6IG1lc3NhZ2VfOw0KICAgIH0NCiAgICAvKioNCiAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlID0gMzs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlT3JCdWlsZGVyIGdldE1lc3NhZ2VPckJ1aWxkZXIoKSB7DQogICAgICByZXR1cm4gZ2V0TWVzc2FnZSgpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBzdGF0aWMgZmluYWwgaW50IElTRVJST1JfRklFTERfTlVNQkVSID0gNDsNCiAgICBwcml2YXRlIGJvb2xlYW4gaXNFcnJvcl87DQogICAgLyoqDQogICAgICogPGNvZGU+Ym9vbCBJc0Vycm9yID0gNDs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGJvb2xlYW4gZ2V0SXNFcnJvcigpIHsNCiAgICAgIHJldHVybiBpc0Vycm9yXzsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGludCBFUlJPUl9GSUVMRF9OVU1CRVIgPSA1Ow0KICAgIHByaXZhdGUgdm9sYXRpbGUgamF2YS5sYW5nLk9iamVjdCBlcnJvcl87DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGphdmEubGFuZy5TdHJpbmcgZ2V0RXJyb3IoKSB7DQogICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGVycm9yXzsNCiAgICAgIGlmIChyZWYgaW5zdGFuY2VvZiBqYXZhLmxhbmcuU3RyaW5nKSB7DQogICAgICAgIHJldHVybiAoamF2YS5sYW5nLlN0cmluZykgcmVmOw0KICAgICAgfSBlbHNlIHsNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGJzID0gDQogICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgIGphdmEubGFuZy5TdHJpbmcgcyA9IGJzLnRvU3RyaW5nVXRmOCgpOw0KICAgICAgICBlcnJvcl8gPSBzOw0KICAgICAgICByZXR1cm4gczsNCiAgICAgIH0NCiAgICB9DQogICAgLyoqDQogICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNTs8L2NvZGU+DQogICAgICovDQogICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICBnZXRFcnJvckJ5dGVzKCkgew0KICAgICAgamF2YS5sYW5nLk9iamVjdCByZWYgPSBlcnJvcl87DQogICAgICBpZiAocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYiA9IA0KICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgZXJyb3JfID0gYjsNCiAgICAgICAgcmV0dXJuIGI7DQogICAgICB9IGVsc2Ugew0KICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgfQ0KICAgIH0NCg0KICAgIHByaXZhdGUgYnl0ZSBtZW1vaXplZElzSW5pdGlhbGl6ZWQgPSAtMTsNCiAgICBwdWJsaWMgZmluYWwgYm9vbGVhbiBpc0luaXRpYWxpemVkKCkgew0KICAgICAgYnl0ZSBpc0luaXRpYWxpemVkID0gbWVtb2l6ZWRJc0luaXRpYWxpemVkOw0KICAgICAgaWYgKGlzSW5pdGlhbGl6ZWQgPT0gMSkgcmV0dXJuIHRydWU7DQogICAgICBpZiAoaXNJbml0aWFsaXplZCA9PSAwKSByZXR1cm4gZmFsc2U7DQoNCiAgICAgIG1lbW9pemVkSXNJbml0aWFsaXplZCA9IDE7DQogICAgICByZXR1cm4gdHJ1ZTsNCiAgICB9DQoNCiAgICBwdWJsaWMgdm9pZCB3cml0ZVRvKGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0gb3V0cHV0KQ0KICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgaWYgKCFnZXRSZXF1ZXN0SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDEsIHJlcXVlc3RJRF8pOw0KICAgICAgfQ0KICAgICAgaWYgKHN0cmVhbVJlcXVlc3RUeXBlRGF0YV8gIT0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZS5TdHJlYW1SZXF1ZXN0VHlwZVVua25vd24uZ2V0TnVtYmVyKCkpIHsNCiAgICAgICAgb3V0cHV0LndyaXRlRW51bSgyLCBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfKTsNCiAgICAgIH0NCiAgICAgIGlmIChtZXNzYWdlXyAhPSBudWxsKSB7DQogICAgICAgIG91dHB1dC53cml0ZU1lc3NhZ2UoMywgZ2V0TWVzc2FnZSgpKTsNCiAgICAgIH0NCiAgICAgIGlmIChpc0Vycm9yXyAhPSBmYWxzZSkgew0KICAgICAgICBvdXRwdXQud3JpdGVCb29sKDQsIGlzRXJyb3JfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0RXJyb3JCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy53cml0ZVN0cmluZyhvdXRwdXQsIDUsIGVycm9yXyk7DQogICAgICB9DQogICAgICB1bmtub3duRmllbGRzLndyaXRlVG8ob3V0cHV0KTsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW50IGdldFNlcmlhbGl6ZWRTaXplKCkgew0KICAgICAgaW50IHNpemUgPSBtZW1vaXplZFNpemU7DQogICAgICBpZiAoc2l6ZSAhPSAtMSkgcmV0dXJuIHNpemU7DQoNCiAgICAgIHNpemUgPSAwOw0KICAgICAgaWYgKCFnZXRSZXF1ZXN0SURCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDEsIHJlcXVlc3RJRF8pOw0KICAgICAgfQ0KICAgICAgaWYgKHN0cmVhbVJlcXVlc3RUeXBlRGF0YV8gIT0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZS5TdHJlYW1SZXF1ZXN0VHlwZVVua25vd24uZ2V0TnVtYmVyKCkpIHsNCiAgICAgICAgc2l6ZSArPSBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkT3V0cHV0U3RyZWFtDQogICAgICAgICAgLmNvbXB1dGVFbnVtU2l6ZSgyLCBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfKTsNCiAgICAgIH0NCiAgICAgIGlmIChtZXNzYWdlXyAhPSBudWxsKSB7DQogICAgICAgIHNpemUgKz0gY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZE91dHB1dFN0cmVhbQ0KICAgICAgICAgIC5jb21wdXRlTWVzc2FnZVNpemUoMywgZ2V0TWVzc2FnZSgpKTsNCiAgICAgIH0NCiAgICAgIGlmIChpc0Vycm9yXyAhPSBmYWxzZSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuQ29kZWRPdXRwdXRTdHJlYW0NCiAgICAgICAgICAuY29tcHV0ZUJvb2xTaXplKDQsIGlzRXJyb3JfKTsNCiAgICAgIH0NCiAgICAgIGlmICghZ2V0RXJyb3JCeXRlcygpLmlzRW1wdHkoKSkgew0KICAgICAgICBzaXplICs9IGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLmNvbXB1dGVTdHJpbmdTaXplKDUsIGVycm9yXyk7DQogICAgICB9DQogICAgICBzaXplICs9IHVua25vd25GaWVsZHMuZ2V0U2VyaWFsaXplZFNpemUoKTsNCiAgICAgIG1lbW9pemVkU2l6ZSA9IHNpemU7DQogICAgICByZXR1cm4gc2l6ZTsNCiAgICB9DQoNCiAgICBAamF2YS5sYW5nLk92ZXJyaWRlDQogICAgcHVibGljIGJvb2xlYW4gZXF1YWxzKGZpbmFsIGphdmEubGFuZy5PYmplY3Qgb2JqKSB7DQogICAgICBpZiAob2JqID09IHRoaXMpIHsNCiAgICAgICByZXR1cm4gdHJ1ZTsNCiAgICAgIH0NCiAgICAgIGlmICghKG9iaiBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlKSkgew0KICAgICAgICByZXR1cm4gc3VwZXIuZXF1YWxzKG9iaik7DQogICAgICB9DQogICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBvdGhlciA9IChpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSkgb2JqOw0KDQogICAgICBib29sZWFuIHJlc3VsdCA9IHRydWU7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0UmVxdWVzdElEKCkNCiAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldFJlcXVlc3RJRCgpKTsNCiAgICAgIHJlc3VsdCA9IHJlc3VsdCAmJiBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfID09IG90aGVyLnN0cmVhbVJlcXVlc3RUeXBlRGF0YV87DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGhhc01lc3NhZ2UoKSA9PSBvdGhlci5oYXNNZXNzYWdlKCkpOw0KICAgICAgaWYgKGhhc01lc3NhZ2UoKSkgew0KICAgICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0TWVzc2FnZSgpDQogICAgICAgICAgICAuZXF1YWxzKG90aGVyLmdldE1lc3NhZ2UoKSk7DQogICAgICB9DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgKGdldElzRXJyb3IoKQ0KICAgICAgICAgID09IG90aGVyLmdldElzRXJyb3IoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgZ2V0RXJyb3IoKQ0KICAgICAgICAgIC5lcXVhbHMob3RoZXIuZ2V0RXJyb3IoKSk7DQogICAgICByZXN1bHQgPSByZXN1bHQgJiYgdW5rbm93bkZpZWxkcy5lcXVhbHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICByZXR1cm4gcmVzdWx0Ow0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgaW50IGhhc2hDb2RlKCkgew0KICAgICAgaWYgKG1lbW9pemVkSGFzaENvZGUgIT0gMCkgew0KICAgICAgICByZXR1cm4gbWVtb2l6ZWRIYXNoQ29kZTsNCiAgICAgIH0NCiAgICAgIGludCBoYXNoID0gNDE7DQogICAgICBoYXNoID0gKDE5ICogaGFzaCkgKyBnZXREZXNjcmlwdG9yKCkuaGFzaENvZGUoKTsNCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIFJFUVVFU1RJRF9GSUVMRF9OVU1CRVI7DQogICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRSZXF1ZXN0SUQoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgU1RSRUFNUkVRVUVTVFRZUEVEQVRBX0ZJRUxEX05VTUJFUjsNCiAgICAgIGhhc2ggPSAoNTMgKiBoYXNoKSArIHN0cmVhbVJlcXVlc3RUeXBlRGF0YV87DQogICAgICBpZiAoaGFzTWVzc2FnZSgpKSB7DQogICAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIE1FU1NBR0VfRklFTERfTlVNQkVSOw0KICAgICAgICBoYXNoID0gKDUzICogaGFzaCkgKyBnZXRNZXNzYWdlKCkuaGFzaENvZGUoKTsNCiAgICAgIH0NCiAgICAgIGhhc2ggPSAoMzcgKiBoYXNoKSArIElTRVJST1JfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnRlcm5hbC5oYXNoQm9vbGVhbigNCiAgICAgICAgICBnZXRJc0Vycm9yKCkpOw0KICAgICAgaGFzaCA9ICgzNyAqIGhhc2gpICsgRVJST1JfRklFTERfTlVNQkVSOw0KICAgICAgaGFzaCA9ICg1MyAqIGhhc2gpICsgZ2V0RXJyb3IoKS5oYXNoQ29kZSgpOw0KICAgICAgaGFzaCA9ICgyOSAqIGhhc2gpICsgdW5rbm93bkZpZWxkcy5oYXNoQ29kZSgpOw0KICAgICAgbWVtb2l6ZWRIYXNoQ29kZSA9IGhhc2g7DQogICAgICByZXR1cm4gaGFzaDsNCiAgICB9DQoNCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5uaW8uQnl0ZUJ1ZmZlciBkYXRhKQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBqYXZhLm5pby5CeXRlQnVmZmVyIGRhdGEsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gew0KICAgICAgcmV0dXJuIFBBUlNFUi5wYXJzZUZyb20oZGF0YSwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZUZyb20oDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZUZyb20oYnl0ZVtdIGRhdGEpDQogICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gUEFSU0VSLnBhcnNlRnJvbShkYXRhKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZUZyb20oDQogICAgICAgIGJ5dGVbXSBkYXRhLA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkV4dGVuc2lvblJlZ2lzdHJ5TGl0ZSBleHRlbnNpb25SZWdpc3RyeSkNCiAgICAgICAgdGhyb3dzIGNvbS5nb29nbGUucHJvdG9idWYuSW52YWxpZFByb3RvY29sQnVmZmVyRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBQQVJTRVIucGFyc2VGcm9tKGRhdGEsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZUZyb20oamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCkNCiAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgcmV0dXJuIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzDQogICAgICAgICAgLnBhcnNlV2l0aElPRXhjZXB0aW9uKFBBUlNFUiwgaW5wdXQpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgamF2YS5pby5JbnB1dFN0cmVhbSBpbnB1dCwNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZVdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcGFyc2VEZWxpbWl0ZWRGcm9tKGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQpDQogICAgICAgIHRocm93cyBqYXZhLmlvLklPRXhjZXB0aW9uIHsNCiAgICAgIHJldHVybiBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgIC5wYXJzZURlbGltaXRlZFdpdGhJT0V4Y2VwdGlvbihQQVJTRVIsIGlucHV0KTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZURlbGltaXRlZEZyb20oDQogICAgICAgIGphdmEuaW8uSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VEZWxpbWl0ZWRXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCiAgICBwdWJsaWMgc3RhdGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHBhcnNlRnJvbSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCk7DQogICAgfQ0KICAgIHB1YmxpYyBzdGF0aWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcGFyc2VGcm9tKA0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICB0aHJvd3MgamF2YS5pby5JT0V4Y2VwdGlvbiB7DQogICAgICByZXR1cm4gY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMNCiAgICAgICAgICAucGFyc2VXaXRoSU9FeGNlcHRpb24oUEFSU0VSLCBpbnB1dCwgZXh0ZW5zaW9uUmVnaXN0cnkpOw0KICAgIH0NCg0KICAgIHB1YmxpYyBCdWlsZGVyIG5ld0J1aWxkZXJGb3JUeXBlKCkgeyByZXR1cm4gbmV3QnVpbGRlcigpOyB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRS50b0J1aWxkZXIoKTsNCiAgICB9DQogICAgcHVibGljIHN0YXRpYyBCdWlsZGVyIG5ld0J1aWxkZXIoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgcHJvdG90eXBlKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRS50b0J1aWxkZXIoKS5tZXJnZUZyb20ocHJvdG90eXBlKTsNCiAgICB9DQogICAgcHVibGljIEJ1aWxkZXIgdG9CdWlsZGVyKCkgew0KICAgICAgcmV0dXJuIHRoaXMgPT0gREVGQVVMVF9JTlNUQU5DRQ0KICAgICAgICAgID8gbmV3IEJ1aWxkZXIoKSA6IG5ldyBCdWlsZGVyKCkubWVyZ2VGcm9tKHRoaXMpOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwcm90ZWN0ZWQgQnVpbGRlciBuZXdCdWlsZGVyRm9yVHlwZSgNCiAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlclBhcmVudCBwYXJlbnQpIHsNCiAgICAgIEJ1aWxkZXIgYnVpbGRlciA9IG5ldyBCdWlsZGVyKHBhcmVudCk7DQogICAgICByZXR1cm4gYnVpbGRlcjsNCiAgICB9DQogICAgLyoqDQogICAgICogUHJvdG9idWYgdHlwZSB7QGNvZGUga3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZX0NCiAgICAgKi8NCiAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNsYXNzIEJ1aWxkZXIgZXh0ZW5kcw0KICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5CdWlsZGVyPEJ1aWxkZXI+IGltcGxlbWVudHMNCiAgICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfaW1wbGVtZW50czprdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlKQ0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZU9yQnVpbGRlciB7DQogICAgICBwdWJsaWMgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgICAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLmludGVybmFsX3N0YXRpY19rdWJlbXFfU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlX2Rlc2NyaXB0b3I7DQogICAgICB9DQoNCiAgICAgIHByb3RlY3RlZCBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgICAgICBpbnRlcm5hbEdldEZpZWxkQWNjZXNzb3JUYWJsZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZmllbGRBY2Nlc3NvclRhYmxlDQogICAgICAgICAgICAuZW5zdXJlRmllbGRBY2Nlc3NvcnNJbml0aWFsaXplZCgNCiAgICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZS5jbGFzcywgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2UuQnVpbGRlci5jbGFzcyk7DQogICAgICB9DQoNCiAgICAgIC8vIENvbnN0cnVjdCB1c2luZyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZS5uZXdCdWlsZGVyKCkNCiAgICAgIHByaXZhdGUgQnVpbGRlcigpIHsNCiAgICAgICAgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIEJ1aWxkZXIoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuQnVpbGRlclBhcmVudCBwYXJlbnQpIHsNCiAgICAgICAgc3VwZXIocGFyZW50KTsNCiAgICAgICAgbWF5YmVGb3JjZUJ1aWxkZXJJbml0aWFsaXphdGlvbigpOw0KICAgICAgfQ0KICAgICAgcHJpdmF0ZSB2b2lkIG1heWJlRm9yY2VCdWlsZGVySW5pdGlhbGl6YXRpb24oKSB7DQogICAgICAgIGlmIChjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMw0KICAgICAgICAgICAgICAgIC5hbHdheXNVc2VGaWVsZEJ1aWxkZXJzKSB7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyKCkgew0KICAgICAgICBzdXBlci5jbGVhcigpOw0KICAgICAgICByZXF1ZXN0SURfID0gIiI7DQoNCiAgICAgICAgc3RyZWFtUmVxdWVzdFR5cGVEYXRhXyA9IDA7DQoNCiAgICAgICAgaWYgKG1lc3NhZ2VCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgbWVzc2FnZV8gPSBudWxsOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG1lc3NhZ2VfID0gbnVsbDsNCiAgICAgICAgICBtZXNzYWdlQnVpbGRlcl8gPSBudWxsOw0KICAgICAgICB9DQogICAgICAgIGlzRXJyb3JfID0gZmFsc2U7DQoNCiAgICAgICAgZXJyb3JfID0gIiI7DQoNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICAgICAgICBnZXREZXNjcmlwdG9yRm9yVHlwZSgpIHsNCiAgICAgICAgcmV0dXJuIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZGVzY3JpcHRvcjsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlIGdldERlZmF1bHRJbnN0YW5jZUZvclR5cGUoKSB7DQogICAgICAgIHJldHVybiBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZS5nZXREZWZhdWx0SW5zdGFuY2UoKTsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlIGJ1aWxkKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSByZXN1bHQgPSBidWlsZFBhcnRpYWwoKTsNCiAgICAgICAgaWYgKCFyZXN1bHQuaXNJbml0aWFsaXplZCgpKSB7DQogICAgICAgICAgdGhyb3cgbmV3VW5pbml0aWFsaXplZE1lc3NhZ2VFeGNlcHRpb24ocmVzdWx0KTsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgYnVpbGRQYXJ0aWFsKCkgew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSByZXN1bHQgPSBuZXcgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2UodGhpcyk7DQogICAgICAgIHJlc3VsdC5yZXF1ZXN0SURfID0gcmVxdWVzdElEXzsNCiAgICAgICAgcmVzdWx0LnN0cmVhbVJlcXVlc3RUeXBlRGF0YV8gPSBzdHJlYW1SZXF1ZXN0VHlwZURhdGFfOw0KICAgICAgICBpZiAobWVzc2FnZUJ1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICByZXN1bHQubWVzc2FnZV8gPSBtZXNzYWdlXzsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXN1bHQubWVzc2FnZV8gPSBtZXNzYWdlQnVpbGRlcl8uYnVpbGQoKTsNCiAgICAgICAgfQ0KICAgICAgICByZXN1bHQuaXNFcnJvcl8gPSBpc0Vycm9yXzsNCiAgICAgICAgcmVzdWx0LmVycm9yXyA9IGVycm9yXzsNCiAgICAgICAgb25CdWlsdCgpOw0KICAgICAgICByZXR1cm4gcmVzdWx0Ow0KICAgICAgfQ0KDQogICAgICBwdWJsaWMgQnVpbGRlciBjbG9uZSgpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5jbG9uZSgpOw0KICAgICAgfQ0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RmllbGQoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWVsZERlc2NyaXB0b3IgZmllbGQsDQogICAgICAgICAgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhckZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJGaWVsZChmaWVsZCk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck9uZW9mKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuT25lb2ZEZXNjcmlwdG9yIG9uZW9mKSB7DQogICAgICAgIHJldHVybiAoQnVpbGRlcikgc3VwZXIuY2xlYXJPbmVvZihvbmVvZik7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGludCBpbmRleCwgamF2YS5sYW5nLk9iamVjdCB2YWx1ZSkgew0KICAgICAgICByZXR1cm4gKEJ1aWxkZXIpIHN1cGVyLnNldFJlcGVhdGVkRmllbGQoZmllbGQsIGluZGV4LCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBhZGRSZXBlYXRlZEZpZWxkKA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmllbGREZXNjcmlwdG9yIGZpZWxkLA0KICAgICAgICAgIGphdmEubGFuZy5PYmplY3QgdmFsdWUpIHsNCiAgICAgICAgcmV0dXJuIChCdWlsZGVyKSBzdXBlci5hZGRSZXBlYXRlZEZpZWxkKGZpZWxkLCB2YWx1ZSk7DQogICAgICB9DQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZUZyb20oY29tLmdvb2dsZS5wcm90b2J1Zi5NZXNzYWdlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciBpbnN0YW5jZW9mIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlKSB7DQogICAgICAgICAgcmV0dXJuIG1lcmdlRnJvbSgoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2Upb3RoZXIpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIHN1cGVyLm1lcmdlRnJvbShvdGhlcik7DQogICAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgcHVibGljIEJ1aWxkZXIgbWVyZ2VGcm9tKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlIG90aGVyKSB7DQogICAgICAgIGlmIChvdGhlciA9PSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZS5nZXREZWZhdWx0SW5zdGFuY2UoKSkgcmV0dXJuIHRoaXM7DQogICAgICAgIGlmICghb3RoZXIuZ2V0UmVxdWVzdElEKCkuaXNFbXB0eSgpKSB7DQogICAgICAgICAgcmVxdWVzdElEXyA9IG90aGVyLnJlcXVlc3RJRF87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgaWYgKG90aGVyLnN0cmVhbVJlcXVlc3RUeXBlRGF0YV8gIT0gMCkgew0KICAgICAgICAgIHNldFN0cmVhbVJlcXVlc3RUeXBlRGF0YVZhbHVlKG90aGVyLmdldFN0cmVhbVJlcXVlc3RUeXBlRGF0YVZhbHVlKCkpOw0KICAgICAgICB9DQogICAgICAgIGlmIChvdGhlci5oYXNNZXNzYWdlKCkpIHsNCiAgICAgICAgICBtZXJnZU1lc3NhZ2Uob3RoZXIuZ2V0TWVzc2FnZSgpKTsNCiAgICAgICAgfQ0KICAgICAgICBpZiAob3RoZXIuZ2V0SXNFcnJvcigpICE9IGZhbHNlKSB7DQogICAgICAgICAgc2V0SXNFcnJvcihvdGhlci5nZXRJc0Vycm9yKCkpOw0KICAgICAgICB9DQogICAgICAgIGlmICghb3RoZXIuZ2V0RXJyb3IoKS5pc0VtcHR5KCkpIHsNCiAgICAgICAgICBlcnJvcl8gPSBvdGhlci5lcnJvcl87DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy5tZXJnZVVua25vd25GaWVsZHMob3RoZXIudW5rbm93bkZpZWxkcyk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHVibGljIGZpbmFsIGJvb2xlYW4gaXNJbml0aWFsaXplZCgpIHsNCiAgICAgICAgcmV0dXJuIHRydWU7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBCdWlsZGVyIG1lcmdlRnJvbSgNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkNvZGVkSW5wdXRTdHJlYW0gaW5wdXQsDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5FeHRlbnNpb25SZWdpc3RyeUxpdGUgZXh0ZW5zaW9uUmVnaXN0cnkpDQogICAgICAgICAgdGhyb3dzIGphdmEuaW8uSU9FeGNlcHRpb24gew0KICAgICAgICBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBwYXJzZWRNZXNzYWdlID0gbnVsbDsNCiAgICAgICAgdHJ5IHsNCiAgICAgICAgICBwYXJzZWRNZXNzYWdlID0gUEFSU0VSLnBhcnNlUGFydGlhbEZyb20oaW5wdXQsIGV4dGVuc2lvblJlZ2lzdHJ5KTsNCiAgICAgICAgfSBjYXRjaCAoY29tLmdvb2dsZS5wcm90b2J1Zi5JbnZhbGlkUHJvdG9jb2xCdWZmZXJFeGNlcHRpb24gZSkgew0KICAgICAgICAgIHBhcnNlZE1lc3NhZ2UgPSAoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2UpIGUuZ2V0VW5maW5pc2hlZE1lc3NhZ2UoKTsNCiAgICAgICAgICB0aHJvdyBlLnVud3JhcElPRXhjZXB0aW9uKCk7DQogICAgICAgIH0gZmluYWxseSB7DQogICAgICAgICAgaWYgKHBhcnNlZE1lc3NhZ2UgIT0gbnVsbCkgew0KICAgICAgICAgICAgbWVyZ2VGcm9tKHBhcnNlZE1lc3NhZ2UpOw0KICAgICAgICAgIH0NCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBqYXZhLmxhbmcuT2JqZWN0IHJlcXVlc3RJRF8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgamF2YS5sYW5nLlN0cmluZyBnZXRSZXF1ZXN0SUQoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVxdWVzdElEXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgcmVxdWVzdElEXyA9IHM7DQogICAgICAgICAgcmV0dXJuIHM7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChqYXZhLmxhbmcuU3RyaW5nKSByZWY7DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nDQogICAgICAgICAgZ2V0UmVxdWVzdElEQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gcmVxdWVzdElEXzsNCiAgICAgICAgaWYgKHJlZiBpbnN0YW5jZW9mIFN0cmluZykgew0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZyBiID0gDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZy5jb3B5RnJvbVV0ZjgoDQogICAgICAgICAgICAgICAgICAoamF2YS5sYW5nLlN0cmluZykgcmVmKTsNCiAgICAgICAgICByZXF1ZXN0SURfID0gYjsNCiAgICAgICAgICByZXR1cm4gYjsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZykgcmVmOw0KICAgICAgICB9DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0UmVxdWVzdElEKA0KICAgICAgICAgIGphdmEubGFuZy5TdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICANCiAgICAgICAgcmVxdWVzdElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPnN0cmluZyBSZXF1ZXN0SUQgPSAxOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJSZXF1ZXN0SUQoKSB7DQogICAgICAgIA0KICAgICAgICByZXF1ZXN0SURfID0gZ2V0RGVmYXVsdEluc3RhbmNlKCkuZ2V0UmVxdWVzdElEKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIFJlcXVlc3RJRCA9IDE7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBzZXRSZXF1ZXN0SURCeXRlcygNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgfQ0KICBjaGVja0J5dGVTdHJpbmdJc1V0ZjgodmFsdWUpOw0KICAgICAgICANCiAgICAgICAgcmVxdWVzdElEXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgaW50IHN0cmVhbVJlcXVlc3RUeXBlRGF0YV8gPSAwOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlIFN0cmVhbVJlcXVlc3RUeXBlRGF0YSA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW50IGdldFN0cmVhbVJlcXVlc3RUeXBlRGF0YVZhbHVlKCkgew0KICAgICAgICByZXR1cm4gc3RyZWFtUmVxdWVzdFR5cGVEYXRhXzsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZSBTdHJlYW1SZXF1ZXN0VHlwZURhdGEgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0U3RyZWFtUmVxdWVzdFR5cGVEYXRhVmFsdWUoaW50IHZhbHVlKSB7DQogICAgICAgIHN0cmVhbVJlcXVlc3RUeXBlRGF0YV8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlIFN0cmVhbVJlcXVlc3RUeXBlRGF0YSA9IDI7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZSBnZXRTdHJlYW1SZXF1ZXN0VHlwZURhdGEoKSB7DQogICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUmVxdWVzdFR5cGUgcmVzdWx0ID0gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZS52YWx1ZU9mKHN0cmVhbVJlcXVlc3RUeXBlRGF0YV8pOw0KICAgICAgICByZXR1cm4gcmVzdWx0ID09IG51bGwgPyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVJlcXVlc3RUeXBlLlVOUkVDT0dOSVpFRCA6IHJlc3VsdDsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5TdHJlYW1SZXF1ZXN0VHlwZSBTdHJlYW1SZXF1ZXN0VHlwZURhdGEgPSAyOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0U3RyZWFtUmVxdWVzdFR5cGVEYXRhKGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUmVxdWVzdFR5cGUgdmFsdWUpIHsNCiAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICAgICAgICB0aHJvdyBuZXcgTnVsbFBvaW50ZXJFeGNlcHRpb24oKTsNCiAgICAgICAgfQ0KICAgICAgICANCiAgICAgICAgc3RyZWFtUmVxdWVzdFR5cGVEYXRhXyA9IHZhbHVlLmdldE51bWJlcigpOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPi5rdWJlbXEuU3RyZWFtUmVxdWVzdFR5cGUgU3RyZWFtUmVxdWVzdFR5cGVEYXRhID0gMjs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIGNsZWFyU3RyZWFtUmVxdWVzdFR5cGVEYXRhKCkgew0KICAgICAgICANCiAgICAgICAgc3RyZWFtUmVxdWVzdFR5cGVEYXRhXyA9IDA7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCg0KICAgICAgcHJpdmF0ZSBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZSBtZXNzYWdlXyA9IG51bGw7DQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuU2luZ2xlRmllbGRCdWlsZGVyVjM8DQogICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLkJ1aWxkZXIsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlT3JCdWlsZGVyPiBtZXNzYWdlQnVpbGRlcl87DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPi5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2UgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGJvb2xlYW4gaGFzTWVzc2FnZSgpIHsNCiAgICAgICAgcmV0dXJuIG1lc3NhZ2VCdWlsZGVyXyAhPSBudWxsIHx8IG1lc3NhZ2VfICE9IG51bGw7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPi5rdWJlbXEuUXVldWVNZXNzYWdlIE1lc3NhZ2UgPSAzOzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlIGdldE1lc3NhZ2UoKSB7DQogICAgICAgIGlmIChtZXNzYWdlQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIHJldHVybiBtZXNzYWdlXyA9PSBudWxsID8gaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuZ2V0RGVmYXVsdEluc3RhbmNlKCkgOiBtZXNzYWdlXzsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gbWVzc2FnZUJ1aWxkZXJfLmdldE1lc3NhZ2UoKTsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldE1lc3NhZ2UoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgdmFsdWUpIHsNCiAgICAgICAgaWYgKG1lc3NhZ2VCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgaWYgKHZhbHVlID09IG51bGwpIHsNCiAgICAgICAgICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICAgICAgICAgIH0NCiAgICAgICAgICBtZXNzYWdlXyA9IHZhbHVlOw0KICAgICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgIG1lc3NhZ2VCdWlsZGVyXy5zZXRNZXNzYWdlKHZhbHVlKTsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldE1lc3NhZ2UoDQogICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UuQnVpbGRlciBidWlsZGVyRm9yVmFsdWUpIHsNCiAgICAgICAgaWYgKG1lc3NhZ2VCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgbWVzc2FnZV8gPSBidWlsZGVyRm9yVmFsdWUuYnVpbGQoKTsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBtZXNzYWdlQnVpbGRlcl8uc2V0TWVzc2FnZShidWlsZGVyRm9yVmFsdWUuYnVpbGQoKSk7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZSA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBtZXJnZU1lc3NhZ2UoaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UgdmFsdWUpIHsNCiAgICAgICAgaWYgKG1lc3NhZ2VCdWlsZGVyXyA9PSBudWxsKSB7DQogICAgICAgICAgaWYgKG1lc3NhZ2VfICE9IG51bGwpIHsNCiAgICAgICAgICAgIG1lc3NhZ2VfID0NCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UubmV3QnVpbGRlcihtZXNzYWdlXykubWVyZ2VGcm9tKHZhbHVlKS5idWlsZFBhcnRpYWwoKTsNCiAgICAgICAgICB9IGVsc2Ugew0KICAgICAgICAgICAgbWVzc2FnZV8gPSB2YWx1ZTsNCiAgICAgICAgICB9DQogICAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgbWVzc2FnZUJ1aWxkZXJfLm1lcmdlRnJvbSh2YWx1ZSk7DQogICAgICAgIH0NCg0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZSA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhck1lc3NhZ2UoKSB7DQogICAgICAgIGlmIChtZXNzYWdlQnVpbGRlcl8gPT0gbnVsbCkgew0KICAgICAgICAgIG1lc3NhZ2VfID0gbnVsbDsNCiAgICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICBtZXNzYWdlXyA9IG51bGw7DQogICAgICAgICAgbWVzc2FnZUJ1aWxkZXJfID0gbnVsbDsNCiAgICAgICAgfQ0KDQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZS5CdWlsZGVyIGdldE1lc3NhZ2VCdWlsZGVyKCkgew0KICAgICAgICANCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiBnZXRNZXNzYWdlRmllbGRCdWlsZGVyKCkuZ2V0QnVpbGRlcigpOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT4ua3ViZW1xLlF1ZXVlTWVzc2FnZSBNZXNzYWdlID0gMzs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlF1ZXVlTWVzc2FnZU9yQnVpbGRlciBnZXRNZXNzYWdlT3JCdWlsZGVyKCkgew0KICAgICAgICBpZiAobWVzc2FnZUJ1aWxkZXJfICE9IG51bGwpIHsNCiAgICAgICAgICByZXR1cm4gbWVzc2FnZUJ1aWxkZXJfLmdldE1lc3NhZ2VPckJ1aWxkZXIoKTsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gbWVzc2FnZV8gPT0gbnVsbCA/DQogICAgICAgICAgICAgIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLmdldERlZmF1bHRJbnN0YW5jZSgpIDogbWVzc2FnZV87DQogICAgICAgIH0NCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+Lmt1YmVtcS5RdWV1ZU1lc3NhZ2UgTWVzc2FnZSA9IDM7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwcml2YXRlIGNvbS5nb29nbGUucHJvdG9idWYuU2luZ2xlRmllbGRCdWlsZGVyVjM8DQogICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLkJ1aWxkZXIsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlT3JCdWlsZGVyPiANCiAgICAgICAgICBnZXRNZXNzYWdlRmllbGRCdWlsZGVyKCkgew0KICAgICAgICBpZiAobWVzc2FnZUJ1aWxkZXJfID09IG51bGwpIHsNCiAgICAgICAgICBtZXNzYWdlQnVpbGRlcl8gPSBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5TaW5nbGVGaWVsZEJ1aWxkZXJWMzwNCiAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5RdWV1ZU1lc3NhZ2UsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlLkJ1aWxkZXIsIGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuUXVldWVNZXNzYWdlT3JCdWlsZGVyPigNCiAgICAgICAgICAgICAgICAgIGdldE1lc3NhZ2UoKSwNCiAgICAgICAgICAgICAgICAgIGdldFBhcmVudEZvckNoaWxkcmVuKCksDQogICAgICAgICAgICAgICAgICBpc0NsZWFuKCkpOw0KICAgICAgICAgIG1lc3NhZ2VfID0gbnVsbDsNCiAgICAgICAgfQ0KICAgICAgICByZXR1cm4gbWVzc2FnZUJ1aWxkZXJfOw0KICAgICAgfQ0KDQogICAgICBwcml2YXRlIGJvb2xlYW4gaXNFcnJvcl8gOw0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIElzRXJyb3IgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGJvb2xlYW4gZ2V0SXNFcnJvcigpIHsNCiAgICAgICAgcmV0dXJuIGlzRXJyb3JfOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5ib29sIElzRXJyb3IgPSA0OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0SXNFcnJvcihib29sZWFuIHZhbHVlKSB7DQogICAgICAgIA0KICAgICAgICBpc0Vycm9yXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICAvKioNCiAgICAgICAqIDxjb2RlPmJvb2wgSXNFcnJvciA9IDQ7PC9jb2RlPg0KICAgICAgICovDQogICAgICBwdWJsaWMgQnVpbGRlciBjbGVhcklzRXJyb3IoKSB7DQogICAgICAgIA0KICAgICAgICBpc0Vycm9yXyA9IGZhbHNlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQoNCiAgICAgIHByaXZhdGUgamF2YS5sYW5nLk9iamVjdCBlcnJvcl8gPSAiIjsNCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBqYXZhLmxhbmcuU3RyaW5nIGdldEVycm9yKCkgew0KICAgICAgICBqYXZhLmxhbmcuT2JqZWN0IHJlZiA9IGVycm9yXzsNCiAgICAgICAgaWYgKCEocmVmIGluc3RhbmNlb2YgamF2YS5sYW5nLlN0cmluZykpIHsNCiAgICAgICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcgYnMgPQ0KICAgICAgICAgICAgICAoY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nKSByZWY7DQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyBzID0gYnMudG9TdHJpbmdVdGY4KCk7DQogICAgICAgICAgZXJyb3JfID0gczsNCiAgICAgICAgICByZXR1cm4gczsNCiAgICAgICAgfSBlbHNlIHsNCiAgICAgICAgICByZXR1cm4gKGphdmEubGFuZy5TdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXJyb3IgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuQnl0ZVN0cmluZw0KICAgICAgICAgIGdldEVycm9yQnl0ZXMoKSB7DQogICAgICAgIGphdmEubGFuZy5PYmplY3QgcmVmID0gZXJyb3JfOw0KICAgICAgICBpZiAocmVmIGluc3RhbmNlb2YgU3RyaW5nKSB7DQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIGIgPSANCiAgICAgICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nLmNvcHlGcm9tVXRmOCgNCiAgICAgICAgICAgICAgICAgIChqYXZhLmxhbmcuU3RyaW5nKSByZWYpOw0KICAgICAgICAgIGVycm9yXyA9IGI7DQogICAgICAgICAgcmV0dXJuIGI7DQogICAgICAgIH0gZWxzZSB7DQogICAgICAgICAgcmV0dXJuIChjb20uZ29vZ2xlLnByb3RvYnVmLkJ5dGVTdHJpbmcpIHJlZjsNCiAgICAgICAgfQ0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXJyb3IgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgc2V0RXJyb3IoDQogICAgICAgICAgamF2YS5sYW5nLlN0cmluZyB2YWx1ZSkgew0KICAgICAgICBpZiAodmFsdWUgPT0gbnVsbCkgew0KICAgIHRocm93IG5ldyBOdWxsUG9pbnRlckV4Y2VwdGlvbigpOw0KICB9DQogIA0KICAgICAgICBlcnJvcl8gPSB2YWx1ZTsNCiAgICAgICAgb25DaGFuZ2VkKCk7DQogICAgICAgIHJldHVybiB0aGlzOw0KICAgICAgfQ0KICAgICAgLyoqDQogICAgICAgKiA8Y29kZT5zdHJpbmcgRXJyb3IgPSA1OzwvY29kZT4NCiAgICAgICAqLw0KICAgICAgcHVibGljIEJ1aWxkZXIgY2xlYXJFcnJvcigpIHsNCiAgICAgICAgDQogICAgICAgIGVycm9yXyA9IGdldERlZmF1bHRJbnN0YW5jZSgpLmdldEVycm9yKCk7DQogICAgICAgIG9uQ2hhbmdlZCgpOw0KICAgICAgICByZXR1cm4gdGhpczsNCiAgICAgIH0NCiAgICAgIC8qKg0KICAgICAgICogPGNvZGU+c3RyaW5nIEVycm9yID0gNTs8L2NvZGU+DQogICAgICAgKi8NCiAgICAgIHB1YmxpYyBCdWlsZGVyIHNldEVycm9yQnl0ZXMoDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nIHZhbHVlKSB7DQogICAgICAgIGlmICh2YWx1ZSA9PSBudWxsKSB7DQogICAgdGhyb3cgbmV3IE51bGxQb2ludGVyRXhjZXB0aW9uKCk7DQogIH0NCiAgY2hlY2tCeXRlU3RyaW5nSXNVdGY4KHZhbHVlKTsNCiAgICAgICAgDQogICAgICAgIGVycm9yXyA9IHZhbHVlOw0KICAgICAgICBvbkNoYW5nZWQoKTsNCiAgICAgICAgcmV0dXJuIHRoaXM7DQogICAgICB9DQogICAgICBwdWJsaWMgZmluYWwgQnVpbGRlciBzZXRVbmtub3duRmllbGRzKA0KICAgICAgICAgIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuVW5rbm93bkZpZWxkU2V0IHVua25vd25GaWVsZHMpIHsNCiAgICAgICAgcmV0dXJuIHN1cGVyLnNldFVua25vd25GaWVsZHNQcm90bzModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCiAgICAgIHB1YmxpYyBmaW5hbCBCdWlsZGVyIG1lcmdlVW5rbm93bkZpZWxkcygNCiAgICAgICAgICBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlVua25vd25GaWVsZFNldCB1bmtub3duRmllbGRzKSB7DQogICAgICAgIHJldHVybiBzdXBlci5tZXJnZVVua25vd25GaWVsZHModW5rbm93bkZpZWxkcyk7DQogICAgICB9DQoNCg0KICAgICAgLy8gQEBwcm90b2NfaW5zZXJ0aW9uX3BvaW50KGJ1aWxkZXJfc2NvcGU6a3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSkNCiAgICB9DQoNCiAgICAvLyBAQHByb3RvY19pbnNlcnRpb25fcG9pbnQoY2xhc3Nfc2NvcGU6a3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSkNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBERUZBVUxUX0lOU1RBTkNFOw0KICAgIHN0YXRpYyB7DQogICAgICBERUZBVUxUX0lOU1RBTkNFID0gbmV3IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXEuU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlKCk7DQogICAgfQ0KDQogICAgcHVibGljIHN0YXRpYyBpby5rdWJlbXEuc2RrLmdycGMuS3ViZW1xLlN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZSBnZXREZWZhdWx0SW5zdGFuY2UoKSB7DQogICAgICByZXR1cm4gREVGQVVMVF9JTlNUQU5DRTsNCiAgICB9DQoNCiAgICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLlBhcnNlcjxTdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2U+DQogICAgICAgIFBBUlNFUiA9IG5ldyBjb20uZ29vZ2xlLnByb3RvYnVmLkFic3RyYWN0UGFyc2VyPFN0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZT4oKSB7DQogICAgICBwdWJsaWMgU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlIHBhcnNlUGFydGlhbEZyb20oDQogICAgICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5Db2RlZElucHV0U3RyZWFtIGlucHV0LA0KICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnlMaXRlIGV4dGVuc2lvblJlZ2lzdHJ5KQ0KICAgICAgICAgIHRocm93cyBjb20uZ29vZ2xlLnByb3RvYnVmLkludmFsaWRQcm90b2NvbEJ1ZmZlckV4Y2VwdGlvbiB7DQogICAgICAgIHJldHVybiBuZXcgU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlKGlucHV0LCBleHRlbnNpb25SZWdpc3RyeSk7DQogICAgICB9DQogICAgfTsNCg0KICAgIHB1YmxpYyBzdGF0aWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8U3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlPiBwYXJzZXIoKSB7DQogICAgICByZXR1cm4gUEFSU0VSOw0KICAgIH0NCg0KICAgIEBqYXZhLmxhbmcuT3ZlcnJpZGUNCiAgICBwdWJsaWMgY29tLmdvb2dsZS5wcm90b2J1Zi5QYXJzZXI8U3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlPiBnZXRQYXJzZXJGb3JUeXBlKCkgew0KICAgICAgcmV0dXJuIFBBUlNFUjsNCiAgICB9DQoNCiAgICBwdWJsaWMgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2UgZ2V0RGVmYXVsdEluc3RhbmNlRm9yVHlwZSgpIHsNCiAgICAgIHJldHVybiBERUZBVUxUX0lOU1RBTkNFOw0KICAgIH0NCg0KICB9DQoNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9QaW5nUmVzdWx0X2Rlc2NyaXB0b3I7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIA0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9QaW5nUmVzdWx0X2ZpZWxkQWNjZXNzb3JUYWJsZTsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FbXB0eV9kZXNjcmlwdG9yOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCANCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfRW1wdHlfZmllbGRBY2Nlc3NvclRhYmxlOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1Jlc3VsdF9kZXNjcmlwdG9yOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCANCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUmVzdWx0X2ZpZWxkQWNjZXNzb3JUYWJsZTsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FdmVudF9kZXNjcmlwdG9yOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCANCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRfZmllbGRBY2Nlc3NvclRhYmxlOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0V2ZW50X1RhZ3NFbnRyeV9kZXNjcmlwdG9yOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCANCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRfVGFnc0VudHJ5X2ZpZWxkQWNjZXNzb3JUYWJsZTsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FdmVudFJlY2VpdmVfZGVzY3JpcHRvcjsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0V2ZW50UmVjZWl2ZV9maWVsZEFjY2Vzc29yVGFibGU7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRSZWNlaXZlX1RhZ3NFbnRyeV9kZXNjcmlwdG9yOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCANCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRSZWNlaXZlX1RhZ3NFbnRyeV9maWVsZEFjY2Vzc29yVGFibGU7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfU3Vic2NyaWJlX2Rlc2NyaXB0b3I7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIA0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdWJzY3JpYmVfZmllbGRBY2Nlc3NvclRhYmxlOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1JlcXVlc3RfZGVzY3JpcHRvcjsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1JlcXVlc3RfZmllbGRBY2Nlc3NvclRhYmxlOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1JlcXVlc3RfVGFnc0VudHJ5X2Rlc2NyaXB0b3I7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIA0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXF1ZXN0X1RhZ3NFbnRyeV9maWVsZEFjY2Vzc29yVGFibGU7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUmVzcG9uc2VfZGVzY3JpcHRvcjsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1Jlc3BvbnNlX2ZpZWxkQWNjZXNzb3JUYWJsZTsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXNwb25zZV9UYWdzRW50cnlfZGVzY3JpcHRvcjsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1Jlc3BvbnNlX1RhZ3NFbnRyeV9maWVsZEFjY2Vzc29yVGFibGU7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlX2Rlc2NyaXB0b3I7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIA0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VfZmllbGRBY2Nlc3NvclRhYmxlOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZV9UYWdzRW50cnlfZGVzY3JpcHRvcjsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZV9UYWdzRW50cnlfZmllbGRBY2Nlc3NvclRhYmxlOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3RfZGVzY3JpcHRvcjsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3RfZmllbGRBY2Nlc3NvclRhYmxlOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZXNCYXRjaFJlc3BvbnNlX2Rlc2NyaXB0b3I7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIA0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZV9maWVsZEFjY2Vzc29yVGFibGU7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlQXR0cmlidXRlc19kZXNjcmlwdG9yOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCANCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlQXR0cmlidXRlc19maWVsZEFjY2Vzc29yVGFibGU7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRGVzY3JpcHRvcg0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlUG9saWN5X2Rlc2NyaXB0b3I7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIA0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VQb2xpY3lfZmllbGRBY2Nlc3NvclRhYmxlOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1NlbmRRdWV1ZU1lc3NhZ2VSZXN1bHRfZGVzY3JpcHRvcjsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgDQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlDQogICAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1NlbmRRdWV1ZU1lc3NhZ2VSZXN1bHRfZmllbGRBY2Nlc3NvclRhYmxlOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1JlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdF9kZXNjcmlwdG9yOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCANCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXF1ZXN0X2ZpZWxkQWNjZXNzb3JUYWJsZTsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlX2Rlc2NyaXB0b3I7DQogIHByaXZhdGUgc3RhdGljIGZpbmFsIA0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZQ0KICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlX2ZpZWxkQWNjZXNzb3JUYWJsZTsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVxdWVzdF9kZXNjcmlwdG9yOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCANCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3RfZmllbGRBY2Nlc3NvclRhYmxlOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0Fja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZV9kZXNjcmlwdG9yOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCANCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlX2ZpZWxkQWNjZXNzb3JUYWJsZTsNCiAgcHJpdmF0ZSBzdGF0aWMgZmluYWwgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5EZXNjcmlwdG9yDQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdF9kZXNjcmlwdG9yOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCANCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3RfZmllbGRBY2Nlc3NvclRhYmxlOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCBjb20uZ29vZ2xlLnByb3RvYnVmLkRlc2NyaXB0b3JzLkRlc2NyaXB0b3INCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1N0cmVhbVF1ZXVlTWVzc2FnZXNSZXNwb25zZV9kZXNjcmlwdG9yOw0KICBwcml2YXRlIHN0YXRpYyBmaW5hbCANCiAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUNCiAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlX2ZpZWxkQWNjZXNzb3JUYWJsZTsNCg0KICBwdWJsaWMgc3RhdGljIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmlsZURlc2NyaXB0b3INCiAgICAgIGdldERlc2NyaXB0b3IoKSB7DQogICAgcmV0dXJuIGRlc2NyaXB0b3I7DQogIH0NCiAgcHJpdmF0ZSBzdGF0aWMgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmlsZURlc2NyaXB0b3INCiAgICAgIGRlc2NyaXB0b3I7DQogIHN0YXRpYyB7DQogICAgamF2YS5sYW5nLlN0cmluZ1tdIGRlc2NyaXB0b3JEYXRhID0gew0KICAgICAgIlxuXDAxNGt1YmVtcS5wcm90b1wwMjJcMDA2a3ViZW1xXCJhXG5cblBpbmdSZXN1bHRcMDIyXDAxNFxuXDAwNCIgKw0KICAgICAgIkhvc3RcMDMwXDAwMSBcMDAxKFx0XDAyMlwwMTdcblwwMDdWZXJzaW9uXDAzMFwwMDIgXDAwMShcdFwwMjJcMDI3XG5cMDE3U2VydmVyU3RhIiArDQogICAgICAicnRUaW1lXDAzMFwwMDMgXDAwMShcMDAzXDAyMlwwMzNcblwwMjNTZXJ2ZXJVcFRpbWVTZWNvbmRzXDAzMFwwMDQgXDAwMSgiICsNCiAgICAgICJcMDAzXCJcMDA3XG5cMDA1RW1wdHlcIjZcblwwMDZSZXN1bHRcMDIyXDAxN1xuXDAwN0V2ZW50SURcMDMwXDAwMSBcMDAxKFx0XDAyMlwwMTRcbiIgKw0KICAgICAgIlwwMDRTZW50XDAzMFwwMDIgXDAwMShcMDEwXDAyMlxyXG5cMDA1RXJyb3JcMDMwXDAwMyBcMDAxKFx0XCJcMjc2XDAwMVxuXDAwNUV2ZW50XDAyMlwwMTdcblwwMDciICsNCiAgICAgICJFdmVudElEXDAzMFwwMDEgXDAwMShcdFwwMjJcMDIwXG5cMDEwQ2xpZW50SURcMDMwXDAwMiBcMDAxKFx0XDAyMlwwMTdcblwwMDdDaGFubiIgKw0KICAgICAgImVsXDAzMFwwMDMgXDAwMShcdFwwMjJcMDIwXG5cMDEwTWV0YWRhdGFcMDMwXDAwNCBcMDAxKFx0XDAyMlwwMTRcblwwMDRCb2R5XDAzMFwwMDUgXDAwMShcMDE0IiArDQogICAgICAiXDAyMlxyXG5cMDA1U3RvcmVcMDMwXDAwNiBcMDAxKFwwMTBcMDIyJVxuXDAwNFRhZ3NcMDMwXDAwNyBcMDAzKFwwMTMyXDAyNy5rdWJlbXEuRSIgKw0KICAgICAgInZlbnQuVGFnc0VudHJ5XDAzMitcblx0VGFnc0VudHJ5XDAyMlwwMTNcblwwMDNrZXlcMDMwXDAwMSBcMDAxKFx0IiArDQogICAgICAiXDAyMlxyXG5cMDA1dmFsdWVcMDMwXDAwMiBcMDAxKFx0OlwwMDI4XDAwMVwiXDMyMFwwMDFcblwwMTRFdmVudFJlY2VpdmVcMDIyXDAxN1xuXDAwNyIgKw0KICAgICAgIkV2ZW50SURcMDMwXDAwMSBcMDAxKFx0XDAyMlwwMTdcblwwMDdDaGFubmVsXDAzMFwwMDIgXDAwMShcdFwwMjJcMDIwXG5cMDEwTWV0YWRhIiArDQogICAgICAidGFcMDMwXDAwMyBcMDAxKFx0XDAyMlwwMTRcblwwMDRCb2R5XDAzMFwwMDQgXDAwMShcMDE0XDAyMlwwMjFcblx0VGltZXN0YW1wXDAzMFwwMDUgXDAwMSgiICsNCiAgICAgICJcMDAzXDAyMlwwMjBcblwwMTBTZXF1ZW5jZVwwMzBcMDA2IFwwMDEoXDAwNFwwMjIsXG5cMDA0VGFnc1wwMzBcMDA3IFwwMDMoXDAxMzJcMDM2Lmt1YmUiICsNCiAgICAgICJtcS5FdmVudFJlY2VpdmUuVGFnc0VudHJ5XDAzMitcblx0VGFnc0VudHJ5XDAyMlwwMTMiICsNCiAgICAgICJcblwwMDNrZXlcMDMwXDAwMSBcMDAxKFx0XDAyMlxyXG5cMDA1dmFsdWVcMDMwXDAwMiBcMDAxKFx0OlwwMDI4XDAwMVwiXDM0M1wwMDNcblx0U3Vic2MiICsNCiAgICAgICJyaWJlXDAyMjpcblwwMjFTdWJzY3JpYmVUeXBlRGF0YVwwMzBcMDAxIFwwMDEoXDAxNjJcMDM3Lmt1YmVtcSIgKw0KICAgICAgIi5TdWJzY3JpYmUuU3Vic2NyaWJlVHlwZVwwMjJcMDIwXG5cMDEwQ2xpZW50SURcMDMwXDAwMiBcMDAxIiArDQogICAgICAiKFx0XDAyMlwwMTdcblwwMDdDaGFubmVsXDAzMFwwMDMgXDAwMShcdFwwMjJcclxuXDAwNUdyb3VwXDAzMFwwMDQgXDAwMShcdFwwMjI+XG5cMDIzRXYiICsNCiAgICAgICJlbnRzU3RvcmVUeXBlRGF0YVwwMzBcMDA1IFwwMDEoXDAxNjIhLmt1YmVtcS5TdWJzY3JpIiArDQogICAgICAiYmUuRXZlbnRzU3RvcmVUeXBlXDAyMlwwMzRcblwwMjRFdmVudHNTdG9yZVR5cGVWYWwiICsNCiAgICAgICJ1ZVwwMzBcMDA2IFwwMDEoXDAwM1wiY1xuXHJTdWJzY3JpYmVUeXBlXDAyMlwwMzJcblwwMjZTdWJzY3JpYmVUeSIgKw0KICAgICAgInBlVW5kZWZpbmVkXDAyMFwwMDBcMDIyXG5cblwwMDZFdmVudHNcMDIwXDAwMVwwMjJcMDE3XG5cMDEzRXZlbnRzU3RvcmUiICsNCiAgICAgICJcMDIwXDAwMlwwMjJcMDE0XG5cMDEwQ29tbWFuZHNcMDIwXDAwM1wwMjJcMDEzXG5cMDA3UXVlcmllc1wwMjBcMDA0XCJcMjQ0XDAwMVxuXDAxN0V2ZW50cyIgKw0KICAgICAgIlN0b3JlVHlwZVwwMjJcMDM0XG5cMDMwRXZlbnRzU3RvcmVUeXBlVW5kZWZpbmVkXDAyMFwwMDBcMDIyIiArDQogICAgICAiXDAyMFxuXDAxNFN0YXJ0TmV3T25seVwwMjBcMDAxXDAyMlwwMjJcblwwMTZTdGFydEZyb21GaXJzdFwwMjBcMDAyXDAyMlwwMjFcbiIgKw0KICAgICAgIlxyU3RhcnRGcm9tTGFzdFwwMjBcMDAzXDAyMlwwMjNcblwwMTdTdGFydEF0U2VxdWVuY2VcMDIwXDAwNFwwMjJcMDE3XG4iICsNCiAgICAgICJcMDEzU3RhcnRBdFRpbWVcMDIwXDAwNVwwMjJcMDI0XG5cMDIwU3RhcnRBdFRpbWVEZWx0YVwwMjBcMDA2XCJcMjAzXDAwM1xuIiArDQogICAgICAiXDAwN1JlcXVlc3RcMDIyXDAyMVxuXHRSZXF1ZXN0SURcMDMwXDAwMSBcMDAxKFx0XDAyMjRcblwwMTdSZXF1ZXN0VHkiICsNCiAgICAgICJwZURhdGFcMDMwXDAwMiBcMDAxKFwwMTYyXDAzMy5rdWJlbXEuUmVxdWVzdC5SZXF1ZXN0VHlwIiArDQogICAgICAiZVwwMjJcMDIwXG5cMDEwQ2xpZW50SURcMDMwXDAwMyBcMDAxKFx0XDAyMlwwMTdcblwwMDdDaGFubmVsXDAzMFwwMDQgXDAwMShcdFwwMjJcMDIwXG5cMDEwIiArDQogICAgICAiTWV0YWRhdGFcMDMwXDAwNSBcMDAxKFx0XDAyMlwwMTRcblwwMDRCb2R5XDAzMFwwMDYgXDAwMShcMDE0XDAyMlwwMjRcblwwMTRSZXBseUNoYSIgKw0KICAgICAgIm5uZWxcMDMwXDAwNyBcMDAxKFx0XDAyMlwwMTdcblwwMDdUaW1lb3V0XDAzMFwwMTAgXDAwMShcMDA1XDAyMlwwMjBcblwwMTBDYWNoZUtleVwwMzAiICsNCiAgICAgICJcdCBcMDAxKFx0XDAyMlwwMjBcblwwMTBDYWNoZVRUTFwwMzBcbiBcMDAxKFwwMDVcMDIyXDAxNFxuXDAwNFNwYW5cMDMwXDAxMyBcMDAxKFwwMTRcMDIyXCdcbiIgKw0KICAgICAgIlwwMDRUYWdzXDAzMFwwMTQgXDAwMyhcMDEzMlwwMzEua3ViZW1xLlJlcXVlc3QuVGFnc0VudHJ5XDAzMisiICsNCiAgICAgICJcblx0VGFnc0VudHJ5XDAyMlwwMTNcblwwMDNrZXlcMDMwXDAwMSBcMDAxKFx0XDAyMlxyXG5cMDA1dmFsdWVcMDMwXDAwMiBcMDAxKFx0OiIgKw0KICAgICAgIlwwMDI4XDAwMVwiPVxuXDAxM1JlcXVlc3RUeXBlXDAyMlwwMjZcblwwMjJSZXF1ZXN0VHlwZVVua25vd24iICsNCiAgICAgICJcMDIwXDAwMFwwMjJcMDEzXG5cMDA3Q29tbWFuZFwwMjBcMDAxXDAyMlx0XG5cMDA1UXVlcnlcMDIwXDAwMlwiXDIyMFwwMDJcblwwMTBSZXNwb25zZVwwMjIiICsNCiAgICAgICJcMDIwXG5cMDEwQ2xpZW50SURcMDMwXDAwMSBcMDAxKFx0XDAyMlwwMjFcblx0UmVxdWVzdElEXDAzMFwwMDIgXDAwMShcdFwwMjJcMDI0XG5cMDE0IiArDQogICAgICAiUmVwbHlDaGFubmVsXDAzMFwwMDMgXDAwMShcdFwwMjJcMDIwXG5cMDEwTWV0YWRhdGFcMDMwXDAwNCBcMDAxKFx0XDAyMlwwMTRcblwwMDQiICsNCiAgICAgICJCb2R5XDAzMFwwMDUgXDAwMShcMDE0XDAyMlwwMjBcblwwMTBDYWNoZUhpdFwwMzBcMDA2IFwwMDEoXDAxMFwwMjJcMDIxXG5cdFRpbWVzdGFtIiArDQogICAgICAicFwwMzBcMDA3IFwwMDEoXDAwM1wwMjJcMDIwXG5cMDEwRXhlY3V0ZWRcMDMwXDAxMCBcMDAxKFwwMTBcMDIyXHJcblwwMDVFcnJvclwwMzBcdCBcMDAxKFx0IiArDQogICAgICAiXDAyMlwwMTRcblwwMDRTcGFuXDAzMFxuIFwwMDEoXDAxNFwwMjIoXG5cMDA0VGFnc1wwMzBcMDEzIFwwMDMoXDAxMzJcMDMyLmt1YmVtcS5SZSIgKw0KICAgICAgInNwb25zZS5UYWdzRW50cnlcMDMyK1xuXHRUYWdzRW50cnlcMDIyXDAxM1xuXDAwM2tleVwwMzBcMDAxIFwwMDEiICsNCiAgICAgICIoXHRcMDIyXHJcblwwMDV2YWx1ZVwwMzBcMDAyIFwwMDEoXHQ6XDAwMjhcMDAxXCJcMjM3XDAwMlxuXDAxNFF1ZXVlTWVzc2FnZVwwMjJcMDIxIiArDQogICAgICAiXG5cdE1lc3NhZ2VJRFwwMzBcMDAxIFwwMDEoXHRcMDIyXDAyMFxuXDAxMENsaWVudElEXDAzMFwwMDIgXDAwMShcdFwwMjJcMDE3XG5cMDA3QyIgKw0KICAgICAgImhhbm5lbFwwMzBcMDAzIFwwMDEoXHRcMDIyXDAyMFxuXDAxME1ldGFkYXRhXDAzMFwwMDQgXDAwMShcdFwwMjJcMDE0XG5cMDA0Qm9keVwwMzBcMDA1IiArDQogICAgICAiIFwwMDEoXDAxNFwwMjIsXG5cMDA0VGFnc1wwMzBcMDA2IFwwMDMoXDAxMzJcMDM2Lmt1YmVtcS5RdWV1ZU1lc3NhZ2UiICsNCiAgICAgICIuVGFnc0VudHJ5XDAyMjJcblxuQXR0cmlidXRlc1wwMzBcMDA3IFwwMDEoXDAxMzJcMDM2Lmt1YmVtcS4iICsNCiAgICAgICJRdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzXDAyMipcblwwMDZQb2xpY3lcMDMwXDAxMCBcMDAxKFwwMTMyXDAzMiIgKw0KICAgICAgIi5rdWJlbXEuUXVldWVNZXNzYWdlUG9saWN5XDAzMitcblx0VGFnc0VudHJ5XDAyMiIgKw0KICAgICAgIlwwMTNcblwwMDNrZXlcMDMwXDAwMSBcMDAxKFx0XDAyMlxyXG5cMDA1dmFsdWVcMDMwXDAwMiBcMDAxKFx0OlwwMDI4XDAwMVwiVFxuXDAzMVF1ZXVlIiArDQogICAgICAiTWVzc2FnZXNCYXRjaFJlcXVlc3RcMDIyXDAxN1xuXDAwN0JhdGNoSURcMDMwXDAwMSBcMDAxKFx0XDAyMiZcbiIgKw0KICAgICAgIlwwMTBNZXNzYWdlc1wwMzBcMDAyIFwwMDMoXDAxMzJcMDI0Lmt1YmVtcS5RdWV1ZU1lc3NhZ2VcInJcbiIgKw0KICAgICAgIlwwMzJRdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZVwwMjJcMDE3XG5cMDA3QmF0Y2hJRFwwMzBcMDAxIiArDQogICAgICAiIFwwMDEoXHRcMDIyL1xuXDAwN1Jlc3VsdHNcMDMwXDAwMiBcMDAzKFwwMTMyXDAzNi5rdWJlbXEuU2VuZFF1ZXVlIiArDQogICAgICAiTWVzc2FnZVJlc3VsdFwwMjJcMDIyXG5cbkhhdmVFcnJvcnNcMDMwXDAwMyBcMDAxKFwwMTBcIlwyNzRcMDAxXG5cMDI2UXUiICsNCiAgICAgICJldWVNZXNzYWdlQXR0cmlidXRlc1wwMjJcMDIxXG5cdFRpbWVzdGFtcFwwMzBcMDAxIFwwMDEoXDAwM1wwMjIiICsNCiAgICAgICJcMDIwXG5cMDEwU2VxdWVuY2VcMDMwXDAwMiBcMDAxKFwwMDRcMDIyXDAyMVxuXHRNRDVPZkJvZHlcMDMwXDAwMyBcMDAxKFx0XDAyMlwwMjRcblwwMTQiICsNCiAgICAgICJSZWNlaXZlQ291bnRcMDMwXDAwNCBcMDAxKFwwMDVcMDIyXDAyMFxuXDAxMFJlUm91dGVkXDAzMFwwMDUgXDAwMShcMDEwXDAyMlwwMzFcblwwMjEiICsNCiAgICAgICJSZVJvdXRlZEZyb21RdWV1ZVwwMzBcMDA2IFwwMDEoXHRcMDIyXDAyNFxuXDAxNEV4cGlyYXRpb25BdFwwMzAiICsNCiAgICAgICJcMDA3IFwwMDEoXDAwM1wwMjJcMDIxXG5cdERlbGF5ZWRUb1wwMzBcMDEwIFwwMDEoXDAwM1wid1xuXDAyMlF1ZXVlTWVzc2FnZSIgKw0KICAgICAgIlBvbGljeVwwMjJcMDMxXG5cMDIxRXhwaXJhdGlvblNlY29uZHNcMDMwXDAwMSBcMDAxKFwwMDVcMDIyXDAyNFxuXDAxNERlbCIgKw0KICAgICAgImF5U2Vjb25kc1wwMzBcMDAyIFwwMDEoXDAwNVwwMjJcMDI3XG5cMDE3TWF4UmVjZWl2ZUNvdW50XDAzMFwwMDMgXDAwMShcMDA1IiArDQogICAgICAiXDAyMlwwMjdcblwwMTdNYXhSZWNlaXZlUXVldWVcMDMwXDAwNCBcMDAxKFx0XCJcMjA0XDAwMVxuXDAyNlNlbmRRdWV1ZU0iICsNCiAgICAgICJlc3NhZ2VSZXN1bHRcMDIyXDAyMVxuXHRNZXNzYWdlSURcMDMwXDAwMSBcMDAxKFx0XDAyMlwwMTZcblwwMDZTZW50QSIgKw0KICAgICAgInRcMDMwXDAwMiBcMDAxKFwwMDNcMDIyXDAyNFxuXDAxNEV4cGlyYXRpb25BdFwwMzBcMDAzIFwwMDEoXDAwM1wwMjJcMDIxXG5cdERlbGF5ZWQiICsNCiAgICAgICJUb1wwMzBcMDA0IFwwMDEoXDAwM1wwMjJcMDE3XG5cMDA3SXNFcnJvclwwMzBcMDA1IFwwMDEoXDAxMFwwMjJcclxuXDAwNUVycm9yXDAzMFwwMDYgXDAwMShcdCIgKw0KICAgICAgIlwiXDIzMVwwMDFcblwwMzNSZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3RcMDIyXDAyMVxuXHRSZXF1IiArDQogICAgICAiZXN0SURcMDMwXDAwMSBcMDAxKFx0XDAyMlwwMjBcblwwMTBDbGllbnRJRFwwMzBcMDAyIFwwMDEoXHRcMDIyXDAxN1xuXDAwN0NoYW5uZWwiICsNCiAgICAgICJcMDMwXDAwMyBcMDAxKFx0XDAyMlwwMzNcblwwMjNNYXhOdW1iZXJPZk1lc3NhZ2VzXDAzMFwwMDQgXDAwMShcMDA1XDAyMlwwMjdcblwwMTdXIiArDQogICAgICAiYWl0VGltZVNlY29uZHNcMDMwXDAwNSBcMDAxKFwwMDVcMDIyXDAxNlxuXDAwNklzUGVha1wwMzBcMDA2IFwwMDEoXDAxMFwiXDI3NFwwMDFcbiIgKw0KICAgICAgIlwwMzRSZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlXDAyMlwwMjFcblx0UmVxdWVzdCIgKw0KICAgICAgIklEXDAzMFwwMDEgXDAwMShcdFwwMjImXG5cMDEwTWVzc2FnZXNcMDMwXDAwMiBcMDAzKFwwMTMyXDAyNC5rdWJlbXEuUXVldSIgKw0KICAgICAgImVNZXNzYWdlXDAyMlwwMzBcblwwMjBNZXNzYWdlc1JlY2VpdmVkXDAzMFwwMDMgXDAwMShcMDA1XDAyMlwwMjdcblwwMTdNZSIgKw0KICAgICAgInNzYWdlc0V4cGlyZWRcMDMwXDAwNCBcMDAxKFwwMDVcMDIyXDAxNlxuXDAwNklzUGVha1wwMzBcMDA1IFwwMDEoXDAxMFwwMjJcMDE3XG5cMDA3SSIgKw0KICAgICAgInNFcnJvclwwMzBcMDA2IFwwMDEoXDAxMFwwMjJcclxuXDAwNUVycm9yXDAzMFwwMDcgXDAwMShcdFwia1xuXDAzMkFja0FsbFF1ZSIgKw0KICAgICAgInVlTWVzc2FnZXNSZXF1ZXN0XDAyMlwwMjFcblx0UmVxdWVzdElEXDAzMFwwMDEgXDAwMShcdFwwMjJcMDIwXG5cMDEwIiArDQogICAgICAiQ2xpZW50SURcMDMwXDAwMiBcMDAxKFx0XDAyMlwwMTdcblwwMDdDaGFubmVsXDAzMFwwMDMgXDAwMShcdFwwMjJcMDI3XG5cMDE3V2FpdFQiICsNCiAgICAgICJpbWVTZWNvbmRzXDAzMFwwMDQgXDAwMShcMDA1XCJqXG5cMDMzQWNrQWxsUXVldWVNZXNzYWdlc1IiICsNCiAgICAgICJlc3BvbnNlXDAyMlwwMjFcblx0UmVxdWVzdElEXDAzMFwwMDEgXDAwMShcdFwwMjJcMDMwXG5cMDIwQWZmZWN0ZWRNZSIgKw0KICAgICAgInNzYWdlc1wwMzBcMDAyIFwwMDEoXDAwNFwwMjJcMDE3XG5cMDA3SXNFcnJvclwwMzBcMDAzIFwwMDEoXDAxMFwwMjJcclxuXDAwNUVycm9yXDAzMFwwMDQiICsNCiAgICAgICIgXDAwMShcdFwiXDIwNFwwMDJcblwwMzJTdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdFwwMjJcMDIxXG5cdFIiICsNCiAgICAgICJlcXVlc3RJRFwwMzBcMDAxIFwwMDEoXHRcMDIyXDAyMFxuXDAxMENsaWVudElEXDAzMFwwMDIgXDAwMShcdFwwMjI4XG5cMDI1U3RyZSIgKw0KICAgICAgImFtUmVxdWVzdFR5cGVEYXRhXDAzMFwwMDMgXDAwMShcMDE2MlwwMzEua3ViZW1xLlN0cmVhbVIiICsNCiAgICAgICJlcXVlc3RUeXBlXDAyMlwwMTdcblwwMDdDaGFubmVsXDAzMFwwMDQgXDAwMShcdFwwMjJcMDMxXG5cMDIxVmlzaWJpbGl0IiArDQogICAgICAieVNlY29uZHNcMDMwXDAwNSBcMDAxKFwwMDVcMDIyXDAyN1xuXDAxN1dhaXRUaW1lU2Vjb25kc1wwMzBcMDA2IFwwMDEoXDAwNVwwMjIiICsNCiAgICAgICJcMDIzXG5cMDEzUmVmU2VxdWVuY2VcMDMwXDAwNyBcMDAxKFwwMDRcMDIyLVxuXDAxN01vZGlmaWVkTWVzc2FnZVwwMzAiICsNCiAgICAgICJcMDEwIFwwMDEoXDAxMzJcMDI0Lmt1YmVtcS5RdWV1ZU1lc3NhZ2VcIlwyNjFcMDAxXG5cMDMzU3RyZWFtUXUiICsNCiAgICAgICJldWVNZXNzYWdlc1Jlc3BvbnNlXDAyMlwwMjFcblx0UmVxdWVzdElEXDAzMFwwMDEgXDAwMShcdFwwMjI4IiArDQogICAgICAiXG5cMDI1U3RyZWFtUmVxdWVzdFR5cGVEYXRhXDAzMFwwMDIgXDAwMShcMDE2MlwwMzEua3ViZW1xLlMiICsNCiAgICAgICJ0cmVhbVJlcXVlc3RUeXBlXDAyMiVcblwwMDdNZXNzYWdlXDAzMFwwMDMgXDAwMShcMDEzMlwwMjQua3ViZSIgKw0KICAgICAgIm1xLlF1ZXVlTWVzc2FnZVwwMjJcMDE3XG5cMDA3SXNFcnJvclwwMzBcMDA0IFwwMDEoXDAxMFwwMjJcclxuXDAwNUVycm8iICsNCiAgICAgICJyXDAzMFwwMDUgXDAwMShcdCpcMjUyXDAwMVxuXDAyMVN0cmVhbVJlcXVlc3RUeXBlXDAyMlwwMzRcblwwMzBTdHJlYW1SIiArDQogICAgICAiZXF1ZXN0VHlwZVVua25vd25cMDIwXDAwMFwwMjJcMDIyXG5cMDE2UmVjZWl2ZU1lc3NhZ2VcMDIwXDAwMVwwMjIiICsNCiAgICAgICJcMDE2XG5cbkFja01lc3NhZ2VcMDIwXDAwMlwwMjJcMDIxXG5cclJlamVjdE1lc3NhZ2VcMDIwXDAwM1wwMjJcMDI0XG5cMDIwTW8iICsNCiAgICAgICJkaWZ5VmlzaWJpbGl0eVwwMjBcMDA0XDAyMlwwMjFcblxyUmVzZW5kTWVzc2FnZVwwMjBcMDA1XDAyMlwwMjdcblwwMjNTIiArDQogICAgICAiZW5kTW9kaWZpZWRNZXNzYWdlXDAyMFwwMDYyXDMzN1wwMDZcblwwMDZrdWJlbXFcMDIyLFxuXHRTZW5kRSIgKw0KICAgICAgInZlbnRcMDIyXHIua3ViZW1xLkV2ZW50XDAzMlwwMTYua3ViZW1xLlJlc3VsdFwiXDAwMFwwMjI3XG4iICsNCiAgICAgICJcMDIwU2VuZEV2ZW50c1N0cmVhbVwwMjJcci5rdWJlbXEuRXZlbnRcMDMyXDAxNi5rdWJlbSIgKw0KICAgICAgInEuUmVzdWx0XCJcMDAwKFwwMDEwXDAwMVwwMjJAXG5cMDIxU3Vic2NyaWJlVG9FdmVudHNcMDIyXDAyMS5rdSIgKw0KICAgICAgImJlbXEuU3Vic2NyaWJlXDAzMlwwMjQua3ViZW1xLkV2ZW50UmVjZWl2ZVwiXDAwMDBcMDAxIiArDQogICAgICAiXDAyMj1cblwwMjNTdWJzY3JpYmVUb1JlcXVlc3RzXDAyMlwwMjEua3ViZW1xLlN1YnNjcmkiICsNCiAgICAgICJiZVwwMzJcMDE3Lmt1YmVtcS5SZXF1ZXN0XCJcMDAwMFwwMDFcMDIyMlxuXDAxM1NlbmRSZXF1ZXN0XDAyMlwwMTciICsNCiAgICAgICIua3ViZW1xLlJlcXVlc3RcMDMyXDAyMC5rdWJlbXEuUmVzcG9uc2VcIlwwMDBcMDIyMVxuXDAxNFMiICsNCiAgICAgICJlbmRSZXNwb25zZVwwMjJcMDIwLmt1YmVtcS5SZXNwb25zZVwwMzJcci5rdWJlbXEuRSIgKw0KICAgICAgIm1wdHlcIlwwMDBcMDIySlxuXDAyMFNlbmRRdWV1ZU1lc3NhZ2VcMDIyXDAyNC5rdWJlbXEuUXVldSIgKw0KICAgICAgImVNZXNzYWdlXDAzMlwwMzYua3ViZW1xLlNlbmRRdWV1ZU1lc3NhZ2VSZXN1bHQiICsNCiAgICAgICJcIlwwMDBcMDIyYVxuXDAyNlNlbmRRdWV1ZU1lc3NhZ2VzQmF0Y2hcMDIyIS5rdWJlbXEuUXUiICsNCiAgICAgICJldWVNZXNzYWdlc0JhdGNoUmVxdWVzdFwwMzJcIi5rdWJlbXEuUXVldWVNZSIgKw0KICAgICAgInNzYWdlc0JhdGNoUmVzcG9uc2VcIlwwMDBcMDIyY1xuXDAyNFJlY2VpdmVRdWV1ZU1lcyIgKw0KICAgICAgInNhZ2VzXDAyMiMua3ViZW1xLlJlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWUiICsNCiAgICAgICJzdFwwMzIkLmt1YmVtcS5SZWNlaXZlUXVldWVNZXNzYWdlc1Jlc3BvbnNlIiArDQogICAgICAiXCJcMDAwXDAyMmNcblwwMjJTdHJlYW1RdWV1ZU1lc3NhZ2VcMDIyXCIua3ViZW1xLlN0cmVhbSIgKw0KICAgICAgIlF1ZXVlTWVzc2FnZXNSZXF1ZXN0XDAzMiMua3ViZW1xLlN0cmVhbVF1ZXUiICsNCiAgICAgICJlTWVzc2FnZXNSZXNwb25zZVwiXDAwMChcMDAxMFwwMDFcMDIyYFxuXDAyM0Fja0FsbFF1ZXVlTWUiICsNCiAgICAgICJzc2FnZXNcMDIyXCIua3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZSIgKw0KICAgICAgInN0XDAzMiMua3ViZW1xLkFja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZVwiIiArDQogICAgICAiXDAwMFwwMjIrXG5cMDA0UGluZ1wwMjJcci5rdWJlbXEuRW1wdHlcMDMyXDAyMi5rdWJlbXEuUGluZ1JlIiArDQogICAgICAic3VsdFwiXDAwMEJcMDM0XG5cMDIyaW8ua3ViZW1xLnNkay5ncnBjQlwwMDZLdWJlbXFiXDAwNnByIiArDQogICAgICAib3RvMyINCiAgICB9Ow0KICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmlsZURlc2NyaXB0b3IuSW50ZXJuYWxEZXNjcmlwdG9yQXNzaWduZXIgYXNzaWduZXIgPQ0KICAgICAgICBuZXcgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWxlRGVzY3JpcHRvci4gICAgSW50ZXJuYWxEZXNjcmlwdG9yQXNzaWduZXIoKSB7DQogICAgICAgICAgcHVibGljIGNvbS5nb29nbGUucHJvdG9idWYuRXh0ZW5zaW9uUmVnaXN0cnkgYXNzaWduRGVzY3JpcHRvcnMoDQogICAgICAgICAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmlsZURlc2NyaXB0b3Igcm9vdCkgew0KICAgICAgICAgICAgZGVzY3JpcHRvciA9IHJvb3Q7DQogICAgICAgICAgICByZXR1cm4gbnVsbDsNCiAgICAgICAgICB9DQogICAgICAgIH07DQogICAgY29tLmdvb2dsZS5wcm90b2J1Zi5EZXNjcmlwdG9ycy5GaWxlRGVzY3JpcHRvcg0KICAgICAgLmludGVybmFsQnVpbGRHZW5lcmF0ZWRGaWxlRnJvbShkZXNjcmlwdG9yRGF0YSwNCiAgICAgICAgbmV3IGNvbS5nb29nbGUucHJvdG9idWYuRGVzY3JpcHRvcnMuRmlsZURlc2NyaXB0b3JbXSB7DQogICAgICAgIH0sIGFzc2lnbmVyKTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1BpbmdSZXN1bHRfZGVzY3JpcHRvciA9DQogICAgICBnZXREZXNjcmlwdG9yKCkuZ2V0TWVzc2FnZVR5cGVzKCkuZ2V0KDApOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUGluZ1Jlc3VsdF9maWVsZEFjY2Vzc29yVGFibGUgPSBuZXcNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZSgNCiAgICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9QaW5nUmVzdWx0X2Rlc2NyaXB0b3IsDQogICAgICAgIG5ldyBqYXZhLmxhbmcuU3RyaW5nW10geyAiSG9zdCIsICJWZXJzaW9uIiwgIlNlcnZlclN0YXJ0VGltZSIsICJTZXJ2ZXJVcFRpbWVTZWNvbmRzIiwgfSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FbXB0eV9kZXNjcmlwdG9yID0NCiAgICAgIGdldERlc2NyaXB0b3IoKS5nZXRNZXNzYWdlVHlwZXMoKS5nZXQoMSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FbXB0eV9maWVsZEFjY2Vzc29yVGFibGUgPSBuZXcNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZSgNCiAgICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FbXB0eV9kZXNjcmlwdG9yLA0KICAgICAgICBuZXcgamF2YS5sYW5nLlN0cmluZ1tdIHsgfSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXN1bHRfZGVzY3JpcHRvciA9DQogICAgICBnZXREZXNjcmlwdG9yKCkuZ2V0TWVzc2FnZVR5cGVzKCkuZ2V0KDIpOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUmVzdWx0X2ZpZWxkQWNjZXNzb3JUYWJsZSA9IG5ldw0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlKA0KICAgICAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1Jlc3VsdF9kZXNjcmlwdG9yLA0KICAgICAgICBuZXcgamF2YS5sYW5nLlN0cmluZ1tdIHsgIkV2ZW50SUQiLCAiU2VudCIsICJFcnJvciIsIH0pOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRfZGVzY3JpcHRvciA9DQogICAgICBnZXREZXNjcmlwdG9yKCkuZ2V0TWVzc2FnZVR5cGVzKCkuZ2V0KDMpOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRfZmllbGRBY2Nlc3NvclRhYmxlID0gbmV3DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUoDQogICAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRfZGVzY3JpcHRvciwNCiAgICAgICAgbmV3IGphdmEubGFuZy5TdHJpbmdbXSB7ICJFdmVudElEIiwgIkNsaWVudElEIiwgIkNoYW5uZWwiLCAiTWV0YWRhdGEiLCAiQm9keSIsICJTdG9yZSIsICJUYWdzIiwgfSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FdmVudF9UYWdzRW50cnlfZGVzY3JpcHRvciA9DQogICAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0V2ZW50X2Rlc2NyaXB0b3IuZ2V0TmVzdGVkVHlwZXMoKS5nZXQoMCk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FdmVudF9UYWdzRW50cnlfZmllbGRBY2Nlc3NvclRhYmxlID0gbmV3DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUoDQogICAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRfVGFnc0VudHJ5X2Rlc2NyaXB0b3IsDQogICAgICAgIG5ldyBqYXZhLmxhbmcuU3RyaW5nW10geyAiS2V5IiwgIlZhbHVlIiwgfSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FdmVudFJlY2VpdmVfZGVzY3JpcHRvciA9DQogICAgICBnZXREZXNjcmlwdG9yKCkuZ2V0TWVzc2FnZVR5cGVzKCkuZ2V0KDQpOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRSZWNlaXZlX2ZpZWxkQWNjZXNzb3JUYWJsZSA9IG5ldw0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlKA0KICAgICAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0V2ZW50UmVjZWl2ZV9kZXNjcmlwdG9yLA0KICAgICAgICBuZXcgamF2YS5sYW5nLlN0cmluZ1tdIHsgIkV2ZW50SUQiLCAiQ2hhbm5lbCIsICJNZXRhZGF0YSIsICJCb2R5IiwgIlRpbWVzdGFtcCIsICJTZXF1ZW5jZSIsICJUYWdzIiwgfSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FdmVudFJlY2VpdmVfVGFnc0VudHJ5X2Rlc2NyaXB0b3IgPQ0KICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9FdmVudFJlY2VpdmVfZGVzY3JpcHRvci5nZXROZXN0ZWRUeXBlcygpLmdldCgwKTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0V2ZW50UmVjZWl2ZV9UYWdzRW50cnlfZmllbGRBY2Nlc3NvclRhYmxlID0gbmV3DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUoDQogICAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfRXZlbnRSZWNlaXZlX1RhZ3NFbnRyeV9kZXNjcmlwdG9yLA0KICAgICAgICBuZXcgamF2YS5sYW5nLlN0cmluZ1tdIHsgIktleSIsICJWYWx1ZSIsIH0pOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfU3Vic2NyaWJlX2Rlc2NyaXB0b3IgPQ0KICAgICAgZ2V0RGVzY3JpcHRvcigpLmdldE1lc3NhZ2VUeXBlcygpLmdldCg1KTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1N1YnNjcmliZV9maWVsZEFjY2Vzc29yVGFibGUgPSBuZXcNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZSgNCiAgICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdWJzY3JpYmVfZGVzY3JpcHRvciwNCiAgICAgICAgbmV3IGphdmEubGFuZy5TdHJpbmdbXSB7ICJTdWJzY3JpYmVUeXBlRGF0YSIsICJDbGllbnRJRCIsICJDaGFubmVsIiwgIkdyb3VwIiwgIkV2ZW50c1N0b3JlVHlwZURhdGEiLCAiRXZlbnRzU3RvcmVUeXBlVmFsdWUiLCB9KTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1JlcXVlc3RfZGVzY3JpcHRvciA9DQogICAgICBnZXREZXNjcmlwdG9yKCkuZ2V0TWVzc2FnZVR5cGVzKCkuZ2V0KDYpOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUmVxdWVzdF9maWVsZEFjY2Vzc29yVGFibGUgPSBuZXcNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZSgNCiAgICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXF1ZXN0X2Rlc2NyaXB0b3IsDQogICAgICAgIG5ldyBqYXZhLmxhbmcuU3RyaW5nW10geyAiUmVxdWVzdElEIiwgIlJlcXVlc3RUeXBlRGF0YSIsICJDbGllbnRJRCIsICJDaGFubmVsIiwgIk1ldGFkYXRhIiwgIkJvZHkiLCAiUmVwbHlDaGFubmVsIiwgIlRpbWVvdXQiLCAiQ2FjaGVLZXkiLCAiQ2FjaGVUVEwiLCAiU3BhbiIsICJUYWdzIiwgfSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXF1ZXN0X1RhZ3NFbnRyeV9kZXNjcmlwdG9yID0NCiAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUmVxdWVzdF9kZXNjcmlwdG9yLmdldE5lc3RlZFR5cGVzKCkuZ2V0KDApOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUmVxdWVzdF9UYWdzRW50cnlfZmllbGRBY2Nlc3NvclRhYmxlID0gbmV3DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUoDQogICAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUmVxdWVzdF9UYWdzRW50cnlfZGVzY3JpcHRvciwNCiAgICAgICAgbmV3IGphdmEubGFuZy5TdHJpbmdbXSB7ICJLZXkiLCAiVmFsdWUiLCB9KTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1Jlc3BvbnNlX2Rlc2NyaXB0b3IgPQ0KICAgICAgZ2V0RGVzY3JpcHRvcigpLmdldE1lc3NhZ2VUeXBlcygpLmdldCg3KTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1Jlc3BvbnNlX2ZpZWxkQWNjZXNzb3JUYWJsZSA9IG5ldw0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlKA0KICAgICAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1Jlc3BvbnNlX2Rlc2NyaXB0b3IsDQogICAgICAgIG5ldyBqYXZhLmxhbmcuU3RyaW5nW10geyAiQ2xpZW50SUQiLCAiUmVxdWVzdElEIiwgIlJlcGx5Q2hhbm5lbCIsICJNZXRhZGF0YSIsICJCb2R5IiwgIkNhY2hlSGl0IiwgIlRpbWVzdGFtcCIsICJFeGVjdXRlZCIsICJFcnJvciIsICJTcGFuIiwgIlRhZ3MiLCB9KTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1Jlc3BvbnNlX1RhZ3NFbnRyeV9kZXNjcmlwdG9yID0NCiAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUmVzcG9uc2VfZGVzY3JpcHRvci5nZXROZXN0ZWRUeXBlcygpLmdldCgwKTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1Jlc3BvbnNlX1RhZ3NFbnRyeV9maWVsZEFjY2Vzc29yVGFibGUgPSBuZXcNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZSgNCiAgICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZXNwb25zZV9UYWdzRW50cnlfZGVzY3JpcHRvciwNCiAgICAgICAgbmV3IGphdmEubGFuZy5TdHJpbmdbXSB7ICJLZXkiLCAiVmFsdWUiLCB9KTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZV9kZXNjcmlwdG9yID0NCiAgICAgIGdldERlc2NyaXB0b3IoKS5nZXRNZXNzYWdlVHlwZXMoKS5nZXQoOCk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VfZmllbGRBY2Nlc3NvclRhYmxlID0gbmV3DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUoDQogICAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlX2Rlc2NyaXB0b3IsDQogICAgICAgIG5ldyBqYXZhLmxhbmcuU3RyaW5nW10geyAiTWVzc2FnZUlEIiwgIkNsaWVudElEIiwgIkNoYW5uZWwiLCAiTWV0YWRhdGEiLCAiQm9keSIsICJUYWdzIiwgIkF0dHJpYnV0ZXMiLCAiUG9saWN5IiwgfSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VfVGFnc0VudHJ5X2Rlc2NyaXB0b3IgPQ0KICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VfZGVzY3JpcHRvci5nZXROZXN0ZWRUeXBlcygpLmdldCgwKTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZV9UYWdzRW50cnlfZmllbGRBY2Nlc3NvclRhYmxlID0gbmV3DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUoDQogICAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlX1RhZ3NFbnRyeV9kZXNjcmlwdG9yLA0KICAgICAgICBuZXcgamF2YS5sYW5nLlN0cmluZ1tdIHsgIktleSIsICJWYWx1ZSIsIH0pOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlc0JhdGNoUmVxdWVzdF9kZXNjcmlwdG9yID0NCiAgICAgIGdldERlc2NyaXB0b3IoKS5nZXRNZXNzYWdlVHlwZXMoKS5nZXQoOSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXF1ZXN0X2ZpZWxkQWNjZXNzb3JUYWJsZSA9IG5ldw0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlKA0KICAgICAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1F1ZXVlTWVzc2FnZXNCYXRjaFJlcXVlc3RfZGVzY3JpcHRvciwNCiAgICAgICAgbmV3IGphdmEubGFuZy5TdHJpbmdbXSB7ICJCYXRjaElEIiwgIk1lc3NhZ2VzIiwgfSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VzQmF0Y2hSZXNwb25zZV9kZXNjcmlwdG9yID0NCiAgICAgIGdldERlc2NyaXB0b3IoKS5nZXRNZXNzYWdlVHlwZXMoKS5nZXQoMTApOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2VfZmllbGRBY2Nlc3NvclRhYmxlID0gbmV3DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUoDQogICAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlc0JhdGNoUmVzcG9uc2VfZGVzY3JpcHRvciwNCiAgICAgICAgbmV3IGphdmEubGFuZy5TdHJpbmdbXSB7ICJCYXRjaElEIiwgIlJlc3VsdHMiLCAiSGF2ZUVycm9ycyIsIH0pOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlQXR0cmlidXRlc19kZXNjcmlwdG9yID0NCiAgICAgIGdldERlc2NyaXB0b3IoKS5nZXRNZXNzYWdlVHlwZXMoKS5nZXQoMTEpOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlQXR0cmlidXRlc19maWVsZEFjY2Vzc29yVGFibGUgPSBuZXcNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZSgNCiAgICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VBdHRyaWJ1dGVzX2Rlc2NyaXB0b3IsDQogICAgICAgIG5ldyBqYXZhLmxhbmcuU3RyaW5nW10geyAiVGltZXN0YW1wIiwgIlNlcXVlbmNlIiwgIk1ENU9mQm9keSIsICJSZWNlaXZlQ291bnQiLCAiUmVSb3V0ZWQiLCAiUmVSb3V0ZWRGcm9tUXVldWUiLCAiRXhwaXJhdGlvbkF0IiwgIkRlbGF5ZWRUbyIsIH0pOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlUG9saWN5X2Rlc2NyaXB0b3IgPQ0KICAgICAgZ2V0RGVzY3JpcHRvcigpLmdldE1lc3NhZ2VUeXBlcygpLmdldCgxMik7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9RdWV1ZU1lc3NhZ2VQb2xpY3lfZmllbGRBY2Nlc3NvclRhYmxlID0gbmV3DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUoDQogICAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUXVldWVNZXNzYWdlUG9saWN5X2Rlc2NyaXB0b3IsDQogICAgICAgIG5ldyBqYXZhLmxhbmcuU3RyaW5nW10geyAiRXhwaXJhdGlvblNlY29uZHMiLCAiRGVsYXlTZWNvbmRzIiwgIk1heFJlY2VpdmVDb3VudCIsICJNYXhSZWNlaXZlUXVldWUiLCB9KTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1NlbmRRdWV1ZU1lc3NhZ2VSZXN1bHRfZGVzY3JpcHRvciA9DQogICAgICBnZXREZXNjcmlwdG9yKCkuZ2V0TWVzc2FnZVR5cGVzKCkuZ2V0KDEzKTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1NlbmRRdWV1ZU1lc3NhZ2VSZXN1bHRfZmllbGRBY2Nlc3NvclRhYmxlID0gbmV3DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUoDQogICAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfU2VuZFF1ZXVlTWVzc2FnZVJlc3VsdF9kZXNjcmlwdG9yLA0KICAgICAgICBuZXcgamF2YS5sYW5nLlN0cmluZ1tdIHsgIk1lc3NhZ2VJRCIsICJTZW50QXQiLCAiRXhwaXJhdGlvbkF0IiwgIkRlbGF5ZWRUbyIsICJJc0Vycm9yIiwgIkVycm9yIiwgfSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3RfZGVzY3JpcHRvciA9DQogICAgICBnZXREZXNjcmlwdG9yKCkuZ2V0TWVzc2FnZVR5cGVzKCkuZ2V0KDE0KTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1JlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVxdWVzdF9maWVsZEFjY2Vzc29yVGFibGUgPSBuZXcNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZSgNCiAgICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9SZWNlaXZlUXVldWVNZXNzYWdlc1JlcXVlc3RfZGVzY3JpcHRvciwNCiAgICAgICAgbmV3IGphdmEubGFuZy5TdHJpbmdbXSB7ICJSZXF1ZXN0SUQiLCAiQ2xpZW50SUQiLCAiQ2hhbm5lbCIsICJNYXhOdW1iZXJPZk1lc3NhZ2VzIiwgIldhaXRUaW1lU2Vjb25kcyIsICJJc1BlYWsiLCB9KTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1JlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZGVzY3JpcHRvciA9DQogICAgICBnZXREZXNjcmlwdG9yKCkuZ2V0TWVzc2FnZVR5cGVzKCkuZ2V0KDE1KTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX1JlY2VpdmVRdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZmllbGRBY2Nlc3NvclRhYmxlID0gbmV3DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUoDQogICAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfUmVjZWl2ZVF1ZXVlTWVzc2FnZXNSZXNwb25zZV9kZXNjcmlwdG9yLA0KICAgICAgICBuZXcgamF2YS5sYW5nLlN0cmluZ1tdIHsgIlJlcXVlc3RJRCIsICJNZXNzYWdlcyIsICJNZXNzYWdlc1JlY2VpdmVkIiwgIk1lc3NhZ2VzRXhwaXJlZCIsICJJc1BlYWsiLCAiSXNFcnJvciIsICJFcnJvciIsIH0pOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfQWNrQWxsUXVldWVNZXNzYWdlc1JlcXVlc3RfZGVzY3JpcHRvciA9DQogICAgICBnZXREZXNjcmlwdG9yKCkuZ2V0TWVzc2FnZVR5cGVzKCkuZ2V0KDE2KTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0Fja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0X2ZpZWxkQWNjZXNzb3JUYWJsZSA9IG5ldw0KICAgICAgY29tLmdvb2dsZS5wcm90b2J1Zi5HZW5lcmF0ZWRNZXNzYWdlVjMuRmllbGRBY2Nlc3NvclRhYmxlKA0KICAgICAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0Fja0FsbFF1ZXVlTWVzc2FnZXNSZXF1ZXN0X2Rlc2NyaXB0b3IsDQogICAgICAgIG5ldyBqYXZhLmxhbmcuU3RyaW5nW10geyAiUmVxdWVzdElEIiwgIkNsaWVudElEIiwgIkNoYW5uZWwiLCAiV2FpdFRpbWVTZWNvbmRzIiwgfSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZGVzY3JpcHRvciA9DQogICAgICBnZXREZXNjcmlwdG9yKCkuZ2V0TWVzc2FnZVR5cGVzKCkuZ2V0KDE3KTsNCiAgICBpbnRlcm5hbF9zdGF0aWNfa3ViZW1xX0Fja0FsbFF1ZXVlTWVzc2FnZXNSZXNwb25zZV9maWVsZEFjY2Vzc29yVGFibGUgPSBuZXcNCiAgICAgIGNvbS5nb29nbGUucHJvdG9idWYuR2VuZXJhdGVkTWVzc2FnZVYzLkZpZWxkQWNjZXNzb3JUYWJsZSgNCiAgICAgICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9BY2tBbGxRdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZGVzY3JpcHRvciwNCiAgICAgICAgbmV3IGphdmEubGFuZy5TdHJpbmdbXSB7ICJSZXF1ZXN0SUQiLCAiQWZmZWN0ZWRNZXNzYWdlcyIsICJJc0Vycm9yIiwgIkVycm9yIiwgfSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVxdWVzdF9kZXNjcmlwdG9yID0NCiAgICAgIGdldERlc2NyaXB0b3IoKS5nZXRNZXNzYWdlVHlwZXMoKS5nZXQoMTgpOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3RfZmllbGRBY2Nlc3NvclRhYmxlID0gbmV3DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUoDQogICAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfU3RyZWFtUXVldWVNZXNzYWdlc1JlcXVlc3RfZGVzY3JpcHRvciwNCiAgICAgICAgbmV3IGphdmEubGFuZy5TdHJpbmdbXSB7ICJSZXF1ZXN0SUQiLCAiQ2xpZW50SUQiLCAiU3RyZWFtUmVxdWVzdFR5cGVEYXRhIiwgIkNoYW5uZWwiLCAiVmlzaWJpbGl0eVNlY29uZHMiLCAiV2FpdFRpbWVTZWNvbmRzIiwgIlJlZlNlcXVlbmNlIiwgIk1vZGlmaWVkTWVzc2FnZSIsIH0pOw0KICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlX2Rlc2NyaXB0b3IgPQ0KICAgICAgZ2V0RGVzY3JpcHRvcigpLmdldE1lc3NhZ2VUeXBlcygpLmdldCgxOSk7DQogICAgaW50ZXJuYWxfc3RhdGljX2t1YmVtcV9TdHJlYW1RdWV1ZU1lc3NhZ2VzUmVzcG9uc2VfZmllbGRBY2Nlc3NvclRhYmxlID0gbmV3DQogICAgICBjb20uZ29vZ2xlLnByb3RvYnVmLkdlbmVyYXRlZE1lc3NhZ2VWMy5GaWVsZEFjY2Vzc29yVGFibGUoDQogICAgICAgIGludGVybmFsX3N0YXRpY19rdWJlbXFfU3RyZWFtUXVldWVNZXNzYWdlc1Jlc3BvbnNlX2Rlc2NyaXB0b3IsDQogICAgICAgIG5ldyBqYXZhLmxhbmcuU3RyaW5nW10geyAiUmVxdWVzdElEIiwgIlN0cmVhbVJlcXVlc3RUeXBlRGF0YSIsICJNZXNzYWdlIiwgIklzRXJyb3IiLCAiRXJyb3IiLCB9KTsNCiAgfQ0KDQogIC8vIEBAcHJvdG9jX2luc2VydGlvbl9wb2ludChvdXRlcl9jbGFzc19zY29wZSkNCn0NCg=="}, response: {"metadata":{"result":"ok"},"data":null,"is_error":false,"error":""}, error:<nil>	{"source": "sync.down"}
2021-06-26T13:14:19.623+0300	INFO	request: {"metadata":{"filename":"README.md","method":"save","path":"java/kubemq-java"},"data":"IyBKYXZhDQpUaGUgKipLdWJlTVEgU0RLIGZvciBKYXZhKiogZW5hYmxlcyBKYXZhIGRldmVsb3BlcnMgdG8gY29tbXVuaWNhdGUgd2l0aCBbS3ViZU1RXShodHRwczovL2t1YmVtcS5pby8pIHNlcnZlci4NCg0KIyMgR2VuZXJhbCBTREsgZGVzY3JpcHRpb24NClRoZSBTREsgaW1wbGVtZW50cyBhbGwgY29tbXVuaWNhdGlvbiBwYXR0ZXJucyBhdmFpbGFibGUgdGhyb3VnaCB0aGUgS3ViZU1RIHNlcnZlcjoNCi0gRXZlbnRzDQotIEV2ZW50U3RvcmUNCi0gQ29tbWFuZA0KLSBRdWVyeQ0KLSBRdWV1ZQ0KDQojIyMgUHJlcmVxdWlzaXRlcw0KDQpLdWJlTVEtU0RLLUphdmEgd29ya3Mgd2l0aCBKREsgOCsNCg0KIyMjIEluc3RhbGxpbmcNCg0KVGhlIHJlY29tbWVuZGVkIHdheSB0byB1c2UgdGhlIFNESyBmb3IgSmF2YSBpbiB5b3VyIHByb2plY3QgaXMgdG8gY29uc3VtZSBpdCBmcm9tIE1hdmVuLg0KaHR0cHM6Ly9vc3Muc29uYXR5cGUub3JnL3NlcnZpY2UvbG9jYWwvcmVwb3NpdG9yaWVzL3JlbGVhc2VzL2NvbnRlbnQvaW8va3ViZW1xL3Nkay9rdWJlbXEtc2RrLUphdmEvMC4xLjYva3ViZW1xLXNkay1KYXZhLTAuMS42Lmphcg0KVG8gYnVpbGQgd2l0aCBHcmFkbGUsIGFkZCB0aGUgZGVwZW5kZW5jeSBiZWxvdyB0byB5b3VyIGJ1aWxkLmdyYWRsZSBmaWxlLg0KDQpgYGAgamF2YQ0KY29tcGlsZSBncm91cDogJ2lvLmt1YmVtcS5zZGsnLCBuYW1lOiAna3ViZW1xLXNkay1KYXZhJywgdmVyc2lvbjogJzEuMC4zJw0KYGBgDQoNCiMjIENvbmZpZ3VyYXRpb25zDQpUaGUgb25seSByZXF1aXJlZCBjb25maWd1cmF0aW9uIHNldHRpbmcgaXMgdGhlIEt1YmVNUSBzZXJ2ZXIgYWRkcmVzcy4NCg0KQ29uZmlndXJhdGlvbiBjYW4gYmUgc2V0IGJ5IHVzaW5nIG9uZSBvZiB0aGUgZm9sbG93aW5nOg0KLSBFbnZpcm9ubWVudCBWYXJpYWJsZQ0KLSAnSmF2YSBQcm9wZXJ0eScNCg0KDQojIyMgQ29uZmlndXJhdGlvbiB2aWEgRW52aXJvbm1lbnQgVmFyaWFibGUNClNldCBgS3ViZU1RU2VydmVyQWRkcmVzc2AgdG8gdGhlIEt1YmVNUSBTZXJ2ZXIgQWRkcmVzcw0KDQoNCiMjIyBDb25maWd1cmF0aW9uIHZpYSBKYXZhIFByb3BlcnR5DQpieSBwYXNzaW5nIHRoZSAtREt1YmVNUVNlcnZlckFkZHJlc3M9IG9wdGlvbiB0byB0aGUgSlZNKQ0KV2l0aGluIHRoZSBjb2RlDQoNCiMjIyBDb25maWd1cmF0aW9uIHZpYSBjb2RlDQpXaGVuIHNldHRpbmcgdGhlIEt1YmVNUSBzZXJ2ZXIgYWRkcmVzcyB3aXRoaW4gdGhlIGNvZGUsIHNpbXBseSBwYXNzIHRoZSBhZGRyZXNzIGFzIGEgcGFyYW1ldGVyIHRvIHRoZSB2YXJpb3VzIGNvbnN0cnVjdG9ycy4NClNlZSBleGFjdGx5IGhvdyBpbiB0aGUgY29kZSBleGFtcGxlcyBpbiB0aGlzIGRvY3VtZW50Lg0KDQojIyBHZW5lcmF0aW5nIERvY3VtZW50YXRpb24NCg0KSmF2YWRvYyBpcyB1c2VkIGZvciBkb2N1bWVudGF0aW9uLiBZb3UgY2FuIGdlbmVyYXRlIEhUTUwgbG9jYWxseSB3aXRoIHRoZSBmb2xsb3dpbmc6DQoNCmBgYCBiYXNoDQouZ3JhZGxldyBqYXZhZG9jDQpgYGANCg0KIyMgUnVubmluZyB0aGUgZXhhbXBsZXMNCg0KVGhlIFtleGFtcGxlc10oaHR0cHM6Ly9naXRodWIuY29tL2t1YmVtcS1pby9rdWJlbXEtSmF2YS90cmVlL21hc3Rlci9leGFtcGxlcy9zcmMvbWFpbi9qYXZhL2lvL2t1YmVtcS9zZGsvZXhhbXBsZXMpDQphcmUgc3RhbmRhbG9uZSBwcm9qZWN0cyB0aGF0IHNob3djYXNlIHRoZSB1c2FnZSBvZiB0aGUgU0RLLg0KDQpUbyBydW4gdGhlIGV4YW1wbGVzLCB5b3UgbmVlZCB0byBoYXZlIGEgcnVubmluZyBpbnN0YW5jZSBvZiBLdWJlTVEuDQoNCllvdSBjYW4gdXNlIHRoZSBHcmFkbGUgdGFza3MgdG8gcnVuIHRoZSBleGFtcGxlczoNCg0KYGBgIGJhc2gNCi5ncmFkbGV3IGNvbW1hbmRRdWVyeUNoYW5uZWwNCi5ncmFkbGV3IGNvbW1hbmRRdWVyeUluaXRpYXRvcg0KLmdyYWRsZXcgY29tbWFuZFF1ZXJ5UmVzcG9uZGVyDQouZ3JhZGxldyBjb21tYW5kUXVlcnlSZXNwb25kZXJBc3luYw0KLmdyYWRsZXcgZXZlbnRDaGFubmVsDQouZ3JhZGxldyBldmVudFNlbmRlcg0KLmdyYWRsZXcgZXZlbnRTdWJzY3JpYmVyDQpgYGANCg0KIyMgQnVpbGRpbmcgZnJvbSBzb3VyY2UNCg0KT25jZSB5b3UgY2hlY2sgb3V0IHRoZSBjb2RlIGZyb20gR2l0SHViLCB5b3UgY2FuIGJ1aWxkIGl0IHVzaW5nIEdyYWRsZS4NCg0KYGBgIGJhc2gNCi5ncmFkbGV3IGJ1aWxkDQpgYGANCg0KIyMgUnVubmluZyB0aGUgdGVzdHMNCg0KVG8gcnVuIHRoZSBhdXRvbWF0ZWQgdGVzdHMgZm9yIHRoaXMgc3lzdGVtIGV4ZWN1dGU6DQoNCmBgYCBiYXNoDQouZ3JhZGxldyB0ZXN0DQpgYGANCg0KIyMgTWFpbiBDb25jZXB0cw0KDQotIE1ldGFkYXRhOiBUaGUgbWV0YWRhdGEgYWxsb3dzIHVzIHRvIHBhc3MgYWRkaXRpb25hbCBpbmZvcm1hdGlvbiB3aXRoIHRoZSBldmVudC4gQ2FuIGJlIGluIGFueSBmb3JtIHRoYXQgY2FuIGJlIHByZXNlbnRlZCBhcyBhIHN0cmluZywgaS5lLiwgc3RydWN0LCBKU09OLCBYTUwgYW5kIG1hbnkgbW9yZS4NCi0gQm9keTogVGhlIGFjdHVhbCBjb250ZW50IG9mIHRoZSBldmVudC4gQ2FuIGJlIGluIGFueSBmb3JtIHRoYXQgaXMgc2VyaWFsaXphYmxlIGludG8gYSBieXRlIGFycmF5LCBpLmUuLCBzdHJpbmcsIHN0cnVjdCwgSlNPTiwgWE1MLCBDb2xsZWN0aW9uLCBiaW5hcnkgZmlsZSBhbmQgbWFueSBtb3JlLg0KLSBDbGllbnRJRDogRGlzcGxheWVkIGluIGxvZ3MsIHRyYWNpbmcsIGFuZCBLdWJlTVEgZGFzaGJvYXJkKFdoZW4gdXNpbmcgRXZlbnRzIFN0b3JlLCBpdCBtdXN0IGJlIHVuaXF1ZSkuDQotIFRhZ3M6IFNldCBvZiBLZXkgdmFsdWUgcGFpciB0aGF0IGhlbHAgY2F0ZWdvcml6ZSB0aGUgbWVzc2FnZQ0KDQojIyMgRXZlbnQvRXZlbnRTdG9yZS9Db21tYW5kL1F1ZXJ5DQoNCi0gQ2hhbm5lbDogUmVwcmVzZW50cyB0aGUgZW5kcG9pbnQgdGFyZ2V0LiBPbmUtdG8tb25lIG9yIG9uZS10by1tYW55LiBSZWFsLVRpbWUgTXVsdGljYXN0Lg0KLSBHcm91cDogT3B0aW9uYWwgcGFyYW1ldGVyIHdoZW4gc3Vic2NyaWJpbmcgdG8gYSBjaGFubmVsLiBBIHNldCBvZiBzdWJzY3JpYmVycyBjYW4gZGVmaW5lIHRoZSBzYW1lIGdyb3VwIHNvIHRoYXQgb25seSBvbmUgb2YgdGhlIHN1YnNjcmliZXJzIHdpdGhpbiB0aGUgZ3JvdXAgd2lsbCByZWNlaXZlIGEgc3BlY2lmaWMgZXZlbnQuIFVzZWQgbWFpbmx5IGZvciBsb2FkIGJhbGFuY2luZy4gU3Vic2NyaWJpbmcgd2l0aG91dCB0aGUgZ3JvdXAgcGFyYW1ldGVyIGVuc3VyZXMgcmVjZWl2aW5nIGFsbCB0aGUgY2hhbm5lbCBtZXNzYWdlcy4gKFdoZW4gdXNpbmcgR3JvdXBpbmcgYWxsIHRoZSBwcm9ncmFtcyB0aGF0IGFyZSBhc3NpZ25lZCB0byB0aGUgZ3JvdXAgbmVlZCB0byBoYXZlIHRvIHNhbWUgY2hhbm5lbCBuYW1lKQ0KLSBFdmVudCBTdG9yZTogVGhlIEV2ZW50IFN0b3JlIHJlcHJlc2VudHMgYSBwZXJzaXN0ZW5jZSBzdG9yZSwgc2hvdWxkIGJlIHVzZWQgd2hlbiBuZWVkIHRvIHN0b3JlIGRhdGEgb24gYSB2b2x1bWUuDQoNCiMjIyBRdWV1ZQ0KDQotIFF1ZXVlOiBSZXByZXNlbnRzIGEgdW5pcXVlIEZJRk8gcXVldWUgbmFtZSwgdXNlZCBpbiBxdWV1ZSBwYXR0ZXJuLg0KLSBUcmFuc2FjdGlvbjogUmVwcmVzZW50cyBhbiBScGMgc3RyZWFtIGZvciBzaW5nbGUgbWVzc2FnZSB0cmFuc2FjdGlvbi4NCg0KIyMjIFF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMuKHByb3RvIHN0cnVjdCkNCi0gVGltZXN0YW1wIC0gd2hlbiB0aGUgbWVzc2FnZSBhcnJpdmVkIHRvIHF1ZXVlLg0KLSBTZXF1ZW5jZSAtIHRoZSBtZXNzYWdlIG9yZGVyIGluIHRoZSBxdWV1ZS4NCi0gTUQ1T2ZCb2R5IC0gQW4gTUQ1IGRpZ2VzdCBub24tVVJMLWVuY29kZWQgbWVzc2FnZSBib2R5IHN0cmluZy4NCi0gUmVjZWl2ZUNvdW50IC0gaG93IG1hbnkgcmVjaWV2ZWQuDQotIFJlUm91dGVkIC0gaWYgdGhlIG1lc3NhZ2Ugd2FzIFJlUm91dGVkIGZyb20gYW5vdGhlciBwb2ludC4NCi0gUmVSb3V0ZWRGcm9tUXVldWUgLSBmcm9tIHdoZXJlIHRoZSBtZXNzYWdlIHdhcyBSZVJvdXRlZA0KLSBFeHBpcmF0aW9uQXQgLSBFeHBpcmF0aW9uIHRpbWUgb2YgdGhlIG1lc3NhZ2UuDQotIERlbGF5ZWRUbyAtaWYgdGhlIG1lc3NhZ2Ugd2FzIERlbGF5ZWQuDQoNCmBgYA0KICBtZXNzYWdlIFF1ZXVlTWVzc2FnZUF0dHJpYnV0ZXMgew0KICAgICAgaW50NjQgICAgICAgICAgICAgICBUaW1lc3RhbXAgICAgICAgICAgICAgICAgICAgPTE7DQogICAgICB1aW50NjQgICAgICAgICAgICAgIFNlcXVlbmNlICAgICAgICAgICAgICAgICAgICA9MjsNCiAgICAgIHN0cmluZyAgICAgICAgICAgICAgTUQ1T2ZCb2R5ICAgICAgICAgICAgICAgICAgID0zOw0KICAgICAgaW50MzIgICAgICAgICAgICAgICBSZWNlaXZlQ291bnQgICAgICAgICAgICAgICAgPTQ7DQogICAgICBib29sICAgICAgICAgICAgICAgIFJlUm91dGVkICAgICAgICAgICAgICAgICAgICA9NTsNCiAgICAgIHN0cmluZyAgICAgICAgICAgICAgUmVSb3V0ZWRGcm9tUXVldWUgICAgICAgICAgID02Ow0KICAgICAgaW50NjQgICAgICAgICAgICAgICBFeHBpcmF0aW9uQXQgICAgICAgICAgICAgICAgPTc7DQogICAgICBpbnQ2NCAgICAgICAgICAgICAgIERlbGF5ZWRUbyAgICAgICAgICAgICAgICAgICA9ODsNCg0KICB9DQpgYGANCg0KIyMjIEV2ZW50L0V2ZW50U3RvcmUvQ29tbWFuZC9RdWVyeSBTdWJzY3JpYmVSZXF1ZXN0IE9iamVjdDoNCg0KQSBzdHJ1Y3QgdGhhdCBpcyB1c2VkIHRvIGluaXRpYWxpemUgU3Vic2NyaWJlVG9FdmVudHMvU3Vic2NyaWJlVG9SZXF1ZXN0LCB0aGUgU3Vic2NyaWJlUmVxdWVzdCBjb250YWlucyB0aGUgZm9sbG93aW5nOg0KDQotIFN1YnNjcmliZVR5cGUgLSBNYW5kYXRvcnkgLSBFbnVtIHRoYXQgcmVwcmVzZW50cyB0aGUgc3Vic2NyaXB0aW9uIHR5cGU6DQotIEV2ZW50cyAtIGlmIHRoZXJlIGlzIG5vIG5lZWQgZm9yIFBlcnNpc3RlbmNlLg0KLSBFdmVudHNTdG9yZSAtIElmIHlvdSB3YW50IHRvIHJlY2VpdmUgRXZlbnRzIGZyb20gcGVyc2lzdGVuY2UuIFNlZSBNYWluIGNvbmNlcHRzLg0KLSBDb21tYW5kIC0gU2hvdWxkIGJlIHVzZWQgd2hlbiBhIHJlc3BvbnNlIGlzIG5vdCBuZWVkZWQuDQotIFF1ZXJ5IC0gU2hvdWxkIGJlIHVzZWQgd2hlbiBhIHJlc3BvbnNlIGlzIG5lZWRlZC4NCi0gQ2xpZW50SUQgLSBNYW5kYXRvcnkgLSBTZWUgTWFpbiBjb25jZXB0cw0KLSBDaGFubmVsIC0gTWFuZGF0b3J5IC0gU2VlIE1haW4gY29uY2VwdHMNCi0gR3JvdXAgLSBPcHRpb25hbCAtIFNlZSBNYWluIGNvbmNlcHRzDQotIEV2ZW50c1N0b3JlVHlwZSAtIE1hbmRhdG9yeSAtIHNldCB0aGUgdHlwZSBldmVudCBzdG9yZSB0byBzdWJzY3JpYmUgdG8gTWFpbiBjb25jZXB0cy4NCg0KIyMgUXVldWUNCg0KS3ViZU1RIHN1cHBvcnRzIGRpc3RyaWJ1dGVkIGR1cmFibGUgRklGTyBiYXNlZCBxdWV1ZXMgd2l0aCB0aGUgZm9sbG93aW5nIGNvcmUgZmVhdHVyZXM6DQoNCi0gRXhhY3RseSBPbmUgRGVsaXZlcnkgLSBPbmx5IG9uZSBtZXNzYWdlIGd1YXJhbnRlZSB3aWxsIGRlbGl2ZXIgdG8gdGhlIHN1YnNjcmliZXINCi0gU2luZ2xlIGFuZCBCYXRjaCBNZXNzYWdlcyBTZW5kIGFuZCBSZWNlaXZlIC0gU2luZ2xlIGFuZCBtdWx0aXBsZSBtZXNzYWdlcyBpbiBvbmUgY2FsbA0KLSBSUEMgYW5kIFN0cmVhbSBGbG93IC0gUlBDIGZsb3cgYWxsb3dzIGFuIGluc2VydCBhbmQgcHVsbHMgbWVzc2FnZXMgaW4gb25lIGNhbGwuIFN0cmVhbSBmbG93IGFsbG93cyBzaW5nbGUgbWVzc2FnZSBjb25zdW1pbmcgaW4gYSB0cmFuc2FjdGlvbmFsIHdheQ0KLSBNZXNzYWdlIFBvbGljeSAtIEVhY2ggbWVzc2FnZSBjYW4gYmUgY29uZmlndXJlZCB3aXRoIGV4cGlyYXRpb24gYW5kIGRlbGF5IHRpbWVycy4gQWxzbywgZWFjaCBtZXNzYWdlIGNhbiBzcGVjaWZ5IGEgZGVhZC1sZXR0ZXIgcXVldWUgZm9yIHVuLXByb2Nlc3NlZCBtZXNzYWdlcyBhdHRlbXB0cw0KLSBMb25nIFBvbGxpbmcgLSBDb25zdW1lcnMgY2FuIHdhaXQgdW50aWwgYSBtZXNzYWdlIGF2YWlsYWJsZSBpbiB0aGUgcXVldWUgdG8gY29uc3VtZQ0KLSBQZWFrIE1lc3NhZ2VzIC0gQ29uc3VtZXJzIGNhbiBwZWVrIGludG8gYSBxdWV1ZSB3aXRob3V0IHJlbW92aW5nIHRoZW0gZnJvbSB0aGUgcXVldWUNCi0gQWNrIEFsbCBRdWV1ZSBNZXNzYWdlcyAtIEFueSBjbGllbnQgY2FuIG1hcmsgYWxsIHRoZSBtZXNzYWdlcyBpbiBhIHF1ZXVlIGFzIGRpc2NhcmRlZCBhbmQgd2lsbCBub3QgYmUgYXZhaWxhYmxlIGFueW1vcmUgdG8gY29uc3VtZQ0KLSBWaXNpYmlsaXR5IHRpbWVycyAtIENvbnN1bWVycyBjYW4gcHVsbCBhIG1lc3NhZ2UgZnJvbSB0aGUgcXVldWUgYW5kIHNldCBhIHRpbWVyIHdoaWNoIHdpbGwgY2F1c2UgdGhlIG1lc3NhZ2Ugbm90IGJlIHZpc2libGUgdG8gb3RoZXIgY29uc3VtZXJzLiBUaGlzIHRpbWVyIGNhbiBiZSBleHRlbmRlZCBhcyBuZWVkZWQuDQotIFJlc2VuZCBNZXNzYWdlcyAtIENvbnN1bWVycyBjYW4gc2VuZCBiYWNrIGEgbWVzc2FnZSB0aGV5IHB1bGxlZCB0byBhIG5ldyBxdWV1ZSBvciBzZW5kIGEgbW9kaWZpZWQgbWVzc2FnZSB0byB0aGUgc2FtZSBxdWV1ZSBmb3IgZnVydGhlciBwcm9jZXNzaW5nLg0KDQojIyMgU2VuZCBNZXNzYWdlIHRvIGEgUXVldWUNCg0KYGBgamF2YQ0KICBRdWV1ZSBxdWV1ZSA9IG5ldyBRdWV1ZSgiUXVldWVOYW1lIiwgIkNsaWVudElEIiwgImxvY2FsaG9zdDo1MDAwMCIpOw0KICBTZW5kTWVzc2FnZVJlc3VsdCByZXNTZW5kID0gcXVldWUuU2VuZFF1ZXVlTWVzc2FnZShuZXcgTWVzc2FnZSgpDQogICAgICAgICAgLnNldEJvZHkoQ29udmVydGVyLlRvQnl0ZUFycmF5KCJzb21lLXNpbXBsZV9xdWV1ZS1xdWV1ZS1tZXNzYWdlIikpDQogICAgICAgICAgLnNldE1ldGFkYXRhKCJzb21lTWV0YSIpKTsNCiAgaWYgKHJlc1NlbmQuZ2V0SXNFcnJvcigpKSB7DQogICAgICBTeXN0ZW0ub3V0LnByaW50ZigiTWVzc2FnZSBlbnF1ZXVlIGVycm9yLCBlcnJvcjogJXMiLCByZXNTZW5kLmdldEVycm9yKCkpOw0KICB9DQpgYGANCg0KICMjIyBTZW5kIE1lc3NhZ2UgdG8gYSBRdWV1ZSB3aXRoIEV4cGlyYXRpb24NCg0KYGBgamF2YQ0KICBRdWV1ZSBxdWV1ZSA9IG5ldyBRdWV1ZSgiUXVldWVOYW1lIiwgIkNsaWVudElEIiwgImxvY2FsaG9zdDo1MDAwMCIpOw0KICBTZW5kTWVzc2FnZVJlc3VsdCByZXNTZW5kID0gcXVldWUNCiAgICAgICAgICAuU2VuZFF1ZXVlTWVzc2FnZShuZXcgTWVzc2FnZSgpDQogICAgICAgICAgLnNldEJvZHkoQ29udmVydGVyLlRvQnl0ZUFycmF5KCJzb21lLXNpbXBsZV9xdWV1ZS1xdWV1ZS1tZXNzYWdlIikpDQogICAgICAgICAgLnNldE1ldGFkYXRhKCJzb21lTWV0YSIpDQogICAgICAgICAgLnNldEV4cGlyYXRpb24oNSkpOw0KICBpZiAocmVzU2VuZC5nZXRJc0Vycm9yKCkpIHsNCiAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJNZXNzYWdlIGVucXVldWUgZXJyb3IsIGVycm9yOiAlcyIsIHJlc1NlbmQuZ2V0RXJyb3IoKSk7DQogIH0NCmBgYA0KDQojIyMgU2VuZCBNZXNzYWdlIHRvIGEgUXVldWUgd2l0aCBEZWxheQ0KDQpgYGBqYXZhDQogIFF1ZXVlIHF1ZXVlID0gbmV3IFF1ZXVlKCJRdWV1ZU5hbWUiLCAiQ2xpZW50SUQiLCAibG9jYWxob3N0OjUwMDAwIik7DQogIFNlbmRNZXNzYWdlUmVzdWx0IHJlc1NlbmQgPSBxdWV1ZS5TZW5kUXVldWVNZXNzYWdlKG5ldyBNZXNzYWdlKCkNCiAgICAgICAgICAuc2V0Qm9keShDb252ZXJ0ZXIuVG9CeXRlQXJyYXkoInNvbWUtc2ltcGxlX3F1ZXVlLXF1ZXVlLW1lc3NhZ2UiKSkNCiAgICAgICAgICAuc2V0TWV0YWRhdGEoInNvbWVNZXRhIikNCiAgICAgICAgICAuc2V0RGVsYXkoMykpOw0KICBpZiAocmVzU2VuZC5nZXRJc0Vycm9yKCkpIHsNCiAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJNZXNzYWdlIGVucXVldWUgZXJyb3IsIGVycm9yOiAlcyIsIHJlc1NlbmQuZ2V0RXJyb3IoKSk7DQogIH0NCmBgYA0KDQojIyMgU2VuZCBNZXNzYWdlIHRvIGEgUXVldWUgd2l0aCBEZWFkLWxldHRlciBRdWV1ZQ0KDQpgYGBqYXZhDQogIFF1ZXVlIHF1ZXVlID0gbmV3IFF1ZXVlKCJRdWV1ZU5hbWUiLCAiQ2xpZW50SUQiLCAibG9jYWxob3N0OjUwMDAwIik7DQogIFNlbmRNZXNzYWdlUmVzdWx0IHJlc1NlbmQgPSBxdWV1ZQ0KICAgICAgICAgIC5TZW5kUXVldWVNZXNzYWdlKG5ldyBNZXNzYWdlKCkNCiAgICAgICAgICAuc2V0Qm9keShDb252ZXJ0ZXIuVG9CeXRlQXJyYXkoInNvbWUtc2ltcGxlX3F1ZXVlLXF1ZXVlLW1lc3NhZ2UiKSkNCiAgICAgICAgICAuc2V0TWV0YWRhdGEoInNvbWVNZXRhIikNCiAgICAgICAgICAuc2V0TWF4UmVjaXZlQ291bnQoMykNCiAgICAgICAgICAuc2V0TWF4UmVjaXZlUXVldWUoIkRlYWRMZXR0ZXJRdWV1ZSIpKTsNCiAgaWYgKHJlc1NlbmQuZ2V0SXNFcnJvcigpKSB7DQogICAgICBTeXN0ZW0ub3V0LnByaW50ZigiTWVzc2FnZSBlbnF1ZXVlIGVycm9yLCBlcnJvcjogJXMiLCByZXNTZW5kLmdldEVycm9yKCkpOw0KICB9DQpgYGANCg0KIyMjIFNlbmQgQmF0Y2ggTWVzc2FnZXMNCg0KYGBgamF2YQ0KICBRdWV1ZSBxdWV1ZSA9IG5ldyBRdWV1ZSgiUXVldWVOYW1lIiwgIkNsaWVudElEIiwgImxvY2FsaG9zdDo1MDAwMCIpOw0KICBDb2xsZWN0aW9uPE1lc3NhZ2U+IGJhdGNoID0gbmV3IEFycmF5TGlzdDxNZXNzYWdlPigpOw0KDQogIGZvciAoaW50IGkgPSAwOyBpIDwgMTA7IGkrKykgew0KICAgICAgYmF0Y2guYWRkKG5ldyBNZXNzYWdlKCkNCiAgICAgIC5zZXRCb2R5KENvbnZlcnRlci5Ub0J5dGVBcnJheSgiQmF0Y2ggTWVzc2FnZSAiICsgaSkpKTsNCiAgfQ0KDQogIFNlbmRCYXRjaE1lc3NhZ2VSZXN1bHQgcmVzQmF0Y2ggPSBxdWV1ZS5TZW5kUXVldWVNZXNzYWdlc0JhdGNoKGJhdGNoKTsNCiAgaWYgKHJlc0JhdGNoLmdldEhhdmVFcnJvcnMoKSkgew0KICAgICAgU3lzdGVtLm91dC5wcmludCgiTWVzc2FnZSBzZW50IGJhdGNoIGhhcyBlcnJvcnMiKTsNCiAgfQ0KICBmb3IgKFNlbmRNZXNzYWdlUmVzdWx0IHJlc1NlbmQgOiByZXNCYXRjaC5nZXRSZXN1bHRzKCkpIHsNCiAgICAgIGlmIChyZXNTZW5kLmdldElzRXJyb3IoKSkgew0KICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJNZXNzYWdlIGVucXVldWUgZXJyb3IsIGVycm9yOiAlcyIsIHJlc1NlbmQuZ2V0RXJyb3IoKSk7DQogICAgICB9IGVsc2Ugew0KICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJTZW5kIHRvIFF1ZXVlIFJlc3VsdDogTWVzc2FnZUlEOiAlcywgU2VudCBBdDolcyIsIHJlc1NlbmQuZ2V0TWVzc2FnZUlEKCksDQogICAgICAgICAgICAgICAgQ29udmVydGVyLkZyb21Vbml4VGltZShyZXNTZW5kLmdldFNlbnRBdCgpKS50b1N0cmluZygpKTsNCg0KICAgICAgfQ0KDQogIH0NCmBgYA0KDQojIyMgUmVjZWl2ZSBNZXNzYWdlcyBmcm9tIGEgUXVldWUNCg0KYGBgamF2YQ0KICBRdWV1ZSBxdWV1ZSA9IG5ldyBRdWV1ZSgiUXVldWVOYW1lIiwgIkNsaWVudElEIiwgImxvY2FsaG9zdDo1MDAwMCIpOw0KICBSZWNlaXZlTWVzc2FnZXNSZXNwb25zZSByZXNSZWMgPSBxdWV1ZS5SZWNlaXZlUXVldWVNZXNzYWdlcygxMCwgMSk7DQogIGlmIChyZXNSZWMuZ2V0SXNFcnJvcigpKSB7DQogICAgICBTeXN0ZW0ub3V0LnByaW50ZigiTWVzc2FnZSBkZXF1ZXVlIGVycm9yLCBlcnJvcjogJXMiLCByZXNSZWMuZ2V0RXJyb3IoKSk7DQogICAgICByZXR1cm47DQogIH0NCiAgU3lzdGVtLm91dC5wcmludGYoIlJlY2VpdmVkIE1lc3NhZ2VzICVzOiIsIHJlc1JlYy5nZXRNZXNzYWdlc1JlY2VpdmVkKCkpOw0KICBmb3IgKE1lc3NhZ2UgbXNnIDogcmVzUmVjLmdldE1lc3NhZ2VzKCkpIHsNCiAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJNZXNzYWdlSUQ6ICVzLCBCb2R5OiVzIiwgbXNnLmdldE1lc3NhZ2VJRCgpLCBDb252ZXJ0ZXIuRnJvbUJ5dGVBcnJheShtc2cuZ2V0Qm9keSgpKSk7DQogIH0NCmBgYA0KDQojIyMgUGVlayBNZXNzYWdlcyBmcm9tIGEgUXVldWUNCg0KYGBgamF2YQ0KICBRdWV1ZSBxdWV1ZSA9IG5ldyBRdWV1ZSgiUXVldWVOYW1lIiwgIkNsaWVudElEIiwgImxvY2FsaG9zdDo1MDAwMCIpOw0KICBSZWNlaXZlTWVzc2FnZXNSZXNwb25zZSByZXNQZWsgPSBxdWV1ZS5QZWVrUXVldWVNZXNzYWdlKDEwLCAxKTsNCiAgaWYgKHJlc1Blay5nZXRJc0Vycm9yKCkpIHsNCiAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJNZXNzYWdlIGRlcXVldWUgZXJyb3IsIGVycm9yOiAlcyIsIHJlc1Blay5nZXRFcnJvcigpKTsNCiAgICAgIHJldHVybjsNCiAgfQ0KICBTeXN0ZW0ub3V0LnByaW50ZigiUmVjZWl2ZWQgTWVzc2FnZXM6ICVzIiwgcmVzUGVrLmdldE1lc3NhZ2VzUmVjZWl2ZWQoKSk7DQogIGZvciAoTWVzc2FnZSBtc2cgOiByZXNQZWsuZ2V0TWVzc2FnZXMoKSkgew0KICAgICAgU3lzdGVtLm91dC5wcmludGYoIk1lc3NhZ2VJRDogJXMsIEJvZHk6ICVzIiwgbXNnLmdldE1lc3NhZ2VJRCgpLCBDb252ZXJ0ZXIuRnJvbUJ5dGVBcnJheShtc2cuZ2V0Qm9keSgpKSk7DQogIH0gICAgICAgIA0KYGBgDQojIyMgQWNrIEFsbCBNZXNzYWdlcyBJbiBhIFF1ZXVlDQoNCmBgYGphdmENCiAgUXVldWUgcXVldWUgPSBuZXcgUXVldWUoIlF1ZXVlTmFtZSIsICJDbGllbnRJRCIsICJsb2NhbGhvc3Q6NTAwMDAiKTsNCiAgQWNrQWxsTWVzc2FnZXNSZXNwb25zZSByZXNBY2sgPSBxdWV1ZS5BY2tBbGxRdWV1ZU1lc3NhZ2VzKCk7DQogIGlmIChyZXNBY2suZ2V0SXNFcnJvcigpKSB7DQogICAgICBTeXN0ZW0ub3V0LnByaW50ZigiQWNrQWxsUXVldWVNZXNzYWdlc1Jlc3BvbnNlIGVycm9yLCBlcnJvcjogJXMiLCByZXNBY2suZ2V0RXJyb3IoKSk7DQogICAgICByZXR1cm47DQogIH0NCiAgU3lzdGVtLm91dC5wcmludGYoIkFjayBBbGwgTWVzc2FnZXM6ICVkIGNvbXBsZXRlZCIsIHJlc0Fjay5nZXRBZmZlY3RlZE1lc3NhZ2VzKCkpOw0KYGBgDQoNCiMjIyBUcmFuc2FjdGlvbmFsIFF1ZXVlIC0gQWNrDQpgYGBqYXZhDQogIFF1ZXVlIHF1ZXVlID0gbmV3IFF1ZXVlKCJRdWV1ZU5hbWUiLCAiQ2xpZW50SUQiLCAibG9jYWxob3N0OjUwMDAwIik7DQogIFRyYW5zYWN0aW9uIHRyYW4gPSBxdWV1ZS5DcmVhdGVUcmFuc2FjdGlvbigpOw0KDQogIFRyYW5zYWN0aW9uTWVzc2FnZXNSZXNwb25zZSByZXNSZWMgPSB0cmFuLlJlY2VpdmUoMTAsIDEwKTsNCiAgaWYgKHJlc1JlYy5nZXRJc0Vycm9yKCkpIHsNCiAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJNZXNzYWdlIGRlcXVldWUgZXJyb3IsIGVycm9yOiAlcyIsIHJlc1JlYy5nZXRFcnJvcigpKTsNCiAgICAgIHJldHVybjsNCiAgfQ0KICBTeXN0ZW0ub3V0LnByaW50ZigiTWVzc2FnZUlEOiAlZCwgQm9keTogJXMiLCByZXNSZWMuZ2V0TWVzc2FnZSgpLmdldE1lc3NhZ2VJRCgpLA0KICAgICAgICAgIENvbnZlcnRlci5Gcm9tQnl0ZUFycmF5KHJlc1JlYy5nZXRNZXNzYWdlKCkuZ2V0Qm9keSgpKSk7DQogIFN5c3RlbS5vdXQucHJpbnRsbigiRG9pbmcgc29tZSB3b3JrLi4uLi4iKTsNCg0KICBUaHJlYWQuc2xlZXAoMTAwMCk7DQogIFN5c3RlbS5vdXQucHJpbnRsbigiRG9uZSwgYWNrIHRoZSBtZXNzYWdlIik7DQogIFRyYW5zYWN0aW9uTWVzc2FnZXNSZXNwb25zZSByZXNBY2sgPSB0cmFuLkFja01lc3NhZ2UoKTsNCiAgaWYgKHJlc0Fjay5nZXRJc0Vycm9yKCkpIHsNCiAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJBY2sgbWVzc2FnZSBlcnJvcjogJXMiLCByZXNBY2suZ2V0RXJyb3IoKSk7DQogIH0NCmBgYA0KDQojIyMgVHJhbnNhY3Rpb25hbCBRdWV1ZSAtIFJlamVjdA0KDQpgYGBqYXZhDQogIFF1ZXVlIHF1ZXVlID0gbmV3IFF1ZXVlKCJRdWV1ZU5hbWUiLCAiQ2xpZW50SUQiLCAibG9jYWxob3N0OjUwMDAwIik7DQogIFRyYW5zYWN0aW9uIHRyYW4gPSBxdWV1ZS5DcmVhdGVUcmFuc2FjdGlvbigpOw0KICBUcmFuc2FjdGlvbk1lc3NhZ2VzUmVzcG9uc2UgcmVzUmVjID0gdHJhbi5SZWNlaXZlKDEwLCAxMCk7DQogIGlmIChyZXNSZWMuZ2V0SXNFcnJvcigpKSB7DQogICAgICBTeXN0ZW0ub3V0LnByaW50ZigiTWVzc2FnZSBkZXF1ZXVlIGVycm9yLCBlcnJvcjogJXMiLCByZXNSZWMuZ2V0RXJyb3IoKSk7DQogICAgICByZXR1cm47DQogIH0NCiAgU3lzdGVtLm91dC5wcmludGYoIk1lc3NhZ2VJRDogJWQsIEJvZHk6ICVzIiwgcmVzUmVjLmdldE1lc3NhZ2UoKS5nZXRNZXNzYWdlSUQoKSwNCiAgICAgICAgICBDb252ZXJ0ZXIuRnJvbUJ5dGVBcnJheShyZXNSZWMuZ2V0TWVzc2FnZSgpLmdldEJvZHkoKSkpOw0KICBTeXN0ZW0ub3V0LnByaW50bG4oIlJlamVjdCBtZXNzYWdlIik7DQogIFRyYW5zYWN0aW9uTWVzc2FnZXNSZXNwb25zZSByZXNSZWogPSB0cmFuLlJlamVjdE1lc3NhZ2UoKTsNCiAgaWYgKHJlc1Jlai5nZXRJc0Vycm9yKCkpIHsNCiAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJNZXNzYWdlIGRlcXVldWUgZXJyb3IsIGVycm9yOiAlcyIsIHJlc1Jlai5nZXRFcnJvcigpKTsNCiAgICAgIHJldHVybjsNCiAgfQ0KYGBgDQoNCiMjIyBUcmFuc2FjdGlvbmFsIFF1ZXVlIC0gRXh0ZW5kIFZpc2liaWxpdHkNCg0KYGBgamF2YQ0KICBRdWV1ZSBxdWV1ZSA9IG5ldyBRdWV1ZSgiUXVldWVOYW1lIiwgIkNsaWVudElEIiwgImxvY2FsaG9zdDo1MDAwMCIpOw0KICBUcmFuc2FjdGlvbiB0cmFuID0gcXVldWUuQ3JlYXRlVHJhbnNhY3Rpb24oKTsNCiAgVHJhbnNhY3Rpb25NZXNzYWdlc1Jlc3BvbnNlIHJlc1JlYyA9IHRyYW4uUmVjZWl2ZSg1LCAxMCk7DQogIGlmIChyZXNSZWMuZ2V0SXNFcnJvcigpKSB7DQogICAgICBTeXN0ZW0ub3V0LnByaW50ZigiTWVzc2FnZSBkZXF1ZXVlIGVycm9yLCBlcnJvcjogJXMiLCByZXNSZWMuZ2V0RXJyb3IoKSk7DQogICAgICByZXR1cm47DQogIH0NCiAgU3lzdGVtLm91dC5wcmludGYoIk1lc3NhZ2VJRDogJWQsIEJvZHk6ICVzIiwgcmVzUmVjLmdldE1lc3NhZ2UoKS5nZXRNZXNzYWdlSUQoKSwNCiAgICAgICAgICBDb252ZXJ0ZXIuRnJvbUJ5dGVBcnJheShyZXNSZWMuZ2V0TWVzc2FnZSgpLmdldEJvZHkoKSkpOw0KICBTeXN0ZW0ub3V0LnByaW50bG4oIndvcmsgZm9yIDEgc2Vjb25kcyIpOw0KICBUaHJlYWQuc2xlZXAoMTAwMCk7DQogIFN5c3RlbS5vdXQucHJpbnRsbigiTmVlZCBtb3JlIHRpbWUgdG8gcHJvY2VzcywgZXh0ZW5kIHZpc2liaWxpdHkgZm9yIG1vcmUgMyBzZWNvbmRzIik7DQogIFRyYW5zYWN0aW9uTWVzc2FnZXNSZXNwb25zZSByZXNFeHQgPSB0cmFuLkV4dGVuZFZpc2liaWxpdHkoMyk7DQogIGlmIChyZXNFeHQuZ2V0SXNFcnJvcigpKSB7DQogICAgICBTeXN0ZW0ub3V0LnByaW50ZigiTWVzc2FnZSBkZXF1ZXVlIGVycm9yLCBlcnJvcjogJXMiLCByZXNFeHQuZ2V0RXJyb3IoKSk7DQogICAgICByZXR1cm47DQogIH0NCiAgU3lzdGVtLm91dC5wcmludGxuKCJBcHByb3ZlZC4gd29yayBmb3IgMi41IHNlY29uZHMiKTsNCiAgVGhyZWFkLnNsZWVwKDI1MDApOw0KICBTeXN0ZW0ub3V0LnByaW50bG4oIldvcmsgZG9uZS4uLiBhY2sgdGhlIG1lc3NhZ2UiKTsNCiAgVHJhbnNhY3Rpb25NZXNzYWdlc1Jlc3BvbnNlIHJlc0FjayA9IHRyYW4uQWNrTWVzc2FnZSgpOw0KICBpZiAocmVzQWNrLmdldElzRXJyb3IoKSkgew0KICAgICAgU3lzdGVtLm91dC5wcmludGYoIkFjayBtZXNzYWdlIGVycm9yOiAlcyIsIHJlc0Fjay5nZXRFcnJvcigpKTsNCg0KICB9DQogIFN5c3RlbS5vdXQucHJpbnRsbigiQWNrIGRvbmUiKTsNCmBgYA0KDQojIyMgVHJhbnNhY3Rpb25hbCBRdWV1ZSAtIFJlc2VuZCB0byBOZXcgUXVldWUNCg0KYGBgamF2YQ0KICBRdWV1ZSBxdWV1ZSA9IG5ldyBRdWV1ZSgiUXVldWVOYW1lIiwgIkNsaWVudElEIiwgImxvY2FsaG9zdDo1MDAwMCIpOw0KICBUcmFuc2FjdGlvbiB0cmFuID0gcXVldWUuQ3JlYXRlVHJhbnNhY3Rpb24oKTsNCiAgVHJhbnNhY3Rpb25NZXNzYWdlc1Jlc3BvbnNlIHJlc1JlYyA9IHRyYW4uUmVjZWl2ZSg1MDAsIDEwKTsNCiAgaWYgKHJlc1JlYy5nZXRJc0Vycm9yKCkpIHsNCiAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJNZXNzYWdlIGRlcXVldWUgZXJyb3IsIGVycm9yOiAlcyIsIHJlc1JlYy5nZXRFcnJvcigpKTsNCiAgICAgIHJldHVybjsNCiAgfQ0KICBTeXN0ZW0ub3V0LnByaW50ZigiTWVzc2FnZUlEOiAlZCwgQm9keTolcyIsIHJlc1JlYy5nZXRNZXNzYWdlKCkuZ2V0TWVzc2FnZUlEKCksDQogICAgICAgICAgQ29udmVydGVyLkZyb21CeXRlQXJyYXkocmVzUmVjLmdldE1lc3NhZ2UoKS5nZXRCb2R5KCkpKTsNCiAgVHJhbnNhY3Rpb25NZXNzYWdlc1Jlc3BvbnNlIHJlc01vZCA9IHRyYW4NCiAgICAgICAgICAuTW9kaWZ5KHJlc1JlYy5nZXRNZXNzYWdlKCkuc2V0UXVldWUoInJlY2VpdmVyQiIpLnNldE1ldGFkYXRhKCJuZXcgbWVhdGRhdGEiKSk7DQogIGlmIChyZXNNb2QuZ2V0SXNFcnJvcigpKSB7DQogICAgICBTeXN0ZW0ub3V0LnByaW50ZigiTWVzc2FnZSBNb2RpZnkgZXJyb3IsIGVycm9yOjolcyIsIHJlc01vZC5nZXRFcnJvcigpKTsNCiAgICAgIHJldHVybjsNCiAgfQ0KYGBgDQoNCiMjIyBUcmFuc2FjdGlvbmFsIFF1ZXVlIC0gUmVzZW5kIE1vZGlmaWVkIE1lc3NhZ2UNCmBgYGphdmENCiAgUXVldWUgcXVldWUgPSBuZXcgUXVldWUoIlF1ZXVlTmFtZSIsICJDbGllbnRJRCIsICJsb2NhbGhvc3Q6NTAwMDAiKTsNCiAgVHJhbnNhY3Rpb24gdHJhbiA9IHF1ZXVlLkNyZWF0ZVRyYW5zYWN0aW9uKCk7DQogIFRyYW5zYWN0aW9uTWVzc2FnZXNSZXNwb25zZSByZXNSZWMgPSB0cmFuLlJlY2VpdmUoNSwgMTApOw0KICBpZiAocmVzUmVjLmdldElzRXJyb3IoKSkgew0KICAgICAgU3lzdGVtLm91dC5wcmludGYoIk1lc3NhZ2UgZGVxdWV1ZSBlcnJvciwgZXJyb3I6ICVzIiwgcmVzUmVjLmdldEVycm9yKCkpOw0KICAgICAgcmV0dXJuOw0KICB9DQogIFN5c3RlbS5vdXQucHJpbnRmKCJNZXNzYWdlSUQ6ICVkLCBCb2R5OiVzIiwgcmVzUmVjLmdldE1lc3NhZ2UoKS5nZXRNZXNzYWdlSUQoKSwNCiAgICAgICAgICBDb252ZXJ0ZXIuRnJvbUJ5dGVBcnJheShyZXNSZWMuZ2V0TWVzc2FnZSgpLmdldEJvZHkoKSkpOw0KDQogIFN5c3RlbS5vdXQucHJpbnRsbigiUmVzZW5kIHRvIG5ldyBxdWV1ZSIpOw0KICBUcmFuc2FjdGlvbk1lc3NhZ2VzUmVzcG9uc2UgcmVzUmVzZW5kID0gdHJhbi5SZVNlbmQoIm5ldy1xdWV1ZSIpOw0KICBpZiAocmVzUmVzZW5kLmdldElzRXJyb3IoKSkgew0KICAgICAgU3lzdGVtLm91dC5wcmludGYoIk1lc3NhZ2UgZGVxdWV1ZSBlcnJvciwgZXJyb3I6ICVzIiwgcmVzUmVzZW5kLmdldEVycm9yKCkpOw0KICAgICAgcmV0dXJuOw0KICB9DQogIFN5c3RlbS5vdXQucHJpbnRsbigiRG9uZSIpOw0KYGBgDQoNCiMjIEV2ZW50DQoNCiMjIyBTZW5kaW5nIEV2ZW50cw0KDQojIyMjIFNpbmdsZSBldmVudA0KYGBgamF2YQ0KICBTdHJpbmcgQ2hhbm5lbE5hbWUgPSAidGVzdGluZ19ldmVudF9jaGFubmVsIiwgQ2xpZW50SUQgPSAiaGVsbG8td29ybGQtc2VuZGVyIiwNCiAgICAgICAgICBLdWJlTVFTZXJ2ZXJBZGRyZXNzID0gImxvY2FsaG9zdDo1MDAwMCI7DQoNCiAgaW8ua3ViZW1xLnNkay5ldmVudC5DaGFubmVsIGNoYW5uZWwgPSBuZXcgaW8ua3ViZW1xLnNkay5ldmVudC5DaGFubmVsKENoYW5uZWxOYW1lLCBDbGllbnRJRCwgZmFsc2UsDQogICAgICAgICAgS3ViZU1RU2VydmVyQWRkcmVzcyk7DQogIEV2ZW50IGV2ZW50ID0gbmV3IEV2ZW50KCk7DQogIGV2ZW50LnNldEJvZHkoQ29udmVydGVyLlRvQnl0ZUFycmF5KCJoZWxsbyBrdWJlbXEgLSBzZW5kaW5nIHNpbmdsZSBldmVudCIpKTsNCiAgUmVzdWx0IHJlc3VsdDsNCiAgdHJ5IHsNCiAgICAgIHJlc3VsdCA9IGNoYW5uZWwuU2VuZEV2ZW50KGV2ZW50KTsNCiAgICAgIGlmICghcmVzdWx0LmlzU2VudCgpKSB7DQogICAgICAgICAgU3lzdGVtLm91dC5wcmludGxuKCJDb3VsZCBub3Qgc2VuZCBzaW5nbGUgbWVzc2FnZSIpOw0KICAgICAgICAgIHJldHVybjsNCiAgICAgIH0NCiAgfSBjYXRjaCAoU2VydmVyQWRkcmVzc05vdFN1cHBsaWVkRXhjZXB0aW9uIGUpIHsNCiAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJDb3VsZCBub3Qgc2VuZCBzaW5nbGUgbWVzc2FnZTogJXMiLCBlLmdldE1lc3NhZ2UoKSk7DQogICAgICBlLnByaW50U3RhY2tUcmFjZSgpOw0KICB9DQoNCmBgYA0KDQojIyMjIFN0cmVhbSBFdmVudHMNCmBgYGphdmENCiAgU3RyaW5nIENoYW5uZWxOYW1lID0gInRlc3RpbmdfZXZlbnRfY2hhbm5lbCIsIENsaWVudElEID0gImhlbGxvLXdvcmxkLXNlbmRlciIsDQogICAgICAgICAgS3ViZU1RU2VydmVyQWRkcmVzcyA9ICJsb2NhbGhvc3Q6NTAwMDAiOw0KDQogIGlvLmt1YmVtcS5zZGsuZXZlbnQuQ2hhbm5lbCBjaGFubmVsID0gbmV3IGlvLmt1YmVtcS5zZGsuZXZlbnQuQ2hhbm5lbChDaGFubmVsTmFtZSwgQ2xpZW50SUQsIGZhbHNlLA0KICAgICAgICAgIEt1YmVNUVNlcnZlckFkZHJlc3MpOw0KICBFdmVudCBldmVudCA9IG5ldyBFdmVudCgpOw0KICBldmVudC5zZXRCb2R5KENvbnZlcnRlci5Ub0J5dGVBcnJheSgiaGVsbG8ga3ViZW1xIC0gc2VuZGluZyBzaW5nbGUgZXZlbnQiKSk7DQoNCiAgU3RyZWFtT2JzZXJ2ZXI8UmVzdWx0PiBzdHJlYW1SZXNPYnNlcnZlciA9IG5ldyBTdHJlYW1PYnNlcnZlcjxSZXN1bHQ+KCkgew0KDQogICAgICBAT3ZlcnJpZGUNCiAgICAgIHB1YmxpYyB2b2lkIG9uTmV4dChSZXN1bHQgdmFsdWUpIHsNCiAgICAgICAgICBTeXN0ZW0ub3V0LnByaW50ZigiU2VudCBldmVudDogJXMiLCB2YWx1ZS5nZXRFdmVudElkKCkpOw0KICAgICAgfQ0KDQogICAgICBAT3ZlcnJpZGUNCiAgICAgIHB1YmxpYyB2b2lkIG9uRXJyb3IoVGhyb3dhYmxlIHQpIHsNCiAgICAgICAgICBTeXN0ZW0ub3V0LnByaW50ZigiQ291bGQgbm90IHNlbmQgc2luZ2xlIG1lc3NhZ2UiKTsNCiAgICAgIH0NCg0KICAgICAgQE92ZXJyaWRlDQogICAgICBwdWJsaWMgdm9pZCBvbkNvbXBsZXRlZCgpIHsNCg0KICAgICAgfQ0KICB9Ow0KDQogIFN0cmVhbU9ic2VydmVyPEV2ZW50PiBzdHJlYW0gPSBjaGFubmVsLlN0cmVhbUV2ZW50KHN0cmVhbVJlc09ic2VydmVyKTsNCiAgc3RyZWFtLm9uTmV4dChldmVudCk7DQpgYGANCg0KIyMjIFJlY2VpdmluZyBFdmVudHMNCg0KYGBgamF2YQ0KICBTdHJpbmcgQ2hhbm5lbE5hbWUgPSAidGVzdGluZ19ldmVudF9jaGFubmVsIiwgQ2xpZW50SUQgPSAiaGVsbG8td29ybGQtc3Vic2NyaWJlciIsDQogICAgICAgICAgS3ViZU1RU2VydmVyQWRkcmVzcyA9ICJsb2NhbGhvc3Q6NTAwMDAiOw0KICBTdWJzY3JpYmVyIHN1YnNjcmliZXIgPSBuZXcgU3Vic2NyaWJlcihLdWJlTVFTZXJ2ZXJBZGRyZXNzKTsNCiAgU3Vic2NyaWJlUmVxdWVzdCBzdWJzY3JpYmVSZXF1ZXN0ID0gbmV3IFN1YnNjcmliZVJlcXVlc3QoKTsNCiAgc3Vic2NyaWJlUmVxdWVzdC5zZXRDaGFubmVsKENoYW5uZWxOYW1lKTsNCiAgc3Vic2NyaWJlUmVxdWVzdC5zZXRDbGllbnRJRChDbGllbnRJRCk7DQogIHN1YnNjcmliZVJlcXVlc3Quc2V0U3Vic2NyaWJlVHlwZShTdWJzY3JpYmVUeXBlLkV2ZW50cyk7DQoNCiAgU3RyZWFtT2JzZXJ2ZXI8RXZlbnRSZWNlaXZlPiBzdHJlYW1PYnNlcnZlciA9IG5ldyBTdHJlYW1PYnNlcnZlcjxFdmVudFJlY2VpdmU+KCkgew0KDQogICAgICBAT3ZlcnJpZGUNCiAgICAgIHB1YmxpYyB2b2lkIG9uTmV4dChFdmVudFJlY2VpdmUgdmFsdWUpIHsNCiAgICAgICAgICB0cnkgew0KICAgICAgICAgICAgICBTeXN0ZW0ub3V0LnByaW50ZigiRXZlbnQgUmVjZWl2ZWQ6IEV2ZW50SUQ6ICVkLCBDaGFubmVsOiAlcywgTWV0YWRhdGE6ICVzLCBCb2R5OiAlcyIsDQogICAgICAgICAgICAgICAgICAgICAgdmFsdWUuZ2V0RXZlbnRJZCgpLCB2YWx1ZS5nZXRDaGFubmVsKCksIHZhbHVlLmdldE1ldGFkYXRhKCksDQogICAgICAgICAgICAgICAgICAgICAgQ29udmVydGVyLkZyb21CeXRlQXJyYXkodmFsdWUuZ2V0Qm9keSgpKSk7DQogICAgICAgICAgfSBjYXRjaCAoQ2xhc3NOb3RGb3VuZEV4Y2VwdGlvbiBlKSB7DQogICAgICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJDbGFzc05vdEZvdW5kRXhjZXB0aW9uOiAlcyIsIGUuZ2V0TWVzc2FnZSgpKTsNCiAgICAgICAgICAgICAgZS5wcmludFN0YWNrVHJhY2UoKTsNCiAgICAgICAgICB9IGNhdGNoIChJT0V4Y2VwdGlvbiBlKSB7DQogICAgICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJJT0V4Y2VwdGlvbjogICVzIiwgZS5nZXRNZXNzYWdlKCkpOw0KICAgICAgICAgICAgICBlLnByaW50U3RhY2tUcmFjZSgpOw0KICAgICAgICAgIH0NCg0KICAgICAgfQ0KDQogICAgICBAT3ZlcnJpZGUNCiAgICAgIHB1YmxpYyB2b2lkIG9uRXJyb3IoVGhyb3dhYmxlIHQpIHsNCiAgICAgICAgICBTeXN0ZW0ub3V0LnByaW50ZigiRXZlbnQgUmVjZWl2ZWQgRXJyb3I6ICVzIiwgdC50b1N0cmluZygpKTsNCiAgICAgIH0NCg0KICAgICAgQE92ZXJyaWRlDQogICAgICBwdWJsaWMgdm9pZCBvbkNvbXBsZXRlZCgpIHsNCg0KICAgICAgfQ0KICB9Ow0KICBzdWJzY3JpYmVyLlN1YnNjcmliZVRvRXZlbnRzKHN1YnNjcmliZVJlcXVlc3QsIHN0cmVhbU9ic2VydmVyKTsNCg0KYGBgDQoNCiMjIEV2ZW50IFN0b3JlDQoNCiMjIyBTdWJzY3JpcHRpb24gT3B0aW9ucw0KDQpLdWJlTVEgc3VwcG9ydHMgNiB0eXBlcyBvZiBzdWJzY3JpcHRpb25zOg0KDQotIFN0YXJ0RnJvbU5ld0V2ZW50cyAtIHN0YXJ0IGV2ZW50IHN0b3JlIHN1YnNjcmlwdGlvbiB3aXRoIG9ubHkgbmV3IGV2ZW50cw0KDQotIFN0YXJ0RnJvbUZpcnN0RXZlbnQgLSByZXBsYXkgYWxsIHRoZSBzdG9yZWQgZXZlbnRzIGZyb20gdGhlIGZpcnN0IGF2YWlsYWJsZSBzZXF1ZW5jZSBhbmQgY29udGludWUgc3RyZWFtIG5ldyBldmVudHMgZnJvbSB0aGlzIHBvaW50DQoNCi0gU3RhcnRGcm9tTGFzdEV2ZW50IC0gcmVwbGF5IHRoZSBsYXN0IGV2ZW50IGFuZCBjb250aW51ZSBzdHJlYW0gbmV3IGV2ZW50cyBmcm9tIHRoaXMgcG9pbnQNCg0KLSBTdGFydEZyb21TZXF1ZW5jZSAtIHJlcGxheSBldmVudHMgZnJvbSBzcGVjaWZpYyBldmVudCBzZXF1ZW5jZSBudW1iZXIgYW5kIGNvbnRpbnVlIHN0cmVhbSBuZXcgZXZlbnRzIGZyb20gdGhpcyBwb2ludA0KDQotIFN0YXJ0RnJvbVRpbWUgLSByZXBsYXkgZXZlbnRzIGZyb20gc3BlY2lmaWMgdGltZSBjb250aW51ZSBzdHJlYW0gbmV3IGV2ZW50cyBmcm9tIHRoaXMgcG9pbnQNCg0KLSBTdGFydEZyb21UaW1lRGVsdGEgLSByZXBsYXkgZXZlbnRzIGZyb20gc3BlY2lmaWMgY3VycmVudCB0aW1lIC0gZGVsdGEgZHVyYXRpb24gaW4gc2Vjb25kcywgY29udGludWUgc3RyZWFtIG5ldyBldmVudHMgZnJvbSB0aGlzIHBvaW50DQojIyMgU2VuZGluZyBFdmVudCBTdG9yZQ0KDQojIyMjIFNpbmdsZSBFdmVudCBTdG9yZQ0KDQpgYGBqYXZhDQogIFN0cmluZyBDaGFubmVsTmFtZSA9ICJ0ZXN0aW5nX2V2ZW50X2NoYW5uZWwiLCBDbGllbnRJRCA9ICJoZWxsby13b3JsZC1zZW5kZXIiLA0KICAgICAgICAgIEt1YmVNUVNlcnZlckFkZHJlc3MgPSAibG9jYWxob3N0OjUwMDAwIjsNCg0KICBpby5rdWJlbXEuc2RrLmV2ZW50LkNoYW5uZWwgY2hhbm5lbCA9IG5ldyBpby5rdWJlbXEuc2RrLmV2ZW50LkNoYW5uZWwoQ2hhbm5lbE5hbWUsIENsaWVudElELCBmYWxzZSwNCiAgICAgICAgICBLdWJlTVFTZXJ2ZXJBZGRyZXNzKTsNCiAgZm9yIChpbnQgaSA9IDA7IGkgPCAxMDsgaSsrKSB7DQogICAgICBFdmVudCBldmVudCA9IG5ldyBFdmVudCgpOw0KICAgICAgZXZlbnQuc2V0Qm9keShDb252ZXJ0ZXIuVG9CeXRlQXJyYXkoImhlbGxvIGt1YmVtcSAtIHNlbmRpbmcgc2luZ2xlIGV2ZW50IikpOw0KICAgICAgZXZlbnQuc2V0RXZlbnRJZCgiZXZlbnQtU3RvcmUtIiArIGkpOw0KICAgICAgdHJ5IHsNCiAgICAgICAgICBjaGFubmVsLlNlbmRFdmVudChldmVudCk7DQogICAgICB9IGNhdGNoIChTU0xFeGNlcHRpb24gZSkgew0KICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJTU0xFeGNlcHRpb246ICVzIiwgZS5nZXRNZXNzYWdlKCkpOw0KICAgICAgICAgIGUucHJpbnRTdGFja1RyYWNlKCk7DQogICAgICB9IGNhdGNoIChTZXJ2ZXJBZGRyZXNzTm90U3VwcGxpZWRFeGNlcHRpb24gZSkgew0KICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJTZXJ2ZXJBZGRyZXNzTm90U3VwcGxpZWRFeGNlcHRpb246ICVzIiwgZS5nZXRNZXNzYWdlKCkpOw0KICAgICAgICAgIGUucHJpbnRTdGFja1RyYWNlKCk7DQogICAgICB9DQogIH0NCmBgYA0KDQojIyMjIFN0cmVhbSBFdmVudHMgU3RvcmUNCg0KYGBgamF2YQ0KICBTdHJpbmcgQ2hhbm5lbE5hbWUgPSAidGVzdGluZ19ldmVudF9jaGFubmVsIiwgQ2xpZW50SUQgPSAiaGVsbG8td29ybGQtc2VuZGVyIiwNCiAgICAgICAgICBLdWJlTVFTZXJ2ZXJBZGRyZXNzID0gImxvY2FsaG9zdDo1MDAwMCI7DQoNCiAgaW8ua3ViZW1xLnNkay5ldmVudC5DaGFubmVsIGNoYW5uZWwgPSBuZXcgaW8ua3ViZW1xLnNkay5ldmVudC5DaGFubmVsKENoYW5uZWxOYW1lLCBDbGllbnRJRCwgZmFsc2UsDQogICAgICAgICAgS3ViZU1RU2VydmVyQWRkcmVzcyk7DQoNCiAgU3RyZWFtT2JzZXJ2ZXI8UmVzdWx0PiBzdHJlYW1SZXNPYnNlcnZlciA9IG5ldyBTdHJlYW1PYnNlcnZlcjxSZXN1bHQ+KCkgew0KDQogICAgICBAT3ZlcnJpZGUNCiAgICAgIHB1YmxpYyB2b2lkIG9uTmV4dChSZXN1bHQgdmFsdWUpIHsNCiAgICAgICAgICBTeXN0ZW0ub3V0LnByaW50ZigiU3RyZWFtIGV2ZW50OiAlcyIsIHZhbHVlLmdldEV2ZW50SWQoKSk7DQogICAgICB9DQoNCiAgICAgIEBPdmVycmlkZQ0KICAgICAgcHVibGljIHZvaWQgb25FcnJvcihUaHJvd2FibGUgdCkgew0KICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJDb3VsZCBub3Qgc2VuZCBzaW5nbGUgbWVzc2FnZSIpOw0KICAgICAgfQ0KDQogICAgICBAT3ZlcnJpZGUNCiAgICAgIHB1YmxpYyB2b2lkIG9uQ29tcGxldGVkKCkgew0KDQogICAgICB9DQogIH07DQoNCiAgU3RyZWFtT2JzZXJ2ZXI8RXZlbnQ+IHN0cmVhbSA9IGNoYW5uZWwuU3RyZWFtRXZlbnQoc3RyZWFtUmVzT2JzZXJ2ZXIpOw0KICBmb3IgKGludCBpID0gMDsgaSA8IDEwOyBpKyspIHsNCiAgICAgIEV2ZW50IGV2ZW50ID0gbmV3IEV2ZW50KCk7DQogICAgICBldmVudC5zZXRCb2R5KENvbnZlcnRlci5Ub0J5dGVBcnJheSgiaGVsbG8ga3ViZW1xIC0gc2VuZGluZyBzaW5nbGUgZXZlbnQiKSk7DQogICAgICBldmVudC5zZXRFdmVudElkKCJldmVudC1TdG9yZS0iICsgaSk7DQogICAgICBzdHJlYW0ub25OZXh0KGV2ZW50KTsNCiAgfQ0KYGBgDQoNCiMjIyBSZWNlaXZpbmcgRXZlbnRzIFN0b3JlDQoNCmBgYGphdmENCiAgU3RyaW5nIENoYW5uZWxOYW1lID0gInRlc3RpbmdfZXZlbnRfY2hhbm5lbCIsIENsaWVudElEID0gImhlbGxvLXdvcmxkLXN1YnNjcmliZXIiLA0KICAgICAgICAgIEt1YmVNUVNlcnZlckFkZHJlc3MgPSAibG9jYWxob3N0OjUwMDAwIjsNCiAgU3Vic2NyaWJlciBzdWJzY3JpYmVyID0gbmV3IFN1YnNjcmliZXIoS3ViZU1RU2VydmVyQWRkcmVzcyk7DQogIFN1YnNjcmliZVJlcXVlc3Qgc3Vic2NyaWJlUmVxdWVzdCA9IG5ldyBTdWJzY3JpYmVSZXF1ZXN0KCk7DQogIHN1YnNjcmliZVJlcXVlc3Quc2V0Q2hhbm5lbChDaGFubmVsTmFtZSk7DQogIHN1YnNjcmliZVJlcXVlc3Quc2V0Q2xpZW50SUQoQ2xpZW50SUQpOw0KICBzdWJzY3JpYmVSZXF1ZXN0LnNldFN1YnNjcmliZVR5cGUoU3Vic2NyaWJlVHlwZS5FdmVudHNTdG9yZSk7DQogIHN1YnNjcmliZVJlcXVlc3Quc2V0RXZlbnRzU3RvcmVUeXBlKEV2ZW50c1N0b3JlVHlwZS5TdGFydEF0U2VxdWVuY2UpOw0KDQogIFN0cmVhbU9ic2VydmVyPEV2ZW50UmVjZWl2ZT4gc3RyZWFtT2JzZXJ2ZXIgPSBuZXcgU3RyZWFtT2JzZXJ2ZXI8RXZlbnRSZWNlaXZlPigpIHsNCg0KICAgICAgQE92ZXJyaWRlDQogICAgICBwdWJsaWMgdm9pZCBvbk5leHQoRXZlbnRSZWNlaXZlIHZhbHVlKSB7DQogICAgICAgICAgdHJ5IHsNCiAgICAgICAgICAgICAgU3lzdGVtLm91dC5wcmludGYoIkV2ZW50IFJlY2VpdmVkOiBFdmVudElEOiAlcywgQ2hhbm5lbDogJXMsIE1ldGFkYXRhOiAlcywgQm9keTogJXMiLA0KICAgICAgICAgICAgICAgICAgICAgIHZhbHVlLmdldEV2ZW50SWQoKSwgdmFsdWUuZ2V0Q2hhbm5lbCgpLCB2YWx1ZS5nZXRNZXRhZGF0YSgpLA0KICAgICAgICAgICAgICAgICAgICAgIENvbnZlcnRlci5Gcm9tQnl0ZUFycmF5KHZhbHVlLmdldEJvZHkoKSkpOw0KICAgICAgICAgIH0gY2F0Y2ggKENsYXNzTm90Rm91bmRFeGNlcHRpb24gZSkgew0KICAgICAgICAgICAgICBTeXN0ZW0ub3V0LnByaW50ZigiQ2xhc3NOb3RGb3VuZEV4Y2VwdGlvbjogJXMiLCBlLmdldE1lc3NhZ2UoKSk7DQogICAgICAgICAgICAgIGUucHJpbnRTdGFja1RyYWNlKCk7DQogICAgICAgICAgfSBjYXRjaCAoSU9FeGNlcHRpb24gZSkgew0KICAgICAgICAgICAgICBTeXN0ZW0ub3V0LnByaW50ZigiSU9FeGNlcHRpb246ICVzIiwgZS5nZXRNZXNzYWdlKCkpOw0KICAgICAgICAgICAgICBlLnByaW50U3RhY2tUcmFjZSgpOw0KICAgICAgICAgIH0NCiAgICAgIH0NCg0KICAgICAgQE92ZXJyaWRlDQogICAgICBwdWJsaWMgdm9pZCBvbkVycm9yKFRocm93YWJsZSB0KSB7DQogICAgICAgICAgU3lzdGVtLm91dC5wcmludGYoIm9uRXJyb3I6ICAlcyIsIHQuZ2V0TWVzc2FnZSgpKTsNCiAgICAgIH0NCg0KICAgICAgQE92ZXJyaWRlDQogICAgICBwdWJsaWMgdm9pZCBvbkNvbXBsZXRlZCgpIHsNCg0KICAgICAgfQ0KDQogIH07DQogIHN1YnNjcmliZXIuU3Vic2NyaWJlVG9FdmVudHMoc3Vic2NyaWJlUmVxdWVzdCwgc3RyZWFtT2JzZXJ2ZXIpOw0KYGBgDQoNCiMjIENvbW1hbmRzDQoNCiMjIyBDb25jZXB0DQoNCkNvbW1hbmRzIGltcGxlbWVudCBzeW5jaHJvbm91cyBtZXNzYWdpbmcgcGF0dGVybiB3aGljaCB0aGUgc2VuZGVyIHNlbmQgYSByZXF1ZXN0IGFuZCB3YWl0IGZvciBhIHNwZWNpZmljIGFtb3VudCBvZiB0aW1lIHRvIGdldCBhIHJlc3BvbnNlLiAgDQpUaGUgcmVzcG9uc2UgY2FuIGJlIHN1Y2Nlc3NmdWwgb3Igbm90LiBUaGlzIGlzIHRoZSByZXNwb25zaWJpbGl0eSBvZiB0aGUgcmVzcG9uZGVyIHRvIHJldHVybiB3aXRoIHRoZSByZXN1bHQgb2YgdGhlIGNvbW1hbmQgd2l0aGluIHRoZSB0aW1lIHRoZSBzZW5kZXIgc2V0IGluIHRoZSByZXF1ZXN0DQoNCiMjIyMgUmVjZWl2aW5nIENvbW1hbmRzIFJlcXVlc3RzDQpgYGBqYXZhDQogIFN0cmluZyBDaGFubmVsTmFtZSA9ICJ0ZXN0aW5nX0NvbW1hbmRfY2hhbm5lbCIsIENsaWVudElEID0gImhlbGxvLXdvcmxkLXNlbmRlciIsDQogICAgICAgICAgS3ViZU1RU2VydmVyQWRkcmVzcyA9ICJsb2NhbGhvc3Q6NTAwMDAiOw0KICBSZXNwb25kZXIuUmVxdWVzdFJlc3BvbnNlT2JzZXJ2ZXIgSGFuZGxlSW5jb21pbmdSZXF1ZXN0czsNCiAgUmVzcG9uZGVyIHJlc3BvbmRlciA9IG5ldyBSZXNwb25kZXIoS3ViZU1RU2VydmVyQWRkcmVzcyk7DQogIEhhbmRsZUluY29taW5nUmVxdWVzdHMgPSByZXF1ZXN0IC0+IHsNCg0KICAgICAgUmVzcG9uc2UgcmVzcG9uc2UgPSBuZXcgUmVzcG9uc2UocmVxdWVzdCk7DQogICAgICByZXNwb25zZS5zZXRDYWNoZUhpdChmYWxzZSk7DQogICAgICByZXNwb25zZS5zZXRFcnJvcigiTm9uZSIpOw0KICAgICAgcmVzcG9uc2Uuc2V0Q2xpZW50SUQoQ2xpZW50SUQpOw0KICAgICAgcmVzcG9uc2Uuc2V0Qm9keSgiT0siLmdldEJ5dGVzKCkpOw0KICAgICAgcmVzcG9uc2Uuc2V0RXhlY3V0ZWQodHJ1ZSk7DQogICAgICByZXNwb25zZS5zZXRNZXRhZGF0YSgiT0siKTsNCiAgICAgIHJlc3BvbnNlLnNldFRpbWVzdGFtcChMb2NhbERhdGVUaW1lLm5vdygpKTsNCiAgICAgIHJldHVybiByZXNwb25zZTsNCiAgfTsNCiAgU3Vic2NyaWJlUmVxdWVzdCBzdWJzY3JpYmVSZXF1ZXN0ID0gbmV3IFN1YnNjcmliZVJlcXVlc3QoKTsNCiAgc3Vic2NyaWJlUmVxdWVzdC5zZXRDaGFubmVsKENoYW5uZWxOYW1lKTsNCiAgc3Vic2NyaWJlUmVxdWVzdC5zZXRDbGllbnRJRChDbGllbnRJRCk7DQogIHN1YnNjcmliZVJlcXVlc3Quc2V0U3Vic2NyaWJlVHlwZShTdWJzY3JpYmVUeXBlLkNvbW1hbmRzKTsNCg0KICBuZXcgVGhyZWFkKCkgew0KICAgICAgcHVibGljIHZvaWQgcnVuKCkgew0KICAgICAgICAgIHRyeSB7DQogICAgICAgICAgICAgIHJlc3BvbmRlci5TdWJzY3JpYmVUb1JlcXVlc3RzKHN1YnNjcmliZVJlcXVlc3QsIEhhbmRsZUluY29taW5nUmVxdWVzdHMpOw0KICAgICAgICAgIH0gY2F0Y2ggKFNTTEV4Y2VwdGlvbiBlKSB7DQogICAgICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJTU0xFeGNlcHRpb246JXMiLCBlLmdldE1lc3NhZ2UoKSk7DQogICAgICAgICAgICAgIGUucHJpbnRTdGFja1RyYWNlKCk7DQogICAgICAgICAgfSBjYXRjaCAoU2VydmVyQWRkcmVzc05vdFN1cHBsaWVkRXhjZXB0aW9uIGUpIHsNCiAgICAgICAgICAgICAgU3lzdGVtLm91dC5wcmludGYoIlNlcnZlckFkZHJlc3NOb3RTdXBwbGllZEV4Y2VwdGlvbjolcyIsIGUuZ2V0TWVzc2FnZSgpKTsNCiAgICAgICAgICAgICAgZS5wcmludFN0YWNrVHJhY2UoKTsNCiAgICAgICAgICB9DQogICAgICB9DQogIH0uc3RhcnQoKTsNCmBgYA0KDQojIyMgU2VuZGluZyBDb21tYW5kIFJlcXVlc3QNCg0KYGBgamF2YQ0KICBTdHJpbmcgQ2hhbm5lbE5hbWUgPSAidGVzdGluZ19Db21tYW5kX2NoYW5uZWwiLCBDbGllbnRJRCA9ICJoZWxsby13b3JsZC1zZW5kZXIiLA0KICAgICAgICAgIEt1YmVNUVNlcnZlckFkZHJlc3MgPSAibG9jYWxob3N0OjUwMDAwIjsNCiAgaW8ua3ViZW1xLnNkay5jb21tYW5kcXVlcnkuQ2hhbm5lbFBhcmFtZXRlcnMgY2hhbm5lbFBhcmFtZXRlcnMgPSBuZXcgaW8ua3ViZW1xLnNkay5jb21tYW5kcXVlcnkuQ2hhbm5lbFBhcmFtZXRlcnMoKTsNCiAgY2hhbm5lbFBhcmFtZXRlcnMuc2V0Q2hhbm5lbE5hbWUoQ2hhbm5lbE5hbWUpOw0KICBjaGFubmVsUGFyYW1ldGVycy5zZXRDbGllbnRJRChDbGllbnRJRCk7DQogIGNoYW5uZWxQYXJhbWV0ZXJzLnNldEt1YmVNUUFkZHJlc3MoS3ViZU1RU2VydmVyQWRkcmVzcyk7DQogIGNoYW5uZWxQYXJhbWV0ZXJzLnNldFJlcXVlc3RUeXBlKFJlcXVlc3RUeXBlLkNvbW1hbmQpOw0KICBjaGFubmVsUGFyYW1ldGVycy5zZXRUaW1lb3V0KDEwMDAwKTsNCiAgaW8ua3ViZW1xLnNkay5jb21tYW5kcXVlcnkuQ2hhbm5lbCBjaGFubmVsID0gbmV3IGlvLmt1YmVtcS5zZGsuY29tbWFuZHF1ZXJ5LkNoYW5uZWwoY2hhbm5lbFBhcmFtZXRlcnMpOw0KICBSZXF1ZXN0IHJlcXVlc3QgPSBuZXcgUmVxdWVzdCgpOw0KICByZXF1ZXN0LnNldEJvZHkoQ29udmVydGVyLlRvQnl0ZUFycmF5KCJoZWxsbyBrdWJlbXEgLSBzZW5kaW5nIGEgY29tbWFuZCwgcGxlYXNlIHJlcGx5IikpOw0KICBSZXNwb25zZSByZXN1bHQgPSBjaGFubmVsLlNlbmRSZXF1ZXN0KHJlcXVlc3QpOw0KICBpZiAoIXJlc3VsdC5pc0V4ZWN1dGVkKCkpIHsNCiAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJSZXNwb25zZSBlcnJvcjogJXMiLCByZXN1bHQuZ2V0RXJyb3IoKSk7DQogICAgICByZXR1cm47DQogIH0NCiAgU3lzdGVtLm91dC5wcmludGYoIlJlc3BvbnNlIFJlY2VpdmVkOiAlcywgRXhlY3V0ZWRBdDogJWQiLCByZXN1bHQuZ2V0UmVxdWVzdElEKCksIHJlc3VsdC5nZXRUaW1lc3RhbXAoKSk7DQpgYGANCg0KIyMjIFNlbmRpbmcgQ29tbWFuZCBSZXF1ZXN0IEFzeW5jDQoNCmBgYGphdmENCiAgU3RyaW5nIENoYW5uZWxOYW1lID0gInRlc3RpbmdfQ29tbWFuZF9jaGFubmVsIiwgQ2xpZW50SUQgPSAiaGVsbG8td29ybGQtc2VuZGVyIiwNCiAgICAgICAgICBLdWJlTVFTZXJ2ZXJBZGRyZXNzID0gImxvY2FsaG9zdDo1MDAwMCI7DQogIGlvLmt1YmVtcS5zZGsuY29tbWFuZHF1ZXJ5LkNoYW5uZWxQYXJhbWV0ZXJzIGNoYW5uZWxQYXJhbWV0ZXJzID0gbmV3IGlvLmt1YmVtcS5zZGsuY29tbWFuZHF1ZXJ5LkNoYW5uZWxQYXJhbWV0ZXJzKCk7DQogIGNoYW5uZWxQYXJhbWV0ZXJzLnNldENoYW5uZWxOYW1lKENoYW5uZWxOYW1lKTsNCiAgY2hhbm5lbFBhcmFtZXRlcnMuc2V0Q2xpZW50SUQoQ2xpZW50SUQpOw0KICBjaGFubmVsUGFyYW1ldGVycy5zZXRLdWJlTVFBZGRyZXNzKEt1YmVNUVNlcnZlckFkZHJlc3MpOw0KICBjaGFubmVsUGFyYW1ldGVycy5zZXRSZXF1ZXN0VHlwZShSZXF1ZXN0VHlwZS5Db21tYW5kKTsNCiAgY2hhbm5lbFBhcmFtZXRlcnMuc2V0VGltZW91dCgxMDAwKTsNCiAgaW8ua3ViZW1xLnNkay5jb21tYW5kcXVlcnkuQ2hhbm5lbCBjaGFubmVsID0gbmV3IGlvLmt1YmVtcS5zZGsuY29tbWFuZHF1ZXJ5LkNoYW5uZWwoY2hhbm5lbFBhcmFtZXRlcnMpOw0KICBSZXF1ZXN0IHJlcXVlc3QgPSBuZXcgUmVxdWVzdCgpOw0KICByZXF1ZXN0LnNldEJvZHkoQ29udmVydGVyLlRvQnl0ZUFycmF5KCJoZWxsbyBrdWJlbXEgLSBzZW5kaW5nIGEgY29tbWFuZCwgcGxlYXNlIHJlcGx5IikpOw0KICBTdHJlYW1PYnNlcnZlcjxSZXNwb25zZT4gcmVzcG9uc2UgPSBuZXcgU3RyZWFtT2JzZXJ2ZXI8UmVzcG9uc2U+KCkgew0KDQogICAgICBAT3ZlcnJpZGUNCiAgICAgIHB1YmxpYyB2b2lkIG9uTmV4dChSZXNwb25zZSB2YWx1ZSkgew0KICAgICAgICAgIGlmICghdmFsdWUuaXNFeGVjdXRlZCgpKSB7DQogICAgICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJSZXNwb25zZSBlcnJvcjogJXMiLCB2YWx1ZS5nZXRFcnJvcigpKTsNCiAgICAgICAgICB9DQogICAgICB9DQoNCiAgICAgIEBPdmVycmlkZQ0KICAgICAgcHVibGljIHZvaWQgb25FcnJvcihUaHJvd2FibGUgdCkgew0KICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJSUEMgRXJyb3I6ICVzIiwgdC5nZXRNZXNzYWdlKCkpOw0KICAgICAgfQ0KDQogICAgICBAT3ZlcnJpZGUNCiAgICAgIHB1YmxpYyB2b2lkIG9uQ29tcGxldGVkKCkgew0KDQogICAgICB9DQogIH07DQogIGNoYW5uZWwuU2VuZFJlcXVlc3RBc3luYyhyZXF1ZXN0LCByZXNwb25zZSk7DQpgYGANCg0KIyMgUXVlcmllcw0KDQojIyMgQ29uY2VwdA0KDQpRdWVyaWVzIGltcGxlbWVudCBzeW5jaHJvbm91cyBtZXNzYWdpbmcgcGF0dGVybiB3aGljaCB0aGUgc2VuZGVyIHNlbmQgYSByZXF1ZXN0IGFuZCB3YWl0IGZvciBhIHNwZWNpZmljIGFtb3VudCBvZiB0aW1lIHRvIGdldCBhIHJlc3BvbnNlLg0KDQpUaGUgcmVzcG9uc2UgbXVzdCBpbmNsdWRlIG1ldGFkYXRhIG9yIGJvZHkgdG9nZXRoZXIgd2l0aCBhbiBpbmRpY2F0aW9uIG9mIHN1Y2Nlc3NmdWwgb3Igbm90IG9wZXJhdGlvbi4gVGhpcyBpcyB0aGUgcmVzcG9uc2liaWxpdHkgb2YgdGhlIHJlc3BvbmRlciB0byByZXR1cm4gd2l0aCB0aGUgcmVzdWx0IG9mIHRoZSBxdWVyeSB3aXRoaW4gdGhlIHRpbWUgdGhlIHNlbmRlciBzZXQgaW4gdGhlIHJlcXVlc3QuDQoNCiMjIyBSZWNlaXZpbmcgUXVlcnkgUmVxdWVzdHMNCg0KYGBgamF2YQ0KICBTdHJpbmcgQ2hhbm5lbE5hbWUgPSAidGVzdGluZ19Db21tYW5kX2NoYW5uZWwiLCBDbGllbnRJRCA9ICJoZWxsby13b3JsZC1zZW5kZXIiLA0KICAgICAgICAgIEt1YmVNUVNlcnZlckFkZHJlc3MgPSAibG9jYWxob3N0OjUwMDAwIjsNCiAgUmVzcG9uZGVyLlJlcXVlc3RSZXNwb25zZU9ic2VydmVyIEhhbmRsZUluY29taW5nUmVxdWVzdHM7DQogIFJlc3BvbmRlciByZXNwb25kZXIgPSBuZXcgUmVzcG9uZGVyKEt1YmVNUVNlcnZlckFkZHJlc3MpOw0KICBIYW5kbGVJbmNvbWluZ1JlcXVlc3RzID0gcmVxdWVzdCAtPiB7DQoNCiAgICAgIFJlc3BvbnNlIHJlc3BvbnNlID0gbmV3IFJlc3BvbnNlKHJlcXVlc3QpOw0KICAgICAgcmVzcG9uc2Uuc2V0Q2FjaGVIaXQoZmFsc2UpOw0KICAgICAgcmVzcG9uc2Uuc2V0RXJyb3IoIk5vbmUiKTsNCiAgICAgIHJlc3BvbnNlLnNldENsaWVudElEKENsaWVudElEKTsNCiAgICAgIHJlc3BvbnNlLnNldEJvZHkoImdvdCB5b3VyIHF1ZXJ5LCB5b3UgYXJlIGdvb2QgdG8gZ29vIi5nZXRCeXRlcygpKTsNCiAgICAgIHJlc3BvbnNlLnNldEV4ZWN1dGVkKHRydWUpOw0KICAgICAgcmVzcG9uc2Uuc2V0TWV0YWRhdGEoInRoaXMgaXMgYSByZXNwb25zZSIpOw0KICAgICAgcmVzcG9uc2Uuc2V0VGltZXN0YW1wKExvY2FsRGF0ZVRpbWUubm93KCkpOw0KICAgICAgcmV0dXJuIHJlc3BvbnNlOw0KICB9Ow0KICBTdWJzY3JpYmVSZXF1ZXN0IHN1YnNjcmliZVJlcXVlc3QgPSBuZXcgU3Vic2NyaWJlUmVxdWVzdCgpOw0KICBzdWJzY3JpYmVSZXF1ZXN0LnNldENoYW5uZWwoQ2hhbm5lbE5hbWUpOw0KICBzdWJzY3JpYmVSZXF1ZXN0LnNldENsaWVudElEKENsaWVudElEKTsNCiAgc3Vic2NyaWJlUmVxdWVzdC5zZXRTdWJzY3JpYmVUeXBlKFN1YnNjcmliZVR5cGUuUXVlcmllcyk7DQoNCiAgbmV3IFRocmVhZCgpIHsNCiAgICAgIHB1YmxpYyB2b2lkIHJ1bigpIHsNCg0KICAgICAgICAgIHRyeSB7DQogICAgICAgICAgICAgIHJlc3BvbmRlci5TdWJzY3JpYmVUb1JlcXVlc3RzKHN1YnNjcmliZVJlcXVlc3QsIEhhbmRsZUluY29taW5nUmVxdWVzdHMpOw0KICAgICAgICAgIH0gY2F0Y2ggKFNTTEV4Y2VwdGlvbiBlKSB7DQogICAgICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJTU0xFeGNlcHRpb246ICVzIiwgZS5nZXRNZXNzYWdlKCkpOw0KICAgICAgICAgICAgICBlLnByaW50U3RhY2tUcmFjZSgpOw0KICAgICAgICAgIH0gY2F0Y2ggKFNlcnZlckFkZHJlc3NOb3RTdXBwbGllZEV4Y2VwdGlvbiBlKSB7DQogICAgICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJTZXJ2ZXJBZGRyZXNzTm90U3VwcGxpZWRFeGNlcHRpb246ICVzIiwgZS5nZXRNZXNzYWdlKCkpOw0KICAgICAgICAgICAgICBlLnByaW50U3RhY2tUcmFjZSgpOw0KICAgICAgICAgIH0NCiAgICAgIH0NCiAgfS5zdGFydCgpOw0KYGBgDQoNCiMjIyBTZW5kaW5nIFF1ZXJ5IFJlcXVlc3RzDQoNCmBgYGphdmENCiAgU3RyaW5nIENoYW5uZWxOYW1lID0gInRlc3RpbmdfQ29tbWFuZF9jaGFubmVsIiwgQ2xpZW50SUQgPSAiaGVsbG8td29ybGQtc2VuZGVyIiwNCiAgICAgICAgICBLdWJlTVFTZXJ2ZXJBZGRyZXNzID0gImxvY2FsaG9zdDo1MDAwMCI7DQogIGlvLmt1YmVtcS5zZGsuY29tbWFuZHF1ZXJ5LkNoYW5uZWxQYXJhbWV0ZXJzIGNoYW5uZWxQYXJhbWV0ZXJzID0gbmV3IGlvLmt1YmVtcS5zZGsuY29tbWFuZHF1ZXJ5LkNoYW5uZWxQYXJhbWV0ZXJzKCk7DQogIGNoYW5uZWxQYXJhbWV0ZXJzLnNldENoYW5uZWxOYW1lKENoYW5uZWxOYW1lKTsNCiAgY2hhbm5lbFBhcmFtZXRlcnMuc2V0Q2xpZW50SUQoQ2xpZW50SUQpOw0KICBjaGFubmVsUGFyYW1ldGVycy5zZXRLdWJlTVFBZGRyZXNzKEt1YmVNUVNlcnZlckFkZHJlc3MpOw0KICBjaGFubmVsUGFyYW1ldGVycy5zZXRSZXF1ZXN0VHlwZShSZXF1ZXN0VHlwZS5RdWVyeSk7DQogIGNoYW5uZWxQYXJhbWV0ZXJzLnNldFRpbWVvdXQoMTAwMCk7DQogIGlvLmt1YmVtcS5zZGsuY29tbWFuZHF1ZXJ5LkNoYW5uZWwgY2hhbm5lbCA9IG5ldyBpby5rdWJlbXEuc2RrLmNvbW1hbmRxdWVyeS5DaGFubmVsKGNoYW5uZWxQYXJhbWV0ZXJzKTsNCiAgUmVxdWVzdCByZXF1ZXN0ID0gbmV3IFJlcXVlc3QoKTsNCiAgcmVxdWVzdC5zZXRCb2R5KENvbnZlcnRlci5Ub0J5dGVBcnJheSgiaGVsbG8ga3ViZW1xIC0gc2VuZGluZyBhIHF1ZXJ5LCBwbGVhc2UgcmVwbHkiKSk7DQogIFJlc3BvbnNlIHJlc3VsdCA9IGNoYW5uZWwuU2VuZFJlcXVlc3QocmVxdWVzdCk7DQogIGlmICghcmVzdWx0LmlzRXhlY3V0ZWQoKSkgew0KDQogICAgICBTeXN0ZW0ub3V0LnByaW50ZigiUmVzcG9uc2UgZXJyb3I6ICVzIiwgcmVzdWx0LmdldEVycm9yKCkpOw0KICAgICAgcmV0dXJuOw0KICB9DQogIFN5c3RlbS5vdXQucHJpbnRmKCJSZXNwb25zZSBSZWNlaXZlZDogJXMsIEV4ZWN1dGVkQXQ6ICVkIiwgcmVzdWx0LmdldFJlcXVlc3RJRCgpLCByZXN1bHQuZ2V0VGltZXN0YW1wKCkpOw0KYGBgDQoNCiMjIyBTZW5kaW5nIFF1ZXJ5IFJlcXVlc3RzIGFzeW5jDQoNCmBgYGphdmENCiAgU3RyaW5nIENoYW5uZWxOYW1lID0gInRlc3RpbmdfQ29tbWFuZF9jaGFubmVsIiwgQ2xpZW50SUQgPSAiaGVsbG8td29ybGQtc2VuZGVyIiwNCiAgICAgICAgICBLdWJlTVFTZXJ2ZXJBZGRyZXNzID0gImxvY2FsaG9zdDo1MDAwMCI7DQogIGlvLmt1YmVtcS5zZGsuY29tbWFuZHF1ZXJ5LkNoYW5uZWxQYXJhbWV0ZXJzIGNoYW5uZWxQYXJhbWV0ZXJzID0gbmV3IGlvLmt1YmVtcS5zZGsuY29tbWFuZHF1ZXJ5LkNoYW5uZWxQYXJhbWV0ZXJzKCk7DQogIGNoYW5uZWxQYXJhbWV0ZXJzLnNldENoYW5uZWxOYW1lKENoYW5uZWxOYW1lKTsNCiAgY2hhbm5lbFBhcmFtZXRlcnMuc2V0Q2xpZW50SUQoQ2xpZW50SUQpOw0KICBjaGFubmVsUGFyYW1ldGVycy5zZXRLdWJlTVFBZGRyZXNzKEt1YmVNUVNlcnZlckFkZHJlc3MpOw0KICBjaGFubmVsUGFyYW1ldGVycy5zZXRSZXF1ZXN0VHlwZShSZXF1ZXN0VHlwZS5RdWVyeSk7DQogIGNoYW5uZWxQYXJhbWV0ZXJzLnNldFRpbWVvdXQoMTAwMCk7DQogIGlvLmt1YmVtcS5zZGsuY29tbWFuZHF1ZXJ5LkNoYW5uZWwgY2hhbm5lbCA9IG5ldyBpby5rdWJlbXEuc2RrLmNvbW1hbmRxdWVyeS5DaGFubmVsKGNoYW5uZWxQYXJhbWV0ZXJzKTsNCiAgUmVxdWVzdCByZXF1ZXN0ID0gbmV3IFJlcXVlc3QoKTsNCiAgcmVxdWVzdC5zZXRCb2R5KENvbnZlcnRlci5Ub0J5dGVBcnJheSgiaGVsbG8ga3ViZW1xIC0gc2VuZGluZyBhIHF1ZXJ5LCBwbGVhc2UgcmVwbHkiKSk7DQogIFN0cmVhbU9ic2VydmVyPFJlc3BvbnNlPiByZXNwb25zZSA9IG5ldyBTdHJlYW1PYnNlcnZlcjxSZXNwb25zZT4oKSB7DQoNCiAgICAgIEBPdmVycmlkZQ0KICAgICAgcHVibGljIHZvaWQgb25OZXh0KFJlc3BvbnNlIHZhbHVlKSB7DQogICAgICAgICAgaWYgKCF2YWx1ZS5pc0V4ZWN1dGVkKCkpIHsNCg0KICAgICAgICAgICAgICBTeXN0ZW0ub3V0LnByaW50ZigiUmVzcG9uc2UgZXJyb3I6ICVzIiwgdmFsdWUuZ2V0RXJyb3IoKSk7DQogICAgICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJSZXNwb25zZSBSZWNlaXZlZDogJXMsIEV4ZWN1dGVkQXQgJWQiLCB2YWx1ZS5nZXRSZXF1ZXN0SUQoKSwNCiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZS5nZXRUaW1lc3RhbXAoKSk7DQogICAgICAgICAgfQ0KDQogICAgICB9DQoNCiAgICAgIEBPdmVycmlkZQ0KICAgICAgcHVibGljIHZvaWQgb25FcnJvcihUaHJvd2FibGUgdCkgew0KICAgICAgICAgIFN5c3RlbS5vdXQucHJpbnRmKCJvbkVycm9yOiAlcyIsIHQuZ2V0TWVzc2FnZSgpKTsNCiAgICAgIH0NCg0KICAgICAgQE92ZXJyaWRlDQogICAgICBwdWJsaWMgdm9pZCBvbkNvbXBsZXRlZCgpIHsNCg0KICAgICAgfQ0KICB9Ow0KICBjaGFubmVsLlNlbmRSZXF1ZXN0QXN5bmMocmVxdWVzdCwgcmVzcG9uc2UpOyAgDQpgYGANCg=="}, response: {"metadata":{"result":"ok"},"data":null,"is_error":false,"error":""}, error:<nil>	{"source": "sync.down"}
2021-06-26T13:14:19.904+0300	INFO	request: {"metadata":{"filename":"Event.java","method":"save","path":"java/kubemq-java/kubemq-java-sdk/src/main/java/io/kubemq/sdk/event/lowlevel"},"data":"LyoNCiAqIE1JVCBMaWNlbnNlDQogKg0KICogQ29weXJpZ2h0IChjKSAyMDE4IEt1YmVNUQ0KICoNCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkNCiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsDQogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzDQogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsDQogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMNCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6DQogKg0KICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsDQogKiBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLg0KICoNCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SDQogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwNCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQ0KICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUg0KICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwNCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFDQogKiBTT0ZUV0FSRS4NCiAqLw0KcGFja2FnZSBpby5rdWJlbXEuc2RrLmV2ZW50Lmxvd2xldmVsOw0KDQppbXBvcnQgY29tLmdvb2dsZS5wcm90b2J1Zi5CeXRlU3RyaW5nOw0KaW1wb3J0IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXE7DQppbXBvcnQgb3JnLmFwYWNoZS5jb21tb25zLmxhbmczLlN0cmluZ1V0aWxzOw0KDQppbXBvcnQgamF2YS51dGlsLkhhc2hNYXA7DQppbXBvcnQgamF2YS51dGlsLk1hcDsNCmltcG9ydCBqYXZhLnV0aWwuT3B0aW9uYWw7DQppbXBvcnQgamF2YS51dGlsLmNvbmN1cnJlbnQuYXRvbWljLkF0b21pY0ludGVnZXI7DQoNCi8qKg0KICogUmVwcmVzZW50cyB0aGUgRXZlbnQgdXNlZCBpbiBwdWJzdWIgdG8gc2VuZCBpbmZvcm1hdGlvbiB1c2luZyB0aGUgS3ViZU1RDQogKi8NCnB1YmxpYyBjbGFzcyBFdmVudCB7DQoNCiAgICBwcml2YXRlIHN0YXRpYyBBdG9taWNJbnRlZ2VyIF9pZCA9IG5ldyBBdG9taWNJbnRlZ2VyKDApOw0KICAgIHByaXZhdGUgYm9vbGVhbiByZXR1cm5SZXN1bHQ7DQogICAgLyoqDQogICAgICogUmVwcmVzZW50cyBUaGUgY2hhbm5lbCBuYW1lIHRvIHNlbmQgdG8gdXNpbmcgdGhlIEt1YmVNUQ0KICAgICAqLw0KICAgIHByaXZhdGUgU3RyaW5nIGNoYW5uZWw7DQogICAgLyoqDQogICAgICogUmVwcmVzZW50cyB0ZXh0IGFzIFN5c3RlbS5TdHJpbmcNCiAgICAgKi8NCiAgICBwcml2YXRlIFN0cmluZyBtZXRhZGF0YTsNCiAgICAvKioNCiAgICAgKiBSZXByZXNlbnRzIFRoZSBjb250ZW50IG9mIHRoZSBFdmVudA0KICAgICAqLw0KICAgIHByaXZhdGUgYnl0ZVtdIGJvZHk7DQogICAgLyoqDQogICAgICogUmVwcmVzZW50cyBhIEV2ZW50IGlkZW50aWZpZXINCiAgICAgKi8NCiAgICBwcml2YXRlIFN0cmluZyBldmVudElkOw0KICAgIC8qKg0KICAgICAqIFJlcHJlc2VudHMgdGhlIHNlbmRlciBJRCB0aGF0IHRoZSBtZXNzYWdlcyB3aWxsIGJlIHNlbmQgdW5kZXINCiAgICAgKi8NCiAgICBwcml2YXRlIFN0cmluZyBjbGllbnRJRDsNCiAgICAvKioNCiAgICAgKiBSZXByZXNlbnRzIGlmIHRoZSBtZXNzYWdlcyBzaG91bGQgYmUgc2VuZCB0byBwZXJzaXN0ZW5jZQ0KICAgICAqLw0KICAgIHByaXZhdGUgYm9vbGVhbiBzdG9yZTsNCiAgICBwcml2YXRlIE1hcDxTdHJpbmcsIFN0cmluZz4gdGFnczsNCg0KICAgIC8qKg0KICAgICAqIEluaXRpYWxpemVzIGEgbmV3IGluc3RhbmNlIG9mIHRoZSBFdmVudA0KICAgICAqLw0KICAgIHB1YmxpYyBFdmVudCgpIHsNCiAgICB9DQoNCiAgICAvKioNCiAgICAgKiBJbml0aWFsaXplcyBhIG5ldyBpbnN0YW5jZSBvZiB0aGUgRXZlbnQgZGVmaW5lZCBieSBhIHNldCBvZiBwYXJhbWV0ZXJzDQogICAgICoNCiAgICAgKiBAcGFyYW0gY2hhbm5lbCAgUmVwcmVzZW50cyBUaGUgY2hhbm5lbCBuYW1lIHRvIHNlbmQgdG8gdXNpbmcgdGhlIEt1YmVNUQ0KICAgICAqIEBwYXJhbSBtZXRhZGF0YSBSZXByZXNlbnRzIHRleHQgYXMgU3lzdGVtLlN0cmluZw0KICAgICAqIEBwYXJhbSBib2R5ICAgICBSZXByZXNlbnRzIFRoZSBjb250ZW50IG9mIHRoZSBFdmVudA0KICAgICAqIEBwYXJhbSBldmVudElkICBSZXByZXNlbnRzIGEgRXZlbnQgaWRlbnRpZmllcg0KICAgICAqIEBwYXJhbSBjbGllbnRJRCBSZXByZXNlbnRzIHRoZSBzZW5kZXIgSUQgdGhhdCB0aGUgbWVzc2FnZXMgd2lsbCBiZSBzZW5kIHVuZGVyDQogICAgICogQHBhcmFtIHN0b3JlICAgIFJlcHJlc2VudHMgaWYgdGhlIG1lc3NhZ2VzIHNob3VsZCBiZSBzZW5kIHRvIHBlcnNpc3RlbmNlDQogICAgICovDQogICAgcHVibGljIEV2ZW50KFN0cmluZyBjaGFubmVsLCBTdHJpbmcgbWV0YWRhdGEsIGJ5dGVbXSBib2R5LCBTdHJpbmcgZXZlbnRJZCwgU3RyaW5nIGNsaWVudElELCBib29sZWFuIHN0b3JlLCBNYXA8U3RyaW5nLFN0cmluZz4gdGFncykgew0KICAgICAgICB0aGlzLmNoYW5uZWwgPSBjaGFubmVsOw0KICAgICAgICB0aGlzLm1ldGFkYXRhID0gbWV0YWRhdGE7DQogICAgICAgIHRoaXMuYm9keSA9IGJvZHk7DQogICAgICAgIHRoaXMuZXZlbnRJZCA9IGV2ZW50SWQ7DQogICAgICAgIHRoaXMuY2xpZW50SUQgPSBjbGllbnRJRDsNCiAgICAgICAgdGhpcy5zdG9yZSA9IHN0b3JlOw0KICAgICAgICB0aGlzLnRhZ3MgPSB0YWdzOw0KICAgIH0NCg0KICAgIEV2ZW50KEt1YmVtcS5FdmVudCBldmVudCkgew0KICAgICAgICBjaGFubmVsID0gZXZlbnQuZ2V0Q2hhbm5lbCgpOw0KICAgICAgICBtZXRhZGF0YSA9IGV2ZW50LmdldE1ldGFkYXRhKCk7DQogICAgICAgIGJvZHkgPSBldmVudC5nZXRCb2R5KCkudG9CeXRlQXJyYXkoKTsNCiAgICAgICAgZXZlbnRJZCA9IFN0cmluZ1V0aWxzLmlzRW1wdHkoZXZlbnQuZ2V0RXZlbnRJRCgpKQ0KICAgICAgICAgICAgICAgID8gR2V0TmV4dElkKCkudG9TdHJpbmcoKQ0KICAgICAgICAgICAgICAgIDogZXZlbnQuZ2V0RXZlbnRJRCgpOw0KICAgICAgICBjbGllbnRJRCA9IGV2ZW50LmdldENsaWVudElEKCk7DQogICAgICAgIHRhZ3MgPSBldmVudC5nZXRUYWdzTWFwKCk7DQogICAgICAgIHN0b3JlID0gZXZlbnQuZ2V0U3RvcmUoKTsNCiAgICB9DQoNCiAgICBLdWJlbXEuRXZlbnQgVG9Jbm5lckV2ZW50KCkgew0KICAgICAgICByZXR1cm4gS3ViZW1xLkV2ZW50Lm5ld0J1aWxkZXIoKQ0KICAgICAgICAgICAgICAgIC5zZXRDaGFubmVsKGNoYW5uZWwpDQogICAgICAgICAgICAgICAgLnNldE1ldGFkYXRhKE9wdGlvbmFsLm9mTnVsbGFibGUobWV0YWRhdGEpLm9yRWxzZSgiIikpDQogICAgICAgICAgICAgICAgLnNldEJvZHkoQnl0ZVN0cmluZy5jb3B5RnJvbShib2R5KSkNCiAgICAgICAgICAgICAgICAuc2V0RXZlbnRJRChTdHJpbmdVdGlscy5pc0VtcHR5KGV2ZW50SWQpDQogICAgICAgICAgICAgICAgICAgICAgICA/IEdldE5leHRJZCgpLnRvU3RyaW5nKCkNCiAgICAgICAgICAgICAgICAgICAgICAgIDogZXZlbnRJZCkNCiAgICAgICAgICAgICAgICAuc2V0Q2xpZW50SUQoY2xpZW50SUQpDQogICAgICAgICAgICAgICAgLnNldFN0b3JlKHN0b3JlKQ0KICAgICAgICAgICAgICAgIC5wdXRBbGxUYWdzKE9wdGlvbmFsLm9mTnVsbGFibGUodGFncykub3JFbHNlKG5ldyBIYXNoTWFwPFN0cmluZyxTdHJpbmc+KCkpKQ0KICAgICAgICAgICAgICAgIC5idWlsZCgpOw0KICAgIH0NCg0KICAgIC8qKg0KICAgICAqIEdldCBhbiB1bmlxdWUgdGhyZWFkIHNhZmV0eSBJRCBiZXR3ZWVuIDEgdG8gMzIsNzY3DQogICAgICoNCiAgICAgKiBAcmV0dXJuIHVuaXF1ZSBJRCBiZXR3ZWVuIDEgdG8gMzIsNzY3DQogICAgICovDQogICAgcHJpdmF0ZSBJbnRlZ2VyIEdldE5leHRJZCgpIHsNCiAgICAgICAgcmV0dXJuIF9pZC51cGRhdGVBbmRHZXQoaSAtPiBpID09IEludGVnZXIuTUFYX1ZBTFVFID8gMSA6IGkgKyAxKTsNCiAgICB9DQoNCiAgICBwdWJsaWMgU3RyaW5nIGdldENoYW5uZWwoKSB7DQogICAgICAgIHJldHVybiBjaGFubmVsOw0KICAgIH0NCg0KICAgIHB1YmxpYyB2b2lkIHNldENoYW5uZWwoU3RyaW5nIGNoYW5uZWwpIHsNCiAgICAgICAgdGhpcy5jaGFubmVsID0gY2hhbm5lbDsNCiAgICB9DQoNCiAgICBwdWJsaWMgU3RyaW5nIGdldE1ldGFkYXRhKCkgew0KICAgICAgICByZXR1cm4gbWV0YWRhdGE7DQogICAgfQ0KDQogICAgcHVibGljIHZvaWQgc2V0TWV0YWRhdGEoU3RyaW5nIG1ldGFkYXRhKSB7DQogICAgICAgIHRoaXMubWV0YWRhdGEgPSBtZXRhZGF0YTsNCiAgICB9DQoNCiAgICBwdWJsaWMgYnl0ZVtdIGdldEJvZHkoKSB7DQogICAgICAgIHJldHVybiBib2R5Ow0KICAgIH0NCg0KICAgIHB1YmxpYyB2b2lkIHNldEJvZHkoYnl0ZVtdIGJvZHkpIHsNCiAgICAgICAgdGhpcy5ib2R5ID0gYm9keTsNCiAgICB9DQoNCiAgICBwdWJsaWMgU3RyaW5nIGdldEV2ZW50SWQoKSB7DQogICAgICAgIHJldHVybiBldmVudElkOw0KICAgIH0NCg0KDQoNCiAgICBwdWJsaWMgdm9pZCBzZXRFdmVudElkKFN0cmluZyBldmVudElkKSB7DQogICAgICAgIHRoaXMuZXZlbnRJZCA9IGV2ZW50SWQ7DQogICAgfQ0KDQogICAgcHVibGljIFN0cmluZyBnZXRDbGllbnRJRCgpIHsNCiAgICAgICAgcmV0dXJuIGNsaWVudElEOw0KICAgIH0NCg0KICAgIHB1YmxpYyB2b2lkIHNldENsaWVudElEKFN0cmluZyBjbGllbnRJRCkgew0KICAgICAgICB0aGlzLmNsaWVudElEID0gY2xpZW50SUQ7DQogICAgfQ0KDQogICAgcHVibGljIGJvb2xlYW4gaXNTdG9yZSgpIHsNCiAgICAgICAgcmV0dXJuIHN0b3JlOw0KICAgIH0NCg0KICAgIHB1YmxpYyB2b2lkIHNldFN0b3JlKGJvb2xlYW4gc3RvcmUpIHsNCiAgICAgICAgdGhpcy5zdG9yZSA9IHN0b3JlOw0KICAgIH0NCg0KICAgIHB1YmxpYyBib29sZWFuIGlzUmV0dXJuUmVzdWx0KCkgew0KICAgICAgICByZXR1cm4gcmV0dXJuUmVzdWx0Ow0KICAgIH0NCg0KICAgIHB1YmxpYyB2b2lkIHNldFJldHVyblJlc3VsdChib29sZWFuIHJldHVyblJlc3VsdCkgew0KICAgICAgICB0aGlzLnJldHVyblJlc3VsdCA9IHJldHVyblJlc3VsdDsNCiAgICB9DQogICAgcHVibGljIE1hcDxTdHJpbmcsIFN0cmluZz4gZ2V0VGFncygpIHsNCiAgICAgICAgcmV0dXJuIHRoaXMudGFnczsNCiAgICB9DQogICAgcHVibGljIHZvaWQgc2V0VGFnKFN0cmluZyBrZXksIFN0cmluZyB2YWx1ZSl7DQogICAgICAgIGlmICh0YWdzPT1udWxsKXsNCiAgICAgICAgICAgIHRhZ3MgPSAgbmV3IEhhc2hNYXA8U3RyaW5nLFN0cmluZz4oKTsNCiAgICAgICAgfQ0KICAgICAgICB0aGlzLnRhZ3MucHV0SWZBYnNlbnQoa2V5LCB2YWx1ZSk7DQogICAgfQ0KDQoNCn0NCg=="}, response: {"metadata":{"result":"ok"},"data":null,"is_error":false,"error":""}, error:<nil>	{"source": "sync.down"}
2021-06-26T13:14:19.912+0300	INFO	request: {"metadata":{"filename":"Subscriber.java","method":"save","path":"java/kubemq-java/kubemq-java-sdk/src/main/java/io/kubemq/sdk/event"},"data":"LyoNCiAqIE1JVCBMaWNlbnNlDQogKg0KICogQ29weXJpZ2h0IChjKSAyMDE4IEt1YmVNUQ0KICoNCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkNCiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsDQogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzDQogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsDQogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMNCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6DQogKg0KICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsDQogKiBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLg0KICoNCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SDQogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwNCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQ0KICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUg0KICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwNCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFDQogKiBTT0ZUV0FSRS4NCiAqLw0KcGFja2FnZSBpby5rdWJlbXEuc2RrLmV2ZW50Ow0KDQppbXBvcnQgaW8ua3ViZW1xLnNkay5iYXNpYy5HcnBjQ2xpZW50Ow0KaW1wb3J0IGlvLmt1YmVtcS5zZGsuYmFzaWMuU2VydmVyQWRkcmVzc05vdFN1cHBsaWVkRXhjZXB0aW9uOw0KaW1wb3J0IGlvLmt1YmVtcS5zZGsuZ3JwYy5LdWJlbXE7DQppbXBvcnQgaW8ua3ViZW1xLnNkay5ncnBjLkt1YmVtcS5QaW5nUmVzdWx0Ow0KaW1wb3J0IGlvLmt1YmVtcS5zZGsuc3Vic2NyaXB0aW9uLkV2ZW50c1N0b3JlVHlwZTsNCmltcG9ydCBpby5rdWJlbXEuc2RrLnN1YnNjcmlwdGlvbi5TdWJzY3JpYmVSZXF1ZXN0Ow0KaW1wb3J0IGlvLmt1YmVtcS5zZGsuc3Vic2NyaXB0aW9uLlN1YnNjcmliZVR5cGU7DQppbXBvcnQgaW8uZ3JwYy5zdHViLlN0cmVhbU9ic2VydmVyOw0KaW1wb3J0IG9yZy5hcGFjaGUuY29tbW9ucy5sYW5nMy5TdHJpbmdVdGlsczsNCmltcG9ydCBvcmcuc2xmNGouTG9nZ2VyOw0KaW1wb3J0IG9yZy5zbGY0ai5Mb2dnZXJGYWN0b3J5Ow0KDQppbXBvcnQgamF2YXgubmV0LnNzbC5TU0xFeGNlcHRpb247DQppbXBvcnQgamF2YS51dGlsLkl0ZXJhdG9yOw0KDQpwdWJsaWMgY2xhc3MgU3Vic2NyaWJlciBleHRlbmRzIEdycGNDbGllbnQgew0KDQogICAgcHJpdmF0ZSBzdGF0aWMgTG9nZ2VyIGxvZ2dlciA9IExvZ2dlckZhY3RvcnkuZ2V0TG9nZ2VyKFN1YnNjcmliZXIuY2xhc3MpOw0KIA0KICAgIC8qKg0KICAgICAqIEluaXRpYWxpemUgYSBuZXcgU3Vic2NyaWJlciB0byBpbmNvbWluZyBtZXNzYWdlcyBLdWJlTVFBZGRyZXNzIHdpbGwgYmUgcGFyc2VkDQogICAgICogZnJvbSBDb25maWcgb3IgZW52aXJvbm1lbnQgcGFyYW1ldGVyDQogICAgICovDQogICAgcHVibGljIFN1YnNjcmliZXIoKSB7DQogICAgICAgIHRoaXMobnVsbCk7DQogICAgfQ0KDQogICAgLyoqDQogICAgICogSW5pdGlhbGl6ZSBhIG5ldyBTdWJzY3JpYmVyIHRvIGluY29taW5nIG1lc3NhZ2VzDQogICAgICoNCiAgICAgKiBAcGFyYW0gS3ViZU1RQWRkcmVzcyBLdWJlTVEgc2VydmVyIGFkZHJlc3MNCiAgICAgKi8NCiAgICBwdWJsaWMgU3Vic2NyaWJlcihTdHJpbmcgS3ViZU1RQWRkcmVzcykgew0KICAgICAgICBfa3ViZW1xQWRkcmVzcyA9IEt1YmVNUUFkZHJlc3M7DQogICAgfQ0KDQogICAgICAvKioNCiAgICAgKiBJbml0aWFsaXplIGEgbmV3IFN1YnNjcmliZXIgdG8gaW5jb21pbmcgbWVzc2FnZXMNCiAgICAgKg0KICAgICAqIEBwYXJhbSBLdWJlTVFBZGRyZXNzIEt1YmVNUSBzZXJ2ZXIgYWRkcmVzcw0KICAgICAqIEBwYXJhbSBhdXRoVG9rZW4gICAgIFNldCBLdWJlTVEgSldUIEF1dGggdG9rZW4gdG8gYmUgdXNlZCBmb3IgS3ViZU1RDQogICAgICogICAgICAgICAgICAgICAgICAgICAgY29ubmVjdGlvbi4NCiAgICAgKi8NCiAgICBwdWJsaWMgU3Vic2NyaWJlcihTdHJpbmcgS3ViZU1RQWRkcmVzcywgU3RyaW5nIGF1dGhUb2tlbikgew0KICAgICAgICBfa3ViZW1xQWRkcmVzcyA9IEt1YmVNUUFkZHJlc3M7DQogICAgICAgIHRoaXMuYWRkQXV0aFRva2VuKGF1dGhUb2tlbik7DQogICAgfQ0KDQogICAgLyoqDQogICAgICogUmVnaXN0ZXIgdG8ga3ViZU1RIENoYW5uZWwgdXNpbmcgaW8ua3ViZW1xLnNkay5TdWJzY3JpcHRpb24uU3Vic2NyaWJlUmVxdWVzdC4NCiAgICAgKiBUaGlzIG1ldGhvZCBpcyBibG9ja2luZy4NCiAgICAgKg0KICAgICAqIEBwYXJhbSBzdWJzY3JpYmVSZXF1ZXN0IFBhcmFtZXRlcnMgbGlzdCByZXByZXNlbnQgYnkNCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICBpby5rdWJlbXEuc2RrLlN1YnNjcmlwdGlvbi5TdWJzY3JpYmVSZXF1ZXN0IHRoYXQgd2lsbA0KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgIGRldGVybWluZSB0aGUgc3Vic2NyaXB0aW9uIGNvbmZpZ3VyYXRpb24uDQogICAgICogQHJldHVybiBpby5rdWJlbXEuc2RrLlB1YlN1Yi5NZXNzYWdlUmVjZWl2ZS4NCiAgICAgKiBAdGhyb3dzIFNlcnZlckFkZHJlc3NOb3RTdXBwbGllZEV4Y2VwdGlvbiBUaHJvd24gZXhjZXB0aW9uIHdoZW4gS3ViZU1RIHNlcnZlcg0KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZHJlc3MgY2FuIG5vdCBiZSBkZXRlcm1pbmVkLg0KICAgICAqIEB0aHJvd3MgU1NMRXhjZXB0aW9uICAgICAgICAgICAgICAgICAgICAgIEluZGljYXRlcyBzb21lIGtpbmQgb2YgZXJyb3INCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXRlY3RlZCBieSBhbiBTU0wgc3Vic3lzdGVtLg0KICAgICAqLw0KICAgIHB1YmxpYyBFdmVudFJlY2VpdmUgU3Vic2NyaWJlVG9FdmVudHMoU3Vic2NyaWJlUmVxdWVzdCBzdWJzY3JpYmVSZXF1ZXN0KQ0KICAgICAgICAgICAgdGhyb3dzIFNlcnZlckFkZHJlc3NOb3RTdXBwbGllZEV4Y2VwdGlvbiwgU1NMRXhjZXB0aW9uIHsNCg0KICAgICAgICBWYWxpZGF0ZVN1YnNjcmliZVJlcXVlc3Qoc3Vic2NyaWJlUmVxdWVzdCk7DQoNCiAgICAgICAgdGhpcy5QaW5nKCk7DQoNCiAgICAgICAgSXRlcmF0b3I8S3ViZW1xLkV2ZW50UmVjZWl2ZT4gY2FsbCA9IEdldEt1YmVNUUNsaWVudCgpDQogICAgICAgICAgICAgICAgLnN1YnNjcmliZVRvRXZlbnRzKHN1YnNjcmliZVJlcXVlc3QuVG9Jbm5lclN1YnNjcmliZVJlcXVlc3QoKSk7DQoNCiAgICAgICAgaWYgKGNhbGwuaGFzTmV4dCgpKSB7DQogICAgICAgICAgICBLdWJlbXEuRXZlbnRSZWNlaXZlIGlubmVyTWVzc2FnZSA9IGNhbGwubmV4dCgpOw0KICAgICAgICAgICAgTG9nSW5jb21pbmdNZXNzYWdlKGlubmVyTWVzc2FnZSk7DQogICAgICAgICAgICByZXR1cm4gbmV3IEV2ZW50UmVjZWl2ZShpbm5lck1lc3NhZ2UpOw0KICAgICAgICB9DQogICAgICAgIHJldHVybiBudWxsOw0KICAgIH0NCg0KICAgLyoqDQogICAgICogUGluZyBjaGVjayBLdWJlbXEgcmVzcG9uc2UuDQogICAgICogDQogICAgICogQHJldHVybiBQaW5nUmVzdWx0DQogICAgICogQHRocm93cyBTZXJ2ZXJBZGRyZXNzTm90U3VwcGxpZWRFeGNlcHRpb24gS3ViZU1RIHNlcnZlciBhZGRyZXNzIGNhbiBub3QgYmUNCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXRlcm1pbmVkLg0KICAgICAqIEB0aHJvd3MgU1NMRXhjZXB0aW9uICAgICAgICAgICAgICAgICAgICAgIEluZGljYXRlcyBzb21lIGtpbmQgb2YgZXJyb3INCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZXRlY3RlZCBieSBhbiBTU0wgc3Vic3lzdGVtLiAgDQogICAgICovDQogICAgcHVibGljIFBpbmdSZXN1bHQgUGluZygpIHRocm93cyBTU0xFeGNlcHRpb24sIFNlcnZlckFkZHJlc3NOb3RTdXBwbGllZEV4Y2VwdGlvbiB7DQogICAgICAgIHJldHVybiBHZXRLdWJlTVFDbGllbnQoKS5waW5nKG51bGwpOw0KICAgIH0NCg0KICAgIC8qKg0KICAgICAqIFJlZ2lzdGVyIHRvIGt1YmVNUSBDaGFubmVsIHVzaW5nIGlvLmt1YmVtcS5zZGsuU3Vic2NyaXB0aW9uLlN1YnNjcmliZVJlcXVlc3QuDQogICAgICogVGhpcyBtZXRob2QgaXMgYXN5bmMuDQogICAgICoNCiAgICAgKiBAcGFyYW0gc3Vic2NyaWJlUmVxdWVzdCBQYXJhbWV0ZXJzIGxpc3QgcmVwcmVzZW50IGJ5DQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgaW8ua3ViZW1xLnNkay5TdWJzY3JpcHRpb24uU3Vic2NyaWJlUmVxdWVzdCB0aGF0IHdpbGwNCiAgICAgKiAgICAgICAgICAgICAgICAgICAgICAgICBkZXRlcm1pbmUgdGhlIHN1YnNjcmlwdGlvbiBjb25maWd1cmF0aW9uLg0KICAgICAqIEBwYXJhbSBzdHJlYW1PYnNlcnZlciAgIEFzeW5jIFN0cmVhbU9ic2VydmVyIHRvIGhhbmRsZSBldmVudCBtZXNzYWdlcw0KICAgICAqIEB0aHJvd3MgU2VydmVyQWRkcmVzc05vdFN1cHBsaWVkRXhjZXB0aW9uIFRocm93biBleGNlcHRpb24gd2hlbiBLdWJlTVEgc2VydmVyDQogICAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzcyBjYW4gbm90IGJlIGRldGVybWluZWQuDQogICAgICogQHRocm93cyBTU0xFeGNlcHRpb24gICAgICAgICAgICAgICAgICAgICAgSW5kaWNhdGVzIHNvbWUga2luZCBvZiBlcnJvcg0KICAgICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRldGVjdGVkIGJ5IGFuIFNTTCBzdWJzeXN0ZW0uICAgDQogICAgICovDQogICAgcHVibGljIHZvaWQgU3Vic2NyaWJlVG9FdmVudHMoDQogICAgICAgICAgICBTdWJzY3JpYmVSZXF1ZXN0IHN1YnNjcmliZVJlcXVlc3QsDQogICAgICAgICAgICBTdHJlYW1PYnNlcnZlcjxFdmVudFJlY2VpdmU+IHN0cmVhbU9ic2VydmVyDQogICAgKSB0aHJvd3MgU2VydmVyQWRkcmVzc05vdFN1cHBsaWVkRXhjZXB0aW9uLCBTU0xFeGNlcHRpb24gew0KDQogICAgICAgIFZhbGlkYXRlU3Vic2NyaWJlUmVxdWVzdChzdWJzY3JpYmVSZXF1ZXN0KTsNCg0KICAgICAgICBLdWJlbXEuU3Vic2NyaWJlIGlubmVyU3Vic2NyaWJlUmVxdWVzdCA9IHN1YnNjcmliZVJlcXVlc3QuVG9Jbm5lclN1YnNjcmliZVJlcXVlc3QoKTsNCiAgICAgICANCiAgICAgICAgU3RyZWFtT2JzZXJ2ZXI8S3ViZW1xLkV2ZW50UmVjZWl2ZT4gb2JzZXJ2ZXIgPSBuZXcgU3RyZWFtT2JzZXJ2ZXI8S3ViZW1xLkV2ZW50UmVjZWl2ZT4oKSB7DQogICAgICAgICAgICBAT3ZlcnJpZGUNCiAgICAgICAgICAgIHB1YmxpYyB2b2lkIG9uTmV4dChLdWJlbXEuRXZlbnRSZWNlaXZlIG1lc3NhZ2VSZWNlaXZlKSB7DQogICAgICAgICAgICAgICAgTG9nSW5jb21pbmdNZXNzYWdlKG1lc3NhZ2VSZWNlaXZlKTsNCiAgICAgICAgICAgICAgICBzdHJlYW1PYnNlcnZlci5vbk5leHQobmV3IEV2ZW50UmVjZWl2ZShtZXNzYWdlUmVjZWl2ZSkpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBAT3ZlcnJpZGUNCiAgICAgICAgICAgIHB1YmxpYyB2b2lkIG9uRXJyb3IoVGhyb3dhYmxlIHQpIHsNCiAgICAgICAgICAgICAgICBzdHJlYW1PYnNlcnZlci5vbkVycm9yKHQpOw0KICAgICAgICAgICAgfQ0KDQogICAgICAgICAgICBAT3ZlcnJpZGUNCiAgICAgICAgICAgIHB1YmxpYyB2b2lkIG9uQ29tcGxldGVkKCkgew0KICAgICAgICAgICAgICAgIHN0cmVhbU9ic2VydmVyLm9uQ29tcGxldGVkKCk7DQogICAgICAgICAgICB9DQogICAgICAgIH07DQogICAgICAgICBHZXRLdWJlTVFBc3luY0NsaWVudCgpLnN1YnNjcmliZVRvRXZlbnRzKGlubmVyU3Vic2NyaWJlUmVxdWVzdCwgb2JzZXJ2ZXIpOw0KICAgIH0NCg0KICAgIHByaXZhdGUgdm9pZCBWYWxpZGF0ZVN1YnNjcmliZVJlcXVlc3QoU3Vic2NyaWJlUmVxdWVzdCBzdWJzY3JpYmVSZXF1ZXN0KSB7DQogICAgICAgIGlmIChTdHJpbmdVdGlscy5pc0JsYW5rKHN1YnNjcmliZVJlcXVlc3QuZ2V0Q2hhbm5lbCgpKSkgew0KICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbigiUGFyYW1ldGVyIENoYW5uZWwgaXMgbWFuZGF0b3J5Iik7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHN1YnNjcmliZVJlcXVlc3QuSXNOb3RWYWxpZFR5cGUoIkV2ZW50cyIpKSB7DQogICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKCJJbnZhbGlkIFN1YnNjcmliZSBUeXBlIGZvciB0aGlzIENsYXNzIik7DQogICAgICAgIH0NCiAgICAgICAgaWYgKHN1YnNjcmliZVJlcXVlc3QuZ2V0U3Vic2NyaWJlVHlwZSgpID09IFN1YnNjcmliZVR5cGUuRXZlbnRzU3RvcmUpIHsNCiAgICAgICAgICAgIGlmIChTdHJpbmdVdGlscy5pc0JsYW5rKHN1YnNjcmliZVJlcXVlc3QuZ2V0Q2xpZW50SUQoKSkpIHsNCiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgSWxsZWdhbEFyZ3VtZW50RXhjZXB0aW9uKCJQYXJhbWV0ZXIgQ2xpZW50SUQgaXMgbWFuZGF0b3J5Iik7DQogICAgICAgICAgICB9DQogICAgICAgICAgICBpZiAoc3Vic2NyaWJlUmVxdWVzdC5nZXRFdmVudHNTdG9yZVR5cGUoKSA9PSBFdmVudHNTdG9yZVR5cGUuVW5kZWZpbmVkKSB7DQogICAgICAgICAgICAgICAgdGhyb3cgbmV3IElsbGVnYWxBcmd1bWVudEV4Y2VwdGlvbigiUGFyYW1ldGVyIEV2ZW50c1N0b3JlVHlwZSBpcyBtYW5kYXRvcnkgZm9yIHRoaXMgdHlwZSIpOw0KICAgICAgICAgICAgfQ0KICAgICAgICB9DQogICAgfQ0KDQogICAgcHJpdmF0ZSB2b2lkIExvZ0luY29taW5nTWVzc2FnZShLdWJlbXEuRXZlbnRSZWNlaXZlIG1lc3NhZ2UpIHsNCiAgICAgICAgaWYgKGxvZ2dlci5pc1RyYWNlRW5hYmxlZCgpKSB7DQogICAgICAgICAgICBsb2dnZXIudHJhY2UoDQogICAgICAgICAgICAgICAgICAgICJTdWJzY3JpYmVyIFJlY2VpdmVkIEV2ZW50OiBFdmVudElEOid7fScsIENoYW5uZWw6J3t9JywgTWV0YWRhdGE6ICd7fSciLA0KICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmdldEV2ZW50SUQoKSwNCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5nZXRDaGFubmVsKCksDQogICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuZ2V0TWV0YWRhdGEoKQ0KICAgICAgICAgICAgKTsNCiAgICAgICAgfQ0KICAgIH0NCn0NCg=="}, response: {"metadata":{"result":"ok"},"data":null,"is_error":false,"error":""}, error:<nil>	{"source": "sync.down"}
2021-06-26T13:14:19.940+0300	INFO	request: {"metadata":{"filename":"Event.java","method":"save","path":"java/kubemq-java/kubemq-java-sdk/src/main/java/io/kubemq/sdk/event"},"data":"LyoNCiAqIE1JVCBMaWNlbnNlDQogKg0KICogQ29weXJpZ2h0IChjKSAyMDE4IEt1YmVNUQ0KICoNCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkNCiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsDQogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzDQogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsDQogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMNCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6DQogKg0KICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsDQogKiBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLg0KICoNCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SDQogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwNCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQ0KICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUg0KICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwNCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFDQogKiBTT0ZUV0FSRS4NCiAqLw0KcGFja2FnZSBpby5rdWJlbXEuc2RrLmV2ZW50Ow0KDQppbXBvcnQgamF2YS51dGlsLkhhc2hNYXA7DQppbXBvcnQgamF2YS51dGlsLk1hcDsNCg0KcHVibGljIGNsYXNzIEV2ZW50IHsNCiAgICBwcml2YXRlIFN0cmluZyBldmVudElkOw0KICAgIHByaXZhdGUgU3RyaW5nIG1ldGFkYXRhOw0KICAgIHByaXZhdGUgYnl0ZVtdIGJvZHk7DQogICAgcHJpdmF0ZSBNYXA8U3RyaW5nLFN0cmluZz4gdGFnczsNCg0KICANCiAgICBwdWJsaWMgRXZlbnQoKSB7DQogICAgfQ0KDQogDQogICAgcHVibGljIEV2ZW50KFN0cmluZyBldmVudElkLCBTdHJpbmcgbWV0YWRhdGEsIGJ5dGVbXSBib2R5KSB7DQogICAgICAgIHRoaXMuZXZlbnRJZCA9IGV2ZW50SWQ7DQogICAgICAgIHRoaXMubWV0YWRhdGEgPSBtZXRhZGF0YTsNCiAgICAgICAgdGhpcy5ib2R5ID0gYm9keTsNCiAgICB9DQoNCiAgIA0KICAgIHB1YmxpYyBTdHJpbmcgZ2V0RXZlbnRJZCgpIHsNCiAgICAgICAgcmV0dXJuIGV2ZW50SWQ7DQogICAgfQ0KDQogICAgDQogICAgcHVibGljIHZvaWQgc2V0RXZlbnRJZChTdHJpbmcgZXZlbnRJZCkgew0KICAgICAgICB0aGlzLmV2ZW50SWQgPSBldmVudElkOw0KICAgIH0NCg0KICAgIHB1YmxpYyBTdHJpbmcgZ2V0TWV0YWRhdGEoKSB7DQogICAgICAgIHJldHVybiBtZXRhZGF0YTsNCiAgICB9DQoNCiAgICBwdWJsaWMgdm9pZCBzZXRNZXRhZGF0YShTdHJpbmcgbWV0YWRhdGEpIHsNCiAgICAgICAgdGhpcy5tZXRhZGF0YSA9IG1ldGFkYXRhOw0KICAgIH0NCg0KICAgIHB1YmxpYyBieXRlW10gZ2V0Qm9keSgpIHsNCiAgICAgICAgcmV0dXJuIGJvZHk7DQogICAgfQ0KDQogICAgcHVibGljIHZvaWQgc2V0Qm9keShieXRlW10gYm9keSkgew0KICAgICAgICB0aGlzLmJvZHkgPSBib2R5Ow0KICAgIH0NCg0KICAgIHB1YmxpYyBNYXA8U3RyaW5nLCBTdHJpbmc+IGdldFRhZ3MoKSB7DQogICAgICAgIHJldHVybiB0aGlzLnRhZ3M7DQogICAgfQ0KICAgIHB1YmxpYyB2b2lkIHNldFRhZyhTdHJpbmcga2V5LCBTdHJpbmcgdmFsdWUpew0KICAgICAgICBpZiAodGFncz09bnVsbCl7DQogICAgICAgICAgICB0YWdzID0gIG5ldyBIYXNoTWFwPFN0cmluZyxTdHJpbmc+KCk7DQogICAgICAgIH0NCiAgICAgICAgdGhpcy50YWdzLnB1dElmQWJzZW50KGtleSwgdmFsdWUpOw0KICAgIH0NCg0KfQ0K"}, response: {"metadata":{"result":"ok"},"data":null,"is_error":false,"error":""}, error:<nil>	{"source": "sync.down"}
2021-06-26T13:14:20.099+0300	INFO	request: {"metadata":{"filename":"EventsStoreType.java","method":"save","path":"java/kubemq-java/kubemq-java-sdk/src/main/java/io/kubemq/sdk/subscription"},"data":"LyoNCiAqIE1JVCBMaWNlbnNlDQogKg0KICogQ29weXJpZ2h0IChjKSAyMDE4IEt1YmVNUQ0KICoNCiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHkNCiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlICJTb2Z0d2FyZSIpLCB0byBkZWFsDQogKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzDQogKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsDQogKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXMNCiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6DQogKg0KICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsDQogKiBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLg0KICoNCiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCAiQVMgSVMiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SDQogKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSwNCiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRQ0KICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUg0KICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSwNCiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFDQogKiBTT0ZUV0FSRS4NCiAqLw0KcGFja2FnZSBpby5rdWJlbXEuc2RrLnN1YnNjcmlwdGlvbjsNCg0KcHVibGljIGVudW0gRXZlbnRzU3RvcmVUeXBlIHsNCiAgICBVbmRlZmluZWQoMCksDQogICAgU3RhcnROZXdPbmx5KDEpLA0KICAgIFN0YXJ0RnJvbUZpcnN0KDIpLA0KICAgIFN0YXJ0RnJvbUxhc3QoMyksDQogICAgU3RhcnRBdFNlcXVlbmNlKDQpLA0KICAgIFN0YXJ0QXRUaW1lKDUpLA0KICAgIFN0YXJ0QXRUaW1lRGVsdGEoNik7DQoNCiAgICBwcml2YXRlIGludCB2YWx1ZTsNCg0KICAgIHByaXZhdGUgRXZlbnRzU3RvcmVUeXBlKGludCB2YWx1ZSkgew0KICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7DQogICAgfQ0KDQogICAgcHVibGljIGludCBnZXRWYWx1ZSgpIHsNCiAgICAgICAgcmV0dXJuIHZhbHVlOw0KICAgIH0NCn0NCg=="}, response: {"metadata":{"result":"ok"},"data":null,"is_error":false,"error":""}, error:<nil>	{"source": "sync.down"}
